(function(e,t){function F(e,t,n,r,i,s){var o=i.realSize?i.realSize:i;t=t||"",t=String(t),e.font=n,e.fillStyle=r,e.strokeStyle="gray",e.textBaseline="middle",e.textAlign="center";var u=t.split("\n"),a=u.length,f=o.height/a,l=(i.height-o.height)/2;for(var c=0;c<a;c++){var h=y.getTextSize(n,u[c]).width,p=i.height,d=h/2;s=="right"?(d=i.width-h/2,e.textAlign="center"):s=="left"?(d=h/2,e.textAlign="center",e.textBaseline="middle"):s=="center"&&(d=i.width/2),e.strokeText(u[c],d,f/2+c*f+l),e.fillText(u[c],d,f/2+c*f+l)}}function q(e,t){var n=0;if(e.shadowMatrix)for(var r=0,i=t.size();r<i;r++){var s=t.get(r);s.refreshShadowUniforms(e,n)&&n++}}function R(e,t){var n=0;if(e.pShadowMap)for(var r=0,i=t.size();r<i;r++){var s=t.get(r);s.refreshUniformsPointShadow(e,n)&&n++}}function U(e,t,n){t._modelViewMatrix||(t._modelViewMatrix=new l),n.uniformMatrix4fv(e.modelViewMatrix,!1,t._modelViewMatrix.elements),e.normalMatrix&&n.uniformMatrix3fv(e.normalMatrix,!1,t._normalMatrix.elements)}function z(e,t,n){var r;return e==="fragment"?r=n.createShader(n.FRAGMENT_SHADER):e==="vertex"&&(r=n.createShader(n.VERTEX_SHADER)),n.shaderSource(r,t),n.compileShader(r),n.getShaderParameter(r,n.COMPILE_STATUS)?r:(console.log(n.getShaderInfoLog(r)),console.error(t),null)}function W(e,t){e.ambientLightColor.value=t.ambient,e.directionalLightColor.value=t.directional.colors,e.directionalLightDirection.value=t.directional.positions,e.pointLightColor.value=t.point.colors,e.pointLightPosition.value=t.point.positions,e.pointLightDistance.value=t.point.distances,e.spotLightColor.value=t.spot.colors,e.spotLightPosition.value=t.spot.positions,e.spotLightDistance.value=t.spot.distances,e.spotLightDirection.value=t.spot.directions,e.spotLightAngleCos.value=t.spot.anglesCos,e.spotLightExponent.value=t.spot.exponents,e.hemisphereLightSkyColor.value=t.hemi.skyColors,e.hemisphereLightGroundColor.value=t.hemi.groundColors,e.hemisphereLightDirection.value=t.hemi.positions}function X(e,t,n,r){e[t]=n.r*r,e[t+1]=n.g*r,e[t+2]=n.b*r}function V(e,t,n,r){e[t]=n.r*n.r*r,e[t+1]=n.g*n.g*r,e[t+2]=n.b*n.b*r}function K(e){var t=e;P.isNaN(t._renderInterval)&&(t._renderInterval=10),t.__timeOutFunc||(t.__timeOutFunc=function(){requestAnimationFrame(t.__timeOutFunc),t.render()}),setTimeout(t.__timeOutFunc,t._renderInterval)}function tt(e,t,n){e!=null&&("number"==typeof e?this.fromNumber(e,t,n):t==null&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function nt(){return new tt(null)}function rt(e,t,n,r,i,s){while(--s>=0){var o=t*this[e++]+n[r]+i;i=Math.floor(o/67108864),n[r++]=o&67108863}return i}function it(e,t,n,r,i,s){var o=t&32767,u=t>>15;while(--s>=0){var a=this[e]&32767,f=this[e++]>>15,l=u*a+f*o;a=o*a+((l&32767)<<15)+n[r]+(i&1073741823),i=(a>>>30)+(l>>>15)+u*f+(i>>>30),n[r++]=a&1073741823}return i}function st(e,t,n,r,i,s){var o=t&16383,u=t>>14;while(--s>=0){var a=this[e]&16383,f=this[e++]>>14,l=u*a+f*o;a=o*a+((l&16383)<<14)+n[r]+i,i=(a>>28)+(l>>14)+u*f,n[r++]=a&268435455}return i}function ct(e){return ut.charAt(e)}function ht(e,t){var n=at[e.charCodeAt(t)];return n==null?-1:n}function pt(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s}function dt(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+DV:this.t=0}function vt(e){var t=nt();return t.fromInt(e),t}function mt(e,t){var n;if(t==16)n=4;else if(t==8)n=3;else if(t==256)n=8;else if(t==2)n=1;else if(t==32)n=5;else{if(t!=4){this.fromRadix(e,t);return}n=2}this.t=0,this.s=0;var r=e.length,i=!1,s=0;while(--r>=0){var o=n==8?e[r]&255:ht(e,r);if(o<0){e.charAt(r)=="-"&&(i=!0);continue}i=!1,s==0?this[this.t++]=o:s+n>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,s+=n,s>=this.DB&&(s-=this.DB)}n==8&&(e[0]&128)!=0&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&tt.ZERO.subTo(this,this)}function gt(){var e=this.s&this.DM;while(this.t>0&&this[this.t-1]==e)--this.t}function yt(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(e==16)t=4;else if(e==8)t=3;else if(e==2)t=1;else if(e==32)t=5;else{if(e!=4)return this.toRadix(e);t=2}var n=(1<<t)-1,r,i=!1,s="",o=this.t,u=this.DB-o*this.DB%t;if(o-->0){u<this.DB&&(r=this[o]>>u)>0&&(i=!0,s=ct(r));while(o>=0)u<t?(r=(this[o]&(1<<u)-1)<<t-u,r|=this[--o]>>(u+=this.DB-t)):(r=this[o]>>(u-=t)&n,u<=0&&(u+=this.DB,--o)),r>0&&(i=!0),i&&(s+=ct(r))}return i?s:"0"}function bt(){var e=nt();return tt.ZERO.subTo(this,e),e}function wt(){return this.s<0?this.negate():this}function Et(e){var t=this.s-e.s;if(t!=0)return t;var n=this.t;t=n-e.t;if(t!=0)return t;while(--n>=0)if((t=this[n]-e[n])!=0)return t;return 0}function St(e){var t=1,n;return(n=e>>>16)!=0&&(e=n,t+=16),(n=e>>8)!=0&&(e=n,t+=8),(n=e>>4)!=0&&(e=n,t+=4),(n=e>>2)!=0&&(e=n,t+=2),(n=e>>1)!=0&&(e=n,t+=1),t}function xt(){return this.t<=0?0:this.DB*(this.t-1)+St(this[this.t-1]^this.s&this.DM)}function Tt(e,t){var n;for(n=this.t-1;n>=0;--n)t[n+e]=this[n];for(n=e-1;n>=0;--n)t[n]=0;t.t=this.t+e,t.s=this.s}function Nt(e,t){for(var n=e;n<this.t;++n)t[n-e]=this[n];t.t=Math.max(this.t-e,0),t.s=this.s}function Ct(e,t){var n=e%this.DB,r=this.DB-n,i=(1<<r)-1,s=Math.floor(e/this.DB),o=this.s<<n&this.DM,u;for(u=this.t-1;u>=0;--u)t[u+s+1]=this[u]>>r|o,o=(this[u]&i)<<n;for(u=s-1;u>=0;--u)t[u]=0;t[s]=o,t.t=this.t+s+1,t.s=this.s,t.clamp()}function kt(e,t){t.s=this.s;var n=Math.floor(e/this.DB);if(n>=this.t){t.t=0;return}var r=e%this.DB,i=this.DB-r,s=(1<<r)-1;t[0]=this[n]>>r;for(var o=n+1;o<this.t;++o)t[o-n-1]|=(this[o]&s)<<i,t[o-n]=this[o]>>r;r>0&&(t[this.t-n-1]|=(this.s&s)<<i),t.t=this.t-n,t.clamp()}function Lt(e,t){var n=0,r=0,i=Math.min(e.t,this.t);while(n<i)r+=this[n]-e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){r-=e.s;while(n<this.t)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{r+=this.s;while(n<e.t)r-=e[n],t[n++]=r&this.DM,r>>=this.DB;r-=e.s}t.s=r<0?-1:0,r<-1?t[n++]=this.DV+r:r>0&&(t[n++]=r),t.t=n,t.clamp()}function At(e,t){var n=this.abs(),r=e.abs(),i=n.t;t.t=i+r.t;while(--i>=0)t[i]=0;for(i=0;i<r.t;++i)t[i+n.t]=n.am(0,r[i],t,i,0,n.t);t.s=0,t.clamp(),this.s!=e.s&&tt.ZERO.subTo(t,t)}function Ot(e){var t=this.abs(),n=e.t=2*t.t;while(--n>=0)e[n]=0;for(n=0;n<t.t-1;++n){var r=t.am(n,t[n],e,2*n,0,1);(e[n+t.t]+=t.am(n+1,2*t[n],e,2*n+1,r,t.t-n-1))>=t.DV&&(e[n+t.t]-=t.DV,e[n+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(n,t[n],e,2*n,0,1)),e.s=0,e.clamp()}function Mt(e,t,n){var r=e.abs();if(r.t<=0)return;var i=this.abs();if(i.t<r.t){t!=null&&t.fromInt(0),n!=null&&this.copyTo(n);return}n==null&&(n=nt());var s=nt(),o=this.s,u=e.s,a=this.DB-St(r[r.t-1]);a>0?(r.lShiftTo(a,s),i.lShiftTo(a,n)):(r.copyTo(s),i.copyTo(n));var f=s.t,l=s[f-1];if(l==0)return;var c=l*(1<<this.F1)+(f>1?s[f-2]>>this.F2:0),h=this.FV/c,p=(1<<this.F1)/c,d=1<<this.F2,v=n.t,m=v-f,g=t==null?nt():t;s.dlShiftTo(m,g),n.compareTo(g)>=0&&(n[n.t++]=1,n.subTo(g,n)),tt.ONE.dlShiftTo(f,g),g.subTo(s,s);while(s.t<f)s[s.t++]=0;while(--m>=0){var y=n[--v]==l?this.DM:Math.floor(n[v]*h+(n[v-1]+d)*p);if((n[v]+=s.am(0,y,n,m,0,f))<y){s.dlShiftTo(m,g),n.subTo(g,n);while(n[v]<--y)n.subTo(g,n)}}t!=null&&(n.drShiftTo(f,t),o!=u&&tt.ZERO.subTo(t,t)),n.t=f,n.clamp(),a>0&&n.rShiftTo(a,n),o<0&&tt.ZERO.subTo(n,n)}function _t(e){var t=nt();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(tt.ZERO)>0&&e.subTo(t,t),t}function Dt(e){this.m=e}function Pt(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e}function Ht(e){return e}function Bt(e){e.divRemTo(this.m,null,e)}function jt(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function Ft(e,t){e.squareTo(t),this.reduce(t)}function It(){if(this.t<1)return 0;var e=this[0];if((e&1)==0)return 0;var t=e&3;return t=t*(2-(e&15)*t)&15,t=t*(2-(e&255)*t)&255,t=t*(2-((e&65535)*t&65535))&65535,t=t*(2-e*t%this.DV)%this.DV,t>0?this.DV-t:-t}function qt(e){this.m=e,this.mp=e.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function Rt(e){var t=nt();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(tt.ZERO)>0&&this.m.subTo(t,t),t}function Ut(e){var t=nt();return e.copyTo(t),this.reduce(t),t}function zt(e){while(e.t<=this.mt2)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var n=e[t]&32767,r=n*this.mpl+((n*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;n=t+this.m.t,e[n]+=this.m.am(0,r,e,t,0,this.m.t);while(e[n]>=e.DV)e[n]-=e.DV,e[++n]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)}function Wt(e,t){e.squareTo(t),this.reduce(t)}function Xt(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function Vt(){return(this.t>0?this[0]&1:this.s)==0}function $t(e,t){if(e>4294967295||e<1)return tt.ONE;var n=nt(),r=nt(),i=t.convert(this),s=St(e)-1;i.copyTo(n);while(--s>=0){t.sqrTo(n,r);if((e&1<<s)>0)t.mulTo(r,i,n);else{var o=n;n=r,r=o}}return t.revert(n)}function Jt(e,t){var n;return e<256||t.isEven()?n=new Dt(t):n=new qt(t),this.exp(e,n)}function Kt(){var e=nt();return this.copyTo(e),e}function Qt(){if(this.s<0){if(this.t==1)return this[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this[0];if(this.t==0)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function Gt(){return this.t==0?this.s:this[0]<<24>>24}function Yt(){return this.t==0?this.s:this[0]<<16>>16}function Zt(e){return Math.floor(Math.LN2*this.DB/Math.log(e))}function en(){return this.s<0?-1:this.t<=0||this.t==1&&this[0]<=0?0:1}function tn(e){e==null&&(e=10);if(this.signum()==0||e<2||e>36)return"0";var t=this.chunkSize(e),n=Math.pow(e,t),r=vt(n),i=nt(),s=nt(),o="";this.divRemTo(r,i,s);while(i.signum()>0)o=(n+s.intValue()).toString(e).substr(1)+o,i.divRemTo(r,i,s);return s.intValue().toString(e)+o}function nn(e,t){this.fromInt(0),t==null&&(t=10);var n=this.chunkSize(t),r=Math.pow(t,n),i=!1,s=0,o=0;for(var u=0;u<e.length;++u){var a=ht(e,u);if(a<0){e.charAt(u)=="-"&&this.signum()==0&&(i=!0);continue}o=t*o+a,++s>=n&&(this.dMultiply(r),this.dAddOffset(o,0),s=0,o=0)}s>0&&(this.dMultiply(Math.pow(t,s)),this.dAddOffset(o,0)),i&&tt.ZERO.subTo(this,this)}function rn(e,t,n){if("number"==typeof t)if(e<2)this.fromInt(1);else{this.fromNumber(e,n),this.testBit(e-1)||this.bitwiseTo(tt.ONE.shiftLeft(e-1),hn,this),this.isEven()&&this.dAddOffset(1,0);while(!this.isProbablePrime(t))this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(tt.ONE.shiftLeft(e-1),this)}else{var r=new Array,i=e&7;r.length=(e>>3)+1,t.nextBytes(r),i>0?r[0]&=(1<<i)-1:r[0]=0,this.fromString(r,256)}}function sn(){var e=this.t,t=new Array;t[0]=this.s;var n=this.DB-e*this.DB%8,r,i=0;if(e-->0){n<this.DB&&(r=this[e]>>n)!=(this.s&this.DM)>>n&&(t[i++]=r|this.s<<this.DB-n);while(e>=0){n<8?(r=(this[e]&(1<<n)-1)<<8-n,r|=this[--e]>>(n+=this.DB-8)):(r=this[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),(r&128)!=0&&(r|=-256),i==0&&(this.s&128)!=(r&128)&&++i;if(i>0||r!=this.s)t[i++]=r}}return t}function on(e){return this.compareTo(e)==0}function un(e){return this.compareTo(e)<0?this:e}function an(e){return this.compareTo(e)>0?this:e}function fn(e,t,n){var r,i,s=Math.min(e.t,this.t);for(r=0;r<s;++r)n[r]=t(this[r],e[r]);if(e.t<this.t){i=e.s&this.DM;for(r=s;r<this.t;++r)n[r]=t(this[r],i);n.t=this.t}else{i=this.s&this.DM;for(r=s;r<e.t;++r)n[r]=t(i,e[r]);n.t=e.t}n.s=t(this.s,e.s),n.clamp()}function ln(e,t){return e&t}function cn(e){var t=nt();return this.bitwiseTo(e,ln,t),t}function hn(e,t){return e|t}function pn(e){var t=nt();return this.bitwiseTo(e,hn,t),t}function dn(e,t){return e^t}function vn(e){var t=nt();return this.bitwiseTo(e,dn,t),t}function mn(e,t){return e&~t}function gn(e){var t=nt();return this.bitwiseTo(e,mn,t),t}function yn(){var e=nt();for(var t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e}function bn(e){var t=nt();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t}function wn(e){var t=nt();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t}function En(e){if(e==0)return-1;var t=0;return(e&65535)==0&&(e>>=16,t+=16),(e&255)==0&&(e>>=8,t+=8),(e&15)==0&&(e>>=4,t+=4),(e&3)==0&&(e>>=2,t+=2),(e&1)==0&&++t,t}function Sn(){for(var e=0;e<this.t;++e)if(this[e]!=0)return e*this.DB+En(this[e]);return this.s<0?this.t*this.DB:-1}function xn(e){var t=0;while(e!=0)e&=e-1,++t;return t}function Tn(){var e=0,t=this.s&this.DM;for(var n=0;n<this.t;++n)e+=xn(this[n]^t);return e}function Nn(e){var t=Math.floor(e/this.DB);return t>=this.t?this.s!=0:(this[t]&1<<e%this.DB)!=0}function Cn(e,t){var n=tt.ONE.shiftLeft(e);return this.bitwiseTo(n,t,n),n}function kn(e){return this.changeBit(e,hn)}function Ln(e){return this.changeBit(e,mn)}function An(e){return this.changeBit(e,dn)}function On(e,t){var n=0,r=0,i=Math.min(e.t,this.t);while(n<i)r+=this[n]+e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){r+=e.s;while(n<this.t)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{r+=this.s;while(n<e.t)r+=e[n],t[n++]=r&this.DM,r>>=this.DB;r+=e.s}t.s=r<0?-1:0,r>0?t[n++]=r:r<-1&&(t[n++]=this.DV+r),t.t=n,t.clamp()}function Mn(e){var t=nt();return this.addTo(e,t),t}function _n(e){var t=nt();return this.subTo(e,t),t}function Dn(e){var t=nt();return this.multiplyTo(e,t),t}function Pn(){var e=nt();return this.squareTo(e),e}function Hn(e){var t=nt();return this.divRemTo(e,t,null),t}function Bn(e){var t=nt();return this.divRemTo(e,null,t),t}function jn(e){var t=nt(),n=nt();return this.divRemTo(e,t,n),new Array(t,n)}function Fn(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()}function In(e,t){if(e==0)return;while(this.t<=t)this[this.t++]=0;this[t]+=e;while(this[t]>=this.DV)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}function qn(){}function Rn(e){return e}function Un(e,t,n){e.multiplyTo(t,n)}function zn(e,t){e.squareTo(t)}function Wn(e){return this.exp(e,new qn)}function Xn(e,t,n){var r=Math.min(this.t+e.t,t);n.s=0,n.t=r;while(r>0)n[--r]=0;var i;for(i=n.t-this.t;r<i;++r)n[r+this.t]=this.am(0,e[r],n,r,0,this.t);for(i=Math.min(e.t,t);r<i;++r)this.am(0,e[r],n,r,0,t-r);n.clamp()}function Vn(e,t,n){--t;var r=n.t=this.t+e.t-t;n.s=0;while(--r>=0)n[r]=0;for(r=Math.max(t-this.t,0);r<e.t;++r)n[this.t+r-t]=this.am(t-r,e[r],n,0,0,this.t+r-t);n.clamp(),n.drShiftTo(1,n)}function $n(e){this.r2=nt(),this.q3=nt(),tt.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}function Jn(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=nt();return e.copyTo(t),this.reduce(t),t}function Kn(e){return e}function Qn(e){e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);while(e.compareTo(this.r2)<0)e.dAddOffset(1,this.m.t+1);e.subTo(this.r2,e);while(e.compareTo(this.m)>=0)e.subTo(this.m,e)}function Gn(e,t){e.squareTo(t),this.reduce(t)}function Yn(e,t,n){e.multiplyTo(t,n),this.reduce(n)}function Zn(e,t){var n=e.bitLength(),r,i=vt(1),s;if(n<=0)return i;n<18?r=1:n<48?r=3:n<144?r=4:n<768?r=5:r=6,n<8?s=new Dt(t):t.isEven()?s=new $n(t):s=new qt(t);var o=new Array,u=3,a=r-1,f=(1<<r)-1;o[1]=s.convert(this);if(r>1){var l=nt();s.sqrTo(o[1],l);while(u<=f)o[u]=nt(),s.mulTo(l,o[u-2],o[u]),u+=2}var c=e.t-1,h,p=!0,d=nt(),v;n=St(e[c])-1;while(c>=0){n>=a?h=e[c]>>n-a&f:(h=(e[c]&(1<<n+1)-1)<<a-n,c>0&&(h|=e[c-1]>>this.DB+n-a)),u=r;while((h&1)==0)h>>=1,--u;(n-=u)<0&&(n+=this.DB,--c);if(p)o[h].copyTo(i),p=!1;else{while(u>1)s.sqrTo(i,d),s.sqrTo(d,i),u-=2;u>0?s.sqrTo(i,d):(v=i,i=d,d=v),s.mulTo(d,o[h],i)}while(c>=0&&(e[c]&1<<n)==0)s.sqrTo(i,d),v=i,i=d,d=v,--n<0&&(n=this.DB-1,--c)}return s.revert(i)}function er(e){var t=this.s<0?this.negate():this.clone(),n=e.s<0?e.negate():e.clone();if(t.compareTo(n)<0){var r=t;t=n,n=r}var i=t.getLowestSetBit(),s=n.getLowestSetBit();if(s<0)return t;i<s&&(s=i),s>0&&(t.rShiftTo(s,t),n.rShiftTo(s,n));while(t.signum()>0)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=n.getLowestSetBit())>0&&n.rShiftTo(i,n),t.compareTo(n)>=0?(t.subTo(n,t),t.rShiftTo(1,t)):(n.subTo(t,n),n.rShiftTo(1,n));return s>0&&n.lShiftTo(s,n),n}function tr(e){if(e<=0)return 0;var t=this.DV%e,n=this.s<0?e-1:0;if(this.t>0)if(t==0)n=this[0]%e;else for(var r=this.t-1;r>=0;--r)n=(t*n+this[r])%e;return n}function nr(e){var t=e.isEven();if(this.isEven()&&t||e.signum()==0)return tt.ZERO;var n=e.clone(),r=this.clone(),i=vt(1),s=vt(0),o=vt(0),u=vt(1);while(n.signum()!=0){while(n.isEven()){n.rShiftTo(1,n);if(t){if(!i.isEven()||!s.isEven())i.addTo(this,i),s.subTo(e,s);i.rShiftTo(1,i)}else s.isEven()||s.subTo(e,s);s.rShiftTo(1,s)}while(r.isEven()){r.rShiftTo(1,r);if(t){if(!o.isEven()||!u.isEven())o.addTo(this,o),u.subTo(e,u);o.rShiftTo(1,o)}else u.isEven()||u.subTo(e,u);u.rShiftTo(1,u)}n.compareTo(r)>=0?(n.subTo(r,n),t&&i.subTo(o,i),s.subTo(u,s)):(r.subTo(n,r),t&&o.subTo(i,o),u.subTo(s,u))}return r.compareTo(tt.ONE)!=0?tt.ZERO:u.compareTo(e)>=0?u.subtract(e):u.signum()<0?(u.addTo(e,u),u.signum()<0?u.add(e):u):u}function sr(e){var t,n=this.abs();if(n.t==1&&n[0]<=rr[rr.length-1]){for(t=0;t<rr.length;++t)if(n[0]==rr[t])return!0;return!1}if(n.isEven())return!1;t=1;while(t<rr.length){var r=rr[t],i=t+1;while(i<rr.length&&r<ir)r*=rr[i++];r=n.modInt(r);while(t<i)if(r%rr[t++]==0)return!1}return n.millerRabin(e)}function or(e){var t=this.subtract(tt.ONE),n=t.getLowestSetBit();if(n<=0)return!1;var r=t.shiftRight(n);e=e+1>>1,e>rr.length&&(e=rr.length);var i=nt();for(var s=0;s<e;++s){i.fromInt(rr[Math.floor(Math.random()*rr.length)]);var o=i.modPow(r,this);if(o.compareTo(tt.ONE)!=0&&o.compareTo(t)!=0){var u=1;while(u++<n&&o.compareTo(t)!=0){o=o.modPowInt(2,this);if(o.compareTo(tt.ONE)==0)return!1}if(o.compareTo(t)!=0)return!1}}return!0}function ur(){this.i=0,this.j=0,this.S=new Array}function ar(e){var t,n,r;for(t=0;t<256;++t)this.S[t]=t;n=0;for(t=0;t<256;++t)n=n+this.S[t]+e[t%e.length]&255,r=this.S[t],this.S[t]=this.S[n],this.S[n]=r;this.i=0,this.j=0}function fr(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]}function lr(){return new ur}function vr(e){pr[dr++]^=e&255,pr[dr++]^=e>>8&255,pr[dr++]^=e>>16&255,pr[dr++]^=e>>24&255,dr>=cr&&(dr-=cr)}function mr(){vr((new Date).getTime())}function br(){if(hr==null){mr(),hr=lr(),hr.init(pr);for(dr=0;dr<pr.length;++dr)pr[dr]=0;dr=0}return hr.next()}function wr(e){var t;for(t=0;t<e.length;++t)e[t]=br()}function Er(){}function Tr(e){var t,n,r="";for(t=0;t+3<=e.length;t+=3)n=parseInt(e.substring(t,t+3),16),r+=Sr.charAt(n>>6)+Sr.charAt(n&63);t+1==e.length?(n=parseInt(e.substring(t,t+1),16),r+=Sr.charAt(n<<2)):t+2==e.length&&(n=parseInt(e.substring(t,t+2),16),r+=Sr.charAt(n>>2)+Sr.charAt((n&3)<<4));while((r.length&3)>0)r+=xr;return r}function Nr(e){var t="",n,r=0,i;for(n=0;n<e.length;++n){if(e.charAt(n)==xr)break;v=Sr.indexOf(e.charAt(n));if(v<0)continue;r==0?(t+=ct(v>>2),i=v&3,r=1):r==1?(t+=ct(i<<2|v>>4),i=v&15,r=2):r==2?(t+=ct(i),t+=ct(v>>2),i=v&3,r=3):(t+=ct(i<<2|v>>4),t+=ct(v&15),r=0)}return r==1&&(t+=ct(i<<2)),t}function Cr(e){var t=Nr(e),n,r=new Array;for(n=0;2*n<t.length;++n)r[n]=parseInt(t.substring(2*n,2*n+2),16);return r}function kr(e,t){return new tt(e,t)}function Lr(e){return e<16?"0"+e.toString(16):e.toString(16)}function Ar(e,t){if(t<e.length+11)return null;var n=new Array,r=e.length-1;while(r>=0&&t>0){var i=e.charCodeAt(r--);i<128?n[--t]=i:i>127&&i<2048?(n[--t]=i&63|128,n[--t]=i>>6|192):(n[--t]=i&63|128,n[--t]=i>>6&63|128,n[--t]=i>>12|224)}n[--t]=0;var s=new Er,o=new Array;while(t>2){o[0]=0;while(o[0]==0)s.nextBytes(o);n[--t]=o[0]}return n[--t]=2,n[--t]=0,new tt(n)}function Or(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function Mr(e,t){this.n=kr(e,16),this.e=parseInt(t,16)}function _r(e){return e.modPowInt(this.e,this.n)}function Dr(e){var t=Ar(e,this.n.bitLength()+7>>3);if(t==null)return null;var n=this.doPrivate(t);if(n==null)return null;var r=n.toString(16);return(r.length&1)==0?r:"0"+r}function Pr(e,t){var n=e.toByteArray(),r=0;while(r<n.length&&n[r]==0)++r;if(n.length-r!=t-1||n[r]!=2)return null;++r;while(n[r]!=0)if(++r>=n.length)return null;var i="";while(++r<n.length){var s=n[r]&255;s<128?i+=String.fromCharCode(s):s>191&&s<224?(i+=String.fromCharCode((s&31)<<6|n[r+1]&63),++r):(i+=String.fromCharCode((s&15)<<12|(n[r+1]&63)<<6|n[r+2]&63),r+=2)}return i}function Hr(e,t,n){this.n=kr(e,16),this.e=parseInt(t,16),this.d=kr(n,16)}function Br(e,t,n,r,i,s,o,u){this.n=kr(e,16),this.e=parseInt(t,16),this.d=kr(n,16),this.p=kr(r,16),this.q=kr(i,16),this.dmp1=kr(s,16),this.dmq1=kr(o,16),this.coeff=kr(u,16)}function jr(e){if(this.p==null||this.q==null)return e.modPow(this.d,this.n);var t=e.mod(this.p).modPow(this.dmp1,this.p),n=e.mod(this.q).modPow(this.dmq1,this.q);while(t.compareTo(n)<0)t=t.add(this.p);return t.subtract(n).multiply(this.coeff).mod(this.p).multiply(this.q).add(n)}function Fr(e){var t=kr(e,16),n=this.doPublic(t);return n==null?null:Pr(n,this.n.bitLength()+7>>3)}function Zr(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function ei(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function ii(e,t){e.psColor.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size,e.map.value=t.map}function hi(e,t){return e.distance-t.distance}function pi(e,t,r,i,s){(e instanceof n.Node||e instanceof n.Billboard)&&vi(e,t,r,i,s)}function di(e,n,r,i,s){if(e===t)return;var o=e.getDescendants();for(var u=0,a=o.length;u<a;u++)pi(o[u],n,r,i,s)}function vi(e,r,i,u,a){if(!u&&a.isVisible(e)==0)return;if(e instanceof n.Billboard){var f=r.matrixPosition;f.setFromMatrixPosition(e.worldMatrix);var l=r.ray.distanceToPoint(f),c=e.material.alignment,h=new n.Plane(1,1);if(c.x||c.y)h.setPosition(c.x,c.y,0),h=n.Utils.transformElement(h,!0);h.setPosition(f);var p=(new o).getScaleFromMatrix(e.worldMatrix);h.setScale(p.x,p.y,1);var d=r.direction.clone(),v=h.getPosition().clone(),m=e.material;m&&m.vertical&&(d.y=0),v.sub(d),h.lookAt(v),h.updateWorldMatrix(!0);var g=[];return vi(h,r,g,!0,a),g.length===0?i:(i.push({distance:g[0].distance,point:e._position,face:null,object:e,element:e}),i)}if(e instanceof n.Line){var y=1;y-=1;var b=Math.sqrt(r.linePrecision+y),w=b*b,E=e;E.boundingSphere==null&&E.computeBoundingSphere(),ci.copy(E.boundingSphere),ci.applyMatrix4(e.worldMatrix);if(r.ray.isIntersectionSphere(ci)===!1)return i;ai.getInverse(e.worldMatrix),ui.copy(r.ray).transform(ai);var S=E.vertices,x=S.length,T=new o,N=new o,C=e.type===n.LineStrip?1:2;for(var k=0;k<x-1;k+=C){var L=ui.distanceSqToSegment(S[k],S[k+1],N,T);if(L>w)continue;var l=ui.origin.distanceTo(N);if(l<r.near||l>r.far)continue;i.push({distance:l,point:T.clone().applyMatrix4(e.worldMatrix),face:null,faceIndex:null,element:e,object:e})}return i}e.boundingSphere===null&&e.computeBoundingSphere(),ci.set(e.worldMatrix.getPosition(),e.boundingSphere.radius*e.worldMatrix.getMaxScaleOnAxis());if(!r.ray.isIntersectionSphere(ci))return i;var E=e,S=E.vertices,A=e.material instanceof n.ArrayMaterial,O=A===!0?e.material.materials:null,M=e.material.side,_,D,H,B,j,F,I,b=r.precision;e.rotationWorldMatrix.extractRotation(e.worldMatrix),ai.getInverse(e.worldMatrix),ui.copy(r.ray).transform(ai);for(var q=0,R=E.faces.length;q<R;q++){var U=E.faces[q],z=A===!0?O[U.materialIndex]:e.material,W=a.getOverLoadMaterial(e,z);W&&(z=W);if(z===t||z.visible===!1||E.visible===!1&&!u)continue;fi.setFromNormalAndCoplanarPoint(U.normal,S[U.a]);var X=ui.distanceToPlane(fi);if(Math.abs(X)<b)continue;if(X<0)continue;M=z.side;var V=ui.direction.dot(fi.normal);if(M!==n.DoubleSide&&!(M===n.FrontSide?V<0:V>0))continue;if(X<r.near||X>r.far)continue;li=ui.at(X,li);var $=new o,J=U.materialIndex,K=!1,Q;a&&a._selectTransparencyThreshold>0&&(K=z.transparent==1||z.alphaTest>0);if(U instanceof n.Face3){_=S[U.a],D=S[U.b],H=S[U.c];if(!n.Triangle.containsPoint(li,_,D,H))continue;$=n.Triangle.barycoordFromPoint(li,_,D,H)}else{if(!(U instanceof n.Face4))throw Error("face type not supported");_=S[U.a],D=S[U.b],H=S[U.c],B=S[U.d];var G=n.Triangle.containsPoint(li,_,D,B),Y=n.Triangle.containsPoint(li,D,H,B);if(!G&&!Y)continue;G?$=n.Triangle.barycoordFromPoint(li,_,D,B):($=n.Triangle.barycoordFromPoint(li,D,H,B),Q=!0)}var Z=new s,et=$.z,tt=$.x,nt=$.y;if(E.uvs&&E.uvs[q]){var rt=E.uvs[q];U instanceof n.Face3?(Z.x=rt[0].x*tt+rt[1].x*nt+rt[2].x*et,Z.y=rt[0].y*tt+rt[1].y*nt+rt[2].y*et):Q?(Z.x=rt[1].x*tt+rt[2].x*nt+rt[3].x*et,Z.y=rt[1].y*tt+rt[2].y*nt+rt[3].y*et):(Z.x=rt[0].x*tt+rt[1].x*nt+rt[3].x*et,Z.y=rt[0].y*tt+rt[1].y*nt+rt[3].y*et)}var it=1,st;Z=a.debugUV||Z;if(K){if(z.opacity<a._selectTransparencyThreshold)continue;if(z.map==null)it=z.opacity;else{st=z.map._image;var ot=P.getPixelFromImage(st,Z.x,Z.y);it=ot[3]/255*(z.opacity==null?1:z.opacity)}it<z.alphaTest?it=0:z.transparent==0&&(it=1)}if(it<a._selectTransparencyThreshold)continue;i.push({distance:X,point:r.ray.at(X),face:U,uv:Z,faceIndex:q,element:e,object:e,side:V>0?1:-1})}}function Ci(e){if(!Pi[e.id]){Bi=!0,Pi[e.id]=e,e.finish=e.finish==null?e.delay+e.dur+e.interval:e.finish;if(e.from==null&&e.attr&&e.source){var t;(t=e.attr.match(/^S[:@](.*)/i))?e.from=e.source.getStyle(t[1]):(t=e.attr.match(/^C[:@](.*)/i))?e.from=e.source.getClient(t[1]):e.from=twaver.Util.getValue(e.source,e.attr)}ki(e),Li(e)}return e}function ki(e){var t=e.type,n=e.from,r=e.to;t==="number"?(e.from=n||0,e.to=r||0):t==="point"?(n?n.length&&(e.from={x:n[0],y:n[1]}):e.from=e.attr==="scale"?{x:1,y:1}:{x:0,y:0},r?r.length&&(e.to={x:r[0],y:r[1]}):e.to=e.attr==="scale"?{x:1,y:1}:{x:0,y:0}):t==="rect"?(n?n.length&&(e.from={x:n[0],y:n[1],w:n[2],h:n[3]}):e.from={x:0,y:0,w:0,h:0},r?r.length&&(e.to={x:r[0],y:r[1],w:r[2],h:r[3]}):e.to={x:0,y:0,w:0,h:0}):t==="color"?(e.from=getColorValue(n),e.to=getColorValue(r)):t!=="set"&&t==="group_set",e.current=e.from}function Li(e){var t=e.type,n=e.from,r=e.to;t==="number"?e.delta=r-n:t==="point"?e.delta={x:r.x-n.x,y:r.y-n.y}:t==="rect"?e.delta={x:r.x-n.x,y:r.y-n.y,w:r.w-n.w,h:r.h-n.h}:t==="color"?e.delta={r:r.r-n.r,g:r.g-n.g,b:r.b-n.b,a:r.a-n.a}:t!=="set"&&t==="group_set"}function Ai(e,t){return Pi[e.id]&&(t==null&&(t=!0),t&&Di(e,e.to),e.onStop&&e.onStop(),e.time=0,e.total=0,e.start=null,e.count=0,e.started=!1,e.stopped=!1,delete Pi[e.id]),e}function Oi(e){e==null&&(e=!0),Object.keys(Pi).forEach(function(t){var n=Pi[t];e&&Di(n,n.to),n.onStop&&n.onStop()}),Pi={}}function Mi(e){Object.keys(Pi).forEach(function(t){var n=Pi[t];if(!n)return;n.start==null&&(n.start=e),n.total=e-n.start;if(n.total>n.delay){n.time=n.total-n.delay;var r=!1;n.time>=n.dur&&(n.time=n.dur,r=!0),!n.stopped&&Di(n,_i(n)),n.stopped=r;if(n.total>=n.finish){n.count++;if(n.count>=n.repeat)Ai(n,!1),n.onDone&&n.onDone();else{n.time=0,n.total=0,n.start=null,n.stopped=!1;if(n.reverse){var i=n.from;n.from=n.to,n.to=i,Li(n)}}}}!Bi&&(Bi=!0)})}function _i(e,t){var n=e.type,r=e.delta,i=e.from,s=e.time,o=e.dur,u=T[e.easing||"easeNone"];return u||(u=T.easeNone),n==="number"?t=u(s,i,r,o):n==="point"?t={x:u(s,i.x,r.x,o),y:u(s,i.y,r.y,o)}:n==="rect"?t={x:u(s,i.x,r.x,o),y:u(s,i.y,r.y,o),w:u(s,i.w,r.w,o),h:u(s,i.h,r.h,o)}:n==="color"?t="rgba("+Math.floor(u(s,i.r,r.r,o))+","+Math.floor(u(s,i.g,r.g,o))+","+Math.floor(u(s,i.b,r.b,o))+","+Math.floor(u(s,i.a,r.a,o))+")":n==="set"?e.time&&(t=e.to):n==="group_set"&&(t=e.to[e.groupIndex]),e.current=t,t}function Di(e,t){e.started||(e.started=!0,e.onPlay&&e.onPlay()),e.filter&&(t=e.filter(t));if(e.attr&&e.source){var n;(n=e.attr.match(/^S[:@](.*)/i))?e.source.setStyle(n[1],t):(n=e.attr.match(/^C[:@](.*)/i))?e.source.setClient(n[1],t):twaver.Util.setValue(e.source,e.attr,t)}e.onUpdate&&e.onUpdate(t)}self.Int32Array=self.Int32Array||Array,self.Float32Array=self.Float32Array||Array,Object.create=Object.create||function(e){var t=function(){};return t.prototype=e,new t};var n={version:"2.0.6",_id:["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],id:function(e){e=e==null?"":e;var t=[];for(var n=0;n<32;n++)t[n]=this._id[Math.floor(Math.random()*16)];return t[12]="4",t[16]=this._id[t[16]&3|8],e+t.join("")},ip:function(e,t,r,i){var s=r+t;e[n.getter(t,i)]=function(){return this[s]},e[n.setter(t)]=function(e){if(this.setPropertyValue)this.setPropertyValue(s,e)&&(this.onPropertyChange(t,n,e),this.firePropertyChange(t,n,e));else{var n=this[s];if(n===e)return;this[s]=e,this.onPropertyChange(t,n,e),this.firePropertyChange(t,n,e)}}},getter:function(e,t){var n=e.charAt(0).toUpperCase()+e.slice(1),r=/ble$/.test(e)||/ed$/.test(e)?"is":"get";return t&&t.indexOf(e)!=-1&&(r="is"),r+n},setter:function(e){var t=e.charAt(0).toUpperCase()+e.slice(1);return"set"+t},getValue:function(e,t,n){var r=t.charAt(0).toUpperCase()+t.slice(1),i="get"+r,s="is"+r;return n?n==="boolean"?e[s]():(e[i]==null&&console.log("get Function "+i+" not exist"),e[i]()):e[i]?e[i]():e[s]?e[s]():e[t]},setValue:function(e,t,n){e["set"+t.charAt(0).toUpperCase()+t.slice(1)](n)},clone:function(e){if(!e)return null;var t={};for(var n in e)t[n]=e[n];return t},addMethod:function(e,t){var n=e.prototype;for(var r in t)n[r]=t[r]},classCache:{},getClass:function(t){var r=n.classCache[t];if(!r){var i=t.split("."),s=i.length;r=e;for(var o=0;o<s;o++)r=r[i[o]];n.classCache[t]=r}return r},newInstance:function(e){typeof e=="string"&&(e=n.getClass(e),e=e.prototype);var t=e.constructor;if(!t)return null;var r=arguments.length,i=arguments;if(r===1)return new t;if(r===2)return new t(i[1]);if(r===3)return new t(i[1],i[2]);if(r===4)return new t(i[1],i[2],i[3]);if(r===5)return new t(i[1],i[2],i[3],i[4]);if(r===6)return new t(i[1],i[2],i[3],i[4],i[5]);if(r===7)return new t(i[1],i[2],i[3],i[4],i[5],i[6]);if(r===8)return new t(i[1],i[2],i[3],i[4],i[5],i[6],i[7]);throw"don't support args more than 7"},xml:function(t){if(e.DOMParser)return(new DOMParser).parseFromString(t,"text/xml");var n=new ActiveXObject("Microsoft.XmlDOM");return n.async=!1,n.loadXml(t),n}};e.TGL=n,e.mono=n;var r={};n.extend=function(e,t,r){if(t){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e.superClass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}var s=e.prototype;if(r){s.getClassName=function(){return r.className};for(var o in r){if(o==="__accessor"){var u=r.__accessor,a=r.__bool;for(var f=0;f<u.length;f++){var l=u[f];n.ip(s,l,"",a)}}else if(o==="___accessor"){var u=r.___accessor;for(var f=0;f<u.length;f++){var l=u[f];n.ip(s,l,"_",a)}}s[o]=r[o]}r.constructor&&(s.newInstance=function(){return n.newInstance(this)})}},n.defaultEulerOrder="XYZ",String.prototype.startsWith=String.prototype.startsWith||function(e){return this.slice(0,e.length)===e},String.prototype.endsWith=String.prototype.endsWith||function(e){var t=String(e),n=this.lastIndexOf(t);return(-1<n&&n)===this.length-t.length},String.prototype.trim=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},function(){var n=0,r=["ms","moz","webkit","o"];for(var i=0;i<r.length&&!e.requestAnimationFrame;++i)e.requestAnimationFrame=e[r[i]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[r[i]+"CancelAnimationFrame"]||e[r[i]+"CancelRequestAnimationFrame"];e.requestAnimationFrame===t&&(e.requestAnimationFrame=function(t,r){var i=Date.now(),s=Math.max(0,16-(i-n)),o=e.setTimeout(function(){t(i+s)},s);return n=i+s,o}),e.cancelAnimationFrame=e.cancelAnimationFrame||function(t){e.clearTimeout(t)}}(),n.CullFaceNone=0,n.CullFaceBack=1,n.CullFaceFront=2,n.CullFaceFrontBack=3,n.FrontFaceDirectionCW=0,n.FrontFaceDirectionCCW=1,n.BasicShadowMap=0,n.PCFShadowMap=1,n.PCFSoftShadowMap=2,n.FrontSide="front",n.BackSide="back",n.DoubleSide="both",n.BothSide="both",n.NoShading=0,n.FlatShading=1,n.SmoothShading=2,n.NormalTypeFlat="flat",n.NormalTypeSmooth="smooth",n.NoColors=0,n.FaceColors=1,n.VertexColors=2,n.NoBlending=0,n.NormalBlending=1,n.AdditiveBlending=2,n.SubtractiveBlending=3,n.MultiplyBlending=4,n.CustomBlending=5,n.AddEquation=100,n.SubtractEquation=101,n.ReverseSubtractEquation=102,n.ZeroFactor=200,n.OneFactor=201,n.SrcColorFactor=202,n.OneMinusSrcColorFactor=203,n.SrcAlphaFactor=204,n.OneMinusSrcAlphaFactor=205,n.DstAlphaFactor=206,n.OneMinusDstAlphaFactor=207,n.DstColorFactor=208,n.OneMinusDstColorFactor=209,n.SrcAlphaSaturateFactor=210,n.MultiplyOperation=0,n.MixOperation=1,n.AddOperation=2,n.UVMapping=function(){},n.CubeReflectionMapping=function(){},n.CubeRefractionMapping=function(){},n.SphericalReflectionMapping=function(){},n.SphericalRefractionMapping=function(){},n.RepeatWrapping="repeat",n.ClampToEdgeWrapping="clamp",n.MirroredRepeatWrapping="mirrored",n.NearestFilter=1003,n.NearestMipMapNearestFilter=1004,n.NearestMipMapLinearFilter=1005,n.LinearFilter=1006,n.LinearMipMapNearestFilter=1007,n.LinearMipMapLinearFilter=1008,n.UnsignedByteType=1009,n.ByteType=1010,n.ShortType=1011,n.UnsignedShortType=1012,n.IntType=1013,n.UnsignedIntType=1014,n.FloatType=1015,n.UnsignedShort4444Type=1016,n.UnsignedShort5551Type=1017,n.UnsignedShort565Type=1018,n.AlphaFormat=1019,n.RGBFormat=1020,n.RGBAFormat=1021,n.LuminanceFormat=1022,n.LuminanceAlphaFormat=1023,n.RGB_S3TC_DXT1_Format=2001
,n.RGBA_S3TC_DXT1_Format=2002,n.RGBA_S3TC_DXT3_Format=2003,n.RGBA_S3TC_DXT5_Format=2004,n.Gradient_Linear_U=1,n.Gradient_Linear_V=2,n.Gradient_Linear_UV=3,n.Gradient_Linear_NUV=4,n.Gradient_Linear_Radial=5,n.Gradient_Linear_Sweep=6,n.Math={clamp:function(e,t,n){return e<t?t:e>n?n:e},isConcave:function(e,t,n){var r=n?1:-1;return(e.x*t.y-t.x*e.y)*r<0?!0:!1},area:function(e,n,r,i){var s=i?1:-1;if(!e||!n||!r)return t;var o=-e.x*n.y-n.x*r.y-r.x*e.y+r.x*n.y+n.x*e.y+e.x*r.y;return o*s},isClockwise:function(e,t,n){t=t||"x",n=n||"y";var r=0,i=e.length;for(var s=0;s<i;s++){var o=e[s],u=e[s+1===i?0:s+1];r+=(u[t]-o[t])*(u[n]+o[n])}return r<0},isClockwise3:function(e,t,n){var r=(new mono.XiangliangThree).crossVectors(e,t),i=(new mono.XiangliangThree).subVectors(t,e),s=(new mono.XiangliangThree).subVectors(t,e)},clampBottom:function(e,t){return e<t?t:e},mapLinear:function(e,t,n,r,i){return r+(e-t)*(i-r)/(n-t)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return e<0?-1:e>0?1:0},degToRad:function(e){return e*n.Math.__d2r},radToDeg:function(e){return e*n.Math.__r2d},smoothstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t),e*e*(3-2*e))},smootherstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t),e*e*e*(e*(e*6-15)+10))},PI2:Math.PI*2,generateUUID:function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),t=new Array(36),n=0,r;return function(){for(var i=0;i<36;i++)i==8||i==13||i==18||i==23?t[i]="-":i==14?t[i]="4":(n<=2&&(n=33554432+Math.random()*16777216|0),r=n&15,n>>=4,t[i]=e[i==19?r&3|8:r]);return t.join("")}}()},n.Math.__d2r=Math.PI/180,n.Math.__r2d=180/Math.PI,n.Quat=function(e,n,r,i){this.x=e||0,this.y=n||0,this.z=r||0,this.w=i!==t?i:1},n.Quat.prototype={constructor:n.Quat,set:function(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},setFromEuler:function(e,n){var r=Math.cos(e.x/2),i=Math.cos(e.y/2),s=Math.cos(e.z/2),o=Math.sin(e.x/2),u=Math.sin(e.y/2),a=Math.sin(e.z/2);return n===t||n==="XYZ"?(this.x=o*i*s+r*u*a,this.y=r*u*s-o*i*a,this.z=r*i*a+o*u*s,this.w=r*i*s-o*u*a):n==="YXZ"?(this.x=o*i*s+r*u*a,this.y=r*u*s-o*i*a,this.z=r*i*a-o*u*s,this.w=r*i*s+o*u*a):n==="ZXY"?(this.x=o*i*s-r*u*a,this.y=r*u*s+o*i*a,this.z=r*i*a+o*u*s,this.w=r*i*s-o*u*a):n==="ZYX"?(this.x=o*i*s-r*u*a,this.y=r*u*s+o*i*a,this.z=r*i*a-o*u*s,this.w=r*i*s+o*u*a):n==="YZX"?(this.x=o*i*s+r*u*a,this.y=r*u*s+o*i*a,this.z=r*i*a-o*u*s,this.w=r*i*s-o*u*a):n==="XZY"&&(this.x=o*i*s-r*u*a,this.y=r*u*s-o*i*a,this.z=r*i*a+o*u*s,this.w=r*i*s+o*u*a),this},setFromAxisAngle:function(e,t){var n=t/2,r=Math.sin(n);return this.x=e.x*r,this.y=e.y*r,this.z=e.z*r,this.w=Math.cos(n),this},setFromRotationMatrix:function(e){var t=e.elements,n=t[0],r=t[4],i=t[8],s=t[1],o=t[5],u=t[9],a=t[2],f=t[6],l=t[10],c=n+o+l,h;return c>0?(h=.5/Math.sqrt(c+1),this.w=.25/h,this.x=(f-u)*h,this.y=(i-a)*h,this.z=(s-r)*h):n>o&&n>l?(h=2*Math.sqrt(1+n-o-l),this.w=(f-u)/h,this.x=.25*h,this.y=(r+s)/h,this.z=(i+a)/h):o>l?(h=2*Math.sqrt(1+o-n-l),this.w=(i-a)/h,this.x=(r+s)/h,this.y=.25*h,this.z=(u+f)/h):(h=2*Math.sqrt(1+l-n-o),this.w=(s-r)/h,this.x=(i+a)/h,this.y=(u+f)/h,this.z=.25*h),this},inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var e=this.length();return e===0?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this},multiply:function(e,n){return n!==t?(console.warn("DEPRECATED: Quat's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,n)):this.multiplyQuaternions(this,e)},multiplyQuaternions:function(e,t){var n=e.x,r=e.y,i=e.z,s=e.w,o=t.x,u=t.y,a=t.z,f=t.w;return this.x=n*f+s*o+r*a-i*u,this.y=r*f+s*u+i*o-n*a,this.z=i*f+s*a+n*u-r*o,this.w=s*f-n*o-r*u-i*a,this},multiplyVector3:function(e){return console.warn("DEPRECATED: Quat's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( Quat ) instead."),e.applyQuaternion(this)},slerp:function(e,t){var n=this.x,r=this.y,i=this.z,s=this.w,o=s*e.w+n*e.x+r*e.y+i*e.z;o<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,o=-o):this.copy(e);if(o>=1)return this.w=s,this.x=n,this.y=r,this.z=i,this;var u=Math.acos(o),a=Math.sqrt(1-o*o);if(Math.abs(a)<.001)return this.w=.5*(s+this.w),this.x=.5*(n+this.x),this.y=.5*(r+this.y),this.z=.5*(i+this.z),this;var f=Math.sin((1-t)*u)/a,l=Math.sin(t*u)/a;return this.w=s*f+this.w*l,this.x=n*f+this.x*l,this.y=r*f+this.y*l,this.z=i*f+this.z*l,this},toEuler:function(){var e=this.w*this.w,t=this.x*this.x,n=this.y*this.y,r=this.z*this.z,i=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-t-n+r+e),s=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),o=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),t-n-r+e);return[i,s,o]},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},clone:function(){return new n.Quat(this.x,this.y,this.z,this.w)}},n.Quat.slerp=function(e,t,n,r){return n.copy(e).slerp(t,r)};var s=function(e,t){this.x=e||0,this.y=t||0};s.prototype={constructor:s,set:function(e,t){return this.x=e,this.y=t,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,n){return n!==t?(console.warn("DEPRECATED: XiangliangTwo's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,n)):(this.x+=e.x,this.y+=e.y,this)},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScalar:function(e){return this.x+=e,this.y+=e,this},sub:function(e,n){return n!==t?(console.warn("DEPRECATED: XiangliangTwo's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,n)):(this.x-=e.x,this.y-=e.y,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},divideScalar:function(e){return e!==0?(this.x/=e,this.y/=e):this.set(0,0),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y;return t*t+n*n},setLength:function(e){var t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},equals:function(e){return e==null?!1:e.x===this.x&&e.y===this.y},clone:function(){return new s(this.x,this.y)}},n.XiangliangTwo=s;var o=function(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0};n.XiangliangThree=o,o.prototype={set:function(e,t,n){return this.x=e,this.y=t,this.z=n,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},center:function(e,t){return this.x=(e.x+t.x)/2,this.y=(e.y+t.y)/2,this.z=(e.z+t.z)/2,this},copy:function(e){return(this==null||e==null)&&console.log("TGL.XiangliangThree.copy this : "+this+" v : "+e),this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e){return(!this||!e)&&console.log("TGL.XiangliangThree.add this : "+this+" v : "+e),this.x+=e.x,this.y+=e.y,this.z+=e.z,this},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return(!e||!t)&&console.log("TGL.XiangliangThree.addVectors a : "+e+" b : "+t),this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},sub:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},subVectors:function(e,t){return(e==null||t==null)&&console.log("null"),this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyMatrix3:function(e){var t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6]*r,this.y=i[1]*t+i[4]*n+i[7]*r,this.z=i[2]*t+i[5]*n+i[8]*r,this},applyMatrix4:function(e){var t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[4]*n+i[8]*r+i[12],this.y=i[1]*t+i[5]*n+i[9]*r+i[13],this.z=i[2]*t+i[6]*n+i[10]*r+i[14],this},applyProjection:function(e){var t=this.x,n=this.y,r=this.z,i=e.elements,s=1/(i[3]*t+i[7]*n+i[11]*r+i[15]);return this.x=(i[0]*t+i[4]*n+i[8]*r+i[12])*s,this.y=(i[1]*t+i[5]*n+i[9]*r+i[13])*s,this.z=(i[2]*t+i[6]*n+i[10]*r+i[14])*s,this},applyQuaternion:function(e){var t=this.x,n=this.y,r=this.z,i=e.x,s=e.y,o=e.z,u=e.w,a=u*t+s*r-o*n,f=u*n+o*t-i*r,l=u*r+i*n-s*t,c=-i*t-s*n-o*r;return this.x=a*u+c*-i+f*-o-l*-s,this.y=f*u+c*-s+l*-i-a*-o,this.z=l*u+c*-o+a*-s-f*-i,this},applyEuler:function(e,t){var n=o.__q1.setFromEuler(e,t);return this.applyQuaternion(n),this},applyAxisAngle:function(e,t){var n=o.__q1.setFromAxisAngle(e,t);return this.applyQuaternion(n),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return e!==0?(this.x/=e,this.y/=e,this.z/=e):(this.x=0,this.y=0,this.z=0),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this},cross:function(e){var t=this.x,n=this.y,r=this.z;return this.x=n*e.z-r*e.y,this.y=r*e.x-t*e.z,this.z=t*e.y-n*e.x,this},crossVectors:function(e,t){return this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this},angleTo:function(e){return Math.acos(this.dot(e)/this.length()/e.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y,r=this.z-e.z;return t*t+n*n+r*r},getPositionFromMatrix:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},setEulerFromRotationMatrix:function(e,n){function r(e){return Math.min(Math.max(e,-1),1)}var i=e.elements,s=i[0],o=i[4],u=i[8],a=i[1],f=i[5],l=i[9],c=i[2],h=i[6],p=i[10];return n===t||n==="XYZ"?(this.y=Math.asin(r(u)),Math.abs(u)<.99999?(this.x=Math.atan2(-l,p),this.z=Math.atan2(-o,s)):(this.x=Math.atan2(h,f),this.z=0)):n==="YXZ"?(this.x=Math.asin(-r(l)),Math.abs(l)<.99999?(this.y=Math.atan2(u,p),this.z=Math.atan2(a,f)):(this.y=Math.atan2(-c,s),this.z=0)):n==="ZXY"?(this.x=Math.asin(r(h)),Math.abs(h)<.99999?(this.y=Math.atan2(-c,p),this.z=Math.atan2(-o,f)):(this.y=0,this.z=Math.atan2(a,s))):n==="ZYX"?(this.y=Math.asin(-r(c)),Math.abs(c)<.99999?(this.x=Math.atan2(h,p),this.z=Math.atan2(a,s)):(this.x=0,this.z=Math.atan2(-o,f))):n==="YZX"?(this.z=Math.asin(r(a)),Math.abs(a)<.99999?(this.x=Math.atan2(-l,f),this.y=Math.atan2(-c,s)):(this.x=0,this.y=Math.atan2(u,p))):n==="XZY"&&(this.z=Math.asin(-r(o)),Math.abs(o)<.99999?(this.x=Math.atan2(h,f),this.y=Math.atan2(u,s)):(this.x=Math.atan2(-l,p),this.y=0)),this},setEulerFromQuaternion:function(e,n){function r(e){return Math.min(Math.max(e,-1),1)}var i=e.x*e.x,s=e.y*e.y,o=e.z*e.z,u=e.w*e.w;return n===t||n==="XYZ"?(this.x=Math.atan2(2*(e.x*e.w-e.y*e.z),u-i-s+o),this.y=Math.asin(r(2*(e.x*e.z+e.y*e.w))),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),u+i-s-o)):n==="YXZ"?(this.x=Math.asin(r(2*(e.x*e.w-e.y*e.z))),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),u-i-s+o),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),u-i+s-o)):n==="ZXY"?(this.x=Math.asin(r(2*(e.x*e.w+e.y*e.z))),this.y=Math.atan2(2*(e.y*e.w-e.z*e.x),u-i-s+o),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),u-i+s-o)):n==="ZYX"?(this.x=Math.atan2(2*(e.x*e.w+e.z*e.y),u-i-s+o),this.y=Math.asin(r(2*(e.y*e.w-e.x*e.z))),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),u+i-s-o)):n==="YZX"?(this.x=Math.atan2(2*(e.x*e.w-e.z*e.y),u-i+s-o),this.y=Math.atan2(2*(e.y*e.w-e.x*e.z),u+i-s-o),this.z=Math.asin(r(2*(e.x*e.y+e.z*e.w)))):n==="XZY"&&(this.x=Math.atan2(2*(e.x*e.w+e.y*e.z),u-i+s-o),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),u+i-s-o),this.z=Math.asin(r(2*(e.z*e.w-e.x*e.y)))),this},getScaleFromMatrix:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),n=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),r=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=n,this.z=r,this},toString:function(){return this.x+"_"+this.y+"_"+this.z},equals:function(e){return e==null?!1:e.x===this.x&&e.y===this.y&&e.z===this.z},clone:function(){return new o(this.x,this.y,this.z)},setFromMatrixPosition:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},rotateFromAxisAndCenter:function(e,t,r){var i=(new n.Mat4).makeRotationAxisAndCenter(e,t,r);return this.applyMatrix4(i),this},rotationTowards:function(e,t){var r=(new n.Mat4).rotationTowards(e,t);return this.setEulerFromRotationMatrix(r),this},constructor:n.XiangliangThree},o.__q1=new n.Quat,n.Vec4=function(e,n,r,i){this.x=e||0,this.y=n||0,this.z=r||0,this.w=i!==t?i:1},n.Vec4.prototype={constructor:n.Vec4,set:function(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==t?e.w:1,this},add:function(e,n){return n!==t?(console.warn("DEPRECATED: Vec4's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,n)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},sub:function(e,n){return n!==t?(console.warn("DEPRECATED: Vec4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,n)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,n=this.y,r=this.z,i=this.w,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*r+s[12]*i,this.y=s[1]*t+s[5]*n+s[9]*r+s[13]*i,this.z=s[2]*t+s[6]*n+s[10]*r+s[14]*i,this.w=s[3]*t+s[7]*n+s[11]*r+s[15]*i,this},divideScalar:function(e){return e!==0?(this.x/=e,this.y/=e,this.z/=e,this.w/=e):(this.x=0,this.y=0,this.z=0,this.w=1),this},min:function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this.w>e.w&&(this.w=e.w),this},max:function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this.w<e.w&&(this.w=e.w),this},clamp:function(e,t){return this.x<e.x?this.x=e.x:this.x>t.x&&(this.x=t.x),this.y<e.y?this.y=e.y:this.y>t.y&&(this.y=t.y),this.z<e.z?this.z=e.z:this.z>t.z&&(this.z=t.z),this.w<e.w?this.w=e.w:this.w>t.w&&(this.w=t.w),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){var t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},clone:function(){return new n.Vec4(this.x,this.y,this.z,this.w)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,n,r,i,s=.01,o=.1,u=e.elements,a=u[0],f=u[4],l=u[8],c=u[1],h=u[5],p=u[9],d=u[2],v=u[6],m=u[10];if(Math.abs(f-c)<s&&Math.abs(l-d)<s&&Math.abs(p-v)<s){if(Math.abs(f+c)<o&&Math.abs(l+d)<o&&Math.abs(p+v)<o&&Math.abs(a+h+m-3)<o)return this.set(1,0,0,0),this;t=Math.PI;var g=(a+1)/2,y=(h+1)/2,b=(m+1)/2,w=(f+c)/4,E=(l+d)/4,S=(p+v)/4;return g>y&&g>b?g<s?(n=0,r=.707106781,i=.707106781):(n=Math.sqrt(g),r=w/n,i=E/n):y>b?y<s?(n=.707106781,r=0,i=.707106781):(r=Math.sqrt(y),n=w/r,i=S/r):b<s?(n=.707106781,r=.707106781,i=0):(i=Math.sqrt(b),n=E/i,r=S/i),this.set(n,r,i,t),this}var x=Math.sqrt((v-p)*(v-p)+(l-d)*(l-d)+(c-f)*(c-f));return Math.abs(x)<.001&&(x=1),this.x=(v-p)/x,this.y=(l-d)/x,this.z=(c-f)/x,this.w=Math.acos((a+h+m-1)/2),this}};var f=function(e,n,r,i,s,o,u,a,f){this.elements=new Float32Array(9),this.set(e!==t?e:1,n||0,r||0,i||0,s!==t?s:1,o||0,u||0,a||0,f!==t?f:1)};f.prototype={constructor:f,set:function(e,t,n,r,i,s,o,u,a){var f=this.elements;return f[0]=e,f[3]=t,f[6]=n,f[1]=r,f[4]=i,f[7]=s,f[2]=o,f[5]=u,f[8]=a,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this},multiplyVector3:function(e){return console.warn("DEPRECATED: Mat3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(){var e=new o;return function(t){for(var n=0,r=t.length;n<r;n+=3)e.x=t[n],e.y=t[n+1],e.z=t[n+2],e.applyMatrix3(this),t[n]=e.x,t[n+1]=e.y,t[n+2]=e.z;return t}}(),multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8];return t*s*f-t*o*a-n*i*f+n*o*u+r*i*a-r*s*u},getInverse:function(e,t){var n=e.elements,r=this.elements;r[0]=n[10]*n[5]-n[6]*n[9],r[1]=-n[10]*n[1]+n[2]*n[9],r[2]=n[6]*n[1]-n[2]*n[5],r[3]=-n[10]*n[4]+n[6]*n[8],r[4]=n[10]*n[0]-n[2]*n[8],r[5]=-n[6]*n[0]+n[2]*n[4],r[6]=n[9]*n[4]-n[5]*n[8],r[7]=-n[9]*n[0]+n[1]*n[8],r[8]=n[5]*n[0]-n[1]*n[4];var i=n[0]*r[0]+n[1]*r[3]+n[2]*r[6];if(i===0){var s="Mat3.getInverse(): can't invert matrix, determinant is 0";if(t||!1)throw new Error(s);return console.warn(s),this.identity(),this}return this.multiplyScalar(1/i),this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.getInverse(e).transpose(),this},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},clone:function(){var e=this.elements;return new f(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])}},n.Mat3=f;var l=function(e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){this.elements=new Float32Array(16),this.set(e!==t?e:1,n||0,r||0,i||0,s||0,o!==t?o:1,u||0,a||0,f||0,l||0,c!==t?c:1,h||0,p||0,d||0,v||0,m!==t?m:1)};l.prototype={constructor:l,set:function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=this.elements;return m[0]=e,m[4]=t,m[8]=n,m[12]=r,m[1]=i,m[5]=s,m[9]=o,m[13]=u,m[2]=a,m[6]=f,m[10]=l,m[14]=c,m[3]=h,m[7]=p,m[11]=d,m[15]=v,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]),this},setRotationFromEuler:function(e,n){var r=this.elements,i=e.x,s=e.y,o=e.z,u=Math.cos(i),a=Math.sin(i),f=Math.cos(s),l=Math.sin(s),c=Math.cos(o),h=Math.sin(o);if(n===t||n==="XYZ"){var p=u*c,d=u*h,v=a*c,m=a*h;r[0]=f*c,r[4]=-f*h,r[8]=l,r[1]=d+v*l,r[5]=p-m*l,r[9]=-a*f,r[2]=m-p*l,r[6]=v+d*l,r[10]=u*f}else if(n==="YXZ"){var g=f*c,y=f*h,b=l*c,w=l*h;r[0]=g+w*a,r[4]=b*a-y,r[8]=u*l,r[1]=u*h,r[5]=u*c,r[9]=-a,r[2]=y*a-b,r[6]=w+g*a,r[10]=u*f}else if(n==="ZXY"){var g=f*c,y=f*h,b=l*c,w=l*h;r[0]=g-w*a,r[4]=-u*h,r[8]=b+y*a,r[1]=y+b*a,r[5]=u*c,r[9]=w-g*a,r[2]=-u*l,r[6]=a,r[10]=u*f}else if(n==="ZYX"){var p=u*c,d=u*h,v=a*c,m=a*h;r[0]=f*c,r[4]=v*l-d,r[8]=p*l+m,r[1]=f*h,r[5]=m*l+p,r[9]=d*l-v,r[2]=-l,r[6]=a*f,r[10]=u*f}else if(n==="YZX"){var E=u*f,S=u*l,x=a*f,T=a*l;r[0]=f*c,r[4]=T-E*h,r[8]=x*h+S,r[1]=h,r[5]=u*c,r[9]=-a*c,r[2]=-l*c,r[6]=S*h+x,r[10]=E-T*h}else if(n==="XZY"){var E=u*f,S=u*l,x=a*f,T=a*l;r[0]=f*c,r[4]=-h,r[8]=l*c,r[1]=E*h+T,r[5]=u*c,r[9]=S*h-x,r[2]=x*h-S,r[6]=a*c,r[10]=T*h+E}return this},setRotationFromQuaternion:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z,s=e.w,o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,d=i*a,v=s*o,m=s*u,g=s*a;return t[0]=1-(h+d),t[4]=l-g,t[8]=c+m,t[1]=l+g,t[5]=1-(f+d),t[9]=p-v,t[2]=c-m,t[6]=p+v,t[10]=1-(f+h),this},lookAt:function(e,t,n){var r=this.elements,i=l.__v1,s=l.__v2,o=l.__v3;return o.subVectors(e,t).normalize(),o.length()===0&&(o.z=1),i.crossVectors(n,o).normalize(),i.length()===0&&(o.x+=1e-4,i.crossVectors(n,o).normalize()),s.crossVectors(o,i),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[4]=s.x,r[5]=s.y,r[6]=s.z,r[8]=o.x,r[9]=o.y,r[10]=o.z,this},multiply:function(e,n){return n!==t?this.multiplyMatrices(e,n):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var n=e.elements,r=t.elements,i=this.elements,s=n[0],o=n[4],u=n[8],a=n[12],f=n[1],l=n[5],c=n[9],h=n[13],p=n[2],d=n[6],v=n[10],m=n[14],g=n[3],y=n[7],b=n[11],w=n[15],E=r[0],S=r[4],x=r[8],T=r[12],N=r[1],C=r[5],k=r[9],L=r[13],A=r[2],O=r[6],M=r[10],_=r[14],D=r[3],P=r[7],H=r[11],B=r[15];return i[0]=s*E+o*N+u*A+a*D,i[4]=s*S+o*C+u*O+a*P,i[8]=s*x+o*k+u*M+a*H,i[12]=s*T+o*L+u*_+a*B,i[1]=f*E+l*N+c*A+h*D,i[5]=f*S+l*C+c*O+h*P,i[9]=f*x+l*k+c*M+h*H,i[13]=f*T+l*L+c*_+h*B,i[2]=p*E+d*N+v*A+m*D,i[6]=p*S+d*C+v*O+m*P,i[10]=p*x+d*k+v*M+m*H,i[14]=p*T+d*L+v*_+m*B,i[3]=g*E+y*N+b*A+w*D,i[7]=g*S+y*C+b*O+w*P,i[11]=g*x+y*k+b*M+w*H,i[15]=g*T+y*L+b*_+w*B,this},multiplyToArray:function(e,t,n){var r=this.elements;return this.multiplyMatrices(e,t),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return e.applyProjection(this)},multiplyVector4:function(e){return e.applyMatrix4(this)},multiplyVector3Array:function(e){var t=l.__v1;for(var n=0,r=e.length;n<r;n+=3)t.x=e[n],t.y=e[n+1],t.z=e[n+2],t.applyProjection(this),e[n]=t.x,e[n+1]=t.y,e[n+2]=t.z;return e},rotateAxis:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return e.x=n*t[0]+r*t[4]+i*t[8],e.y=n*t[1]+r*t[5]+i*t[9],e.z=n*t[2]+r*t[6]+i*t[10],e.normalize(),e},crossVector:function(e){var t=this.elements,r=new n.Vector4;return r.x=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12]*e.w,r.y=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13]*e.w,r.z=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14]*e.w,r.w=e.w?t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15]*e.w:1,r},determinant:function(){var e=this.elements,t=e[0],n=e[4],r=e[8],i=e[12],s=e[1],o=e[5],u=e[9],a=e[13],f=e[2],l=e[6],c=e[10],h=e[14],p=e[3],d=e[7],v=e[11],m=e[15];return p*(+i*u*l-r*a*l-i*o*c+n*a*c+r*o*h-n*u*h)+d*(+t*u*h-t*a*c+i*s*c-r*s*h+r*a*f-i*u*f)+v*(+t*a*l-t*o*h-i*s*l+n*s*h+i*o*f-n*a*f)+m*(-r*o*f-t*u*l+t*o*c+r*s*l-n*s*c+n*u*f)},transpose:function(){var e=this.elements,t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},flattenToArrayOffset:function(e,t){var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e},getPosition:function(){var e=this.elements;return(new o).set(e[12],e[13],e[14])},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getColumnX:function(){var e=this.elements;return l.__v1.set(e[0],e[1],e[2])},getColumnY:function(){var e=this.elements;return l.__v1.set(e[4],e[5],e[6])},getColumnZ:function(){var e=this.elements;return l.__v1.set(e[8],e[9],e[10])},getInverse:function(e,t){var n=this.elements,r=e.elements,i=r[0],s=r[4],o=r[8],u=r[12],a=r[1],f=r[5],l=r[9],c=r[13],h=r[2],p=r[6],d=r[10],v=r[14],m=r[3],g=r[7],y=r[11],b=r[15];n[0]=l*v*g-c*d*g+c*p*y-f*v*y-l*p*b+f*d*b,n[4]=u*d*g-o*v*g-u*p*y+s*v*y+o*p*b-s*d*b,n[8]=o*c*g-u*l*g+u*f*y-s*c*y-o*f*b+s*l*b,n[12]=u*l*p-o*c*p-u*f*d+s*c*d+o*f*v-s*l*v,n[1]=c*d*m-l*v*m-c*h*y+a*v*y+l*h*b-a*d*b,n[5]=o*v*m-u*d*m+u*h*y-i*v*y-o*h*b+i*d*b,n[9]=u*l*m-o*c*m-u*a*y+i*c*y+o*a*b-i*l*b,n[13]=o*c*h-u*l*h+u*a*d-i*c*d-o*a*v+i*l*v,n[2]=f*v*m-c*p*m+c*h*g-a*v*g-f*h*b+a*p*b,n[6]=u*p*m-s*v*m-u*h*g+i*v*g+s*h*b-i*p*b,n[10]=s*c*m-u*f*m+u*a*g-i*c*g-s*a*b+i*f*b,n[14]=u*f*h-s*c*h-u*a*p+i*c*p+s*a*v-i*f*v,n[3]=l*p*m-f*d*m-l*h*g+a*d*g+f*h*y-a*p*y,n[7]=s*d*m-o*p*m+o*h*g-i*d*g-s*h*y+i*p*y,n[11]=o*f*m-s*l*m-o*a*g+i*l*g+s*a*y-i*f*y,n[15]=s*l*h-o*f*h+o*a*p-i*l*p-s*a*d+i*f*d;var w=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+r[3]*n[12];if(w==0){var E="Mat4.getInverse(): can't invert matrix, determinant is 0";if(t||!1)throw new Error(E);return console.warn(E),this.identity(),this}return this.multiplyScalar(1/w),this},compose:function(e,t,n){var r=this.elements,i=l.__m1,s=l.__m2;return i.identity(),i.setRotationFromQuaternion(t),s.makeScale(n.x,n.y,n.z),this.multiplyMatrices(i,s),r[12]=e.x,r[13]=e.y,r[14]=e.z,this},decompose:function(e,t,r){var i=this.elements,s=l.__v1,u=l.__v2,a=l.__v3;s.set(i[0],i[1],i[2]),u.set(i[4],i[5],i[6]),a.set(i[8],i[9],i[10]),e=e instanceof o?e:new o,t=t instanceof n.Quat?t:new n.Quat,r=r instanceof o?r:new o,r.x=s.length(),r.y=u.length(),r.z=a.length(),e.x=i[12],e.y=i[13],e.z=i[14];var f=l.__m1;return f.copy(this),f.elements[0]/=r.x,f.elements[1]/=r.x,f.elements[2]/=r.x,f.elements[4]/=r.y,f.elements[5]/=r.y,f.elements[6]/=r.y,f.elements[8]/=r.z,f.elements[9]/=r.z,f.elements[10]/=r.z,t.setFromRotationMatrix(f),[e,t,r]},extractPosition:function(e){var t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this},extractRotation:function(e){var t=this.elements,n=e.elements,r=l.__v1,i=1/r.set(n[0],n[1],n[2]).length(),s=1/r.set(n[4],n[5],n[6]).length(),o=1/r.set(n[8],n[9],n[10]).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[4]=n[4]*s,t[5]=n[5]*s,t[6]=n[6]*s,t[8]=n[8]*o,t[9]=n[9]*o,t[10]=n[10]*o,this},translate:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return t[12]=t[0]*n+t[4]*r+t[8]*i+t[12],t[13]=t[1]*n+t[5]*r+t[9]*i+t[13],t[14]=t[2]*n+t[6]*r+t[10]*i+t[14],t[15]=t[3]*n+t[7]*r+t[11]*i+t[15],this},rotateX:function(e){var t=this.elements,n=t[4],r=t[5],i=t[6],s=t[7],o=t[8],u=t[9],a=t[10],f=t[11],l=Math.cos(e),c=Math.sin(e);return t[4]=l*n+c*o,t[5]=l*r+c*u,t[6]=l*i+c*a,t[7]=l*s+c*f,t[8]=l*o-c*n,t[9]=l*u-c*r,t[10]=l*a-c*i,t[11]=l*f-c*s,this},rotateY:function(e){var t=this.elements,n=t[0],r=t[1],i=t[2],s=t[3],o=t[8],u=t[9],a=t[10],f=t[11],l=Math.cos(e),c=Math.sin(e);return t[0]=l*n-c*o,t[1]=l*r-c*u,t[2]=l*i-c*a,t[3]=l*s-c*f,t[8]=l*o+c*n,t[9]=l*u+c*r,t[10]=l*a+c*i,t[11]=l*f+c*s,this},rotateZ:function(e){var t=this.elements,n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=Math.cos(e),c=Math.sin(e);return t[0]=l*n+c*o,t[1]=l*r+c*u,t[2]=l*i+c*a,t[3]=l*s+c*f,t[4]=l*o-c*n,t[5]=l*u-c*r,t[6]=l*a-c*i,t[7]=l*f-c*s,this},rotateByAxis:function(e,t){var n=this.elements;if(e.x===1&&e.y===0&&e.z===0)return this.rotateX(t);if(e.x===0&&e.y===1&&e.z===0)return this.rotateY(t);if(e.x===0&&e.y===0&&e.z===1)return this.rotateZ(t);var r=e.x,i=e.y,s=e.z,o=Math.sqrt(r*r+i*i+s*s);r/=o,i/=o,s/=o;var u=r*r,a=i*i,f=s*s,l=Math.cos(t),c=Math.sin(t),h=1-l,p=r*i*h,d=r*s*h,v=i*s*h,m=r*c,g=i*c,y=s*c,b=u+(1-u)*l,w=p+y,E=d-g,S=p-y,x=a+(1-a)*l,T=v+m,N=d+g,C=v-m,k=f+(1-f)*l,L=n[0],A=n[1],O=n[2],M=n[3],_=n[4],D=n[5],P=n[6],H=n[7],B=n[8],j=n[9],F=n[10],I=n[11],q=n[12],R=n[13],U=n[14],z=n[15];return n[0]=b*L+w*_+E*B,n[1]=b*A+w*D+E*j,n[2]=b*O+w*P+E*F,n[3]=b*M+w*H+E*I,n[4]=S*L+x*_+T*B,n[5]=S*A+x*D+T*j,n[6]=S*O+x*P+T*F,n[7]=S*M+x*H+T*I,n[8]=N*L+C*_+k*B,n[9]=N*A+C*D+k*j,n[10]=N*O+C*P+k*F,n[11]=N*M+C*H+k*I,this},scale:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return t[0]*=n,t[4]*=r,t[8]*=i,t[1]*=n,t[5]*=r,t[9]*=i,t[2]*=n,t[6]*=r,t[10]*=i,t[3]*=n,t[7]*=r,t[11]*=i,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(n,r)))},makeTranslation:function(e,t,n){return this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var n=Math.cos(t),r=Math.sin(t),i=1-n,s=e.x,o=e.y,u=e.z,a=i*s,f=i*o;return this.set(a*s+n,a*o-r*u,a*u+r*o,0,a*o+r*u,f*o+n,f*u-r*s,0,a*u-r*o,f*u+r*s,i*u*u+n,0,0,0,0,1),this},makeScale:function(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this},makeFrustum:function(e,t,n,r,i,s){var o=this.elements,u=2*i/(t-e),a=2*i/(r-n),f=(t+e)/(t-e),l=(r+n)/(r-n),c=-(s+i)/(s-i),h=-2*s*i/(s-i);return o[0]=u,o[4]=0,o[8]=f,o[12]=0,o[1]=0,o[5]=a,o[9]=l,o[13]=0,o[2]=0,o[6]=0,o[10]=c,o[14]=h,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makePerspective:function(e,t,r,i){var s=r*Math.tan(n.Math.degToRad(e*.5)),o=-s,u=o*t,a=s*t;return this.makeFrustum(u,a,o,s,r,i)},makeOrthographic:function(e,t,n,r,i,s){var o=this.elements,u=t-e,a=n-r,f=s-i,l=(t+e)/u,c=(n+r)/a,h=(s+i)/f;return o[0]=2/u,o[4]=0,o[8]=0,o[12]=-l,o[1]=0,o[5]=2/a,o[9]=0,o[13]=-c,o[2]=0,o[6]=0,o[10]=-2/f,o[14]=-h,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},clone:function(){var e=this.elements;return new l(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15])},makeRotationFromQuaternion:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z,s=e.w,o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=
n*a,h=r*u,p=r*a,d=i*a,v=s*o,m=s*u,g=s*a;return t[0]=1-(h+d),t[4]=l-g,t[8]=c+m,t[1]=l+g,t[5]=1-(f+d),t[9]=p-v,t[2]=c-m,t[6]=p+v,t[10]=1-(f+h),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},getEulerAngles:function(){var e=(new l).extractRotation(this).elements,t=e[0],n=e[1],r=e[2],i=e[5],s=e[6],u=e[10],a=Math.atan2(s,u),f=Math.atan2(-r,Math.sqrt(t*t+n*n)),c=Math.sin(a),h=Math.cos(a),p=Math.atan2(c*e[8]-h*e[4],h*i-c*e[9]);return new o(a,f,p)},makeRotationAxisAndCenter:function(e,t,n){var r=Math.cos(t),i=Math.sin(t),s=1-r,o=e.x,u=e.y,a=e.z,f=s*o,l=s*u,c=n.x,h=n.y,p=n.z,d=this,v=new Float32Array(16);return v[0]=f*o+r,v[4]=f*u-i*a,v[8]=f*a+i*u,v[12]=c-c*(f*o+r)-h*(f*u-i*a)-p*(f*a+i*u),v[1]=f*u+i*a,v[5]=l*u+r,v[9]=l*a-i*o,v[13]=h-c*(f*u+i*a)-h*(l*u+r)-p*(l*a-i*o),v[2]=f*a-i*u,v[6]=l*a+i*o,v[10]=s*a*a+r,v[14]=p-c*(f*a-i*u)-h*(l*a+i*o)-p*(s*a*a+r),v[3]=0,v[7]=0,v[11]=0,v[15]=1,d.elements=v,d},rotationTowards:function(e,t){var r=Math.acos(t.dot(e)/t.length()/e.length()),i=(new n.XiangliangThree).crossVectors(t,e).normalize();return this.makeRotationAxis(i,-r),this},equals:function(e){if(e instanceof l){for(var t=0;t<this.elements.length;t++)if(Math.abs(this.elements[t]-e.elements[t])>1e-4)return!1;return!0}}},l.__v1=new o,l.__v2=new o,l.__v3=new o,l.__m1=new l,l.__m2=new l,n.Mat4=l,n.Euler=function(e,t,r,i){this._x=e||0,this._y=t||0,this._z=r||0,this._order=i||n.Euler.DefaultOrder},n.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],n.Euler.DefaultOrder="XYZ",n.Euler.prototype={constructor:n.Euler,_x:0,_y:0,_z:0,_order:n.Euler.DefaultOrder,_quaternion:t,_updateQuaternion:function(){this._quaternion!==t&&this._quaternion.setFromEuler(this,!1)},get x(){return this._x},set x(e){this._x=e,this._updateQuaternion()},get y(){return this._y},set y(e){this._y=e,this._updateQuaternion()},get z(){return this._z},set z(e){this._z=e,this._updateQuaternion()},get order(){return this._order},set order(e){this._order=e,this._updateQuaternion()},set:function(e,t,n,r){return this._x=e,this._y=t,this._z=n,this._order=r||this._order,this._updateQuaternion(),this},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._updateQuaternion(),this},setFromRotationMatrix:function(e,t){function n(e){return Math.min(Math.max(e,-1),1)}var r=e.elements,i=r[0],s=r[4],o=r[8],u=r[1],a=r[5],f=r[9],l=r[2],c=r[6],h=r[10];return t=t||this._order,t==="XYZ"?(this._y=Math.asin(n(o)),Math.abs(o)<.99999?(this._x=Math.atan2(-f,h),this._z=Math.atan2(-s,i)):(this._x=Math.atan2(c,a),this._z=0)):t==="YXZ"?(this._x=Math.asin(-n(f)),Math.abs(f)<.99999?(this._y=Math.atan2(o,h),this._z=Math.atan2(u,a)):(this._y=Math.atan2(-l,i),this._z=0)):t==="ZXY"?(this._x=Math.asin(n(c)),Math.abs(c)<.99999?(this._y=Math.atan2(-l,h),this._z=Math.atan2(-s,a)):(this._y=0,this._z=Math.atan2(u,i))):t==="ZYX"?(this._y=Math.asin(-n(l)),Math.abs(l)<.99999?(this._x=Math.atan2(c,h),this._z=Math.atan2(u,i)):(this._x=0,this._z=Math.atan2(-s,a))):t==="YZX"?(this._z=Math.asin(n(u)),Math.abs(u)<.99999?(this._x=Math.atan2(-f,a),this._y=Math.atan2(-l,i)):(this._x=0,this._y=Math.atan2(o,h))):t==="XZY"?(this._z=Math.asin(-n(s)),Math.abs(s)<.99999?(this._x=Math.atan2(c,a),this._y=Math.atan2(o,i)):(this._x=Math.atan2(-f,h),this._y=0)):console.warn("WARNING: Euler.setFromRotationMatrix() given unsupported order: "+t),this._order=t,this._updateQuaternion(),this},setFromQuaternion:function(e,t,n){function r(e){return Math.min(Math.max(e,-1),1)}var i=e.x*e.x,s=e.y*e.y,o=e.z*e.z,u=e.w*e.w;return t=t||this._order,t==="XYZ"?(this._x=Math.atan2(2*(e.x*e.w-e.y*e.z),u-i-s+o),this._y=Math.asin(r(2*(e.x*e.z+e.y*e.w))),this._z=Math.atan2(2*(e.z*e.w-e.x*e.y),u+i-s-o)):t==="YXZ"?(this._x=Math.asin(r(2*(e.x*e.w-e.y*e.z))),this._y=Math.atan2(2*(e.x*e.z+e.y*e.w),u-i-s+o),this._z=Math.atan2(2*(e.x*e.y+e.z*e.w),u-i+s-o)):t==="ZXY"?(this._x=Math.asin(r(2*(e.x*e.w+e.y*e.z))),this._y=Math.atan2(2*(e.y*e.w-e.z*e.x),u-i-s+o),this._z=Math.atan2(2*(e.z*e.w-e.x*e.y),u-i+s-o)):t==="ZYX"?(this._x=Math.atan2(2*(e.x*e.w+e.z*e.y),u-i-s+o),this._y=Math.asin(r(2*(e.y*e.w-e.x*e.z))),this._z=Math.atan2(2*(e.x*e.y+e.z*e.w),u+i-s-o)):t==="YZX"?(this._x=Math.atan2(2*(e.x*e.w-e.z*e.y),u-i+s-o),this._y=Math.atan2(2*(e.y*e.w-e.x*e.z),u+i-s-o),this._z=Math.asin(r(2*(e.x*e.y+e.z*e.w)))):t==="XZY"?(this._x=Math.atan2(2*(e.x*e.w+e.y*e.z),u-i+s-o),this._y=Math.atan2(2*(e.x*e.z+e.y*e.w),u+i-s-o),this._z=Math.asin(r(2*(e.z*e.w-e.x*e.y)))):console.warn("WARNING: Euler.setFromQuaternion() given unsupported order: "+t),this._order=t,n!==!1&&this._updateQuaternion(),this},reorder:function(){var e=new n.Quat;return function(t){e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],e[3]!==t&&(this._order=e[3]),this._updateQuaternion(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},clone:function(){return new n.Euler(this._x,this._y,this._z,this._order)}},n.math={},n.math.Plane=function(e,n){this.normal=e!==t?e:new o(1,0,0),this.constant=n!==t?n:0},n.math.Plane.prototype={constructor:n.math.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,n,r){return this.normal.set(e,t,n),this.constant=r,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(e,t,r){var i=n.math.Plane.__v1.subVectors(r,t).cross(n.math.Plane.__v2.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(e,t){var n=this.distanceToPoint(e),r=t||new o;return r.copy(this.normal).multiplyScalar(n)},isIntersectionLine:function(e,t){var n=this.distanceToPoint(e),r=this.distanceToPoint(t);return n<0&&r>0||r<0&&n>0},isIntersectionFace:function(e,t){var n=[];n.push(t[e.a]),n.push(t[e.b]),n.push(t[e.c]),e.d!=null&&n.push(t[e.d]);var r=[],i,s,o;for(i=0;i<n.length;i++)r.push(this.distanceToPoint(n[i]));for(i=0;i<r.length;i++)if(i==0)s=o=r[i];else{o=r[i];if(s<0&&o>0||o<0&&s>0)return"intersect";s=o}return o>0?"in":"out"},intersectLine:function(e,r,i){var s=i||new o,u=n.math.Plane.__v1.subVectors(r,e),a=this.normal.dot(u);if(a==0)return this.distanceToPoint(e)==0?s.copy(e):t;var f=-(e.dot(this.normal)+this.constant)/a;return f<0||f>1?t:s.copy(u).multiplyScalar(f).add(e)},coplanarPoint:function(e){var t=e||new o;return t.copy(this.normal).multiplyScalar(-this.constant)},transform:function(e,t){t=t||(new n.Mat3).getInverse(e).transpose();var r=n.math.Plane.__v1.copy(this.normal).applyMatrix3(t),i=this.coplanarPoint(n.math.Plane.__v2);return i.applyMatrix4(e),this.setFromNormalAndCoplanarPoint(r,i),this},translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant==this.constant},clone:function(){return(new n.math.Plane).copy(this)}},n.math.Plane.__vZero=new o(0,0,0),n.math.Plane.__v1=new o,n.math.Plane.__v2=new o,n.Frustum=function(e,r,i,s,o,u){this.planes=[e!==t?e:new n.math.Plane,r!==t?r:new n.math.Plane,i!==t?i:new n.math.Plane,s!==t?s:new n.math.Plane,o!==t?o:new n.math.Plane,u!==t?u:new n.math.Plane]},n.Frustum.prototype={set:function(e,t,n,r,i,s){var o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(n),o[3].copy(r),o[4].copy(i),o[5].copy(s),this},setPoints:function(e){this.points=e},copy:function(e){var t=this.planes;for(var n=0;n<6;n++)t[n].copy(e.planes[n]);return this},setFromMatrix:function(e){var t=this.planes,n=e.elements,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],f=n[6],l=n[7],c=n[8],h=n[9],p=n[10],d=n[11],v=n[12],m=n[13],g=n[14],y=n[15];return t[0].setComponents(o-r,l-u,d-c,y-v).normalize(),t[1].setComponents(o+r,l+u,d+c,y+v).normalize(),t[2].setComponents(o+i,l+a,d+h,y+m).normalize(),t[3].setComponents(o-i,l-a,d-h,y-m).normalize(),t[4].setComponents(o-s,l-f,d-p,y-g).normalize(),t[5].setComponents(o+s,l+f,d+p,y+g).normalize(),this},intersectsObjectAccurate:function(e,t){if(t==0)return this.intersectsObject(e);var r=e.worldMatrix,i=this.planes,s=e.vertices,o=[],u,a,f=s.length;for(a=0;a<f;a++){u=s[a].clone(),u.applyMatrix4(r),o.push(u);if(this.containsPoint(u))return!0}if(t==2)if(e instanceof n.Line)for(a=0,f=o.length;a<f-1;a++){var l=o[a],c=o[a+1];if(this.containsLine(l,c))return!0}else{var h=e.faces,p,d,v,m,g,y;for(a=0,f=h.length;a<f;a++){p=h[a];if(this.containsLine(o[p.a],o[p.b]))return!0;if(this.containsLine(o[p.b],o[p.c]))return!0;if(p.d!=null){if(this.containsLine(o[p.c],o[p.d]))return!0;if(this.containsLine(o[p.d],o[p.a]))return!0}else if(this.containsLine(o[p.a],o[p.c]))return!0}}return!1},intersectsObject:function(e){var t=e.worldMatrix,n=this.planes,r=t.getPosition();if(!e.computeBoundingSphere)return!1;e.boundingSphere||e.computeBoundingSphere();var i=-e.boundingSphere.radius*t.getMaxScaleOnAxis();for(var s=0;s<6;s++){var o=n[s].distanceToPoint(r);if(o<i)return!1}return!0},intersectsSphere:function(e){var t=this.planes,n=e.center,r=-e.radius;for(var i=0;i<6;i++){var s=t[i].distanceToPoint(n);if(s<r)return!1}return!0},intersectsBox:function(e){var t=new o,n=new o,r=this.planes;for(var i=0;i<6;i++){var s=r[i];t.x=s.normal.x>0?e.min.x:e.max.x,n.x=s.normal.x>0?e.max.x:e.min.x,t.y=s.normal.y>0?e.min.y:e.max.y,n.y=s.normal.y>0?e.max.y:e.min.y,t.z=s.normal.z>0?e.min.z:e.max.z,n.z=s.normal.z>0?e.max.z:e.min.z;var u=s.distanceToPoint(t),a=s.distanceToPoint(n);if(u<0&&a<0)return!1}return!0},containsLine:function(e,t){var n=this.planes,r=new o;for(var i=0;i<6;i++){r=n[i].intersectLine(e,t,r);if(r&&this.containsPoint(r))return!0}return!1},containsPoint:function(e){var t=this.planes;for(var n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0},clone:function(){return(new n.Frustum).copy(this)}},n.Ray=function(e,n){this.origin=e!==t?e:new o,this.direction=n!==t?n:new o},n.Ray.prototype={constructor:n.Ray,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){var n=t||new o;return n.copy(this.direction).multiplyScalar(e).add(this.origin)},recast:function(e){return this.origin.copy(this.at(e,n.Ray.__v1)),this},closestPointToPoint:function(e,t){var n=t||new o;n.subVectors(e,this.origin);var r=n.dot(this.direction);return n.copy(this.direction).multiplyScalar(r).add(this.origin)},distanceToPoint:function(e){var t=n.Ray.__v1.subVectors(e,this.origin).dot(this.direction);return n.Ray.__v1.copy(this.direction).multiplyScalar(t).add(this.origin),n.Ray.__v1.distanceTo(e)},isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},isIntersectionPlane:function(e){var t=e.normal.dot(this.direction);return t!=0?!0:e.distanceToPoint(this.origin)==0?!0:!1},distanceToPlane:function(e){var n=e.normal.dot(this.direction);if(n==0)return e.distanceToPoint(this.origin)==0?0:t;var r=-(this.origin.dot(e.normal)+e.constant)/n;return r},intersectPlane:function(e,n){var r=this.distanceToPlane(e);return r===t?t:this.at(r,n)},transform:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this},distanceSqToSegment:function(e,t,n,r){var i=e.clone().add(t).multiplyScalar(.5),s=t.clone().sub(e).normalize(),o=e.distanceTo(t)*.5,u=this.origin.clone().sub(i),a=-this.direction.dot(s),f=u.dot(this.direction),l=-u.dot(s),c=u.lengthSq(),h=Math.abs(1-a*a),p,d,v,m;if(h>=0){p=a*l-f,d=a*f-l,m=o*h;if(p>=0)if(d>=-m)if(d<=m){var g=1/h;p*=g,d*=g,v=p*(p+a*d+2*f)+d*(a*p+d+2*l)+c}else d=o,p=Math.max(0,-(a*d+f)),v=-p*p+d*(d+2*l)+c;else d=-o,p=Math.max(0,-(a*d+f)),v=-p*p+d*(d+2*l)+c;else d<=-m?(p=Math.max(0,-(-a*o+f)),d=p>0?-o:Math.min(Math.max(-o,-l),o),v=-p*p+d*(d+2*l)+c):d<=m?(p=0,d=Math.min(Math.max(-o,-l),o),v=d*(d+2*l)+c):(p=Math.max(0,-(a*o+f)),d=p>0?o:Math.min(Math.max(-o,-l),o),v=-p*p+d*(d+2*l)+c)}else d=a>0?-o:o,p=Math.max(0,-(a*d+f)),v=-p*p+d*(d+2*l)+c;return n&&n.copy(this.direction.clone().multiplyScalar(p).add(this.origin)),r&&r.copy(s.clone().multiplyScalar(d).add(i)),v},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)},clone:function(){return(new n.Ray).copy(this)}},n.Ray.__v1=new o,n.Ray.__v2=new o,n.Triangle=function(e,n,r){this.a=e!==t?e:new o,this.b=n!==t?n:new o,this.c=r!==t?r:new o},n.Triangle.normal=function(e,t,r,i){var s=i||new o;s.subVectors(r,t),n.Triangle.__v0.subVectors(e,t),s.cross(n.Triangle.__v0);var u=s.lengthSq();return u>0?s.multiplyScalar(1/Math.sqrt(u)):s.set(0,0,0)},n.Triangle.barycoordFromPoint=function(e,t,r,i,s){n.Triangle.__v0.subVectors(i,t),n.Triangle.__v1.subVectors(r,t),n.Triangle.__v2.subVectors(e,t);var u=n.Triangle.__v0.dot(n.Triangle.__v0),a=n.Triangle.__v0.dot(n.Triangle.__v1),f=n.Triangle.__v0.dot(n.Triangle.__v2),l=n.Triangle.__v1.dot(n.Triangle.__v1),c=n.Triangle.__v1.dot(n.Triangle.__v2),h=u*l-a*a,p=s||new o;if(h==0)return p.set(-2,-1,-1);var d=1/h,v=(l*f-a*c)*d,m=(u*c-a*f)*d;return p.set(1-v-m,m,v)},n.Triangle.containsPoint=function(e,t,r,i){var s=n.Triangle.barycoordFromPoint(e,t,r,i,n.Triangle.__v3);return s.x>=0&&s.y>=0&&s.x+s.y<=1},n.Triangle.prototype={constructor:n.Triangle,set:function(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this},setFromPointsAndIndices:function(e,t,n,r){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[r]),this},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){return n.Triangle.__v0.subVectors(this.c,this.b),n.Triangle.__v1.subVectors(this.a,this.b),n.Triangle.__v0.cross(n.Triangle.__v1).length()*.5},midpoint:function(e){var t=e||new o;return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return n.Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){var t=e||new n.math.Plane;return t.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return n.Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return n.Triangle.containsPoint(e,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)},clone:function(){return(new n.Triangle).copy(this)},intersectLine:function(e,t){var n=this.plane(),r=n.intersectLine(e,t);return r!=null&&this.containsPoint(r)}},n.Triangle.__v0=new o,n.Triangle.__v1=new o,n.Triangle.__v2=new o,n.Triangle.__v3=new o;var h={getLogicalPoint:function(e,t){var n,r=e.getBoundingClientRect();if(p.isTouchable&&t.changedTouches&&t.changedTouches.length>0){var i=t.changedTouches[0],s=p.isAndroid?0:$touch.scrollLeft(),o=p.isAndroid?0:$touch.scrollTop();n={x:i.clientX+e.scrollLeft-r.left-s,y:i.clientY+e.scrollTop-r.top-o}}else{if(!h.isValidEvent(e,t))return null;n={x:t.clientX-r.left+e.scrollLeft,y:t.clientY-r.top+e.scrollTop}}return n},isValidEvent:function(e,t){if(!t)return!1;if(t.target===e)if(p.isFirefox){if(e.clientHeight<e.scrollHeight&&t.layerX<25)return!1;if(e.clientWidth<e.scrollWidth&&t.layerY<25)return!1}else if(t.offsetX>e.clientWidth||t.offsetY>e.clientHeight)return!1;return!0},isImage:function(e){return e&&e.nodeName&&e.nodeName.toLowerCase()==="img"},isCanvas:function(e){return e&&e.nodeName&&e.nodeName.toLowerCase()==="canvas"},createView:function(e,t){var n=document.createElement("div");return n.style.position=D.VIEW_POSITION,n.style.fontSize=D.VIEW_FONT_SIZE,n.style.fontFamily=D.VIEW_FONT_FAMILY,n.style.cursor="default",n.style.outline="none",n.style.textAlign="left",n.style.msTouchAction="none",n.tabIndex=0,t||(n.onmousedown=h.preventDefault),n.style.setProperty&&(n.style.setProperty("-khtml-user-select","none",null),n.style.setProperty("-webkit-user-select","none",null),n.style.setProperty("-moz-user-select","none",null),n.style.setProperty("-webkit-tap-highlight-color","rgba(0, 0, 0, 0)",null)),e&&(n.style.overflow=e),n},preventDefault:function(e){if(D.KEEP_DEFAULT_FUNCTION(e))return;e.preventDefault?e.preventDefault():e.preventManipulation?e.preventManipulation():e.returnValue=!1},createCanvas:function(e){var t=document.createElement("canvas"),n=e.getView();return t.width=n.width,t.height=n.height,t.style.msTouchAction="none",t.style.position="absolute",t},isCtrlDown:function(e){return e.ctrlKey||e.metaKey},getScrollTop:function(e){if(!e)return 0;var t=e.scrollTop,n=e.parentElement;return t+this.getScrollTop(n)},getScrollLeft:function(e){if(!e)return 0;var t=e.scrollLeft,n=e.parentElement;return t+this.getScrollLeft(n)},debug:function(e,t){try{e.call(t)}catch(n){alert(n)}},setFocus:function(e){if(document.activeElement===e)return;var t,n,r=document.documentElement,i=document.body,s;r&&(p.isIE||p.isOpera||r.scrollLeft||r.scrollTop)&&(t=r.scrollLeft,n=r.scrollTop,s=r),e.focus(),s&&(s.scrollLeft=t,s.scrollTop=n)},isRightClick:function(t){var n;if(!t)var t=e.event;return t.which?n=t.which==3:t.button&&(n=t.button==2),n}};n.html=h;var p=function(){var e={},t=navigator.userAgent.toLowerCase();return e.isOpera=/opera/.test(t),e.isIE=/msie/.test(t)||/trident/.test(t),e.isFirefox=/firefox/i.test(t),e.isChrome=/chrome/i.test(t),e.isSafari=!e.isChrome&&/safari/i.test(t),e.isIPhone=/iphone/.test(t),e.isIPod=/ipod/.test(t),e.isIPad=/ipad/.test(t),e.isAndroid=/android/i.test(t),e.isWebOS=/webos/i.test(t),e.isMSToucheable=navigator.msMaxTouchPoints&&navigator.msMaxTouchPoints>1,e.isTouchable="ontouchend"in document||e.isMSToucheable,e.isIOS=e.isIPhone||e.isIPod||e.isIPad,e}();n.ua=p,function(){function r(e){var n,r,i,s,o,u;i=e.length,r=0,n="";while(r<i){s=e.charCodeAt(r++)&255;if(r==i){n+=t.charAt(s>>2),n+=t.charAt((s&3)<<4),n+="==";break}o=e.charCodeAt(r++);if(r==i){n+=t.charAt(s>>2),n+=t.charAt((s&3)<<4|(o&240)>>4),n+=t.charAt((o&15)<<2),n+="=";break}u=e.charCodeAt(r++),n+=t.charAt(s>>2),n+=t.charAt((s&3)<<4|(o&240)>>4),n+=t.charAt((o&15)<<2|(u&192)>>6),n+=t.charAt(u&63)}return n}function i(e){var t,r,i,s,o,u,a;u=e.length,o=0,a="";while(o<u){do t=n[e.charCodeAt(o++)&255];while(o<u&&t==-1);if(t==-1)break;do r=n[e.charCodeAt(o++)&255];while(o<u&&r==-1);if(r==-1)break;a+=String.fromCharCode(t<<2|(r&48)>>4);do{i=e.charCodeAt(o++)&255;if(i==61)return a;i=n[i]}while(o<u&&i==-1);if(i==-1)break;a+=String.fromCharCode((r&15)<<4|(i&60)>>2);do{s=e.charCodeAt(o++)&255;if(s==61)return a;s=n[s]}while(o<u&&s==-1);if(s==-1)break;a+=String.fromCharCode((i&3)<<6|s)}return a}var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);e.btoa||(e.btoa=r),e.atob||(e.atob=i)}();var d=function(){var t=!1,n=document.createElement("canvas");n.getContext("2d")&&(t=!0);if(!t)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var r=!!n.getContext("2d").getImageData,i=!!n.toDataURL,s=!!e.btoa,o="image/octet-stream",u=function(e){var t=parseInt(e.width),n=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,n)},a=function(e){var t="";if(typeof e=="string")t=e;else{var n=e;for(var r=0;r<n.length;r++)t+=String.fromCharCode(n[r])}return btoa(t)},f=function(e){var t=[],n=e.width,r=e.height;t.push(66),t.push(77);var i=n*r*3+54;t.push(i%256),i=Math.floor(i/256),t.push(i%256),i=Math.floor(i/256),t.push(i%256),i=Math.floor(i/256),t.push(i%256),t.push(0),t.push(0),t.push(0),t.push(0),t.push(54),t.push(0),t.push(0),t.push(0);var s=[];s.push(40),s.push(0),s.push(0),s.push(0);var o=n;s.push(o%256),o=Math.floor(o/256),s.push(o%256),o=Math.floor(o/256),s.push(o%256),o=Math.floor(o/256),s.push(o%256);var u=r;s.push(u%256),u=Math.floor(u/256),s.push(u%256),u=Math.floor(u/256),s.push(u%256),u=Math.floor(u/256),s.push(u%256),s.push(1),s.push(0),s.push(24),s.push(0),s.push(0),s.push(0),s.push(0),s.push(0);var f=n*r*3;s.push(f%256),f=Math.floor(f/256),s.push(f%256),f=Math.floor(f/256),s.push(f%256),f=Math.floor(f/256),s.push(f%256);for(var l=0;l<16;l++)s.push(0);var c=(4-n*3%4)%4,h=e.data,p="",d=r;do{var v=n*(d-1)*4,m="";for(var g=0;g<n;g++){var y=4*g;m+=String.fromCharCode(h[v+y+2]),m+=String.fromCharCode(h[v+y+1]),m+=String.fromCharCode(h[v+y])}for(var b=0;b<c;b++)m+=String.fromCharCode(0);p+=m}while(--d);var w=a(t.concat(s))+a(p);return w},l=function(e,t){return"data:"+t+";base64,"+e},c=function(e){var t=document.createElement("img");return t.src=e,t},h=function(e,t,n,r,i){n=n||(t?t.w:e.width),r=r||(t?t.h:e.height);var s=document.createElement("canvas");s.width=n,s.height=r,s.style.width=n+"px",s.style.height=r+"px";var o=s.getContext("2d"),o=s.getContext("2d"),u=e.style.backgroundColor;return u||(i==="PNG"?u="rgba(255,255,255,0.0)":i==="BMP"?u="rgba(255,255,255,0.01)":u="#FFFFFF"),o.fillStyle=u,o.fillRect(0,0,n,r),t=t?t:{x:0,y:0,w:e.width,h:e.height},o.drawImage(e,t.x,t.y,t.w,t.h,0,0,n,r),s};return{saveAsPNG:function(e,t,n,r,s){if(!i)return!1;var o=h(e,t,r,s,"PNG"),u=o.toDataURL("image/png");return n?c(u):u},saveAsJPEG:function(e,t,n,r,s){if(!i)return!1;var o=h(e,t,r,s,"JPEG"),u="image/jpeg",a=o.toDataURL(u);return a.indexOf(u)!=5?!1:n?c(a):a},saveAsBMP:function(e,t,n,i,o){if(!r||!s)return!1;var a=h(e,t,i,o,"BMP"),p=u(a),d=f(p);return n?c(l(d,"image/bmp")):l(d,"image/bmp")}}}(),g={},y={cache:{},g:document.createElement("canvas").getContext("2d"),getTextSize:function(e,t){y.g.font=e?e:D.FONT;var n=y.cache[y.g.font];return n||(n=y.g.measureText("e").width*2+4,y.cache[y.g.font]=n),{width:y.g.measureText(t).width+4,height:n}}};g.g=y,n.g=y;var w={},E=setTimeout;w.bcld=function(e,t,n,r,i,u,a,f,l){var c=e/2,h,p,d=[],v=[],m={vertices:[],faces:[],uvs:[],uv2s:[]};for(p=0;p<=t;p++){var g=[],y=[],b=p/t,w=b*(n-r)+r;for(h=0;h<=i;h++){var E=h/i,S=new o;S.x=w*Math.sin(E*f+l),S.y=-b*e+c,S.z=w*Math.cos(E*f+l),m.vertices.push(S),g.push(m.vertices.length-1),y.push(new s(E,1-b))}d.push(g),v.push(y)}var x=(n-r)/e,T,N;for(h=0;h<i;h++){r!==0?(T=m.vertices[d[0][h]].clone(),N=m.vertices[d[0][h+1]].clone()):(T=m.vertices[d[1][h]].clone(),N=m.vertices[d[1][h+1]].clone()),T.setY(Math.sqrt(T.x*T.x+T.z*T.z)*x).normalize(),N.setY(Math.sqrt(N.x*N.x+N.z*N.z)*x).normalize();for(p=0;p<t;p++){var C=d[p][h],k=d[p+1][h],L=d[p+1][h+1],A=d[p][h+1],M=T.clone(),_=T.clone(),D=N.clone(),P=N.clone(),H=v[p][h].clone(),B=v[p+1][h].clone(),j=v[p+1][h+1].clone(),F=v[p][h+1].clone();m.faces.push(new O(C,k,A,[M,_,P],null,0)),m.uvs.push([H,B,F]),m.uv2s.push([H.clone(),B.clone(),F.clone()]),m.faces.push(new O(k,L,A,[_,D,P],null,0)),m.uvs.push([B,j,F]),m.uv2s.push([B.clone(),j.clone(),F.clone()])}}var I=!1;if(u===!1&&r>0){m.vertices.push(new o(0,c,0)),I=!0;for(h=0;h<i;h++){var C=d[0][h],k=d[0][h+1],L=m.vertices.length-1,M=new o(0,1,0),_=new o(0,1,0),D=new o(0,1,0),q=m.vertices[C],R=m.vertices[k],H=new s((q.x/r+1)/2,1-(q.z/r+1)/2),B=new s((R.x/r+1)/2,1-(R.z/r+1)/2),j=new s(.5,.5);m.faces.push(new O(C,k,L,[M,_,D],null,1)),m.uvs.push([H,B,j]),m.uv2s.push([H.clone(),B.clone(),j.clone()])}}var U=!1;if(a===!1&&n>0){m.vertices.push(new o(0,-c,0)),U=!0;for(h=0;h<i;h++){var C=d[p][h+1],k=d[p][h],L=m.vertices.length-1,M=new o(0,-1,0),_=new o(0,-1,0),D=new o(0,-1,0),q=m.vertices[C],R=m.vertices[k],H=new s((q.x/n+1)/2,(q.z/n+1)/2),B=new s((R.x/n+1)/2,(R.z/n+1)/2),j=new s(.5,.5);m.faces.push(new O(C,k,L,[M,_,D],null,2)),m.uvs.push([H,B,j]),m.uv2s.push([H.clone(),B.clone(),j.clone()])}}if(f!==Math.PI*2){!I&&m.vertices.push(new o(0,c,0)),!U&&m.vertices.push(new o(0,-c,0));var C=d[0][0],k=d[t][0],L=m.vertices.length-1,A=m.vertices.length-2,H=new s(0,0),B=new s(0,1),j=new s(1,1),F=new s(1,0);m.faces.push(new O(C,L,k)),m.uvs.push([H,j,B]),m.uv2s.push([H.clone(),j.clone(),B.clone()]),m.faces.push(new O(A,L,C)),m.uvs.push([F,j,H]),m.uv2s.push([F.clone(),j.clone(),H.clone()]),C=d[0][i],k=d[t][i];var H=new s(0,0),B=new s(0,1),j=new s(1,1),F=new s(1,0);m.faces.push(new O(C,k,A)),m.uvs.push([H,B,F]),m.uv2s.push([H.clone(),B.clone(),F.clone()]),m.faces.push(new O(k,L,A)),m.uvs.push([B,j,F]),m.uv2s.push([B.clone(),j.clone(),F.clone()])}return m},w.buildCubeData=function(e,t,n,r,i,u,a,f){function v(v){var m,g,y,b,w,E,S,x,T,N;l=c.length;var C,k=a=="six-each"||a=="front-other"||a=="back-other"||a=="left-other"||a=="right-other"||a=="top-other"||a=="bottom-other",L=new s(0,0),A=k?new s(1/3,.5):new s(1,1),O=a.split("-")[0];O=="six"?O=null:A=new s(.5,1),v=="right"?(m="z",g="y",y="x",b=-1,w=-1,E=e/2,S=n,x=t,T=u,N=i,C=0,L=new s(2/3,0)):v=="left"?(m="z",g="y",y="x",b=1,w=-1,E=-e/2,S=n,x=t,T=u,N=i,C=1):v=="top"?(m="x",g="z",y="y",b=1,w=1,E=t/2,S=e,x=n,T=r,N=u,C=2,L=new s(1/3,.5)):v=="bottom"?(m="x",g="z",y="y",b=1,w=-1,E=-t/2,S=e,x=n,T=r,N=u,C=3,L=new s(0,.5)):v=="front"?(m="x",g="y",y="z",b=1,w=-1,E=n/2,S=e,x=t,T=r,N=i,C=4,L=new s(1/3,0)):v=="back"&&(m="x",g="y",y="z",b=-1,w=-1,E=-n/2,S=e,x=t,T=r,N=i,C=5,L=new s(2/3,.5)),O&&(O==v?L=new s(0,0):L=new s(.5,0));var _,D,P=T+1,H=N+1;for(D=0;D<H;D++)for(_=0;_<P;_++){var B=new o;B[m]=(_/T*S-S/2)*b+f[m],B[g]=(D/N*x-x/2)*w+f[g],B[y]=E+f[y],c.push(B)}k&&(C=0);var j=new o;j[y]=E>0?1:-1;for(D=0;D<N;D++)for(_=0;_<T;_++){var F=_+P*D,I=_+P*(D+1),q=_+1+P*(D+1),R=_+1+P*D,U=[new s(_/T,1-D/N),new s(_/T,1-(D+1)/N),new s((_+1)/T,1-(D+1)/N),new s((_+1)/T,1-D/N)];if(k)for(var z=0;z<U.length;z++)U[z].multiply(A).add(L);var W=new M(F+l,I+l,q+l,R+l);W.normal.copy(j),W.vertexNormals.push(j.clone(),j.clone(),j.clone(),j.clone()),W.materialIndex=C,h.push(W),p.push([U[0],U[1],U[2],U[3]]),d.push([U[0].clone(),U[1].clone(),U[2].clone(),U[3].clone()])}}var l,c=[],h=[],p=[],d=[];v("right"),v("left"),v("top"),v("bottom"),v("front"),v("back");var m={vertices:c,faces:h,uvs:p,uv2s:d};return m},w.bsd=function(e,t,n,r,i,u,a){var f,l,c=[],h=[],p=[],d=[],v=[],m=[];for(l=0;l<=n;l++){var g=[],y=[];for(f=0;f<=t;f++){var b=f/t,w=l/n,E=new o;E.x=-e*Math.cos(r+b*i)*Math.sin(u+w*a),E.y=e*Math.cos(u+w*a),E.z=e*Math.sin(r+b*i)*Math.sin(u+w*a),c.push(E),g.push(c.length-1),y.push(new s(b,1-w))}v.push(g),m.push(y)}for(l=0;l<n;l++)for(f=0;f<t;f++){var S=v[l][f+1],x=v[l][f],T=v[l+1][f],N=v[l+1][f+1],C=c[S].clone().normalize(),k=c[x].clone().normalize(),L=c[T].clone().normalize(),A=c[N].clone().normalize(),M=m[l][f+1].clone(),_=m[l][f].clone(),D=m[l+1][f].clone(),P=m[l+1][f+1].clone();Math.abs(c[S].y)===e?(p.push(new O(S,T,N,[C,L,A])),h.push([M,D,P]),d.push([M.clone(),D.clone(),P.clone()])):Math.abs(c[T].y)===e?(p.push(new O(S,x,T,[C,k,L])),h.push([M,_,D]),d.push([M.clone(),_.clone(),D.clone()])):(p.push(new O(S,x,N,[C,k,A])),h.push([M,_,P]),d.push([M.clone(),_.clone(),P.clone()]),p.push(new O(x,T,N,[k.clone(),L,A.clone()])),h.push([_.clone(),D,P.clone()]),d.push([_.clone(),D.clone(),P.clone()]))}return{vertices:c,faces:p,uvs:h,uv2s:d}};var S=function(e){var r,i,s,o,u,a,f,l={},c=e.primitive;if(c.groups){e.groups=c.groups,e.groupList=c.groupList;return}c.groups={};var h=e.material,p=e.getMaterialMapping();for(r=0,i=c.faces.length;r<i;r++)s=c.faces[r],o=h instanceof n.ArrayMaterial?s.materialIndex:0,o=p[o],o==null,a=o!==t?o:-1,l[a]===t&&(l[a]={hash:a,counter:0}),f=l[a].hash+"_"+l[a].counter,c.groups[f]===t&&(c.groups[f]={faces3:[],faces4:[],materialIndex:o,vertices:0}),u=s instanceof O?3:4,c.groups[f].vertices+u>65535&&(l[a].counter+=1,f=l[a].hash+"_"+l[a].counter,c.groups[f]===t&&(c.groups[f]={faces3:[],faces4:[],materialIndex:o,vertices:0})),s instanceof O?c.groups[f].faces3.push(r):c.groups[f].faces4.push(r),c.groups[f].vertices+=u;c.groupsList=[];for(var d in e.groups)c.groupsList.push(e.groups[d]);e.groups=c.groups,e.groupList=c.groupsList},x=function(e,n,r,i){var s,o,u,a,f,l,c=e,h=c,p=h.vertices,d=p.length,v=h.colors,m=v.length,g=i.__vertexArray,y=i.__colorArray,b=i.__sortArray,w=h.verticesNeedUpdate,E=h.elementsNeedUpdate,S=h.colorsNeedUpdate,x=h.__webglCustomAttributesList,T,N,C,k,L,A,O;if(c.sortParticles){_projScreenMatrixPS.copy(_projScreenMatrix),_projScreenMatrixPS.multiply(c.matrixWorld);for(s=0;s<d;s++)u=p[s],_vector3.copy(u),_vector3.applyProjection(_projScreenMatrixPS),b[s]=[_vector3.z,s];b.sort(numericalSort);for(s=0;s<d;s++)u=p[b[s][1]],a=s*3,g[a]=u.x,g[a+1]=u.y,g[a+2]=u.z;for(o=0;o<m;o++)a=o*3,l=v[b[o][1]],y[a]=l.r,y[a+1]=l.g,y[a+2]=l.b;if(x)for(T=0,N=x.length;T<N;T++){O=x[T];if(O.boundTo!==t&&O.boundTo!=="vertices")continue;a=0,L=O.value.length;if(O.size===1)for(k=0;k<L;k++)f=b[k][1],O.array[k]=O.value[f];else if(O.size===2)for(k=0;k<L;k++)f=b[k][1],A=O.value[f],O.array[a]=A.x,O.array[a+1]=A.y,a+=2;else if(O.size===3)if(O.type==="c")for(k=0;k<L;k++)f=b[k][1],A=O.value[f],O.array[a]=A.r,O.array[a+1]=A.g,O.array[a+2]=A.b,a+=3;else for(k=0;k<L;k++)f=b[k][1],A=O.value[f],O.array[a]=A.x,O.array[a+1]=A.y,O.array[a+2]=A.z,a+=3;else if(O.size===4)for(k=0;k<L;k++)f=b[k][1],A=O.value[f],O.array[a]=A.x,O.array[a+1]=A.y,O.array[a+2]=A.z,O.array[a+3]=A.w,a+=4}}else{if(w)for(s=0;s<d;s++)u=p[s],a=s*3,g[a]=u.x,g[a+1]=u.y,g[a+2]=u.z;if(S)for(o=0;o<m;o++)l=v[o],a=o*3,y[a]=l.r,y[a+1]=l.g,y[a+2]=l.b;if(x)for(T=0,N=x.length;T<N;T++){O=x[T];if(O.needsUpdate&&(O.boundTo===t||O.boundTo==="vertices")){L=O.value.length,a=0;if(O.size===1)for(k=0;k<L;k++)O.array[k]=O.value[k];else if(O.size===2)for(k=0;k<L;k++)A=O.value[k],O.array[a]=A.x,O.array[a+1]=A.y,a+=2;else if(O.size===3)if(O.type==="c")for(k=0;k<L;k++)A=O.value[k],O.array[a]=A.r,O.array[a+1]=A.g,O.array[a+2]=A.b,a+=3;else for(k=0;k<L;k++)A=O.value[k],O.array[a]=A.x,O.array[a+1]=A.y,O.array[a+2]=A.z,a+=3;else if(O.size===4)for(k=0;k<L;k++)A=O.value[k],O.array[a]=A.x,O.array[a+1]=A.y,O.array[a+2]=A.z,O.array[a+3]=A.w,a+=4}}}if(w||c.sortParticles)r.bindBuffer(r.ARRAY_BUFFER,i.__webglVertexBuffer),r.bufferData(r.ARRAY_BUFFER,g,n);if(S||c.sortParticles)r.bindBuffer(r.ARRAY_BUFFER,i.__webglColorBuffer),r.bufferData(r.ARRAY_BUFFER,y,n);if(x)for(T=0,N=x.length;T<N;T++){O=x[T];if(O.needsUpdate||c.sortParticles)r.bindBuffer(r.ARRAY_BUFFER,O.buffer),r.bufferData(r.ARRAY_BUFFER,O.array,n)}};w.buildGroupBufferData=function(e,r,i,s,o,u,a,f){var l=o._type=="basic"?!1:!0,c=o.isVertexColor(),h=o.needUV(),p=f.needSmoothNormal(r,o),d,v,m,g,y,b,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt,vt,mt,gt,yt,bt=0,wt=0,Et=0,St=0,xt=0,Tt=0,Nt=0,Ct=0,kt=0,Lt=0,At=0,Ot=0,Mt=0,_t,Dt=a.__vertexArray,Pt=a.__uvArray,Ht=a.__uv2Array,Bt=a.__normalArray,jt=a.__colorArray,Ft=a.__webglCustomAttributesList,It,qt=a.__faceArray,Rt=a.__lineArray,Ut=r,zt=Ut.verticesNeedUpdate,Wt=Ut.elementsNeedUpdate,Xt=Ut.uvsNeedUpdate,Vt=Ut.normalsNeedUpdate,$t=Ut.tangentsNeedUpdate,Jt=Ut.colorsNeedUpdate,Kt=Ut.morphTargetsNeedUpdate,Qt=Ut.vertices,Gt=e.faces3,Yt=e.faces4,Zt=Ut.faces,en=Ut.uvs,tn=Ut.uv2s,nn=Ut.colors,rn=Ut.skinIndices,sn=Ut.skinWeights,on=Ut.morphTargets,un=Ut.morphNormals;if(zt){for(d=0,v=Gt.length;d<v;d++)g=Zt[Gt[d]],k=Qt[g.a],L=Qt[g.b],A=Qt[g.c],Dt[wt]=k.x,Dt[wt+1]=k.y,Dt[wt+2]=k.z,Dt[wt+3]=L.x,Dt[wt+4]=L.y,Dt[wt+5]=L.z,Dt[wt+6]=A.x,Dt[wt+7]=A.y,Dt[wt+8]=A.z,wt+=9;for(d=0,v=Yt.length;d<v;d++)g=Zt[Yt[d]],k=Qt[g.a],L=Qt[g.b],A=Qt[g.c],O=Qt[g.d],Dt[wt]=k.x,Dt[wt+1]=k.y,Dt[wt+2]=k.z,Dt[wt+3]=L.x,Dt[wt+4]=L.y,Dt[wt+5]=L.z,Dt[wt+6]=A.x,Dt[wt+7]=A.y,Dt[wt+8]=A.z,Dt[wt+9]=O.x,Dt[wt+10]=O.y,Dt[wt+11]=O.z,wt+=12;u.bindBuffer(u.ARRAY_BUFFER,a.__webglVertexBuffer),u.bufferData(u.ARRAY_BUFFER,Dt,i),a.__vertexArray=Dt}if(Jt&&c){for(d=0,v=Gt.length;d<v;d++)g=Zt[Gt[d]],S=g.vertexColors,x=g.color,S.length===3&&c===n.VertexColors?(I=S[0],q=S[1],R=S[2]):(I=x,q=x,R=x),jt[kt]=I.r,jt[kt+1]=I.g,jt[kt+2]=I.b,jt[kt+3]=q.r,jt[kt+4]=q.g,jt[kt+5]=q.b,jt[kt+6]=R.r,jt[kt+7]=R.g,jt[kt+8]=R.b,kt+=9;for(d=0,v=Yt.length;d<v;d++)g=Zt[Yt[d]],S=g.vertexColors,x=g.color,S.length===4&&c===n.VertexColors?(I=S[0],q=S[1],R=S[2],U=S[3]):(I=x,q=x,R=x,U=x),jt[kt]=I.r,jt[kt+1]=I.g,jt[kt+2]=I.b,jt[kt+3]=q.r,jt[kt+4]=q.g,jt[kt+5]=q.b,jt[kt+6]=R.r,jt[kt+7]=R.g,jt[kt+8]=R.b,jt[kt+9]=U.r,jt[kt+10]=U.g,jt[kt+11]=U.b,kt+=12;kt>0&&(u.bindBuffer(u.ARRAY_BUFFER,a.__webglColorBuffer),u.bufferData(u.ARRAY_BUFFER,jt,i))}if(Vt&&l){for(d=0,v=Gt.length;d<v;d++){g=Zt[Gt[d]],y=g.vertexNormals,b=g.normal;if(y.length===3&&p)for(ut=0;ut<3;ut++)ft=y[ut],Bt[Tt]=ft.x,Bt[Tt+1]=ft.y,Bt[Tt+2]=ft.z,Tt+=3;else for(ut=0;ut<3;ut++)Bt[Tt]=b.x,Bt[Tt+1]=b.y,Bt[Tt+2]=b.z,Tt+=3}for(d=0,v=Yt.length;d<v;d++){g=Zt[Yt[d]],y=g.vertexNormals,b=g.normal;if(
y.length===4&&p)for(ut=0;ut<4;ut++)ft=y[ut],Bt==null&&console.log("normal array is null"),Bt[Tt]=ft.x,Bt[Tt+1]=ft.y,Bt[Tt+2]=ft.z,Tt+=3;else for(ut=0;ut<4;ut++)Bt[Tt]=b.x,Bt[Tt+1]=b.y,Bt[Tt+2]=b.z,Tt+=3}u.bindBuffer(u.ARRAY_BUFFER,a.__webglNormalBuffer),u.bufferData(u.ARRAY_BUFFER,Bt,i),a.__normalArray=Bt}if(Xt&&en&&h){for(d=0,v=Gt.length;d<v;d++){m=Gt[d],N=en[m];if(N===t)continue;for(ut=0;ut<3;ut++)lt=N[ut],Pt[Et]=lt.x,Pt[Et+1]=lt.y,Et+=2}for(d=0,v=Yt.length;d<v;d++){m=Yt[d],N=en[m];if(N===t)continue;for(ut=0;ut<4;ut++)lt=N[ut],Pt[Et]=lt.x,Pt[Et+1]=lt.y,Et+=2}Et>0&&(u.bindBuffer(u.ARRAY_BUFFER,a.__webglUVBuffer),u.bufferData(u.ARRAY_BUFFER,Pt,i),a.uvArray=Pt)}if(Xt&&tn&&h){for(d=0,v=Gt.length;d<v;d++){m=Gt[d],C=tn[m];if(C===t)continue;for(ut=0;ut<3;ut++)ct=C[ut],Ht[St]=ct.x,Ht[St+1]=ct.y,St+=2}for(d=0,v=Yt.length;d<v;d++){m=Yt[d],C=tn[m];if(C===t)continue;for(ut=0;ut<4;ut++)ct=C[ut],Ht[St]=ct.x,Ht[St+1]=ct.y,St+=2}St>0&&(u.bindBuffer(u.ARRAY_BUFFER,a.__webglUV2Buffer),u.bufferData(u.ARRAY_BUFFER,Ht,i))}if(Wt){for(d=0,v=Gt.length;d<v;d++)qt[xt]=bt,qt[xt+1]=bt+1,qt[xt+2]=bt+2,xt+=3,Rt[Ct]=bt,Rt[Ct+1]=bt+1,Rt[Ct+2]=bt,Rt[Ct+3]=bt+2,Rt[Ct+4]=bt+1,Rt[Ct+5]=bt+2,Ct+=6,bt+=3;for(d=0,v=Yt.length;d<v;d++)qt[xt]=bt,qt[xt+1]=bt+1,qt[xt+2]=bt+3,qt[xt+3]=bt+1,qt[xt+4]=bt+2,qt[xt+5]=bt+3,xt+=6,Rt[Ct]=bt,Rt[Ct+1]=bt+1,Rt[Ct+2]=bt,Rt[Ct+3]=bt+3,Rt[Ct+4]=bt+1,Rt[Ct+5]=bt+2,Rt[Ct+6]=bt+2,Rt[Ct+7]=bt+3,Ct+=8,bt+=4;u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,a.__webglFaceBuffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,qt,i),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,a.__webglLineBuffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,Rt,i),a.__lineArray=Rt}if(Ft)for(ut=0,at=Ft.length;ut<at;ut++){It=Ft[ut];if(!It.__original.needsUpdate)continue;Ot=0,Mt=0;if(It.size===1){if(It.boundTo===t||It.boundTo==="vertices"){for(d=0,v=Gt.length;d<v;d++)g=Zt[Gt[d]],It.array[Ot]=It.value[g.a],It.array[Ot+1]=It.value[g.b],It.array[Ot+2]=It.value[g.c],Ot+=3;for(d=0,v=Yt.length;d<v;d++)g=Zt[Yt[d]],It.array[Ot]=It.value[g.a],It.array[Ot+1]=It.value[g.b],It.array[Ot+2]=It.value[g.c],It.array[Ot+3]=It.value[g.d],Ot+=4}else if(It.boundTo==="faces"){for(d=0,v=Gt.length;d<v;d++)_t=It.value[Gt[d]],It.array[Ot]=_t,It.array[Ot+1]=_t,It.array[Ot+2]=_t,Ot+=3;for(d=0,v=Yt.length;d<v;d++)_t=It.value[Yt[d]],It.array[Ot]=_t,It.array[Ot+1]=_t,It.array[Ot+2]=_t,It.array[Ot+3]=_t,Ot+=4}}else if(It.size===2){if(It.boundTo===t||It.boundTo==="vertices"){for(d=0,v=Gt.length;d<v;d++)g=Zt[Gt[d]],k=It.value[g.a],L=It.value[g.b],A=It.value[g.c],It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=L.x,It.array[Ot+3]=L.y,It.array[Ot+4]=A.x,It.array[Ot+5]=A.y,Ot+=6;for(d=0,v=Yt.length;d<v;d++)g=Zt[Yt[d]],k=It.value[g.a],L=It.value[g.b],A=It.value[g.c],O=It.value[g.d],It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=L.x,It.array[Ot+3]=L.y,It.array[Ot+4]=A.x,It.array[Ot+5]=A.y,It.array[Ot+6]=O.x,It.array[Ot+7]=O.y,Ot+=8}else if(It.boundTo==="faces"){for(d=0,v=Gt.length;d<v;d++)_t=It.value[Gt[d]],k=_t,L=_t,A=_t,It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=L.x,It.array[Ot+3]=L.y,It.array[Ot+4]=A.x,It.array[Ot+5]=A.y,Ot+=6;for(d=0,v=Yt.length;d<v;d++)_t=It.value[Yt[d]],k=_t,L=_t,A=_t,O=_t,It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=L.x,It.array[Ot+3]=L.y,It.array[Ot+4]=A.x,It.array[Ot+5]=A.y,It.array[Ot+6]=O.x,It.array[Ot+7]=O.y,Ot+=8}}else if(It.size===3){var an;It.type==="c"?an=["r","g","b"]:an=["x","y","z"];if(It.boundTo===t||It.boundTo==="vertices"){for(d=0,v=Gt.length;d<v;d++)g=Zt[Gt[d]],k=It.value[g.a],L=It.value[g.b],A=It.value[g.c],It.array[Ot]=k[an[0]],It.array[Ot+1]=k[an[1]],It.array[Ot+2]=k[an[2]],It.array[Ot+3]=L[an[0]],It.array[Ot+4]=L[an[1]],It.array[Ot+5]=L[an[2]],It.array[Ot+6]=A[an[0]],It.array[Ot+7]=A[an[1]],It.array[Ot+8]=A[an[2]],Ot+=9;for(d=0,v=Yt.length;d<v;d++)g=Zt[Yt[d]],k=It.value[g.a],L=It.value[g.b],A=It.value[g.c],O=It.value[g.d],It.array[Ot]=k[an[0]],It.array[Ot+1]=k[an[1]],It.array[Ot+2]=k[an[2]],It.array[Ot+3]=L[an[0]],It.array[Ot+4]=L[an[1]],It.array[Ot+5]=L[an[2]],It.array[Ot+6]=A[an[0]],It.array[Ot+7]=A[an[1]],It.array[Ot+8]=A[an[2]],It.array[Ot+9]=O[an[0]],It.array[Ot+10]=O[an[1]],It.array[Ot+11]=O[an[2]],Ot+=12}else if(It.boundTo==="faces"){for(d=0,v=Gt.length;d<v;d++)_t=It.value[Gt[d]],k=_t,L=_t,A=_t,It.array[Ot]=k[an[0]],It.array[Ot+1]=k[an[1]],It.array[Ot+2]=k[an[2]],It.array[Ot+3]=L[an[0]],It.array[Ot+4]=L[an[1]],It.array[Ot+5]=L[an[2]],It.array[Ot+6]=A[an[0]],It.array[Ot+7]=A[an[1]],It.array[Ot+8]=A[an[2]],Ot+=9;for(d=0,v=Yt.length;d<v;d++)_t=It.value[Yt[d]],k=_t,L=_t,A=_t,O=_t,It.array[Ot]=k[an[0]],It.array[Ot+1]=k[an[1]],It.array[Ot+2]=k[an[2]],It.array[Ot+3]=L[an[0]],It.array[Ot+4]=L[an[1]],It.array[Ot+5]=L[an[2]],It.array[Ot+6]=A[an[0]],It.array[Ot+7]=A[an[1]],It.array[Ot+8]=A[an[2]],It.array[Ot+9]=O[an[0]],It.array[Ot+10]=O[an[1]],It.array[Ot+11]=O[an[2]],Ot+=12}else if(It.boundTo==="faceVertices"){for(d=0,v=Gt.length;d<v;d++)_t=It.value[Gt[d]],k=_t[0],L=_t[1],A=_t[2],It.array[Ot]=k[an[0]],It.array[Ot+1]=k[an[1]],It.array[Ot+2]=k[an[2]],It.array[Ot+3]=L[an[0]],It.array[Ot+4]=L[an[1]],It.array[Ot+5]=L[an[2]],It.array[Ot+6]=A[an[0]],It.array[Ot+7]=A[an[1]],It.array[Ot+8]=A[an[2]],Ot+=9;for(d=0,v=Yt.length;d<v;d++)_t=It.value[Yt[d]],k=_t[0],L=_t[1],A=_t[2],O=_t[3],It.array[Ot]=k[an[0]],It.array[Ot+1]=k[an[1]],It.array[Ot+2]=k[an[2]],It.array[Ot+3]=L[an[0]],It.array[Ot+4]=L[an[1]],It.array[Ot+5]=L[an[2]],It.array[Ot+6]=A[an[0]],It.array[Ot+7]=A[an[1]],It.array[Ot+8]=A[an[2]],It.array[Ot+9]=O[an[0]],It.array[Ot+10]=O[an[1]],It.array[Ot+11]=O[an[2]],Ot+=12}}else if(It.size===4)if(It.boundTo===t||It.boundTo==="vertices"){for(d=0,v=Gt.length;d<v;d++)g=Zt[Gt[d]],k=It.value[g.a],L=It.value[g.b],A=It.value[g.c],It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=k.z,It.array[Ot+3]=k.w,It.array[Ot+4]=L.x,It.array[Ot+5]=L.y,It.array[Ot+6]=L.z,It.array[Ot+7]=L.w,It.array[Ot+8]=A.x,It.array[Ot+9]=A.y,It.array[Ot+10]=A.z,It.array[Ot+11]=A.w,Ot+=12;for(d=0,v=Yt.length;d<v;d++)g=Zt[Yt[d]],k=It.value[g.a],L=It.value[g.b],A=It.value[g.c],O=It.value[g.d],It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=k.z,It.array[Ot+3]=k.w,It.array[Ot+4]=L.x,It.array[Ot+5]=L.y,It.array[Ot+6]=L.z,It.array[Ot+7]=L.w,It.array[Ot+8]=A.x,It.array[Ot+9]=A.y,It.array[Ot+10]=A.z,It.array[Ot+11]=A.w,It.array[Ot+12]=O.x,It.array[Ot+13]=O.y,It.array[Ot+14]=O.z,It.array[Ot+15]=O.w,Ot+=16}else if(It.boundTo==="faces"){for(d=0,v=Gt.length;d<v;d++)_t=It.value[Gt[d]],k=_t,L=_t,A=_t,It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=k.z,It.array[Ot+3]=k.w,It.array[Ot+4]=L.x,It.array[Ot+5]=L.y,It.array[Ot+6]=L.z,It.array[Ot+7]=L.w,It.array[Ot+8]=A.x,It.array[Ot+9]=A.y,It.array[Ot+10]=A.z,It.array[Ot+11]=A.w,Ot+=12;for(d=0,v=Yt.length;d<v;d++)_t=It.value[Yt[d]],k=_t,L=_t,A=_t,O=_t,It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=k.z,It.array[Ot+3]=k.w,It.array[Ot+4]=L.x,It.array[Ot+5]=L.y,It.array[Ot+6]=L.z,It.array[Ot+7]=L.w,It.array[Ot+8]=A.x,It.array[Ot+9]=A.y,It.array[Ot+10]=A.z,It.array[Ot+11]=A.w,It.array[Ot+12]=O.x,It.array[Ot+13]=O.y,It.array[Ot+14]=O.z,It.array[Ot+15]=O.w,Ot+=16}else if(It.boundTo==="faceVertices"){for(d=0,v=Gt.length;d<v;d++)_t=It.value[Gt[d]],k=_t[0],L=_t[1],A=_t[2],It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=k.z,It.array[Ot+3]=k.w,It.array[Ot+4]=L.x,It.array[Ot+5]=L.y,It.array[Ot+6]=L.z,It.array[Ot+7]=L.w,It.array[Ot+8]=A.x,It.array[Ot+9]=A.y,It.array[Ot+10]=A.z,It.array[Ot+11]=A.w,Ot+=12;for(d=0,v=Yt.length;d<v;d++)_t=It.value[Yt[d]],k=_t[0],L=_t[1],A=_t[2],O=_t[3],It.array[Ot]=k.x,It.array[Ot+1]=k.y,It.array[Ot+2]=k.z,It.array[Ot+3]=k.w,It.array[Ot+4]=L.x,It.array[Ot+5]=L.y,It.array[Ot+6]=L.z,It.array[Ot+7]=L.w,It.array[Ot+8]=A.x,It.array[Ot+9]=A.y,It.array[Ot+10]=A.z,It.array[Ot+11]=A.w,It.array[Ot+12]=O.x,It.array[Ot+13]=O.y,It.array[Ot+14]=O.z,It.array[Ot+15]=O.w,Ot+=16}u.bindBuffer(u.ARRAY_BUFFER,It.buffer),u.bufferData(u.ARRAY_BUFFER,It.array,i)}s&&w.deleteGroupBufferData(e)},w.buildLineBufferData=function(e,n,r,i){var s,o,u,a,f,l,c=e,h=c.vertices,p=c.colors,d=c.lineDistances,v=h.length,m=p.length,g=d.length,y=i.__vertexArray,b=i.__colorArray,w=i.__lineDistanceArray,E=c.verticesNeedUpdate,S=c.colorsNeedUpdate,x=c.lineDistancesNeedUpdate,T=c.__webglCustomAttributesList,N,C,k,L,A,O,M;if(E){for(s=0;s<v;s++)a=h[s],f=s*3,y[f]=a.x,y[f+1]=a.y,y[f+2]=a.z;r.bindBuffer(r.ARRAY_BUFFER,i.__webglVertexBuffer),r.bufferData(r.ARRAY_BUFFER,y,n)}if(S){for(o=0;o<m;o++)l=p[o],f=o*3,b[f]=l.r,b[f+1]=l.g,b[f+2]=l.b;r.bindBuffer(r.ARRAY_BUFFER,i.__webglColorBuffer),r.bufferData(r.ARRAY_BUFFER,b,n)}if(x){for(u=0;u<g;u++)w[u]=d[u];r.bindBuffer(r.ARRAY_BUFFER,i.__webglLineDistanceBuffer),r.bufferData(r.ARRAY_BUFFER,w,n)}if(T)for(N=0,C=T.length;N<C;N++){M=T[N];if(M.needsUpdate&&(M.boundTo===t||M.boundTo==="vertices")){f=0,A=M.value.length;if(M.size===1)for(L=0;L<A;L++)M.array[L]=M.value[L];else if(M.size===2)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,f+=2;else if(M.size===3)if(M.type==="c")for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.r,M.array[f+1]=O.g,M.array[f+2]=O.b,f+=3;else for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,f+=3;else if(M.size===4)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,M.array[f+3]=O.w,f+=4;r.bindBuffer(r.ARRAY_BUFFER,M.buffer),r.bufferData(r.ARRAY_BUFFER,M.array,n)}}},w.buildLineBufferData=function(e,n,r,i){var s,o,u,a,f,l,c=e,h=c.vertices,p=c.colors,d=c.lineDistances,v=h.length,m=p.length,g=d.length,y=i.__vertexArray,b=i.__colorArray,w=i.__lineDistanceArray,E=c.verticesNeedUpdate,S=c.colorsNeedUpdate,x=c.lineDistancesNeedUpdate,T=c.__webglCustomAttributesList,N,C,k,L,A,O,M;if(E){for(s=0;s<v;s++)a=h[s],f=s*3,y[f]=a.x,y[f+1]=a.y,y[f+2]=a.z;r.bindBuffer(r.ARRAY_BUFFER,i.__webglVertexBuffer),r.bufferData(r.ARRAY_BUFFER,y,n)}if(S){for(o=0;o<m;o++)l=p[o],f=o*3,b[f]=l.r,b[f+1]=l.g,b[f+2]=l.b;r.bindBuffer(r.ARRAY_BUFFER,i.__webglColorBuffer),r.bufferData(r.ARRAY_BUFFER,b,n)}if(x){for(u=0;u<g;u++)w[u]=d[u];r.bindBuffer(r.ARRAY_BUFFER,i.__webglLineDistanceBuffer),r.bufferData(r.ARRAY_BUFFER,w,n)}if(T)for(N=0,C=T.length;N<C;N++){M=T[N];if(M.needsUpdate&&(M.boundTo===t||M.boundTo==="vertices")){f=0,A=M.value.length;if(M.size===1)for(L=0;L<A;L++)M.array[L]=M.value[L];else if(M.size===2)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,f+=2;else if(M.size===3)if(M.type==="c")for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.r,M.array[f+1]=O.g,M.array[f+2]=O.b,f+=3;else for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,f+=3;else if(M.size===4)for(L=0;L<A;L++)O=M.value[L],M.array[f]=O.x,M.array[f+1]=O.y,M.array[f+2]=O.z,M.array[f+3]=O.w,f+=4;r.bindBuffer(r.ARRAY_BUFFER,M.buffer),r.bufferData(r.ARRAY_BUFFER,M.array,n)}}},w.deleteGroupBufferData=function(e){delete e.__inittedArrays,delete e.__colorArray,delete e.__normalArray,delete e.__tangentArray,delete e.__uvArray,delete e.__uv2Array,delete e.__faceArray,delete e.__vertexArray,delete e.__lineArray,delete e.__skinIndexArray,delete e.__skinWeightArray},w.getMaterial=function(e,t){var r=e.material;return r instanceof n.ArrayMaterial?(t>r.materials.length-1&&(t=r.materials.length-1),r.materials[t]):r},n.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase(),n=this;n.faces[t]=n.faces[t]||{},n.faces[t][e.cssFontWeight]=n.faces[t][e.cssFontWeight]||{},n.faces[t][e.cssFontWeight][e.cssFontStyle]=e;var r=n.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(e){var t=[],r=[],i,s,o=this.getFace(),u=this.size/o.resolution,a=0,f=String(e).split(""),l=f.length,c=[];for(i=0;i<l;i++){var h=new n.Path,p=this.extractGlyphPoints(f[i],o,u,a,h);a+=p.offset,c.push(p.path)}var d=a/2,v,m,g;for(i=0;i<l;i++){var h=c[i];for(g=0;g<h.actions.length;g++){var v=h.actions[g].args;for(m=0;m<v.length;m++)m%3===0&&(v[m]-=d)}}return{paths:c,offset:d}},extractGlyphPoints:function(e,t,r,i,s,o){var u=[],a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k=t.glyphs[e]||t.glyphs["?"],L=0;if(!k)return;if(k.o){c=k._cachedOutline||(k._cachedOutline=k.o.split(" ")),p=c.length,d=r,v=r;for(a=0;a<p;){h=c[a++];switch(h){case"m":m=c[a++]*d+i,g=c[a++]*v-L,s.moveTo(m,g,0);break;case"l":m=c[a++]*d+i,g=c[a++]*v-L,s.lineTo(m,g,0);break;case"q":y=c[a++]*d+i,b=c[a++]*v-L,S=c[a++]*d+i,x=c[a++]*v-L,s.quadraticCurveTo(S,x,0,y,b,0),C=u[u.length-1];if(C){w=C.x,E=C.y;for(f=1,l=this.divisions;f<=l;f++)var A=f/l,O=n.Shape.Utils.b2(A,w,S,y),M=n.Shape.Utils.b2(A,E,x,b)}break;case"b":y=c[a++]*d+i,b=c[a++]*v-L,S=c[a++]*d+i,x=c[a++]*-v-L,T=c[a++]*d+i,N=c[a++]*-v-L,s.bezierCurveTo(y,b,0,S,x,0,T,N,0),C=u[u.length-1];if(C){w=C.x,E=C.y;for(f=1,l=this.divisions;f<=l;f++)var A=f/l,O=n.Shape.Utils.b3(A,w,S,T,y),M=n.Shape.Utils.b3(A,E,x,N,b)}}}}return{offset:k.ha*r,path:s}}},n.FontUtils.generateShapes=function(e,r){r=r||{};var i=r.size!==t?r.size:100,s=r.curveSegments!==t?r.curveSegments:4,o=r.font!==t?r.font:"helvetiker",u=r.weight!==t?r.weight:"normal",a=r.style!==t?r.style:"normal";n.FontUtils.size=i,n.FontUtils.divisions=s,n.FontUtils.face=o,n.FontUtils.weight=u,n.FontUtils.style=a;var f=n.FontUtils.drawText(e),l=f.paths,c=[];for(var h=0,p=l.length;h<p;h++)Array.prototype.push.apply(c,l[h].toShapes());return c},function(e){var t=1e-10,n=function(e,t){var n=e.length;if(n<3)return null;var s=[],o=[],u=[],a,f,l;if(r(e)>0)for(f=0;f<n;f++)o[f]=f;else for(f=0;f<n;f++)o[f]=n-1-f;var c=n,h=2*c;for(f=c-1;c>2;){if(h--<=0)return console.log("Warning, unable to triangulate polygon!"),t?u:s;a=f,c<=a&&(a=0),f=a+1,c<=f&&(f=0),l=f+1,c<=l&&(l=0);if(i(e,a,f,l,c,o)){var p,d,v,m,g;p=o[a],d=o[f],v=o[l],s.push([e[p],e[d],e[v]]),u.push([o[a],o[f],o[l]]);for(m=f,g=f+1;g<c;m++,g++)o[m]=o[g];c--,h=2*c}}return t?u:s},r=function(e){var t=e.length,n=0;for(var r=t-1,i=0;i<t;r=i++)n+=e[r].x*e[i].y-e[i].x*e[r].y;return n*.5},i=function(e,n,r,i,s,o){var u,a,f,l,c,h,p,d,v;a=e[o[n]].x,f=e[o[n]].y,l=e[o[r]].x,c=e[o[r]].y,h=e[o[i]].x,p=e[o[i]].y;if(t>(l-a)*(p-f)-(c-f)*(h-a))return!1;var m,g,y,b,w,E,S,x,T,N,C,k,L,A,O;m=h-l,g=p-c,y=a-h,b=f-p,w=l-a,E=c-f;for(u=0;u<s;u++){if(u===n||u===r||u===i)continue;d=e[o[u]].x,v=e[o[u]].y,S=d-a,x=v-f,T=d-l,N=v-c,C=d-h,k=v-p,O=m*N-g*T,L=w*x-E*S,A=y*k-b*C;if(O>=-t&&A>=-t&&L>=-t)return!1}return!0};return e.Triangulate=n,e.Triangulate.area=r,e}(n.FontUtils),self._typeface_js={faces:n.FontUtils.faces,loadFace:n.FontUtils.loadFace},n.typeface_js=self._typeface_js;var T={easeNone:function(e,t,n,r){return n*e/r+t},easeIn:function(e,t,n,r){return n*(e/=r)*e+t},easeOut:function(e,t,n,r){return-n*(e/=r)*(e-2)+t},easeBoth:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e+t:-n/2*(--e*(e-2)-1)+t},easeInStrong:function(e,t,n,r){return n*(e/=r)*e*e*e+t},easeOutStrong:function(e,t,n,r){return-n*((e=e/r-1)*e*e*e-1)+t},easeBothStrong:function(e,t,n,r){return(e/=r/2)<1?n/2*e*e*e*e+t:-n/2*((e-=2)*e*e*e-2)+t},elasticIn:function(e,t,n,r,i,s){var o;return e===0?t:(e/=r)===1?t+n:(s||(s=r*.3),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),-(i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s))+t)},elasticOut:function(e,t,n,r,i,s){var o;return e===0?t:(e/=r)===1?t+n:(s||(s=r*.3),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),i*Math.pow(2,-10*e)*Math.sin((e*r-o)*2*Math.PI/s)+n+t)},elasticBoth:function(e,t,n,r,i,s){var o;return e===0?t:(e/=r/2)===2?t+n:(s||(s=r*.3*1.5),!i||i<Math.abs(n)?(i=n,o=s/4):o=s/(2*Math.PI)*Math.asin(n/i),e<1?-0.5*i*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*2*Math.PI/s)*.5+n+t)},backIn:function(e,n,r,i,s){return s===t&&(s=1.70158),e===i&&(e-=.001),r*(e/=i)*e*((s+1)*e-s)+n},backOut:function(e,t,n,r,i){return typeof i=="undefined"&&(i=1.70158),n*((e=e/r-1)*e*((i+1)*e+i)+1)+t},backBoth:function(e,t,n,r,i){return typeof i=="undefined"&&(i=5.70158),(e/=r/2)<1?n/2*e*e*(((i*=1.525)+1)*e-i)+t:n/2*((e-=2)*e*(((i*=1.525)+1)*e+i)+2)+t},bounceIn:function(e,t,n,r){return n-T.bounceOut(r-e,0,n,r)+t},bounceOut:function(e,t,n,r){return(e/=r)<1/2.75?n*7.5625*e*e+t:e<2/2.75?n*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?n*(7.5625*(e-=2.25/2.75)*e+.9375)+t:n*(7.5625*(e-=2.625/2.75)*e+.984375)+t},bounceBoth:function(e,t,n,r){return e<r/2?T.bounceIn(e*2,0,n,r)*.5+t:T.bounceOut(e*2-r,0,n,r)*.5+n*.5+t}},N=function(){this._as=[];if(arguments.length===1){var e=arguments[0];e instanceof N&&(e=e._as);if(e instanceof Array){var t=e.length;for(var n=0;n<t;n++)this._as.push(e[n])}else e!=null&&this._as.push(e)}else if(arguments.length>1){t=arguments.length;for(n=0;n<t;n++)this._as.push(arguments[n])}};n.List=N,n.extend(n.List,Object,{size:function(){return this._as.length},isEmpty:function(){return this._as.length===0},add:function(e,n){return n===t?this._as.push(e):this._as.splice(n,0,e)},addAll:function(e){e instanceof N&&(e=e._as);if(e instanceof Array){var t=e.length;for(var n=0;n<t;n++)this._as.push(e[n])}else this._as.push(e)},get:function(e){return this._as[e]},remove:function(e){var t=this._as.indexOf(e);return t>=0&&t<this._as.length&&this.removeAt(t),t},removeAt:function(e){return this._as.splice(e,1)[0]},set:function(e,t){return this._as[e]=t},clear:function(){return this._as.splice(0,this._as.length)},contains:function(e){return this.indexOf(e)>=0},indexOf:function(e){return this._as.indexOf(e)},forEach:function(e,t){var n=this._as.length;for(var r=0;r<n;r++){var i=this._as[r];t?e.call(t,i):e(i)}},forEachReverse:function(e,t){var n=this._as.length;for(var r=n-1;r>=0;r--){var i=this._as[r];t?e.call(t,i):e(i)}},toArray:function(e,t){if(e){var n=[],r=this._as.length;for(var i=0;i<r;i++){var s=this._as[i];t?e.call(t,s)&&n.push(s):e(s)&&n.push(s)}return n}return this._as.concat()},toList:function(e,t){if(e){var n=new N,r=this._as.length;for(var i=0;i<r;i++){var s=this._as[i];t?e.call(t,s)&&n.add(s):e(s)&&n.add(s)}return n}return new N(this)},sort:function(e){return e?this._as.sort(e):this._as.sort(),this},toString:function(){return this._as.toString()}}),n.ImageCache=function(){};var C=n.ImageCache;C.AlarmBillboardImage=new Image,C.AlarmBillboardImage.src="data:image/png;base64,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",C.Logo=new Image,C.Logo.src="data:image/png;base64,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"
,n.ImageUtils={},n.ImageUtils.registerDefaultImage=function(e){e.src!=null?C.Logo.src=e.src:C.Logo.src=e},n.ImageUtils.registerAlarmImage=function(e){e.src!=null?C.AlarmBillboardImage.src=e.src:C.AlarmBillboardImage.src=e},C.ssaoNormalImage=new Image,C.ssaoNormalImage.src="data:image/png;base64,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",C.ssaoNormalImage.loaded=!0,n.EventDispatcher=function(){this.listeners={}},n.extend(n.EventDispatcher,null,{constructor:n.EventDispatcher,addEventListener:function(e,n){this.listeners[e]===t&&(this.listeners[e]=[]),this.listeners[e].indexOf(n)===-1&&this.listeners[e].push(n)},removeEventListener:function(e,t){var n=this.listeners[e].indexOf(t);n!==-1&&this.listeners[e].splice(n,1)},dispatchEvent:function(e){var n=this.listenters[e.type];if(n!=t){e.target=this;for(var r=0;r<n.length;r++){var i=n[r];i.call(this,e)}}},contains:function(e,t){if(this._ls)for(var n=0,r=this._ls.size(),i;n<r;n++){i=this._ls.get(n);if(e===i.l&&t===i.s)return!0}return!1},add:function(e,t,n){if(e==null){console.error("TGL.EventDispatcher#add:listener is null");return}var r={l:e,s:t,a:n};this._ls||(this._ls=new N),this._f?(this._addPendings||(this._addPendings=new N),this._addPendings.add(r)):r.a?this._ls.add(r,0):this._ls.add(r)},remove:function(e,t){this._ls&&(this._f?(this._removePendings||(this._removePendings=new N),this._removePendings.add({l:e,s:t})):this._remove(e,t))},_remove:function(e,t){for(var n=0,r=this._ls.size(),i;n<r;n++){i=this._ls.get(n);if(i.l===e&&i.s===t){this._ls.removeAt(n);return}}},fire:function(e){if(this._ls){var t,n=this._ls.size(),r;this._f=!0;for(t=0;t<n;t++)r=this._ls.get(t),r.s?r.l.call(r.s,e):r.l(e);this._f=!1;if(this._removePendings){n=this._removePendings.size();for(t=0;t<n;t++)r=this._removePendings.get(t),this._remove(r.l,r.s);delete this._removePendings}if(this._addPendings){n=this._addPendings.size();for(t=0;t<n;t++)r=this._addPendings.get(t),r.a?this._ls.add(r,0):this._ls.add(r);delete this._addPendings}}}}),n.PropertyChangeDispatcher=function(){this._dispatcher=new n.EventDispatcher},n.extend(n.PropertyChangeDispatcher,Object,{addPropertyChangeListener:function(e,t,n){this._dispatcher.add(e,t,n)},removePropertyChangeListener:function(e,t){this._dispatcher.remove(e,t)},firePropertyChange:function(e,t,n){if(t==n)return!1;var r={property:e,oldValue:t,newValue:n,source:this};return this._dispatcher.fire(r),this.onPropertyChanged(r),!0},onPropertyChanged:function(e){}}),n.Texture=function(e,r,i,s,o,u,a,f,l){n.PropertyChangeDispatcher.call(this),this.id=n.TextureIdCount++,this.name="",e!=null&&this.setImage(e),this.mipmaps=[],this.mapping=r!==t?r:new n.UVMapping,this.wrapS=i!==t?i:n.RepeatWrapping,this.wrapT=s!==t?s:n.RepeatWrapping,this.magFilter=o!==t?o:n.LinearFilter,this.minFilter=u!==t?u:n.LinearMipMapLinearFilter,this.anisotropy=l!==t?l:1,this.format=a!==t?a:n.RGBAFormat,this.type=f!==t?f:n.UnsignedByteType,this.repeatX=1,this.repeatY=1,this.offsetX=0,this.offsetY=0,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!1,this.flipX=!1,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null},n.extend(n.Texture,n.PropertyChangeDispatcher,{getUniqueCode:function(){if(h.isImage(this._image)||typeof this._image=="string"||P.isArray(this._image))return this._imageSrc+" "+this.format+" "+this.type+" "+" "+this.wrapS+" "+this.wrapT+" "+this.magFilter+" "+this.minFilter+" "+this.flipY+" "+this.flipX+this.anisotropy;if(h.isCanvas(this._image)){var e=this._image;return e.__uniqueCode||(e.__uniqueCode=n.id("texture")),e.__uniqueCode+" "+this.format+" "+this.type+" "+this.wrapS+" "+this.wrapT+" "+this.magFilter+" "+this.minFilter+" "+this.flipY+" "+this.flipX+this.anisotropy}},resetValue:function(){this.name="",this._image=null,this.mipmaps=[],this.mapping=new n.UVMapping,this.wrapS=n.RepeatWrapping,this.wrapT=n.RepeatWrapping,this.magFilter=n.LinearFilter,this.minFilter=n.LinearMipMapLinearFilter,this.anisotropy=1,this.format=n.RGBAFormat,this.type=n.UnsignedByteType,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!1,this.flipX=!1,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null},clone:function(e,r){return e===t&&(e=new n.Texture),r==null||r?e.setImage(this._image):e._image=this._image,e._imageSrc=this._imageSrc,e.mipmaps=this.mipmaps.slice(0),e.mapping=this.mapping,e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.format=this.format,e.type=this.type,e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e.flipX=this.flipX,e.unpackAlignment=this.unpackAlignment,e},onloadTexture:function(){},setImageSrc:function(e){if(typeof e=="string")this._imageSrc=e;else if(P.isArray(e)){var t="";for(var n=0;n<e.length;n++)typeof e[n]=="string"?t+=e:t+=e[n].src;this._imageSrc=t}else this._imageSrc=e.src},loadAllImages:function(e,t){function s(s){s.onload=function(){s.loaded=!0,s.onload=null,r++,r==n&&(i.onloadTexture(),i.firePropertyChange("image",t,i._image),e.loaded=!0)}}var n=e.length,r=0,i=this;for(var o=0;o<n;o++)s(e[o])},setImage:function(e){var t=this._image;if(P.isArray(e)){var n="",r=[],i;for(var s=0;s<e.length;s++)typeof e[s]=="string"?(n+=e,i=new Image,e[s].startsWith("data:image")||(i.crossOrigin="use-credentials"),i.src=e[s],r.push(i)):(n+=e[s].src,r.push(e[s]));this._imageSrc=n,this.loadAllImages(r,t),this._image=r}else if(typeof e=="string"){if(this._image&&this._image.src===e)return;this._imageSrc=e;var o=new Image;e.startsWith("data:image")||(o.crossOrigin="use-credentials"),o.src=e;var u=this;u._image=o,o.onload=function(e){o.loaded=!0,o.onload=null,u.onloadTexture(),u.firePropertyChange("image",t,o)}}else{if(this._image===e)return;this._imageSrc=e.src;var t=this._image;h.isCanvas(e)&&(e.loaded=!0);if(e&&!e.loaded){var u=this;u._image=e;var a=e.onload;e.onload=function(n){a&&a.call(null,n),e.loaded=!0,e.onload=null,u.onloadTexture(),u.firePropertyChange("image",t,e)}}else this._image=e,this.firePropertyChange("image",t,e)}},getImage:function(){return this._image},dispose:function(){this.firePropertyChange("disposed",!1,!0)}}),n.TextureIdCount=0,n.PixelsTexture=function(e,t,r,i,s,o,u,a,f,l,c){n.Texture.call(this,null,o,u,a,f,l,i,s,c),this.image={data:e,width:t,height:r}},n.PixelsTexture.prototype=Object.create(n.Texture.prototype),n.PixelsTexture.prototype.clone=function(){var e=new n.PixelsTexture;return n.Texture.prototype.clone.call(this,e),e},n.CompressedTexture=function(e,t,r,i,s,o,u,a,f,l,c){n.Texture.call(this,null,o,u,a,f,l,i,s,c),this.image={width:t,height:r},this.mipmaps=e,this.generateMipmaps=!1},n.CompressedTexture.prototype=Object.create(n.Texture.prototype),n.CompressedTexture.prototype.clone=function(){var e=new n.CompressedTexture;return n.Texture.prototype.clone.call(this,e),e};var k={pools:{},useTimes:{},size:0,setTexture:function(e,t){k.size++,k.pools[e]=t},getTexture:function(e){return k.pools[e]},useTexture:function(e){if(e){var t=e.id,n=k.useTimes[t]||0;n++,k.useTimes[t]=n}},unUseTexture:function(e){if(e){var t=e.id,n=k.useTimes[t]||0;n--,k.useTimes[t]=n;if(n<=0){var r=e.getUniqueCode();delete k.pools[r],k.size--,e.dispose()}}}};n.TexturePool=k,n.TexturePool.TestTexture=new n.Texture,n.SerializationSettings=function(){var e=n.SerializationSettings;this.isServaSerializable=e.isServaSerializable,this.isStyleSerializable=e.isStyleSerializable,this.isClientSerializable=e.isClientSerializable,this.encodeURI=e.encodeURI,this._pm=n.clone(e._pm),this._sm=n.clone(e._sm),this._cm=n.clone(e._cm)},function(){var e=n.SerializationSettings;e.isServaSerializable=!0,e.isStyleSerializable=!0,e.isClientSerializable=!0,e.encodeURI=!0,e._pm={},e._sm={},e._cm={},e.setPropertyType=function(t,n){e._pm[t]=n},e.getPropertyType=function(t){return e._pm[t]},e.setStyleType=function(t,n){e._sm[t]=n},e.getStyleType=function(t){return e._sm[t]},e.setClientType=function(t,n){e._cm[t]=n},e.getClientType=function(t){return e._cm[t]}}(),n.extend(n.SerializationSettings,Object,{setPropertyType:function(e,t){this._pm[e]=t},getPropertyType:function(e){return this._pm[e]},setStyleType:function(e,t){this._sm[e]=t},getStyleType:function(e){return this._sm[e]},setClientType:function(e,t){this._cm[e]=t},getClientType:function(e){return this._cm[e]}}),n.Styles={_m:{},setStyle:function(e,t){return t==null?delete n.Styles._m[e]:n.Styles._m[e]=t,n.Styles},getStyle:function(e){return n.Styles._m[e]}},n.Styles.MaterailType="S:m.type",n.Styles.NormalType="S:m.normalType",n.Styles.PREFIX_STYLE="S:",function(){var e=function(e,t){n.SerializationSettings.setPropertyType(e,t)};e("combos","data.list"),e("name","cdata"),e("toolTip","cdata"),e("parent","data"),e("fromNode","data"),e("toNode","data"),e("alarmState","alarmstate"),e("vertices","list.vec3"),e("faces","serializeabe.list"),e("uvs","list.vec2"),e("position","vec3"),e("rotation","vec3"),e("scale","vec3"),e("location","point"),e("materialSize","number"),e("color","color"),e("ambient","color"),e("diffuse","color"),e("specular","color"),e("intensity","number"),e("distance","number"),e("type","number"),e("startClosed","boolean"),e("endClosed","boolean"),e("curveSegments","number"),e("amount","number"),e("vertical","boolean"),e("repeat","number"),e("centralized","boolean"),e("visible","boolean"),e=function(e,t,r){r==null&&(t!=null?t instanceof n.XiangliangTwo?r="vec2":t instanceof n.XiangliangThree?r="vec3":r=typeof t:r="string"),n.Styles.setStyle(e,t),n.SerializationSettings.setStyleType(e,r)},e("select.style","border"),e("select.width",1),e("select.color",65280),e("select.offset",0),e("outer.width",1),e("outer.offset",0),e("outer.color",null,"color"),e("m.type","basic"),e("m.color",16777215,"color"),e("m.side","front"),e("m.alphaTest",0),e("m.polygonOffset",!1),e("m.polygonOffsetFactor",0),e("m.polygonOffsetUnits",0),e("m.wireframe",!1),e("m.wireframeLinewidth",1),e("m.gradient",{}),e("m.gradientType",1),e("m.transparent",!1),e("m.opacity",1),e("m.visible",!0),e("m.depthTest",!0),e("m.depthMask",!0),e("m.alignment",new n.XiangliangTwo(0,0)),e("m.linewidth",1),e("m.texture.image",null),e("m.texture.offset",new n.XiangliangTwo(0,0)),e("m.texture.repeat",new n.XiangliangTwo(1,1)),e("m.texture.wrapS",n.RepeatWrapping),e("m.texture.wrapT",n.RepeatWrapping),e("m.texture.flipX",!1),e("m.texture.flipY",!1),e("m.normalmap.image",null),e("m.envmap.image",null),e("m.specularmap.image",null),e("right.m.type","basic"),e("left.m.type","basic"),e("top.m.type","basic"),e("bottom.m.type","basic"),e("front.m.type","basic"),e("back.m.type","basic"),e("side.m.type","basic"),e("alarm.billboard.scale",null),e("alarm.billboard.position","top"),e("alarm.billboard.vertical",!1),e("annotation.class","tgl_annotation")}(),n.extend(n.Styles,Object,{});var L=function(e,n){this.min=e!==t?e:new s(Infinity,Infinity),this.max=n!==t?n:new s(-Infinity,-Infinity)};n.Box2=L,L.prototype={constructor:n.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var n=1,r=e.length;n<r;n++)t=e[n],t.x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var e=new s;return function(t,n){var r=e.copy(n).multiplyScalar(.5);return this.min.copy(t).sub(r),this.max.copy(t).add(r),this}}(),copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=Infinity,this.max.x=this.max.y=-Infinity,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},center:function(e){var t=e||new s;return t.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(e){var t=e||new s;return t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y?!0:!1},getParameter:function(e,t){var n=t||new s;return n.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y?!1:!0},clampPoint:function(e,t){var n=t||new s;return n.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new s;return function(t){var n=e.copy(t).clamp(this.min,this.max);return n.sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new L).copy(this)}},n.BizBox=function(e,n){this.min=e!==t?e:new o(Infinity,Infinity,Infinity),this.max=n!==t?n:new o(-Infinity,-Infinity,-Infinity)},n.BizBox.prototype={constructor:n.BizBox,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){if(e.length>0){var t=e[0];this.min.copy(t),this.max.copy(t);for(var n=1,r=e.length;n<r;n++)t=e[n],t.x<this.min.x?this.min.x=t.x:t.x>this.max.x&&(this.max.x=t.x),t.y<this.min.y?this.min.y=t.y:t.y>this.max.y&&(this.max.y=t.y),t.z<this.min.z?this.min.z=t.z:t.z>this.max.z&&(this.max.z=t.z)}else this.makeEmpty();return this},setFromCenterAndSize:function(e,t){var r=n.BizBox.__v1.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=Infinity,this.max.x=this.max.y=this.max.z=-Infinity,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(e){var t=e||new o;return t.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(e){var t=e||new o;return t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z?!0:!1},getParameter:function(e){return new o((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z?!1:!0},clampPoint:function(e,t){var n=t||new o;return(new o).copy(e).clamp(this.min,this.max)},distanceToPoint:function(e){var t=n.BizBox.__v1.copy(e).clamp(this.min,this.max);return t.sub(e).length()},getBoundingSphere:function(e){var t=e||new n.Sphere;return t.center=this.center(),t.radius=this.size(n.BizBox.__v0).length()*.5,t},intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},transform:function(e){var t=[n.BizBox.__v0.set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),n.BizBox.__v0.set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),n.BizBox.__v1.set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),n.BizBox.__v2.set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),n.BizBox.__v3.set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),n.BizBox.__v4.set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),n.BizBox.__v5.set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),n.BizBox.__v6.set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),n.BizBox.__v7.set(this.max.x,this.max.y,this.max.z).applyMatrix4(e)];return this.makeEmpty(),this.setFromPoints(t),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)},clone:function(){return(new n.BizBox).copy(this)}},n.BizBox.__v0=new o,n.BizBox.__v1=new o,n.BizBox.__v2=new o,n.BizBox.__v3=new o,n.BizBox.__v4=new o,n.BizBox.__v5=new o,n.BizBox.__v6=new o,n.BizBox.__v7=new o,n.BoundingSphere=function(e,n){this.center=e!==t?e:new o,this.radius=n!==t?n:0},n.BoundingSphere.prototype={constructor:n.BoundingSphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromCenterAndPoints:function(e,t){var n=0;for(var r=0,i=t.length;r<i;r++){var s=e.distanceToSquared(t[r]);n=Math.max(n,s)}return this.center=e,this.radius=Math.sqrt(n),this},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsBoundingSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},clampPoint:function(e,t){var n=this.center.distanceToSquared(e),r=t||new o;return r.copy(e),n>this.radius*this.radius&&(r.sub(this.center).normalize(),r.multiplyScalar(this.radius).add(this.center)),r},getBizBox:function(e){var t=e||new n.Box3;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},transform:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius},clone:function(){return(new n.BoundingSphere).copy(this)}},n.Primitive=function(e,t){e=e||{},this.data=e,this.vertices=e.vertices,this.faces=e.faces,this.uvs=e.uvs,this.uv2s=e.uv2s,this.uniqueCode=t},n.extend(n.Primitive,Object,{clone:function(e){if(e){var t={},r;t.vertices=[];for(r=0;r<this.vertices.length;r++)t.vertices.push(this.vertices[r].clone());t.faces=[];for(r=0;r<this.faces.length;r++)t.faces.push(this.faces[r].clone());t.uvs=[];for(r=0;r<this.uvs.length;r++){var i=this.uvs[r],s=[];for(var o=0;o<i.length;o++)s.push(i[o].clone);t.uvs.push(s)}t.uv2s=[];for(r=0;r<this.uv2s.length;r++)t.uv2s.push(this.uv2s[r].clone());return new n.Primitive(t)}return new n.Primitvie(this.data)}}),n.PrimitiveCache={_cache:{},_useCount:{},getPrimitive:function(e){return e?n.PrimitiveCache._cache[e]:null},setPrimitive:function(e,t){e&&(n.PrimitiveCache._cache[e]=t)},usePrimitive:function(e){var t=n.PrimitiveCache._useCount[e]||0;t++,n.PrimitiveCache._useCount[e]=t},unUsePrimitive:function(e){var t=n.PrimitiveCache._useCount[e]||0;t--,t<=0&&delete n.PrimitiveCache._useCount[e]}},n.PrimitiveGroupCache={},n.Color=function(e){return e!==t&&this.set(e),this},n.extend(n.Color,Object,{r:1,g:1,b:1,getUniqueCode:function(){return""+this.r+this.g+this.b},set:function(e){switch(typeof e){case"number":this.setHex(e);break;case"string":this.setStyle(e)}},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,this},setRGB:function(e,t,n){return this.r=e,this.g=t,this.b=n,this},setHSV:function(e,t,n){var r,i,s,o,u;return n===0?this.r=this.g=this.b=0:(r=Math.floor(e*6),i=e*6-r,s=n*(1-t),o=n*(1-t*i),u=n*(1-t*(1-i)),r===0?(this.r=n,this.g=u,this.b=s):r===1?(this.r=o,this.g=n,this.b=s):r===2?(this.r=s,this.g=n,this.b=u):r===3?(this.r=s,this.g=o,this.b=n):r===4?(this.r=u,this.g=s,this.b=n):r===5&&(this.r=n,this.g=s,this.b=o)),this},setStyle:function(e){if(/^rgb\((\d+),(\d+),(\d+)\)$/i.test(e)){var t=/^rgb\((\d+),(\d+),(\d+)\)$/i.exec(e);return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,this}if(/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.test(e)){var t=/^rgb\((\d+)\%,(\d+)\%,(\d+)\%\)$/i.exec(e);return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,this}if(/^\#([0-9a-f]{6})$/i.test(e)){var t=/^\#([0-9a-f]{6})$/i.exec(e);return this.setHex(parseInt(t[1],16)),this}if(/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(e)){var t=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(e);return this.setHex(parseInt(t[1]+t[1]+t[2]+t[2]+t[3]+t[3],16)),this}if(/^(\w+)$/i.test(e))return this.setHex(n.ColorKeywords[e]),this},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e){return this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b,this},copyLinearToGamma:function(e){return this.r=Math.sqrt(e.r),this.g=Math.sqrt(e.g),this.b=Math.sqrt(e.b),this},convertGammaToLinear:function(){var e=this.r,t=this.g,n=this.b;return this.r=e*e,this.g=t*t,this.b=n*n,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return this.r*255<<16^this.g*255<<8^this.b*255<<0},getHexString:function(){return("000000"+this
.getHex().toString(16)).slice(-6)},getStyle:function(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"},getHSV:function(e){var n=this.r,r=this.g,i=this.b,s=Math.max(Math.max(n,r),i),o=Math.min(Math.min(n,r),i),u,a,f=s;if(o===s)u=0,a=0;else{var l=s-o;a=l/s,n===s?u=(r-i)/l:r===s?u=2+(i-n)/l:u=4+(n-r)/l,u/=6,u<0&&(u+=1),u>1&&(u-=1)}return e===t&&(e={h:0,s:0,v:0}),e.h=u,e.s=a,e.v=f,e},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},clone:function(){return(new n.Color).setRGB(this.r,this.g,this.b)}}),n.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},n.Data=function(e){n.PropertyChangeDispatcher.call(this),this._childList=new N,this._childMap={},this._clientMap={},this._id=e},n.extend(n.Data,n.PropertyChangeDispatcher,{___accessor:["name"],constructor:n.Data,getId:function(){return this._id},onAlarmChange:function(){},onPropertyChange:function(e,t,n){},setGroupId:function(e){if(this._groupId===e)return;var t=this._groupId;this._groupId=e,this.firePropertyChange("groupId",t,e)},getGroupId:function(){return this._groupId},hasChildren:function(){return this._childList.size()>0},getChildren:function(){return this._childList},isDescendantOf:function(e){if(!e)return!1;if(!e.hasChildren())return!1;var t=this._parent;while(t){if(e===t)return!0;t=t.getParent()}return!1},getParent:function(){return this._parent},getRoot:function(){var e=this._parent;return e&&e._parent==null?e:e&&e._parent!=null?e.getRoot(e):arguments[0]},setParent:function(e){e===null&&e===t;if(this._isUpdatingParent||this._parent===e||this===e)return;if(e&&e.isDescendantOf(this))return;var n=this._parent;this._parent=e,this._isUpdatingParent=!0,n&&n.removeChild(this),e&&e.addChild(this),delete this._isUpdatingParent,this.firePropertyChange("parent",n,e),this.onParentChanged(n,e)},onParentChanged:function(e,t){},addChild:function(e,n){n===t&&(n=this._childList.size());if(!e||e===this)return!1;if(this._childMap[e.getId()])return!1;if(this.isDescendantOf(e))return!1;e.getParent()&&e.getParent().removeChild(e);if(n<0||n>this._childList.size())n=this._childList.size();return this._childList.add(e,n),this._childMap[e._id]=e,e.setParent(this),this.firePropertyChange("children",null,e),this.onChildAdded(e,n),!0},onChildAdded:function(e,t){},clearChildren:function(){if(this._childList!=null&&this._childList.size()>0){var e=this._childList.toList(),t=this;e.forEach(function(e){t.removeChild(e)})}},removeChild:function(e){if(!e)return!1;if(!this._childMap[e._id])return!1;var t=this._childList.remove(e);return delete this._childMap[e._id],this.firePropertyChange("children",e,null),e.setParent(null),this.onChildRemoved(e,t),!0},onChildRemoved:function(e,t){},c:function(e){if(e)for(var t in e)this.setClient(t,e[t])},setClient:function(e,t){if(e==null)return this;this._clientMap==null&&(this._clientMap=new Object);var n=this._clientMap[e];if(n===t)return;return t==null?delete this._clientMap[e]:this._clientMap[e]=t,this._clientMap[e]=t,this.firePropertyChange("C:"+e,n,t),this.onClientChanged(e,n,t),this},getClient:function(e){return this._clientMap[e]},onClientChanged:function(e,t,n){},setPropertyValue:function(e,t){if(this[e]===t)return!1;var r=this[e];return r instanceof n.Color&&t!=null?(r=r.clone(),t instanceof n.Color?this[e].copy(t):this[e].set(t)):this[e]=t,!0}}),n.Element=function(e){n.Data.call(this,e),this._id=e||n.id("E"),this.styleMap={},this._visible=!0,this._selected=!1,this._selectable=!0,this._editable=!0,this.editing=!1,this.up=new o(0,1,0),this._position=new o(0,0,0),this._rotation=new o(0,0,0),this._scale=new o(1,1,1),this.eulerOrder=n.defaultEulerOrder,this.rotationAutoUpdate=!0,this.matrix=new l,this.worldMatrix=new l,this.rotationWorldMatrix=new l,this.matrixAutoUpdate=!1,this.worldMatrixNeedsUpdate=!0,this.quaternion=new n.Quat,this.useQuaternion=!1,this._sizeFixed=!1,this._fixedSize=108,this.castShadow=!0,this.receiveShadow=!0,this.frustumCulled=!0,this._vector=new o,this.renderDepth=null,this._attachId="",this._groupId=null,this.editTransformToParent=!1,this._alarmState=new n.AlarmState(this),this.colors=[]},n.Element.__m1=new l,n.ElementIdCount=0,n.extend(n.Element,n.Data,{IStyle:!0,___accessor:["visible","selected","selectable","editable","sizeFixed"],constructor:n.Element,getAlarmState:function(){return this._alarmState},onAlarmChange:function(e,t){var r=this._alarmState.getHighestNativeAlarmSeverity();r?this.setStyle("m.alarmColor",new n.Color(r.color)):this.setStyle("m.alarmColor",null)},getDefaultInstance:function(){return this.constructor.defaultInstance===t&&(this.constructor.defaultInstance=new this.constructor),this.constructor.defaultInstance},onParentChanged:function(e,t){this.updateWorldMatrix(!0,!1)},onChildAdded:function(e,t){e.updateWorldMatrix(!0,!1)},onChildRemoved:function(e,t){e.updateWorldMatrix(!0,!1)},generatePrimitiveKey:function(){return null},serializeProperty:function(){},clear:function(e){},getSelectStyle:function(){return this.getStyle("select.style")},isSpaceChangedProperty:function(e){return e==="scale"||e==="position"||e==="rotation"},isStyleEquals:function(e,t,n){return t==null&&n==null?!0:t===n},setStyle:function(e,t){if(e==null)return this;this.styleMap==null&&(this.styleMap={});var r=this.styleMap[e];return this.isStyleEquals(e,r,t)?this:(t==null?delete this.styleMap[e]:this.styleMap[e]=t,this.onStyleChanged(e,r,t),this.firePropertyChange(n.Styles.PREFIX_STYLE+e,r,t),this)},s:function(e){if(e==null)return;this.styleMap==null&&(this.styleMap={});var t,r,i,s={};for(t in e){r=e[t],i=this.styleMap[t];if(this.isStyleEquals(t,i,r))continue;r==null?delete this.styleMap[t]:this.styleMap[t]=r,this.firePropertyChange(n.Styles.PREFIX_STYLE+t,i,r),this.isMaterialStyle(t)&&(s[t]=[r,i])}return this.onMaterialStylesChanged(s),this},getStyle:function(e,t,n){n==null&&(n=!0);var r;return this.styleMap!=null&&(r=this.styleMap[e]),t&&(r=this.getCloneObject(r)),r==null&&n&&(r=this.getDefaultStyle(e,t)),r},getCloneObject:function(e){if(e==null)return null;if(n.Utils.isArray(e)){var t=[];for(var r=0;r<e.length;r++)t.push(this.getCloneObject(e[r]));return t}return e.clone?e.clone():e},getSideIndexMapping:function(){},setMaterialStyle:function(e,t){},setMaterialStyles:function(e){var t,r,s,o;for(var u in e){if(u.startsWith("m."))t=u.substr(u.indexOf(".")+1);else if(this.getSideIndexMapping()&&this.isSideStyle(s)){var a=s.substr(0,s.indexOf(".")),f=this.getSideMaterialIndex(a);if(f!=i)continue;s=s.substr(s.indexOf(".")+1),t=s.substr(u.indexOf(".")+1)}else u.startsWith("alarm.billboard.")&&(o=!0);var l=e[u];r=l[0],r==null?r=n.Styles.getStyle(u):P.isArray(r)&&(r=r[i]),this._A97(this.material,t,r)}o&&this._alarmBillboard&&this._setAlarmBillboardPositionAndSize(this._alarmBillboard)},onMaterialStylesChanged:function(e){this.setMaterialStyles(e)},isMaterialStyle:function(e){return e.startsWith("m.")?!0:this.getSideIndexMapping()&&this.isSideStyle(e)?!0:!1},onStyleChanged:function(e,t,n){if(e.startsWith("m."))this.setMaterialStyle(e,n);else if(this.getSideIndexMapping()&&this.isSideStyle(e)){var r=e.substr(0,e.indexOf("."));e=e.substr(e.indexOf(".")+1);var i=this.getSideMaterialIndex(r);this.setMaterialStyle(e,n,i)}else e.startsWith("alarm.billboard.")&&this._alarmBillboard&&this._setAlarmBillboardPositionAndSize(this._alarmBillboard)},textureMapping:{texture:"map",texture1:"map1",texture2:"map2",textureb:"blendMap",texturebp:"bumpMap",lightMap:"lightMap",lightmap:"lightMap",normalmap:"normalMap",envmap:"envMap",specularmap:"specularMap"},_A97:function(e,t,r){if(t.startsWith("texture.")||t.startsWith("texture1.")||t.startsWith("texture2.")||t.startsWith("textureb.")||t.startsWith("texturen.")||t.startsWith("texturebp.")||t.startsWith("lightmap")||t.startsWith("envmap")||t.startsWith("normalmap")||t.startsWith("specularmap")){var i=t.substr(0,t.indexOf(".")),s=t.substr(t.indexOf(".")+1);if(s==="offset"||s==="repeat"){e.setPropertyValue(s,this.getCloneObject(r));return}var o=this.textureMapping[i],u=e[o],a=n.TexturePool.TestTexture;if(s==="image"){var f=r;if(t.startsWith("envmap")&&P.isArray(f))for(var l=0;l<f.length;l++)if(f[l]==null){f=null;break}if(u==null&&f!=null){a.resetValue(),a._image=f,a.setImageSrc(f);var c=a.getUniqueCode(),h=n.TexturePool.getTexture(c);h==null&&(h=new n.Texture(f),n.TexturePool.setTexture(c,h)),e.setMap(h,o)}else if(f==null)e.setMap(null,o);else{u.clone(a,!1),a._image=f,a.setImageSrc(f);var c=a.getUniqueCode(),h=n.TexturePool.getTexture(c);h!==u&&(h==null&&(h=new n.Texture,u.clone(h,!1),h.setImage(f),n.TexturePool.setTexture(c,h)),e.setMap(h,o))}}else if(u!=null){u.clone(a,!1),a[s]=this.getCloneObject(r);var c=a.getUniqueCode(),h=n.TexturePool.getTexture(c);h!=u&&(h==null&&(h=new n.Texture,u.clone(h),h[s]=r),e.setMap(h,o))}}else t==="type"&&e.setType?e.setType(r):e.setPropertyValue(t,this.getCloneObject(r))},getDefaultStyle:function(e,t){if(e==null)return null;if(e.startsWith("m.")){var r=[],i=e.substr(e.indexOf(".")+1);if(this.material.materials){var s=this.material.materials;s=s||[this.material];for(var o=0;o<s.length;o++){var u=s[o];if(i.startsWith("texture.")||i.startsWith("texture1.")||i.startsWith("texture2.")||i.startsWith("textureb.")||i.startsWith("texturen.")||i.startsWith("texturebp.")||i.startsWith("lightmap")||i.startsWith("envmap")||i.startsWith("normalmap")||i.startsWith("specularmap")){var a=i.substr(0,i.indexOf(".")),f=i.substr(i.indexOf(".")+1),l=i.substr(i.indexOf(".")+1),c=this.textureMapping[a],h=u[c];if(h)if(f==="image")if(P.isArray(h._image)){var p=[];r.push(p);for(var d=0;d<h._image.length;d++)p.push(h._image[d].src)}else r.push(h._image.src);else f==="offset"||f==="repeat"?r.push(u[f]):r.push(u.map[f]);else r.push(n.Styles.getStyle(e))}else r.push(u[i])}}t&&(r=this.getCloneObject(r));var v=!0;for(var o=0;o<r.length;o++)if(r.indexOf(r[o])!=0){v=!1;break}return v?r[0]:r}if(this.isSideStyle(e)){var m=e.substr(0,e.indexOf("."));e=e.substr(e.indexOf(".")+1);var i=e.substr(e.indexOf(".")+1),g=this.getSideMaterialIndex(m);if(g!=null){var y,u=this.material.materials[g];return i.startsWith("texture.")?u.map&&(i==="texture.image"?y=u.map._image.src:y=u.map[i]):y=u[i],t&&(y=this.getCloneObject(y)),y}}return n.Styles.getStyle(e)},isSideStyle:function(e){if(e.indexOf(".")===-1)return!1;var n=this.getSideIndexMapping();if(!n)return!1;var r=e.substr(0,e.indexOf("."));return n[r]!==t?!0:!1},setUp:function(e,t,n){var r;if(arguments.length===3){if(this.up.x===e&&this.up.y===t&&this.up.z===n)return;r=new o(e,t,n)}else{if(this.up.x===e.x&&this.up.y===e.y&&this.up.z===e.z)return;r=e}var i=this.up;this.up=r,this.onUpChanged(i,newValue),this.firePropertyChange("up",i,r)},getUp:function(){return this.up},onUpChanged:function(e,t){},checkNumber:function(e,t,n,r){P.isNaN(e)&&console.error(r+",x is not a number"),P.isNaN(t)&&console.error(r+",y is not a number"),P.isNaN(n)&&console.error(r+",z is not a number")},invalidateTexture:function(e){var t=this.material,r,i,s,o;if(e!=null){if(typeof e=="string"){var u=this.getSideIndexMapping();u!=null&&(e=u[e]);if(e==null)return}if(typeof e!="number")return;t instanceof n.ArrayMaterial?s=t.materials[e]:s=materail,this._dirtyMaterialTexture(s)}else if(t instanceof n.ArrayMaterial){i=t.materials;for(r=0;r<i.length;r++)s=i[r],this._dirtyMaterialTexture(s)}},_dirtyMaterialTexture:function(e){e!=null&&e.map&&e.map instanceof n.Texture&&this._dirtyTexture(e.map)},_dirtyTexture:function(e){var t=e._image;e.firePropertyChange("image",null,t)},p:function(e,t,n){if(arguments.length===0)return this.getPosition();arguments.length===3?this.setPosition(e,t,n):this.setPosition(e)},setPosition:function(e,t,n){var r;if(arguments.length===3){if(this._position.x===e&&this._position.y===t&&this._position.z===n)return;this.checkNumber(e,t,n,"setPosition"),r=new o(e,t,n)}else{if(this._position.x===e.x&&this._position.y===e.y&&this._position.z===e.z)return;if(!(e instanceof o))throw"Element.setPosition : position is not instanceof TGL.XiangliangThree";r=e}var i=this._position;this._position=r,this.updateWorldMatrix(!0,!1),this.firePropertyChange("position",i,r)},getPosition:function(e){return e==t&&(e=!0),e?this._position.clone():this._position},setPositionX:function(e){if(this._position.x===e)return;this.checkNumber(e,0,0,"setPositionX");var t=this._position.x;this._position.x=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("positionX",t,e)},setX:function(e){this.setPositionX(e)},getPositionX:function(){return this._position.x},getX:function(){return this.getPositionX()},setPositionY:function(e){if(this._position.y===e)return;this.checkNumber(0,e,0,"setPositionY");var t=this._position.y;this._position.y=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("positionY",t,e)},setY:function(e){this.setPositionY(e)},getPositionY:function(){return this._position.y},getY:function(){return this.getPositionY()},setPositionZ:function(e){if(this._position.z===e)return;this.checkNumber(0,0,e,"setPositionZ");var t=this._position.z;this._position.z=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("positionZ",t,e)},setZ:function(e){this.setPositionZ(e)},getPositionZ:function(){return this._position.z},getZ:function(){return this.getPositionZ()},setScale:function(e,t,n){var r;if(arguments.length===3){if(this._scale.x===e&&this._scale.y===t&&this._scale.z===n)return;this.checkNumber(e,t,n,"setScale"),r=new o(e,t,n)}else{if(this._scale.x===e.x&&this._scale.y===e.y&&this._scale.z===e.z)return;if(!(e instanceof o))throw"Element.setScale : scale is not instanceof TGL.XiangliangThree";r=e}var i=this._scale;r.x=r.x||1,r.y=r.y||1,r.z=r.z||1,this._scale=r,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scale",i,r)},getScale:function(e){return e==t&&(e=!0),e?this._scale.clone():this._scale},setScaleX:function(e){if(this._scale.x===e)return;this.checkNumber(e,0,0,"setScalX");var t=this._scale.x;this._scale.x=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scaleX",t,e)},getScaleX:function(){return this._scale.x},setScaleY:function(e){if(this._scale.y===e)return;this.checkNumber(0,e,0,"setScaleY");var t=this._scale.y;this._scale.y=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scaleY",t,e)},getScaleY:function(){return this._scale.y},setScaleZ:function(e){if(this._scale.z===e)return;this.checkNumber(0,0,e,"setScaleZ");var t=this._scale.z;this._scale.z=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("scaleZ",t,e)},getScaleZ:function(){return this._scale.z},setRotation:function(e,t,n){var r;if(arguments.length===3){if(this._rotation.x===e&&this._rotation.y===t&&this._rotation.z===n)return;this.checkNumber(e,t,n,"setRotation"),r=new o(e,t,n)}else{if(this._rotation.x===e.x&&this._rotation.y===e.y&&this._rotation.z===e.z)return;if(!(e instanceof o))throw"Element.setRotation : rotation is not instanceof TGL.XiangliangThree";r=e}var i=this._rotation;this._rotation=r,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotation",i,r)},getRotation:function(e){return e==t&&(e=!0),e?this._rotation.clone():this._rotation},setRotationX:function(e){if(this._rotation.x===e)return;this.checkNumber(e,0,0,"setRotationX");var t=this._rotation.x;this._rotation.x=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotationX",t,e)},getRotationX:function(){return this._rotation.x},setRotationY:function(e){if(this._rotation.y===e)return;this.checkNumber(0,e,0,"setRotationY");var t=this._rotation.y;this._rotation.y=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotationY",t,e)},getRotationY:function(){return this._rotation.y},setRotationZ:function(e){if(this._rotation.z===e)return;this.checkNumber(0,0,e,"setRotationZ");var t=this._rotation.z;this._rotation.z=e,this.updateWorldMatrix(!0,!1),this.firePropertyChange("rotationZ",t,e)},getRotationZ:function(){return this._rotation.z},applyMatrix:function(e){var t=this.matrix.clone();this.matrix.multiplyMatrices(e,this.matrix),this._scale.getScaleFromMatrix(this.matrix);var n=(new l).extractRotation(this.matrix);this._rotation.setEulerFromRotationMatrix(n,this.eulerOrder),this._position.getPositionFromMatrix(this.matrix),this.updateWorldMatrix(!0,!1),this.firePropertyChange("matrix",t,this.matrix)},translate:function(e,t){this.matrix.rotateAxis(t),this.setPosition(this._position.clone().add(t.multiplyScalar(e)))},translateX:function(e){this.translate(e,this._vector.set(1,0,0))},translateY:function(e){this.translate(e,this._vector.set(0,1,0))},translateZ:function(e){this.translate(e,this._vector.set(0,0,1))},rotateFromAxis:function(e,t,n){t=t.clone().applyMatrix4(this.matrix),e=e.clone().applyMatrix4((new l).extractRotation(this.matrix));var r=(new l).makeRotationAxisAndCenter(e,n,t);this.applyMatrix(r)},rotateFromWorldAxis:function(e,t){var n=new l;n.makeRotationAxis(e.normalize(),t),n.multiply(this.matrix),this.matrix=n;var r=(new l).extractRotation(this.matrix),i=new o;i.setEulerFromRotationMatrix(r,this.eulerOrder),this.setRotation(i)},getEulerAngles:function(){return this.matrix.getEulerAngles()},rotateFromWorldXAxis:function(e){this.rotateFromWorldAxis(new o(1,0,0),e)},rotateFromWorldYAxis:function(e){this.rotateFromWorldAxis(new o(0,1,0),e)},rotateFromWorldZAxis:function(e){this.rotateFromWorldAxis(new o(0,0,1),e)},getRelativeTransform:function(e){if(e instanceof n.Element){var t=(new l).getInverse(e.matrix.clone()),r=(new l).multiplyMatrices(t,this.matrix.clone()),i=(new o).getPositionFromMatrix(r),s=(new o).setEulerFromRotationMatrix(r),u=(new o).getScaleFromMatrix(r),a={position:i,rotation:s,scale:u,matrix:r};return a}return null},localToWorld:function(e){return this._parent==null?e:e.clone().applyMatrix4(this._parent.worldMatrix)},localToWorld2:function(e){return e.clone().applyMatrix4(this.worldMatrix)},getWorldPosition:function(){return this.worldMatrix.getPosition()},direction:function(e){var t=e.applyMatrix4((new l).extractRotation(this.worldMatrix));return t.normalize(),t},frontDirection:function(){var e=new o(0,0,1);return e=e.applyMatrix4((new l).extractRotation(this.worldMatrix)),e.normalize(),e},worldPosition:function(e,t){t=t>0?t:e.length();var n=this.worldMatrix.getPosition();return n.add(this.direction(e).multiplyScalar(t))},frontWorldPosition:function(e){e=e>0?e:1;var t=this.worldMatrix.getPosition();return t.add(this.frontDirection().multiplyScalar(e))},worldToLocal:function(e){return e.clone().applyMatrix4(n.Element.__m1.getInverse(this.worldMatrix))},lookAt:function(e,t){this.matrix.lookAt(e,this._position,t?t:this.up),this.rotationAutoUpdate&&(this.useQuaternion===!1?this._rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder):this.quaternion.copy(this.matrix.decompose()[1])),this.worldMatrixNeedsUpdate=!0},iterator:function(e){e(this),this._childList&&this._childList.forEach(function(t){t.iterator(e)})},getChildByName:function(e,n){for(var r=0,i=this.children.length;r<i;r++){var s=this.children[r];if(s.name===e)return s;if(n===!0){s=s.getChildByName(e,n);if(s!==t)return s}}return t},getDescendants:function(e){e===t&&(e=[]);var n=this.getChildren().toArray();Array.prototype.push.apply(e,n);for(var r=0,i=n.length;r<i;r++)n[r].getDescendants(e);return e},fixSize:function(e){if(this._sizeFixed){this.updateWorldMatrix();var t=new o,n=new o;t.getPositionFromMatrix(this.worldMatrix),e.updateWorldMatrix(),n.getPositionFromMatrix(e.worldMatrix),scale=t.distanceTo(n)/this._fixedSize,scale===0&&(scale=1e-5),this.setScale(scale,scale,scale)}},updateMatrix:function(){this.matrix.setPosition(this._position),this.useQuaternion===!1?this.matrix.setRotationFromEuler(this._rotation,this.eulerOrder):this.matrix.setRotationFromQuaternion(this.quaternion),(this._scale.x!==1||this._scale.y!==1||this._scale.z!==1)&&this.matrix.scale(this._scale),this.worldMatrixNeedsUpdate=!0},updateWorldMatrix:function(e,n){n=n==t?!0:n,this.matrixAutoUpdate===!0&&this.updateMatrix();if(this.worldMatrixNeedsUpdate===!0||e===!0){this.matrixAutoUpdate===!1&&this.updateMatrix();var r=this.worldMatrix.clone();this._parent==t?this.worldMatrix.copy(this.matrix):this.worldMatrix.multiplyMatrices(this._parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,e=!0,r.equals(this.worldMatrix)||(n&&this.firePropertyChange("worldMatrix",r,this.worldMatrix),this.updateGleyeMatrix&&this.updateGleyeMatrix(!1))}this._childList.forEach(function(t){t.updateWorldMatrix(e)})},cloneCallback:function(e){},clonePrefab:function(e){var n=new mono.Entity;e===t&&(e=!0),n.name=this.name,n.up==null&&(n.up=new o(0,1,0)),n.up.copy(this.up),n._position.copy(this._position),n._rotation.copy(this._rotation),n.eulerOrder=this.eulerOrder,n._scale.copy(this._scale),n.renderDepth=this.renderDepth,n.rotationAutoUpdate=this.rotationAutoUpdate,n.matrix.copy(this.matrix),n.worldMatrix.copy(this.worldMatrix),n.rotationWorldMatrix.copy(this.rotationWorldMatrix),n.matrixAutoUpdate=this.matrixAutoUpdate,n.worldMatrixNeedsUpdate=this.worldMatrixNeedsUpdate,n.quaternion.copy(this.quaternion),n.useQuaternion=this.useQuaternion,n._visible=this._visible,n.castShadow=this.castShadow,n.receiveShadow=this.receiveShadow,n.frustumCulled=this.frustumCulled,n.styleMap=n.styleMap||{},e&&this._childList&&this._childList.forEach(function(t){n.addChild(t.clonePrefab(e))}),n.vertices=this.vertices,n.faces=this.faces,n.uvs=this.uvs,n.uv2s=this.uv2s,n.primitive=this.primitive,n.data=this.primitive.data,n.computed=!0;for(var r in this.styleMap)n.styleMap[r]=this.getCloneObject(this.styleMap[r]);if(this._clientMap!=null)for(var i in this._clientMap)n.setClient(i,this._clientMap[i]);return this.material&&this.material.clone&&(n.material=this.material.clone()),n.material=this.material,n},clone:function(e,r,i){typeof e=="boolean"&&(i=r,r=e,e=t),e==t&&(this.constructor?e=new this.constructor:e=new n.Element),i===t&&(i=!0),e.name=this.name,e.up==null&&(e.up=new o(0,1,0)),e.up.copy(this.up),e._position.copy(this._position),e._rotation.copy(this._rotation),e.eulerOrder=this.eulerOrder,e._scale.copy(this._scale),e.renderDepth=this.renderDepth,e.rotationAutoUpdate=this.rotationAutoUpdate,e.matrix.copy(this.matrix),e.worldMatrix.copy(this.worldMatrix),e.rotationWorldMatrix.copy(this.rotationWorldMatrix),e.matrixAutoUpdate=this.matrixAutoUpdate,e.worldMatrixNeedsUpdate=this.worldMatrixNeedsUpdate,e.quaternion.copy(this.quaternion),e.useQuaternion=this.useQuaternion,e._visible=this._visible,e.castShadow=this.castShadow,e.receiveShadow=this.receiveShadow,e.frustumCulled=this.frustumCulled,e.styleMap=e.styleMap||{},i&&this._childList&&this._childList.forEach(function(t){e.addChild(t.clone(r,i))});if(this.constructor){var s=this.constructor.prototype.__accessor,u=this.constructor.prototype.__bool;if(s&&s.length>0)for(var a=0;a<s.length;a++){var f=s[a],l=n.getter(f,u),c=n.setter(f);f==="vertices"?e.vertices=this.vertices:f==="faces"?e.faces=this.faces:e[c]&&e[c](this[l]())}}if(r&&this.vertices){var h=e,p=this.vertices;h.vertices=[],h.faces=[],h.uvs=[];for(var a=0,d=p.length;a<d;a++)h.vertices.push(p[a].clone());var v=this.faces;for(var a=0,d=v.length;a<d;a++)h.faces.push(v[a].clone());var m=this.uvs;for(var a=0,d=m.length;a<d;a++){var g=m[a],y=[];for(var b=0,w=g.length;b<w;b++)y.push(new n.XiangliangTwo(g[b].x,g[b].y));h.uvs.push(y)}}for(var E in this.styleMap)e.setStyle(E,this.getCloneObject(this.styleMap[E]));if(this._clientMap!=null)for(var S in this._clientMap)e.setClient(S,this._clientMap[S]);return this.material&&this.material.clone&&(e.material=this.material.clone()),e.cloneCallback(r),e}}),n.Annotation=function(e,t,r,i){n.Element.call(this,i),this._label=e,this._text=t,this.buttons=r,this._gleyePosition=null},n.extend(n.Annotation,n.Element,{___accessor:["label","text","gleyePosition"]}),n.Node=function(e){n.Element.call(this,e),this.name="",this.computed=!1,this.selectionData=null,this.stylesMap=new Object,this.renderGroup=[],this.primitive=null,this.vertices=[],this.faces=[],this.uvs=[],this.uv2s=[],this.colors=[],this.normals=[],this.faces=[],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.dynamic=!0,this.verticesNeedUpdate=!1,this.morphTargetsNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.tangentsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.buffersNeedUpdate=!1,this.computeNodeData(),this._alarmBillboard=null},n.extend(n.Node,n.Element,{__accessor:["vertices","faces","uvs","linkAgent"],__SizePropeties:[],setUpdateFlags:function(e){this.verticesNeedUpdate=e,this.morphTargetsNeedUpdate=e,this.elementsNeedUpdate=e,this.uvsNeedUpdate=e,this.normalsNeedUpdate=e,this.tangentsNeedUpdate=e,this.colorsNeedUpdate=e},getLinks:function(){return this._links},getFromLinks:function(){return this._fromLinks},getToLinks:function(){return this._toLinks},_addFromLink:function(e){this._allLinks||(this._allLinks=new N),this._fromLinks||(this._fromLinks=new N),this._allLinks.add(e),this._fromLinks.add(e),this._resetLinkSet()},_addToLink:function(e){this._allLinks||(this._allLinks=new N),this._toLinks||(this._toLinks=new N),this._allLinks.add(e),this._toLinks.add(e),this._resetLinkSet()},_removeFromLink:function(e){this._allLinks.remove(e),this._fromLinks.remove(e),this._allLinks.size()===0&&delete this._allLinks,this._fromLinks.size()===0&&delete this._fromLinks,this._resetLinkSet()},_removeToLink:function(e){this._allLinks.remove(e),this._toLinks.remove(e),this._allLinks.size()===0&&delete this._allLinks,this._toLinks.size()===0&&delete this._toLinks,this._resetLinkSet()},_resetLinkSet:function(){delete this._loopedLinks;if(!this._allLinks||this._allLinks.size()===0){delete this._links;return}var e;this._allLinks.forEach(function(t){t.isLooped()&&(e||(e={}),e[t._id]||(this._loopedLinks||(this._loopedLinks=new N),this._loopedLinks.add(t),e[t._id]=t))},this),e?(this._links=new N,this._allLinks.forEach(function(t){e[t._id]?e[t._id]!==!1&&(e[t._id]=!1,this._links.add(t)):this._links.add(t)},this)):this._links=this._allLinks},onAlarmChange:function(e,t){n.Element.prototype.onAlarmChange.call(this,e,t);var r=this;setTimeout(function(){var e=r._alarmState.getPropagateSeverity();e||(e=r._alarmState.getHighestNativeAlarmSeverity());var t=r._parent,i=!1;if(t==null||!t._alarmState)i=!0;else{var s=t._alarmState.getPropagateSeverity();s||(i=!0)}e&&i?(r._alarmBillboard==null&&r.setAlarmBillboard(new n.Billboard),r._alarmBillboard.setStyle("m.texture.image",n.ImageCache.AlarmBillboardImage),r._alarmBillboard.setStyle("m.color",e.color),r._alarmBillboard.setStyle("m.alignment",n.BillboardAlignment.bottomCenter)):r.setAlarmBillboard(null)},100)},_setAlarmBillboardPositionAndSize:function(e){var t=this.getStyle("alarm.billboard.position"),n=this.getBizBox(),r=n.min,i=n.max,s=n.center(),u=n.size();t==="topLeft"?e._position.set(r.x,i.y,s.z+1):t==="topRight"?e._position.set(i.x,i.y,s.z+1):t==="topBack"?e._position.set(s.x,i.y,r.z-1):t==="topFront"?e._position.set(s.x,i.y,i.z+1):e._position.set(s.x,i.y,s.z+1);var a=this.getStyle("alarm.billboard.scale");a instanceof o?e._scale.copy(a):e._scale.set(u.x/2,u.x/2,1);var f=this.getStyle("alarm.billboard.vertical");e.setStyle("m.vertical",f)},getLinkOffset:function(e){return new mono.XiangliangThree(0,0,0)},getLinkExtend:function(e){return new mono.XiangliangThree(0,0,0)},clearLinkOrthogonal:function(e,t){return!1},clearLinkExtend:function(e,t){return!1},setAlarmBillboard:function(e){if(this._alarmBillboard===e)return;var t=this._alarmBillboard;e?(this._alarmBillboard=e,e.setParent(this),this._setAlarmBillboardPositionAndSize(e)):delete this._alarmBillboard,this.firePropertyChange("alarmBillboard",t,e)},needUpdate:function(){return this.verticesNeedUpdate||this.morphTargetsNeedUpdate||this.elementsNeedUpdate||this.uvsNeedUpdate||this.normalsNeedUpdate||this.tangentsNeedUpdate||this.colorsNeedUpdate},getVerticesWithChildren:function(e,t){function h(n){n.applyMatrix4(e),t.push(n)}t==null&&(t=[]),e==null&&(e=new l);var r,i;if(this instanceof n.Node){if(this.vertices!=null&&this.vertices.length!=0){var s=this.getBizBox(),u=s.min,a=s.max;h(u.clone()),h(a.clone()),h(new o(u.x,u.y,a.z)),h(new o(u.x,a.y,u.z)),h(new o(a.x,u.y,u.z)),h(new o(a.x,a.y,u.z)),h(new o(a.x,u.y,a.z)),h(new o(u.x,a.y,a.z))}for(var r=0;r<(this._childList?this._childList.size():0);r++){var f=this._childList.get(r),c=new l;c.multiplyMatrices(e,f.matrix.clone()),f.getVerticesWithChildren&&f.getVerticesWithChildren(c,t)}}return t},getBizBoxWithChildren:function(e){var t=this.getVerticesWithChildren();if(e)for(var r=0;r<e.length;r++){var i=e[r];if(i.getParent()===this.getParent()&&i!==this){var s=(new l).getInverse(this.matrix.clone()),o=(new l).multiplyMatrices(s,i.matrix.clone());t=t.concat(i.getVerticesWithChildren(o))}}var u=new n.BizBox;return u.setFromPoints(t),u},getWorldBizBox:function(){var e=[];for(var t=0;t<this.vertices.length;t++){var r=this.vertices[t].clone();r.applyMatrix4(this.worldMatrix),e.push(r)}var i=new n.BizBox;return i.setFromPoints(e),i},getBizBox:function(){return this.boundingBox==null&&this.computeBizBox(),this.boundingBox},computeBizBox:function(){this.boundingBox===null&&(this.boundingBox=new n.BizBox),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){this.boundingSphere===null&&(this.boundingSphere=new n.BoundingSphere),this.boundingSphere.setFromCenterAndPoints(this.boundingSphere.center,this.vertices)},createPropagateAlarmCube:function(e){this.boundingBox==null&&this.computeBizBox(),e._attachId=this._id;if(this.propagateAlarmData==null){var t=this.getStyle("outer.offset"),n=this.boundingBox.min,r=this.boundingBox.max;e.width=r.x-n.x+t,e.height=r.y-n.y+t,e.depth=r.z-n.z+t,e.computed=!1,e.computeNodeData(),this.propagateAlarmData=e.data,S(e,!0),this.propagateAlarmData.primitive=e.primitive
,this.propagateAlarmData.groups=e.groups;var i=(new o).center(n,r);for(var s=0;s<e.vertices.length;s++){var u=e.vertices[s];u.add(i)}this.propagateAlarmData.vertices=e.vertices}else{var a=this.propagateAlarmData;e.primitive=a.primitive,e.data=a,e.vertices=a.vertices,e.uvs=a.uvs,e.faces=a.faces,e.groups=a.groups}this.updateMatrix(!0),e._position.copy(this._position),e._scale.copy(this._scale),e._rotation.copy(this._rotation),e.useQuaternion=this.useQuaternion,e.quaternion=this.quaternion,e.worldMatrix=this.worldMatrix,e._parent=this.getParent(),e.updateMatrix(!0);var f=e.material;f.wireframeLinewidth=this.getStyle("outer.width");var l=this.getAlarmState().getPropagateSeverity();return f.color.set(l.color),e},createCanvasSelectionCube:function(){return this._csc==null&&(this._csc=new _,this._csc.material=new n.EntityMaterial,this._csc.material.wireframe=!0),this.createSelectionCube(this._csc),this._csc},createSelectionCube:function(e){this.boundingBox==null&&this.computeBizBox(),e._attachId=this._id+"_selection";if(this.selectionData==null){var t=this.getStyle("select.offset"),n=this.boundingBox.min,r=this.boundingBox.max,i=(new o).center(n,r);e.width=r.x-n.x+t,e.height=r.y-n.y+t,e.depth=r.z-n.z+t,e.offset=i,e.computed=!1;var s=e.computeNodeData();this.selectionData=e.data,S(e,!0),this.selectionData.primitive=e.primitive,this.selectionData.groups=e.groups,this.selectionData.vertices=e.vertices}else{var u=this.selectionData;e.primitive=u.primitive,e.data=u,e.vertices=u.vertices,e.uvs=u.uvs,e.faces=u.faces,e.groups=u.groups}this.updateMatrix(!0),e._position.copy(this._position),e._scale.copy(this._scale),e._rotation.copy(this._rotation),e.useQuaternion=this.useQuaternion,e.quaternion=this.quaternion,e.worldMatrix=this.worldMatrix,e._parent=this.getParent(),e.updateMatrix(!0);var a=e.material;return a.wireframeLinewidth=this.getStyle("select.width"),a.color.set(this.getStyle("select.color")),e},mergeVertices:function(){var e={},n=[],r=[],i,s,o=4,u=Math.pow(10,o),a,f,l,c,h,p,d,v;this.__tmpVertices=t,this.vertices==null&&console.log("vertices is null");for(a=0,f=this.vertices.length;a<f;a++)i=this.vertices[a],s=[Math.round(i.x*u),Math.round(i.y*u),Math.round(i.z*u)].join("_"),e[s]===t?(e[s]=a,n.push(this.vertices[a]),r[a]=n.length-1):r[a]=r[e[s]];var m=[];for(a=0,f=this.faces.length;a<f;a++){l=this.faces[a];if(l instanceof O){l.a=r[l.a],l.b=r[l.b],l.c=r[l.c],c=[l.a,l.b,l.c];var g=-1;for(var y=0;y<3;y++)if(c[y]==c[(y+1)%3]){g=y,m.push(a);break}}else if(l instanceof M){l.a=r[l.a],l.b=r[l.b],l.c=r[l.c],l.d=r[l.d],c=[l.a,l.b,l.c,l.d];var g=-1;for(var y=0;y<4;y++)c[y]==c[(y+1)%4]&&(g>=0&&m.push(a),g=y);if(g>=0){c.splice(g,1);var b=new O(c[0],c[1],c[2],l.normal,l.color,l.materialIndex);v=this.uvs[a],v&&v.splice(g,1),l.vertexNormals&&l.vertexNormals.length>0&&(b.vertexNormals=l.vertexNormals,b.vertexNormals.splice(g,1)),l.vertexColors&&l.vertexColors.length>0&&(b.vertexColors=l.vertexColors,b.vertexColors.splice(g,1)),this.faces[a]=b}}}for(a=m.length-1;a>=0;a--);var w=this.vertices.length-n.length;return this.vertices=n,w},computeVertexNormals:function(e){var r,i,s,o,u,a;if(this.__tmpVertices===t){this.__tmpVertices=new Array(this.vertices.length),a=this.__tmpVertices;for(r=0,i=this.vertices.length;r<i;r++)a[r]=new n.XiangliangThree;for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],u.vertexNormals=[new n.XiangliangThree,new n.XiangliangThree,new n.XiangliangThree]}else{a=this.__tmpVertices;for(r=0,i=this.vertices.length;r<i;r++)a[r].set(0,0,0)}if(e){var f={},l={},c,h,p,d,v=new n.XiangliangThree,m=new n.XiangliangThree,g=new n.XiangliangThree,y=new n.XiangliangThree,b=new n.XiangliangThree,w;for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],c=this.vertices[u.a],h=this.vertices[u.b],p=this.vertices[u.c],v.subVectors(p,h),m.subVectors(c,h),v.cross(m),a[u.a].add(v),a[u.b].add(v),a[u.c].add(v),u.d!=t&&a[u.d].add(v)}else for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],a[u.a].add(u.normal),a[u.b].add(u.normal),a[u.c].add(u.normal);for(r=0,i=this.vertices.length;r<i;r++)a[r].normalize();for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],u.vertexNormals[0].copy(a[u.a]),u.vertexNormals[1].copy(a[u.b]),u.vertexNormals[2].copy(a[u.c]),u.d!=t&&(u.vertexNormals[3]=a[u.d].clone())},computeCentroids:function(){var e,t,n;for(e=0,t=this.faces.length;e<t;e++)n=this.faces[e],n.centroid=n.centroid||new o,n.centroid==null&&console.log("fdasfdsa"),n.centroid.set||(n.centroid=new o),n.centroid.set(0,0,0),n instanceof O?(n.centroid.add(this.vertices[n.a]),n.centroid.add(this.vertices[n.b]),n.centroid.add(this.vertices[n.c]),n.centroid.divideScalar(3)):n instanceof M&&(n.centroid.add(this.vertices[n.a]),n.centroid.add(this.vertices[n.b]),n.centroid.add(this.vertices[n.c]),n.centroid.add(this.vertices[n.d]),n.centroid.divideScalar(4))},computeFaceNormals:function(){var e,t,n,r,i,s,u,a,f,l,c,h=new o,p=new o;for(s=0,u=this.faces.length;s<u;s++)a=this.faces[s],f=this.vertices[a.a],l=this.vertices[a.b],c=this.vertices[a.c],h.subVectors(c,l),p.subVectors(f,l),h.cross(p),h.normalize(),a.normal.copy||(a.normal=new o),a.normal.copy(h)},computeVertex:function(){},computePrimitive:function(){},generalteGroup:function(){},getMatetial:function(){return this.material},computeNodeMaterial:function(e){},cacheNodeMaterial:function(e){},needComputeVertexNormal:function(){return!0},computeNodeData:function(e){if(this.computed===!1){var t=this.generatePrimitiveKey();this._attachId&&(t+="_"+this._attachId);var r=n.PrimitiveCache.getPrimitive(t),i=!1;if(!r){var s=this.computeData();this.needComputeVertexNormal()&&(n.Node.prototype.mergeVertices.call(s),n.Node.prototype.computeFaceNormals.call(s),n.Node.prototype.computeVertexNormals.call(s,!0));if(s.uv2s==null||s.uv2s.length==0){s.uv2s=[];if(s.uvs!=null&&s.uvs.length>0)for(var o=0;o<s.uvs.length;o++){var u=[],a=s.uvs[o];for(var f=0;f<a.length;f++)u.push(a[f].clone());s.uv2s.push(u)}}r=new n.Primitive(s,t),n.PrimitiveCache.setPrimitive(t,r),this.cacheNodeMaterial(r),i=!0}else this.primitive&&n.PrimitiveCache.unUsePrimitive(r),this.computeNodeMaterial(r);return n.PrimitiveCache.usePrimitive(r),this.primitive=r,this.data=r.data,this.vertices=r.vertices,this.faces=r.faces,this.uvs=r.uvs,this.uv2s=r.uv2s,this.computed=!0,i}},computeData:function(){var e={vertices:[],faces:[],uv2s:[],uvs:[]};return this.vertices=e.vertices,this.uvs=e.uvs,this.faces=e.faces,this.data=e,e},setMaterial:function(e,t,n){var r=t.getUniqueCode?t.getUniqueCode():null,i=ni.getMaterial(r);i?(this.material.materials[e]=i,ni.useMaterial(i)):(this.material.materials[e]=t,ni.setMaterial(r,t),ni.useMaterial(t)),ni.unUseMaterial(n)},onMaterialMapping:function(){this.groups=t},getMaterialSize:function(){return this.materialSize||1},startBatch:function(){this.batch=!0},endBatch:function(){this.materialMappingChanges!==t&&(this.onSizeChanged(),this.onMaterialMapping(),this.firePropertyChange("materialMapping",this.materialMappingChanges[0],this.materialMappingChanges[1]),this.materialMappingChanges=t),this.batch=!1},compareAndSetMaterial:function(e,t,n){this.setMaterial(n,t,e)},cloneStyle:function(e){if(this.getClassName()!=e.getClassName()){console.warn("ApplyStyle fail, the source with not the same class");return}var t=this.getMaterialMapping();for(var r=0;r<this.getMaterialSize();r++){var i=this.material.materials[r],s=e.material.materials[r];this.compareAndSetMaterial(i,s,r)}var o=this.getMaterialMapping();n.Utils.isSame(t,o)||(this.batch?this.materialMappingChanges=[t,o]:(this.onSizeChanged(),this.onMaterialMapping(),this.firePropertyChange("materialMapping",t,o)))},_considerArray:function(e,t){if(!e.startsWith("envmap.image"))return P.isArray(t);var n=!1;if(P.isArray(t))for(var r=0;r<t.length;r++)if(P.isArray(t[r])){n=!0;break}return n},setMaterialStyles:function(e){var t=this.getMaterialMapping(),r,i,s,o,u,a,f,l,c,t=this.getMaterialMapping();for(var h in e)var p=e[h];for(var d=0;d<this.getMaterialSize();d++){o=this.material.materials[d],u=o.clone();var v=!1;for(var h in e){var m=!1;if(h.startsWith("m."))f=h.substr(h.indexOf(".")+1);else if(this.getSideIndexMapping()&&this.isSideStyle(h)){var g=h.substr(0,h.indexOf(".")),l=this.getSideMaterialIndex(g);if(l!=d)continue;m=!0,c=h.substr(h.indexOf(".")+1),f=c.substr(c.indexOf(".")+1)}var p=e[h];s=p[0],s==null?s=n.Styles.getStyle(h):this._considerArray(f,s)&&(s=s[d]),this._A97(u,f,s),v=!0}v&&this.compareAndSetMaterial(o,u,d)}this.changeMapping(t)},setMaterialStyle:function(e,t,r){var t,i,s,o,u,a,f=e;e.startsWith("m.")&&(f=e.substr(e.indexOf(".")+1));if(r==null&&!n.Utils.isArray(t)){var l=[];for(h=0;h<this.getMaterialSize();h++)l.push(t);this.styleMap[e]=l,t=l}var c=!1;if(f.startsWith("envmap.image")&&t&&P.isArray(t))for(var h=0;h<t.length;h++){if(!!P.isArray(t[h])){c=!1;break}c=!0}var p=this.getMaterialMapping();if(r==null&&(!n.Utils.isArray(t)||c)){var d=[];for(var h=0;h<this.getMaterialSize();h++){if(d[h]===!0)continue;s=t,o=this.material.materials[h],u=o.clone(),s==null&&(s=n.Styles.getStyle(e)),this._A97(u,f,s),this.compareAndSetMaterial(o,u,h)}}else if(n.Utils.isArray(t)){i=t;for(var h=0;h<this.getMaterialSize();h++)s=i[h],o=this.material.materials[h],u=o.clone(),s==null&&(s=n.Styles.getStyle(e)),this._A97(u,f,s),this.compareAndSetMaterial(o,u,h)}else if(r!=null){var p=this.getMaterialMapping();o=this.material.materials[r],u=o.clone(),this._A97(u,f,t),this.compareAndSetMaterial(o,u,r),this.synchronizeIndexStyle(e,r,t)}this.changeMapping(p)},changeMapping:function(e){var t=this.getMaterialMapping();n.Utils.isSame(e,t)||(this.batch?this.materialMappingChanges=[e,t]:(this.onSizeChanged(),this.onMaterialMapping(),this.firePropertyChange("materialMapping",e,t)))},synchronizeSideStyle:function(e,t,n){var r=this.getMaterialIndexSide(t);r&&this.styleMap[r+"."+e]!=null&&(this.styleMap[r+"."+e]=n)},synchronizeIndexStyle:function(e,t,r){var s=this.styleMap[e];s==null&&(s=this.getStyle(e),this.styleMap[e]=s);if(n.Utils.isArray(s))s[t]=r;else{var o=[];for(i=0;i<this.getMaterialSize();i++)o.push(s);o[t]=r,this.styleMap[e]=o}},getDefaultMaterial:function(e,t){return e?e instanceof n.ArrayMaterial?e.materials.length===0?ni.DefaultMaterial:(t>=e.materials.length&&(t=e.materials.length-1),e.materials[t]):e:ni.DefaultMaterial},createMaterial:function(e){var t=new n.ArrayMaterial;this.material=t;var r=this.getMaterialSize();for(var i=0;i<r;i++)this.setMaterial(i,this.getDefaultMaterial(e,i))},onPropertyChange:function(e,t,n){this.changeProperty=e,this.oldGroups=this.groups;var r=this.isSizeChangedProperty(e);r&&this.onSizeChanged(),r&&this.onMaterialMapping(),r&&this.firePropertyChange("materialMapping",0,1)},onSizeChanged:function(){this.computed=!1,this.computeNodeData(),this.computeCentroids(),this.computeFaceNormals(),this.computeBizBox(),this.selectionData=null,this.boundingSphere=null,this.changeProperty=null},isSizeChangedProperty:function(e){return this.__SizePropeties.indexOf(e)!==-1||e=="vertices"||e=="faces"||e=="uvs"},isGroupChangedProperty:function(e){},getMaterialMapping:function(){var e={},t=this.material.materials;for(var n in t)e[n]=t.indexOf(t[n]);return e},getSideMaterialIndex:function(e){var t=this.getSideIndexMapping();if(t)return t[e]},getMaterialIndexSide:function(e){var t=this.getIndexSideMapping();if(t)return t[e]},getIndexSideMapping:function(){var e=this.getSideIndexMapping();if(e&&!this.IndexSideMapping){this.IndexSideMapping={};var t,n;for(t in e)n=e[t],this.IndexSideMapping[n]=t}return this.IndexSideMapping},getSideIndexMapping:function(){},disposeMaterial:function(){},getMaterial:function(){return this.material}});var A=function(e,t,r){this.normal=e instanceof n.XiangliangThree?e:new n.XiangliangThree,this.vertexNormals=e instanceof Array?e:[],this.color=t instanceof n.Color?t:new n.Color,this.vertexColors=t instanceof Array?t:[],this.materialIndex=r?r:0,this.centroid=new n.XiangliangThree};n.Face=A,A.prototype={constructor:n.Face,subClone:function(){},clone:function(){var e=this.subClone();e.normal.copy(this.normal),e.color.copy(this.color),e.centroid.copy(this.centroid),e.materialIndex=this.materialIndex;var t,n;for(t=0,n=this.vertexNormals.length;t<n;t++)e.vertexNormals.push(this.vertexNormals[t]);for(t=0,n=this.vertexColors.length;t<n;t++)e.vertexColors.push(this.vertexColors[t]);return e}};var O=function(e,t,r,i,s,o){n.Face.call(this,i,s,o),this.a=e,this.b=t,this.c=r};n.Face3=O,O.prototype=Object.create(n.Face.prototype),O.prototype.constructor=n.Face3,O.prototype.subClone=function(){var e=new O(this.a,this.b,this.c);return e},O.prototype.vertexCount=3,O.prototype.serializeJsonValue=function(){return{a:this.a,b:this.b,c:this.c}};var M=function(e,t,r,i,s,o,u){n.Face.call(this,s,o,u),this.a=e,this.b=t,this.c=r,this.d=i};n.Face4=M,M.prototype=Object.create(n.Face.prototype),M.prototype.constructor=n.Face4,M.prototype.subClone=function(){var e=new M(this.a,this.b,this.c,this.d);return e},M.prototype.splitToFace3s=function(){var e=new O(this.a,this.b,this.d,this.normal,this.color,this.materialIndex),t=new O(this.d,this.b,this.c,this.normal,this.color,this.materialIndex);return[e,t]},M.prototype.vertexCount=4,M.prototype.serializeJsonValue=function(){return{a:this.a,b:this.b,c:this.c,d:this.d}},n.Entity=function(e,r){e instanceof n.ArrayMaterial?(this.material=e,this.materialSize=this.material.materials.length||1):e instanceof n.Material?(this.material=e,this.materialSize=1):e&&(this.materialSize=e),this.materialSize=this.materialSize||1,this.createMaterial(this.material),r!=t&&this._id==null&&(this._id=r),n.Node.call(this,this._id),this.groups=null},n.extend(n.Entity,n.Node,{constructor:n.Entity,className:"TGL.Entity",setUpdateFlags:function(e){this.verticesNeedUpdate=e,this.morphTargetsNeedUpdate=e,this.elementsNeedUpdate=e,this.uvsNeedUpdate=e,this.normalsNeedUpdate=e,this.colorsNeedUpdate=e,this.tangentsNeedUpdate=e,this.buffersNeedUpdate=e},cloneCallback:function(e){e&&this.className==="TGL.Entity"&&(this.computed=!1,this.computeNodeData())},needComputeVertexNormal:function(){return!1},computeData:function(){var e={vertices:this.vertices,faces:this.faces,uvs:this.uvs,uv2s:this.uv2s};return e},getMaterialSize:function(){return this.materialSize},setMaterialSize:function(e){typeof e=="number"&&(this.materialSize=e,this.createMaterial(this.material))}});var _=function(){var e,t,r,i,s,u,a,f,l,c;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(a=arguments[0],e=a.width,t=a.height,r=a.depth,i=a.segmentsW,s=a.segmentsH,u=a.segmentsD,c=a.wrapMode,this._id=a.id):arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4],s=arguments[5],u=arguments[6],c=arguments[7]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4],u=arguments[5],c=arguments[6]),this.width=e||1,this.height=t||1,this.depth=r||1,this.segmentsW=i||1,this.segmentsH=s||1,this.segmentsD=u||1,this.wrapMode=(c||"").toLowerCase(),this.materialSize=this.wrapMode==null||this.wrapMode==""?6:1,this.offset=new o(0,0,0),n.Entity.call(this)};n.Cube=_,n.extend(n.Cube,n.Entity,{__accessor:["width","height","depth","wrapMode"],__SizePropeties:["width","height","depth","wrapMode"],className:"TGL.Cube",getUVs:function(){return this.uvs},setPropertyValue:function(e,t){var n=this[e];if(n===t)return!1;this[e]=t;if(e==="wrapMode"){var r=this.wrapMode,i=r=="six-each"||r=="front-other"||r=="back-other"||r=="left-other"||r=="right-other"||r=="top-other"||r=="bottom-other";this.materialSize=this.wrapMode==null||this.wrapMode==""?6:1,i||(this[e]="")}return!0},getLinkOffset:function(e){var t=e.length();e.normalize();var n=e.x/this.getWidth(),r=e.y/this.getHeight(),i=e.z/this.getDepth(),s=Math.max(Math.abs(n),Math.abs(r),Math.abs(i));return s==Math.abs(n)?new o(this.getWidth()/2*(n<0?-1:1),0,0):s==Math.abs(r)?new o(0,this.getHeight()/2*(r<0?-1:1),0):new o(0,0,this.getDepth()/2*(i<0?-1:1))},getLinkExtend:function(e){var t=this.worldMatrix.clone();return t=(new mono.Mat4).extractRotation(t),this.getLinkOffset(e.applyMatrix4((new l).getInverse(t)))},computeData:function(){var e=w.buildCubeData(this.width,this.height,this.depth,this.segmentsW,this.segmentsH,this.segmentsD,this.wrapMode,this.offset||new o(0,0,0));return this.vertices=e.vertices,this.uvs=e.uvs,this.faces=e.faces,this.data=e,e},getSideIndexMapping:function(){return this.wrapMap?null:n.Cube.SideIndexMapping},generatePrimitiveKey:function(){return"cube_"+this.width+"_"+this.height+"_"+this.depth+"_"+this.segmentsW+"_"+this.segmentsH+"_"+this.segmentsD+"_"+(this.material instanceof n.ArrayMaterial?1:0)+"_"+this.wrapMode+"_"+this.offset.x+"_"+this.offset.y+"_ "+this.offset.z+"_"+n.Utils.toString(this.getMaterialMapping())},serialize:function(e){var t=e;this.width!==1&&t.serializeSimple("p","width",this.width,"number"),this.height!==1&&t.serializeSimple("p","height",this.height,"number"),this.depth!==1&&t.serializeSimple("p","depth",this.depth,"number"),this.widthSegemtns!==1&&t.serializeSimple("p","widthSegemtns",this.widthSegemtns,"number"),this.heightSegments!==1&&t.serializeSimple("p","heightSegments",this.heightSegments,"number"),this.depthSegments!==1&&t.serializeSimple("p","depthSegments",this.depthSegments,"number"),n.Element.serialize.call(this,t)}}),_.SideIndexMapping={right:0,left:1,top:2,bottom:3,front:4,back:5},n.Sphere=function(){var e,r,i,s,o,u,a;if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var f=arguments[0];e=f.radius,r=f.segmentsW,i=f.segmentsH,s=f.longitudeStart,o=f.longitudeLength,u=f.latitudeStart,this._id=f.id}else arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4],o=arguments[5],u=arguments[6],a=arguments[7]):(e=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3],o=arguments[4],u=arguments[5],a=arguments[6]);this.radius=e||50,this.segmentsW=Math.max(3,Math.floor(r)||22),this.segmentsH=Math.max(2,Math.floor(i)||15),this.longitudeStart=s!==t?s:0,this.longitudeLength=o!==t?o:Math.PI*2,this.latitudeStart=u!==t?u:0,this.latitudeLength=a!==t?a:Math.PI,this.materialSize=1,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Sphere,n.Entity,{constructor:n.Sphere,__accessor:["radius","segmentsW","segmentsH","latitudeStart","latitudeLength","longitudeStart","longitudeLength"],__SizePropeties:["radius","segmentsW","segmentsH","latitudeStart","latitudeLength","longitudeStart","longitudeLength"],className:"TGL.Sphere",computeData:function(){var e=w.bsd(this.radius,this.segmentsW,this.segmentsH,this.longitudeStart,this.longitudeLength,this.latitudeStart,this.latitudeLength);return this.vertices=e.vertices,this.uvs=e.uvs,this.faces=e.faces,this.data=e,e},setWidthSegments:function(e){console.log("TGL.Sphere.setWidthSegments has deprecated,please use setSegmentsW"),this.setSegmentsW(e)},setHeightSegments:function(e){console.log("TGL.Sphere.setHeightSegments has deprecated,please use setSegmentsW"),this.setSegmentsH(e)},generatePrimitiveKey:function(){return"sphere_"+this.radius+"_"+this.segmentsW+"_"+this.segmentsH+"_"+this.longitudeStart+"_"+this.longitudeLength+"_"+this.latitudeStart+"_"+this.latitudeLength},computeBoundingSphere:function(){this.boundingSphere===null&&(this.boundingSphere=new n.BoundingSphere(new n.XiangliangThree,this.radius))},getLinkOffset:function(e){var t=e.length();return e.normalize(),e.multiplyScalar(this.radius)},serialize:function(e){var t=e;this.radius!==50&&t.serializeSimple(Wr,"radius",this.radius,"number"),this.widthSegments!==24&&t.serializeSimple(Wr,"widthSegments",this.widthSegments,"number"),this.heightSegments!==18&&t.serializeSimple(Wr,"heightSegments",this.heightSegments,"number"),this.phiStart!==0&&t.serializeSimple(Wr,"phiStart",this.phiStart,"number"),this.phiLength!==Math.PI*2&&t.serializeSimple(Wr,"phiLength",this.phiLength,"number"),this.thetaStart!==0&&t.serializeSimple(Wr,"thetaStart",this.thetaStart,"number"),this.thetaLength!==Math.PI&&t.serializeSimple(Wr,"thetaLength",this.thetaLength,"number")}}),n.Plane=function(){var e,t,r,i,s;arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3]),this.width=e||5,this.height=t||5,this.segmentsW=r||1,this.segmentsH=i||1,this.vertices=[],this.faces=[],this.uvs=[],this.uv2s=[],this.materialSize=1,this.computeData=function(){var e,t,r=this.width/2,i=this.height/2,s=this.segmentsW,o=this.segmentsH,u=s+1,a=o+1,f=this.width/s,l=this.height/o,c=new n.XiangliangThree(0,0,1),h={vertices:[],faces:[],uvs:[]};for(t=0;t<a;t++)for(e=0;e<u;e++){var p=e*f-r,d=t*l-i;h.vertices.push(new n.XiangliangThree(p,-d,0))}for(t=0;t<o;t++)for(e=0;e<s;e++){var v=e+u*t,m=e+u*(t+1),g=e+1+u*(t+1),y=e+1+u*t,b=new n.XiangliangTwo(e/s,1-t/o),w=new n.XiangliangTwo(e/s,1-(t+1)/o),E=new n.XiangliangTwo((e+1)/s,1-(t+1)/o),S=new n.XiangliangTwo((e+1)/s,1-t/o),x=new n.Face4(v,m,g,y);x.normal.copy(c),x.vertexNormals.push(c.clone(),c.clone(),c.clone(),c.clone()),h.faces.push(x),h.uvs.push([b,w,E,S])}return h},n.Entity.call(this),this.computeCentroids()},n.extend(n.Plane,n.Entity,{constructor:n.Plane,className:"TGL.Plane",__accessor:["width","height","segmentsW","segmentsH"],__SizePropeties:["width","height","segmentsW","segmentsH"],clone:function(){var e=new n.Plane(this.material,this.width,this.height,this.segmentsW,this.segmentsH);return this.superClass.clone.call(this,e),e},getSelectStyle:function(){var e=this.getStyle("select.style");if(e=="outline.normal"||e=="outline")e="outline.wireframe";return e}}),n.Cylinder=function(){var e,r,i,s,o,u,a,f,l;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(options=arguments[0],e=options.radiusTop,r=options.radiusBottom,i=options.height,s=options.segmentsR,o=options.segmentsH,u=options.openTop,a=options.openBottom,f=options.arcLength,l=options.arcStart,this._id=options.id):arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4],o=arguments[5],u=arguments[6],a=arguments[7],f=arguments[8],l=arguments[9]):(e=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3],o=arguments[4],u=arguments[5],a=arguments[6],f=arguments[7],l=arguments[8]),this.radiusTop=e=e!==t?e:20,this.radiusBottom=r=r!==t?r:20,this.height=i=i!==t?i:100,this.segmentsR=s=s||20,this.segmentsH=o=o||1,this.openTop=u!==t?u:!1,this.openBottom=a!=t?a:!1,this.arcLength=f!==t?f:Math.PI*2,this.arcStart=l!==t?l:0,this.materialSize=3,n.Entity.call(this),this.computeNodeData(),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Cylinder,n.Entity,{constructor:n.Cylinder,__accessor:["radiusTop","radiusBottom","height","segmentsR","segmentsH","openTop","openBottom","arcLength","arcStart"],__bool:["openTop","openBottom"],__SizePropeties:["radiusTop","radiusBottom","height","segmentsR","segmentsH","openTop","openBottom","arcLength","arcStart"],className:"TGL.Cylinder",computeData:function(){return w.bcld(this.height,this.segmentsH,this.radiusBottom,this.radiusTop,this.segmentsR,this.openTop,this.openBottom,this.arcLength,this.arcStart)},getLinkOffset:function(e){var t=e.length();e.normalize();var n=e.x,r=e.y,i=e.z,s=Math.sqrt(n*n+i*i),u=r>0?this.radiusTop:this.radiusBottom;if(Math.abs(r/s)>this.height/2/u&&t>0){var a=new o(0,this.height/2*(r>0?1:-1),0);return a}return(new o(n,0,i)).normalize().multiplyScalar((this.radiusTop+this.radiusBottom)/2)},getLinkExtend:function(e){var t=this.worldMatrix.clone();return t=(new mono.Mat4).extractRotation(t),this.getLinkOffset(e.applyMatrix4((new l).getInverse(t)))},clearLinkOrthogonal:function(e,t,n,r){r=r||0;var i=this.getHeight()/2+r,s=(this.radiusTop+this.radiusBottom)/2+r;return n=="orthogonal.x"||n=="orthogonal.x.n"?!(Math.abs(e.y-t.y)>i||Math.abs(e.z-t.z)>s):n=="orthogonal.y"||n=="orthogonal.y.n"?!(Math.abs(e.x-t.x)>s||Math.abs(e.z-t.z)>s):n=="orthogonal.z"||n=="orthogonal.z.n"?!(Math.abs(e.y-t.y)>i||Math.abs(e.z-t.z)>s):!1},clearLinkExtend:function(e,t){return t!=="extend.x"&&t==="extend.y"&&e>this.getHeight()/2?!0:!1},getSideIndexMapping:function(){return n.Cylinder.SideIndexMapping},generatePrimitiveKey:function(){return"cylinder_"+this.height+"_"+this.segmentsH+"_"+this.radiusTop+"_"+this.radiusBottom+"_"+this.segmentsR+"_"+this.openTop+"_"+this.openBottom+"_"+this.arcLength+"_"+this.arcStart+n.Utils.toString(this.getMaterialMapping())},needComputeVertexNormal:function(){return!1}}),n.Cylinder.SideIndexMapping={side:0,top:1,bottom:2},n.Circle=function(){var e,r,i,s;arguments.length===4?(e=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3]):(this.material=arguments[0],e=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4]),this.radius=e=e||50,this.segments=r=r!==t?Math.max(3,r):8,this.thetaStart=i=i!==t?i:0,this.thetaLength=s=s!==t?s:Math.PI*2,this.materialSize=1,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new n.BoundingSphere(new n.XiangliangThree,e)},n.extend(n.Circle,n.Entity,{clone:function(){var e=new n.Circle(this.material,this.radius,this.segments,this.thetaStart,this.thetaLength);return this.constructor.superClass.clone.call(this,e),e},computeData:function(){var e=this.segments,t,r=[],i=new n.XiangliangThree,s=new n.XiangliangTwo(.5,.5),o={vertices:[],faces:[],uvs:[],uv2s:[]};o.vertices.push(i),r.push(s);for(t=0;t<=e;t++){var u=new n.XiangliangThree,a=this.thetaStart+t/e*this.thetaLength;u.x=this.radius*Math.cos(a),u.y=this.radius*Math.sin(a),o.vertices.push(u),r.push(new n.XiangliangTwo((u.x/this.radius+1)/2,(u.y/this.radius+1)/2))}var f=new n.XiangliangThree(0,0,1);for(t=1;t<=e;t++){var l=t,c=t+1,h=0;o.faces.push(new n.Face3(l,c,h,[f,f,f])),o.uvs.push([r[t],r[t+1],s])}return o}}),n.Torus=function(){var e,t,r,i,s;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(options=arguments[0],e=options.radius,t=options.tube,r=options.segmentsR,i=options.segmentsT,s=options.arc,this._id=options.id):arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4],s=arguments[5]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4]),this.materialSize=1,this.radius=e||100,this.tube=t||40,this.segmentsR=r||8,this.segmentsT=i||6,this.arc=s||Math.PI*2,n.Entity.call(this),this.computeNodeData(),this.computeCentroids()},n.extend(n.Torus,n.Entity,{__accessor:["radius","tube","segmentsR","segmentsT","arc"],__SizePropeties:["radius","tube","segmentsR","segmentsT","arc"],className:"TGL.Torus",generatePrimitiveKey:function(){return"torus_"+this.radius+"_"+this.tube+"_"+this.segmentsR+"_"+this.segmentsT+"_"+this.arc},computeData:function(){var e=new n.XiangliangThree,t=[],r=[],i={vertices:[],faces:[],uvs:[],uv2s:[]};for(var s=0;s<=this.segmentsR;s++)for(var o=0;o<=this.segmentsT;o++){var u=o/this.segmentsT*this.arc,a=s/this.segmentsR*Math.PI*2;e.x=this.radius*Math.cos(u),e.y=this.radius*Math.sin(u);var f=new n.XiangliangThree;f.x=(this.radius+this.tube*Math.cos(a))*Math.cos(u),f.y=(this.radius+this.tube*Math.cos(a))*Math.sin(u),f.z=this.tube*Math.sin(a),i.vertices.push(f),t.push(new n.XiangliangTwo(o/this.segmentsT,s/this.segmentsR)),r.push(f.clone().sub(e).normalize())}for(var s=1;s<=this.segmentsR;s++)for(var o=1;o<=this.segmentsT;o++){var l=(this.segmentsT+1)*s+o-1,c=(this.segmentsT+1)*(s-1)+o-1,h=(this.segmentsT+1)*(s-1)+o,p=(this.segmentsT+1)*s+o,d=new n.Face3(l,c,p,[r[l],r[c],r[p]]);d.normal.add(r[l]),d.normal.add(r[c]),d.normal.add(r[p]),d.normal.normalize(),i.faces.push(d),i.uvs.push([t[l].clone(),t[c].clone(),t[p].clone()]),d=new n.Face3(c,h,p,[r[c],r[h],r[p]]),d.normal.add(r[c]),d.normal.add(r[h]),d.normal.add(r[p]),d.normal.normalize(),i.faces.push(d),i.uvs.push([t[c].clone(),t[h].clone(),t[p].clone()])}return i}}),n.Arrow=function(){var e,t,r,i,s;arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4],s=arguments[5]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3],s=arguments[4]),this.materialSize=1,this.tailHeight=e||100,this.tailRadius=t||20,this.headHeight=r||20,this.headRadius=i||30,this.radiusSegments=s||30,this.computeData=function(){var o=2;this.headRadius<this.tailRadius&&(this.headRadius=this.tailRadius);var u=e+r,a=u/2,f,l,c=[],h=[],p=[],d=[];for(l=0;l<=o;l++){var v=[],m=[],g=l/o,y=g*i;for(f=0;f<=s;f++){var b=f/s,w=new n.XiangliangThree;w.x=y*Math.sin(b*Math.PI*2),w.y=-g*r+a,w.z=y*Math.cos(b*Math.PI*2),this.vertices.push(w),v.push(this.vertices.length-1),m.push(new n.XiangliangTwo(b,1-g))}c.push(v),p.push(m)}this.vertices.push(new n.XiangliangThree(0,a-r,0));for(l=0;l<=o;l++){var v=[],m=[],g=l/o,y=t;for(f=0;f<=s;f++){var b=f/s,w=new n.XiangliangThree;w.x=y*Math.sin(b*Math.PI*2),w.y=-g*e+a-r,w.z=y*Math.cos(b*Math.PI*2),this.vertices.push(w),v.push(this.vertices.length-1),m.push(new n.XiangliangTwo(b,1-g))}h.push(v),d.push(m)}this.vertices.push(new n.XiangliangThree(0,-a,0));var E=this.headRadius/u,S,x;for(f=0;f<s;f++){S=this.vertices[c[0][f]].clone(),x=this.vertices[c[0][f+1]].clone(),S.setY(Math.sqrt(S.x*S.x+S.z*S.z)*E).normalize(),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*E).normalize();for(l=0;l<o;l++){var T=c[l][f],N=c[l+1][f],C=c[l+1][f+1],k=c[l][f+1],L=S.clone(),A=S.clone(),O=x.clone(),M=x.clone(),_=p[l][f].clone(),D=p[l+1][f].clone(),P=p[l+1][f+1].clone(),H=p[l][f+1].clone();this.faces.push(new n.Face3(T,N,k,[L,A,M])),this.uvs.push([_,D,H]),this.faces.push(new n.Face3(N,C,k,[A,O,M])),this.uvs.push([D,P,H])}}for(f=0;f<s;f++){var T=c[l][f+1],N=c[l][f],C=c.length-1,L=new n.XiangliangThree(0,-1,0),A=new n.XiangliangThree(0,-1,0),O=new n.XiangliangThree(0,-1,0),_=p[l][f+1].clone(),D=p[l][f].clone(),P=new n.XiangliangTwo(D.u,1);this.faces.push(new n.Face3(T,N,C,[L,A,O])),this.uvs.push([_,D,P])}var E=0,S,x;for(f=0;f<s;f++){S=this.vertices[h[1][f]].clone(),x=this.vertices[h[1][f+1]].clone(),S.setY(Math.sqrt(S.x*S.x+S.z*S.z)*E).normalize(),x.setY(Math.sqrt(x.x*x.x+x.z*x.z)*E).normalize();for(l=0;l<o;l++){var T=h[l][f],N=h[l+1][f],C=h[l+1][f+1],k=h[l][f+1],L=S.clone(),A=S.clone(),O=x.clone(),M=x.clone(),_=p[l][f].clone(),D=p[l+1][f].clone(),P=p[l+1][f+1].clone(),H=p[l][f+1].clone();this.faces.push(new n.Face3(T,N,k,[L,A,M])),this.uvs.push([_,D,H]),this.faces.push(new n.Face3(N,C,k,[A,O,M])),this.uvs.push([D,P,H])}}for(f=0;f<s;f++){var T=h[l][f+1],N=h[l][f],C=h.length-1,L=new n.XiangliangThree(0,-1,0),A=new n.XiangliangThree(0,-1,0),O=new n.XiangliangThree(0,-1,0),_=d[l][f+1].clone(),D=d[l][f].clone(),P=new n.XiangliangTwo(D.u,1);this.faces.push(new n.Face3(T,N,C,[L,A,O])),this.uvs.push([_,D,P])}return this},n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Arrow,n.Entity,{}),n.BufferNode=function(){this.uuid=n.Math.generateUUID(),this.name="",this.attributes={},this.dynamic=!0,this.offsets=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.morphTargets=[],this.materialSize=1,this.createMaterial(),n.Node.call(this)},n.extend(n.BufferNode,n.Node,{constructor:n.BufferNode,compuateBufferData:function(){if(!this.computed){var e=this.attributes.position;e&&e.array&&(e.itemSize=3,e.numItems=e.array.length,this.verticesNeedUpdate=!0);var t=this.attributes.uv;t&&t.array&&(t.itemSize=2,t.numItems=t.array.length,this.uvsNeedUpdate=!0);var n=this.attributes.index;n&&n.array&&(this.offsets=[{index:0,start:0,count:n.array.length}]),this.computed=!0}},applyMatrix:function(e){var r,i;this.attributes.position&&(r=this.attributes.position.array),this.attributes.normal&&(i=this.attributes.normal.array),r!==t&&(e.multiplyXiangliangThreeArray(r),this.verticesNeedUpdate=!0);if(i!==t){var s=(new n.Matrix3).getNormalMatrix(e);s.multiplyXiangliangThreeArray(i),this.normalizeNormals(),this.normalsNeedUpdate=!0}},computeBizBox:function(){this.boundingBox===null&&(this.boundingBox=new n.BizBox);var e=this.attributes.position.array;if(e){var r=this.boundingBox,i,s,o;e.length>=3&&(r.min.x=r.max.x=e[0],r.min.y=r.max.y=e[1],r.min.z=r.max.z=e[2]);for(var u=3,a=e.length;u<a;u+=3)i=e[u],s=e[u+1],o=e[u+2],i<r.min.x?r.min.x=i:i>r.max.x&&(r.max.x=i),s<r.min.y?r.min.y=s:s>r.max.y&&(r.max.y=s),o<r.min.z?r.min.z=o:o>r.max.z&&(r.max.z=o)}if(e===t||e.length===0)this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)},computeBoundingSphere:function(){var e=new n.BizBox,t=new n.XiangliangThree;return function(){this.boundingSphere===null&&(this.boundingSphere=new n.BoundingSphere);var r=this.attributes.position.array;if(r){var i=this.boundingSphere.center,s=[];for(var o=0,u=r.length;o<u;o+=3)t.set(r[o],r[o+1],r[o+2]),s.push(t);e.setFromPoints(s),e.center(i);var a=0;for(var o=0,u=r.length;o<u;o+=3)t.set(r[o],r[o+1],r[o+2]),a=Math.max(a,i.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(a)}}}(),computeVertexNormals:function(){if(this.attributes.position){var e,r,i,s,o=this.attributes.position.array.length;if(this.attributes.normal===t)this.attributes.normal={itemSize:3,array:new Float32Array(o)};else for(e=0,r=this.attributes.normal.array.length;e<r;e++)this.attributes.normal.array[e]=0;var u=this.attributes.position.array,a=this.attributes.normal.array,f,l,c,h,p,d,v=new n.XiangliangThree,m=new n.XiangliangThree,g=new n.XiangliangThree,y=new n
.XiangliangThree,b=new n.XiangliangThree;if(this.attributes.index){var w=this.attributes.index.array,E=this.offsets;for(i=0,s=E.length;i<s;++i){var S=E[i].start,x=E[i].count,T=E[i].index;for(e=S,r=S+x;e<r;e+=3)f=T+w[e],l=T+w[e+1],c=T+w[e+2],h=u[f*3],p=u[f*3+1],d=u[f*3+2],v.set(h,p,d),h=u[l*3],p=u[l*3+1],d=u[l*3+2],m.set(h,p,d),h=u[c*3],p=u[c*3+1],d=u[c*3+2],g.set(h,p,d),y.subVectors(g,m),b.subVectors(v,m),y.cross(b),a[f*3]+=y.x,a[f*3+1]+=y.y,a[f*3+2]+=y.z,a[l*3]+=y.x,a[l*3+1]+=y.y,a[l*3+2]+=y.z,a[c*3]+=y.x,a[c*3+1]+=y.y,a[c*3+2]+=y.z}}else for(e=0,r=u.length;e<r;e+=9)h=u[e],p=u[e+1],d=u[e+2],v.set(h,p,d),h=u[e+3],p=u[e+4],d=u[e+5],m.set(h,p,d),h=u[e+6],p=u[e+7],d=u[e+8],g.set(h,p,d),y.subVectors(g,m),b.subVectors(v,m),y.cross(b),a[e]=y.x,a[e+1]=y.y,a[e+2]=y.z,a[e+3]=y.x,a[e+4]=y.y,a[e+5]=y.z,a[e+6]=y.x,a[e+7]=y.y,a[e+8]=y.z;this.normalizeNormals(),this.normalsNeedUpdate=!0}},normalizeNormals:function(){var e=this.attributes.normal.array,t,n,r,i;for(var s=0,o=e.length;s<o;s+=3)t=e[s],n=e[s+1],r=e[s+2],i=1/Math.sqrt(t*t+n*n+r*r),e[s]*=i,e[s+1]*=i,e[s+2]*=i},computeTangents:function(){function q(e,t,n){h=r[e*3],p=r[e*3+1],d=r[e*3+2],v=r[t*3],m=r[t*3+1],g=r[t*3+2],y=r[n*3],b=r[n*3+1],w=r[n*3+2],E=s[e*2],S=s[e*2+1],x=s[t*2],T=s[t*2+1],N=s[n*2],C=s[n*2+1],k=v-h,L=y-h,A=m-p,O=b-p,M=g-d,_=w-d,D=x-E,P=N-E,H=T-S,B=C-S,j=1/(D*B-P*H),F.set((B*k-H*L)*j,(B*A-H*O)*j,(B*M-H*_)*j),I.set((D*L-P*k)*j,(D*O-P*A)*j,(D*_-P*M)*j),f[e].add(F),f[t].add(F),f[n].add(F),l[e].add(I),l[t].add(I),l[n].add(I)}function st(e){et.x=i[e*3],et.y=i[e*3+1],et.z=i[e*3+2],tt.copy(et),rt=f[e],Y.copy(rt),Y.sub(et.multiplyScalar(et.dot(rt))).normalize(),Z.crossVectors(tt,rt),it=Z.dot(l[e]),nt=it<0?-1:1,a[e*4]=Y.x,a[e*4+1]=Y.y,a[e*4+2]=Y.z,a[e*4+3]=nt}if(this.attributes.index===t||this.attributes.position===t||this.attributes.normal===t||this.attributes.uv===t){console.warn("Missing required attributes (index, position, normal or uv) in BufferNode.computeTangents()");return}var e=this.attributes.index.array,r=this.attributes.position.array,i=this.attributes.normal.array,s=this.attributes.uv.array,o=r.length/3;if(this.attributes.tangent===t){var u=4*o;this.attributes.tangent={itemSize:4,array:new Float32Array(u)}}var a=this.attributes.tangent.array,f=[],l=[];for(var c=0;c<o;c++)f[c]=new n.XiangliangThree,l[c]=new n.XiangliangThree;var h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F=new n.XiangliangThree,I=new n.XiangliangThree,R,U,z,W,X,V,$,J=this.offsets;for(z=0,W=J.length;z<W;++z){var K=J[z].start,Q=J[z].count,G=J[z].index;for(R=K,U=K+Q;R<U;R+=3)X=G+e[R],V=G+e[R+1],$=G+e[R+2],q(X,V,$)}var Y=new n.XiangliangThree,Z=new n.XiangliangThree,et=new n.XiangliangThree,tt=new n.XiangliangThree,nt,rt,it;for(z=0,W=J.length;z<W;++z){var K=J[z].start,Q=J[z].count,G=J[z].index;for(R=K,U=K+Q;R<U;R+=3)X=G+e[R],V=G+e[R+1],$=G+e[R+2],st(X),st(V),st($)}this.hasTangents=!0,this.tangentsNeedUpdate=!0},clone:function(){var e=new n.BufferNode,t=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];for(var r in this.attributes){var i=this.attributes[r],s=i.array,o={itemSize:i.itemSize,numItems:i.numItems,array:null};for(var u=0,a=t.length;u<a;u++){var f=t[u];if(s instanceof f){o.array=new f(s);break}}e.attributes[r]=o}for(var u=0,a=this.offsets.length;u<a;u++){var l=this.offsets[u];e.offsets.push({start:l.start,index:l.index,count:l.count})}return e},dispose:function(){this.dispatchEvent({type:"dispose"})}}),n.Particle=function(e,t){var r;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])&&(r=arguments[0],this._id=r.id),n.Node.call(this,this._id),this.material=new n.ParticleMaterial({color:Math.random()*16777215}),this.sortParticles=!1,this.frustumCulled=!1,this.vertices=(r?r.vertices:e)||[],this.colors=(r?r.colors:t)||[]},n.extend(n.Particle,n.Node,{clone:function(e){return e===t&&(e=new n.Particle(this.material)),e.sortParticles=this.sortParticles,e.frustumCulled=this.frustumCulled,n.Element.prototype.clone.call(this,e),e},needUpdate:function(){return!1},setUpdateFlags:function(e){this.verticesNeedUpdate=e},setMaterialStyle:function(e,t){e=e.substr(e.indexOf(".")+1),this._A97(this.material,e,t)}}),n.Line=function(){var e,r,i;if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var s=arguments[0];e=s.vertices,r=s.colors,i=s.type,this._id=s.id||this._id}else e=arguments[0],r=arguments[1],i=arguments[2];n.Node.call(this,this._id),this.material=new n.LineMaterial({color:16777215}),this.type=i!==t?i:n.LineStrip,this.vertices=e||[],this.colors=r||[]},n.LineStrip=0,n.LinePieces=1,n.extend(n.Line,n.Node,{className:"TGL.Line",__accessor:["vertices","type"],__SizePropeties:["vertices","type"],clone:function(e){return e===t&&(e=new n.Line(this.material,this.type)),n.Element.prototype.clone.call(this,e,!0),e},onPropertyChange:function(){},setMaterialStyle:function(e,t){e=e.substr(e.indexOf(".")+1),this._A97(this.material,e,t)},setMaterialStyles:function(e){n.Element.prototype.setMaterialStyles.call(this,e)}}),n.Line.createEllipse=function(e,t,r,i,s,o,u){typeof e=="number"?(u=o,o=s,s=i,i=r,r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);var a=new n.EllipseCurve(0,0,t,r,s,o,u),f=[],l=i||50;for(var c=0;c<=l;c++){var h=a.getPoint(c/l);f.push(h)}return e.setVertices(f),e},n.Line.createHelix=function(e,t,r,i,s,u){typeof e=="number"?(u=s,s=i,i=r,r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);var a=[],f=u||50;s=s||1;var l,c,h,p;for(var d=0;d<=f;d++)l=(r*d+t*(f-d))/f,h=s*Math.PI*2*d/f,c=i*(.5-d/f),p=new o(l*Math.sin(h),c,l*Math.cos(h)),a.push(p);return e.setVertices(a),e},n.Line.createRectangle=function(e,t,r,i){typeof e=="number"?(i=r,r=t,t=e,e=new n.Line):e==null&&(e=new n.Line);var s=i||50,u=(t+r)*2/s,a=[];if(u>Math.min(t,r))a.push(new o(-t/2,-r/2,0)),a.push(new o(-t/2,r/2,0)),a.push(new o(t/2,r/2,0)),a.push(new o(t/2,-r/2,0)),a.push(new o(-t/2,-r/2,0));else{var f=-t/2,l=-r/2,c;for(var h=0;h<=s;h++)f==-t/2&&l<r/2?l+u<=r/2?l+=u:(a.push(new o(-t/2,r/2,0)),a.push(new o(-t/2,r/2,0)),f+=l+u-r/2,l=r/2):l==r/2&&f<=t/2?f+u<=t/2?f+=u:(a.push(new o(t/2,r/2,0)),a.push(new o(t/2,r/2,0)),l-=f+u-t/2,f=t/2):f==t/2&&l>-r/2?l-u>=-r/2?l-=u:(a.push(new o(t/2,-r/2,0)),a.push(new o(t/2,-r/2,0)),f-=-r/2-l+u,l=-r/2):l==-r/2&&f>=-t/2&&(f-u>=-t/2?f-=u:(l+=-t/2-f+u,f=-t/2)),c=new o(f,l,0),a.push(c)}return e.setVertices(a),e},n.Polyhedron=function(){function w(e){var t=e.normalize().clone();t.index=s.vertices.push(t)-1;var r=x(e)/2/Math.PI+.5,i=T(e)/Math.PI+.5;return t.uv=new n.XiangliangThree(r,1-i),t}function E(e,t,r){var i=new n.Face3(e.index,t.index,r.index,[e.clone(),t.clone(),r.clone()]);i.centroid.add(e).add(t).add(r).divideScalar(3),s.faces.push(i);var o=x(i.centroid);s.uvs.push([N(e.uv,e,o),N(t.uv,t,o),N(r.uv,r,o)])}function S(e,t){var n=Math.pow(2,t),r=Math.pow(4,t),i=w(s.vertices[e.a]),o=w(s.vertices[e.b]),u=w(s.vertices[e.c]),a=[];for(var f=0;f<=n;f++){a[f]=[];var l=w(i.clone().lerp(u,f/n)),c=w(o.clone().lerp(u,f/n)),h=n-f;for(var p=0;p<=h;p++)p==0&&f==n?a[f][p]=l:a[f][p]=w(l.clone().lerp(c,p/h))}for(var f=0;f<n;f++)for(var p=0;p<2*(n-f)-1;p++){var d=Math.floor(p/2);p%2==0?E(a[f][d+1],a[f+1][d],a[f][d]):E(a[f][d+1],a[f+1][d+1],a[f+1][d])}}function x(e){return Math.atan2(e.z,-e.x)}function T(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}function N(e,t,r){return r<0&&e.x===1&&(e=new n.XiangliangThree(e.x-1,e.y)),t.x===0&&t.z===0&&(e=new n.XiangliangThree(r/2/Math.PI+.5,e.y)),e.clone()}var e,t,r,i;arguments[0]instanceof n.Material?(this.material=arguments[0],e=arguments[1],t=arguments[2],r=arguments[3],i=arguments[4]):(e=arguments[0],t=arguments[1],r=arguments[2],i=arguments[3]),this.materialSize=1,n.Entity.call(this),r=r||1,i=i||0;var s=this;for(var o=0,u=e.length;o<u;o++)w(new n.XiangliangThree(e[o][0],e[o][1],e[o][2]));var a=[],f=this.vertices,l=[];for(var o=0,u=t.length;o<u;o++){var c=f[t[o][0]],h=f[t[o][1]],p=f[t[o][2]];l[o]=new n.Face3(c.index,h.index,p.index,[c.clone(),h.clone(),p.clone()])}for(var o=0,u=l.length;o<u;o++)S(l[o],i);for(var o=0,u=this.uvs.length;o<u;o++){var d=this.uvs[o],v=d[0].x,m=d[1].x,g=d[2].x,y=Math.max(v,Math.max(m,g)),b=Math.min(v,Math.min(m,g));y>.9&&b<.1&&(v<.2&&(d[0].x+=1),m<.2&&(d[1].x+=1),g<.2&&(d[2].x+=1))}for(var o=0,u=this.vertices.length;o<u;o++)this.vertices[o].multiplyScalar(r);this.mergeVertices(),this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new n.BoundingSphere(new n.XiangliangThree,r)},n.extend(n.Polyhedron,n.Entity,{}),n.Octahedron=function(e,t,r){var i=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],s=[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]];n.Polyhedron.call(this,e,i,s,t,r)},n.extend(n.Octahedron,n.Polyhedron,{clone:function(){return new n.Octahedron(this.material,this.radius,this.detail)}}),n.Axis=function(e){e=e||1;var t=[],r=[];t.push(new n.XiangliangThree,new n.XiangliangThree(e,0,0),new n.XiangliangThree,new n.XiangliangThree(0,e,0),new n.XiangliangThree,new n.XiangliangThree(0,0,e)),r.push(new n.Color(16711680),new n.Color(16711680),new n.Color(65280),new n.Color(65280),new n.Color(255),new n.Color(255));var i=new n.LineMaterial({vertexColors:n.VertexColors,depthTest:!1,depthMask:!1});n.Line.call(this,t,r,n.LinePieces),this.material=i,this.xAxisText=this.makeAxisText("X",16711680),this.yAxisText=this.makeAxisText("Y",65280),this.zAxisText=this.makeAxisText("Z",255),this.xAxisText.setParent(this),this.yAxisText.setParent(this),this.zAxisText.setParent(this),this.setSize(e),this._sizeFixed=!0},n.extend(n.Axis,n.Line,{showAxisText:function(e){this.xAxisText._visible=e,this.yAxisText._visible=e,this.zAxisText._visible=e},setSize:function(e){this.vertices[1].x=e,this.vertices[3].y=e,this.vertices[5].z=e,this.xAxisText.setPosition(e,0,0),this.yAxisText.setPosition(0,e,0),this.zAxisText.setPosition(0,0,e)},fixSize:function(e){n.Element.prototype.fixSize.call(this,e);var t=this._scale.x,r=this._scale.y,i=this._scale.z;this.xAxisText.setScale(3,3,1),this.yAxisText.setScale(3,3,1),this.zAxisText.setScale(3,3,1)},makeAxisText:function(e,t){var r="Arial",i=36,s=n.BillboardAlignment.topLeft,o=document.createElement("canvas"),u=o.getContext("2d");u.font="Bold "+i+"px "+r,t instanceof n.Color||(t=new n.Color(t));var a=u.measureText(e),f=a.width;o.width=f,o.height=u.measureText("e").width*2+4,u.fillStyle="rgba("+t.r*255+", "+t.g*255+", "+t.b*255+", 1.0)",u.fillText(e,0,10);var l=new n.Texture(o),c=new n.BillboardMaterial({map:l,useScreenCoordinates:!1,alignment:s,depthTest:!1,depthMask:!1}),h=new n.Billboard;return h.material=c,h}}),n.Curve=function(){},n.Curve.prototype.getPoint=function(e){return console.log("Warning, getPoint() not implemented!"),null},n.Curve.prototype.getPointAt=function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},n.Curve.prototype.getPoints=function(e){e||(e=5);var t,n=[];for(t=0;t<=e;t++)n.push(this.getPoint(t/e));return n},n.Curve.prototype.getSpacedPoints=function(e){e||(e=5);var t,n=[];for(t=0;t<=e;t++)n.push(this.getPointAt(t/e));return n},n.Curve.prototype.getLength=function(){var e=this.getLengths();return e[e.length-1]},n.Curve.prototype.getLengths=function(e){e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200);if(this.cacheArcLengths&&this.cacheArcLengths.length==e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t=[],n,r=this.getPoint(0),i,s=0;t.push(0);for(i=1;i<=e;i++)n=this.getPoint(i/e),s+=n.distanceTo(r),t.push(s),r=n;return this.cacheArcLengths=t,t},n.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0,this.getLengths()},n.Curve.prototype.getUtoTmapping=function(e,t){var n=this.getLengths(),r=0,i=n.length,s;t?s=t:s=e*n[i-1];var o=0,u=i-1,a;while(o<=u){r=Math.floor(o+(u-o)/2),a=n[r]-s;if(a<0){o=r+1;continue}if(a>0){u=r-1;continue}u=r;break}r=u;if(n[r]==s){var f=r/(i-1);return f}var l=n[r],c=n[r+1],h=c-l,p=(s-l)/h,f=(r+p)/(i-1);return f},n.Curve.prototype.getTangent=function(e){var t=1e-4,n=e-t,r=e+t;n<0&&(n=0),r>1&&(r=1);var i=this.getPoint(n),s=this.getPoint(r),o=s.clone().sub(i);return o.normalize()},n.Curve.prototype.getTangentAt=function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},n.Curve.Utils={tangentQuadraticBezier:function(e,t,n,r){return 2*(1-e)*(n-t)+2*e*(r-n)},tangentCubicBezier:function(e,t,n,r,i){return-3*t*(1-e)*(1-e)+3*n*(1-e)*(1-e)-6*e*n*(1-e)+6*e*r*(1-e)-3*e*e*r+3*e*e*i},tangentSpline:function(e,t,n,r,i){var s=6*e*e-6*e,o=3*e*e-4*e+1,u=-6*e*e+6*e,a=3*e*e-2*e;return s+o+u+a},interpolate:function(e,t,n,r,i){var s=(n-e)*.5,o=(r-t)*.5,u=i*i,a=i*u;return(2*t-2*n+s+o)*a+(-3*t+3*n-2*s-o)*u+s*i+t}},n.Curve.create=function(e,t){return e.prototype=Object.create(n.Curve.prototype),e.prototype.getPoint=t,e},n.LineCurve=function(e,t){this.v1=e,this.v2=t},n.LineCurve.prototype=Object.create(n.Curve.prototype),n.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},n.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},n.LineCurve.prototype.getTangent=function(e){var t=this.v2.clone().sub(this.v1);return t.normalize()},n.LineCurve3=function(e,t){this.v1=e,this.v2=t,this.getPoint=function(e){var t=new n.XiangliangThree;return t.subVectors(this.v2,this.v1),t.multiplyScalar(e),t.add(this.v1),t}},n.extend(n.LineCurve3,n.Curve,{}),n.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},n.CurvePath.prototype=Object.create(n.Curve.prototype),n.CurvePath.prototype.add=function(e){this.curves.push(e)},n.CurvePath.prototype.checkConnection=function(){},n.CurvePath.prototype.closePath=function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new n.LineCurve3(t,e))},n.CurvePath.prototype.getPoint=function(e){var t=e*this.getLength(),n=this.getCurveLengths(),r=0,i,s;while(r<n.length){if(n[r]>=t){i=n[r]-t,s=this.curves[r];var o=1-i/s.getLength();return s.getPointAt(o)}r++}return null},n.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},n.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e=[],t=0,n,r=this.curves.length;for(n=0;n<r;n++)t+=this.curves[n].getLength(),e.push(t);return this.cacheLengths=e,e},n.CurvePath.prototype.getBizBox=function(){var e=this.getPoints(),t,r,i,s,o,u;t=r=Number.NEGATIVE_INFINITY,s=o=Number.POSITIVE_INFINITY;var a,f,l,c,h=e[0]instanceof n.XiangliangThree;c=h?new n.XiangliangThree:new n.XiangliangTwo;for(f=0,l=e.length;f<l;f++)a=e[f],a.x>t?t=a.x:a.x<s&&(s=a.x),a.y>r?r=a.y:a.y<o&&(o=a.y),h&&(a.z>i?i=a.z:a.z<u&&(u=a.z)),c.add(a);var p={minX:s,minY:o,maxX:t,maxY:r,centroid:c.divideScalar(l)};return h&&(p.maxZ=i,p.minZ=u),p},n.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},n.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},n.CurvePath.prototype.createGeometry=function(e){var t=new n.Geometry;for(var r=0;r<e.length;r++)t.vertices.push(new n.XiangliangThree(e[r].x,e[r].y,e[r].z||0));return t},n.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},n.CurvePath.prototype.getTransformedPoints=function(e,t){var n=this.getPoints(e),r,i;t||(t=this.bends);for(r=0,i=t.length;r<i;r++)n=this.getWrapPoints(n,t[r]);return n},n.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var n=this.getSpacedPoints(e),r,i;t||(t=this.bends);for(r=0,i=t.length;r<i;r++)n=this.getWrapPoints(n,t[r]);return n},n.CurvePath.prototype.getWrapPoints=function(e,t){var n=this.getBizBox(),r,i,s,o,u,a;for(r=0,i=e.length;r<i;r++){s=e[r],o=s.x,u=s.y,a=o/n.maxX,a=t.getUtoTmapping(a,o);var f=t.getPoint(a),l=t.getTangent(a);l.set(-l.y,l.x).multiplyScalar(u),s.x=f.x+l.x,s.y=f.y+l.y}return e},n.EllipseCurve=function(e,t,n,r,i,s,o){this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=r,this.aStartAngle=i||0,this.aEndAngle=s||Math.PI*2,this.aClockwise=o},n.EllipseCurve.prototype=Object.create(n.Curve.prototype),n.EllipseCurve.prototype.getPoint=function(e){var t,r=this.aEndAngle-this.aStartAngle;r<0&&(r+=Math.PI*2),r>Math.PI*2&&(r-=Math.PI*2),this.aClockwise===!0?t=this.aEndAngle+(1-e)*(Math.PI*2-r):t=this.aStartAngle+e*r;var i=this.aX+this.xRadius*Math.cos(t),s=this.aY+this.yRadius*Math.sin(t);return new n.XiangliangThree(i,s,0)},n.ArcCurve=function(e,t,r,i,s,o){n.EllipseCurve.call(this,e,t,r,r,i,s,o)},n.ArcCurve.prototype=Object.create(n.EllipseCurve.prototype),n.Path=function(e){n.CurvePath.call(this),this.actions=[],this.points=[],e&&this.fromPoints(e)},n.extend(n.Path,n.CurvePath,{constructor:n.Path,className:"TGL.Path",serializeJsonValue:function(){return{actions:this.actions,"class":"TGL.Path"}},deserializeJsonValue:function(e){var t,n,r,i;for(i=0;i<e.actions.length;i++)n=e.actions[i],t=n.action,r=n.args,this[t].apply(this,r)}}),n.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"curveTo",BEZIER_CURVE_TO:"bCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},n.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y,e[0].z);for(var t=1,n=e.length;t<n;t++)this.lineTo(e[t].x,e[t].y,e[t].z)},n.Path.prototype.closePath=function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.lineTo(e.x,e.y,e.z)},n.Path.prototype.reverse=function(){var e=new n.Path,t,r=this.actions.length,i,s,o,u,a;for(t=r-1;t>=0;t--){s=this.actions[t].args,o=s.length,t===r-1&&e.moveTo(s[o-3],s[o-2],s[o-1]);if(u!=null)switch(a){case n.PathActions.MOVE_TO:e.moveTo(s[o-3],s[o-2],s[o-1]);break;case n.PathActions.LINE_TO:e.lineTo(s[o-3],s[o-2],s[o-1]);break;case n.PathActions.QUADRATIC_CURVE_TO:e.quadraticCurveTo(u[0],u[1],u[2],s[o-3],s[o-2],s[o-1]);break;case n.PathActions.BEZIER_CURVE_TO:e.bezierCurveTo(u[3],u[4],u[5],u[0],u[1],u[2],s[o-3],s[o-2],s[o-1])}u=s,a=this.actions[t].action}return e},n.Path.prototype.moveTo=function(e,t,r){e=e||0,t=t||0,r=r||0;var i=Array.prototype.slice.call(arguments);this.actions.push({action:n.PathActions.MOVE_TO,args:i}),this.points.push(new o(e,t,r))},n.Path.prototype.lineTo=function(e,t,r){e=e||0,t=t||0,r=r||0;if(this.actions&&this.actions.length===1){var i=this.actions[0].args;i[0]===e&&i[1]===t&&i[2]===r&&(console.log("TGL.Path:lineTo the same point of moveTo"),e+=.01)}var i=Array.prototype.slice.call(arguments),s=this.actions[this.actions.length-1].args,u=s[s.length-3],a=s[s.length-2],f=s[s.length-1],l=new n.LineCurve3(new n.XiangliangThree(u,a,f),new n.XiangliangThree(e,t,r));this.curves.push(l),this.actions.push({action:n.PathActions.LINE_TO,args:i}),this.points.push(new o(e,t,r))},n.Path.prototype.quadraticCurveTo=function(e,t,r,i,s,u){e=e||0,t=t||0,r=r||0,i=i||0,s=s||0,u=u||0;if(this.actions&&this.actions.length===1){var a=this.actions[0].args;a[0]===i&&a[1]===s&&a[2]===u&&(console.log("TGL.Path:quadraticCurveTo the same point of moveTo"),i=.01)}var a=Array.prototype.slice.call(arguments),f=this.actions[this.actions.length-1].args,l=f[f.length-3],c=f[f.length-2],h=f[f.length-1],p=new n.QuadraticBezierCurve3(new n.XiangliangThree(l,c,h),new n.XiangliangThree(e,t,r),new n.XiangliangThree(i,s,u));this.curves.push(p),this.actions.push({action:n.PathActions.QUADRATIC_CURVE_TO,args:a}),this.points.push(new o(i,s,u))},n.Path.prototype.curveTo=n.Path.prototype.quadraticCurveTo,n.Path.prototype.bezierCurveTo=function(e,t,r,i,s,u,a,f,l){var c=Array.prototype.slice.call(arguments),h=this.actions[this.actions.length-1].args,p=h[h.length-3],d=h[h.length-2],v=h[h.length-1],m=new n.CubicBezierCurve3(new n.XiangliangThree(p,d,v),new n.XiangliangThree(e,t,r),new n.XiangliangThree(i,s,u),new n.XiangliangThree(a,f,l));this.curves.push(m),this.actions.push({action:n.PathActions.BEZIER_CURVE_TO,args:c}),this.points.push(new o(a,f,l))},n.Path.prototype.isClockwise=function(){if(this.points.length<2)return t;if(this.points.length<3){var e=this.points[0],r=this.points[1];return r.x>e.x}return n.Math.isClockwise(this.points)},n.Path.prototype.bCurveTo=n.Path.prototype.bezierCurveTo,n.Path.prototype.splineThru=function(e){var t=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,i=r[r.length-2],s=r[r.length-1],o=[new n.XiangliangTwo(i,s)];Array.prototype.push.apply(o,e);var u=new n.SplineCurve(o);this.curves.push(u),this.actions.push({action:n.PathActions.CSPLINE_THRU,args:t})},n.Path.prototype.arc=function(e,t,n,r,i,s){var o=this.actions[this.actions.length-1].args,u=o[o.length-2],a=o[o.length-1];this.absarc(e+u,t+a,n,r,i,s)},n.Path.prototype.absarc=function(e,t,n,r,i,s){this.absellipse(e,t,n,n,r,i,s)},n.Path.prototype.ellipse=function(e,t,n,r,i,s,o){var u=this.actions[this.actions.length-1].args,a=u[u.length-2],f=u[u.length-1];this.absellipse(e+a,t+f,n,r,i,s,o)},n.Path.prototype.absellipse=function(e,t,r,i,s,o,u){var a=Array.prototype.slice.call(arguments),f=new n.EllipseCurve(e,t,r,i,s,o,u);this.curves.push(f);var l=f.getPoint(1);a.push(l.x),a.push(l.y),this.actions.push({action:n.PathActions.ELLIPSE,args:a})},n.Path.prototype.toArray=function(){var e,t=this.actions.length,n=[];for(e=0;e<t;e++){var r=this.actions[e];r.action==="moveTo"?(n.push("m"),n.push(r.args[0]),n.push(r.args[1]),n.push(r.args[2])):r.action==="lineTo"?(n.push("l"),n.push(r.args[0]),n.push(r.args[1]),n.push(r.args[2])):r.action==="curveTo"&&(n.push("c"),n.push(r.args[0]),n.push(r.args[1]),n.push(r.args[2]),n.push(r.args[3]),n.push(r.args[4]),n.push(r.args[5]))}return n},n.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);var n=[];for(var r=0;r<e;r++)n.push(this.getPoint(r/e));return n},n.Path.prototype.getPoints=function(e,t){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(e,t);e=e||12;var r=[],i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N;for(i=0,s=this.actions.length;i<s;i++){o=this.actions[i],u=o.action,a=o.args;switch(u){case n.PathActions.MOVE_TO:r.push(new n.XiangliangThree(a[0],a[1],a[2]));break;case n.PathActions.LINE_TO:r.push(new n.XiangliangThree(a[0],a[1],a[2]));break;case n.PathActions.QUADRATIC_CURVE_TO:f=a[3],l=a[4],c=a[5],v=a[0],m=a[1],g=a[2],r.length>0?(E=r[r.length-1],y=E.x,b=E.y,w=E.z):(E=this.actions[i-1].args,y=E[E.length-3],b=E[E.length-2],w=E[E.length-1]);for(S=1;S<=e;S++)x=S/e,T=n.Shape.Utils.b2(x,y,v,f),N=n.Shape.Utils.b2(x,b,m,l),tz=n.Shape.Utils.b2(x,w,g,c),r.push(new n.XiangliangThree(T,N,tz));break;case n.PathActions.BEZIER_CURVE_TO:f=a[6],l=a[7],c=a[8],v=a[0],m=a[1],g=a[2],h=a[3],p=a[4],d=a[5],r.length>0?(E=r[r.length-1],y=E.x,b=E.y,w=E.z):(E=this.actions[i-1].args,y=E[E.length-3],b=E[E.length-2],w=E[E.length-1]);for(S=1;S<=e;S++)x=S/e,T=n.Shape.Utils.b3(x,y,v,h,f),N=n.Shape.Utils.b3(x,b,m,p,l),tz=n.Shape.Utils.b3(x,w,g,d,c),r.push(new n.XiangliangThree(T,N,tz));break;case n.PathActions.CSPLINE_THRU:E=this.actions[i-1].args;var C=new n.XiangliangTwo(E[E.length-2],E[E.length-1]),k=[C],L=e*a[0].length;k=k.concat(a[0]);var A=new n.SplineCurve(k);for(S=1;S<=L;S++)r.push(A.getPointAt(S/L));break;case n.PathActions.ARC:var O=a[0],M=a[1],_=a[2],D=a[3],P=a[4],H=!!a[5],B=P-D,j,F=e*2;for(S=1;S<=F;S++)x=S/F,H||(x=1-x),j=D+x*B,T=O+_*Math.cos(j),N=M+_*Math.sin(j),r.push(new n.XiangliangThree(T,N));break;case n.PathActions.ELLIPSE:var O=a[0],M=a[1],I=a[2],q=a[3],D=a[4],P=a[5],H=!!a[6],B=P-D,j,F=e*2;for(S=1;S<=F;S++)x=S/F,H||(x=1-x),j=D+x*B,T=O+I*Math.cos(j),N=M+q*Math.sin(j),r.push(new n.XiangliangThree(T,N))}}var R=r[r.length-1],U=1e-10;return Math.abs(R.x-r[0].x)<U&&Math.abs(R.y-r[0].y)<U&&r.splice(r.length-1,1),t&&r.push(r[0]),r},n.Path.prototype.toShapes=function(e){var r,i,s,o,u,a=[],f=new n.Path;for(r=0,i=this.actions.length;r<i;r++)s=this.actions[r],u=s.args,o=s.action,o==n.PathActions.MOVE_TO&&f.actions.length!=0&&(a.push(f),f=new n.Path),f[o].apply(f,u);f.actions.length!=0&&a.push(f);if(a.length==0)return[];var l,c,h,p=[];if(a.length==1)return c=a[0],h=new n.Shape,h.actions=c.actions,h.curves=c.curves,p.push(h),p;var d=!n.Shape.Utils.isClockWise(a[0].getPoints());d=e?!d:d;if(d){h=new n.Shape;for(r=0,i=a.length;r<i;r++)c=a[r],l=n.Shape.Utils.isClockWise(c.getPoints()),l=e?!l:l,l?(h.actions=c.actions,h.curves=c.curves,p.push(h),h=new n.Shape):h.holes.push(c)}else{h=t;for(r=0,i=a.length;r<i;r++)c=a[r],l=n.Shape.Utils.isClockWise(c.getPoints()),l=e?!l:l,l?(h&&p.push(h),h=new n.Shape,h.actions=c.actions,h.curves=c.curves):h.holes.push(c);p.push(h)}return p},n.Shape=function(){n.Path.apply(this,arguments),this.holes=[]},n.Shape.prototype=Object.create(n.Path.prototype),n.Shape.prototype.extrude=function(e){var t=new n.ShapeNode(this,e);return t},n.Shape.prototype.makeGeometry=function(e){var t=new n.ShapeGeometry(this,e);return t},n.Shape.prototype.getPointsHoles=function(e){var t,n=this.holes.length,r=[];for(t=0;t<n;t++)r[t]=this.holes[t].getTransformedPoints(e,this.bends);return r},n.Shape.prototype.getSpacedPointsHoles=function(e){var t,n=this.holes.length,r=[];for(t=0;t<n;t++)r[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return r},n.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},n.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},n.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},n.Shape.Utils={removeHoles:function(e,t){var r=e.concat(),i=r.concat(),s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N=[];for(p=0;p<t.length;p++){v=t[p],Array.prototype.push.apply(i,v),m=Number.POSITIVE_INFINITY;for(d=0;d<v.length;d++){b=v[d];var C=[];for(y=0;y<r.length;y++)w=r[y],g=b.distanceToSquared(w),C.push(g),g<m&&(m=g,f=d,l=y)}s=l-1>=0?l-1:r.length-1,u=f-1>=0?f-1:v.length-1;var k=[v[f],r[l],r[s]],L=n.FontUtils.Triangulate.area(k),A=[v[f],v[u],r[l]],O=n.FontUtils.Triangulate.area(A),M=1,_=-1,D=l,P=f;l+=M,f+=_,l<0&&(l+=r.length),l%=r.length,f<0&&(f+=v.length),f%=v.length,s=l-1>=0?l-1:r.length-1,u=f-1>=0?f-1:v.length-1,k=[v[f],r[l],r[s]];var H=n.FontUtils.Triangulate.area(k);A=[v[f],v[u],r[l]];var B=n.FontUtils.Triangulate.area(A);L+O>H+B&&(l=D,f=P,l<0&&(l+=r.length),l%=r.length,f<0&&(f+=v.length),f%=v.length,s=l-1>=0?l-1:r.length-1,u=f-1>=0?f-1:v.length-1),E=r.slice(0,l),S=r.slice(l),x=v.slice(f),T=v.slice(0,f);var j=[v[f],r[l],r[s]],F=[v[f],v[u],r[l]];N.push(j),N.push(F),r=E.concat(x).concat(T).concat(S)}return{shape:r,isolatedPts:N,allpoints:i}},triangulateShape:function(e,r){var i=n.Shape.Utils.removeHoles(e,r),s=i.shape,o=i.allpoints,u=i.isolatedPts,a=n.FontUtils.Triangulate(s,!1),f,l,c,h,p,d,v={},m={};for(f=0,l=o.length;f<l;f++)p=o[f].x+":"+o[f].y,v[p]!==t&&console.log("Duplicate point",p),v[p]=f;for(f=0,l=a.length;f<l;f++){h=a[f];for(c=0;c<3;c++)p=h[c].x+":"+h[c].y,d=v[p],d!==t&&(h[c]=d)}for(f=0,l=u.length;f<l;f++){h=u[f];for(c=0;c<3;c++)p=h[c].x+":"+h[c].y,d=v[p],d!==t&&(h[c]=d)}return a.concat(u)},isClockWise:function(e){return n.FontUtils.Triangulate.area(e)<0},b2p0:function(e,t){var n=1-e;return n*n*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,n,r){return this.b2p0(e,t)+this.b2p1(e,n)+this.b2p2(e,r)},b3p0:function(e,t){var n=1-e;return n*n*n*t},b3p1:function(e,t){var n=1-e;return 3*n*n*e*t},b3p2:function(e,t){var n=1-e;return 3*n*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,n,r,i){return this.b3p0(e,t)+this.b3p1(e,n)+this.b3p2(e,r)+this.b3p3(e,i)}},n.CubicBezierCurve3=n.Curve.create(function(e,t,n,r){this.v0=e,this.v1=t,this.v2=n,this.v3=r},function(e){var t,r,i;return t=n.Shape.Utils.b3(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),r=n.Shape.Utils.b3(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),i=n.Shape.Utils.b3(e,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new n.XiangliangThree(t,r,i)}),n.QuadraticBezierCurve3=n.Curve.create(function(e,t,n){this.v0=e,this.v1=t,this.v2=n},function(e){var t,r,i;return t=n.Shape.Utils.b2(e,this.v0.x,this.v1.x,this.v2.x),r=n.Shape.Utils.b2(e,this.v0.y,this.v1.y,this.v2.y),i=n.Shape.Utils.b2(e,this.v0.z,this.v1.z,this.v2.z),new n.XiangliangThree(t,r,i)}),n.PathNode=function(e,r,i,s,o,u,a,f,l,c){this.materialSize=1,this.closed=!1;var h;arguments.length===1&&arguments[0]instanceof Object&&!(arguments[0]instanceof n.Path)?(h=arguments[0],this.path=h.path,this.segments=h.segments||20,this.radius=h.radius||1,this.segmentsR=h.segmentsR||8,this.shape=h.shape,this.startCap=h.startCap||"plain",this.endCap=h.endCap||"plain",this.arc=h.arc!=t?h.arc:Math.PI*2,this.arcStart=h.arcStart!=t?h.arcStart:0,this.cutSurface=h.cutSurface||"none",this.startCapR=h.startCapR,this.endCapR=h.endCapR,this.startCapSize=h.startCapSize,this.endCapSize=h.endCapSize,this.startCapExtend=h.startCapExtend===t?1:h.startCapExtend,this.endCapExtend=h.endCapExtend===t?1:h.endCapExtend,this._id=h.id):(this.path=e,this.segments=r||20,this.radius=i||1,this.segmentsR=s||8,this.shape=a,this.startCap=o||"plain",this.endCap=u||"plain",this.arc=f!=t?f:Math.PI*2,this.arcStart=l!=t?l:0,this.cutSurface=c||"none"),this.startCapSize=this.startCapSize||1,this.endCapSize=this.endCapSize||1,this.segmentsCap=20,this.arc===Math.PI*2&&(this.cutSurface="none"),n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.PathNode,n.Entity,{constructor:n.PathNode,className:"TGL.PathNode",__accessor:["path","segments","radius","segmentsR","startCap","endCap","shape","startCapSize","endCapSize","segmentsCap","arc","arcStart","cutSurface","startCapR","endCapR","startCapExtend","endCapExtend"],__SizePropeties:["path","segments","radius","segmentsR","startCap","endCap","shape","startCapSize","endCapSize","segmentsCap","arc","arcStart","cutSurface","startCapR","endCapR","startCapExtend","endCapExtend"],getCrossSectionPoint:function(){},adjustPath:function(e,t,r){t=t||this.radius,r=r||1;var i=new n.Path,s,u,a,f,l,c,h,p,d,v=new o,m=new o,g,y=new o,b=new o,w,E,S=e.actions.length;for(E=0;E<S;E++)a=e.actions[E],l=E+1===S?null:e.actions[E+1],f=a.args,a.action==="moveTo"?i.moveTo(f[0],f[1],f[2]):a.action==="lineTo"?l&&l.action==="lineTo"?(s=e.actions[E-1],u=s.args,c=l.args,h=new o(u[0],u[1],u[2]),p=new o(f[0],f[1],f[2]),d=new o(c[0],c[1],c[2]),v.subVectors(p,h),m.subVectors(p,d),g=v.angleTo(m),w=Math.min(v.length()/2,m.length()/2),w=Math.min(t*r,w),y.addVectors(p,v.normalize().multiplyScalar(-w)),b.addVectors(p,m.normalize().multiplyScalar(-w)),i.lineTo(y.x,y.y,y.z),i.curveTo(p.x,p.y,p.z,b.x,b.y,b.z)):i.lineTo(f[0],f[1],f[2]):a.action==="quadraticCurveTo"&&i.curveTo(f[0],f[1],f[2],f[3],f[4],f[5]);return i},_resetPath:function(){return this.path},getPointAt:function(e){return this._realPath?this._realPath.getPoint(e):null},getTangentAt:function(e){if(this._realPath){var t=this._realPath.getPoint(e),n=this._realPath.getPoint(e-.001);return t.sub(n).normalize()}return null},computeData:function(){function Y(e,t,r,i){return i.vertices.push(new n.XiangliangThree(e,t,r))-1}this.grid=[],this.startGrid=[],this.endGrid=[];var e=this.segmentsCap,t=this,r,i,o,u,a,f,l,c,h,p,d,v,m,g,y=new n.XiangliangThree,b,w,E,S,x,T,N,C,k,L,A,O,M={};M.faces=[],M.uvs=[],M.vertices=[];if(this.path==null)return M;var _=this._resetPath(),D=this.startCap,P=this.endCap,H=this.cutSurface;this._realPath=_,this._autoAjust==1&&(_=this.adjustPath(_));var B=_.curves.length,j=_.curves,F=[],I,q=_.getLength(),N,R,U=0,z=this.segments,w;for(b=0;b<B;b++){N=j[b],R=N.getLength();if(N instanceof n.LineCurve3){var W=(R*.001+U)/q,X=(R*.999+U)/q;F.push(W),F.push(X)}else{var V=R*.998;for(w=0;w<=z;w++){var $=(R*.001+V*w/z+U)/q;F.push($)}}U+=R}var J=this.frenetFrames(_,F,this.closed),K=J.tangents,Q=J.normals,G=J.binormals;this.tangents=K,this.normals=Q,this.binormals=G;var Z=0,et,tt=F.length-1,nt=tt+1,rt=0,it=0;for(b=0;b<nt;b++){this.grid[b]=[],p=F[b],g=_.getPointAt(p),r=K[b],i=Q[b],o=G[b];if(D!=="none"&&b===0)if(D==="round"||D==="arrow"){var st,ot;rt+=this.radius*this.startCapSize;var ut=g.clone().add(r.clone().multiplyScalar(-this.radius*this.startCapSize));for(var at=0;at<=e;at++){this.startGrid[at]=[];var ft=at/e*Math.PI/2;D==="round"?st=ut.clone().add(r.clone().multiplyScalar(this.radius*this.startCapSize*(1-Math.cos(ft)))):st=ut.clone().add(r.clone().multiplyScalar(this.radius*this.startCapSize*at/e));for(var w=0;w<this.segmentsR;w++)d=w/this.segmentsR*this.arc+this.arcStart,D==="round"?(v=-this.radius*Math.cos(d)*Math.sin(ft),m=this.radius*Math.sin(d)*Math.sin(ft)):(v=-this.radius*Math.cos(d)*at/e,m=this.radius*Math.sin(d)*at/e,v*=this.startCapR||1.3,m*=this.startCapR||1.3),ot=st.clone(),ot.x+=v*i.x+m*o.x,ot.y+=v*i.y+m*o.y,ot.z+=v*i.z+m*o.z,this.startGrid[at][w]=M.vertices.push(ot)-1;H==="center"&&(this.startGrid[at][this.segmentsR]=M.vertices.push(st.clone())-1)}}else Z=M.vertices.push(g);for(w=0;w<this.segmentsR;w++){et=w/(this.segmentsR-1);if(this.shape instanceof Array)v=-this.shape[w].x,m=this.shape[w].y;else if(this.shape instanceof n.Path){var lt=this.shape.getPointAt(et);v=-lt.x,m=-lt.y}else d=w/this.segmentsR*this.arc+this.arcStart,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);y.copy(g),y.x+=v*i.x+m*o.x,y.y+=v*i.y+m*o.y,y.z+=v*i.z+m*o.z,this.grid[b][w]=Y(y.x,y.y,y.z,M)}H==="center"&&(this.grid[b][this.segmentsR]=M.vertices.push(g.clone())-1);if(P!=="none"&&b===nt-1)if(P==="round"||P==="arrow"){it+=this.radius*this.endCapSize;var st,ot,ut=g.clone().add(r.clone
().multiplyScalar(this.radius*this.endCapSize));for(var at=0;at<=e;at++){this.endGrid[at]=[];var ft=(1-at/e)*Math.PI/2;P==="round"?st=ut.clone().add(r.clone().multiplyScalar(-this.radius*this.endCapSize*(1-Math.cos(ft)))):st=ut.clone().add(r.clone().multiplyScalar(-this.radius*this.endCapSize*(1-at/e)));for(var w=0;w<this.segmentsR;w++)d=w/this.segmentsR*this.arc+this.arcStart,P==="round"?(v=-this.radius*Math.cos(d)*Math.sin(ft),m=this.radius*Math.sin(d)*Math.sin(ft)):(v=-this.radius*Math.cos(d)*(1-at/e),m=this.radius*Math.sin(d)*(1-at/e),v*=this.endCapR||1.3,m*=this.endCapR||1.3),ot=st.clone(),ot.x+=v*i.x+m*o.x,ot.y+=v*i.y+m*o.y,ot.z+=v*i.z+m*o.z,this.endGrid[at][w]=M.vertices.push(ot)-1;H==="center"&&(this.endGrid[at][this.segmentsR]=M.vertices.push(st)-1)}}else M.vertices.push(g)}var ct=this.segmentsR,ht=this.segmentsR;this.arc!==Math.PI*2&&(H==="center"?(ct++,ht++):H==="none"&&ct--);var pt=this.arc/Math.PI/2,dt=_.getLength(),vt=dt+rt+it,mt=0,gt=rt/vt,yt=gt,bt=dt/vt,wt=gt+bt,Et=it/vt,St=0;if(D!=="none")if(D==="plain"){x=0;for(w=0;w<this.segmentsR;w++){S=(w+1)%this.segmentsR,T=this.grid[0][w],N=this.grid[0][S],M.faces.push(new n.Face3(x,T,N)),d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var k=new s(.5,.5);d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var L=new s((v/this.radius+1)/2,(m/this.radius+1)/2);d=S/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var A=new s((v/this.radius+1)/2,(m/this.radius+1)/2);M.uvs.push([k,L,A])}}else for(b=0;b<=e;b++)for(w=0;w<ct;w++){E=b+1,S=(w+1)%ht,x=this.startGrid[b][w],E===e+1?(T=this.grid[0][w],N=this.grid[0][S]):(T=this.startGrid[E][w],N=this.startGrid[E][S]),C=this.startGrid[b][S];if(w>=this.segmentsR-1){var at=this.segmentsR-1,p=at/this.segmentsR*pt;ct===this.segmentsR?(k=new n.XiangliangTwo(b/e*gt+mt,p),L=new n.XiangliangTwo((b+1)/e*gt+mt,p),A=new n.XiangliangTwo((b+1)/e*gt+mt,1),O=new n.XiangliangTwo(b/e*gt+mt,1)):w>this.segmentsR-1?(k=new n.XiangliangTwo(b/e*gt+mt,(1+p)/2),L=new n.XiangliangTwo((b+1)/e*gt+mt,(1+p)/2),A=new n.XiangliangTwo((b+1)/e*gt+mt,1),O=new n.XiangliangTwo(b/e*gt+mt,1)):(k=new n.XiangliangTwo(b/e*gt+mt,p),L=new n.XiangliangTwo((b+1)/e*gt+mt,p),A=new n.XiangliangTwo((b+1)/e*gt+mt,(1+p)/2),O=new n.XiangliangTwo(b/e*gt+mt,(1+p)/2))}else k=new n.XiangliangTwo(b/e*gt+mt,w/this.segmentsR*pt),L=new n.XiangliangTwo((b+1)/e*gt+mt,w/this.segmentsR*pt),A=new n.XiangliangTwo((b+1)/e*gt+mt,(w+1)/this.segmentsR*pt),O=new n.XiangliangTwo(b/e*gt+mt,(w+1)/this.segmentsR*pt);b!==0&&(M.faces.push(new n.Face3(x,T,C,Z-1)),M.uvs.push([k,L,O])),M.faces.push(new n.Face3(T,N,C,Z-1)),M.uvs.push([L.clone(),A,O.clone()])}for(b=0;b<tt;b++)for(w=0;w<ct;w++){E=this.closed?(b+1)%tt:b+1,S=(w+1)%ht,x=this.grid[b][w],T=this.grid[E][w],N=this.grid[E][S],C=this.grid[b][S];if(w>=this.segmentsR-1){var at=this.segmentsR-1,p=at/this.segmentsR*pt;ct===this.segmentsR?(k=new n.XiangliangTwo(F[b]*bt+yt,p),L=new n.XiangliangTwo(F[b+1]*bt+yt,p),A=new n.XiangliangTwo(F[b+1]*bt+yt,1),O=new n.XiangliangTwo(F[b]*bt+yt,1)):w>this.segmentsR-1?(k=new n.XiangliangTwo(F[b]*bt+yt,(p+1)/2),L=new n.XiangliangTwo(F[b+1]*bt+yt,(p+1)/2),A=new n.XiangliangTwo(F[b+1]*bt+yt,1),O=new n.XiangliangTwo(F[b]*bt+yt,1)):(k=new n.XiangliangTwo(F[b]*bt+yt,p),L=new n.XiangliangTwo(F[b+1]*bt+yt,p),A=new n.XiangliangTwo(F[b+1]*bt+yt,(p+1)/2),O=new n.XiangliangTwo(F[b]*bt+yt,(p+1)/2))}else k=new n.XiangliangTwo(F[b]*bt+yt,w/this.segmentsR*pt),L=new n.XiangliangTwo(F[b+1]*bt+yt,w/this.segmentsR*pt),A=new n.XiangliangTwo(F[b+1]*bt+yt,(w+1)/this.segmentsR*pt),O=new n.XiangliangTwo(F[b]*bt+yt,(w+1)/this.segmentsR*pt);M.faces.push(new n.Face3(x,T,C)),M.uvs.push([k,L,O]),M.faces.push(new n.Face3(T,N,C)),M.uvs.push([L.clone(),A,O.clone()])}if(P!=="none"){x=M.vertices.length-1;var B=this.grid.length;if(P==="plain")for(w=0;w<this.segmentsR;w++){S=(w+1)%this.segmentsR,T=this.grid[B-1][w],N=this.grid[B-1][S],M.faces.push(new n.Face3(x,N,T)),d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var k=new s(.5,.5);d=w/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var L=new s((v/this.radius+1)/2,(m/this.radius+1)/2);d=S/this.segmentsR*2*Math.PI,v=-this.radius*Math.cos(d),m=this.radius*Math.sin(d);var A=new s((v/this.radius+1)/2,(m/this.radius+1)/2);M.uvs.push([k,A,L])}else for(b=-1;b<e;b++)for(w=0;w<ct;w++){E=b+1,S=(w+1)%ht,b===-1?(x=this.grid[B-1][w],C=this.grid[B-1][S]):(x=this.endGrid[b][w],C=this.endGrid[b][S]),T=this.endGrid[E][w],N=this.endGrid[E][S];if(w>=this.segmentsR-1){var at=this.segmentsR-1,p=at/this.segmentsR*pt;ct===this.segmentsR?(k=new n.XiangliangTwo(b/e*Et+wt,p),L=new n.XiangliangTwo((b+1)/e*Et+wt,p),A=new n.XiangliangTwo((b+1)/e*Et+wt,1),O=new n.XiangliangTwo(b/e*Et+wt,1)):w>this.segmentsR-1?(k=new n.XiangliangTwo(b/e*Et+wt,(1+p)/2),L=new n.XiangliangTwo((b+1)/e*Et+wt,(1+p)/2),A=new n.XiangliangTwo((b+1)/e*Et+wt,1),O=new n.XiangliangTwo(b/e*Et+wt,1)):(k=new n.XiangliangTwo(b/e*Et+wt,p),L=new n.XiangliangTwo((b+1)/e*Et+wt,p),A=new n.XiangliangTwo((b+1)/e*Et+wt,(1+p)/2),O=new n.XiangliangTwo(b/e*Et+wt,(1+p)/2))}else k=new n.XiangliangTwo(b/e*Et+wt,w/this.segmentsR*pt),L=new n.XiangliangTwo((b+1)/e*Et+wt,w/this.segmentsR*pt),A=new n.XiangliangTwo((b+1)/e*Et+wt,(w+1)/this.segmentsR*pt),O=new n.XiangliangTwo(b/e*Et+wt,(w+1)/this.segmentsR*pt);M.faces.push(new n.Face3(x,T,C)),M.uvs.push([k,L,O]),M.faces.push(new n.Face3(T,N,C)),M.uvs.push([L.clone(),A,O.clone()])}}return M},frenetFrames:function(e,r,i){function N(e){f[0]=new n.XiangliangThree,l[0]=new n.XiangliangThree,e===t&&(e=new n.XiangliangThree(0,0,1)),f[0].crossVectors(e,a[0]).normalize(),l[0].crossVectors(a[0],f[0]).normalize()}function C(){var t=e.getTangentAt(m);f[0]=(new n.XiangliangThree).subVectors(t,a[0]).normalize(),l[0]=(new n.XiangliangThree).crossVectors(a[0],f[0]),f[0].crossVectors(l[0],a[0]).normalize(),l[0].crossVectors(a[0],f[0]).normalize()}function k(){f[0]=new n.XiangliangThree,l[0]=new n.XiangliangThree,g=Number.MAX_VALUE,y=Math.abs(a[0].x),b=Math.abs(a[0].y),w=Math.abs(a[0].z),y<=g&&(g=y,o.set(1,0,0)),b<=g&&(g=b,o.set(0,1,0)),w<=g&&o.set(0,0,1),c.crossVectors(a[0],o).normalize(),f[0].crossVectors(a[0],c),l[0].crossVectors(a[0],f[0])}var s=new n.XiangliangThree,o=new n.XiangliangThree,u=new n.XiangliangThree,a=[],f=[],l=[],c=new n.XiangliangThree,h=new n.Mat4,p=r.length-1,d=p+1,v,m=1e-4,g,y,b,w,E,S,x,T=[];T.tangents=a,T.normals=f,T.binormals=l;for(E=0;E<d;E++){S=r[E];var x=e.getTangentAt(S);a[E]=new n.XiangliangThree(x.x,x.y,x.z?x.z:0),a[E].normalize()}k();for(E=1;E<d;E++)f[E]=f[E-1].clone(),l[E]=l[E-1].clone(),c.crossVectors(a[E-1],a[E]),c.length()>m&&(c.normalize(),v=Math.acos(n.Math.clamp(a[E-1].dot(a[E]),-1,1)),f[E].applyMatrix4(h.makeRotationAxis(c,v))),l[E].crossVectors(a[E],f[E]);if(i){v=Math.acos(n.Math.clamp(f[0].dot(f[d-1]),-1,1)),v/=d-1,a[0].dot(c.crossVectors(f[0],f[d-1]))>0&&(v=-v);for(E=1;E<d;E++)f[E].applyMatrix4(h.makeRotationAxis(a[E],v*E)),l[E].crossVectors(a[E],f[E])}return T}}),n.PathCube=function(e,t,r,i,s){var o;arguments.length===1&&arguments[0]instanceof Object&&!(arguments[0]instanceof n.Path)?(o=arguments[0],this.path=o.path,this.width=o.width||50,this.height=o.height||100,this.curveSegements=o.curveSegements||32,this.repeat=o.repeat||20,this._id=o.id):(this.path=e,this.width=t||50,this.height=r||100,this.curveSegements=i||32,this.repeat=s||20),this.materialSize=6,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.PathCube.SideIndexMapping={bottom:0,outside:1,inside:2,top:3,aside:4,zside:5},n.extend(n.PathCube,n.Entity,{__accessor:["path","width","height","curveSegements","repeat"],__SizePropeties:["path","width","height","curveSegements","repeat"],constructor:n.PathCube,className:"TGL.PathCube",getSideIndexMapping:function(){return n.PathCube.SideIndexMapping},computeData:function(){var e={};e.vertices=[],e.faces=[],e.uvs=[],e.uv2s=[];if(this.path==null)return e;var t=this.computePoints(this.path,this.width,this.curveSegements),n=t[0],r=t[1],i=n.length,s,o=t[2],u=this.height,a=this.repeat,f=[],l=[],c=[],h=[],p=this.path.isClockwise();this.innerPoints=this.clonePoints(n),this.outerPoints=this.clonePoints(r);for(s=0;s<i;s++)this.exchangeYZ(n[s]),this.exchangeYZ(r[s]),f[s]=e.vertices.push(n[s])-1,l[s]=e.vertices.push(r[s])-1,c[s]=e.vertices.push(n[s].clone().setY(u))-1,h[s]=e.vertices.push(r[s].clone().setY(u))-1;var d=o?i:i-1;for(s=0;s<d;s++)this.generateTop(e,s,i,c,h,!0,a),this.generateBottom(e,s,i,f,l,a),this.generateSideWall(e,s,i,h,l,!0,a,p),this.generateSideWall(e,s,i,c,f,!1,a,p);return o||(this.generateEnd(e,c,f,l,h,a,!0),this.generateEnd(e,c,f,l,h,a,!1)),this.clockwise=p,e},clonePoints:function(e){var t=[];for(var n=0;n<e.length;n++)t.push(e[n].clone());return t},getInsidePoints:function(){var e=[];return this.clockwise?e=this.innerPoints:e=this.outerPoints,e},generateEnd:function(e,t,r,i,o,u,a){var f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,E,T,N,C,k,L=a?0:r.length-1;f=t[L],l=r[L],c=i[L],h=o[L],T=e.vertices[f],N=e.vertices[l],C=e.vertices[c],k=e.vertices[h],p=T.x,d=T.y,v=T.z,m=N.x,g=N.y,y=N.z,b=C.x,w=C.y,E=C.z,S=k.x,x=k.y,dz=k.z;var A=Math.abs(v-E),O=Math.abs(p-b);a?(e.faces.push(new n.Face3(f,l,h,null,null,4)),A<O?e.uvs.push([new n.XiangliangTwo(p/u,d/u),new n.XiangliangTwo(m/u,g/u),new n.XiangliangTwo(S/u,x/u)]):e.uvs.push([new n.XiangliangTwo(v/u,d/u),new n.XiangliangTwo(y/u,g/u),new n.XiangliangTwo(dz/u,x/u)]),e.uv2s.push([new s(0,1),new s(0,0),new s(1,1)]),e.faces.push(new n.Face3(l,c,h,null,null,4)),A<O?e.uvs.push([new n.XiangliangTwo(m/u,g/u),new n.XiangliangTwo(b/u,w/u),new n.XiangliangTwo(S/u,x/u)]):e.uvs.push([new n.XiangliangTwo(y/u,g/u),new n.XiangliangTwo(E/u,w/u),new n.XiangliangTwo(dz/u,x/u)]),e.uv2s.push([new s(0,0),new s(1,0),new s(1,1)])):(e.faces.push(new n.Face3(l,f,h,null,null,5)),A<O?e.uvs.push([new n.XiangliangTwo(m/u,g/u),new n.XiangliangTwo(p/u,d/u),new n.XiangliangTwo(S/u,x/u)]):e.uvs.push([new n.XiangliangTwo(y/u,g/u),new n.XiangliangTwo(v/u,d/u),new n.XiangliangTwo(dz/u,x/u)]),e.uv2s.push([new s(0,0),new s(0,1),new s(1,1)]),e.faces.push(new n.Face3(c,l,h,null,null,5)),A<O?e.uvs.push([new n.XiangliangTwo(b/u,w/u),new n.XiangliangTwo(m/u,g/u),new n.XiangliangTwo(S/u,x/u)]):e.uvs.push([new n.XiangliangTwo(E/u,w/u),new n.XiangliangTwo(y/u,g/u),new n.XiangliangTwo(dz/u,x/u)]),e.uv2s.push([new s(1,0),new s(0,0),new s(1,1)]))},generateSideWall:function(e,t,r,i,o,u,a,f){var l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,S,N,C,k,L,A;N=(t+1)%r,l=i[t],c=o[t],h=o[N],p=i[N],C=e.vertices[l],k=e.vertices[c],L=e.vertices[h],A=e.vertices[p],d=C.x,v=C.y,m=C.z,g=k.x,y=k.y,b=k.z,w=L.x,E=L.y,S=L.z,x=A.x,T=A.y,dz=A.z;var O=Math.abs(m-S),M=Math.abs(d-w),_;u?(_=f?1:2,e.faces.push(new n.Face3(l,c,p,null,null,_)),O<M?e.uvs.push([new n.XiangliangTwo(d/a,v/a),new n.XiangliangTwo(g/a,y/a),new n.XiangliangTwo(x/a,T/a)]):e.uvs.push([new n.XiangliangTwo(m/a,v/a),new n.XiangliangTwo(b/a,y/a),new n.XiangliangTwo(dz/a,T/a)]),e.uv2s.push([new s(0,1),new s(0,0),new s(1,1)]),e.faces.push(new n.Face3(c,h,p,null,null,_)),O<M?e.uvs.push([new n.XiangliangTwo(g/a,y/a),new n.XiangliangTwo(w/a,E/a),new n.XiangliangTwo(x/a,T/a)]):e.uvs.push([new n.XiangliangTwo(b/a,y/a),new n.XiangliangTwo(S/a,E/a),new n.XiangliangTwo(dz/a,T/a)]),e.uv2s.push([new s(0,0),new s(1,0),new s(1,1)])):(_=f?2:1,e.faces.push(new n.Face3(c,l,p,null,null,_)),O<M?e.uvs.push([new n.XiangliangTwo(g/a,y/a),new n.XiangliangTwo(d/a,v/a),new n.XiangliangTwo(x/a,T/a)]):e.uvs.push([new n.XiangliangTwo(b/a,y/a),new n.XiangliangTwo(m/a,v/a),new n.XiangliangTwo(dz/a,T/a)]),e.uv2s.push([new s(0,0),new s(0,1),new s(1,1)]),e.faces.push(new n.Face3(h,c,p,null,null,_)),O<M?e.uvs.push([new n.XiangliangTwo(w/a,E/a),new n.XiangliangTwo(g/a,y/a),new n.XiangliangTwo(x/a,T/a)]):e.uvs.push([new n.XiangliangTwo(S/a,E/a),new n.XiangliangTwo(b/a,y/a),new n.XiangliangTwo(dz/a,T/a)]),e.uv2s.push([new s(1,0),new s(0,0),new s(1,1)]))},generateBottom:function(e,t,n,r,i,s){this.generateTop(e,t,n,r,i,!1,s)},generateTop:function(e,t,r,i,o,u,a){var f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,E,T,N,C,k,L;T=(t+1)%r,f=i[t],l=o[t],c=o[T],h=i[T],N=e.vertices[f],C=e.vertices[l],k=e.vertices[c],L=e.vertices[h],p=N.x,d=N.y,v=N.z,m=C.x,g=C.y,y=C.z,b=k.x,w=k.y,E=k.z,S=L.x,x=L.y,dz=L.z,u?(e.faces.push(new n.Face3(f,l,h,null,null,3)),e.uvs.push([new n.XiangliangTwo(p/a,v/a),new n.XiangliangTwo(m/a,y/a),new n.XiangliangTwo(S/a,dz/a)]),e.uv2s.push([new s(0,1),new s(0,0),new s(1,1)]),e.faces.push(new n.Face3(l,c,h,null,null,3)),e.uvs.push([new n.XiangliangTwo(m/a,y/a),new n.XiangliangTwo(b/a,E/a),new n.XiangliangTwo(S/a,dz/a)]),e.uv2s.push([new s(0,0),new s(1,0),new s(1,1)])):(e.faces.push(new n.Face3(l,f,h,null,null,0)),e.uvs.push([new n.XiangliangTwo(m/a,y/a),new n.XiangliangTwo(p/a,v/a),new n.XiangliangTwo(S/a,dz/a)]),e.uv2s.push([new s(0,0),new s(0,1),new s(1,1)]),e.faces.push(new n.Face3(c,l,h,null,null,0)),e.uvs.push([new n.XiangliangTwo(b/a,E/a),new n.XiangliangTwo(m/a,y/a),new n.XiangliangTwo(S/a,dz/a)]),e.uv2s.push([new s(1,0),new s(0,0),new s(1,1)]))},exchangeYZ:function(e){var t=e.y;e.y=e.z,e.z=-t},addPoints:function(e,t,r,i,s){t.multiplyScalar(.5),r.push((new n.XiangliangThree).subVectors(e,t)),i.push((new n.XiangliangThree).addVectors(e,t))},computeCurvePoint:function(e,t,r,i,s,a,f,l,c){var h=i?0:1,p,d,v=new n.XiangliangThree,m,g,y,b=l;if(e){m=e.getTangentAt(1),g=t.getTangentAt(0),concave=n.Math.isConcave(m,g,!1),g.multiplyScalar(-1),angle=m.angleTo(g),y=Math.sin(angle/2),d=t.getPoint(0),y=y==0?.1:y;var w=concave?r/y:-r/y;y==1?v.crossVectors(g,new o(0,0,1)).normalize().multiplyScalar(w):v.addVectors(m,g).normalize().multiplyScalar(w),this.addPoints(d,v,a,f,c)}else g=t.getTangentAt(h),d=t.getPoint(h),v.crossVectors(g,new n.XiangliangThree(0,0,1)).normalize().multiplyScalar(r),this.addPoints(d,v,a,f,c);if(!(t instanceof n.LineCurve3)&&s){var E=b+1;for(j=0;j<E-2;j++)u=j/(E-1),g=t.getTangentAt(u),d=t.getPointAt(u),v.crossVectors(g,new n.XiangliangThree(0,0,1)).normalize().multiplyScalar(r),j*t.getLength()/b>r/Math.abs(y)&&this.addPoints(d,v,a,f,c)}},computePoints:function(e,t,r){var i,s,o,u,a=new n.XiangliangThree,f,l,c=e.isClockwise(),h,p,d=e.curves[0].getPoint(0),v=e.curves[e.curves.length-1].getPoint(1);p=d.equals(v),l=e.curves.length;var m=[],g=[],y=new n.Path,b=0,w,E=e.getLength();for(i=0;i<l;i++){var S=i-1;p&&S===-1&&(S=l-1);var x=e.curves[S],T=e.curves[i];this.computeCurvePoint(x,T,t,!0,!0,m,g,r,c),i===l-1&&!p&&this.computeCurvePoint(null,T,t,!1,!1,m,g,r,c)}return[m,g,p]}}),n.ShapeNode=function(e,t,r,i,s){if(e==null){e=[],this.materialSize=3,n.Entity.call(this);return}var o;if(!(arguments.length===1&&arguments[0]instanceof Object)||arguments[0]instanceof n.Shape||arguments[0]instanceof n.Path&&!Array.isArray(arguments[0]))this.options={curveSegments:t,amount:r,vertical:i,zMinusHalfAmount:this.zMinusHalfAmount,repeat:s||20};else{o=arguments[0],e=o.path;if(e==null){e=[],this.materialSize=3,n.Entity.call(this);return}t=o.curveSegments,r=o.amount,i=o.vertical,s=o.repeat,this.options={curveSegments:o.curveSegments,amount:o.amount,vertical:o.vertical,zMinusHalfAmount:this.zMinusHalfAmount,repeat:o.repeat||20},this._id=o.id}var u=[];e instanceof n.Path?(u=e.toShapes(),this.path=e):u=e,this.curveSegments=t,this.amount=r,this.vertical=i,this.repeat=s||20,u=u instanceof Array?u:[u],this.shapes=u,this.shapebb=u[u.length-1].getBizBox(),this.materialSize=3,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.ShapeNode.SideIndexMapping={bottom:0,side:1,top:2},n.extend(n.ShapeNode,n.Entity,{constructor:n.ShapeNode,className:"TGL.ShapeNode",__accessor:["path","curveSegments","amount","vertical","repeat"],__bool:["vertical"],__SizePropeties:["path","curveSegments","amount","vertical","repeat"],computeData:function(){return this.options={curveSegments:this.curveSegments,amount:this.amount,vertical:this.vertical,zMinusHalfAmount:this.zMinusHalfAmount,repeat:this.repeat||20},this.addShapes(this.path,this.options)},getSideIndexMapping:function(){return n.ShapeNode.SideIndexMapping},addShapes:function(e,t){var r=[];e instanceof n.Path?r=e.toShapes():r=e;var i={};i.vertices=[],i.uvs=[],i.faces=[];if(!r)return i;var s=r.length;for(var o=0;o<s;o++){var u=r[o];this.addShape(u,t,i)}var a=new n.BizBox;a.setFromPoints(i.vertices);var f=(a.max.y-a.min.y)/2;if(t.zMinusHalfAmount)for(var l=0;l<i.vertices.length;l++)i.vertices[l].y-=f;if(t.vertical)for(var l=0;l<i.vertices.length;l++){var c=i.vertices[l].y;i.vertices[l].y=i.vertices[l].z,i.vertices[l].z=-c}return i}}),n.ShapeNode.prototype.addShape=function(e,r,i){function H(e,t,n){return t||console.log("die"),t.clone().multiplyScalar(n).add(e)}function $(e,t,n){return K(e,t,n)}function J(e,t,r){var i=Math.atan2(t.y-e.y,t.x-e.x),s=Math.atan2(r.y-e.y,r.x-e.x);i>s&&(s+=Math.PI*2);var o=(i+s)/2,u=-Math.cos(o),a=-Math.sin(o),f=new n.XiangliangTwo(u,a);return f}function K(e,t,r){var i=n.ShapeNode.__v1,s=n.ShapeNode.__v2,o=n.ShapeNode.__v3,u=n.ShapeNode.__v4,a=n.ShapeNode.__v5,f=n.ShapeNode.__v6,l,c,h,p,d,v;return i.set(e.x-t.x,e.y-t.y),s.set(e.x-r.x,e.y-r.y),l=i.normalize(),c=s.normalize(),o.set(-l.y,l.x),u.set(c.y,-c.x),a.copy(e).add(o),f.copy(e).add(u),a.equals(f)?u.clone():(a.copy(t).add(o),f.copy(r).add(u),h=l.dot(u),p=f.sub(a).dot(u),h===0&&(console.log("Either infinite or no solutions!"),p===0?console.log("Its finite solutions."):console.log("Too bad, no solutions.")),d=p/h,d<0?J(e,t,r):(v=l.multiplyScalar(d).add(a),v.sub(e).clone()))}function at(){if(l){var e=0,t=R*e;for(G=0;G<z;G++)U=D[G],ht(U[2]+t,U[1]+t,U[0]+t,!0);e=h+f*2,t=R*e;for(G=0;G<z;G++)U=D[G],ht(U[0]+t,U[1]+t,U[2]+t,!1)}else{for(G=0;G<z;G++)U=D[G],ht(U[2],U[1],U[0],!0);for(G=0;G<z;G++)U=D[G],ht(U[0]+R*h,U[1]+R*h,U[2]+R*h,!1)}}function ft(){var e=0;lt(P,e),e+=P.length;for(N=0,C=M.length;N<C;N++)T=M[N],lt(T,e),e+=T.length}function lt(e,t){var n,r;G=e.length;while(--G>=0){n=G,r=G-1,r<0&&(r=e.length-1);var i=0,s=h+f*2;for(i=0;i<s;i++){var o=R*i,u=R*(i+1),a=t+n+o,l=t+r+o,c=t+r+u,p=t+n+u;pt(a,l,c,p,e,i,s,n,r)}}}function ct(e,t,r){i.vertices.push(new n.XiangliangThree(e,t,r-(o?s/2:0)))}function ht(t,s,o,u){t+=L,s+=L,o+=L;var a=u?0:2;if(n.Math.isClockwise([i.vertices[t],i.vertices[s],i.vertices[o]]),"x","z"){i.faces.push(new n.Face3(t,s,o,null,null,a));var f=u?y.generateBottomUV(i,e,r,t,s,o):y.generateTopUV(i,e,r,t,s,o);i.uvs.push(f)}else{i.faces.push(new n.Face3(t,o,s,null,null,a));var f=u?y.generateBottomUV(i,e,r,t,o,s):y.generateTopUV(i,e,r,t,o,s);i.uvs.push(f)}}function pt(t,s,o,u,a,f,l,c,h){t+=L,s+=L,o+=L,u+=L;if(n.Math.isClockwise([i.vertices[t],i.vertices[s],i.vertices[u]]),"x","z"){i.faces.push(new n.Face3(t,s,u,null,null,g)),i.faces.push(new n.Face3(s,o,u,null,null,g));var p=y.generateSideWallUV(i,e,a,r,t,s,o,u,f,l,c,h);i.uvs.push([p[0],p[1],p[3]]),i.uvs.push([p[1],p[2],p[3]])}else{i.faces.push(new n.Face3(t,u,s,null,null,g)),i.faces.push(new n.Face3(s,u,o,null,null,g));var p=y.generateSideWallUV(i,e,a,r,t,s,o,u,f,l,c,h);i.uvs.push([p[0],p[3],p[1]]),i.uvs.push([p[1],p[3],p[2]])}}var s=r.amount!==t?r.amount:100,o=r.zMinusHalfAmount!==t?r.zMinusHalfAmount:!1,u=r.bevelThickness!==t?r.bevelThickness:6,a=r.bevelSize!==t?r.bevelSize:u-2,f=r.bevelSegments!==t?r.bevelSegments:3,l=r.bevelEnabled!==t?r.bevelEnabled:!1,c=r.curveSegments!==t?r.curveSegments:12,h=r.steps!==t?r.steps:1,p=r.extrudePath,d,v=!1,m=r.material||0,g=r.extrudeMaterial||1,y=r.UVGenerator!==t?r.UVGenerator:n.ShapeNode.WorldUVGenerator;y.repeat=r.repeat;var b=this.shapebb,w,E,S,x;p&&(d=p.getSpacedPoints(h),v=!0,l=!1,w=r.frames!==t?r.frames:n.PathNode.prototype.frenetFrames(p,h,!1),E=new n.XiangliangThree,S=new n.XiangliangThree,x=new n.XiangliangThree),l||(f=0,u=0,a=0);var T,N,C,k=[],L=i.vertices.length,A=e.extractPoints(c),O=A.shape,M=A.holes,_=!n.Shape.Utils.isClockWise(O);if(_){O=O.reverse();for(N=0,C=M.length;N<C;N++)T=M[N],n.Shape.Utils.isClockWise(T)&&(M[N]=T.reverse());_=!1}var D=n.Shape.Utils.triangulateShape(O,M),P=O;for(N=0,C=M.length;N<C;N++)T=M[N],O=O.concat(T);var B,j,F,I,q,R=O.length,U,z=D.length,W,X=P.length,V=180/Math.PI,Q=[];for(var G=0,Y=P.length,Z=Y-1,et=G+1;G<Y;G++,Z++,et++){Z===Y&&(Z=0),et===Y&&(et=0);var tt=P[G],nt=P[Z],rt=P[et];Q[G]=$(P[G],P[Z],P[et])}var it=[],st,ot=Q.concat();for(N=0,C=M.length;N<C;N++){T=M[N],st=[];for(G=0,Y=T.length,Z=Y-1,et=G+1;G<Y;G++,Z++,et++)Z===Y&&(Z=0),et===Y&&(et=0),st[G]=$(T[G],T[Z],T[et]);it.push(st),ot=ot.concat(st)}for(B=0;B<f;B++){F=B/f,I=u*(1-F),j=a*Math.sin(F*Math.PI/2);for(G=0,Y=P.length;G<Y;G++)q=H(P[G],Q[G],j),ct(q.x,q.y,-I);for(N=0,C=M.length;N<C;N++){T=M[N],st=it[N];for(G=0,Y=T.length;G<Y;G++)q=H(T[G],st[G],j),ct(q.x,q.y,-I)}}j=a;for(G=0;G<R;G++)q=l?H(O[G],ot[G],j):O[G],v?(S.copy(w.normals[0]).multiplyScalar(q.x),E.copy(w.binormals[0]).multiplyScalar(q.y),x.copy(d[0]).add(S).add(E),ct(x.x,x.y,x.z)):ct(q.x,q.y,0);var ut;for(ut=1;ut<=h;ut++)for(G=0;G<R;G++)q=l?H(O[G],ot[G],j):O[G],v?(S.copy(w.normals[ut]).multiplyScalar(q.x),E.copy(w.binormals[ut]).multiplyScalar(q.y),x.copy(d[ut]).add(S).add(E),ct(x.x,x.y,x.z)):ct(q.x,q.y,s/h*ut);for(B=f-1;B>=0;B--){F=B/f,I=u*(1-F),j=a*Math.sin(F*Math.PI/2);for(G=0,Y=P.length;G<Y;G++)q=H(P[G],Q[G],j),ct(q.x,q.y,s+I);for(N=0,C=M.length;N<C;N++){T=M[N],st=it[N];for(G=0,Y=T.length;G<Y;G++)q=H(T[G],st[G],j),v?ct(q.x,q.y+d[h-1].y,d[h-1].x+I):ct(q.x,q.y,s+I)}}at(),ft()},n.ShapeNode.WorldUVGenerator={generateTopUV:function(e,t,r,i,s,o){var u=e.vertices[i].x,a=e.vertices[i].y,f=e.vertices[s].x,l=e.vertices[s].y,c=e.vertices[o].x,h=e.vertices[o].y;return[new n.XiangliangTwo(u/this.repeat,a/this.repeat),new n.XiangliangTwo(f/this.repeat,l/this.repeat),new n.XiangliangTwo(c/this.repeat,h/this.repeat)]},generateBottomUV:function(e,t,n,r,i,s){return this.generateTopUV(e,t,n,r,i,s)},uv:function(e,t,n){return new s(Math.sqrt(e*e+t*t)/this.repeat,(1-n)/this.repeat)},generateSideWallUV:function(e,t,r,i,s,o,u,a,f,l,c,h){var p=e.vertices[s].x,d=e.vertices[s].y,v=e.vertices[s].z,m=e.vertices[o].x,g=e.vertices[o].y,y=e.vertices[o].z,b=e.vertices[u].x,w=e.vertices[u].y,E=e.vertices[u].z,S=e.vertices[a].x,x=e.vertices[a].y,T=e.vertices[a].z,N=Math.abs(d-g),C=Math.abs(p-m);return N<C?[new n.XiangliangTwo(p/this.repeat,(1-v)/this.repeat),new n.XiangliangTwo(m/this.repeat,(1-y)/this.repeat),new n.XiangliangTwo(b/this.repeat,(1-E)/this.repeat),new n.XiangliangTwo(S/this.repeat,(1-T)/this.repeat)]:[new n.XiangliangTwo(d/this.repeat,(1-v)/this.repeat),new n.XiangliangTwo(g/this.repeat,(1-y)/this.repeat),new n.XiangliangTwo(w/this.repeat,(1-E)/this.repeat),new n.XiangliangTwo(x/this.repeat,(1-T)/this.repeat)]}},n.ShapeNode.__v1=new n.XiangliangTwo,n.ShapeNode.__v2=new n.XiangliangTwo,n.ShapeNode.__v3=new n.XiangliangTwo,n.ShapeNode.__v4=new n.XiangliangTwo,n.ShapeNode.__v5=new n.XiangliangTwo,n.ShapeNode.__v6=new n.XiangliangTwo,n.TextNode=function(e,r,i,s,o,u,a){var f;arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])?(f=arguments[0],e=f.text,this.font=f.font||"helvetiker",this.size=f.size||150,this.weight=f.weight||"normal",this.fontStyle=f.fontStyle||"normal",this.height=f.height||50,this._id=f.id,this.curveSegments=f.curveSegments):(this.font=s||"helvetiker",this.size=r||150,this.weight=o||"normal",this.fontStyle=u||"normal",this.height=i||50,this.curveSegments=a);var l={size:this.size,height:this.height,font:this.font,weight:this.weight,style:this.fontStyle,curveSegments:this.curveSegments||30,bevelEnabled:!1,zMinusHalfAmount:!0};this.text=e;var c=n.FontUtils.generateShapes(e,l);l.amount=l.height!==t?l.height:50,l.bevelThickness===t&&(l.bevelThickness=10),l.bevelSize===t&&(l.bevelSize=8),l.bevelEnabled===t&&(l.bevelEnabled=!1),n.ShapeNode.call(this,c,l.curveSegments,this.height,!1,50,!0)},n.extend(n.TextNode,n.ShapeNode,{constructor:n.TextNode,className:"TGL.TextNode",__accessor:["text","size","height","font","weight","fontStyle"],__SizePropeties:["text","size","height","font","weight","fontStyle"],computeData:function(){var e={size:this.size,height:this.height,font:this.font,weight:this.weight,style:this.fontStyle,curveSegments:this.curveSegments||30,bevelEnabled:!1,zMinusHalfAmount:!0},t={curveSegments:this.curveSegments,amount:this.height,vertical:!1,zMinusHalfAmount:!0,repeat:20},r=n.FontUtils.generateShapes(this.text,e);return n.ShapeNode.prototype.addShapes.call(this,r,t)}}),n.LatheNode=function(e,r,i,s,o,u){this.materialSize=3;var a;arguments.length===1&&arguments[0]instanceof Object&&!(arguments[0]instanceof n.Path)?(a=arguments[0],this.path=a.path,this.segmentsH=a.segmentsH||64,this.segmentsR=a.segmentsR||20,this.arc=a.arc!=t?a.arc:Math.PI*2,this.startClosed=a.startClosed,this.endClosed=a.endClosed,this._id=a.id):(this.path=e,this.segmentsH=r||64,this.segmentsR=i||20,this.arc=s!=t?s:Math.PI*2,this.startClosed=o,this.endClosed=u),n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.LatheNode,n.Entity,{constructor:n.LatheNode,className:"TGL.LatheNode",__accessor:["path","segmentsH","segmentsR","arc","startClosed","endClosed"],__SizePropeties:["path","segmentsH","segmentsR","arc","startClosed","endClosed"],computeData:function(){function v(e){var t=e.x,r=e.z,i=((r===0?t/Math.abs(t):t/Math.abs(r))+1)/2;i=n.Math.clamp(i,0,1);var s=((t===0?r/Math.abs(r):r/Math.abs(t))+1)/2;return s=n.Math.clamp(s,0,1),new n.XiangliangTwo(i,s)}var e={},e={};e.faces=[],e.uvs=[],e.vertices=[];if(this.path==null)return e;var t=[],r=this.path,i=this.segmentsH,s=this.segmentsR,o,u,f,l,h,p,d;n.Shape.Utils.isClockWise(r.getPoints())||(r=r.reverse());for(u=0;u<=i;u++){o=r.getPoint(u/i),t[u]=[],l=Math.abs(o.x),h=o.y,this.startClosed&&u===0&&e.vertices.push(new n.XiangliangThree(0,h,0));for(f=0;f<s;f++)d=f/s*this.arc,p=new n.XiangliangThree(l*Math.cos(d),h,l*Math.sin(d)),t[u][f]=e.vertices.push(p)-1;this.endClosed&&u===i&&e.vertices.push(new n.XiangliangThree(0,h,0))}var m=this.arc==Math.PI*2;if(this.startClosed){a=0;for(f=0;f<(m?s:s-1);f++)jp=(f+1)%s,b=t[0][f],c=t[0][jp],uva=new n.XiangliangTwo(.5,.5),uvb=v(e.vertices[b]),uvc=v(e.vertices[c]),e.faces.push(new n.Face3(a,b,c)),e.uvs.push([uva,uvb,uvc])}for(u=0;u<i;u++)for(f=0;f<(m?s:s-1);f++)ip=u+1,jp=(f+1)%s,a=t[u][f],b=t[ip][f],c=t[ip][jp],zr=t[u][jp],uva=new n.XiangliangTwo(u/i,f/s),uvb=new n.XiangliangTwo((u+1)/i,f/s),uvc=new n.XiangliangTwo((u+1)/i,(f+1)/s),uvd=new n.XiangliangTwo(u/i,(f+1)/s),e.faces.push(new n.Face3(a,b,zr)),e.uvs.push([uva,uvb,uvd]),e.faces.push(new n.Face3(b,c,zr)),e.uvs.push([uvb.clone(),uvc,uvd.clone()]);if(this.endClosed){a=e.vertices.length-1;for(f=0;f<(m?s:s-1);f++)jp=(f+1)%s,b=t[t.length-1][f],c=t[t.length-1][jp],uva=new n.XiangliangTwo(0,0),uvb=new n.XiangliangTwo(1,f/s),uvc=new n.XiangliangTwo(1,(f+1)/s),e.faces.push(new n.Face3(a,b,c)),e.uvs.push([uva,uvb,uvc])}return e}}),n.CurvePlane=function(e,t,r,i){this.pathH=e,this.pathV=t,this.segmentsH=r||20,this.segmentsV=i||20,n.Entity.call(this)},n.extend(n.CurvePlane,n.Entity,{constructor:n.CurvePlane,className:"TGL.CurvePlane",computeData:function(){var e={};e.faces=[],e.uvs=[],e.vertices=[];if(this.pathV==null||this.pathH==null)return e;var t=this.pathV,n=this.pathH,r=this.segmentsV,i=this.segmentsH,u,a,f=r+1,l=i+1,c,h,p,d,v,m,g,y;this.grid=[];for(u=0;u<l;u++){this.grid[u]=[];var b=n.getPointAt(u/l);for(a=0;a<f;a++){var w=t.getPointAt(a/f);this.grid[u][a]=e.vertices.push(new o(b.x,w.y,b.z+w.z))-1}}for(u=0;u<i;u++)for(a=0;a<r;a++)c=this.grid[u][a],h=this.grid[u][a+1],p=this.grid[u+1][a+1],d=this.grid[u+1][a],v=new s(u/l,a/f),m=new s(u/l,(a+1)/f),uvc=new s((u+1)/l,(a+1)/f),y=new s((u+1)/l,a/f),e.faces.push(new O(c,p,h)),e.uvs.push([v,uvc,m]),e.faces.push(new O(c,d,p)),e.uvs.push([v.clone(),y.clone(),uvc]);return e}}),n.ComboNode=function(e,t,r,i,s){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var o=e;this.combos=o.combos||[],this.operators=o.operators,this.centralized=r,this.names=s,this._id=o.id}else this.combos=e||[],this.operators=t,this.centralized=r,this._id=i,this.names=s;this.csgs=[],n.Entity.call(this)},n.extend(n.ComboNode,n.Entity,{constructor:n.ComboNode,className:"TGL.ComboNode",__accessor:["combos","operators","centralized","names"],__SizePropeties:["combos","operators","centralized"],getOffsetPosition:function(){return this._offsetPosition},getSideIndexMapping:function(){var e=this.combos,t=this.names||[],n,r,i,s,o={},u=0;if(e&&e.length)for(i=0;i<e.length;i++){n=e[i],r=t[i],r||(s=n.getClassName(),s&&s.indexOf(".")>0&&(s=s.substr(s.lastIndexOf(".")+1)),r=s+""+i,r=r.toLowerCase());var a=n.getSideIndexMapping();if(a)for(var f in a)o[r+"-"+f]=u++;else o[r]=u++}return o},computeData:function(){this.csgs=[];var e={vertices:[],faces:[],uvs:[],uv2s:[]};if(!this.combos)return e;if(this.operators==null||this.operators.length==0){var r=P.mergeElements(this.combos);this.materialSize=r.material.materials.length,this.material=r.material,this.orgMaterial=r.material,e={vertices:r.vertices,faces:r.faces,uvs:r.uvs,uv2s:r.uv2s||[]};if(this.centralized&&e.vertices){var i=new n.BizBox;i.setFromPoints(e.vertices);var s=i.center();for(u=0;u<e.vertices.length;u++){var o=e.vertices[u];o.sub(s)}this._offsetPosition=s}return e}this.operators=this.operators||[];var u,a,f=this.combos.length,l,c;for(u=0;u<f;u++)this.csgs.push(new n.CSG(this.combos[u]));for(u=0;u<f;u++)a==null?a=this.csgs[u]:(l=this.operators[u-1],l==="+"||l==t?a=a.union(this.csgs[u]):l==="-"?a=a.substract(this.csgs[u]):l==="^"&&(a=a.intersect(this.csgs[u])));if(!a)return e;c=a.toMesh();if(this.changeProperty!="centralized"||this.material==null)this.materialSize=c.material.materials.length,this.material=c.material,this.orgMaterial=c.material;e={vertices:c.vertices,faces:c.faces,uvs:c.uvs,uv2s:c.uv2s};if(this.centralized&&e.vertices){var i=new n.BizBox;i.setFromPoints(e.vertices);var s=i.center();for(u=0;u<e.vertices.length;u++){var o=e.vertices[u];o.sub(s)}this._offsetPosition=s}return c=t,e},computeNodeMaterial:function(e){this.material=e.material,this.materialSize=e.materialSize},cacheNodeMaterial:function(e){e.material=this.material,e.materialSize=this.materialSize},needComputeVertexNormal:function(){return!0},generatePrimitiveKey:function(){return null},changeMapping:function(e){var t=this.getMaterialMapping();n.Utils.isSame(e,t)||(this.batch?this.materialMappingChanges=[e,t]:(this.onMaterialMapping(),this.firePropertyChange("materialMapping",e,t)))},isStyleEquals:function(e,t,n){return!1},getSelectStyle:function(){var e=this.getStyle("select.style");if(e=="outline.normal"||e=="outline")e="outline.wireframe";return e},onMaterialMapping:function(){this.groups=t,this.primitive.groups=t}}),n.Terrain=function(e){e=e||{},this._id=e.id,this.width=e.width,this.depth=e.depth,this.segmentsW=e.segmentsW||30,this.segmentsD=e.segmentsD||30,this.heightMap=e.heightMap,this.heightUnit=e.heightUnit||1,this.maxHeight=e.maxHeight||255,this.minHeight=e.minHeight||0,this.baseLayerHeight=e.baseLayerHeight||0,typeof this.heightMap=="string"?(this.image=new Image,this.image.src=this.heightMap):h.isCanvas(this.heightMap)?this.canvas=this.heightMap:h.isImage(this.heightMap)&&(this.image=this.heightMap);if(this.image){var t=this;this.image.onload=function(e){var n=document.createElement("canvas");n.width=t.image.width,n.height=t.image.height;var r=n.getContext("2d");r.drawImage(t.image,0,0),t.canvas=n,t.computed=!1,t.computeNodeData(),t.firePropertyChange("width",0,1)}}this.materialSize=2,n.Entity.call(this),this.computeCentroids(),this.computeFaceNormals()},n.extend(n.Terrain,n.Entity,{constructor:n.Terrain,className:"TGL.Terrain",__accessor:["width","heightUnit","depth","segmentsW","segmentsD","heightMap","heightUnit","maxHeight","minHeight","baseLayerHeight","smooth"],__SizePropeties:["width","heightUnit","depth","segmentsW","segmentsD","heightMap","heightUnit","maxHeight","minHeight","baseLayerHeight","smooth"],__bool:["smooth"],computeLayerData:function(e,t,r){var i,s,o=this.width/2,u=this.depth/2,a=r?this.segmentsW:1,f=r?this.segmentsD:1,l=a+1,c=f+1,h=this.width/a,p=this.depth/f,d=new n.XiangliangThree(0,0,1),v=e.vertices.length;for(s=0;s<c;s++)for(i=0;i<l;i++){var m=i*h-o,g=s*p-u,y=0;r?y=r.call(this,i/l,s/c):y=this.baseLayerHeight*this.heightUnit,e.vertices.push(new n.XiangliangThree(m,y,g))}for(s=0;s<f;s++)for(i=0;i<a;i++){var b=i+l*s+v,w=i+l*(s+1)+v,E=i+1+l*(s+1)+v,S=i+1+l*s+v,x=new n.XiangliangTwo(i/a,1-s/f),T=new n.XiangliangTwo(i/a,1-(s+1)/f),N=new n.XiangliangTwo((i+1)/a,1-(s+1)/f),C=new n.XiangliangTwo((i+1)/a,1-s/f);if(r){var k=new n.Face3(b,w,S);k.materialIndex=t,e.faces.push(k),e.uvs.push([x,T,C]),k=new n.Face3(w,E,S),k.materialIndex=t,e.faces.push(k),e.uvs.push([T.clone(),N,C.clone()])}else{var k=new n.Face4(b,w,E,S);k.normal.copy(d),k.vertexNormals.push(d.clone(),d.clone(),d.clone(),d.clone()),k.materialIndex=t,e.faces.push(k),e.uvs.push([x,T,N,C])}}},computeData:function(){var e={};return e.vertices=[],e.faces=[],e.uvs=[],this.computeLayerData(e,0),this.computeLayerData(e,1,this.getHeight),e},getFaceNormal:function(e,t){this.computeFaceNormals();var n=this.segmentsW*e,r=this.segmentsD*t,i=Math.floor(n),s=Math.floor(r),o=s*this.segmentsW+i;o=o*2+1,i!=Math.round(n)&&s!=Math.round(r)&&o++;var u=this.faces[o],a=this.vertices[u.a],f=this.vertices[u.b],l=this.vertices[u.c];return u.normal.clone()},setHeightMap:function(e){this.heightMap=e,typeof this.heightMap=="string"?(this.image=new Image,this.image.src=this.heightMap):h.isCanvas(this.heightMap)?this.canvas=this.heightMap:h.isImage(this.heightMap)&&(this.image=this.heightMap);if(this.image){var t=this;if(this.image.width){var n=document.createElement("canvas");n.width=t.image.width,n.height=t.image.height;var r=n.getContext("2d");r.drawImage(t.image,0,0),t.canvas=n,t.computed=!1,t.computeNodeData(),t.firePropertyChange("width",0,1)}else this.image.onload=function(e){var n=document.createElement("canvas");n.width=t.image.width,n.height=t.image.height;var r=n.getContext("2d");r.drawImage(t.image,0,0),t.canvas=n,t.computed=!1,t.computeNodeData(),t.firePropertyChange("width",0,1)}}},getHeight:function(e,t){if(this.canvas==null)return 0;var r=this.canvas;if(this.heightData==null){var i=r.width*r.height,s=new Float32Array(i);for(var o=0;o<i;o++)s[o]=0;var u=r.getContext("2d"),a=u.getImageData(0,0,r.width,r.height),f=a.data,l=0;for(var o=0,c=f.length;o<c;o+=4){var h=f[o]+f[o+1]+f[o+2];s[l++]=h/3}this.heightData=s}var p=e*r.width,d=t*r.height,v=Math.floor
(p),m=Math.floor(d),g=[],y=[];g.push(v),p!=v&&g.push(v+1),y.push(m),d!=m&&y.push(m+1);var b=g.length*y.length,o,l,w=0,E;for(o=0;o<g.length;o++)for(l=0;l<y.length;l++)E=y[l]*r.width+g[o],w+=this.heightData[E];return w/=b,w=n.Math.clamp(w,this.minHeight,this.maxHeight),w*=this.heightUnit,w},getSideIndexMapping:function(){return n.Terrain.SideIndexMapping},refreshUniforms:function(e){e.heightUnit&&(e.heightUnit.value=this.heightUnit)}}),n.Terrain.SideIndexMapping={layer0:0,layer1:1},n.Link=function(e,t,r){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var i=arguments[0];e=i.fromNode,t=i.toNode,this._id=i.id}else this._id=r;n.Line.call(this),this.setFromNode(e),this.setToNode(t),this._editable=!1},n.extend(n.Link,n.Line,{className:"TGL.Link",___accessor:["linkType","extend","controls"],__SizePropeties:["fromNode","toNode","linkType","extend","controls"],setFromNode:function(e){if(this._fromNode!=e){var t=this._fromNode;this._fromNode=e,this.onPropertyChange(),this.firePropertyChange("fromNode",t,e),t,this._fromNode=e,t&&(t._removeFromLink(this),t.removePropertyChangeListener(this.handleNodePropertyChange)),this._fromNode&&(this._fromNode._addFromLink(this),this._fromNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getFromNode:function(){return this._fromNode},setToNode:function(e){if(this._toNode!=e){var t=this._toNode;this._toNode=e,this.onPropertyChange(),this.firePropertyChange("toNode",t,e),t&&(t.removePropertyChangeListener(this.handleNodePropertyChange),t._removeToLink(this)),this._toNode&&(this._toNode._addToLink(this),this._toNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getToNode:function(){return this._toNode},isLooped:function(){return this._fromNode===this._toNode&&this._fromNode!=null&&this._toNode!=null},handleNodePropertyChange:function(e){if(e.property.startsWith("position")||e.property=="worldMatrix"){var t=this.vertices;this.onPropertyChange(),this.firePropertyChange("vertices",t,this.vertices)}},computeNodeData:function(){this.computeData()},updateMatrix:function(){},updateWorldMatrix:function(){},computeData:function(){if(this._fromNode==null||this._toNode==null)return;this._extend==null&&(this._extend=0);var e=this._fromNode.worldMatrix.getPosition(),t=this._toNode.worldMatrix.getPosition(),n=[];n.push(e.clone());if(this._linkType=="orthogonal.x"){var r=Math.max(e.x,t.x),i=new o(r+this._extend,e.y,e.z);n.push(i),i=new o(r+this._extend,t.y,t.z),n.push(i)}else if(this._linkType=="orthogonal.x.n"){var s=Math.min(e.x,t.x),i=new o(s-this._extend,e.y,e.z);n.push(i),i=new o(s-this._extend,t.y,t.z),n.push(i)}else if(this._linkType=="orthogonal.y"){var u=Math.max(e.y,t.y),i=new o(e.x,u+this._extend,e.z);n.push(i),i=new o(t.x,u+this._extend,t.z),n.push(i)}else if(this._linkType=="orthogonal.y.n"){var a=Math.min(e.y,t.y),i=new o(e.x,a-this._extend,e.z);n.push(i),i=new o(t.x,a-this._extend,t.z),n.push(i)}else if(this._linkType=="orthogonal.z"){var f=Math.max(e.z,t.z),i=new o(e.x,e.y,f+this._extend);n.push(i),i=new o(t.x,t.y,f+this._extend),n.push(i)}else if(this._linkType=="orthogonal.z.n"){var l=Math.min(e.z,t.z),i=new o(e.x,e.y,l-this._extend);n.push(i),i=new o(t.x,t.y,l-this._extend),n.push(i)}else if(this._linkType=="control"){var c=this._controls;if(c&&c.length>0)for(var h=0;h<c.length;h++)c[h]instanceof o&&n.push(c[h].clone())}n.push(t.clone()),this.vertices=n},onPropertyChange:function(){this.vertices=this.vertices||[],this.computeData(),this.computeBizBox(),this.selectionData=null,this.boundingSphere=null}}),n.PathLink=function(e,t,r){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var i=arguments[0];e=i.fromNode,t=i.toNode,this._id=i.id}else this._id=r;n.PathNode.call(this),this._autoAjust=!0,this.setFromNode(e),this.setToNode(t)},n.PathLink.allLinkTypes=["extend.x","extend.y","extend.z","extend.x.n","extend.y.n","extend.z.n","orthogonal.x","orthogonal.y","orthogonal.z","orthogonal.x.n","orthogonal.y.n","orthogonal.z.n","flex.x","flex.y","flex.z","flex.yz","flex.xz","flex.xy"],n.extend(n.PathLink,n.PathNode,{className:"TGL.PathLink",___accessor:["linkType","extend","controls","fromOffset","toOffset"],__SizePropeties:["fromOffset","toOffset","path","segments","radius","segmentsR","startCap","endCap","shape","startCapSize","endCapSize","segmentsCap","arc","arcStart","cutSurface","startCapR","endCapR","startCapExtend","endCapExtend","fromNode","toNode","linkType","extend","controls"],setFromNode:function(e){if(this._fromNode!=e){var t=this._fromNode;this._fromNode=e,this._dirtyPath=!0,this.onPropertyChange("fromNode",t,e),this.firePropertyChange("fromNode",t,e),t,this._fromNode=e,t&&(t._removeFromLink(this),t.removePropertyChangeListener(this.handleNodePropertyChange)),this._fromNode&&(this._fromNode._addFromLink(this),this._fromNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getFromNode:function(){return this._fromNode},setToNode:function(e){if(this._toNode!=e){var t=this._toNode;this._toNode=e,this.onPropertyChange("toNode",t,e),this.firePropertyChange("toNode",t,e),t&&(t.removePropertyChangeListener(this.handleNodePropertyChange),t._removeToLink(this)),this._toNode&&(this._toNode._addToLink(this),this._toNode.addPropertyChangeListener(this.handleNodePropertyChange,this))}},getToNode:function(){return this._toNode},isLooped:function(){return this._fromNode===this._toNode&&this._fromNode!=null&&this._toNode!=null},handleNodePropertyChange:function(e){var t=e.source,n=e.property;if(n.startsWith("position")||n.startsWith("rotation")||n.startsWith("scale")||n=="worldMatrix"||n==="linkAgent"||t.isSizeChangedProperty(n)||n==="parent"){var r=this.vertices;this._dirtyPath=!0;var i=this;D.PATH_LINK_COMPUTE_DELAY?setTimeout(function(){i._computePath()},10):i._computePath()}},_resetPath:function(){if(!this.path)return;var e=!1;if(this.endCap!=="arrow")return this.path;if(this.endCapExtend*this.endCapR>1)return this.path;e=!0;var t=this.path,r=new n.Path,i,s,u=t.actions.length,a=null,f;for(s=0;s<u-1;s++)i=t.actions[s],f=i.args,a=new n.XiangliangThree(f[0],f[1],f[2]),i.action==="moveTo"?r.moveTo(f[0],f[1],f[2]):i.action==="lineTo"?r.lineTo(f[0],f[1],f[2]):i.action==="quadraticCurveTo"&&(r.curveTo(f[0],f[1],f[2],f[3],f[4],f[5]),a=new n.XiangliangThree(f[3],f[4],f[5]));s=u-1,i=t.actions[s],f=i.args;if(i.action==="lineTo"){var l=new n.XiangliangThree(f[0],f[1],f[2]),c=(new o).subVectors(l,a).normalize(),u=this.radius*this.endCapSize,h=null;(new o).subVectors(l,a).length()<u?h=a.add(c.multiplyScalar(.1)):h=l.clone().sub(c.multiplyScalar(u)),r.lineTo(h.x,h.y,h.z)}return r},_getNodeOffset:function(e,t,n){t=e.worldToLocal(t.clone()),n=e.worldToLocal(n.clone());var r=(new o).subVectors(n,t),i=r.length(),s=e.getLinkOffset(r);return s&&s.length()>i&&s.normalize().multiplyScalar(i-.1),s||new o(0,0,0)},updateMatrix:function(){},updateWorldMatrix:function(e,t){},onPropertyChange:function(e,t,r){if(e==="fromNode"||e==="toNode"||e==="linkType"||e==="extend"||e==="controls"||e==="fromOffset"||e==="toOffset")this._dirtyPath=!0;n.Node.prototype.onPropertyChange.call(this,e,t,r)},computeData:function(){return this._computePath(),n.PathNode.prototype.computeData.call(this)},_clearFromNodeExtend:function(e,t,n){},_flex:function(e,t,n,r,i){e=e.substr(e.indexOf(".")+1);var s=["x","y","z"],u,a=new o,f=new o;for(var l=0;l<3;l++)u=s[l],a[u]=u===e?r[u]:t[u],f[u]=u===e?r[u]:n[u];i.push(a,f)},_flex2:function(e,t,n,r){e=e.substr(e.indexOf(".")+1);var i=["x","y","z"],s=e[0],o=e[1];if(t[s]!=n[s]){var u=new mono.XiangliangThree;for(var a=0;a<i.length;a++)u[i[a]]=i[a]==s?n[i[a]]:t[i[a]];r.push(u)}if(t[o]!=n[o]){var f=new mono.XiangliangThree;for(var a=0;a<i.length;a++)f[i[a]]=i[a]==s||i[a]==o?n[i[a]]:t[i[a]];r.push(f)}},_orthogonal:function(e,t,n,r){e=e.substr(e.indexOf(".")+1);var i=!1,s=["x","y","z"],u,a=new o,f=0;e.endsWith(".n")&&(i=!0,e=e[0]);var l=i?t[e]:n[e];for(var c=0;c<s.length;c++)u=s[c],u!==e&&t[u]==n[u]&&f++;if(f===2)return;for(var c=0;c<s.length;c++)u=s[c],u!==e?a[u]=l:a[u]=i?n[u]:t[u];r.push(a)},_removeSamePoint:function(e){},_computePath:function(){if(!this._dirtyPath)return;this._dirtyPath=!1;if(this._fromNode==null||this._toNode==null)return;this._extend==null&&(this._extend=0);var e=this._fromNode.getLinkAgent()||this._fromNode,t=this._toNode.getLinkAgent()||this._toNode,r=e.localToWorld2(new o(0,0,0)),i=t.localToWorld2(new o(0,0,0));if(e==t){var s=new mono.Path;return s.moveTo(r.x,r.y,r.z),s.lineTo(r.x,r.y+200,r.z),s.lineTo(r.x+200,r.y+200,r.z),s.lineTo(r.x+200,r.y,r.z),s.lineTo(r.x,r.y,r.z),this.setPath(s),s}if(r.equals(i)){this.setPath(null);return}var s,u=[],a=this.radius*this.endCapSize,f;if(this._linkType&&this._linkType.startsWith("extend")){var r,i,l,c=[],h,p,d,v;if(this._linkType==="extend.x"){l=new o(1,0,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.max(r.x,i.x),d=v+this._extend+a+.1,h=new o(d,r.y,r.z),p=new o(d,i.y,i.z)}else if(this._linkType==="extend.y"){l=new o(0,1,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.max(r.y,i.y),d=v+this._extend+a+.1,h=new o(r.x,d,r.z),p=new o(i.x,d,i.z)}else if(this._linkType==="extend.z"){l=new o(0,0,1);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.max(r.z,i.z),d=v+this._extend+a+.1,h=new o(r.x,r.y,d),p=new o(i.x,i.y,d)}else if(this._linkType==="extend.x.n"){l=new o(-1,0,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.min(r.x,i.x),d=v-this._extend-a-.1,h=new o(d,r.y,r.z),p=new o(d,i.y,i.z)}else if(this._linkType==="extend.y.n"){l=new o(0,-1,0);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.min(r.y,i.y),d=v-this._extend-a-.1,h=new o(r.x,d,r.z),p=new o(i.x,d,i.z)}else if(this._linkType==="extend.z.n"){l=new o(0,0,-1);var r=e.localToWorld2(e.getLinkExtend(l.clone())),i=t.localToWorld2(t.getLinkExtend(l));v=Math.min(r.z,i.z),d=v-this._extend-a-.1,h=new o(r.x,r.y,d),p=new o(i.x,i.y,d)}h?u.push(r,h,p,i):u.push(r,i)}else{u.push(r);if(this._linkType==="orthogonal.x"){if(r.y!=i.y||r.z!=i.z){var m=i.x,g=new o(m,r.y,r.z);u.push(g)}}else if(this._linkType==="orthogonal.x.n"){var m=r.x,g=new o(m,i.y,i.z);u.push(g)}else if(this._linkType==="orthogonal.y"){var y=i.y,g=new o(r.x,y,r.z);u.push(g)}else if(this._linkType==="orthogonal.y.n"){var y=r.y,g=new o(i.x,y,i.z);u.push(g)}else if(this._linkType==="orthogonal.z"){var g=new o(r.x,r.y,i.z);u.push(g)}else if(this._linkType==="orthogonal.z.n"){var g=new o(i.x,i.y,r.z);u.push(g)}var b=(new o(r.x+i.x,r.y+i.y,r.z+i.z)).multiplyScalar(.5);(this._linkType==="flex.x"||this._linkType==="flex.y"||this._linkType==="flex.z")&&this._flex(this._linkType,r,i,b,u),(this._linkType==="flex.yz"||this._linkType==="flex.zy"||this._linkType==="flex.xy"||this._linkType==="flex.yx"||this._linkType==="flex.xz"||this._linkType==="flex.zx")&&this._flex2(this._linkType,r,i,u);if(this._linkType==="control"){var w=this.getControls();P.isArray(w)&&(u=u.concat(w))}u.push(i),f=u.length;var E=this._getNodeOffset(e,u[0].clone(),u[1].clone()),S=this._getNodeOffset(t,u[f-1].clone(),u[f-2].clone());r=e.localToWorld2(E),i=t.localToWorld2(S),u[0]=r,u[f-1]=i}var f=u.length,x=this.getFromOffset(),T=this.getToOffset();x&&u[0].add(x),T&&u[f-1].add(T);var s=new n.Path,N;for(var C=0;C<f;C++)N=u[C],C===0?s.moveTo(N.x,N.y,N.z):s.lineTo(N.x,N.y,N.z);return this.setPath(s),s}}),n.Serva=function(e){n.Serva.superClass.constructor.apply(this,arguments),arguments.length===1&&(this._name=e),this._dataList=new N,this._dataMap={},this._rootList=new N,this._rootMap={},this._clientMap={},this._lightList=new N,this._billboardList=new N,this._nodeList=new N,this._annotationList=new N,this._particleList=new N,this.nodes=[],this.particles=[],this.billboards=[],this._dataBoxChangeDispatcher=new n.EventDispatcher,this._dataPropertyChangeDispatcher=new n.EventDispatcher,this._groupLists={},this.selection=new N,this instanceof n.AlarmBox||(this._selectionContainer=new n.SelectionContainer(this),this._alarmBox=new n.AlarmBox(this),this._alarmStatePropagator=new n.AlarmStatePropagator(this),this._alarmStatePropagator.setEnable(!0)),this.batch=!1,this._clientMap={}},n.extend(n.Serva,n.PropertyChangeDispatcher,{constructor:n.Serva,className:"TGL.Serva",___accessor:["name"],add:function(e,t){if(!e)return;arguments.length===1&&(t=-1);var r=e.getId();if(this._dataMap.hasOwnProperty(r))throw"Data with ID '"+r+"' already exists";this._dataMap[r]=e,this._dataList.add(e),e.getParent()||(this._rootMap[r]=e,t>=0?this._rootList.add(e,t):this._rootList.add(e)),e instanceof n.Billboard?this._billboardList.add(e):e instanceof n.Node?this._nodeList.add(e):e instanceof n.Particle?this._particleList.add(e):e instanceof n.Annotation?this._annotationList.add(e):e instanceof n.Light&&this._lightList.add(e),this._dataBoxChangeDispatcher.fire({kind:"add",data:e,source:this}),e.getGroupId()&&this.groupElements(e,null,e.getGroupId()),e.addPropertyChangeListener(this.handleDataPropertyChange,this),e._selected=!1},addByDescendant:function(e){e&&(this.add(e),e.getChildren().size()>0&&e.getChildren().forEach(function(e){this.addByDescendant(e)},this))},getAlarmBox:function(){return this._alarmBox},removeById:function(e,t){var n=this.getDataById(e);this.remove(n,t)},remove:function(e,t){if(!e)return;e instanceof n.Link&&(e.setFromNode(null),e.setToNode(null)),e instanceof n.Node&&e.getLinks()&&e.getLinks().toList().forEach(function(e){this.remove(e)},this),t&&(e.getChildren().forEach(function(t){e.removeChild(t)},this),e.getParent()&&e.getParent().removeChild(e)),this._dataList.remove(e);var r=e._id;delete this._dataMap[r],this._rootMap[r]&&(delete this._rootMap[r],this._rootList.remove(e)),e instanceof n.Billboard?this._billboardList.remove(e):e instanceof n.Node?this._nodeList.remove(e):e instanceof n.Particle?this._particleList.remove(e):e instanceof n.Annotation?this._annotationList.remove(e):e instanceof n.Light&&this._lightList.remove(e),e.getGroupId()&&this.groupElements(e,e.getGroupId(),null),e.removePropertyChangeListener(this.handleDataPropertyChange,this),this._dataBoxChangeDispatcher.fire({kind:"remove",data:e,source:this}),this._selectionContainer&&this._selectionContainer.removeSelection(e)},removeByDescendant:function(e,t){if(!e)return;var n=this;e.hasChildren()&&e.getChildren().forEachReverse(function(e){n.removeByDescendant(e,t)}),this.remove(e,t)},containsById:function(e){return this._dataMap.hasOwnProperty(e)},contains:function(e){return e?this._dataMap[e._id]===e:!1},lightsSize:function(){return this._lightList.size()},getLights:function(){return this._lightList},getLightsArray:function(){return this._lightList.toArray()},getAnnotations:function(){return this._annotationList},clear:function(e){if(this._dataList.size()>0){var t=this._dataList.toList(function(t){return!this._lightList.contains(t)||e},this);t.forEach(function(e){e.removePropertyChangeListener(this.handleDataPropertyChange,this)},this),this._dataList.clear(),this._dataMap={},this._rootList.clear(),this._rootMap={},this._nodeList.clear(),this._billboardList.clear();if(e)this._lightList.clear();else{var n=this;this._lightList.forEach(function(e){n._dataList.add(e);var t=e.getId();n._dataMap[t]=e,e.getParent()==null&&(n._rootList.add(e),n._rootMap[t]=e)})}this._dataBoxChangeDispatcher.fire({kind:"clear",datas:t}),this.clearSelection()}},startBatch:function(){this.batch=!0},endBatch:function(){this.batch=!1,this._dataBoxChangeDispatcher.fire({kind:"batchEnd"})},removeSelection:function(){var e=this._selectionContainer.toSelection();e.forEach(function(e){this.remove(e)},this)},clearSelection:function(){this._selectionContainer&&this._selectionContainer.clearSelection()},clearEditing:function(){this._nodeList.forEach(function(e){e.editing=!1}),this._billboardList.forEach(function(e){e.editing=!1})},getDataById:function(e){return this._dataMap[e]},groupElements:function(e,t,n){var r;t&&(r=this._groupLists[t],r&&(r.remove(e),r.isEmpty()&&delete this._groupLists[t])),n&&(r=this._groupLists[n],r==null&&(r=new N,this._groupLists[n]=r),r.contains(e)||r.add(e))},synchronizeGroup:function(e,t,r,i){if(this.isAdjustingGroup)return;this.isAdjustingGroup=!0;var s=e.getGroupId(),o=new n.XiangliangThree;if(s){var u=this._groupLists[s];u&&u.size()>1&&u.forEach(function(s){s!==e&&!s.isDescendantOf(e)&&!e.isDescendantOf(s)&&(o.subVectors(r,t),s[n.setter(i)](s[n.getter(i)]().clone().add(o)))})}this.isAdjustingGroup=!1},handleDataPropertyChange:function(e){var t=e.source;if(e.property==="parent"){var n=t.getId();t.getParent()?this._rootMap[n]&&(delete this._rootMap[n],this._rootList.remove(t)):this._rootMap[n]||(this._rootMap[n]=t,this._rootList.add(t))}else if(e.property==="groupId"){var r=e.oldValue,i=e.newValue;this.groupElements(t,r,i)}else e.property==="position"||e.property==="scale"||e.property==="rotation"?this.synchronizeGroup(t,e.oldValue,e.newValue,e.property):e.property==="selected"&&(t._selected?this._selectionContainer.appendSelection(t):this._selectionContainer.removeSelection(t));this.onDataPropertyChanged(t,e),this._dataPropertyChangeDispatcher.fire(e)},onDataPropertyChanged:function(e,t){},addServaChangeListener:function(e,t,n){this._dataBoxChangeDispatcher.add(e,t,n)},removeServaChangeListener:function(e,t){this._dataBoxChangeDispatcher.remove(e,t)},addDataPropertyChangeListener:function(e,t,n){this._dataPropertyChangeDispatcher.add(e,t,n)},removeDataPropertyChangeListener:function(e,t){this._dataPropertyChangeDispatcher.remove(e,t)},allocateLights:function(){var e,t,r,i,s,o,u,r;i=s=o=u=0;var a=this._lightList;for(e=0,t=a.size();e<t;e++){r=a.get(e);if(r.onlyShadow)continue;r instanceof n.DirectionalLight&&i++,r instanceof n.PointLight&&s++,r instanceof n.SpotLight&&o++}return{directional:i,point:s,spot:o,hemi:u}},allocateShadows:function(){var e,t,r,i=0,s=this._lightList;for(e=0,t=s.size();e<t;e++){r=s.get(e);if(!r.castShadow)continue;r instanceof n.SpotLight&&i++,r instanceof n.DirectionalLight&&!r.shadowCascade&&i++}return i},allocatePointShadows:function(){var e,t,r,i=0,s=this._lightList;for(e=0,t=s.size();e<t;e++){r=s.get(e);if(!r.castShadow)continue;r instanceof n.PointLight&&i++}return i},getSelectionContainer:function(){return this._selectionContainer},size:function(){return this._dataList.size()},isEmpty:function(){return this._dataList.isEmpty()},getLimit:function(){return this._limit},setLimit:function(e){var t=this._limit;this._limit=e,this.firePropertyChange("limit",t,e),this._checkLimit()},_checkLimit:function(){this._limit>=0&&this.size()>this._limit&&this.removeFirst(this.size()-this._limit)},removeFirst:function(e){arguments.length===0&&(e=1);while(e>0&&this._dataList.size()>0){var t=this._dataList.get(0);this.remove(t),e--}},getSiblings:function(e){if(!this.contains(e))throw e+" dosen't belong to this dataBox";var t=e.getParent();return t?t.getChildren():this._rootList},getRoots:function(){return this._rootList},getSiblingIndex:function(e){return e.getParent()?e.getParent().getChildren().indexOf(e):this._rootList.indexOf(e)},getNodes:function(){return this._nodeList},getBillboards:function(){return this._billboardList},getDatas:function(){return this._dataList},getDataAt:function(e){return this._dataList.get(e)},toDatas:function(e,t){return this._dataList.toList(e,t)},forEach:function(e,t){this._dataList.forEach(e,t)},forEachReverse:function(e,t){this._dataList.forEachReverse(e,t)},forEachByDepthFirst:function(e,t,n){if(t)this._depthFirst(e,t,n);else{var r=this._rootList.size();for(var i=0;i<r;i++){var s=this._rootList.get(i);if(this._depthFirst(e,s,n)===!1)return}}},_depthFirst:function(e,t,n){var r=t.getChildrenSize();for(var i=0;i<r;i++){var s=t.getChildAt(i);if(this._depthFirst(e,s,n)===!1)return!1}if(n){if(e.call(n,t)===!1)return!1}else if(e(t)===!1)return!1},forEachByBreadthFirst:function(e,t,n){var r=new N;t?r.add(t):this._rootList.forEach(r.add,r);while(r.size()>0){t=r.removeAt(0),t.getChildren().forEach(r.add,r);if(n){if(e.call(n,t)===!1)return}else if(e(t)===!1)return}},getAlarmStatePropagator:function(){return this._alarmStatePropagator},setAlarmStatePropagator:function(e){if(this._alarmStatePropagator==e)return;this._alarmStatePropagator&&this._alarmStatePropagator.setEnable(!1),this._alarmStatePropagator=e,this._alarmStatePropagator.setEnable(!0)},setClient:function(e,t){if(e==null)return this;this._clientMap==null&&(this._clientMap=new Object);var n=this._clientMap[e];if(n===t)return;return t==null?delete this._clientMap[e]:this._clientMap[e]=t,this._clientMap[e]=t,this.firePropertyChange("C:"+e,n,t),this},getClient:function(e){return this._clientMap[e]}}),n.QuickFinder=function(e,t,r,i,s){this._map={};if(!e)throw"dataBox can not be null";if(!t)throw"propertyName can not be null";this._dataBox=e,this._propertyName=t,this._propertyType=r||"accessor",this._propertyType==="accessor"&&(this._getter=n.getter(t)),this._valueFunction=i||this.getValue,this._filterFunction=s||this.isInterested,this._dataBox.forEach(this._addData,this),this._dataBox.addServaChangeListener(this.handleServaChange,this,!0),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this,!0)},n.extend(n.QuickFinder,Object,{_NULL_:"mono-null-key",getValueFunction:function(){return this._valueFunction},getFilterFunction:function(){return this._filterFunction},handleServaChange:function(e){e.kind==="add"?this._addData(e.data):e.kind==="remove"?this._removeData(e.data):e.kind==="clear"&&(this._map={})},handleDataPropertyChange:function(e){if(!this._filterFunction.call(this,e.source))return;if(this._propertyType!=="accessor"||this._propertyName!==e.property)if(this._propertyType!=="style"||!e.source.IStyle||"S:"+this._propertyName!==e.property)if(this._propertyType!=="client"||"C:"+this._propertyName!==e.property)return;var t=this._getMap(e.oldValue);t&&t.remove(e.source),this._addData(e.source)},_getMap:function(e){return e=e==null?this._NULL_:e,this._map[e]},find:function(e){var t=this._getMap(e);return t?t.toList():new N},findFirst:function(e){var t=this._getMap(e);return!t||t.isEmpty()?null:t.get(0)},_addData:function(e){if(!this._filterFunction.call(this,e))return;var t=this._valueFunction.call(this,e),n=this._getMap(t);n||(n=new N,t=t==null?this._NULL_:t,this._map[t]=n),n.add(e)},_removeData:function(e){if(!this._filterFunction.call(this,e))return;var t=this._valueFunction.call(this,e),n=this._getMap(t);n&&(n.remove(e),n.isEmpty()&&(t=t==null?this._NULL_:t,delete this._map[t]))},dispose:function(){this._dataBox.removeServaChangeListener(this.handleServaChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this),delete this._dataBox},getServa:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isInterested:function(e){return this._propertyType==="style"&&!e.IStyle?!1:this._propertyType==="accessor"&&this._valueFunction===this.getValue&&!e[this._getter]?!1:!0},getValue:function(e){return this._propertyType==="accessor"?e[this._getter]():this._propertyType==="style"&&e.getStyle?e.getStyle(this._propertyName):this._propertyType==="client"&&e.getClient?e.getClient(this._propertyName):null}}),n.SelectionContainer=function(e){n.SelectionContainer.superClass.constructor.apply(this,arguments),this._selectionMode="multipleSelection",this._selectionList=new N,this._selectionChangeDispatcher=new n.EventDispatcher,this._selectionMap={},this._setServa(e)},n.extend(n.SelectionContainer,n.PropertyChangeDispatcher,{getSelectionMode:function(){return this._selectionMode},setSelectionMode:function(e){if(this._selectionMode===e)return;if(e!=="noneSelection"&&e!=="singleSelection"&&e!=="multipleSelection")return;this.clearSelection();var t=this._selectionMode;this._selectionMode=e,this.firePropertyChange("selectionMode",t,this._selectionMode)},getServa:function(){return this._dataBox},_setServa:function(e){if(!e)throw"dataBox can not be null";if(this._dataBox===e)return;this._dataBox&&(this.clearSelection(),this._dataBox.removeServaChangeListener(this.handleServaChange,this));var t=this._dataBox;this._dataBox=e,this._dataBox.addServaChangeListener(this.handleServaChange,this,!0),this.firePropertyChange("dataBox",t,this._dataBox)},dispose:function(){this.clearSelection(),this._dataBox.removeServaChangeListener(this.handleServaChange,this)},handleServaChange:function(e){if(e.kind==="remove"){var t=e.data;this.contains(t)&&(this._selectionList.remove(t),delete this._selectionMap[t.getId()],this.fireSelectionChange("remove",new N(t))),t._selected=!1}else e.kind==="clear"&&this.clearSelection()},getFilterFunction:function(){return this._filterFunction},setFilterFunction:function(e){if(this._filterFunction===e)return;this.clearSelection();var t=this._filterFunction;this._filterFunction=e,this.firePropertyChange("filterFunction",t,this._filterFunction)},fireSelectionChange:function(e,t,n){n&&(this._selectionList.forEach(function(e){n.contains(e)?n.remove(e):n.add(e)}),t=n.toList()),this._selectionChangeDispatcher.fire({kind:e,datas:new N(t)})},addSelectionChangeListener:function(e,t,n){this._selectionChangeDispatcher.add(e,t,n)},removeSelectionChangeListener:function(e,t){this._selectionChangeDispatcher.remove(e,t)},_filterList:function(e,t){var n=new N(e);for(var r=0;r<n.size();r++){var i=n.get(r);if(this._filterFunction&&!this._filterFunction(i)||t&&this.contains(i)||!t&&!this.contains(i)||!this._dataBox.contains(i))n.removeAt(r),r--}return n},appendSelection:function(e){if(this._selectionMode==="noneSelection")return;var t=this._filterList(e,!0);if(t.isEmpty())return;var n=null;this._selectionMode==="singleSelection"&&(n=new N(this._selectionList),this._selectionList.forEach(function(e){e._selected=!1}),this._selectionList.clear(),this._selectionMap={},t=new N(t.get(t.size()-1)));for(var r=0;r<t.size();r++){var i=t.get(r);i._selected=!0,this._selectionList.add(i),this._selectionMap[i._id]=i}this.fireSelectionChange("append",t,n)},removeSelection:function(e){var t=this._filterList(e);if(t.size()===0)return;for(var n=0;n<t.size();n++){var r=t.get(n);r._selected=!1,this._selectionList.remove(r),delete this._selectionMap[r.getId()]}this.fireSelectionChange("remove",t)},toSelection:function(e,t){return this._selectionList.toList(e,t)},getSelection:function(){return this._selectionList},setSelection:function(e){if(this._selectionMode==="noneSelection")return;if(this._selectionList.size()===0&&e==null)return;var t=new N(this._selectionList);this._selectionList.clear(),this._selectionMap={};var n=this._filterList(e,!0);this._selectionMode==="singleSelection"&&n.size()>1&&(n=new N(n.get(n.size()-1)));for(var r=0;r<n.size();r++){var i=n.get(r);i._selected=!0,this._selectionList.add(i),this._selectionMap[i.getId()]=i}this.fireSelectionChange("set",null,t)},clearSelection:function(){if(this._selectionList.size()>0){var e=this._selectionList.toList();this._selectionList.forEach(function(e){e._selected=!1}),this._selectionList.clear(),this._selectionMap={},this.fireSelectionChange("clear",e)}},selectAll:function(){if(this._selectionMode==="noneSelection")return;var e=this._dataBox.toDatas(),t=0,n=null;if(this._filterFunction)for(t=0;t<e.size();t++)n=e.get(t),this._filterFunction(n)||(e.removeAt(t),t--);var r=new N(this._selectionList);this._selectionList.clear(),this._selectionMap={},this._selectionMode==="singleSelection"&&e.size()>1&&(e=new N(e.get(e.size()-1)));for(t=0;t<e.size();t++)n=e.get(t),this._selectionList.add(n),this._selectionMap[n.getId()]=n;this.fireSelectionChange("all",null,r)},size:function(){return this._selectionList.size()},contains:function(e){return e?this._selectionMap[e._id]!=null:!1},getLastData:function(){return this._selectionList.size()>0?this._selectionList.get(this._selectionList.size()-1):null},getFirstData:function(){return this._selectionList.size()>0?this._selectionList.get(0):null},isSelectable:function(e){return e?this._selectionMode==="noneSelection"?!1:this._filterFunction&&!this._filterFunction(e)?!1:!0:!1}}),n.AlarmSeverity=function(e,t,n,r,i){this.value=e,this.name=t,this.nickName=n,this.color=r,this.displayName=i},n.extend(n.AlarmSeverity,Object,{toString:function(){return this.displayName?this.displayName:this.name}}),function(){var e=n.AlarmSeverity;e.severities=new N,e._vm={},e._nm={},e._cp=function(e,t){if(e&&t){var n=e.value-t.value;return n>0?1:n<0?-1:0}return e&&!t?1:!e&&t?-1:0},e.forEach=function(t,n){e.severities.forEach(t,n)},e.getSortFunction=function(){return e._cp},e.setSortFunction=function(t){e._cp=t,e.severities.sort(t)},e.add=function(t,n,r,i,s){var o=new e(t,n,r,i,s);return e._vm[t]=o,e._nm[n]=o,e.severities.add(o),e.severities.sort(e._cp),o},e.remove=function(t){var n=e._nm[t];return n&&(delete e._nm[t],delete e._vm[n.value],e.severities.remove(n)),n},e.CRITICAL=e.add(500,"Critical","C","#FF0000"),e.MAJOR=e.add(400,"Major","M","#FFA000"),e.MINOR=e.add(300,"Minor","m","#FFFF00"),e.WARNING=e.add(200,"Warning","W","#00FFFF"),e.INDETERMINATE=e.add(100,"Indeterminate","N","#C800FF"),e.CLEARED=e.add(0,"Cleared","R","#00FF00"),e.isClearedAlarmSeverity=function(e){return e?e.value===0:!1},e.getByName=function(t){return e._nm[t]},e.getByValue=function(t){return e._vm[t]},e.clear=function(){e.severities.clear(),e._vm={},e._nm={}},e.compare=function(t,n){return e._cp(t,n)}}(),n.AlarmState=function(e){this._e=e,this._nm={},this._am={},this._ps=null,this._haa=null,this._hna=null,this._hoa=null,this._hta=null,this._hls=!1,this._aac=0,this._nac=0},n.extend(n.AlarmState,Object,{_ep:!0,_f:function(){this._c1(),this._c2(),this._c3(),this._c4(),this._c5(),this._c6(),this._c7(),this._e.firePropertyChange("alarmState",null,this)},getHighestAcknowledgedAlarmSeverity:function(){return this._haa},getHighestNewAlarmSeverity:function(){return this._hna},getHighestOverallAlarmSeverity:function(){return this._hoa},getHighestNativeAlarmSeverity:function(){return this._hta},hasLessSevereNewAlarms:function(){return this._hls},_c1:function(){var e=null;for(var t in this._am){t=n.AlarmSeverity.getByName(t);if(n.AlarmSeverity.isClearedAlarmSeverity(t))continue;if(this.getAcknowledgedAlarmCount(t)===0)continue;e?e=n.AlarmSeverity.compare(e,t)>0?e:t:e=t}this._haa=e},_c2:function(){var e=null;for(var t in this._nm){t=n.AlarmSeverity.getByName(t);if(n.AlarmSeverity.isClearedAlarmSeverity(t))continue;if(this.getNewAlarmCount(t)===0)continue;e?e=n.AlarmSeverity.compare(e,t)>0?e:t:e=t}this._hna=e},_c3:function(){if(!this._hna){this._hls=!1;return}for(var e in this._nm){e=n.AlarmSeverity.getByName(e);if(n.AlarmSeverity.isClearedAlarmSeverity(e))continue;if(this.getNewAlarmCount(e)===0)continue;if(n.AlarmSeverity.compare(this._hna,e)>0){this._hls=!0;return}}this._hls=!1},_c4:function(){var e=this._haa,t=this._hna,r=this._ps;this._hoa=e,n.AlarmSeverity.compare(t,this._hoa)>0&&(this._hoa=t),n.AlarmSeverity.compare(r,this._hoa)>0&&(this._hoa=r)},_c5:function(){var e=this._haa,t=this._hna;this._hta=e,n.AlarmSeverity.compare(t,this._hta)>0&&(this._hta=t)},increaseAcknowledgedAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._am[e.name];n==null&&(n=0),n+=t,this._am[e.name]=n,this._f(),this._e.onAlarmChange()},increaseNewAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._nm[e.name];n==null&&(n=0),n+=t,this._nm[e.name]=n,this._f(),this._e.onAlarmChange()},decreaseAcknowledgedAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._am[e.name];n==null&&(n=0),n-=t;if(n<0)throw"Alarm count can not be negative";this._am[e.name]=n,this._f(),this._e.onAlarmChange()},decreaseNewAlarm:function(e,t){t==null&&(t=1);if(t===0)return;var n=this._nm[e.name];n==null&&(n=0),n-=t;if(n<0)throw"Alarm count can not be negative";this._nm[e.name]=n,this._f(),this._e.onAlarmChange()},acknowledgeAlarm:function(e){this.decreaseNewAlarm(e,1),this.increaseAcknowledgedAlarm(e,1)},acknowledgeAllAlarms:function(e){if(e){var t=this.getNewAlarmCount(e);this.decreaseNewAlarm(e,t),this.increaseAcknowledgedAlarm(e,t)}else for(var r in this._nm)this.acknowledgeAllAlarms(n.AlarmSeverity.getByName(r))},_c6:function(){this._aac=0;for(var e in this._am)e=n.AlarmSeverity.getByName(e),this._aac+=this.getAcknowledgedAlarmCount(e)},getAcknowledgedAlarmCount:function(e){if(e){var t=this._am[e.name];return t==null?0:t}return this._aac},getAlarmCount:function(e){return this.getAcknowledgedAlarmCount(e)+this.getNewAlarmCount(e)},_c7:function(){this._nac=0;for(var e in this._nm)e=n.AlarmSeverity.getByName(e),this._nac+=this.getNewAlarmCount(e)},getNewAlarmCount:function(e){if(e){var t=this._nm[e.name];return t==null?0:t}return this._nac},setNewAlarmCount:function(e,t){this._nm[e.name]=t,this._f()},removeAllNewAlarms:function(e){e?delete this._nm[e]:this._nm={},this._f()},setAcknowledgedAlarmCount
:function(e,t){this._am[e.name]=t,this._f()},removeAllAcknowledgedAlarms:function(e){e?delete this._am[e.name]:this._am={},this._f()},isEmpty:function(){return this._hoa==null},clear:function(){this._am={},this._nm={},this._f()},getPropagateSeverity:function(){return this._ps},setPropagateSeverity:function(e){this._ep||(e=null);if(this._ps===e)return;var t=this._ps;this._ps=e,this._f(),this._e.onAlarmChange(),this._e.firePropertyChange("propagateSeverity",t,e)},isEnablePropagation:function(){return this._ep},setEnablePropagation:function(e){var t=this._ep;this._ep=e,this._e.firePropertyChange("enablePropagation",t,e)&&(e||this.setPropagateSeverity(null))}}),n.Alarm=function(e,t,r,i,s){n.Data.call(this,e),this._id=e!=null?e:n.id("A"),this._elementId=t,this._alarmSeverity=r,this._acked=i||!1,this._cleared=s||!1},n.extend(n.Alarm,n.Data,{IAlarm:!0,getElementId:function(){return this._elementId},___accessor:["acked","cleared","alarmSeverity"]}),n.AlarmBox=function(e){if(!e)throw"elementBox can not be null.";n.AlarmBox.superClass.constructor.call(this),this._elementBox=e,this._alarmElementMapping=new n.AlarmElementMapping(this,e),this._elementBox.addServaChangeListener(this.handleElementBoxChange,this,!0),this.addServaChangeListener(this.handleAlarmBoxChange,this,!0),this.addDataPropertyChangeListener(this.handleAlarmPropertyChange,this,!0)},n.extend(n.AlarmBox,n.Serva,{__accessor:["removeAlarmWhenElementIsRemoved"],_name:"AlarmBox",_removeAlarmWhenAlarmIsCleared:!1,_removeAlarmWhenElementIsRemoved:!0,getElementBox:function(){return this._elementBox},isRemoveAlarmWhenAlarmIsCleared:function(){return this._removeAlarmWhenAlarmIsCleared},setRemoveAlarmWhenAlarmIsCleared:function(e){var t=this._removeAlarmWhenAlarmIsCleared;this._removeAlarmWhenAlarmIsCleared=e,this.firePropertyChange("removeAlarmWhenAlarmIsCleared",t,e);if(e)for(var n in this.datas){var r=this.datas[n];r.isCleard()&&this.remove(r)}},getAlarmElementMapping:function(){return this._alarmElementMapping},setAlarmElementMapping:function(e){if(!e)throw"alarmElementMapping can not be null";if(this._alarmElementMapping===e)return;var t=this._alarmElementMapping;this.getDatas().forEach(this._decreaseAlarmState,this),this._alarmElementMapping=e,this.getDatas().forEach(this._increaseAlarmState,this),this.firePropertyChange("alarmElementMapping",t,e)},handleElementBoxChange:function(e){e.kind==="add"?this.handleElementAdded(e.data):e.kind==="remove"?(this.handleElementRemoved(e.data),this._removeAlarmWhenElementIsRemoved&&this.removeAlarmsByElement(e.data)):e.kind==="clear"&&(e.datas.forEach(this.handleElementRemoved,this),this._removeAlarmWhenElementIsRemoved&&this.clear())},handleAlarmBoxChange:function(e){e.kind==="add"?this._increaseAlarmState(e.data):e.kind==="remove"?this._decreaseAlarmState(e.data):e.kind==="clear"&&e.datas.forEach(this._decreaseAlarmState,this)},handleAlarmPropertyChange:function(e){var t=e.source;t.isCleared()||(e.property==="alarmSeverity"?this.handleAlarmSeverityChange(t,e):e.property==="acked"&&this.handleAckedChange(t,e)),e.property==="cleared"&&(t.isCleared()?(this._decreaseAlarmState(t,!0),this._removeAlarmWhenAlarmIsCleared&&this.remove(t)):this._increaseAlarmState(t,!0))},handleAckedChange:function(e,t){if(!e.getAlarmSeverity())return;var n=this.getCorrespondingElements(e);if(n)for(var r=0;r<n.size();r++){var i=n.get(r);t.oldValue?i.getAlarmState().decreaseAcknowledgedAlarm(e.getAlarmSeverity()):i.getAlarmState().decreaseNewAlarm(e.getAlarmSeverity()),t.newValue?i.getAlarmState().increaseAcknowledgedAlarm(e.getAlarmSeverity()):i.getAlarmState().increaseNewAlarm(e.getAlarmSeverity())}},handleAlarmSeverityChange:function(e,t){var n=t.oldValue,r=t.newValue,i=this.getCorrespondingElements(e);if(i)for(var s=0;s<i.size();s++){var o=i.get(s);n&&(e.isAcked()?o.getAlarmState().decreaseAcknowledgedAlarm(n):o.getAlarmState().decreaseNewAlarm(n)),r&&(e.isAcked()?o.getAlarmState().increaseAcknowledgedAlarm(r):o.getAlarmState().increaseNewAlarm(r))}},getCorrespondingAlarms:function(e){return this._alarmElementMapping.getCorrespondingAlarms(e)},getCorrespondingElements:function(e){return this._alarmElementMapping.getCorrespondingElements(e)},handleElementAdded:function(e){var t=this.getCorrespondingAlarms(e);if(t)for(var n=0;n<t.size();n++){var r=t.get(n);if(r.isCleared())continue;var i=r.getAlarmSeverity();i&&(r.isAcked()?e.getAlarmState().increaseAcknowledgedAlarm(i):e.getAlarmState().increaseNewAlarm(i))}},_increaseAlarmState:function(e,t){if(e.isCleared()&&!t)return;var n=e.getAlarmSeverity();if(n){var r=this.getCorrespondingElements(e);if(r)for(var i=0;i<r.size();i++){var s=r.get(i);e.isAcked()?s.getAlarmState().increaseAcknowledgedAlarm(n):s.getAlarmState().increaseNewAlarm(n)}}},_decreaseAlarmState:function(e,t){e.isCleared||console.log();if(e.isCleared()&&!t)return;var n=e.getAlarmSeverity();if(!n)return;var r=this.getCorrespondingElements(e);if(r)for(var i=0;i<r.size();i++){var s=r.get(i);e.isAcked()?s.getAlarmState().decreaseAcknowledgedAlarm(n):s.getAlarmState().decreaseNewAlarm(n)}},handleElementRemoved:function(e){var t=this.getCorrespondingAlarms(e);t&&t.forEach(function(t){!t.isCleared()&&t.getAlarmSeverity()&&(t.isAcked()?e.getAlarmState().decreaseAcknowledgedAlarm(t.getAlarmSeverity()):e.getAlarmState().decreaseNewAlarm(t.getAlarmSeverity()))})},removeAlarmsByElement:function(e){var t=this.getCorrespondingAlarms(e);t&&t.forEach(this.remove,this)},add:function(e,t){if(!e.IAlarm)throw"Only IAlarm can be added into AlarmBox";if(this._removeAlarmWhenAlarmIsCleared&&e.isCleared())return;n.AlarmBox.superClass.add.apply(this,arguments)}}),n.AlarmElementMapping=function(e,t){if(!t)throw"ElementBox can not be null";if(!e)throw"AlarmBox can not be null";this._elementBox=t,this._alarmBox=e,this._alarmsFinder=new n.QuickFinder(e,"elementId")},n.extend(n.AlarmElementMapping,Object,{getCorrespondingAlarms:function(e){return this._alarmsFinder.find(e.getId())},getCorrespondingElements:function(e){var t=this._elementBox.getDataById(e.getElementId());return new N(t)},dispose:function(){delete this._elementBox,delete this._alarmBox,delete this._alarmsFinder}}),n.PropertyPropagator=function(e,t,r){if(!e)throw"dataBox can not be null";if(!t)throw"propertyName can not be null";this._dataBox=e,this._propertyName=t,this._propertyType=r||"accessor",this._propertyType==="accessor"&&(this._getter=n.getter(t),this._setter=n.setter(t)),this._enable=!1,this._isPropagating=!1},n.extend(n.PropertyPropagator,Object,{getServa:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isEnable:function(){return this._enable},setEnable:function(e){if(this._enable===e)return;this._enable=e;if(this._enable){this._dataBox.addServaChangeListener(this.handleServaChange,this),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this);for(var t in this._dataBox.datas)this.propagate(this._dataBox.datas[t])}else this._dataBox.removeServaChangeListener(this.handleServaChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this)},handleServaChange:function(e){e.data&&this.propagate(e.data)},handleDataPropertyChange:function(e){if(this.isInterestedProperty(e))this.propagate(e.source);else if(e.property==="parent"){var t=e.oldValue;t&&this.propagate(t),this.propagate(e.source)}},isInterestedProperty:function(e){return this._propertyType==="accessor"&&this._propertyName===e.property?!0:this._propertyType==="style"&&e.IElement&&"S:"+this._propertyName===e.property?!0:this._propertyType==="client"&&"C:"+this._propertyName===e.property?!0:!1},propagate:function(e){if(!e||this._isPropagating)return;this._isPropagating=!0,this.propagateToTop(e),this._isPropagating=!1},propagateToTop:function(e){this.propagateToParent(null,e);while(e&&e.getParent())this.propagateToParent(e,e.getParent()),e=e.getParent()},propagateToParent:function(e,t){}}),n.AlarmStatePropagator=function(e){n.AlarmStatePropagator.superClass.constructor.call(this,e,"alarmState")},n.extend(n.AlarmStatePropagator,n.PropertyPropagator,{handleDataPropertyChange:function(e){e.property==="enablePropagation"?this.propagate(e.source):n.AlarmStatePropagator.superClass.handleDataPropertyChange.call(this,e)},propagateToParent:function(e,t){var r=null;t.getChildren().forEach(function(e){var t=e.getAlarmState().getHighestOverallAlarmSeverity();n.AlarmSeverity.compare(t,r)>0&&(r=t)}),t.getAlarmState&&t.getAlarmState().setPropagateSeverity(r)}});var D={KEEP_DEFAULT_FUNCTION:function(e){return e.target.keepDefault||e.target.getAttribute("keepDefault")?!0:e.target.parentNode&&(e.target.parentNode.keepDefault||e.target.parentNode.getAttribute("keepDefault"))?!0:e.shiftKey?!0:!1}};D.paintSortFunction=function(e,t){return e.z!==t.z?e.z-t.z:0},D.doubleClickToLookAtFunction=function(e){return!0},D.needSmoothNormalFunction=function(e){var t=e instanceof _||e instanceof n.TextNode||e instanceof n.PathCube||e instanceof n.ShapeNode||e instanceof n.ComboNode||e.getClassName()=="TGL.Entity";return!t},D.PATH_LINK_COMPUTE_DELAY=!1,n.Defaults=D,n.BasicShader={vertex_shader:"",fragment_shader:""},n.ShaderUtil={},n.ShaderUtil.getShader=function(e){},n.ShaderChunk={gradient_parts_fragment:["#ifdef MAX_GRADIENT","uniform vec3 gradientColor[MAX_GRADIENT];","uniform float gradientStop[MAX_GRADIENT];","uniform int gradientType;","#endif"].join("\n"),gradient_basic_fragment:["#ifdef MAX_GRADIENT","float gradientUV = 1.0;","float PI = 3.14;","if(gradientType == 1){","gradientUV = oUv.x;","} else if(gradientType == 2){","gradientUV = oUv.y;","} else if(gradientType == 3){","gradientUV = (oUv.x + oUv.y)/2.0;","} else if(gradientType == 4){","gradientUV = (oUv.x + 1.0 - oUv.y)/2.0;","} else if(gradientType == 5){","gradientUV = 1.414 * sqrt((oUv.x - 0.5) * (oUv.x - 0.5) + (oUv.y - 0.5) * (oUv.y - 0.5));","} else if(gradientType == 6){","gradientUV = (atan(oUv.y - 0.5,oUv.x - 0.5)) / (2.0 * PI);","if(gradientUV < 0.0){","gradientUV = 1.0 + gradientUV;","}","}","for( int i = 1; i < MAX_GRADIENT; i ++ ){","if(gradientStop[i - 1] <= gradientUV){","if((gradientStop[i] >= gradientUV)){","vec3 color1 = gradientColor[i-1];","vec3 color2 = gradientColor[i];","float stop1 = gradientStop[i-1];","float stop2 =gradientStop[i]; ","gl_FragColor = vec4( (color1 * (stop2 - gradientUV )  + color2 * (gradientUV - stop1))/(stop2 - stop1),opacity);","break;","}","}","}","#endif"].join("\n"),gradient_phong_fragment:["#ifdef MAX_GRADIENT","float gradientUV = 1.0;","float PI = 3.14;","if(gradientType == 1){","gradientUV = oUv.x;","} else if(gradientType == 2){","gradientUV = oUv.y;","} else if(gradientType == 3){","gradientUV = (oUv.x + oUv.y)/2.0;","} else if(gradientType == 4){","gradientUV = (oUv.x + 1.0 - oUv.y)/2.0;","} else if(gradientType == 5){","gradientUV = 1.414 * sqrt((oUv.x - 0.5) * (oUv.x - 0.5) + (oUv.y - 0.5) * (oUv.y - 0.5));","} else if(gradientType == 6){","gradientUV = (atan(oUv.y - 0.5,oUv.x - 0.5)) / (2.0 * PI);","if(gradientUV < 0.0){","gradientUV = 1.0 + gradientUV;","}","}","for( int i = 1; i < MAX_GRADIENT; i ++ ){","if(gradientStop[i - 1] < gradientUV){","if((gradientStop[i] > gradientUV)){","vec3 color1 = gradientColor[i-1];","vec3 color2 = gradientColor[i];","float stop1 = gradientStop[i-1];","float stop2 = gradientStop[i]; ","tempDiffuse = (color1 * (stop2 - gradientUV )  + color2 * (gradientUV - stop1))/(stop2 - stop1);","break;","}","}","}","#endif"].join("\n"),fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#ifdef USE_ENVMAP","uniform float reflectivity;","uniform samplerCube envMap;","uniform float flipEnvMap;","uniform int combine;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","uniform bool useRefract;","uniform float refractionRatio;","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","vec3 gleyeToVertex = normalize( vWorldPosition - gleyePosition );","if ( useRefract ) {","reflectVec = refract( gleyeToVertex, normal, refractionRatio );","} else { ","reflectVec = reflect( gleyeToVertex, normal );","}","#else","reflectVec = vReflect;","#endif","#ifdef DOUBLE_SIDED","float flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );","vec4 cubeColor = textureCube( envMap, flipNormal * vec3( reflectVec.x*flipEnvMap,  reflectVec.y,reflectVec.z) );","#else","vec4 cubeColor = textureCube( envMap, vec3(reflectVec.x*flipEnvMap,  reflectVec.y,reflectVec.z) );","#endif","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","#ifdef PHONG","#else","float specularStrength = 1.0;","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else if ( combine == 2 ) {","gl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#endif"].join("\n"),worldpos_vertex:["#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP ) ","#ifdef USE_SKINNING","vec4 worldPosition = modelMatrix * skinned;","#endif","#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );","#endif","#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif"].join("\n"),envmap_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;","worldNormal = normalize( worldNormal );","vec3 gleyeToVertex = normalize( worldPosition.xyz - gleyePosition );","if ( useRefract ) {","vReflect = refract( gleyeToVertex, worldNormal, refractionRatio );","} else {","vReflect = reflect( gleyeToVertex, worldNormal );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined(MAX_GRADIENT)","varying vec2 vUv;","varying vec2 oUv;","uniform vec4 offsetRepeat;","uniform bool flipX; ","#endif"].join("\n"),map_pars_fragment:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined(MAX_GRADIENT)","varying vec2 vUv;","varying vec2 oUv;","#endif","#ifdef USE_MAP","uniform bool mapLoaded;","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined(MAX_GRADIENT)","if(flipX){","vUv.x = uv.x * offsetRepeat.z * (-1.0) + offsetRepeat.x + offsetRepeat.z;","vUv.y = uv.y * offsetRepeat.w  + offsetRepeat.y;","}else{","vUv = uv * offsetRepeat.zw  + offsetRepeat.xy;","}","oUv = uv;","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","if(mapLoaded){","vec4 texelColor = texture2D( map, vUv );","#ifdef GAMMA_INPUT","texelColor.xyz *= texelColor.xyz;","#endif","gl_FragColor = texelColor * gl_FragColor;","}","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),normalmap_pars_fragment:["#ifdef USE_NORMALMAP","uniform sampler2D normalMap;","uniform vec2 normalScale;","vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {","vec3 q0 = dFdx( eye_pos.xyz );","vec3 q1 = dFdy( eye_pos.xyz );","vec2 st0 = dFdx( vUv.st );","vec2 st1 = dFdy( vUv.st );","vec3 S = normalize(  q0 * st1.t - q1 * st0.t );","vec3 T = normalize( -q0 * st1.s + q1 * st0.s );","vec3 N = normalize( surf_norm );","vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;","mapN.xy = normalScale * mapN.xy;","mat3 tsn = mat3( S, T, N );","return normalize( tsn * mapN );","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec4 texelSpecular = texture2D( specularMap, vUv );","specularStrength = texelSpecular.r;","#else","specularStrength = uspecularStrength;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0 ","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","varying vec3 vWorldPosition;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ","vWorldPosition = worldPosition.xyz;","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_NORMALMAP","normal = perturbNormal2Arb( -viewPosition, normal );","#elif defined( USE_BUMPMAP )","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += tempDiffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","#else","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ]) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += tempDiffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;","#else","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += tempDiffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0"
,"vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += tempDiffuse * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += specular * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","float ssao = 1.0;","#ifdef USE_SSAO","ssao = clamp(1.0 - texture2D(mapSSAO, (finalPosition.xy / finalPosition.w / 2.0 + vec2(0.5,0.5))).x,0.0,1.0);","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + (ambientLightColor * ambient * ssao) + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + (ambientLightColor * ambient) * ssao ) + totalSpecular;","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, opacity );","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef BONE_TEXTURE","uniform sampler2D boneTexture;","mat4 getBoneMatrix( const in float i ) {","float j = i * 4.0;","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );","vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );","vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );","vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );","mat4 bone = mat4( v1, v2, v3, v4 );","return bone;","}","#else","uniform mat4 boneGlobalMatrices[ MAX_BONES ];","mat4 getBoneMatrix( const in float i ) {","mat4 bone = boneGlobalMatrices[ int(i) ];","return bone;","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","#ifdef USE_MORPHTARGETS","vec4 skinVertex = vec4( morphed, 1.0 );","#else","vec4 skinVertex = vec4( position, 1.0 );","#endif","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","#endif"].join("\n"),default_vertex:["vec4 mvPosition;","#ifdef USE_SKINNING","mvPosition = modelViewMatrix * skinned;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( morphed, 1.0 );","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )","mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","#ifdef USE_MORPHNORMALS","vec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );","#else","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif","#endif"].join("\n"),defaultnormal_vertex:["vec3 objectNormal;","#ifdef USE_SKINNING","objectNormal = skinnedNormal.xyz;","#endif","#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )","objectNormal = morphedNormal;","#endif","#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )","objectNormal = normal;","#endif","#ifdef FLIP_SIDED","objectNormal = -objectNormal;","#endif","vec3 transformedNormal = normalMatrix * objectNormal;"].join("\n"),shadowmap_pars_fragment:["#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","varying vec4 vShadowCoord[ MAX_SHADOWS ];","#endif","#ifdef USE_POINT_SHADOWMAP","uniform samplerCube pShadowMap[MAX_POINT_SHADOWS];","uniform float pShadowDarkness[MAX_POINT_SHADOWS];","uniform vec3 pPosition[MAX_POINT_SHADOWS];","varying vec4 pWorldPosition;","#endif","#if defined(USE_SHADOWMAP) || defined(USE_POINT_SHADOWMAP)","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","float unpack (vec4 colour){","const vec4 bitShifts = vec4(1.0,1.0 / 255.0,1.0 / (255.0 * 255.0),1.0 / (255.0 * 255.0 * 255.0));","return dot(colour, bitShifts) * 100000.0;","}","#endif"].join("\n"),shadowmap_fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","inFrustumCount += int( inFrustum );","bvec3 frustumTestVec = bvec3(inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );","#else","bvec2 frustumTestVec = bvec2(inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest) {","shadowCoord.z += shadowBias[ i ];","#if defined( SHADOWMAP_TYPE_PCF )","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#elif defined( SHADOWMAP_TYPE_PCF_SOFT )","float shadow = 0.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.0 * xPixelOffset;","float dy0 = -1.0 * yPixelOffset;","float dx1 = 1.0 * xPixelOffset;","float dy1 = 1.0 * yPixelOffset;","mat3 shadowKernel;","mat3 depthKernel;","depthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( depthKernel[0][0] < shadowCoord.z ) shadowKernel[0][0] = 0.25;","else shadowKernel[0][0] = 0.0;","depthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( depthKernel[0][1] < shadowCoord.z ) shadowKernel[0][1] = 0.25;","else shadowKernel[0][1] = 0.0;","depthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( depthKernel[0][2] < shadowCoord.z ) shadowKernel[0][2] = 0.25;","else shadowKernel[0][2] = 0.0;","depthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( depthKernel[1][0] < shadowCoord.z ) shadowKernel[1][0] = 0.25;","else shadowKernel[1][0] = 0.0;","depthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( depthKernel[1][1] < shadowCoord.z ) shadowKernel[1][1] = 0.25;","else shadowKernel[1][1] = 0.0;","depthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( depthKernel[1][2] < shadowCoord.z ) shadowKernel[1][2] = 0.25;","else shadowKernel[1][2] = 0.0;","depthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( depthKernel[2][0] < shadowCoord.z ) shadowKernel[2][0] = 0.25;","else shadowKernel[2][0] = 0.0;","depthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( depthKernel[2][1] < shadowCoord.z ) shadowKernel[2][1] = 0.25;","else shadowKernel[2][1] = 0.0;","depthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( depthKernel[2][2] < shadowCoord.z ) shadowKernel[2][2] = 0.25;","else shadowKernel[2][2] = 0.0;","vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );","shadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );","shadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );","vec4 shadowValues;","shadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );","shadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );","shadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );","shadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );","shadow = dot( shadowValues, vec4( 1.0 ) );","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if ( fDepth < shadowCoord.z )","shadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor *= shadowColor;","#endif","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif","#ifdef USE_POINT_SHADOWMAP","for( int i = 0; i < MAX_POINT_SHADOWS; i ++ ) {","vec3 lightVec = normalize(pWorldPosition.xyz - pPosition[i]);","float depth = length(pWorldPosition.xyz - pPosition[i]);","float shadowDepth = unpack (textureCube(pShadowMap[i], lightVec));","depth = depth * 0.95;","if ( depth > shadowDepth){","gl_FragColor.xyz *= 0.8;","}","}","#endif"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif","#ifdef USE_POINT_SHADOWMAP","varying vec4 pWorldPosition;","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif","#ifdef USE_POINT_SHADOWMAP","pWorldPosition = modelMatrix * vec4(position,1.0);","#endif"].join("\n"),alphatest_fragment:["#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n")},n.UniformsUtils={merge:function(e){var t,n,r,i={};for(t=0;t<e.length;t++){r=this.clone(e[t]);for(n in r)i[n]=r[n]}return i},clone:function(e){var t,r,i,s,o={};for(t in e){o[t]={};for(r in e[t])s=e[t][r],s instanceof n.Color||s instanceof n.XiangliangTwo||s instanceof n.XiangliangThree||s instanceof n.Vec4||s instanceof n.Mat4||s instanceof n.Texture?o[t][r]=s.clone():s instanceof Array?o[t][r]=s.slice():o[t][r]=s}return o}},n.UniformsLib={outline:{diffuse:{type:"c",value:new n.Color(15658734)},outline_offset:{type:"f",value:0}},glow:{map:{type:"t",value:null}},blur:{orientation:{type:"i",value:0},texelSize:{type:"v2",value:new n.XiangliangTwo(512,512)},blurAmount:{type:"i",value:10},blurScale:{type:"f",value:1},blurStrength:{type:"f",value:.2},map:{type:"t",value:null},useBlur:{type:"i",value:1},blurGlobalAlpha:{type:"f",value:1}},deferred:{linearDepth:{type:"f",value:9e3},isNormal:{type:"i",value:1}},ssao:{map0:{type:"t",value:null},map1:{type:"t",value:null},map2:{type:"t",value:null},occluderBias:{type:"f",value:.05},samplingRadius:{type:"f",value:20},attenuation:{type:"v2",value:new s(1,0)},texelSize:{type:"v2",value:new s(1/512,1/512)}},common:{diffuse:{type:"c",value:new n.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},mapLoaded:{type:"i",value:0},offsetRepeat:{type:"v4",value:new n.Vec4(0,0,1,1)},flipX:{type:"i",value:0},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},gradient:{gradientColor:{type:"v3v",value:[]},gradientStop:{type:"fv1",value:[]},gradientType:{type:"i",value:0}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new n.XiangliangTwo(1,1)}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new n.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new n.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new n.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]},pShadowMap:{type:"tv",value:[]},pShadowMapSize:{type:"v2v",value:[]},pShadowDarkness:{type:"fv1",value:[]},pPosition:{type:"v3v",value:[]}}},n.ShaderLib={outline:{uniforms:n.UniformsUtils.merge([n.UniformsLib.outline]),vertexShader:["uniform float outline_offset;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position + normal  * outline_offset, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","void main() {","gl_FragColor = vec4(diffuse, 1.0 );","}"].join("\n")},blur:{uniforms:n.UniformsUtils.merge([n.UniformsLib.blur]),vertexShader:["varying vec2 vUv;","void main (){","gl_Position = vec4(position, 1.0);","vUv = uv;","}"].join("\n"),fragmentShader:["uniform vec2 texelSize;","uniform sampler2D map;","uniform int orientation;","uniform int blurAmount;","uniform float blurScale;","uniform float blurStrength;","uniform int useBlur;","uniform float blurGlobalAlpha;","uniform sampler2D depthMap;","varying vec2 vUv;","float Gaussian (float x, float deviation){","return (1.0 / sqrt(2.0 * 3.141592 * deviation)) * exp(-((x * x) / (2.0 * deviation)));","}","void main (){","float halfBlur = float(blurAmount) * 0.5;","vec4 colour = vec4(0.0);","if(useBlur == 0){","colour = texture2D(map,vUv);","}else {","vec4 texColour = vec4(0.0);","float deviation = halfBlur * 0.35;","deviation *= deviation;","float strength = 1.0 - blurStrength;","if ( orientation == 0 ){","for (int i = 0; i < 20; ++i){","if ( i >= blurAmount ){","break;","}","float offset = float(i) - halfBlur;","texColour = texture2D(map, vUv + vec2(offset / texelSize.x * blurScale, 0.0)) * Gaussian(offset * strength, deviation);","colour += texColour;","}","}else{","for (int i = 0; i < 20; ++i){","if ( i >= blurAmount )","break;","float offset = float(i) - halfBlur;","texColour = texture2D(map, vUv + vec2(0.0, offset / texelSize.y * blurScale)) * Gaussian(offset * strength, deviation);","colour += texColour;","}","}","}","gl_FragColor = clamp(colour, 0.0, 1.0);","if(useBlur == 0){","gl_FragColor.w *=  gl_FragColor.w * gl_FragColor.w * gl_FragColor.w * blurGlobalAlpha;","}","}"].join("\n")},deferred:{uniforms:n.UniformsUtils.merge([n.UniformsLib.deferred]),vertexShader:["varying vec4 vPosition;","varying vec3 vNormal;","void main (){","vNormal = mat3(modelViewMatrix) * normal;","vPosition = modelViewMatrix * vec4(position, 1.0);","gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fragmentShader:["uniform float linearDepth;","uniform int isNormal;","varying vec4 vPosition;","varying vec3 vNormal;","void main (){","float linear_depth = length(vPosition) / linearDepth;","if(isNormal == 1){","vec3 normal = normalize(vNormal);","gl_FragColor = vec4(normal.x, normal.y, normal.z, 1.0);","}else{","gl_FragColor = vec4(vPosition.x, vPosition.y, vPosition.z, linear_depth);","}","}"].join("\n")},ssao:{uniforms:n.UniformsUtils.merge([n.UniformsLib.ssao]),vertexShader:["varying vec2 vUv;","void main (){","gl_Position = vec4(position, 1.0);","vUv = uv;","}"].join("\n"),fragmentShader:["uniform sampler2D map0;","uniform sampler2D map1;","uniform sampler2D map2;","uniform vec2 texelSize;","uniform float occluderBias;","uniform float samplingRadius;","uniform vec2 attenuation;","varying vec2 vUv;","float samplePixels (vec3 srcPosition, vec3 srcNormal, vec2 uv){","vec3 dstPosition = texture2D(map0, uv).xyz;","vec3 positionVec = dstPosition - srcPosition;","float intensity = max(dot(normalize(positionVec), srcNormal) - occluderBias, 0.0);","float dist = length(positionVec);","float attenuationValue = 1.0 / (attenuation.x + (attenuation.y * dist));","return intensity * attenuationValue;","}","void main (){","vec3 srcPosition = texture2D(map0, vUv).xyz;","vec3 srcNormal = texture2D(map1, vUv).xyz;","vec2 randVec = normalize(texture2D(map2, vUv).xy * 2.0 - 1.0);","float srcDepth = texture2D(map0, vUv).w;","float kernelRadius = samplingRadius * (1.0 - srcDepth);","vec2 kernel[4];","kernel[0] = vec2(0.0, 1.0);","kernel[1] = vec2(1.0, 0.0);","kernel[2] = vec2(0.0, -1.0);","kernel[3] = vec2(-1.0, 0.0);","const float sin45 = 0.707107;","float occlusion = 0.0;","for (int i = 0; i < 4; ++i){","vec2 k1 = reflect(kernel[i], randVec);","vec2 k2 = vec2(k1.x * sin45 - k1.y * sin45,k1.x * sin45 + k1.y * sin45);","k1 *= texelSize;","k2 *= texelSize;","occlusion += samplePixels(srcPosition, srcNormal, vUv + k1 * kernelRadius);","occlusion += samplePixels(srcPosition, srcNormal, vUv + k2 * kernelRadius * 0.75);","occlusion += samplePixels(srcPosition, srcNormal, vUv + k1 * kernelRadius * 0.5);","occlusion += samplePixels(srcPosition, srcNormal, vUv + k2 * kernelRadius * 0.25);","}","occlusion /= 16.0;","occlusion = clamp(occlusion, 0.0, 1.0);","gl_FragColor =  vec4(occlusion,0.0,0.0,1.0);","}"].join("\n")},basic:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.gradient,n.UniformsLib.fog]),vertexShader:[n.ShaderChunk.map_pars_vertex,n.ShaderChunk.lightmap_pars_vertex,n.ShaderChunk.envmap_pars_vertex,n.ShaderChunk.color_pars_vertex,n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,"void main() {",n.ShaderChunk.map_vertex,n.ShaderChunk.lightmap_vertex,n.ShaderChunk.color_vertex,n.ShaderChunk.skinbase_vertex,"#ifdef USE_ENVMAP",n.ShaderChunk.morphnormal_vertex,n.ShaderChunk.skinnormal_vertex,n.ShaderChunk.defaultnormal_vertex,"#endif",n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,n.ShaderChunk.worldpos_vertex,n.ShaderChunk.envmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.map_pars_fragment,n.ShaderChunk.gradient_parts_fragment,n.ShaderChunk.lightmap_pars_fragment,n.ShaderChunk.envmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, opacity );",n.ShaderChunk.gradient_basic_fragment,n.ShaderChunk.map_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.lightmap_fragment,n.ShaderChunk.color_fragment,n.ShaderChunk.envmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,{ambient:{type:"c",value:new n.Color(16777215)},emissive:{type:"c",value:new n.Color(0)},wrapRGB:{type:"v3",value:new n.XiangliangThree(1,1,1)}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",n.ShaderChunk.map_pars_vertex,n.ShaderChunk.lightmap_pars_vertex,n.ShaderChunk.envmap_pars_vertex,n.ShaderChunk.lights_lambert_pars_vertex,n.ShaderChunk.color_pars_vertex,n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"void main() {",n.ShaderChunk.map_vertex,n.ShaderChunk.lightmap_vertex,n.ShaderChunk.color_vertex,n.ShaderChunk.morphnormal_vertex,n.ShaderChunk.skinbase_vertex,n.ShaderChunk.skinnormal_vertex,n.ShaderChunk.defaultnormal_vertex,n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,n.ShaderChunk.worldpos_vertex,n.ShaderChunk.envmap_vertex,n.ShaderChunk.lights_lambert_vertex,n.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.map_pars_fragment,n.ShaderChunk.lightmap_pars_fragment,n.ShaderChunk.envmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",n.ShaderChunk.map_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",n.ShaderChunk.lightmap_fragment,n.ShaderChunk.color_fragment,n.ShaderChunk.envmap_fragment,n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.gradient,n.UniformsLib.bump,n.UniformsLib.normalmap,n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,{ambient:{type:"c",value:new n.Color(16777215)},emissive:{type:"c",value:new n.Color(0)},specular:{type:"c",value:new n.Color(1118481)},uspecularStrength:{type:"f",value:1},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new n.XiangliangThree(1,1,1)},mapSSAO:{type:"t",value:null}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec4 finalPosition;",n.ShaderChunk.map_pars_vertex,n.ShaderChunk.lightmap_pars_vertex,n.ShaderChunk.envmap_pars_vertex,n.ShaderChunk.lights_phong_pars_vertex,n.ShaderChunk.color_pars_vertex,n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"void main() {",n.ShaderChunk.map_vertex,n.ShaderChunk.lightmap_vertex,n.ShaderChunk.color_vertex,n.ShaderChunk.morphnormal_vertex,n.ShaderChunk.skinbase_vertex,n.ShaderChunk.skinnormal_vertex,n.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",n.ShaderChunk.worldpos_vertex,n.ShaderChunk.envmap_vertex,n.ShaderChunk.lights_phong_vertex,n.ShaderChunk.shadowmap_vertex,"finalPosition = gl_Position;","}"].join("\n"),fragmentShader:["#define PHONG","uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float uspecularStrength;","uniform float shininess;","varying vec4 finalPosition;",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.gradient_parts_fragment,n.ShaderChunk.map_pars_fragment,n.ShaderChunk.lightmap_pars_fragment,n.ShaderChunk.envmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.lights_phong_pars_fragment,n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.bumpmap_pars_fragment,n.ShaderChunk.normalmap_pars_fragment,n.ShaderChunk.specularmap_pars_fragment,"#ifdef USE_SSAO","uniform sampler2D mapSSAO;","#endif","void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );","vec3 tempDiffuse = diffuse;",n.ShaderChunk.gradient_phong_fragment,n.ShaderChunk.map_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.specularmap_fragment,n.ShaderChunk.lights_phong_fragment,n.ShaderChunk.lightmap_fragment,n.ShaderChunk.color_fragment,n.ShaderChunk.envmap_fragment,n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n")},particle_basic:{uniforms:n.UniformsUtils.merge([n.UniformsLib.particle,n.UniformsLib.shadowmap]),vertexShader:["uniform float size;","uniform float scale;",n.ShaderChunk.color_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"void main() {",n.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","gl_Position = projectionMatrix * mvPosition;",n.ShaderChunk.worldpos_vertex,n.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;","uniform float opacity;",n.ShaderChunk.color_pars_fragment,n.ShaderChunk.map_particle_pars_fragment,n.ShaderChunk.fog_pars_fragment,n.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( psColor, opacity );",n.ShaderChunk.map_particle_fragment,n.ShaderChunk.alphatest_fragment,n.ShaderChunk.color_fragment,n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n")},billboard:{vertexShader:["uniform int useScreenCoordinates;","uniform int sizeAttenuation;","uniform vec3 screenPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 alignment;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position + alignment;","vec2 rotatedPosition;","rotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;","rotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;","vec4 finalPosition;","if( useScreenCoordinates != 0 ) {","finalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );","} else {","finalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition * ( sizeAttenuation == 1 ? 1.0 : finalPosition.z );","}","gl_Position = finalPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")},dashed:{uniforms:n.UniformsUtils.merge([n.UniformsLib.common,n.UniformsLib.fog,{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}}]),vertexShader:["uniform float scale;","attribute float lineDistance;","varying float vLineDistance;",n.ShaderChunk.color_pars_vertex,"void main() {",n.ShaderChunk.color_vertex,"vLineDistance = scale * lineDistance;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float totalSize;","varying float vLineDistance;",n.ShaderChunk.color_pars_fragment
,n.ShaderChunk.fog_pars_fragment,"void main() {","if ( mod( vLineDistance, totalSize ) > dashSize ) {","discard;","}","gl_FragColor = vec4( diffuse, opacity );",n.ShaderChunk.color_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float color = 1.0 - smoothstep( mNear, mFar, depth );","gl_FragColor = vec4( vec3( color ), opacity );","}"].join("\n")},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vNormal;","void main() {","gl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );","}"].join("\n")},normalmap:{uniforms:n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new n.XiangliangTwo(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new n.Color(16777215)},uSpecularColor:{type:"c",value:new n.Color(1118481)},uSpecualarStrength:{type:"f",value:1},uAmbientColor:{type:"c",value:new n.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:.98},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new n.XiangliangTwo(0,0)},uRepeat:{type:"v2",value:new n.XiangliangTwo(1,1)},wrapRGB:{type:"v3",value:new n.XiangliangThree(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform vec3 uSpecularStrength;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform vec2 uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, vUv );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, vUv );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, vUv ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","#ifdef FLIP_SIDED","finalNormal = -finalNormal;","#endif","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;","#else","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;","#else","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","vec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","hemiDiffuse += uDiffuseColor * hemiColor;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","float hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","float hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float dotProductGround = dot( normal, lVectorGround );","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlickSky = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );","vec3 schlickGround = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );","hemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );","#else","hemiSpecular += uSpecularColor * hemiColor * ( hemiSpecularWeightSky + hemiSpecularWeightGround ) * hemiDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 gleyeToVertex = normalize( vWorldPosition - gleyePosition );","if ( useRefract ) {","vReflect = refract( gleyeToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( gleyeToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;","varying vec3 vViewPosition;",n.ShaderChunk.skinning_pars_vertex,n.ShaderChunk.shadowmap_pars_vertex,"void main() {",n.ShaderChunk.skinbase_vertex,n.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING","vNormal = normalize( normalMatrix * skinnedNormal.xyz );","vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vTangent = normalize( normalMatrix * skinnedTangent.xyz );","#else","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","#endif","vBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinVertex = vec4( position, 1.0 );","vec4 skinned  = boneMatX * skinVertex * skinWeight.x;","skinned 	  += boneMatY * skinVertex * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = worldPosition.xyz;","vViewPosition = -mvPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;","}","#endif","}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;","void main() {","gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );","}"].join("\n")},depthRGBA:{uniforms:{isCube:{type:"i",value:0}},vertexShader:[n.ShaderChunk.morphtarget_pars_vertex,n.ShaderChunk.skinning_pars_vertex,"varying vec4 vPosition1;","void main() {",n.ShaderChunk.skinbase_vertex,n.ShaderChunk.morphtarget_vertex,n.ShaderChunk.skinning_vertex,n.ShaderChunk.default_vertex,"vPosition1 = modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform int isCube;","varying vec4 vPosition1;","varying vec3 vPosition2;","vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}","vec4 pack (float depth){","const vec4 bias = vec4(1.0 / 255.0,1.0 / 255.0,1.0 / 255.0, 0.0);","float r = depth;","float g = fract(r * 255.0);","float b = fract(g * 255.0);","float a = fract(b * 255.0);","vec4 colour = vec4(r, g, b, a);","return colour - (colour.yzww * bias);","}","void main() {","if(isCube == 1){","gl_FragData[ 0 ] = pack(length(vPosition1) / 100000.0);","}else{","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","}","}"].join("\n")}},n.ShaderTerrain={terrain:{uniforms:n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights,n.UniformsLib.shadowmap,{enableDiffuse1:{type:"i",value:0},enableDiffuse2:{type:"i",value:0},enableDiffuse3:{type:"i",value:0},enableDisplacement:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null},tDiffuse3:{type:"t",value:null},tDetail:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tDisplacement:{type:"t",value:null},heightUnit:{type:"f",value:1},blendRange:{type:"fv1",value:null},uNormalScale:{type:"f",value:1},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new n.Color(15658734)},uSpecularColor:{type:"c",value:new n.Color(1118481)},uAmbientColor:{type:"c",value:new n.Color(328965)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},uRepeatBase:{type:"v2",value:new n.XiangliangTwo(1,1)},uRepeatOverlay:{type:"v2",value:new n.XiangliangTwo(1,1)},uOffset:{type:"v2",value:new n.XiangliangTwo(0,0)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse1;","uniform bool enableDiffuse2;","uniform bool enableDiffuse3;","uniform bool enableSpecular;","uniform bool enableDisplacement;","uniform float blendRange[2];","uniform float heightUnit;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","uniform sampler2D tDiffuse3;","uniform sampler2D tDetail;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tDisplacement;","uniform float uNormalScale;","uniform vec2 uRepeatOverlay;","uniform vec2 uRepeatBase;","uniform vec2 uOffset;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec4 vPosition;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_HEMI_LIGHTS > 0","uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];","uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","varying vec3 vViewPosition;",n.ShaderChunk.shadowmap_pars_fragment,n.ShaderChunk.fog_pars_fragment,"void main() {","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec2 uvOverlay = uRepeatOverlay * vUv + uOffset;","vec2 uvBase = uRepeatBase * vUv;","vec3 normalTex = texture2D( tDetail, uvOverlay ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( (enableDiffuse1 && enableDiffuse2)  || (enableDiffuse1 && enableDiffuse3) || (enableDiffuse2 && enableDiffuse3) ){","vec4 colDiffuse1 = texture2D( tDiffuse1, uvOverlay );","vec4 colDiffuse2 = texture2D( tDiffuse2, uvOverlay );","vec4 colDiffuse3 = texture2D( tDiffuse3, uvOverlay );","vec4 allDefiuuses[3];","allDefiuuses[0] = colDiffuse1;","allDefiuuses[1] = colDiffuse2;","allDefiuuses[2] = colDiffuse3;","#ifdef GAMMA_INPUT","colDiffuse1.xyz *= colDiffuse1.xyz;","colDiffuse2.xyz *= colDiffuse2.xyz;","colDiffuse3.xyz *= colDiffuse3.xyz;","#endif","vec4 mixColor;","if(enableDisplacement){","vec4 dis = texture2D( tDisplacement, uvBase );","if(enableDiffuse1 && enableDiffuse2 && enableDiffuse3){","float total = dis.r + dis.g + dis.b;","if(total == 0.0){","mixColor = colDiffuse1 * 1.0/3.0 + colDiffuse2 * 1.0/3.0 + colDiffuse3 * 1.0/3.0;","}else{","mixColor = colDiffuse1 * dis.r/total + colDiffuse2 * dis.g/total + colDiffuse3 * dis.b/total;","}","}","}else {","mixColor = colDiffuse2;","float y = vPosition.y;","float blend2Bottom = blendRange[1] * heightUnit * 255.0;","float percent = 0.0;","if(y < blendRange[0] * heightUnit * 255.0){","mixColor = colDiffuse1;","percent = y / (blendRange[0] * heightUnit * 255.0);","if(percent >=0.8){","mixColor = mix(colDiffuse1,colDiffuse2,(percent - 0.8) / 0.2);","}","} else if(y > blend2Bottom){","mixColor = colDiffuse3;","percent = (y - blend2Bottom) / (heightUnit * 255.0 - blend2Bottom);","if(percent <= 0.2){","mixColor = mix(colDiffuse2,colDiffuse3,percent/0.2);","}","}","}","gl_FragColor = gl_FragColor * mixColor;"," } else if( enableDiffuse1 ) {","gl_FragColor = gl_FragColor * texture2D( tDiffuse1, uvOverlay );","} else if( enableDiffuse2 ) {","gl_FragColor = gl_FragColor * texture2D( tDiffuse2, uvOverlay );","}","if( enableSpecular )","specularTex = texture2D( tSpecular, uvOverlay ).xyz;","mat3 tsb = mat3( vTangent, vBinormal, vNormal );","vec3 finalNormal = tsb * normalTex;","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDistance = lDistance;","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointDiffuseWeight = max( dot( normal, lVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","}","#endif","#if MAX_HEMI_LIGHTS > 0","vec3 hemiDiffuse  = vec3( 0.0 );","vec3 hemiSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","hemiDiffuse += uDiffuseColor * mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","float hemiSpecularWeight = 0.0;","vec3 hemiHalfVectorSky = normalize( lVector + viewPosition );","float hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;","hemiSpecularWeight += specularTex.r * max( pow( hemiDotNormalHalfSky, uShininess ), 0.0 );","vec3 lVectorGround = -lVector;","vec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );","float hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;","hemiSpecularWeight += specularTex.r * max( pow( hemiDotNormalHalfGround, uShininess ), 0.0 );","hemiSpecular += uSpecularColor * mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight ) * hemiSpecularWeight * hemiDiffuseWeight;","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_HEMI_LIGHTS > 0","totalDiffuse += hemiDiffuse;","totalSpecular += hemiSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif",n.ShaderChunk.shadowmap_fragment,n.ShaderChunk.linear_to_gamma_fragment,n.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uRepeatBase;","uniform sampler2D tNormal;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec4 vPosition;","varying vec3 vViewPosition;",n.ShaderChunk.shadowmap_pars_vertex,"void main() {","vNormal = normalize( normalMatrix * normal );","vTangent = normalize( normalMatrix * tangent.xyz );","vBinormal = cross( vNormal, vTangent ) * tangent.w;","vBinormal = normalize( vBinormal );","vUv = uv;","vec2 uvBase = uv * uRepeatBase;","#ifdef VERTEX_TEXTURES","vec3 dv = texture2D( tDisplacement, uvBase ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","vec3 displacedPosition = normal * df + position;","vec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","#else","vPosition = vec4(position,1.0);","vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#endif","gl_Position = projectionMatrix * mvPosition;","vViewPosition = -mvPosition.xyz;","vec3 normalTex = texture2D( tNormal, uvBase ).xyz * 2.0 - 1.0;","vNormal = normalMatrix * normalTex;",n.ShaderChunk.shadowmap_vertex,"}"].join("\n")}},n.ShaderLib.terrain=n.ShaderTerrain.terrain,n.Fog=function(e,r,i){this.name="",this.color=new n.Color(e),this.near=r!==t?r:1,this.far=i!==t?i:1e3},n.Fog.prototype={constructor:n.Fog,clone:function(){return new n.Flog(this.color.getHex(),this.near,this.far)},refreshUniforms:function(e){e.fogNear.value=this.near,e.fogFar.value=this.far,e.fogColor.value=this.color}},n.FogExp2=function(e,r){this.name="",this.color=new n.Color(e),this.density=r!==t?r:1},n.FogExp2.prototype={DensityFactor:25e-5,constructor:n.FogExp2,clone:function(){return new n.FogExp2(this.color.getHex(),this.density)},refreshUniforms:function(e){e.fogDensity.value=this.density*this.DensityFactor,e.fogColor.value=this.color}};var P={},H=P.RADIANS_TO_DEGREES=180/Math.PI,B=P.DEGREES_TO_RADIANS=Math.PI/180;P.isPowerOfTwo=function(e){return(e&e-1)===0},P.clone=function(e,n){n==t&&(n=new e.prototype.constructor);for(var r in e){if(r==="id")continue;var i=e[r];if(i.copy&&typeof i.copy=="function")n[r].copy(i);else if(i instanceof Array){var s=i,o=n[r];o==null&&(o=[]);for(var u=0;u<s.length;u++){var a=s[u];o.push(a.clone())}}else cloneObjet[r]=i}},P.paramToGL=function(e,t){if(!t){console.error("No webgl context");return}switch(e){case n.RepeatWrapping:return t.REPEAT;case n.ClampToEdgeWrapping:return t.CLAMP_TO_EDGE;case n.MirroredRepeatWrapping:return t.MIRRORED_REPEAT;case n.NearestFilter:return t.NEAREST;case n.NearestMipMapNearestFilter:return t.NEAREST_MIPMAP_NEAREST;case n.NearestMipMapLinearFilter:return t.NEAREST_MIPMAP_LINEAR;case n.LinearFilter:return t.LINEAR;case n.LinearMipMapNearestFilter:return t.LINEAR_MIPMAP_NEAREST;case n.LinearMipMapLinearFilter:return t.LINEAR_MIPMAP_LINEAR;case n.ByteType:return t.BYTE;case n.UnsignedByteType:return t.UNSIGNED_BYTE;case n.ShortType:return t.SHORT;case n.UnsignedShortType:return t.UNSIGNED_SHORT;case n.IntType:return t.INT;case n.UnsignedIntType:return t.UNSIGNED_INT;case n.FloatType:return t.FLOAT;case n.AlphaFormat:return t.ALPHA;case n.RGBFormat:return t.RGB;case n.RGBAFormat:return t.RGBA;case n.LuminanceFormat:return t.LUMINANCE;case n.LuminanceAlphaFormat:return t.LUMINANCE_ALPHA;case n.AddEquation:return t.FUNC_ADD;case n.SubtractEquation:return t.FUNC_SUBTRACT;case n.ReverseSubtractEquation:return t.FUNC_REVERSE_SUBTRACT;case n.ZeroFactor:return t.ZERO;case n.OneFactor:return t.ONE;case n.SrcColorFactor:return t.SRC_COLOR;case n.OneMinusSrcColorFactor:return t.ONE_MINUS_SRC_COLOR;case n.SrcAlphaFactor:return t.SRC_ALPHA;case n.OneMinusSrcAlphaFactor:return t.ONE_MINUS_SRC_ALPHA;case n.DstAlphaFactor:return t.DST_ALPHA;case n.OneMinusDstAlphaFactor:return t.ONE_MINUS_DST_ALPHA;case n.DstColorFactor:return t.DST_COLOR;case n.OneMinusDstColorFactor:return t.ONE_MINUS_DST_COLOR;case n.SrcAlphaSaturateFactor:return t.SRC_ALPHA_SATURATE}return 0},P.createElement=function(e,r,i,o){var u,a,l,c,h=e.vertices.length,p=e.uvs.length,d=e.vertices,v=r.vertices,m=e.faces,g=r.faces,y=e.uvs,b=r.uvs,w=[],E=[],S=[];o===t&&(o=0),e instanceof n.Element&&(e.matrixAutoUpdate&&e.updateMatrix(),u=e.matrix,a=(new f).getNormalMatrix(u)),r instanceof n.Element&&(r.matrixAutoUpdate&&r.updateMatrix(),l=r.matrix,c=(new f).getNormalMatrix(l));for(var x=0,T=d.length;x<T;x++){var N=d[x],C=N.clone();u&&C.applyMatrix4(u),E.push(C)}for(var x=0,T=v.length;x<T;x++){var N=v[x],C=N.clone();l&&C.applyMatrix4(l),E.push(C)}for(x=0,T=m.length;x<T;x++){var k=m[x],L,A,_,D=k.vertexNormals,P=k.vertexColors;k instanceof O?L=new O(k.a,k.b,k.c):L=new M(k.a,k.b,k.c,k.d),L.normal.copy(k.normal),a&&L.normal.applyMatrix3(a).normalize();for(var H=0,B=D.length;H<B;H++)A=D[H].clone(),a&&A.applyMatrix3(a).normalize(),L.vertexNormals.push(A);L.color.copy(k.color);for(var H=0,B=P.length;H<B;H++)_=P[H],L.vertexColors.push(_.clone());L.materialIndex=k.materialIndex,L.centroid.copy(k.centroid),u&&L.centroid.applyMatrix4(u),w.push(L)}for(x=0,T=g.length;x<T;x++){var k=g[x],L,A,_,D=k.vertexNormals,P=k.vertexColors;k instanceof O?L=new O(k.a+h,k.b+h,k.c+h):L=new M(k.a+h,k.b+h,k.c+h,k.d+h),L.normal.copy(k.normal),c&&L.normal.applyMatrix3(c).normalize();for(var H=0,B=D.length;H<B;H++)A=D[H].clone(),c&&A.applyMatrix3(c).normalize(),L.vertexNormals.push(A);L.color.copy(k.color);for(var H=0,B=P.length;H<B;H++)_=P[H],L.vertexColors.push(_.clone());L.materialIndex=k.materialIndex+o,L.centroid.copy(k.centroid),l&&L.centroid.applyMatrix4(l),w.push(L)}for(x=0,T=y.length;x<T;x++){var j=y[x],F=[];for(var H=0,B=j.length;H<B;H++)F.push(new s(j[H].x,j[H].y));S.push(F)}for(x=0,T=b.length;x<T;x++){var j=b[x],F=[];for(var H=0,B=j.length;H<B;H++)F.push(new s(j[H].x,j[H].y));S.push(F)}var I=new n.Entity;return I.vertices=E,I.faces=w,I.uvs=S,I.material=i===t?e.material:i,I},P.transformElement=function(e,t){var r,i,o=e.vertices,u=e.faces,a=e.uvs,l=[],c=[],h=[];e instanceof n.Element&&(e.matrixAutoUpdate&&e.updateMatrix(),r=e.matrix,i=(new f).getNormalMatrix(r));for(var p=0,d=o.length;p<d;p++){var v=o[p],m=v.clone();r&&m.applyMatrix4(r),c.push(m)}for(p=0,d=u.length;p<d;p++){var g=u[p],y,b,w,E=g.vertexNormals,S=g.vertexColors;g instanceof O?y=new O(g.a,g.b,g.c):y=new M(g.a,g.b,g.c,g.d),y.normal.copy(g.normal),i&&y.normal.applyMatrix3(i).normalize();for(var x=0,T=E.length;x<T;x++)b=E[x].clone(),i&&b.applyMatrix3(i).normalize(),y.vertexNormals.push(b);y.color.copy(g.color);for(var x=0,T=S.length;x<T;x++)w=S[x],y.vertexColors.push(w.clone());y.materialIndex=g.materialIndex,y.centroid.copy(g.centroid),r&&y.centroid.applyMatrix4(r),l.push(y)}for(p=0,d=a.length;p<d;p++){var N=a[p],C=[];for(var x=0,T=N.length;x<T;x++)C.push(new s(N[x].x,N[x].y));h.push(C)}if(t){var k=new n.Entity(e.material);k.vertices=c,k.faces=l,k.uvs=h,k.setPosition(0,0,0),k.setRotation(0,0,0),k.setScale(1,1,1
);var L={};return L.vertices=c,L.faces=l,L.uvs=h,k.primitive=new n.Primitive(L),k}e.vertices=c,e.faces=l,e.uvs=h,e.setPosition(0,0,0),e.setRotation(0,0,0),e.setScale(1,1,1);var L={};L.vertices=c,L.faces=l,L.uvs=h,e.primitive=new n.Primitive(L);for(var p in r.elements)e._attachId+=r.elements[p];return e},P.mergeElements=function(e){var t,r,i,u=0,a=0,l=0,c,h,p;for(t=0;t<e.length;t++)i=e[t],u+=i.materialSize;var d=new n.Entity(u),v={},m={},g=new o(0,0,0),y=[],b=[],w=[],E=[],S=new n.ArrayMaterial;for(t=0;t<e.length;t++){i=e[t],i.matrixAutoUpdate&&i.updateWorldMatrix(),c=i.worldMatrix.clone(),h=(new f).getNormalMatrix(c);for(r=0;r<i.vertices.length;r++)p=i.vertices[r],y.push(p.clone().applyMatrix4(c));for(r=0;r<i.faces.length;r++){var x=i.faces[r],T,N,C,k=x.vertexNormals,L=x.vertexColors;x instanceof O?T=new O(x.a+a,x.b+a,x.c+a):T=new M(x.a+a,x.b+a,x.c+a,x.d+a),T.normal.copy(x.normal),h&&T.normal.applyMatrix3(h).normalize(),T.materialIndex=x.materialIndex+l,T.centroid.copy(x.centroid),c&&T.centroid.applyMatrix4(c),b.push(T)}for(r=0,len=i.uvs.length;r<len;r++){var A=i.uvs[r],_=[];for(var D=0,H=A.length;D<H;D++)_.push(new s(A[D].x,A[D].y));w.push(_)}if(i.uv2s&&i.uv2s.length>0)for(r=0,len=i.uv2s.length;r<len;r++){var B=i.uv2s[r],j=[];for(var D=0,H=B.length;D<H;D++)j.push(new s(B[D].x,B[D].y));E.push(j)}S.materials=S.materials.concat(i.material.materials),a+=i.vertices.length,l+=i.materialSize;for(var F in i.styleMap){var I=v[F];I==null&&(I=[]);var q=i.styleMap[F],R=!0;if(P.isArray(q))for(var D=0;D<q.length;D++)I.push(q[t]),D>0&&q[D]!=q[D-1]&&(R=!1);else for(var D=0;D<i.materialSize;D++)I.push(q);if(m[F]==1||m[F]==null)m[F]=R;v[F]=I}}for(var F in m)m[F]==1&&(v[F]=v[F][0]);return d.styleMap=v,d.material=S,d.vertices=y,d.faces=b,d.setUvs(w),d.uv2s=E,d.setUpdateFlags(!0),d},P.mergeElement=function(e,r,i){var o,u,a,l,c=e.vertices.length,h=e.uvs.length,p=e.vertices,d=r.vertices,v=e.faces,m=r.faces,g=e.uvs,y=r.uvs,b=[],w=[],E=[];i===t&&(i=0),e instanceof n.Element&&(e.matrixAutoUpdate&&e.updateMatrix(),o=e.matrix,u=(new f).getNormalMatrix(o)),r instanceof n.Element&&(r.matrixAutoUpdate&&r.updateMatrix(),a=r.matrix,l=(new f).getNormalMatrix(a));for(var S=0,x=p.length;S<x;S++){var T=p[S],N=T.clone();o&&N.applyMatrix4(o),w.push(N)}for(var S=0,x=d.length;S<x;S++){var T=d[S],N=T.clone();a&&N.applyMatrix4(a),w.push(N)}for(S=0,x=v.length;S<x;S++){var C=v[S],k,L,A,_=C.vertexNormals,D=C.vertexColors;C instanceof O?k=new O(C.a,C.b,C.c):k=new M(C.a,C.b,C.c,C.d),k.normal.copy(C.normal),u&&k.normal.applyMatrix3(u).normalize();for(var P=0,H=_.length;P<H;P++)L=_[P].clone(),u&&L.applyMatrix3(u).normalize(),k.vertexNormals.push(L);k.color.copy(C.color);for(var P=0,H=D.length;P<H;P++)A=D[P],k.vertexColors.push(A.clone());k.materialIndex=C.materialIndex,k.centroid.copy(C.centroid),o&&k.centroid.applyMatrix4(o),b.push(k)}for(S=0,x=m.length;S<x;S++){var C=m[S],k,L,A,_=C.vertexNormals,D=C.vertexColors;C instanceof O?k=new O(C.a+c,C.b+c,C.c+c):k=new M(C.a+c,C.b+c,C.c+c,C.d+c),k.normal.copy(C.normal),l&&k.normal.applyMatrix3(l).normalize();for(var P=0,H=_.length;P<H;P++)L=_[P].clone(),l&&L.applyMatrix3(l).normalize(),k.vertexNormals.push(L);k.color.copy(C.color);for(var P=0,H=D.length;P<H;P++)A=D[P],k.vertexColors.push(A.clone());k.materialIndex=C.materialIndex+i,k.centroid.copy(C.centroid),a&&k.centroid.applyMatrix4(a),b.push(k)}for(S=0,x=g.length;S<x;S++){var B=g[S],j=[];for(var P=0,H=B.length;P<H;P++)j.push(new s(B[P].x,B[P].y));E.push(j)}for(S=0,x=y.length;S<x;S++){var B=y[S],j=[];for(var P=0,H=B.length;P<H;P++)j.push(new s(B[P].x,B[P].y));E.push(j)}return e.vertices=w,e.faces=b,e.uvs=E,e._position.set(0,0,0),e._rotation.set(0,0,0),e._scale.set(1,1,1),e},P.autoAdjustGl3dviewBounds=function(t,n,r,i,s,o){s=s||0,o=o||0,t.adjustBounds(n[r]-s,n[i]-o),e.addEventListener?e.addEventListener("resize",function(){t.adjustBounds(n[r]-s,n[i]-o,o,s)},!0):e.attachEvent?e.attachEvent("onresize",function(){t.adjustBounds(n[r]-s,n[i]-o,o,s)}):e.onresize=function(){t.adjustBounds(n[r]-s,n[i]-o,o,s)}},P.isEmptyObject=function(e){for(var t in e)return!1;return!0},P.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"},P.isSame=function(e,t){if(e===t)return!0;if(e==null&&t!=null)return!1;if(e!=null&&t==null)return!1;if(typeof e!=typeof t)return!1;for(var n in e)if(e[n]!=t[n])return!1;return!0},P.toString=function(e){if(e){var t="";for(var n in e)t+=n+":"+e[n];return t}},P.validateLicense=function(e){G=e,Ir()},P.getLicense=function(){return G},P.getObjectCount=function(e){if(!e)return 0;var t=0;for(var n in e)t++;return t},P.isNaN=function(e){return e===""||e===null||isNaN(e)},P.getTransformVertices=function(e,t,r){r==null&&(r=[]);var i,s;if(e instanceof n.Node||e instanceof n.Billboard){for(i=0;i<e.vertices.length;i++)s=e.vertices[i].clone(),e instanceof n.Billboard?(s.x*=e.rotation3d.x,s.y*=e.rotation3d.y,s.add(e.getPosition())):s.applyMatrix4(e.worldMatrix),r.push(s);for(var i=0;i<(e._childList?e._childList.size():0);i++){var o=e._childList.get(i);P.getTransformVertices(o,t,r)}}return r},P.getBizBox=function(e,t){var r,i,s,o,u;if(e==null)return null;e instanceof N?r=e._as:P.isArray(e)?r=e:r=[e];var a=[];for(i=0;i<r.length;i++)o=r[i],P.getTransformVertices(o,t,a);var f=new n.BizBox;return f.setFromPoints(a),f},P.mergeWrapMap=function(e){if(!(e instanceof _))return;if(e.getWrapMap())return;var t=[],n=e.getMaterialMapping(),r=e.material.materials,i;for(var s=0;s<r.length;s++)i=r[s],i.map&&t.indexOf(i.map._image)==-1&&t.push(i.map._image);e.setWrapMap(!0)},P.setWrapMap=function(e,t,n,r){P.loadImages(t,function(i){var s=mono.Utils.createWrapMapFromImages(i,n,r);s.__uniqueCode="";for(var o=0;o<t.length;o++)s.__uniqueCode+=t[o].src;for(var o in n)s.__uniqueCode+=o+":"+n[o];if(P.isArray(e))for(var o=0;o<e.length;o++)e[o].setStyle("m.texture.image",s),e[o].setClient("_originalImage",t),e[o].setClient("_wrapMapping",n);else e.setStyle("m.texture.image",s),e.setClient("_wrapMapping",n)})},P.loadImages=function(e,t){function i(e){e.onload=function(){e.loaded=!0,s(),e.onload=null}}function s(){for(var n=0;n<e.length;n++)if(!e[n].loaded)return;t(e)}if(e==null||e.length==0||t==null)return;for(var n=0;n<e.length;n++){var r=e[n];typeof r=="string"&&(e[n]=new Image,e[n].crossOrigin="",e[n].src=r),r=e[n],i(r)}},P.createWrapMapFromImages=function(e,t,n,r,i){if(e==null||e.length==0)return null;n=(n||"six-each").toLowerCase();var s=n=="six-each"||n=="front-other"||n=="back-other"||n=="left-other"||n=="right-other"||n=="top-other"||n=="bottom-other";if(!s)return;t==null&&(t={0:"bottom",1:"top",2:"back",3:"left",4:"front",5:"right"});var o=document.createElement("canvas"),u=o.getContext("2d"),a=0,f=0;if(n=="six-each"){var l={bottom:[0,0],top:[1/3,0],back:[2/3,0],left:[0,.5],front:[1/3,.5],right:[2/3,.5]};if(r==null||i==null)for(var c=0;c<e.length;c++)a=Math.max(e[c].width,a),f=Math.max(e[c].height,f);a*=3,f*=2,a>1024&&(a=1024),f>1024&&(f=1024);var h=["front","back","right","left","top","bottom"],p=[],d;for(var c in t){var v=t[c];v!=="other"?(p.push(v),h.splice(h.indexOf(v),1)):d=c}d!=null&&(t[d]=h),r=r||a,i=i||f,o.setAttribute("width",r),o.setAttribute("height",i);var m=Math.min(e.length,6);for(var c=0;c<6;c++){var g=t[c];if(g){var y=g;P.isArray(g)?y=g:g.indexOf(",")!=-1?y=g.split(","):y=[g];for(var b=0;b<y.length;b++){var v=y[b],w=l[v][0],E=l[v][1];u.drawImage(e[c],w*r,E*i,r/3,i/2)}}}}else{var S=n.split("-")[0];if(r==null||i==null)for(var c=0;c<e.length;c++)a+=e[c].width,f=Math.max(e[c].height,f);r=r||a,i=i||f,o.setAttribute("width",r),o.setAttribute("height",i);var x=t[S],m=Math.min(e.length,2);for(var c=0;c<2;c++){var g=t[c];g&&(g==S?u.drawImage(e[c],0,0,r/2,i):u.drawImage(e[c],r/2,0,r/2,i))}}return o},P.getVectorAngles=function(e,t){var n=e;t&&(n=t.clone().sub(e)),n=n.normalize();var r=Math.asin(n.y)*H,i=Math.atan2(n.x,n.z)*H;return[i,r]},P.getPixelFromImage=function(e,t,n){var r;h.isCanvas(e)?r=e:(r=document.createElement("canvas"),r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(e,0,0,e.width,e.height)),t-=Math.floor(t),n-=Math.floor(n),n=1-n;var i=r.getContext("2d").getImageData(e.width*t,e.height*n,1,1).data;return i},P.nextPowerOfTwo=function(e){var t=e;return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e},P.createTextBillboard=function(e,t){var n=new mono.Billboard;e=e||"",t=t||{};var r=P.createTextImage(e,t);return n.setStyle("m.texture.image",r),n.setScale(r.width,r.height,1),n},P.createTextImage=function(e,n){e=e||"";var r=n.font,i=n.color,s=n.background,o=n.powerOfTwo,u=n.canvas,a=n.drawFunction;u=u||document.createElement("canvas"),r=r||'20px "Dialog"',i=i||"white",s=s===t?"#0F90C4":s,o=o||!1;var f=n.textAlign||"center",l;P.isArray(e)?l=e:l=e.split("\n");var c=mono.Utils.getMaxTextSize(l,r),h=n.ratio||c.width/c.height,p=u.realSize={width:c.width,height:c.height};o&&(c.width=mono.Utils.nextPowerOfTwo(c.width),c.height=mono.Utils.nextPowerOfTwo(c.height));var d=u.drawRect={width:p.width/p.height>h?p.width:p.height*h,height:p.width/p.height>h?p.width/h:p.height};Number.isNaN(d.width)&&console.log("debug -- b",p.width,p.height,h),d.width=Math.min(d.width,c.width),d.height=Math.min(d.height,c.height),u.width=c.width,u.height=c.height,Number.isNaN(d.width)&&console.log("debug -- a");var v=u.getContext("2d");s&&(v.fillStyle=s);if(a)a(v,u.width,u.height);else{s&&v.fillRect(0,0,u.width,u.height),v.font=r,v.fillStyle=i,v.strokeStyle="gray",v.textBaseline="middle",v.textAlign=f;var m=l.length,g=p.height/m,y;for(var b=0;b<m;b++){P.isArray(i)&&(y=i[b],y&&(v.fillStyle=y));var w=mono.Utils.getTextSize(r,l[b]),E=w.width,S=w.height,x=u.height,T=(d.width-p.width)/2;f==="center"?T=d.width/2:f==="right"&&(T=d.width);var N=(d.height-p.height)/2+g/2+b*g+(u.height-d.height);v.strokeText(l[b],T,N),v.fillText(l[b],T,N)}}return u},P.createTextImage2=function(e,n){e=e||"",e=String(e);var r=n.font,i=n.color,s=n.background,o=n.powerOfTwo,u=n.canvas,a=n.drawFunction;u=u||document.createElement("canvas"),r=r||'20px "Dialog"',i=i||"white",s=s===t?"#0F90C4":s,o=o||!1;var f=n.align||"center",l=n.sizeScale||1,c=P.getMaxTextSize(e.split("\n"),r);u.realSize={width:c.width,height:c.height},c.width*=l,c.height*=l,o&&(c.width=P.nextPowerOfTwo(c.width),c.height=P.nextPowerOfTwo(c.height)),u.width=c.width,u.height=c.height;var h=u.getContext("2d");return s&&(h.fillStyle=s),a?a(h,u.width,u.height):(s&&h.fillRect(0,0,u.width,u.height),F(h,e,r,i,u,"center")),u},P.getMaxTextSize=function(e,t){if(e&&e.length>0){var n=e.length,r=y.getTextSize(t,e[0]),i=r.width,s=r.height*n;for(var o=0;o<n;o++){var u=y.getTextSize(t,e[o]).width;i<u&&(i=u)}return{width:i,height:s}}return null},P.getTextSize=function(e,t){return y.getTextSize(e,t)},P.playGleyeAnimation=function(e,t,n,r,i){t=t||e.p(),n=n||e.getTarget(),r=r||2e3;var s=mono.Utils.getVectorAngles(e.getTarget(),e.p()),o=mono.Utils.getVectorAngles(n,t),u=e.getTarget(),a=n,f=e.getDistance(),l=(new mono.XiangliangThree).subVectors(t,n).length();(new mono.Animate({from:0,to:1,repeat:1,dur:r,onPlay:function(){},onUpdate:function(t){var n=s[0]+(o[0]-s[0])*t,r=s[1]+(o[1]-s[1])*t,i=(new mono.XiangliangThree).lerpVectors(u,a,t),c=f+(l-f)*t,h=new mono.XiangliangThree;h.x=i.x+c*Math.sin(n*B)*Math.cos(r*B),h.z=i.z+c*Math.cos(n*B)*Math.cos(r*B),h.y=i.y+c*Math.sin(r*B),e.lookAt(i),e.p(h)},onDone:function(){i&&i()}})).play()},P.stopAnimate=function(e,t){Ai(e,t)},P.stopAllAnimates=function(e){Oi(e)},n.Utils=P,n.GLParameters=function(e,t,r){this.material=e,this.gl3dview=t,this.precision=t._precision,this.map=!!e.map,this.mapLoaded=!0,this.envMap=!!e.envMap,this.lightMap=!!e.lightMap,this.bumpMap=!!e.bumpMap&&e._type==="phong",this.normalMap=!!e.normalMap&&e._type==="phong",this.specularMap=!!e.specularMap,this.vertexColors=e.vertexColors,this.fog=t._fog,this.useFog=e.fog,this.fogExp=this.fog instanceof n.FogExp2,this.sizeAttenuation=e.sizeAttenuation,this.skinning=e.skinning,this.maxBones=t.maxBones,this.useVertexTexture=t._supportsBoneTextures&&r&&r.useVertexTexture,this.boneTextureWidth=r&&r.boneTextureWidth,this.boneTextureHeight=r&&r.boneTextureHeight,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.maxMorphTargets=t.maxMorphTargets,this.maxMorphNormals=t.maxMorphNormals,this.maxDirLights=t.maxLightCount.directional,this.maxPointLights=t.maxLightCount.point,this.maxSpotLights=t.maxLightCount.spot,this.maxHemiLights=t.maxLightCount.hemi,this.maxShadows=t.maxShadows,this.maxPointShadows=t.maxPointShadows,this.shadowMapEnable=t._shadowMapEnable&&r.receiveShadow&&this.maxShadows>0,this.pointShadowMapEnable=t._shadowMapEnable&&r.receiveShadow&&this.maxPointShadows>0,this.shadowMapType=t.shadowMapType,this.shadowMapDebug=t.shadowMapDebug,this.shadowMapCascade=t.shadowMapCascade,this.alphaTest=e.alphaTest,this.metal=e.metal,this.perPixel=e.perPixel,this.wrapAround=e.wrapAround,this.doubleSided=e.side===n.DoubleSide&&!p.isIE,this.flipSided=e.side===n.BackSide,this.useSSAO=t.isSSAOEnable()&&t.pm.isLightMaterial(e),this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.physicallyBasedShading=t.physicallyBasedShading,this.supportsVertexTextures=!1,this.shadowMapTypeDefine="SHADOWMAP_TYPE_BASIC",this.shadowMapType===n.PCFShadowMap?this.shadowMapTypeDefine="SHADOWMAP_TYPE_PCF":this.shadowMapType===n.PCFSoftShadowMap&&(this.shadowMapTypeDefine="SHADOWMAP_TYPE_PCF_SOFT"),this.maxGrandient=P.getObjectCount(e.gradient)},n.GLParameters.prototype.getShaders=function(e){e=e===t?"":e;var n=this,r=["precision "+n.precision+" float;",e,this.supportsVertexTextures?"#define VERTEX_TEXTURES":"",n.gammaInput?"#define GAMMA_INPUT":"",n.gammaOutput?"#define GAMMA_OUTPUT":"",n.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+n.maxDirLights,"#define MAX_POINT_LIGHTS "+n.maxPointLights,"#define MAX_SPOT_LIGHTS "+n.maxSpotLights,"#define MAX_HEMI_LIGHTS "+n.maxHemiLights,"#define MAX_SHADOWS "+n.maxShadows,"#define MAX_POINT_SHADOWS "+n.maxPointShadows,"#define MAX_BONES "+n.maxBones,n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.lightMap?"#define USE_LIGHTMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.vertexColors?"#define USE_COLOR":"",n.maxGrandient>0?"#define MAX_GRADIENT "+n.maxGrandient:"",n.skinning?"#define USE_SKINNING":"",n.useVertexTexture?"#define BONE_TEXTURE":"",n.boneTextureWidth?"#define N_BONE_PIXEL_X "+n.boneTextureWidth.toFixed(1):"",n.boneTextureHeight?"#define N_BONE_PIXEL_Y "+n.boneTextureHeight.toFixed(1):"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals?"#define USE_MORPHNORMALS":"",n.perPixel?"#define PHONG_PER_PIXEL":"",n.wrapAround?"#define WRAP_AROUND":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnable?"#define USE_SHADOWMAP":"",n.shadowMapEnable?"#define "+n.shadowMapTypeDefine:"",n.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",n.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",n.pointShadowMapEnable?"#define USE_POINT_SHADOWMAP":"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 gleyePosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),i=["precision "+this.precision+" float;",n.bumpMap||n.normalMap?"#extension GL_OES_standard_derivatives : enable":"",e,"#define MAX_DIR_LIGHTS "+n.maxDirLights,"#define MAX_POINT_LIGHTS "+n.maxPointLights,"#define MAX_SPOT_LIGHTS "+n.maxSpotLights,"#define MAX_HEMI_LIGHTS "+n.maxHemiLights,"#define MAX_SHADOWS "+n.maxShadows,"#define MAX_POINT_SHADOWS "+n.maxPointShadows,n.useSSAO?"#define USE_SSAO":"",n.alphaTest?"#define ALPHATEST "+n.alphaTest:"",this.gammaInput?"#define GAMMA_INPUT":"",this.gammaOutput?"#define GAMMA_OUTPUT":"",this.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.lightMap?"#define USE_LIGHTMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.maxGrandient>0?"#define MAX_GRADIENT "+n.maxGrandient:"",n.vertexColors?"#define USE_COLOR":"",n.metal?"#define METAL":"",n.perPixel?"#define PHONG_PER_PIXEL":"",n.wrapAround?"#define WRAP_AROUND":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnable?"#define USE_SHADOWMAP":"",n.shadowMapEnable?"#define "+n.shadowMapTypeDefine:"",n.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",n.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",n.pointShadowMapEnable?"#define USE_POINT_SHADOWMAP":"","uniform mat4 viewMatrix;","uniform vec3 gleyePosition;",""].join("\n");return[r,i]};var I={};I.setDepthTest=function(e,t){var n=t._gl;t._oldDepthTest!==e&&(e?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),t._oldDepthTest=e)},I.setSmapleAlphaToCoverage=function(e,t){var n=t._gl;t._oldSmapleAlphaToCoverage!==e&&(e?n.enable(n.SAMPLE_ALPHA_TO_COVERAGE):n.disable(n.SAMPLE_ALPHA_TO_COVERAGE),t._oldSmapleAlphaToCoverage=e)},I.setDepthWrite=function(e,t){var n=t._gl;t._oldDepthWrite!==e&&(n.depthMask(e),t._oldDepthWrite=e)},I.clear=function(e,n,r,i){var s=i._gl,o=0;if(e===t||e)o|=s.COLOR_BUFFER_BIT;if(n===t||n)o|=s.DEPTH_BUFFER_BIT;if(r===t||r)o|=s.STENCIL_BUFFER_BIT;i._gl.clear(o)},I.setPolygonOffset=function(e,t,n,r){var i=r._gl;r._oldPolygonOffset!==e&&(e?i.enable(i.POLYGON_OFFSET_FILL):i.disable(i.POLYGON_OFFSET_FILL),r._oldPolygonOffset=e),e&&(r._oldPolygonOffsetFactor!==t||r._oldPolygonOffsetUnits!==n)&&(i.polygonOffset(t,n),r._oldPolygonOffsetFactor=t,r._oldPolygonOffsetUnits=n)},I.setBlending=function(e,t,r,i,s){var o=s._gl;e!==s._oldBlending&&(e===n.NoBlending?o.disable(o.BLEND):e===n.AdditiveBlending?(o.enable(o.BLEND),o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE)):e===n.SubtractiveBlending?(o.enable(o.BLEND),o.blendEquation(o.FUNC_ADD),o.blendFunc(o.ZERO,o.ONE_MINUS_SRC_COLOR)):e===n.MultiplyBlending?(o.enable(o.BLEND),o.blendEquation(o.FUNC_ADD),o.blendFunc(o.ZERO,o.SRC_COLOR)):e===n.CustomBlending?o.enable(o.BLEND):(o.enable(o.BLEND),o.blendEquationSeparate(o.FUNC_ADD,o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)),s._oldBlending=e);if(e===n.CustomBlending){t!==this._oldBlendEquation&&(o.blendEquation(paramThreeToGL(t)),s._oldBlendEquation=t);if(r!==_oldBlendSrc||i!==_oldBlendDst)o.blendFunc(paramToGL(r),paramToGL(i)),s._oldBlendSrc=r,s._oldBlendDst=i}else s._oldBlendEquation=null,s._oldBlendSrc=null,s._oldBlendDst=null},I.enableStencil=function(e){e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,1),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),e.stencilMask(1),e.clearStencil(0),e.clear(e.STENCIL_BUFFER_BIT)},I.stencilTest=function(e){e.enable(e.STENCIL_TEST),e.stencilFunc(e.EQUAL,0,1),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(0)},I.disableStencil=function(e){e.disable(e.STENCIL_TEST)},I.r=function(e,t,n,r,i,s,o){e._AK47(t,n,r,i,s,o)},I.g=function(e,t,n,r,i,s){e.renderGroup(t,n,r,i,s)},n.GLUtils=I,n.GPU=function(e){var t=e._gl;this._glExtensionTextureFloat=t.getExtension("OES_texture_float"),this._glExtensionStandardDerivatives=t.getExtension("OES_standard_derivatives"),this._glExtensionTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this._glExtensionCompressedTextureS3TC=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this._glExtensionTextureFloat||console.log("Float textures not supported."),this._glExtensionStandardDerivatives||console.log("Standard derivatives not supported."),this._glExtensionTextureFilterAnisotropic||console.log("Anisotropic texture filtering not supported."),this._glExtensionCompressedTextureS3TC||console.log("S3TC compressed textures not supported."),this._maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._maxCubemapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxAnisotropy=this._glExtensionTextureFilterAnisotropic?t.getParameter(this._glExtensionTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._supportsVertexTextures=this._maxVertexTextures>0,this._supportsBoneTextures=this._supportsVertexTextures&&this._glExtensionTextureFloat,this._compressedTextureFormats=this._glExtensionCompressedTextureS3TC?t.getParameter(t.COMPRESSED_TEXTURE_FORMATS):[],this._vertexShaderPrecisionHighpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),this._vertexShaderPrecisionMediumpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),this._vertexShaderPrecisionLowpFloat=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_FLOAT),this._fragmentShaderPrecisionHighpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),this._fragmentShaderPrecisionMediumpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),this._fragmentShaderPrecisionLowpFloat=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_FLOAT),this._vertexShaderPrecisionHighpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_INT),this._vertexShaderPrecisionMediumpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_INT),this._vertexShaderPrecisionLowpInt=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_INT),this._fragmentShaderPrecisionHighpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_INT),this._fragmentShaderPrecisionMediumpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_INT),this._fragmentShaderPrecisionLowpInt=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_INT);var n=this._vertexShaderPrecisionHighpFloat.precision>0&&this._fragmentShaderPrecisionHighpFloat.precision>0,r=this._vertexShaderPrecisionMediumpFloat.precision>0&&this._fragmentShaderPrecisionMediumpFloat.precision>0,i=e._precision;i==="highp"&&!n&&(r?(i="mediump",console.log("highp not supported, using mediump")):(i="lowp",console.log("highp and mediump not supported, using lowp"))),i==="mediump"&&!r&&(i="lowp",console.log("mediump not supported, using lowp")),e._precision=i},n.Program=function(e,t,n,r){this.entity=e,this.group=t,this.material=n,this.gl3dview=r},n.Program.prototype.setEntity=function(){this.entity},n.Program.prototype.buildGLProgram=function(){},n.Uniform=function(e,n,r){this.id=e,this.type=n,this.value=r,this.location=t},n.Uniform.prototype={constructor:n.Uniform,setValue:function(e){this.value=e},getUniformLocation:function(e,t){return e.getUniformLocation(this.id)}},n.Uniform.loadUniform=function(e,n,r){type=n.type,value=n.value;if(type==="i")r.uniform1i(e,value);else if(type==="f")r.uniform1f(e,value);else if(type==="v2")r.uniform2f(e,value.x,value.y);else if(type==="v3")r.uniform3f(e,value.x,value.y,value.z);else if(type==="v4")r.uniform4f(e,value.x,value.y,value.z,value.w);else if(type==="c")r.uniform3f(e,value.r,value.g,value.b);else if(type==="iv1")r.uniform1iv(e,value);else if(type==="iv")r.uniform3iv(e,value);else if(type==="fv1")r.uniform1fv(e,value);else if(type==="fv")r.uniform3fv(e,value);else if(type==="v2v"){n._array===t&&(n._array=new Float32Array(2*value.length));for(i=0,il=value.length;i<il;i++)offset=i*2,n._array[offset]=value[i].x,n._array[offset+1]=value[i].y;r.uniform2fv(e,n._array)}else if(type==="v3v"){n._array===t&&(n._array=new Float32Array(3*value.length));for(i=0,il=value.length;i<il;i++)offset=i*3,n._array[offset]=value[i].x,n._array[offset+1]=value[i].y,n._array[offset+2]=value[i].z;r.uniform3fv(e,n._array)}else if(type==="v4v"){n._array===t&&(n._array=new Float32Array(4*value.length));for(i=0,il=value.length;i<il;i++)offset=i*4,n._array[offset]=value[i].x,n._array[offset+1]=value[i].y,n._array[offset+2]=value[i].z,n._array[offset+3]=value[i].w;r.uniform4fv(e,n._array)}else if(type==="m4")n._array===t&&(n._array=new Float32Array(16)),value.flattenToArray(n._array),r.uniformMatrix4fv(e,!1,n._array);else if(type==="m4v"){n._array===t&&(n._array=new Float32Array(16*value.length));for(i=0,il=value.length;i<il;i++)value[i].flattenToArrayOffset(n._array,i*16);r.uniformMatrix4fv(e,!1,n._array)}else if(type==="t")texture=value,textureUnit=getTextureUnit(),r.uniform1i(e,textureUnit),!texture||(texture.image instanceof Array&&texture.image.length===6?setCubeTexture(texture,textureUnit):texture instanceof $CubeRenderTargetCube?setCubeTextureDynamic(texture,textureUnit):_this.setTexture(texture,textureUnit));else if(type==="tv"){n._array===t&&(n._array=[]);for(i=0,il=n.value.length;i<il;i++)n._array[i]=getTextureUnit();r.uniform1iv(e,n._array);for(i=0,il=n.value.length;i<il;i++){texture=n.value[i],textureUnit=n._array[i];if(!texture)continue;_this.setTexture(texture,textureUnit)}}},n.Uniform.loadGeneralUniforms=function(e,t,r){var i,s,o,u,a,f,l,c,h,p,d;for(h=0,p=t.length;h<p;h++){u=e.uniforms[t[h][1]];if(!u)continue;i=t[h][0],n.Uniform.loadUniform(i,r)}},n.ProgramManager=function(e){this.id=n.ProgramManagerId++,n.ProgramManagerCache.count++,this.gl3dview=e,this.gl=this.gl3dview._gl,this.gpu=this.gl3dview.gpu,this.programs=[],this.currentProgram=null,this.currentEntity=null,this.currentGroup=null,this.currentMaterial=null,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0},currentMaterialId:-1},this.textures=[],this.textureCount=0,this._lightNeedsUpdate=!0,this._lights={ambient:[0,0,0],directional:{length:0,colors:new Array,positions:new Array},point:{length:0,colors:new Array,positions:new Array,distances:new Array},spot:{length:0,colors:new Array,positions:new Array,distances:new Array,directions:new Array,anglesCos:new Array,exponents:new Array},hemi:{length:0,skyColors:new Array,groundColors:new Array,positions:new Array}},this.gammaInput=!1,this.textureCount=0,this.programMap={},this.textureMap={},this.textureUpdateFlags={},this.glTextureMap={},this.textureMaterialMap={},this.unLoadedImage={},this.materialMap={},this.materialUpdateFlags={},this.handleTextureChange=function(e){if(e.property==="image"||e.property==="loaded"){var t=e.source;this.changeTextureUpdateFlags(t,!0),delete this.unLoadedImage[t._image]}else if(e.property==="disposed"){var t=e.source;this.deallocateTexture(t),t.removePropertyChangeListener(this.handleTextureChange),delete this.textureUpdateFlags[t.id],delete this.textureMap[t.id]}P.getObjectCount(this.unLoadedImage)<=0&&this.gl3dview.dirtyGl3dview()},this.handleMaterialChange=function(e){if(e.property=="map"||e.property.endsWith("Map")||e.property==="needsUpdate"){var t=e.source;this.materialUpdateFlags[t.id]=!0}else if(e.property==="disposed"){var t=e.source;this.deallocateMaterial(t),t.removePropertyChangeListener(this.handleMaterialChange),delete this.materialUpdateFlags[t.id],delete this.materialMap[t.id],delete this.programMap[t.id]}P.getObjectCount(this.unLoadedImage)<=0&&this.gl3dview.dirtyGl3dview()}},n.ProgramManager.prototype.addMaterial=function(e){this.materialMap[e.id]==null&&(this.materialMap[e.id]=e,e.addPropertyChangeListener(this.handleMaterialChange,this))},n.ProgramManager.prototype.needsUpdateMaterial=function(e){return this.materialUpdateFlags[e.id]===t||this.materialUpdateFlags[e.id]===!0?!0:e.map instanceof $||e.map instanceof J?!0:!1},n.ProgramManager.prototype.changeMaterialUpdateFlags=function(e,t){this.materialUpdateFlags[e.id]=t},n.ProgramManager.prototype.isLightMaterial=function(e){return e instanceof n.LambertMaterial||e instanceof n.PhongMaterial||e.lights||e._type==="lambert"||e._type==="phong"||e._type==="terrain"},n.ProgramManager.prototype.changeAllMaterialUpdateFlags=function(e,t,n){for(var r in this.materialMap){var i=this.materialMap[r];if(t==null||t.call(n,i))this.materialUpdateFlags[i.id]=e}},n.ProgramManager.prototype.changeAllLightMaterialUpdateFlags=function(e){this.changeAllMaterialUpdateFlags(e,this.isLightMaterial,this)},n.ProgramManager.prototype.addTexture=function(e){e.id!=null&&this.textureMap[e.id]===t&&(this.textureMap[e.id]=e,e.addPropertyChangeListener(this.handleTextureChange,this),e._image.loaded||(this.unLoadedImage[e._image]=1))},n.ProgramManager.prototype.needsUpdateTexture=function(e){return this.textureUpdateFlags[e.id]===t||this.textureUpdateFlags[e.id]===!0?!0:!1},n.ProgramManager.prototype.changeTextureUpdateFlags=function(e,t){this.textureUpdateFlags[e.id]=t;for(var n in this.materialMap){var r=this.materialMap[n];(r.map===e||r.lightMap===e||r.envMap===e||r.normalMap===e||r.specularMap===e)&&this.changeMaterialUpdateFlags(r,!0)}},n.ProgramManager.prototype.buildProgram=function(e,t,r){this.currentEntity=e,this.currentGroup=t,this.currentMaterial=r,r.shaderID||r.setupMaterialShader();var i=new n.GLParameters(this.currentMaterial,this.gl3dview,e),s,o,u,a,f=[];r.shaderID?f.push(r.shaderID):(f.push(r.vertexShader),f.push(r.fragmentShader));for(Wr in i)Wr!=="material"&&Wr!=="gl3dview"&&Wr!=="node"&&(f.push(Wr),f.push(i[Wr]));a=f.join();for(s=0,o=this.programs.length;s<o;s++)if(this.programs[s].code===a){r.program=this.programs[s].program,r.uniformsList=[];for(d in r.uniforms)r.uniformsList.push([r.uniforms[d],d]);return this.programs[s].usedTimes++,this.programs[s].program}u=this.gl.createProgram();var l=i.getShaders(),c=l[1],h=l[0];this.gl.attachShader(u,z("fragment",c+r.fragmentShader,this.gl)),this.gl.attachShader(u,z("vertex",h+r.vertexShader,this.gl)),this.gl.linkProgram(u),this.gl.getProgramParameter(u,this.gl.LINK_STATUS)||console.log("Could not initialise shader\nVALIDATE_STATUS: "+this.gl.getProgramParameter(u,this.gl.VALIDATE_STATUS)+", gl error ["+this.gl.getError()+"]"),u.uniforms={},u.attributes={};var p,d,v,s;p=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","gleyePosition","boneGlobalMatrices","morphTargetInfluences"];for(d in r.uniforms)p.push(d);this.attachGLLocations(u,p,"uniform"),p=["position","normal","uv","uv2","tangent","color","skinVertexA","skinVertexB","skinIndex","skinWeight"];for(s=0;s<i.maxMorphTargets;s++)p.push("morphTarget"+s);for(s=0;s<i.maxMorphNormals;s++)p.push("morphNormal"+s);for(v in r.attributes)p.push(v);this.attachGLLocations(u,p,"attribute"),u.id=this.programs.length,this.programs.push({program:u,code:a,usedTimes:1}),this.info.memory.programCount=this.programs.length,r.program=u,r.uniformsList=[];for(d in r.uniforms)r.uniformsList.push([r.uniforms[d],d]);return u},n.ProgramManager.prototype.enableAttribute=function(e,n){var r=n.program.attributes;r.position>=0&&_gl.enableVertexAttribArray(r.position),r.color>=0&&_gl.enableVertexAttribArray(r.color),r.normal>=0&&_gl.enableVertexAttribArray(r.normal);if(n.attributes)for(a in n.attributes)r[a]!==t&&r[a]>=0&&_gl.enableVertexAttribArray(r[a])},n.ProgramManager.prototype.attachGLLocations=function(e,t,n){var r,i,s,o=this.gl;if(n==="uniform")for(r=0,i=t.length;r<i;r++)s=t[r],e.uniforms[s]=o.getUniformLocation(e,s);else if(n==="attribute")for(r=0,i=t.length;r<i;r++)s=t[r],e.attributes[s]=o.getAttribLocation(e,s)},n.ProgramManager.prototype.getGLShaders=function(e,t){var n;return e==="fragment"?n=this.gl.createShader(this.gl.FRAGMENT_SHADER):tpye==="vertex"&&(n=this.gl.createShader(this.gl.VERTEX_SHADER)),this.gl.shaderSource(n,string),this.gl.compileShader(n),gl.getShaderParameter(n,gl.COMPILE_STATUS)?n:(console.log(gl.getShaderInfoLog(n)),console.log(string),null)},n.ProgramManager.prototype.setProgram=function(e,t,r,i,s,o){this.textureCount=0,this.addMaterial(i);if(this.needsUpdateMaterial(i)){i.setupMaterialShader(),this.programMap[i.id]&&this.deallocateMaterial(i);var u=this.buildProgram(o,s,i);this.programMap[i.id]=u,this.changeMaterialUpdateFlags(i,!1)}var a=!1,f=this.programMap[i.id],l=f.uniforms,c=i.uniforms;f!=this.currentProgram&&(this.gl.useProgram(f),this.currentProgram=f,a=!0),i.id!==this.currentMaterialId&&(this.currentMaterialId=i.id,a=!0);if(a||e!==this.gl3dview._currentGleye)this.gl.uniformMatrix4fv(l.projectionMatrix,!1,e.projectionMatrix.elements),e!==this.gl3dview._currentGleye&&(this.gl3dview
._currentGleye=e);r&&i.fog&&r.refreshUniforms(c);if(i instanceof n.PhongMaterial||i instanceof n.LambertMaterial||i.lights||i._type==="phong"||i._type==="lambert"||i._type==="terrain")this._lightNeedsUpdate&&(this.setupLights(f,t),this._lightNeedsUpdate=!1),W(c,this._lights);return a&&i.refreshUniforms(!1,{gleye:this.gl3dview._gleye}),o.receiveShadow&&!i._shadowPass&&this.gl3dview.isShadowable()&&(q(c,t),R(c,t)),a&&this.loadUniformsGeneric(f,i.uniformsList,i),i.loadGleyePosition(l,e,this.gl),(i instanceof n.PhongMaterial||i instanceof n.LambertMaterial||i.skinning||i._type==="phong"||i._type==="lambert"||i._type==="terrain"||i instanceof n.ShaderMaterial)&&l.viewMatrix!==null&&this.gl.uniformMatrix4fv(l.viewMatrix,!1,e.worldMatrixInverse.elements),U(l,o,this.gl),l.modelMatrix!=null&&this.gl.uniformMatrix4fv(l.modelMatrix,!1,o.worldMatrix.elements),this.gl3dview._baseRender&&this.loadSSAOUniforms(l,i,a),f},n.ProgramManager.prototype.loadSSAOUniforms=function(e,t,n){if(e.mapSSAO!=null&&this.gl3dview._sSAOEnable){var r=e.mapSSAO,i=n?this.getTextureUnit():t._ssaoSlot;this.gl.uniform1i(r,i),this.setTexture(this.gl3dview.finalSSAOTarget,i),t._ssaoSlot=i}},n.ProgramManager.prototype.onTextureDispose=function(e){var t=e.target;t.removeEventListener("dispose",onTextureDispose),deallocateTexture(t),this.info.memory.textures--},n.ProgramManager.prototype.deallocateTexture=function(e){var t=this.gl;if(e._image&&e._image.__webglTextureCube)t.deleteTexture(e._image.__webglTextureCube);else{if(!e.__webglInit)return;e.__webglInit=!1,t.deleteTexture(e.__webglTexture)}},n.ProgramManager.prototype.setTextureParameters=function(e,t,r,i){var s=this.gl,o=this.gpu,u=n.Utils.paramToGL;r&&!i?(s.texParameteri(e,s.TEXTURE_WRAP_S,u(t.wrapS,s)),s.texParameteri(e,s.TEXTURE_WRAP_T,u(t.wrapT,s)),s.texParameteri(e,s.TEXTURE_MAG_FILTER,u(t.magFilter,s)),s.texParameteri(e,s.TEXTURE_MIN_FILTER,u(t.minFilter,s))):(s.texParameteri(e,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(e,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(e,s.TEXTURE_MAG_FILTER,this.filterFallback(t.magFilter)),s.texParameteri(e,s.TEXTURE_MIN_FILTER,this.filterFallback(t.minFilter))),o._glExtensionTextureFilterAnisotropic&&t.type!==n.FloatType&&(t.anisotropy>1||t.__oldAnisotropy)&&(s.texParameterf(e,o._glExtensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,o._maxAnisotropy)),t.__oldAnisotropy=t.anisotropy)},n.ProgramManager.prototype.setCubeTexture=function(e,r){var i=this.gl;this.addTexture(e);var s=e.id;if(e._image.length===6){if(!e._image.loaded)return;var o=n.Utils.isPowerOfTwo,u=n.Utils.paramToGL;if(this.needsUpdateTexture(e)){this.glTextureMap[s]===t&&(this.glTextureMap[s]=i.createTexture(),this.info.memory.texture++),this.changeTextureUpdateFlags(e,!1),i.activeTexture(i.TEXTURE0+r),i.bindTexture(i.TEXTURE_CUBE_MAP,this.glTextureMap[s]),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e.flipY);var a=e instanceof n.CompressedTexture,f=[];for(var l=0;l<6;l++)this.autoScaleCubemaps&&!a?f[l]=clampToMaxSize(e._image[l],_maxCubemapSize):f[l]=e._image[l];var c=f[0],h=o(c.width)&&o(c.height),p=u(e.format,i),d=u(e.type,i);this.setTextureParameters(i.TEXTURE_CUBE_MAP,e,h);for(var l=0;l<6;l++)if(a){var v,m=f[l].mipmaps;for(var g=0,y=m.length;g<y;g++)v=m[g],i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,p,v.width,v.height,0,v.data)}else i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,p,p,d,f[l]);e.generateMipmaps&&h&&i.generateMipmap(i.TEXTURE_CUBE_MAP),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else i.activeTexture(i.TEXTURE0+r),i.bindTexture(i.TEXTURE_CUBE_MAP,this.glTextureMap[s])}},n.ProgramManager.prototype.setCubeTextureDynamic=function(e,t){var n=this.gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_CUBE_MAP,e.__webglTexture)},n.ProgramManager.prototype.loadUniformsGeneric=function(e,r,i){var s=this.gl,o,u,a,f,l,c,h,p,d,v,m;for(d=0,v=r.length;d<v;d++){f=e.uniforms[r[d][1]];if(!f)continue;o=r[d][0],a=o.type,u=o.value;if(a==="i")s.uniform1i(f,u);else if(a==="f")s.uniform1f(f,u);else if(a==="v2")s.uniform2f(f,u.x,u.y);else if(a==="v3")s.uniform3f(f,u.x,u.y,u.z);else if(a==="v4")s.uniform4f(f,u.x,u.y,u.z,u.w);else if(a==="c")s.uniform3f(f,u.r,u.g,u.b);else if(a==="iv1")s.uniform1iv(f,u);else if(a==="iv")s.uniform3iv(f,u);else if(a==="fv1")s.uniform1fv(f,u);else if(a==="fv")s.uniform3fv(f,u);else if(a==="v2v"){o._array===t&&(o._array=new Float32Array(2*u.length));for(h=0,p=u.length;h<p;h++)m=h*2,o._array[m]=u[h].x,o._array[m+1]=u[h].y;s.uniform2fv(f,o._array)}else if(a==="v3v"){o._array===t&&(o._array=new Float32Array(3*u.length));for(h=0,p=u.length;h<p;h++)m=h*3,u[h]instanceof n.Color?(o._array[m]=u[h].r,o._array[m+1]=u[h].g,o._array[m+2]=u[h].b):(o._array[m]=u[h].x,o._array[m+1]=u[h].y,o._array[m+2]=u[h].z);s.uniform3fv(f,o._array)}else if(a==="v4v"){o._array===t&&(o._array=new Float32Array(4*u.length));for(h=0,p=u.length;h<p;h++)m=h*4,o._array[m]=u[h].x,o._array[m+1]=u[h].y,o._array[m+2]=u[h].z,o._array[m+3]=u[h].w;s.uniform4fv(f,o._array)}else if(a==="m4")o._array===t&&(o._array=new Float32Array(16)),u.flattenToArray(o._array),s.uniformMatrix4fv(f,!1,o._array);else if(a==="m4v"){o._array===t&&(o._array=new Float32Array(16*u.length));for(h=0,p=u.length;h<p;h++)u[h].flattenToArrayOffset(o._array,h*16);s.uniformMatrix4fv(f,!1,o._array)}else if(a==="t"){l=u,c=this.getTextureUnit(),s.uniform1i(f,c);if(!l)continue;if(l._image instanceof Array&&l._image.length===6)this.setCubeTexture(l,c);else{var g=l._image;this.setTexture(l,c,g?!g.loaded:!0)}}else if(a==="tv"){o._array===t&&(o._array=[]);for(h=0,p=o.value.length;h<p;h++)o._array[h]=this.getTextureUnit();s.uniform1iv(f,o._array);for(h=0,p=o.value.length;h<p;h++){l=o.value[h],c=o._array[h];if(!l)continue;var g=l._image;l instanceof J?this.setCubeTextureDynamic(l,c):this.setTexture(l,c,g?!g.loaded:!0)}}}},n.ProgramManager.prototype.setTexture=function(e,r,i){var s=this.gl,o=n.Utils.isPowerOfTwo,u=e.id;this.addTexture(e);if(!this.needsUpdateTexture(e)||e instanceof $)s.activeTexture(s.TEXTURE0+r),e instanceof $?s.bindTexture(s.TEXTURE_2D,e.__webglTexture):s.bindTexture(s.TEXTURE_2D,this.glTextureMap[u]);else{if(!e._image)return;this.glTextureMap[u]===t&&(this.glTextureMap[u]=s.createTexture(),this.info.memory.textures++),this.changeTextureUpdateFlags(e,!1),s.activeTexture(s.TEXTURE0+r),s.bindTexture(s.TEXTURE_2D,this.glTextureMap[u]),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!e.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,e.unpackAlignment);var a=n.Utils.paramToGL,f=i?n.ImageCache.Logo:e._image,l=o(f.width)&&o(f.height),c=a(e.format,s),h=a(e.type,s);this.setTextureParameters(s.TEXTURE_2D,e,l,i);var p,d=e.mipmaps;if(e instanceof n.PixelsTexture)if(d.length>0&&l){for(var v=0,m=d.length;v<m;v++)p=d[v],s.texImage2D(s.TEXTURE_2D,v,c,p.width,p.height,0,c,h,p.data);e.generateMipmaps=!1}else s.texImage2D(s.TEXTURE_2D,0,c,f.width,f.height,0,c,h,f.data);else if(e instanceof n.CompressedTexture)for(var v=0,m=d.length;v<m;v++)p=d[v],s.compressedTexImage2D(s.TEXTURE_2D,v,c,p.width,p.height,0,p.data);else if(d.length>0&&l){for(var v=0,m=d.length;v<m;v++)p=d[v],s.texImage2D(s.TEXTURE_2D,v,c,c,h,p);e.generateMipmaps=!1}else try{s.texImage2D(s.TEXTURE_2D,0,c,c,h,f)}catch(g){console.log(g)}e.generateMipmaps&&l&&s.generateMipmap(s.TEXTURE_2D),e.onUpdate&&e.onUpdate()}},n.ProgramManager.prototype.getTextureUnit=function(){var e=this.textureCount;return e>=this.gpu._maxTextures&&console.warn("Gl3dview3D: trying to use "+e+" texture units while this GPU supports only "+this.gpu._maxTextures),this.textureCount++,e},n.ProgramManager.prototype.deallocateMaterial=function(e){var n=e.program;if(n===t)return;e.program=t;var r,i,s,o=!1;for(r=0,i=this.programs.length;r<i;r++){s=this.programs[r];if(s.program===n){s.usedTimes--,s.usedTimes===0&&(o=!0);break}}if(o===!0){var u=[];for(r=0,i=this.programs.length;r<i;r++)s=this.programs[r],s.program!==n&&u.push(s);this.programs=u,this.gl.deleteProgram(n),this.info.memory.programs--}},n.ProgramManager.prototype.filterFallback=function(e){return e===n.NearestFilter||e===n.NearestMipMapNearestFilter||e===n.NearestMipMapLinearFilter?this.gl.NEAREST:this.gl.LINEAR},n.ProgramManager.prototype.setupLights=function(e,t){var r,i,s,o,u=0,a=0,f=0,l,c,h,p,d,v,m,g=this._lights,y=g.directional.colors,b=g.directional.positions,w=g.point.colors,E=g.point.positions,S=g.point.distances,x=g.spot.colors,T=g.spot.positions,N=g.spot.distances,C=g.spot.directions,k=g.spot.anglesCos,L=g.spot.exponents,A=g.hemi.skyColors,O=g.hemi.groundColors,M=g.hemi.positions,_=0,D=0,P=0,H=0,B=0,j=0,F=0,I=0,q=0,R=0,U=0,z=0,W=new n.XiangliangThree;for(r=0,i=t.size();r<i;r++){s=t.get(r);if(s.onlyShadow)continue;l=s.color,p=s.intensity*this.gl3dview.lightIntensityRatio,m=s.distance,s.updateWorldMatrix(!0);if(s instanceof n.AmbientLight){if(!s._visible)continue;this.gammaInput?(u+=l.r*l.r,a+=l.g*l.g,f+=l.b*l.b):(u+=l.r,a+=l.g,f+=l.b)}else if(s instanceof n.DirectionalLight){B+=1;if(!s._visible)continue;s.direction?W.copy(s.direction):(W.copy(s.worldMatrix.getPosition()),W.sub(s.target.worldMatrix.getPosition())),W.normalize();if(W.x===0&&W.y===0&&W.z===0)continue;q=_*3,b[q]=W.x,b[q+1]=W.y,b[q+2]=W.z,this.gammaInput?V(y,q,l,p*p):X(y,q,l,p),_+=1}else if(s instanceof n.PointLight){j+=1;if(!s._visible)continue;R=D*3,this.gammaInput?V(w,R,l,p*p):X(w,R,l,p),v=s.worldMatrix.getPosition(),E[R]=v.x,E[R+1]=v.y,E[R+2]=v.z,S[D]=m,D+=1}else if(s instanceof n.SpotLight){F+=1;if(!s._visible)continue;U=P*3,this.gammaInput?V(x,U,l,p*p):X(x,U,l,p),v=s.worldMatrix.getPosition(),T[U]=v.x,T[U+1]=v.y,T[U+2]=v.z,N[P]=m,W.copy(v),W.sub(s.target.worldMatrix.getPosition()),W.normalize(),C[U]=W.x,C[U+1]=W.y,C[U+2]=W.z,k[P]=Math.cos(s.angle),L[P]=s.exponent,P+=1}else if(s instanceof n.HemisphereLight){I+=1;if(!s._visible)continue;W.copy(s.worldMatrix.getPosition()),W.normalize();if(W.x===0&&W.y===0&&W.z===0)continue;z=H*3,M[z]=W.x,M[z+1]=W.y,M[z+2]=W.z,c=s.color,h=s.groundColor,this.gammaInput?(d=p*p,V(A,z,c,d),V(O,z,h,d)):(X(A,z,c,p),X(O,z,h,p)),H+=1}}for(r=_*3,i=Math.max(y.length,B*3);r<i;r++)y[r]=0;for(r=D*3,i=Math.max(w.length,j*3);r<i;r++)w[r]=0;for(r=P*3,i=Math.max(x.length,F*3);r<i;r++)x[r]=0;for(r=H*3,i=Math.max(A.length,I*3);r<i;r++)A[r]=0;for(r=H*3,i=Math.max(O.length,I*3);r<i;r++)O[r]=0;g.directional.length=_,g.point.length=D,g.spot.length=P,g.hemi.length=H,g.ambient[0]=u,g.ambient[1]=a,g.ambient[2]=f},n.ProgramManagerId=0,n.ProgramManagerCache={count:0};var $=function(e,r,i){this.width=e,this.height=r,i=i||{},this.wrapS=i.wrapS!==t?i.wrapS:n.ClampToEdgeWrapping,this.wrapT=i.wrapT!==t?i.wrapT:n.ClampToEdgeWrapping,this.magFilter=i.magFilter!==t?i.magFilter:n.LinearFilter,this.minFilter=i.minFilter!==t?i.minFilter:n.LinearMipMapLinearFilter,this.anisotropy=i.anisotropy!==t?i.anisotropy:1,this.offset=new n.XiangliangTwo(0,0),this.repeat=new n.XiangliangTwo(1,1),this.format=i.format!==t?i.format:n.RGBAFormat,this.type=i.type!==t?i.type:n.UnsignedByteType,this.depthBuffer=i.depthBuffer!==t?i.depthBuffer:!0,this.stencilBuffer=i.stencilBuffer!==t?i.stencilBuffer:!0,this.generateMipmaps=!0,this.shareDepthFrom=null};$.prototype={constructor:$,clone:function(){var e=new $(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e.generateMipmaps=this.generateMipmaps,e.shareDepthFrom=this.shareDepthFrom,e},getUniqueCode:function(){return this._id},dispose:function(){this.dispatchEvent({type:"dispose"})}};var J=function(e,t,n){$.call(this,e,t,n),this.activeCubeFace=0};n.extend(J,$,{}),n.Gl3dview3D=function(r,i,s,u){n.Element.call(this),this.id=n.Gl3dview3DId++,this._interactionDispatcher=new n.EventDispatcher,u=u||{},this.helperBox=new n.Serva,this.helperBox.addServaChangeListener(this.handleServaChange,this),this._rootView=h.createView("hidden"),this._canvas=this.initCanvas(s),this._topCanvas=h.createCanvas(this),this._bottomCanvas=h.createCanvas(this);var a=this._canvas.parentNode;a&&(a.removeChild(this._canvas),a.appendChild(this._rootView),this.adjustRootViewBounds(0,0,this._canvas.width,this._canvas.height)),this._rootView.appendChild(this._bottomCanvas),this._rootView.appendChild(this._canvas),this._rootView.appendChild(this._topCanvas),this.setCanvasPropety(),this._gleye=i||new n.PerspectiveGleye,this._gleye.addPropertyChangeListener(this.dirtyGl3dview,this),this._clearColor=u.clearColor!==t?u.clearColor:new n.Color(16777215),this._clearAlpha=u.clearAlpha!=t?u.clearAlpha:1,this._precision=u.precision!==t?u.precision:"mediump",this.__fog=new n.FogExp2,this.devicePixelRatio=u.devicePixelRatio!==t?u.devicePixelRatio:e.devicePixelRatio!==t?e.devicePixelRatio:1,this._premultipliedAlpha=u.premultipliedAlpha==null?!0:u.premultipliedAlpha,this.lightIntensityRatio=1,p.isIOS||p.isAndroid?(this._antialias=!1,this._preserveDrawingBuffer=!1,this.lightIntensityRatio=.1):(this._preserveDrawingBuffer=u.preserveDrawingBuffer==null?!0:u.preserveDrawingBuffer,this._antialias=u.antialias==t?!0:u.antialias),this._gl=this.initGL(),this._programs=[],this._currentProgram=null,this.overrideMaterial=null,this._maxLights=u.maxLights!==t?u.maxLights:4,this._projScreenMatrix=new l,this._projScreenMatrixPS=new l,this._frustum=new n.Frustum,this._vector3=new o,this._oldDoubleSided=-1,this._oldFlipSided=-1,this._oldBlending=null,this._oldBlendEquation=null,this._oldBlendSrc=null,this._oldBlendDst=null,this._currentGleye=null,this._enabledAttributes={},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.gpu=new n.GPU(this),this.pm=new n.ProgramManager(this),this.setDefaultGLState(),this.paintSortFunction=n.Defaults.paintSortFunction,this.sortNodes=!0,this.sortOpaqueOrderByMaterial=!0,this.glNodeList=[],this.helperGLNodeList=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0},currentMaterialId:-1},this.projector=new n.Projector,this.up=new n.XiangliangThree(0,1,0),this.position=new n.XiangliangThree(0,0,0),this.seletionMaterial=new n.BasicMaterial,this.seletionMaterial.wireframe=!0,this.seletionMaterial.wireframeLinewidth=1,this.seletionMaterial.color=new n.Color(65280),this.selectionCube=new _,this.selectionCube.material=this.seletionMaterial,this.outlineMaterialMap={},this.selectionCube._modelViewMatrix=new l,this.selectionCube._normalMatrix=new f,this.selectionCube.name="select",this.alarmMaterial=new n.BasicMaterial,this.alarmMaterial.wireframe=!0,this.alarmMaterial.wireframeLinewidth=1,this.alarmMaterial.color=new n.Color(16711680),this.alarmCube=new _,this.alarmCube.material=this.alarmMaterial,this.alarmCube._modelViewMatrix=new l,this.alarmCube._normalMatrix=new f,this.alarmCube.name="alarm";var c=512;this._glowSurface=new n.Plane(2,2),this._glowSurface2=new n.Plane(c,c),this._glowSurface.target=new $(c,c,{type:n.UnsignedByteType}),this._glowSurface.target1=new $(c,c,{type:n.UnsignedByteType}),this._glowSurface.target2=new $(c,c,{type:n.UnsignedByteType}),this._glowSurfaceMaterial=new n.BlurMaterial,this._blurMaterialH=new n.BlurMaterial,this._blurMaterialH.orientation=1,this._blurMaterialV=new n.BlurMaterial,this.deferredPostionMaterial=new n.DeferredMaterial,this.deferredNormalMaterial=new n.DeferredMaterial({isNormal:1}),this.ssaoMaterial=new n.SSAOMaterial,this.ssaoMaterial.map2=new n.Texture(C.ssaoNormalImage);var d=1024;this.deferredPostionTarget=new $(d,d,{type:n.FloatType,magFilter:n.NearestFilter,minFilter:n.NearestFilter}),this.deferredNormalTarget=new $(d,d,{type:n.FloatType,magFilter:n.NearestFilter,minFilter:n.NearestFilter,format:n.RGBFormat}),this.ssaoTarget=new $(d,d,{type:n.FloatType,magFilter:n.NearestFilter,minFilter:n.NearestFilter}),this.ssaoTarget1=new $(c,c,{type:n.UnsignedByteType}),this.ssaoTarget2=new $(c,c,{type:n.UnsignedByteType}),this.finalSSAOTarget=null,this._interactions=null,this.billboardRenderer=null,this._groupCounter=0,this.groupMap={},this.groupCountMap={},this.bufferNodeMap={},this.lineMap={},this.particleMap={},this.glInited={},this.glNodeMap={},this.normalNodeMap={},this.showAxis=!1,this.axisSize=20,this.axisPosition=new n.XiangliangThree(0,0,0),this.axis=new n.Axis(this.axisSize),this.alarmBillboards=[],this.areaPickingRect={},this.setServa(r===t?new n.Serva:r),this.renderCallback=null,this.beforeRenderFunction=null,this.dirtyGl3dview(),this.prepareData(),this.autoUpdateGleyeAspect=!0,this.shadowMapRenderer=null,this.shadowMapType=n.PCFSoftShadowMap,this.shadowMapCullFace=n.CullFaceFront,this.adjustBounds(this._canvas.width,this._canvas.height,0,0);var v=new n.DefaultInteraction(this);v.panSpeed=3,v.zoomSpeed=10;var m=this;this.getRootView().addEventListener("mousedown",function(e){m.handleMouseDown(e)}),this.getRootView().addEventListener("mouseup",function(e){m.handleClick(e)});var g=[v,new n.SelectionInteraction(this)];this.setInteractions(g),this.doubleClickToLookAtFunction=D.doubleClickToLookAtFunction,K(this),this.initSurfaceGroup(),this.materialRenderListMap={},this._selectTransparencyThreshold=0,this._dynamicBatchDraw=!1,this._dynamicBatchDrawCountLimit=1024,this.needSmoothNormalFunction=D.needSmoothNormalFunction,this._annotationMap={},this._activeAnnotation=null},n.extend(n.Gl3dview3D,n.Data,{___accessor:["shadowMapEnable","editableFunction","keyboardRemoveEnabled","selectTransparencyThreshold","dynamicBatchDraw","showFps"],setUseFog:function(e){this._useFog=e,this._useFog?this._fog=this.__fog:this._fog=null},setOverloadMaterial:function(e){this._overloadMaterial=e},setFogColor:function(e){this.__fog.color=e},setFogDensity:function(e){this.__fog.density=e},setServa:function(e){if(!e)throw"Serva can not be null";if(this.dataBox===e)return;var t=this.dataBox;t&&(this._clearServa(t),t.removeServaChangeListener(this.handleServaChange,this),t.removeDataPropertyChangeListener(this.handleDataPropertyChange,this),t.getAlarmBox().removeServaChangeListener(this.dirtyGl3dview,this),t.getSelectionContainer().removeSelectionChangeListener(this.dirtyGl3dview,this)),this.dataBox=e,this.dataBox.addServaChangeListener(this.handleServaChange,this),this.dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this),this.dataBox.getAlarmBox().addServaChangeListener(this.dirtyGl3dview,this),this.dataBox.getSelectionContainer().addSelectionChangeListener(this.dirtyGl3dview,this),this.firePropertyChange("dataBox",t,this._box),this.glNodeList=[],this.dirtyGl3dview(),this._clearNodeCache()},setRenderCallback:function(e){this.renderCallback=e},setBeforeRenderFunction:function(e){this.beforeRenderFunction=e},getServa:function(){return this.dataBox},getClearColor:function(){return this._clearColor},setClearColor:function(e){arguments.length==3?(this._clearColor=new n.Color,this._clearColor.setRGB(arguments[0],arguments[1],arguments[2])):(this._clearColor=e,this._clearColor instanceof n.Color||(this._clearColor=new n.Color(e))),this._gl.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearAlpha),this.dirtyGl3dview()},setClearAlpha:function(e){this._clearAlpha=e,this._gl.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearAlpha),this.dirtyGl3dview()},getClearAlpha:function(){return this._clearAlpha},getPrecision:function(){return this._precision},setPrecision:function(e){this._precesion=e},setSSAOBlur:function(e){this._ssaoBlur=e},setSSAOEnable:function(e){return e&&!this.isFloatTextureSupport()?!1:(this._sSAOEnable=e,this._dirty=!0,!0)},isSSAOEnable:function(){return this._sSAOEnable&&this._baseRender},setSSAOOccluderBias:function(e){this._occluderBias=e,this._dirty=!0},setSSAOSamplingRadius:function(e){this._samplingRadius=e,this._dirty=!0},setSSAOAttenuation:function(e){this._attenuation=e,this._dirty=!0},isFloatTextureSupport:function(){return this._glExtensionTextureFloat!=null},getGleye:function(){return this._gleye},setGleye:function(e,t){if(this._gleye!=e){var n=this._gleye;n.removePropertyChangeListener(this.dirtyGl3dview),this._gleye=e,this._gleye.addPropertyChangeListener(this.dirtyGl3dview,this);if(this.autoUpdateGleyeAspect){this._gleye.setAspect(n.aspect);var r=this.getDefaultInteraction();r&&(r.object=this._gleye)}t&&(this._gleye.p(n.p()),this._gleye.lookAt(n.getTarget())),this.dirtyGl3dview()}},isVisible:function(e){if(e){if(e instanceof n.Link||e instanceof n.PathLink){if(!e.isVisible())return!1;if(!this.isVisible(e._fromNode))return!1;if(!this.isVisible(e._toNode))return!1}if(!e.isVisible())return!1;if(e._parent)return this.isVisible(e._parent);if(this.visibleFunction)return this.visibleFunction(e)}return!0},setCanvasPropety:function(){this._canvas&&(this._canvas.setAttribute("tabindex",this.id),this._canvas.style.outline="none",this._canvas.style.position="absolute")},initCanvas:function(e){return e===t?document.createElement("canvas"):(typeof e=="string"&&(e=document.getElementById(e)),e)},initGL:function(){var e;try{e=this._canvas.getContext("webgl",{preserveDrawingBuffer:this._preserveDrawingBuffer,premultipliedAlpha:this._premultipliedAlpha,antialias:this._antialias,stencil:!0})||this._canvas.getContext("experimental-webgl",{preserveDrawingBuffer:this._preserveDrawingBuffer,premultipliedAlpha:this._premultipliedAlpha,antialias:this._antialias,stencil:!0})}catch(t){console.log(t)}e||console.error("Can not init webgl context"),this._glExtensionTextureFloat=e.getExtension("OES_texture_float"),this._glExtensionStandardDerivatives=e.getExtension("OES_standard_derivatives"),this._glExtensionTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this._glExtensionCompressedTextureS3TC=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this._glExtensionTextureFloat||console.log("TGL.Gl3dview3D: Float textures not supported."),this._glExtensionStandardDerivatives||console.log("TGL.Gl3dview3D: Standard derivatives not supported."),this._glExtensionTextureFilterAnisotropic||console.log("TGL.Gl3dview3D: Anisotropic texture filtering not supported."),this._glExtensionCompressedTextureS3TC||console.log("TGL.Gl3dview3D: S3TC compressed textures not supported.");if(!!e)return e;console.log("Error: Your browser does not support WebGL.")},resetRenderInfo:function(){this.info.render.calls=0,this.info.render.vertices=0,this.info.render.faces=0,this.info.render.points=0,this.info.currentMaterialId=-1},_clearServa:function(e){var t=null;e===this.helperBox?t=this.helperGLNodeList:t=this.glNodeList;for(var n=t.length-1;n>=0;n--){var r=t[n];t.splice(n,1)}t=[],this.prepareData(),this.pm._lightNeedsUpdate=!0,this.pm.changeAllLightMaterialUpdateFlags(!0),this._clearNodeCache(),this.deleteCloneNode()},handleServaChange:function(e){var t=e.kind,r=e.data,i=e.source,s=null;i===this.helperBox?s=this.helperGLNodeList:s=this.glNodeList,t==="add"?r instanceof n.Light?(this.pm._lightNeedsUpdate=!0,this.pm.changeAllLightMaterialUpdateFlags(!0),this.prepareData()):r instanceof n.Annotation?this._createAnnotationDiv(r):(this.addNodeMaterials(r),s.length===0?this.initWebGLNodes(i,s):this.addNode(r,s),r._alarmBillboard&&this.alarmBillboards.push(r._alarmBillboard)):t==="remove"?r instanceof n.Light?(this.pm._lightNeedsUpdate=!0,this.pm.changeAllLightMaterialUpdateFlags(!0),this.prepareData()):r instanceof n.Annotation?this._removeAnnotationDiv(r):(this.removeNode(r,s),this.deleteCloneNode(r)):t==="clear"&&this._clearServa(),this.boundingBox=null,this.dirtyGl3dview()},removeNode:function(e,t){for(var n=t.length-1;n>=0;n--){var r=t[n];r.node===e&&t.splice(n,1)}this._clearNodeCache(e)},_clearNodeCache:function(e){if(e){e.oldGroups=e.groups||e.oldGroups;if(e.oldGroups!=null)for(var t in e.oldGroups){var r=e.oldGroups[t],i=this.groupCountMap[r.id];i!=null&&(i--,i<=0?(delete this.groupCountMap[r.id],delete this.groupMap[r.id]):this.groupCountMap[r.id]=i)}for(var s=0;s<this.alarmBillboards.length;s++){var o=this.alarmBillboards[s];o.getParent()===e&&(this.alarmBillboards.splice(s,1),s--)}e instanceof n.Annotation&&this._removeAnnotationDiv(e)}else{for(var u in this.groupMap){var a=this.groupMap[u],f=a._nodeId;this.helperBox.containsById(f)||delete this.groupMap[u]}this.glInited=new Object,this.alarmBillboards.splice(0),this.glNodeList=[]}for(var u in this._annotationMap)this._removeAnnotationDiv(u)},addNode:function(e,t){var n=this.addWebGLNode(t,e);for(var r=0;r<n.length;r++){var i=n[r];this.updateWebGLNode(i)}},addNodeMaterials:function(e){var t=e.material,r;if(t instanceof n.Material)this.addMaterial(t);else if(t instanceof n.ArrayMaterial){var i=t.materials,s=i.length;for(r=0;r<s;r++)this.addMaterial(i[r])}},addMaterial:function(e){this.pm.addMaterial(e),e.map&&this.pm.addTexture(e.map)},handleDataPropertyChange:function(e){var t=e.source;if(t instanceof n.Node){var r=e.property;if(t.isSizeChangedProperty(r)||r===n.Styles.MaterailType||r===n.Styles.NormalType){if(t instanceof n.Line){t.verticesNeedUpdate=!0;var i=this.lineMap[t._id];this.initLineBuffers(t),w.buildLineBufferData(t,this._gl.DYNAMIC_DRAW,this._gl,i)}else if(t.groups){t.verticesNeedUpdate=!0;if(r===n.Styles.MaterailType||r===n.Styles.NormalType)t.normalsNeedUpdate=!0;for(var s in t.groups){var o=t.groups[s],i=this.groupMap[o.id],u=w.getMaterial(t,o.materialIndex);t.normalsNeedUpdate&&this.initGroupBuffer(t,o,i,!0),w.buildGroupBufferData(o,t,this._gl.DYNAMIC_DRAW,!t.dynamic,u,this._gl,i,this)}}}else if(r==="materialMapping")this._currentGroupHash=null,this.glInited[t.getId()]=!1,this.removeNode(t,this.glNodeList),this.addNode(t,this.glNodeList);else if(r==="alarmBillboard"){var a=e.oldValue,f=e.newValue;this._addNodeAlarmBillboard(t,a,f)}this.addNodeMaterials(t)}else t instanceof n.Light&&(this.pm._lightNeedsUpdate=!0);if(t.isSizeChangedProperty&&t.isSizeChangedProperty(r)||r=="parent"||t.isSpaceChangedProperty(r))this.deleteCloneNode(t),this.boundingBox=null;this.dirtyGl3dview()},deleteCloneNode:function(e){if(e){var t=e.getId?e.getId():e,n=this.normalNodeMap[t];if(n!=null){n.setParent(null);for(var r in n.groups){var i=n.groups[r];delete this.groupMap[i.id]}}delete this.normalNodeMap[t]}else for(var t in this.normalNodeMap)this.deleteCloneNode(t)},setBlurAmount:function(e){this._blurAmount=e},setBlurScale:function(e){this._blurScale=e},setBlurStrength:function(e){this._blurStrength=e},setBlurGlobalAlpha:function(e){this._blurGlobalAlpha=e},dirtyGl3dview:function(e){this.dataBox.batch||(this._dirty=!0)},_addNodeAlarmBillboard:function(e,n,r){r===t&&(r=e._alarmBillboard);if(n!=null&&this.alarmBillboards.indexOf(n)!==-1){var i=this.alarmBillboards.indexOf(n);this.alarmBillboards.splice(i,1),n.removePropertyChangeListener(this.dirtyGl3dview,this)}r&&this.alarmBillboards.indexOf(r)===-1&&(this.alarmBillboards.push(r),r.addPropertyChangeListener(this.dirtyGl3dview,this))},initWebGLNodes:function(e,t){var n=e.getNodes(),r,i;for(r=0,i=n.size();r<i;r++){var s=n.get(r);s.renderSelected=!1,this.addWebGLNode(t,s),this.glNodeMap[s.id]=s}for(r=0,i=t.length;r<i;r++)this.updateWebGLNode(t[r])},updateWebGLNode:function(e){var t=e.node,r=t,i,s,o;if(t instanceof n.Entity){for(var u in t.groups){i=t.groups[u],o=w.getMaterial(t,i.materialIndex);if(t.buffersNeedUpdate){var a=this.groupMap[i.id];this.initGroupBuffer(t,i,a),w.buildGroupBufferData(i,t,this._gl.DYNAMIC_DRAW,!t.dynamic,o,this._gl,a,this)}}t.setUpdateFlags(!1),t.buffersNeedUpdate=!1}else if(t instanceof n.BufferNode)this.setBufferNodeData(t,this._gl.DYNAMIC_DRAW,!t.dynamic);else if(t instanceof n.Line){var a=this.lineMap[t._id];w.buildLineBufferData(t,this._gl.DYNAMIC_DRAW,this._gl,a)}else if(t instanceof n.Particle){var a=this.particleMap[t._id];x(t,this._gl.DYNAMIC_DRAW,this._gl,a)}},addWebGLNode:function(e,r){var i,s,o,u=[],a;this.glInited[r.getId()]||this._addNodeAlarmBillboard(r);if(!this.glInited[r.getId()]){this.glInited[r.id]=!0,r._modelViewMatrix=new l,r._normalMatrix=new f;if(r instanceof n.Entity){r.groups==t&&S(r);for(i in r.groups){s=r.groups[i],s.id=s.id===t?n.Gl3dview3D.GroupCache._groupCounter++:s.id;var c=this.groupCountMap[s.id]||0;c++,this.groupCountMap[s.id]=c,this.groupMap[s.id]===t&&(this.groupMap[s.id]={});var h=this.groupMap[s.id];h._nodeId=r.getId(),h.__webglVertexBuffer||(this.createGroupBuffer(s,h),this.initGroupBuffer(r,s,h),r.setUpdateFlags(!0))}}else if(r instanceof n.Line){this.lineMap[r._id]==null&&(this.lineMap[r._id]={});var h=this.lineMap[r._id];h._nodeId=r.getId(),h.__webglVertexBuffer||(this.createLineBuffers(r),this.initLineBuffers(r),r.verticesNeedUpdate=!0,r.colorsNeedUpdate=!0,r.lineDistancesNeedUpdate=!0)}else if(r instanceof n.Particle){this.lineMap[r._id]==null&&(this.lineMap[r._id]={});var h=this.lineMap[r._id];h._nodeId=r.getId(),h.__webglVertexBuffer||(this.createParticleBuffers(r),this.initParticleBuffers(r),r.verticesNeedUpdate=!0,r.colorsNeedUpdate=!0)}else r instanceof n.BufferNode?this.initBufferNode(r):r instanceof n.Annotation&&this._createAnnotationDiv(r)}if(r instanceof n.Entity){for(i in r.groups)s=r.groups[i],o=w.getMaterial(r,s.materialIndex),a={group:s,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a);r.groups===null}else r instanceof n.Line?(o=r.material,a={group:r,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a)):r instanceof n.Particle?(o=r.material,a={group:r,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a)):r instanceof n.BufferNode&&(o=r.material instanceof n.ArrayMaterial?r.material.materials[0]:r.material,a={group:r,node:r,opaque:o.transparent?null:o,transparent:o.transparent?o:null},e.push(a),u.push(a));return r.glActive=!0,u},onElementDispose:function(e){var t=e.target;t.removeEventListener("dispose",this.onElementDispose),deallocateElement(t),this.info.memory.geometries--},deallocateElement:function(e){},_AK47:function(e,r,i,s,o,u){var a=this._fog;e.parent===t&&e.updateWorldMatrix(!0,!1),e.worldMatrixInverse.getInverse(e.worldMatrix),this._projScreenMatrix.multiply(e.projectionMatrix,e.worldMatrixInverse),this._frustum.setFromMatrix(this._projScreenMatrix),i.length===0&&(this.initWebGLNodes(r,i),this.prepareData()),this.resetRenderInfo();var f,l,c,h;if(!u)for(f=0,l=i.length;f<l;f++){c=i[f],h=c.node,h.renderSelected=!1,c.render=!1;if(this.isVisible(h)){this.unrollBufferMaterial(c),this.setupMatrices(h,e);if(!(h instanceof n.Entity||h instanceof n.Particle)||!h.frustumCulled||this._frustum.intersectsObject(h))c.render=!0,this.sortNodes&&(this._vector3.copy(h.worldMatrix.getPosition()),this._vector3.applyProjection(this._projScreenMatrix),h.renderDepth!=null?c.z=h.renderDepth+this._vector3.z:c.z=this._vector3.z)}}var p=new N;p.addAll(s),!o&&!u&&p.addAll(this.alarmBillboards);var d=this;!u&&p.forEach(function(e){e.renderDepth?e.z=e.renderDepth:(d._vector3.copy(e.worldMatrix.getPosition()),d._vector3.applyProjection(d._projScreenMatrix),e.z=d._vector3.z)}),p.size()>0&&!u&&this.billboardRenderer==null&&(this.billboardRenderer=new n.BillboardRenderer,this.billboardRenderer.init(this));var v=i.concat(p._as),m=this.sortNodesFunc(v);this.setBlending(n.NoBlending),this.renderNodes(m,!1,"opaque",e,r.getLights(),!1,null,u,this.sortOpaqueOrderByMaterial),this.renderNodes(m,!0,"transparent",e,r.getLights(),!0,null,u),this.setDepthTest(!0),this.setDepthWrite(!0)},unrollBufferMaterial:function(e){var t=e.node,r=e.group,i,s,o;o=t.material,o instanceof n.ArrayMaterial?(s=r.materialIndex||0,i=o.materials[s],i.transparent?(e.transparent=i,e.opaque=null):(e.opaque=i,e.transparent=null)):(i=o,i&&(i.transparent?(e.transparent=i,e.opaque=null):(e.opaque=i,e.transparent=null)))},renderLicense:function(){},isShadowable:function(){return this.isShadowMapEnable()&&(this.maxShadows>0||this.maxPointShadows>0)},render:function(){if(!this._dirty)return;this._dirty=!1,this.beforeRenderFunction!=null&&this.beforeRenderFunction.call(this);if(this.isShadowable()){this.shadowMapRender(),this.setRenderTarget(t);if(this.debugPointLight)return}qr.twm(this),this.paintBottom(this._bottomCanvas),this.getShowFps()&&(this.__time=(new Date).getTime()),this.innerRender(this._gleye,!0),this.renderAnnotations(this._gleye),this.extendRender(this._gleye),this.paintTopCanvas();if(this.getShowFps()){this._tpf=(new Date).getTime()-this.__time;var e=this._topCanvas.getContext("2d"),n=(1e3/this._tpf).toFixed(0);n>500&&(n="> 500");var r="FPS:"+n+",TPF:"+this._tpf+" ms";e.font="20px Arial sans-serif",e.fontWeight="bold",e.lineWith=2,e.fillStyle="rgba(0, 0, 0, 1)",e.fillText(r,10,25)}if(this._xyz!=t){var i=this._xyz,
s=i.markText,o=i.type,u=i.expired,r=i.innerHTML,a=0,f=0,l,c=this._topCanvas.getBoundingClientRect(),e=this._topCanvas.getContext("2d");s!=t&&s!=null&&s!=""||o=="2"?(e.font="24px Arial sans-serif",l=y.getTextSize(e.font,r),e.fillStyle="red",a=this._canvas.width-l.width-20,f=this._canvas.height-l.height-10):(e.font="15px Arial sans-serif",e.fillStyle="rgba(240, 120, 25, 0.6)",l=y.getTextSize(e.font,r),a=this._canvas.width-l.width-20,f=this._canvas.height-l.height-10),e.fillText(r,a,f)}this.renderCallback!=null&&this.renderCallback.call(this)},getTextSize:function(e,t){return y.getTextSize(e,t)},shadowMapRender:function(){this.shadowMapRenderer==null&&(this.shadowMapRenderer=new oi,this.shadowMapRenderer.init(this)),this.glNodeList.length===0&&(this.initWebGLNodes(this.dataBox,this.glNodeList),this.prepareData()),this.shadowMapRenderer.render(this.dataBox,this._gleye)},handleMouseDown:function(e){var t=e.target;this.lastX=e.clientX,this.lastY=e.clientY,t.getAttribute("class")=="tgl_annotation"&&t.style.opacity=="1"&&(e.stop=!0,e.stopPropagation())},handleClick:function(e){var t=e.clientX-this.lastX,n=e.clientY-this.lastY;if(Math.abs(t)<.1&&Math.abs(n)<.1){var r=e.target;if(r.getAttribute("clazz")!="tgl_annotation")this._activeAnnotation&&(this._activeAnnotation=null,this.dirtyGl3dview());else if(r.style.opacity=="1"){var i=r.getAttribute("id"),s=this.getServa().getDataById(i),o=this._annotationMap[i];this.handleDefaultAnnotationClick(s,o),this.handleAnnotationClick(s,o),this.dirtyGl3dview()}}},handleDefaultAnnotationClick:function(e,t){this._activeAnnotation!=e&&(this._activeAnnotation=e)},handleAnnotationClick:function(e,t){},renderAnnotations:function(e){var t=this.dataBox.getAnnotations(),n=this;t&&(t.forEach(function(t){n.renderAnnotation(e,t)}),this._createAnnotationStyle());if(this._activeAnnotation){this._createAnnotationToolTipDiv();var r=this._annotationToolTipDiv;r.innerHTML=this._activeAnnotation.getText();var i=this._annotationMap[this._activeAnnotation.getId()];r.parentNode!=i&&i.appendChild(r),r.style.opacity=i.style.opacity}},getAnnotationDiv:function(e){return this._annotationMap[e.getId()]},renderAnnotation:function(e,t){var n=this._annotationMap[t.getId()];n==null&&(n=this._createAnnotationDiv(t)),n.innerHTML=t._label,t.updateWorldMatrix();var r=t.worldMatrix.getPosition(),i=t.getStyle("annotation.class");n.setAttribute("class",i);var s=this.getViewPosition(r),o=this._annotationToolTipDiv;n.style.left=s.x+"px",n.style.top=s.y+"px",n.style.opacity="1";var u=r.distanceTo(e.getPosition()),a=this.getElementByScreenPoint(s,!1);if(a&&a.length>0){var f=a[0];f.distance<u&&(n.style.opacity="0.03")}},_addCSSRule:function(e,t,n,r){r=r||(e.cssRules||e.rules).length,e.insertRule?e.insertRule(t+"{"+n+"}",r):e.addRule&&e.addRule(t,n,r)},_createAnnotationStyle:function(){if(!this._annotationStyle){var e=document.createElement("style");e.appendChild(document.createTextNode("")),document.head.appendChild(e);var t=e.sheet;this._addCSSRule(t,".tgl_annotation","position:absolute;width:16px;height:16px;border-radius:10px;text-align:center;border : 2px solid gray;"),this._addCSSRule(t,".tgl_annotation:hover","border : 2px solid black;"),this._annotationStyle=e}},_removeAnnotationDiv:function(e){var t=e.getId?e.getId():e,n=this._annotationMap[t];n!=null&&this.getRootView().removeChild(n)},_createAnnotationDiv:function(e){var t=document.createElement("div"),n=this,r=e.getStyle("annotation.class");return t.setAttribute("id",e.getId()),t.setAttribute("class",r),t.setAttribute("clazz","tgl_annotation"),this._annotationMap[e.getId()]=t,this.getRootView().appendChild(t),t},_createAnnotationToolTipDiv:function(){if(this._annotationToolTipDiv==null){var e=document.createElement("div");e.setAttribute("class","tgl_annotation_tooltip");var t=document.createElement("style");t.appendChild(document.createTextNode("")),document.head.appendChild(t);var n=t.sheet,r="position: absolute;border: 3px solid #333; background-color: #ccd; padding: 3px;text-align: left;width: 220px;height: 'auto';border-radius: 10px;bottom:35px;left:-13px;";this._addCSSRule(n,".tgl_annotation_tooltip",r),r="content: ' ';position: absolute;top: 100%; border: 1px solid;",this._addCSSRule(n,".tgl_annotation_tooltip:after, .tgl_annotation_tooltip:before",r),r="border-color: #333 transparent transparent transparent;border-width: 16px 17px 0 7px;left: 10px;",this._addCSSRule(n,".tgl_annotation_tooltip:before",r),r="border-color: #ccd transparent transparent transparent;border-width: 12px 11px 0 4px;left: 14px;",this._addCSSRule(n,".tgl_annotation_tooltip:after",r),this._annotationToolTipDiv=e}},extendRender:function(e){},innerRender:function(e,n){e===t&&(e=this._gleye);if(e===null){console.log(" no gleye");return}this.debug&&console.log("inner Render");if(this.autoClear){var r=this._clearColor;this._gl.clearColor(r.r,r.g,r.b,this._clearAlpha),I.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil,this)}if(n)for(var i=0;i<this._interactions.length;i++){var o=this._interactions[i];o.update&&o.update()}this.billboardRenderer&&this.billboardRenderer.disable(),this._gl.viewport(0,0,this._canvas.width,this._canvas.height);if(this._sSAOEnable){this.linearDepth=e.far-e.near,this.ssaoing=!0,this._renderDeferredTarget(e,this.deferredPostionMaterial,this.deferredPostionTarget),this._renderDeferredTarget(e,this.deferredNormalMaterial,this.deferredNormalTarget),this._setSSAOMaterial(),this._overloadMaterial=null,this._renderSurface(e,this.ssaoTarget,this.ssaoMaterial);var u=this._canvas.width/this._canvas.height;this._ssaoBlur?(this._renderBlurTarget(e,this._blurMaterialH,this.ssaoTarget,this.ssaoTarget1,u),this._renderBlurTarget(e,this._blurMaterialV,this.ssaoTarget1,this.ssaoTarget2,u),this.finalSSAOTarget=this.ssaoTarget2):this.finalSSAOTarget=this.ssaoTarget,this.setRenderTarget(t),this.ssaoing=!1}this.renderOutline=!1,this.renderOutlineGlow=!1,I.enableStencil(this._gl),this._baseRender=!0,I.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards()),this._baseRender=!1,I.stencilTest(this._gl),this.renderOutline&&I.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards(),!1,"stencil");if(this.renderOutlineGlow){var a=this._glowSurface.target,c=this._glowSurface.target1,h=this._glowSurface.target2;I.disableStencil(this._gl),this.setRenderTarget(a),a._id=a._id||(new Date).getTime()+"0",c._id=c._id||(new Date).getTime()+"1",h._id=h._id||(new Date).getTime()+"2",this._gl.viewport(0,0,a.width,a.height),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._gl.colorMask(!1,!1,!1,!1),I.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards(),!1,"glow.unselect"),this._gl.colorMask(!0,!0,!0,!0),I.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards(),!1,"glow.select");var p,d;this.setRenderTarget(c),this._gl.viewport(0,0,c.width,c.height),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialH.setMap(a);var u=this._canvas.width/this._canvas.height;this._blurMaterialH.texelSize=new s(a.width,a.height/u),this._blurMaterialH.blurAmount=this._blurAmount||5,this._blurMaterialH.blurScale=this._blurScale||1,this._blurMaterialH.blurStrength=this._blurStrength||1,this._blurMaterialH.orientation=1;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialH,d,this._glowSurface2);this.setRenderTarget(h),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialV.setMap(c),this._blurMaterialV.texelSize=new s(c.width,c.height/u),this._blurMaterialV.blurAmount=this._blurAmount||5,this._blurMaterialV.blurScale=this._blurScale||1,this._blurMaterialV.blurStrength=this._blurStrength||1,this._blurMaterialV.orientation=0;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialV,d,this._glowSurface2);this.setRenderTarget(t),this._glowSurface._modelViewMatrix=new l,this._glowSurface._normalMatrix=new f,this.setupMatrices(this._glowSurface,e),this._glowSurfaceMaterial.setMap(h),this._glowSurfaceMaterial.useBlur=0,this._glowSurfaceMaterial.blurGlobalAlpha=this._blurGlobalAlpha||1,I.setBlending(this._glowSurfaceMaterial.blendMode,this._glowSurfaceMaterial.blendEquation,this._glowSurfaceMaterial.blendSrc,this._glowSurfaceMaterial.blendDst,this),this._gl.enable(this._gl.STENCIL_TEST);for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._glowSurfaceMaterial,d,this._glowSurface);this.setRenderTarget(c),this._gl.viewport(0,0,c.width,c.height),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialH.setMap(a);var u=this._canvas.width/this._canvas.height;this._blurMaterialH.texelSize=new s(a.width,a.height/u),this._blurMaterialH.blurAmount=this._blurAmount||10,this._blurMaterialH.blurScale=this._blurScale||1,this._blurMaterialH.blurStrength=this._blurStrength||1,this._blurMaterialH.orientation=0;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialH,d,this._glowSurface2);this.setRenderTarget(h),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._blurMaterialV.setMap(c),this._blurMaterialV.texelSize=new s(c.width,c.height/u),this._blurMaterialV.blurAmount=this._blurAmount||10,this._blurMaterialV.blurScale=this._blurScale||1,this._blurMaterialV.blurStrength=this._blurStrength||1,this._blurMaterialV.orientation=1;for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._blurMaterialV,d,this._glowSurface2);this.setRenderTarget(t),this._glowSurface._modelViewMatrix=new l,this._glowSurface._normalMatrix=new f,this.setupMatrices(this._glowSurface,e),this._glowSurfaceMaterial.setMap(h),this._glowSurfaceMaterial.useBlur=0,this._glowSurfaceMaterial.blurGlobalAlpha=this._blurGlobalAlpha||1,I.setBlending(this._glowSurfaceMaterial.blendMode,this._glowSurfaceMaterial.blendEquation,this._glowSurfaceMaterial.blendSrc,this._glowSurfaceMaterial.blendDst,this),this._gl.enable(this._gl.STENCIL_TEST);for(p in this._glowSurface.groups)d=this._glowSurface.groups[p],this.renderGroup(e,[],this._glowSurfaceMaterial,d,this._glowSurface);this._gl.clearColor(0,0,0,0)}I.disableStencil(this._gl),this.renderHelper(e)},_renderDeferredTarget:function(e,t,r,i){i=i||new n.Vec4(0,0,0,0,0),t.linearDepth=this.linearDepth,this.setRenderTarget(r),this._overloadMaterial=t,this._gl.clearColor(i.x,i.y,i.z,i.w),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),I.r(this,e,this.dataBox,this.glNodeList,this.dataBox.getBillboards())},_renderBlurTarget:function(e,t,r,i,o){clearColor=clearColor||new n.Vec4(0,0,0,0,0),this.setRenderTarget(i),this._gl.viewport(0,0,i.width,i.height),this._gl.clearColor(clearColor.x,clearColor.y,clearColor.z,clearColor.w),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),t.setMap(r),t.texelSize=new s(r.width,r.height/o),t.blurAmount=this._blurAmount||5,t.blurScale=this._blurScale||1,t.blurStrength=this._blurStrength||1;var u,a;for(u in this._glowSurface.groups)a=this._glowSurface.groups[u],this.renderGroup(e,[],t,a,this._glowSurface2)},_setSSAOMaterial:function(){this.ssaoMaterial.map=this.deferredPostionTarget,this.ssaoMaterial.map1=this.deferredNormalTarget,this.ssaoMaterial.attenuation=this._attenuation||new s(1,.02),this.ssaoMaterial.occluderBias=this._occluderBias||.5,this.ssaoMaterial.samplingRadius=this._samplingRadius||20,this.ssaoMaterial.texelSize=new s(1/this.deferredPostionTarget.width,1/this.deferredPostionTarget.height)},_renderSurface:function(e,t,r,i){i=i||new n.Vec4(1,1,1,1),this.setRenderTarget(t),this._gl.clearColor(i.x,i.y,i.z,i.w),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this._glowSurface._modelViewMatrix=new l,this._glowSurface._normalMatrix=new f,this.setupMatrices(this._glowSurface,e);var s,o;for(o in this._glowSurface.groups)s=this._glowSurface.groups[o],this.renderGroup(e,[],r,s,this._glowSurface)},renderHelper:function(e){I.r(this,e,this.helperBox,this.helperGLNodeList,this.helperBox.getBillboards(),"stencil")},initSurfaceGroup:function(){this._glowSurface.setUpdateFlags(!0),S(this._glowSurface);for(var e in this._glowSurface.groups){var r=this._glowSurface.groups[e];r.id=r.id===t?n.Gl3dview3D.GroupCache._groupCounter++:r.id,this.groupMap[r.id]===t&&(this.groupMap[r.id]={});var i=this.groupMap[r.id];this.createGroupBuffer(r,i),this.initGroupBuffer(this._glowSurface,r,i),w.buildGroupBufferData(r,this._glowSurface,this._gl.DYNAMIC_DRAW,!1,this._glowSurfaceMaterial,this._gl,i,this)}this._glowSurface2.setUpdateFlags(!0),S(this._glowSurface2);for(var e in this._glowSurface2.groups){var r=this._glowSurface2.groups[e];r.id=r.id===t?n.Gl3dview3D.GroupCache._groupCounter++:r.id,this.groupMap[r.id]===t&&(this.groupMap[r.id]={});var i=this.groupMap[r.id];this.createGroupBuffer(r,i),this.initGroupBuffer(this._glowSurface2,r,i),w.buildGroupBufferData(r,this._glowSurface2,this._gl.DYNAMIC_DRAW,!1,this._glowSurfaceMaterial,this._gl,i,this)}},getOutlineMaterial:function(e,t){var r=(t.getStyle("select.width")||1)+1+" "+(new n.Color(t.getStyle("select.color"))).getUniqueCode()+e,i=this.outlineMaterialMap[r];return i==null&&(i=new n.EntityMaterial,e=="outline.normal"?(i._type="outline",i.outline=t.getStyle("select.width")||1):e=="outline.glow"?i._type="basic":(i.wireframe=!0,i.wireframeLinewidth=(t.getStyle("select.width")||1)+1),i.color=new n.Color(t.getStyle("select.color")),this.outlineMaterialMap[r]=i),i},renderNodes:function(e,t,r,i,s,o,u,a,f){var l,c,h,p,d,v,m;t?(d=e.length-1,v=-1,m=-1):(d=0,v=e.length,m=1);var g=null;for(var y=d;y!==v;y+=m){l=e[y],p=l.node?l.transparent||l.opaque:l.material;if(!p)continue;this._overloadMaterial&&(p=this._overloadMaterial);var b=this.getOverLoadMaterial(l.node?l.node:l,p);if(b){var w=b.getUniqueCode(),E=ni.getMaterial(w);E?p=E:(ni.setMaterial(w,b),p=b)}if(r=="opaque"&&p.transparent==1)continue;if(r=="transparent"&&p.transparent==0)continue;o?(I.setBlending(p.blendMode,p.blendEquation,p.blendSrc,p.blendDst,this),I.setDepthWrite(!1,this)):I.setDepthWrite(p.depthMask,this);if(l instanceof n.Billboard){var S=l.material.transparent?"transparent":"opaque";r==S&&this.billboardRenderer.render(this,[l],i,this._canvas.width*2,this._canvas.height*2)}else if(l.render){this.billboardRenderer&&this.billboardRenderer.disable(),c=l.node,h=l.group,I.setDepthTest(p.depthTest,this),I.setPolygonOffset(p.polygonOffset,p.polygonOffsetFactor,p.polygonOffsetUnits,this),this.setGLFaces(p);if(c instanceof n.Particle){if(c.verticesNeedUpdate||c.colorsNeedUpdate||c.sortParticles){var T=this.particleMap[c._id];x(c,this._gl.DYNAMIC_DRAW,this._gl,T)}c.verticesNeedUpdate=!1,c.colorsNeedUpdate=!1}var N=a==="stencil",C=this.getSelectStyle(c);C=="outline"&&(C="outline.normal"),a?a==="glow.unselect"&&(c.isSelected()||(c instanceof n.BufferNode?this.renderBufferNode(i,s,p,h,c):I.g(this,i,s,p,h,c))):(!c.isSelected()||C!=="outline.normal"&&C!=="outline.wireframe"&&C!=="outline.glow"?this._gl.disable(this._gl.STENCIL_TEST):(this._gl.enable(this._gl.STENCIL_TEST),C==="outline.glow"?this.renderOutlineGlow=!0:this.renderOutline=!0),c instanceof n.BufferNode?this.renderBufferNode(i,s,p,h,c):I.g(this,i,s,p,h,c));if(c.isSelected()&&this.renderSelect(c))if(C==="outline.normal"||C==="outline.wireframe"||C==="outline.glow"){if(a!=null&&a!="glow.unselect")if(C==="outline.normal"){if(c.renderSelected===!1){var k=this.getOutlineMaterial(C,c),L=this.normalNodeMap[c.getId()];if(L==null){var L=this.cloneNode(c,k);this.normalNodeMap[c.getId()]=L}this.setupMatrices(L,i);for(var A in L.groups)I.g(this,i,s,k,L.groups[A],L);c.renderSelected=!0}}else if(C!=="outline.normal"){var k=this.getOutlineMaterial(C,c);I.g(this,i,s,k,h,c)}}else c.renderSelected===!1&&(this.renderNodeSelection(i,s,c),c.renderSelected=!0);c.getAlarmState().getPropagateSeverity()&&this.renderAlarmBorder(c)&&this.renderNodeAlarm(i,s,c)}c&&c.setUpdateFlags(!1)}},cloneNode:function(e,t){var r=new n.Entity,i={vertices:[],uvs:[],faces:[]},s,o,u,a,c;for(s=0,o=e.vertices.length;s<o;s++)i.vertices.push(e.vertices[s].clone());for(s=0,o=e.faces.length;s<o;s++)i.faces.push(e.faces[s].clone());for(s=0,o=e.uvs.lenght;s<o;s++){var h=uvs[s],p=[];for(var d=0;d<h;d++)p.push(h[d].clone());i.uvs.push(p)}return n.Node.prototype.mergeVertices.call(i),n.Node.prototype.computeFaceNormals.call(i),n.Node.prototype.computeVertexNormals.call(i,!0),r.setPosition(e.getPosition()),r.setScale(e.getScale()),r.setRotation(e.getRotation()),r.setParent(e.getParent()),r._modelViewMatrix=new l,r._normalMatrix=new f,r.data=i,r.vertices=i.vertices,r.uvs=i.uvs,r.faces=i.faces,r.material=t,r.primitive=new n.Primitive(i),r.setUpdateFlags(!0),S(r),this.buildNodeBufferData(r),r},buildNodeBufferData:function(e){for(var r in e.groups){var i=e.groups[r];i.id=i.id===t?n.Gl3dview3D.GroupCache._groupCounter++:i.id,this.groupMap[i.id]===t&&(this.groupMap[i.id]={});var s=this.groupMap[i.id];this.createGroupBuffer(i,s),this.initGroupBuffer(e,i,s),w.buildGroupBufferData(i,e,this._gl.DYNAMIC_DRAW,!1,e.material,this._gl,s,this)}},needSmoothNormal:function(e,r){var i=r.normalType;return i!=t?i===n.NormalTypeSmooth:this.needSmoothNormalFunction?this.needSmoothNormalFunction(e):!1},renderNodeSelection:function(e,r,i){i.createSelectionCube(this.selectionCube),this.setupMatrices(this.selectionCube,e);var s=this.selectionCube.groups;this.selectionCube.material.needsUpdate=!0;for(var o in s){var u=s[o];u.id=u.id===t?n.Gl3dview3D.GroupCache._groupCounter++:u.id,this.groupMap[u.id]===t&&(this.groupMap[u.id]={});var a=this.groupMap[u.id];a.__webglVertexBuffer||(this.createGroupBuffer(u,a),this.initGroupBuffer(i,u,a)),this.selectionCube.setUpdateFlags(!0),w.buildGroupBufferData(u,this.selectionCube,this._gl.DYNAMIC_DRAW,!1,this.selectionCube.material,this._gl,a,this),this.renderGroup(e,[],this.selectionCube.material,u,this.selectionCube)}},renderNodeAlarm:function(e,r,i){i.createPropagateAlarmCube(this.alarmCube),this.setupMatrices(this.alarmCube,e);var s=this.alarmCube.groups;this.alarmCube.material.needsUpdate=!0;for(var o in s){var u=s[o];u.id=u.id===t?n.Gl3dview3D.GroupCache._groupCounter++:u.id,this.groupMap[u.id]===t&&(this.groupMap[u.id]={});var a=this.groupMap[u.id];a.__webglVertexBuffer||(this.createGroupBuffer(u,a),this.initGroupBuffer(i,u,a)),this.alarmCube.setUpdateFlags(!0),w.buildGroupBufferData(u,this.alarmCube,this._gl.DYNAMIC_DRAW,!1,this.alarmCube.material,this._gl,a,this),this.renderGroup(e,[],this.alarmCube.material,u,this.alarmCube)}},renderBufferNode:function(e,t,n,r,i,s){if(n.visible===!1)return;var o,u,a,f,l,c;o=this.pm.setProgram(e,t,this._fog,n,r,i),u=o.attributes;var h=i,p=!1,d=n.wireframe?1:0,v=r._id*16777215+o.id*2+d;if(v!==this._currentGroupHash||s)this._currentGroupHash=v,p=!0;p&&this.disableAttributes();var m=this._gl,g=h.attributes.index,y=this.bufferNodeMap[i._id];if(g){var b=h.offsets;b.length>1&&(p=!0);for(var w=0,E=b.length;w<E;w++){var S=b[w].index;if(p){var x=h.attributes.position,T=x.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.position),this.enableAttribute(u.position),m.vertexAttribPointer(u.position,T,m.FLOAT,!1,0,S*T*4);var N=h.attributes.normal;if(u.normal>=0&&N){var C=N.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.normal),this.enableAttribute(u.normal),m.vertexAttribPointer(u.normal,C,m.FLOAT,!1,0,S*C*4)}var k=h.attributes.uv;if(u.uv>=0&&k){var L=k.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.uv),this.enableAttribute(u.uv),m.vertexAttribPointer(u.uv,L,m.FLOAT,!1,0,S*L*4)}var A=h.attributes.color;if(u.color>=0&&A){var O=A.itemSize;m.bindBuffer(m.ARRAY_BUFFER,y.color),this.enableAttribute(u.color),m.vertexAttribPointer(u.color,O,m.FLOAT,!1,0,S*O*4)}m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,y.index)}m.drawElements(m.TRIANGLES,b[w].count,m.UNSIGNED_SHORT,b[w].start*2),this.info.render.calls++,this.info.render.vertices+=b[w].count,this.info.render.faces+=b[w].count/3}}else{if(p){var x=h.attributes.position,T=x.itemSize;m.bindBuffer(m.ARRAY_BUFFER,x.buffer),this.enableAttribute(u.position),m.vertexAttribPointer(u.position,T,m.FLOAT,!1,0,0);var N=h.attributes.normal;if(u.normal>=0&&N){var C=N.itemSize;m.bindBuffer(m.ARRAY_BUFFER,N.buffer),this.enableAttribute(u.normal),m.vertexAttribPointer(u.normal,C,m.FLOAT,!1,0,0)}var k=h.attributes.uv;if(u.uv>=0&&k){var L=k.itemSize;m.bindBuffer(m.ARRAY_BUFFER,k.buffer),this.enableAttribute(u.uv),m.vertexAttribPointer(u.uv,L,m.FLOAT,!1,0,0)}var A=h.attributes.color;if(u.color>=0&&A){var O=A.itemSize;m.bindBuffer(m.ARRAY_BUFFER,A.buffer),this.enableAttribute(u.color),m.vertexAttribPointer(u.color,O,m.FLOAT,!1,0,0)}}var x=h.attributes.position;m.drawArrays(m.TRIANGLES,0,x.numItems/3),this.info.render.calls++,this.info.render.vertices+=x.numItems/3,this.info.render.faces+=x.numItems/3/3}},getOverLoadMaterial:function(e,t){return null},renderGroup:function(e,t,r,i,s){r==null&&console.log("material is null");if(r.visible===!1)return;var o=this._gl,u;s instanceof n.Entity?u=this.groupMap[i.id]:s instanceof n.Line?u=this.lineMap[i._id]:s instanceof n.Particle&&(u=this.particleMap[i._id]);var a,f,l,c,h,p,d,v;a=this.pm.setProgram(e,t,this._fog,r,i,s),f=a.attributes;var m=!1,g=r.wireframe?1:0,y;i.id!=null?y=i.id*16777215+a.id*2+g:y=i._id+""+(a.id*2+g),y!==this._currentGroupHash&&(this._currentGroupHash=y,m=!0),m&&this.disableAttributes(),f.position>=0&&m&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglVertexBuffer),this.enableAttribute(f.position),o.vertexAttribPointer(f.position,3,o.FLOAT,!1,0,0));if(m){if(i.__webglCustomAttributesList)for(d=0,v=i.__webglCustomAttributesList.length;d<v;d++)p=i.__webglCustomAttributesList[d],f[p.buffer.belongsToAttribute]>=0&&(o.bindBuffer(o.ARRAY_BUFFER,p.buffer),this.enableAttribute(f[p.buffer.belongsToAttribute]),o.vertexAttribPointer(f[p.buffer.belongsToAttribute],p.size,o.FLOAT,!1,0,0));f.color>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglColorBuffer),this.enableAttribute(f.color),o.vertexAttribPointer(f.color,3,o.FLOAT,!1,0,0)),f.normal>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglNormalBuffer),this.enableAttribute(f.normal),o.vertexAttribPointer(f.normal,3,o.FLOAT,!1,0,0)),f.uv>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglUVBuffer),this.enableAttribute(f.uv),o.vertexAttribPointer(f.uv,2,o.FLOAT,!1,0,0)),f.uv2>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglUV2Buffer),this.enableAttribute(f.uv2),o.vertexAttribPointer(f.uv2,2,o.FLOAT,!1,0,0)),f.lineDistance>=0&&(o.bindBuffer(o.ARRAY_BUFFER,u.__webglLineDistanceBuffer),this.enableAttribute(f.lineDistance),o.vertexAttribPointer(f.lineDistance,1,o.FLOAT,!1,0,0))}s instanceof n.Entity?(r.wireframe?(this.setLineWidth(r.wireframeLinewidth),this._gl.lineJoin="round",m&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,u.__webglLineBuffer),o.drawElements(o.LINES,u.__webglLineCount,o.UNSIGNED_SHORT,0)):(m&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,u.__webglFaceBuffer),o.drawElements(o.TRIANGLES,u.__webglFaceCount,o.UNSIGNED_SHORT,0)),this.info.render.calls++,this.info.render.vertices+=i.__webglFaceCount,this.info.render.faces+=i.__webglFaceCount/3):s instanceof n.Line?(c=s.type===n.LineStrip?o.LINE_STRIP:o.LINES,this.setLineWidth(r.linewidth),o.drawArrays(c,0,u.__webglLineCount),this.info.render.calls++):s instanceof n.Particle?(o.drawArrays(o.POINTS,0,u.__webglParticleCount),this.info.render.calls++,this.info.render.points+=u.__webglParticleCount):s instanceof n.Ribbon&&(o.drawArrays(o.TRIANGLE_STRIP,0,i.__webglVertexCount),this.info.render.calls++)},prepareData:function(){this.maxLightCount=this.dataBox.allocateLights(this._maxLights),this.maxShadows=this.dataBox.allocateShadows(),this.maxPointShadows=this.dataBox.allocatePointShadows()},wrapBillboardMaterial:function(e){e instanceof n.Billboard&&e.material&&(e.opaque=e.material.transparent?null:e.material,e.transparent=e.material.transparent?e.material:null)},sortNodesFunc:function(e){if(this.sortNodes&&(this.paintSortFunction!==null||this.sortOpaqueOrderByMaterial)){var t=this;this.sortOpaqueOrderByMaterial?this.__st==null&&(this.__st=function(e,n){t.wrapBillboardMaterial(e),t.wrapBillboardMaterial(e);var r="opaque";if(e[r]&&n[r])return e[r].id-n[r].id;if(!e[r]&&n[r])return-1;if(e[r]&&!n[r])return 1;var i=e.node?e.node:e,s=n.node?n.node:n;i.z=e.z,s.z=n.z;if(t.paintSortFunction)return t.paintSortFunction(i,s)}):this.__st==null&&(this.__st=function(e,n){var r=e.node?e.node:e,i=n.node?n.node:n;r.z=e.z,i.z=n.z;if(t.paintSortFunction)return t.paintSortFunction(r,i)}),e.sort(this.__st)}return e},renderNode:function(e,t){this.setupMatrices(e),e instanceof n.Entity&&renderEntity(e)},paintTopCanvas:function(){var e=this._topCanvas.getContext("2d");e.clearRect(0,0,this._topCanvas.width,this._topCanvas.height);var t=this.areaPickingRect;t&&(e.beginPath(),e.lineStyle="#FFffff",e.rect(t.x,t.y,t.w,t.h),e.stroke()),this.renderLicense()},setBackgroundImage:function(e){if(typeof e=="string"){var t=new Image;e.startsWith("data:image")||(t.crossOrigin="use-credentials"),t.src=e,this._backgroundImage=t;var n=this;t.onload=function(){n.dirtyGl3dview()}}else this._backgroundImage=e,this.dirtyGl3dview()},paintBottom:function(e){var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);var n=this._backgroundImage;n instanceof Image&&n.height&&t.drawImage(n,0,0,e.width,e.height)},initBufferNode:function(e){if(!this.bufferNodeMap[e._id]){var t={};this.bufferNodeMap[e._id]=t;var n,r,i,s=this._gl;for(n in e.attributes)n==="index"?i=s.ELEMENT_ARRAY_BUFFER:i=s.ARRAY_BUFFER,r=e.attributes[n],t[n]=s.createBuffer(),s.bindBuffer(i,t[n]),s.bufferData(i,r.array,s.STATIC_DRAW)}},setBufferNodeData:function(e,n,r){var i=this.bufferNodeMap[e._id],s=e.attributes,o=s.index,u=s.position,a=s.normal,f=s.uv,l=s.color,c=s.tangent,h=this._gl;e.elementsNeedUpdate&&o!==t&&(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,i.index),h.bufferData(h.ELEMENT_ARRAY_BUFFER,o.array,n)),e.verticesNeedUpdate&&u!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.position),h.bufferData(h.ARRAY_BUFFER,u.array,n)),e.normalsNeedUpdate&&a!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.normal),h.bufferData(h.ARRAY_BUFFER,a.array,n)),e.uvsNeedUpdate&&f!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.uv),h.bufferData(h.ARRAY_BUFFER,f.array,n)),e.colorsNeedUpdate&&l!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.color),h.bufferData(h.ARRAY_BUFFER,l.array,n)),e.tangentsNeedUpdate&&c!==t&&(h.bindBuffer(h.ARRAY_BUFFER,i.tangent),h.bufferData(h.ARRAY_BUFFER,c.array,n));if(r)for(var p in e.attributes);},initGroupBuffer:function(e,n,r,i){var s=n.faces3,o=n.faces4,u=s.length*3+o.length*4,a=s.length*1+o.length*2,f=s.length*3+o.length*4,l=w.getMaterial(e,n.materialIndex?n.materialIndex:0),c=l.needUV(),h=l.getNormalType(),p=l.isVertexColor();r.__vertexArray=new Float32Array(u*3),h&&(r.__normalArray=new Float32Array(u*3));if(i)return;p&&(r.__colorArray=new Float32Array(u*3)),c&&(r.__uvArray=new Float32Array(u*2),e.uv2s&&(r.__uv2Array=new Float32Array(u*2))),r.__faceArray=new Uint16Array(a*3),r.__lineArray=new Uint16Array(f*2);var d,v;if(n.numMorphTargets){r.__morphTargetsArrays=[];for(d=0,v=n.numMorphTargets;d<v;d++)r.__morphTargetsArrays.push(new Float32Array(u*3))}if(n.numMorphNormals){r.__morphNormalsArrays=[];for(d=0,v=n.numMorphNormals;d<v;d++)r.__morphNormalsArrays.push(new Float32Array(u*3))}r.__webglFaceCount=a*3,r.__webglLineCount=f*2;if(l.attributes){r.__webglCustomAttributesList===t&&(r.__webglCustomAttributesList=[]);for(var m in l.attributes){var g=l.attributes[m],y={};for(var b in g)y[b]=g[b];if(!y.__webglInitialized||y.createUniqueBuffers){y.__webglInitialized=!0;var E=1;y.type==="v2"?E=2:y.type==="v3"?E=3:y.type==="v4"?E=4:y.type==="c"&&(E=3),y.size=E,y.array=new Float32Array(u*E),y.buffer=_gl.createBuffer(),y.buffer.belongsToAttribute=m,g.needsUpdate=!0,y.__original=g}r.__webglCustomAttributesList.push(y)}}r.__inittedArrays=!0},createLineBuffers:function(e){this.lineMap[e._id]==null&&(this.lineMap[e._id]={});var t=this.lineMap[e._id],n=this._gl;t.__webglVertexBuffer=n.createBuffer(),t.__webglColorBuffer=n.createBuffer(),t.__webglLineDistanceBuffer=n.createBuffer(),this.info.memory.geometries++},initLineBuffers:function(e){this.lineMap[e._id]==null&&(this.lineMap[e._id]={});var t=this.lineMap[e._id],n=e.vertices.length;t.__vertexArray=new Float32Array(n*3),t.__colorArray=new Float32Array(n*3),t.__lineDistanceArray=new Float32Array(n*1),t.__webglLineCount=n},createParticleBuffers:function(e){this.particleMap[e._id]==null&&(this.particleMap[e._id]={});var t=this.particleMap[e._id],n=this._gl;t.__webglVertexBuffer=n.createBuffer(),t.__webglColorBuffer=n.createBuffer(),this.info.memory.geometries++},initParticleBuffers:function(e){this.particleMap[e._id]==null&&(this.particleMap[e._id]={});var t=this.particleMap[e._id],n=e.vertices.length;t.__vertexArray=new Float32Array(n*3),t.__colorArray=new Float32Array(n*3),t.__sortArray=[],t.__webglParticleCount=n},createGroupBuffer:function(e,t){var n=this._gl;t.__webglVertexBuffer=n.createBuffer(),t.__webglNormalBuffer=n.createBuffer(),t.__webglTangentBuffer=n.createBuffer(),t.__webglColorBuffer=n.createBuffer(),t.__webglUVBuffer=n.createBuffer(),t.__webglUV2Buffer=n.createBuffer(),t.__webglSkinIndicesBuffer=n.createBuffer(),t.__webglSkinWeightsBuffer=n.createBuffer(),t.__webglFaceBuffer=n.createBuffer(),t.__webglLineBuffer=n.createBuffer(),this.info.memory.geometries++},setRenderTarget:function(e){var r=e instanceof J,i=this._gl;if(e&&!e.__webglFramebuffer){e.depthBuffer===t&&(e.depthBuffer=!0),e.stencilBuffer===t&&(e.stencilBuffer=!0),e.__webglTexture=i.createTexture(),this.info.memory.textures++;var s=P.isPowerOfTwo,o=s(e.width)&&s(e.height),u=P.paramToGL(e.format,i),a=P.paramToGL(e.type,i);e.type==n.FloatType;var f=u;if(r){e.__webglFramebuffer=[],e.__webglRenderbuffer=[],i.bindTexture(i.TEXTURE_CUBE_MAP,e.__webglTexture),this.pm.setTextureParameters(i.TEXTURE_CUBE_MAP,e,o);for(var l=0;l<6;l++)e.__webglFramebuffer[l]=i.createFramebuffer(),e.__webglRenderbuffer[l]=i.createRenderbuffer(),i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,f,e.width,e.height,0,u,a,null),this.setupFrameBuffer(e.__webglFramebuffer[l],e,i.TEXTURE_CUBE_MAP_POSITIVE_X+l),this.setupRenderBuffer(e.__webglRenderbuffer[l],e);o&&i.generateMipmap(i.TEXTURE_CUBE_MAP)}else e.__webglFramebuffer=i.createFramebuffer(),e.shareDepthFrom?e.__webglRenderbuffer=e.shareDepthFrom.__webglRenderbuffer:e.__webglRenderbuffer=i.createRenderbuffer(),i.bindTexture(i.TEXTURE_2D,e.__webglTexture),this.pm.setTextureParameters(i.TEXTURE_2D,e,o),i.texImage2D(i.TEXTURE_2D,0,f,e.width,e.height,0,u,a,null),this.setupFrameBuffer(e.__webglFramebuffer,e,i.TEXTURE_2D),e.shareDepthFrom?e.depthBuffer&&!e.stencilBuffer?i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e.__webglRenderbuffer):e.depthBuffer&&e.stencilBuffer&&i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e.__webglRenderbuffer):this.setupRenderBuffer(e.__webglRenderbuffer,e),o&&i.generateMipmap(i.TEXTURE_2D);r?i.bindTexture(i.TEXTURE_CUBE_MAP,null):i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null)}var c,h,p,d,v;e?(r?c=e.__webglFramebuffer[e.activeCubeFace]:c=e.__webglFramebuffer,h=e.width,p=e.height,d=0,v=0):(c=null,h=this._viewportWidth,p=this._viewportHeight,d=this._viewportX,v=this._viewportY),c!==this._currentFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,c),i.viewport(d,v,h,p),this._currentFramebuffer=c),this._currentWidth=h,this._currentHeight=p},setupFrameBuffer:function(e,t,n){var r=this._gl;r.bindFramebuffer(r.FRAMEBUFFER,e),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,n,t.__webglTexture,0)},setupRenderBuffer:function(e,t){var n=this._gl;n.bindRenderbuffer(n.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,t.width,t.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,t.width,t.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,e)):n.renderbufferStorage(n.RENDERBUFFER,n.RGBA4,t.width,t.height)},setLineWidth:function(e){e!==this._oldLineWidth&&(this._gl.lineWidth&&this._gl.lineWidth(e),this._oldLineWidth=e)},setupMatrices:function(e,t){e.fixSize(t),e.updateWorldMatrix(),e._modelViewMatrix.multiplyMatrices(t.worldMatrixInverse,e.worldMatrix),e._normalMatrix.getNormalMatrix(e._modelViewMatrix)},setDefaultGLState:function(){var e=this._gl,t=new n.Color(this._clearColor);e.clearColor(t.r,t.g,t.b,this._clearAlpha),e.clearDepth(1),p.isIE||e.clearStencil(0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.frontFace(e.CCW),e.cullFace(e.BACK),e.enable(e.CULL_FACE),e.enable(e.BLEND),e.blendEquation
(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)},clear:function(e,n,r){var i=this._gl,s=0;if(e===t||e)s|=i.COLOR_BUFFER_BIT;if(n===t||n)s|=i.DEPTH_BUFFER_BIT;if(r===t||r)s|=i.STENCIL_BUFFER_BIT;i.clear(s)},setGLFaces:function(e){var t=this._gl,r=e.side===n.DoubleSide,i=e.side===n.BackSide;this._oldDoubleSided!==r&&(r?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),this._oldDoubleSided=r),this._oldFlipSided!==i&&(i?t.frontFace(t.CW):t.frontFace(t.CCW),this._oldFlipSided=i)},getView:function(){return this._canvas},getRootView:function(){return this._rootView},setBlending:function(e,t,n,r){I.setBlending(e,t,n,r,this)},setDepthTest:function(e){I.setDepthTest(e,this)},setDepthWrite:function(e){I.setDepthWrite(e,this)},getLineWidthRange:function(){var e=this._gl;return e.getParameter(e.ALIASED_LINE_WIDTH_RANGE)},setTexture:function(e,t){this.pm.setTexture(e,t)},disableAttributes:function(){for(var e in this._enabledAttributes)this._enabledAttributes[e]&&(this._gl.disableVertexAttribArray(e),this._enabledAttributes[e]=!1)},enableAttribute:function(e){this._enabledAttributes[e]||(this._gl.enableVertexAttribArray(e),this._enabledAttributes[e]=!0)},adjustRootViewBounds:function(e,t){var n=this._rootView;n.style.width=e+"px",n.style.height=t+"px"},adjustCanvasBounds:function(e,t,n,r,i){e.width=t*this.devicePixelRatio,e.height=n*this.devicePixelRatio,e.style.margin="0px",e.style.padding="0px",e.style.width=t+"px",e.style.height=n+"px"},adjustBounds:function(e,t,n,r){var i=this.getView();this.adjustRootViewBounds(e,t,n,r),this.adjustCanvasBounds(i,e,t,n,r),this.adjustCanvasBounds(this._topCanvas,e,t,n,r),this.adjustCanvasBounds(this._bottomCanvas,e,t,n,r),this.adjustCallback(e,t,n,r),this.setViewport(0,0,i.width,i.height);if(this.autoUpdateGleyeAspect&&t!==0){var s=this._gleye;s.aspect=e/t,s.updateProjectionMatrix(),this._currentGleye=null}this.dirtyGl3dview()},adjustCallback:function(){},setViewport:function(e,n,r,i){this._viewportX=e!==t?e:0,this._viewportY=n!==t?n:0,this._viewportWidth=r!==t?r:_canvas.width,this._viewportHeight=i!==t?i:_canvas.height,this._gl.viewport(this._viewportX,this._viewportY,this._viewportWidth,this._viewportHeight)},setShowAxis:function(e){if(this.showAxis===e)return;this.showAxis=e,this.showAxis&&(this.helperBox.contains(this.axis)||this.helperBox.addByDescendant(this.axis)),this.axis._visible=e,this.dirtyGl3dview()},setShowAxisText:function(e){this.axis.showAxisText(e),this.dirtyGl3dview()},setAxisSize:function(e){this.axis.setSize(e)},onSelect:function(e){this.onSelectFunction!=null&&this.onSelectFunction(e)},setOnSelectFunction:function(e){this.onSelectFunction=e},isSelectable:function(e){return e.isSelectable()?this.selectableFunction?this.selectableFunction(e):!0:!1},setSelectableFunction:function(e){this.selectableFunction=e},setRenderSelectFunction:function(e){this.renderSelectFunction=e},renderSelect:function(e){return this.renderSelectFunction?this.renderSelectFunction(e):!0},renderAlarmBorder:function(e){return this.renderAlarmBorderFunction?this.renderAlarmBorderFunction(e):!0},selectable:function(e){return e.element.isVisible()&&this.isSelectable(e.element)&&this.getServa().getSelectionContainer().isSelectable(e.element)},editable:function(e){var t=this.selectable(e);return t&&this.editableFunction!=null?this.editableFunction(e.element):t},getFirstSelectElement:function(e){if(e==null)return null;var t=0,n;while(t<e.length){var r=e[t];if(this.selectable(r)){n=r.element;break}t++}return n},getFirstEditElement:function(e){if(e==null)return null;var t=0,n;while(t<e.length){var r=e[t];if(this.editable(r)){n=r.element;break}t++}return n},toImageData:function(e,t,n,r){this.dirtyGl3dview(),this.render(),e=e||"PNG",e.toUpperCase();if(e==="PNG")return d.saveAsPNG(this.getView(),t,!1,n,r);if(e==="JPEG")return d.saveAsJPEG(this.getView(),t,!1,n,r);if(e==="BMP")return d.saveAsBMP(this.getView(),t,!1,n,r);console.log("Not surport type "+e)},getPickingByEvent:function(e){var t=this._gleye,r={},i=this.getView(),s=i.getBoundingClientRect(),u=e.clientX,a=e.clientY;e.touches&&e.touches.length&&(u=e.touches[0].pageX,a=e.touches[0].pageY);var f=(u-s.left)/s.width,l=(a-s.top)/s.height;r.x=f*2-1,r.y=-l*2+1;var c=new n.XiangliangThree(r.x,r.y,.5);this.projector.unprojectVector(c,t);var h=null;if(t instanceof n.PerspectiveGleye)h=new n.Picking(t._position,c.sub(t._position).normalize(),t.up,null,null,this);else{var p=c.clone().sub(t._position),d=t.getTarget().clone().sub(t.p()).normalize(),v=d.multiplyScalar(p.clone().dot(d)),m=p.sub(v),g=(new o).addVectors(t._position,m);h=new n.Picking(g,c.sub(g).normalize(),t.up,null,null,this)}return h},getElementsByMouseEvent:function(e,t){var n=this.getPickingByEvent(e),r=new N;r.addAll(this.dataBox.getNodes()),r.addAll(this.dataBox.getBillboards());var i=n.intersectObjects(r.toArray(),!1,t);return i},getElementByScreenPoint:function(e,t,r){var i={},s=this.getView(),o=this._gleye,u=s.getBoundingClientRect();e.x&&(r=t,t=e.y,e=e.x),e/=u.width,t/=u.height,i.x=e*2-1,i.y=-t*2+1;var a=new n.XiangliangThree(i.x,i.y,.5);this.projector.unprojectVector(a,o);var f=new n.Picking(o._position,a.sub(o._position).normalize(),o.up,null,null,this),l=new N;l.addAll(this.dataBox.getNodes()),l.addAll(this.dataBox.getBillboards());var c=f.intersectObjects(l.toArray(),!1,r);return c},getFirstElementByMouseEvent:function(e,t,n){var r=this.getElementsByMouseEvent(e,t);if(r.length)for(var i=0;i<r.length;i++){var s=r[i],o=s.element;if(n==null||n.call(null,o))return s}return null},getUnProjectVector:function(e){var t={},r=this.getView().getBoundingClientRect(),i=e.x/r.width,s=e.y/r.height;t.x=i*2-1,t.y=-s*2+1;var o=new n.XiangliangThree(t.x,t.y,.5);return this.projector.unprojectVector(o,this._gleye),o},getFrustumByBounding:function(e){var t=e,r=this.getUnProjectVector(new s(t.x,t.y)),i=this.getUnProjectVector(new s(t.x+t.w,t.y)),o=this.getUnProjectVector(new s(t.x,t.y+t.h)),u=this.getUnProjectVector(new s(t.x+t.w,t.y+t.h)),a=this.getNearFarPoints(r),f=this.getNearFarPoints(i),l=this.getNearFarPoints(o),c=this.getNearFarPoints(u),h=new n.math.Plane,p=new n.math.Plane,d=new n.math.Plane,v=new n.math.Plane,m=new n.math.Plane,g=new n.math.Plane;h.setFromCoplanarPoints(a[0],f[0],l[0]),p.setFromCoplanarPoints(a[0],a[1],f[0]),d.setFromCoplanarPoints(a[0],l[0],a[1]),v.setFromCoplanarPoints(f[0],f[1],c[0]),m.setFromCoplanarPoints(l[0],c[0],l[1]),g.setFromCoplanarPoints(a[1],l[1],f[1]);var y=new n.Frustum(h,p,d,v,m,g);return y.setPoints([a[0],f[0],l[0],c[0],a[1],f[1],l[1],c[1]]),y},getNearFarPoints:function(e){var t=this._gleye,n=e.sub(t._position).normalize(),r=t.target.clone().sub(t._position),i=n.angleTo(r),s=t.getNear()/Math.acos(i),o=t.getFar()/Math.acos(i),u=t._position.clone().add(n.clone().multiplyScalar(s)),a=t._position.clone().add(n.clone().multiplyScalar(o));return[u,a]},getSpacePointOnPlane:function(e,t){var r={},i=this.getView(),s=this._gleye,o=i.getBoundingClientRect(),u=e.clientX,a=e.clientY;e.touches&&e.touches.length&&(u=e.touches[0].pageX,a=e.touches[0].pageY);var f=(u-o.left)/o.width,l=(a-o.top)/o.height;r.x=f*2-1,r.y=-l*2+1;var c=new n.XiangliangThree(r.x,r.y,.5);this.projector.unprojectVector(c,s);var h=s._position,p=c.sub(s._position).normalize(),d=new n.Ray(h,p),v=d.distanceToPlane(t);if(v<0||Math.abs(v)<n.Picking.prototype.precision)return null;var m=d.at(v);return m},getElementsByBounding:function(e,t,r){var i=new N;i.addAll(this.dataBox.getNodes()),i.addAll(this.dataBox.getBillboards());var s=this.getFrustumByBounding(e),u=[],a=new o,f,l=this._gleye;return i.forEach(function(e){if(e instanceof n.Billboard){a.setFromMatrixPosition(e.worldMatrix);var t=e.material,i=t.alignment;f=new n.Plane(1,1);if(i.x||i.y)f.setPosition(i.x,i.y,0),f=n.Utils.transformElement(f,!0);f.setPosition(a);var c=(new o).getScaleFromMatrix(e.worldMatrix);f.setScale(c.x,c.y,1);var h=l.getTarget().clone(),p=l.getPosition();h.sub(p);var d=f.getPosition().clone();t&&t.vertical&&(h.y=0),d.sub(h),f.lookAt(d),f.updateWorldMatrix(!0),s.intersectsObjectAccurate(f,r)&&u.push({element:e})}else e instanceof n.Line?s.intersectsObjectAccurate(e,r)&&u.push({element:e}):s.intersectsObjectAccurate(e,r)&&u.push({element:e})}),u},getViewPosition:function(e){var t=new o;t=this.projector.projectVector(e,this._gleye,t),t.x=t.x/2+.5,t.y=-t.y/2+.5;var n={x:this._canvas.width*t.x/this.devicePixelRatio,y:this._canvas.height*t.y/this.devicePixelRatio,h:this._canvas.height};return n},setInteractions:function(e){var t=this._interactions,n,r;if(t)for(n=0;n<t.length;n++)r=t[n],r.tearDown();this._interactions=e;if(e)for(n=0;n<e.length;n++)r=e[n],r.setUp()},getDefaultInteraction:function(){if(this._interactions&&this._interactions.length>0)for(var e=0;e<this._interactions.length;e++){var t=this._interactions[e];if(t instanceof n.DefaultInteraction)return t}return null},getInteractions:function(){return this._interactions},fireInteractionEvent:function(e){this._interactionDispatcher.fire(e)},addInteractionListener:function(e,t,n){this._interactionDispatcher.add(e,t,n)},removeInteractionListener:function(e,t){this._interactionDispatcher.remove(e,t)},dispose:function(){},setRenderInterval:function(e){if(P.isNaN(e)||e<=5)e=5;this._renderInterval=e},_computeGl3dviewBizBox:function(){function c(e,t){e.applyMatrix4(t),a.push(e)}var e=this.getServa().size(),t=this.getServa().getDatas(),r,i,s,u,a=[];for(r=0;r<e;r++){i=t.get(r);if(i instanceof n.Node){s=i.getBizBox(),u=i.worldMatrix;var f=s.min,l=s.max;c(f.clone(),u),c(l.clone(),u),c(new o(f.x,f.y,l.z),u),c(new o(f.x,l.y,f.z),u),c(new o(l.x,f.y,f.z),u),c(new o(l.x,l.y,f.z),u),c(new o(l.x,f.y,l.z),u),c(new o(f.x,l.y,l.z),u)}}if(a.length<=1)return null;var h=new n.BizBox;return h.setFromPoints(a),h},getGl3dviewBizBox:function(){return this.boundingBox==null&&(this.boundingBox=this._computeGl3dviewBizBox()),this.boundingBox},getSelectStyle:function(e){return e.getSelectStyle()},zoomEstimateOverview:function(e){var t=this.getGl3dviewBizBox();if(t==null)return;var n=t.center(),r=new o(0,t.max.y-t.min.y,t.max.z-t.min.z),i=new o(t.max.x-t.min.x,0,0,0),s=r.clone();s.length()<i.length()&&(s=i.clone());var u;if(e){var a=r.length();r.y=r.z*Math.tan(e/180*Math.PI),r.setLength(a)}u=(new o).addVectors(n,r.multiplyScalar(.5));var f=this._gleye.fov,l=this._gleye.aspect,c=s.length()/2/Math.tan(f*Math.PI/180);u.add(r.normalize().multiplyScalar(c)),this._gleye.setPosition(u),this._gleye.lookAt(n)}}),n.Gl3dview3DId=0,n.Gl3dview3D.GroupCache={_groupCounter:0};var Q=function(){function W(){if(r===s){var e=new $RenderObject;return i.push(e),s++,r++,e}return i[r++]}function X(){if(u===f){var e=new $RenderVertex;return a.push(e),f++,u++,e}return a[u++]}function V(){if(c===p){var e=new n.RenderFace3;return h.push(e),p++,c++,e}return h[c++]}function $(){if(d===m){var e=new n.RenderFace4;return v.push(e),m++,d++,e}return v[d++]}function J(){if(y===w){var e=new n.RenderLine;return b.push(e),w++,y++,e}return b[y++]}function K(){if(S===T){var e=new n.RenderableParticle;return x.push(e),T++,S++,e}return x[S++]}function Q(e,t){return t.z-e.z}function G(e,t){var n=0,r=1,i=e.z+e.w,s=t.z+t.w,o=-e.z+e.w,u=-t.z+t.w;return i>=0&&s>=0&&o>=0&&u>=0?!0:i<0&&s<0||o<0&&u<0?!1:(i<0?n=Math.max(n,i/(i-s)):s<0&&(r=Math.min(r,i/(i-s))),o<0?n=Math.max(n,o/(o-u)):u<0&&(r=Math.min(r,o/(o-u))),r<n?!1:(e.lerp(t,n),t.lerp(e,1-r),!0))}var e,r,i=[],s=0,o,u,a=[],f=0,l,c,h=[],p=0,d,v=[],m=0,g,y,b=[],w=0,E,S,x=[],T=0,N={objects:[],sprites:[],lights:[],elements:[]},C=new n.XiangliangThree,k=new n.Vec4,L=new n.BizBox(new n.XiangliangThree(-1,-1,-1),new n.XiangliangThree(1,1,1)),A=new n.BizBox,O=new Array(3),M=new Array(4),_=new n.Mat4,D=new n.Mat4,P,H=new n.Mat4,B=new n.Mat3,j=new n.Mat3,F=new n.XiangliangThree,I=new n.Frustum,q=new n.Vec4,R=new n.Vec4,U;this.projectVector=function(e,n,r){return n.worldMatrixInverse.getInverse(n.worldMatrix),D.multiplyMatrices(n.projectionMatrix,n.worldMatrixInverse),r===t?e.applyProjection(D):(r.copy(e),r.applyProjection(D))},this.unprojectVector=function(e,t){return t.projectionMatrixInverse.getInverse(t.projectionMatrix),D.multiplyMatrices(t.worldMatrix,t.projectionMatrixInverse),e.applyProjection(D)},this.pickingRay=function(e,t){e.z=-1;var r=new n.XiangliangThree(e.x,e.y,1);return this.unprojectVector(e,t),this.unprojectVector(r,t),r.sub(e).normalize(),new n.Picking(e,r)};var z=function(t,i){r=0,N.objects.length=0,N.sprites.length=0,N.lights.length=0;var s=function(t){var r;t instanceof n.Serva?r=t.getRoots():r=t.getChildren(),r=r.toList();for(var i=0,o=r.size();i<o;i++){var u=r.get(i);u.isSelected()&&u instanceof n.Node&&(r.add(u.createCanvasSelectionCube(),i),i++)}for(var i=0,o=r.size();i<o;i++){var u=r.get(i);if(u._visible===!1)continue;if(u instanceof n.Light)N.lights.push(u);else if(u instanceof n.Entity||u instanceof n.Line){if(u.frustumCulled===!1||I.intersectsObject(u)===!0)e=W(),e.object=u,u.renderDepth!==null?e.z=u.renderDepth:(C.copy(u.worldMatrix.getPosition()),C.applyProjection(D),e.z=C.z),N.objects.push(e)}else u instanceof n.Billboard||u instanceof n.Particle?(e=W(),e.object=u,u.renderDepth!==null?e.z=u.renderDepth:(C.copy(u.worldMatrix.getPosition()),C.applyProjection(D),e.z=C.z),N.sprites.push(e)):(e=W(),e.object=u,u.renderDepth!==null?e.z=u.renderDepth:(C.copy(u.worldMatrix.getPosition()),C.applyProjection(D),e.z=C.z),N.objects.push(e));s(u)}};return s(t),i===!0&&N.objects.sort(Q),N};this.projectServa=function(e,r,i,s){var f=!1,h,p,v,m,b,w,x,T,C,U,W,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt;c=0,d=0,y=0,S=0,N.elements.length=0;for(var vt=0;vt<e.getRoots().size();vt++){var mt=e.getRoots().get(vt);mt.updateWorldMatrix()}r.parent===t&&r.updateWorldMatrix(!0,!1),_.copy(r.worldMatrixInverse.getInverse(r.worldMatrix)),D.multiplyMatrices(r.projectionMatrix,_),j.getInverse(_),j.transpose(),I.setFromMatrix(D),N=z(e,i);for(h=0,p=N.objects.length;h<p;h++){Z=N.objects[h].object,P=Z.worldMatrix,u=0;if(Z instanceof n.Entity){et=Z,tt=et.vertices,it=et.faces,at=et.uvs,B.getInverse(P),B.transpose(),pt=Z.material instanceof n.ArrayMaterial,dt=pt===!0?Z.material:null;for(v=0,m=tt.length;v<m;v++)o=X(),o.positionWorld.copy(tt[v]).applyMatrix4(P),o.positionScreen.copy(o.positionWorld).applyMatrix4(D),o.positionScreen.x/=o.positionScreen.w,o.positionScreen.y/=o.positionScreen.w,o.positionScreen.z/=o.positionScreen.w,o.visible=!(o.positionScreen.x<-1||o.positionScreen.x>1||o.positionScreen.y<-1||o.positionScreen.y>1||o.positionScreen.z<-1||o.positionScreen.z>1);for(b=0,w=it.length;b<w;b++){st=it[b];var gt=pt===!0?dt.materials[st.materialIndex]:Z.material;if(gt===t)continue;var yt=gt.side;if(st instanceof n.Face3){ft=a[st.a],lt=a[st.b],ct=a[st.c],O[0]=ft.positionScreen,O[1]=lt.positionScreen,O[2]=ct.positionScreen;if(ft.visible!==!0&&lt.visible!==!0&&ct.visible!==!0&&!L.isIntersectionBox(A.setFromPoints(O)))continue;f=(ct.positionScreen.x-ft.positionScreen.x)*(lt.positionScreen.y-ft.positionScreen.y)-(ct.positionScreen.y-ft.positionScreen.y)*(lt.positionScreen.x-ft.positionScreen.x)<0;if(yt!==n.DoubleSide&&f!==(yt===n.FrontSide))continue;l=V(),l.v1.copy(ft),l.v2.copy(lt),l.v3.copy(ct)}else if(st instanceof n.Face4){ft=a[st.a],lt=a[st.b],ct=a[st.c],ht=a[st.d],M[0]=ft.positionScreen,M[1]=lt.positionScreen,M[2]=ct.positionScreen,M[3]=ht.positionScreen;if(ft.visible!==!0&&lt.visible!==!0&&ct.visible!==!0&&ht.visible!==!0&&!L.isIntersectionBox(A.setFromPoints(M)))continue;f=(ht.positionScreen.x-ft.positionScreen.x)*(lt.positionScreen.y-ft.positionScreen.y)-(ht.positionScreen.y-ft.positionScreen.y)*(lt.positionScreen.x-ft.positionScreen.x)<0||(lt.positionScreen.x-ct.positionScreen.x)*(ht.positionScreen.y-ct.positionScreen.y)-(lt.positionScreen.y-ct.positionScreen.y)*(ht.positionScreen.x-ct.positionScreen.x)<0;if(yt!==n.DoubleSide&&f!==(yt===n.FrontSide))continue;l=$(),l.v1.copy(ft),l.v2.copy(lt),l.v3.copy(ct),l.v4.copy(ht)}l.normalContainer.copy(st.normal),f===!1&&(yt===n.BackSide||yt===n.DoubleSide)&&l.normalContainer.negate(),l.normalContainer.applyMatrix3(B).normalize(),l.normalContainerView.copy(l.normalContainer).applyMatrix3(j),l.centroidContainer.copy(st.centroid).applyMatrix4(P),ot=st.vertexNormals;for(x=0,T=ot.length;x<T;x++){var bt=l.vertexNormalsContainer[x];bt.copy(ot[x]),f===!1&&(yt===n.BackSide||yt===n.DoubleSide)&&bt.negate(),bt.applyMatrix3(B).normalize();var wt=l.vertexNormalsContainerView[x];wt.copy(bt).applyMatrix3(j)}l.vertexNormalsLength=ot.length;var Et=at[b];for(W=0,Y=Et.length;W<Y;W++)l.uvs[0][W]=Et[W];l.color=st.color,l.material=gt,F.copy(l.centroidContainer).applyProjection(D),l.z=F.z,N.elements.push(l)}}else if(Z instanceof n.Line){H.multiplyMatrices(D,P),tt=Z.vertices,ft=X(),ft.positionScreen.copy(tt[0]).applyMatrix4(H);var St=Z.type===n.LinePieces?2:1;for(v=1,m=tt.length;v<m;v++){ft=X(),ft.positionScreen.copy(tt[v]).applyMatrix4(H);if((v+1)%St>0)continue;lt=a[u-2],q.copy(ft.positionScreen),R.copy(lt.positionScreen),G(q,R)===!0&&(q.multiplyScalar(1/q.w),R.multiplyScalar(1/R.w),g=J(),g.v1.positionScreen.copy(q),g.v2.positionScreen.copy(R),g.z=Math.max(q.z,R.z),g.material=Z.material,N.elements.push(g))}}}for(h=0,p=N.sprites.length;h<p;h++)Z=N.sprites[h].object,P=Z.worldMatrix,Z instanceof n.Particle&&(k.set(P.elements[12],P.elements[13],P.elements[14],1),k.applyMatrix4(D),k.z/=k.w,k.z>0&&k.z<1&&(E=K(),E.object=Z,E.x=k.x/k.w,E.y=k.y/k.w,E.z=k.z,E.rotation=Z.rotation.z,E.scale.x=Z.scale.x*Math.abs(E.x-(k.x+r.projectionMatrix.elements[0])/(k.w+r.projectionMatrix.elements[12])),E.scale.y=Z.scale.y*Math.abs(E.y-(k.y+r.projectionMatrix.elements[5])/(k.w+r.projectionMatrix.elements[13])),E.material=Z.material,N.elements.push(E)));return s===!0&&N.elements.sort(Q),N}};n.Projector=Q,n.Billboard=function(e){e!=null&&e.id!=null?this._id=e.id:this._id=e,n.Element.call(this,this._id),this.material=new n.BillboardMaterial,this.rotation3d=this._rotation,this.rotation=0,this.vertices=[new o(-0.5,-0.5,0),new o(.5,-0.5,0),new o(.5,.5,0),new o(-0.5,.5,0)]},n.extend(n.Billboard,n.Element,{constructor:n.Billboard,className:"TGL.Billboard",updateMatrix:function(){this.matrix.setPosition(this._position),this.rotation=this._rotation.z,this.rotation3d.set(0,0,this.rotation),this.matrix.setRotationFromEuler(this.rotation3d),(this._scale.x!==1||this._scale.y!==1)&&this.matrix.scale(this._scale),this.matrixWorldNeedsUpdate=!0},clone:function(e){return e===t&&(e=new n.Billboard(this.material)),n.Element.prototype.clone.call(this,e),e},setMaterialStyle:function(e,t){var n=this.material.clone();e=e.substr(e.indexOf(".")+1),this._A97(n,e,t);var r=n.getUniqueCode(),i=ni.getMaterial(r);i!=null?(ni.unUseMaterial(this.material),this.material=i,ni.useMaterial(i)):(ni.unUseMaterial(this.material),ni.setMaterial(r,n),this.material=n)}}),n.ShaderSprite={sprite:{vertexShader:["uniform int useScreenCoordinates;","uniform int sizeAttenuation;","uniform vec3 screenPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 alignment;","uniform vec2 uvOffset;","uniform vec2 uvScale;","uniform bool vertical;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = (position + alignment) * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","vec4 upPosition;","vec4 rightPosition = vec4(scale.x,0.0,0.0,1.0);","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","if(vertical){","upPosition =  modelViewMatrix * vec4( 0.0, 1.0, 0.0, 1.0 ) - finalPosition;","normalize(upPosition);","}","if(vertical){","finalPosition.xyz += (rotatedPosition.x * rightPosition.xyz / scale.x) + (rotatedPosition.y * upPosition.xyz / scale.y);","}else{","finalPosition.xy += rotatedPosition;","}","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform int useMap;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","if(useMap > 0){","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","} else {","gl_FragColor = vec4( color, 1.0);","}","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")}},n.BillboardRenderer=function(){function a(t,n){var r=e.createProgram(),i=e.createShader(e.FRAGMENT_SHADER),s=e.createShader(e.VERTEX_SHADER),o="precision "+n+" float;\n";return e.shaderSource(i,o+t.fragmentShader),e.shaderSource(s,o+t.vertexShader),e.compileShader(i),e.compileShader(s),e.attachShader(r,i),e.attachShader(r,s),e.linkProgram(r),r}function f(e,t){return e.z!==t.z?t.z-e.z:1}var e,t,r,i={},s=new n.Billboard,u=new n.BillboardMaterial({color:255});this.init=function(s){e=s._gl,t=s,r=s.getPrecision(),i.vertices=new Float32Array(16),i.faces=new Uint16Array(6),i.lines=new Uint16Array(8);var o=0;i.vertices[o++]=-0.5,i.vertices[o++]=-0.5,i.vertices[o++]=0,i.vertices[o++]=0,i.vertices[o++]=.5,i.vertices[o++]=-0.5,i.vertices[o++]=1,i.vertices[o++]=0,i.vertices[o++]=.5,i.vertices[o++]=.5,i.vertices[o++]=1,i.vertices[o++]=1,i.vertices[o++]=-0.5,i.vertices[o++]=.5,i.vertices[o++]=0,i.vertices[o++]=1,o=0,i.faces[o++]=0,i.faces[o++]=1,i.faces[o++]=2,i.faces[o++]=0,i.faces[o++]=2,i.faces[o++]=3,o=0,i.lines[o++]=0,i.lines[o++]=1,i.lines[o++]=0,i.lines[o++]=3,i.lines[o++]=1,i.lines[o++]=2,i.lines[o++]=2,i.lines[o++]=3,i.vertexBuffer=e.createBuffer(),i.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,i.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,i.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i.faces,e.STATIC_DRAW),i.program=a(n.ShaderSprite.sprite,r),i.attributes={},i.uniforms={},i.attributes.position=e.getAttribLocation(i.program,"position"),i.attributes.uv=e.getAttribLocation(i.program,"uv"),i.uniforms.uvOffset=e.getUniformLocation(i.program,"uvOffset"),i.uniforms.uvScale=e.getUniformLocation(i.program,"uvScale"),i.uniforms.rotation=e.getUniformLocation(i.program,"rotation"),i.uniforms.scale=e.getUniformLocation(i.program,"scale"),i.uniforms.alignment=e.getUniformLocation(i.program,"alignment"),i.uniforms.color=e.getUniformLocation(i.program,"color"),i.uniforms.useMap=e.getUniformLocation(i.program,"useMap"),i.uniforms.map=e.getUniformLocation(i.program,"map"),i.uniforms.opacity=e.getUniformLocation(i.program,"opacity"),i.uniforms.vertical=e.getUniformLocation(i.program,"vertical"),i.uniforms.useScreenCoordinates=e.getUniformLocation(i.program,"useScreenCoordinates"),i.uniforms.sizeAttenuation=e.getUniformLocation(i.program,"sizeAttenuation"),i.uniforms.screenPosition=e.getUniformLocation(i.program,"screenPosition"),i.uniforms.modelViewMatrix=e.getUniformLocation(i.program,"modelViewMatrix"),i.uniforms.projectionMatrix=e.getUniformLocation(i.program,"projectionMatrix"),i.uniforms.fogType=e.getUniformLocation(i.program,"fogType"),i.uniforms.fogDensity=e.getUniformLocation(i.program,"fogDensity"),i.uniforms.fogNear=e.getUniformLocation(i.program,"fogNear"),i.uniforms.fogFar=e.getUniformLocation(i.program,"fogFar"),i.uniforms.fogColor=e.getUniformLocation(i.program,"fogColor"),i.uniforms.alphaTest=e.getUniformLocation(i.program,"alphaTest")},this.render=function(r,s,o,a,f){var l=new N(s),c=l.size();if(!c)return;var h=i.attributes,p=i.uniforms,d=a*.5,v=f*.5,m=!1;r.pm.currentProgram!=i.program&&(e.useProgram(i.program),r.pm.currentProgram=i.program,r._currentGroupHash=null,e.enableVertexAttribArray(h.position),e.enableVertexAttribArray(h.uv),e.disable(e.CULL_FACE),e.bindBuffer(e.ARRAY_BUFFER,i.vertexBuffer),e.vertexAttribPointer(h.position,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(h.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),this.enable=!0,m=!0),e.uniformMatrix4fv(p.projectionMatrix,!1,o.projectionMatrix.elements),m&&e.activeTexture(e.TEXTURE0),m&&e.uniform1i(p.map,0);var g=0,y=0,b=r.fog;b?(e.uniform3f(p.fogColor,b.color.r,b.color.g,b.color.b),b instanceof n.Fog?(e.uniform1f(p.fogNear,b.near),e.uniform1f(p.fogFar,b.far),e.uniform1i(p.fogType,1),g=1,y=1):b instanceof n.FogExp2&&(e.uniform1f(p.fogDensity,b.density),e.uniform1i(p.fogType,2),g=2,y=2)):(g=0,y=0);var w,E,S,x,T,C,k=[];for(w=0;w<c;w++){E=l.get(w),S=E.material;if(!t.isVisible(E)||S.opacity===0)continue;E.updateWorldMatrix(!0,!1),S.useScreenCoordinates?E.z=-E.position.z:(E._modelViewMatrix=new n.Mat4,E._modelViewMatrix.multiplyMatrices(o.worldMatrixInverse,E.worldMatrix),E.z=-E._modelViewMatrix.elements[14])}for(w=0;w<c;w++)E=l.get(w),this.renderBillboard(E,p,r,g,y),E._selected&&(E._scale.x=E._scale.x*1.01,E._scale.y=E._scale.y*1.01,E.material.clone(u),u.map=null,u.color.set(65280),this.renderBillboard(E,p,r,g,y,u),E._scale.x=E._scale.x/1.01,E._scale.y=E._scale.y/1.01)},this.disable=function(){if(this.enable){var r=i.attributes,s=i.uniforms;e.disableVertexAttribArray(r.position),e.disableVertexAttribArray(r.uv),t._oldDoubleSided||e.enable(e.CULL_FACE),t._oldBlending===n.NoBlending&&e.disable(e.BLEND),I.setDepthWrite(!0,t),this.enable=!1,this.lastMaterialId=null,t.pm.currentProgram=null}},this.renderBillboard=function(n,r,s,u,a,f){var l,c,h,p,d=[],v=new o;l=f?f:n.material;if(!t.isVisible(n)||l.opacity===0)return;var m=l.id,g=m!=this.lastMaterialId;g&&e.uniform1f(r.alphaTest,l.alphaTest),g&&(l.useScreenCoordinates===!0?(e.uniform1i(r.useScreenCoordinates,1),e.uniform3f(r.screenPosition,(n.position.x*t.devicePixelRatio-halfViewportWidth)/halfViewportWidth,(halfViewportHeight-n.position.y*t.devicePixelRatio)/halfViewportHeight,Math.max(0,Math.min(1,n.position.z)))):(e.uniform1i(r.useScreenCoordinates,0),e.uniform1i(r.sizeAttenuation,l.sizeAttenuation?1:0))),l.useScreenCoordinates===!0?(d[0]=t.devicePixelRatio,d[1]=t.devicePixelRatio):(e.uniformMatrix4fv(r.modelViewMatrix,!1,n._modelViewMatrix.elements),d[0]=1,d[1]=1),s.fog&&l.fog?p=a:p=0,u!==p&&(e.uniform1i(r.fogType,p),u=p),h=1/(l.scaleByViewport?viewportHeight:1),v.getScaleFromMatrix(n.worldMatrix),d[0]*=h*v.x,d[1]*=h*v.y,g&&(e.uniform2f(r.uvScale,l.repeat.x,l.repeat.y),e.uniform2f(r.uvOffset,l.offset.x,l.offset.y),e.uniform2f(r.alignment,l.alignment.x,l.alignment.y),e.uniform1f(r.opacity,l.opacity),e.uniform1i(r.vertical,l.vertical),e.uniform3f(r.color,l.color.r,l.color.g,l.color.b),e.uniform1f(r.rotation,n.rotation)),e.uniform2fv(r.scale,d),g&&(t.setBlending(l.blending,l.blendEquation,l.blendSrc,l.blendDst),t.setDepthTest(l.depthTest),t.setDepthWrite(l.depthMask)),l.map&&l.map._image&&t.pm.addTexture(l.map),g=g||l.map&&t.pm.needsUpdateTexture(l.map),l.map&&l.map._image&&l.map._image.width?(g&&t.setTexture(l.map,0),g&&e.uniform1i(r.useMap,1)):g&&e.uniform1i(r.useMap,0),f?(g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),g&&e.bufferData(e.ELEMENT_ARRAY_BUFFER,i.lines,e.STATIC_DRAW),g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),e.drawElements(e.LINES,8,e.UNSIGNED_SHORT,0)):(g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),g&&e.bufferData(e.ELEMENT_ARRAY_BUFFER,i.faces,e.STATIC_DRAW),g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.elementBuffer),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)),this.lastMaterialId=l.id}};var $=function(e,r,i){this.width=e,this.height=r,i=i||{},this.wrapS=i.wrapS!==t?i.wrapS:n.ClampToEdgeWrapping,this.wrapT=i.wrapT!==t?i.wrapT:n.ClampToEdgeWrapping,this.magFilter=i.magFilter!==t?i.magFilter:n.LinearFilter,this.minFilter=i.minFilter!==t?i.minFilter:n.LinearMipMapLinearFilter,this.anisotropy=i.anisotropy!==t?i.anisotropy:1,this.offset=new n.XiangliangTwo(0,0),this.repeat=new n.XiangliangTwo(1,1),this.format=i.format!==t?i.format:n.RGBAFormat,this.type=i.type!==t?i.type:n.UnsignedByteType,this.depthBuffer=i.depthBuffer!==t?i.depthBuffer:!0,this.stencilBuffer=i.stencilBuffer!==t?i.stencilBuffer:!0,this.generateMipmaps=!0,this.shareDepthFrom=null};$.prototype={constructor:$,clone:function(){var e=new $(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e.generateMipmaps=this.generateMipmaps,e.shareDepthFrom=this.shareDepthFrom,e},getUniqueCode:function(){return this._id},dispose:function(){this.dispatchEvent({type:"dispose"})}};var J=function(e,t,n){$.call(this,e,t,n),this.activeCubeFace=0};n.extend(J,$,{});var G="l=1.0\ntype=1\ngis=0\n3d=1\nstart=2015-09-08\nend=2015-12-31\nnote=This license applies to the evaluation version of TWaver. The License is limited to noncommercial use. Noncommercial use relates only to educational, research, personal or evaluation purposes. Any other use is commercial use. You may not use the Software in connection with any business activities.And You are not permitted to modify the software or attempt to decipher, decompile, disassemble or reverse engineer this Software.\nsignature=53257eaba47c7e574e4ea3fd0eee5a998ff03f03280929aca75ecfae6597b5b1e8978056487f57af37bcca3218171bda3588dc0edafa51fc287f55d5dc98e234eea08a6440e7fa081c3a2fabd52abcfc6a656c548e7f3177247e6d1dbf7460919535af2eaeb19936e90dd1a96e6d49a52f5f861f61c53e54e9110b54c51418e258663306b466d7330218402062939ebed9ea1df0c0353b1177ca6ba1757df828ab044451f1c210ae2cb74c0eac63d5386929d9ce5cce86fe0b1c482ccf1c91ea3203e1fcdb96f6e70ce9cd3bb928ff55536cf24d729029116d54eb3ac0ae8d1856a779e233d2f5584e37fcc5f54c04f1a3390493165bf7d80bdea898597d6b43669075815a22fa1d6f9209f2d2fc48df074b63e9607c56286645e05c0b1be7ebd734d3fe64f9c7af32a6485a5b08a2cd9e50ddce8eb2d5124c27792433acf1db2060b1e2cd46062f73251acc74d3b2950b423ba780f3420df5ea16e9f7c2c36e489be9f91db4ff9210a7d8ca5352a39870c62ce72017b21d29785fe42641eabd4ac90ea1df97853ac8fb8b1e34f21e5c709369337ff0b3120bf0e27feaa7d18536f9044451830563c8cb1cedf29cf173afc9366252bfcac225292892b18aeb3a1931d30c79119a05007b1f89250a9313205135ec03ec0acb1ff78757d44fe70215a5f8535ad3e1405253e7109f692e53572bd895f28827f0a0dd2cb828a1b6aa4403eb31710e4420923621a44585f503dcd9eaf4dda4eb943e9aaae1fdc166a4afeada9054f61a7788e6340bfb44b3e30a3db8021ef74ceab171034dc80c5fd9ef932c26b83bb2ab9f52d4a7e291d7feb6e95d2f66fd1b03696546abd7353919e5cbd09a2c68ea31643c0fb120e670dbb467f5539db5b99ac9d5abedc941bddd",Y,Z=0xdeadbeefcafe,et=(Z&16777215)==15715070;et&&navigator.appName=="Microsoft Internet Explorer"?(tt.prototype.am=it,Y=30):et&&navigator.appName!="Netscape"?(tt.prototype.am=rt,Y=26):(tt.prototype.am=st,Y=28),tt.prototype.DB=Y,tt.prototype.DM=(1<<Y)-1,tt.prototype.DV=1<<Y;var ot=52;tt.prototype.FV=Math.pow(2,ot),tt.prototype.F1=ot-Y,tt.prototype.F2=2*Y-ot;var ut="0123456789abcdefghijklmnopqrstuvwxyz",at=new Array,ft,lt;ft="0".charCodeAt(0);for(lt=0;lt<=9;++lt)at[ft++]=lt;ft="a".charCodeAt(0);for(lt=10;lt<36;++lt)at[ft++]=lt;ft="A".charCodeAt(0);for(lt=10;lt<36;++lt)at[ft++]=lt;Dt.prototype.convert=Pt,Dt.prototype.revert=Ht,Dt.prototype.reduce=Bt,Dt.prototype.mulTo=jt,Dt.prototype.sqrTo=Ft,qt.prototype.convert=Rt,qt.prototype.revert=Ut,qt.prototype.reduce=zt,qt.prototype.mulTo=Xt,qt.prototype.sqrTo=Wt,tt.prototype.copyTo=pt,tt.prototype.fromInt=dt,tt.prototype.fromString=mt,tt.prototype.clamp=gt,tt.prototype.dlShiftTo=Tt,tt.prototype.drShiftTo=Nt,tt.prototype.lShiftTo=Ct,tt.prototype.rShiftTo=kt,tt.prototype.subTo=Lt,tt.prototype.multiplyTo=At,tt.prototype.squareTo=Ot,tt.prototype.divRemTo=Mt,tt.prototype.invDigit=It,tt.prototype.isEven=Vt,tt.prototype.exp=$t,tt.prototype.toString=yt,tt.prototype.negate=bt,tt.prototype.abs=wt,tt.prototype.compareTo=Et,tt.prototype.bitLength=xt,tt.prototype.mod=_t,tt.prototype.modPowInt=Jt,tt.ZERO=vt(0),tt.ONE=vt(1),qn.prototype.convert=Rn,qn.prototype.revert=Rn,qn.prototype.mulTo=Un,qn.prototype.sqrTo=zn,$n.prototype.convert=Jn,$n.prototype.revert=Kn,$n.prototype.reduce=Qn,$n.prototype.mulTo=Yn,$n.prototype.sqrTo=Gn;var rr=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563
,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],ir=(1<<26)/rr[rr.length-1];tt.prototype.chunkSize=Zt,tt.prototype.toRadix=tn,tt.prototype.fromRadix=nn,tt.prototype.fromNumber=rn,tt.prototype.bitwiseTo=fn,tt.prototype.changeBit=Cn,tt.prototype.addTo=On,tt.prototype.dMultiply=Fn,tt.prototype.dAddOffset=In,tt.prototype.multiplyLowerTo=Xn,tt.prototype.multiplyUpperTo=Vn,tt.prototype.modInt=tr,tt.prototype.millerRabin=or,tt.prototype.clone=Kt,tt.prototype.intValue=Qt,tt.prototype.byteValue=Gt,tt.prototype.shortValue=Yt,tt.prototype.signum=en,tt.prototype.toByteArray=sn,tt.prototype.equals=on,tt.prototype.min=un,tt.prototype.max=an,tt.prototype.and=cn,tt.prototype.or=pn,tt.prototype.xor=vn,tt.prototype.andNot=gn,tt.prototype.not=yn,tt.prototype.shiftLeft=bn,tt.prototype.shiftRight=wn,tt.prototype.getLowestSetBit=Sn,tt.prototype.bitCount=Tn,tt.prototype.testBit=Nn,tt.prototype.setBit=kn,tt.prototype.clearBit=Ln,tt.prototype.flipBit=An,tt.prototype.add=Mn,tt.prototype.subtract=_n,tt.prototype.multiply=Dn,tt.prototype.divide=Hn,tt.prototype.remainder=Bn,tt.prototype.divideAndRemainder=jn,tt.prototype.modPow=Zn,tt.prototype.modInverse=nr,tt.prototype.pow=Wn,tt.prototype.gcd=er,tt.prototype.isProbablePrime=sr,tt.prototype.square=Pn,ur.prototype.init=ar,ur.prototype.next=fr;var cr=256,hr,pr,dr;if(pr==null){pr=new Array,dr=0;var gr;if(navigator.appName=="Netscape"&&navigator.appVersion<"5"&&e.crypto){var yr=e.crypto.random(32);for(gr=0;gr<yr.length;++gr)pr[dr++]=yr.charCodeAt(gr)&255}while(dr<cr)gr=Math.floor(65536*Math.random()),pr[dr++]=gr>>>8,pr[dr++]=gr&255;dr=0,mr()}Er.prototype.nextBytes=wr;var Sr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",xr="=";Or.prototype.doPublic=_r,Or.prototype.setPublic=Mr,Or.prototype.encrypt=Dr,Or.prototype.doPrivate=jr,Or.prototype.setPrivate=Hr,Or.prototype.setPrivateEx=Br,Or.prototype.decrypt=Fr;var Ir=function(){qr.v(G)},qr={},Rr="6a384c1259bdb5e731ec96b3174683f48a2c56a85e52e7a5bb20b58711ce50c1a294bd5e1d1752e766085e9ae94bae6d217c25dbb5fcdb86a8a9a7e180fa066723d00fcb85fcf7c9d29f8cc8859f53244a49c0bc30dcc45156daf8843ce1d24fe8ebc9a3c186bb26e9d0714041aef160304c1db8cc5728cf4acb39d29755f319",Ur="10001",zr="61a921483dfa8f24e26204ace4d990b965d11e5bef5d8a5e768ebc5853a6bdd94b02369a3165207460fb91001d3fd83fbe69c6e51b8e40c8ae8a4e30a7c539dca98b44858bdc0b76f25af6803d4d13dacd9fa1a28f66cf561fa36309d4239a2cf50fe20ef0e99e01fc8701090f0685a524f411e00ca91f877d3b49d2d0052f9",Wr="b881f568eb43e7a60c256a8a90e08b7c7638fd66ce3cded9005c72e283ca4f2b8601e2edc687d7f898348a05723b515d9edeb626af7b499a56ddaea93b0c2047",Xr="9360ab3d6b678727748ea004e85120f1823ec94e6116dc5fcd7b1c9ea231d38e5d7d2d23c00607912e1645835756b71290c6c3cc2bc656e93d9a4f6b0d55619f",Vr="3e61c2259d15b26693c8bac2eac4e0a44e1c6aa0adae2af2578aea54e796293a5fee9759293c98aab65b5d27063e43fe514e9f6b68fd581f54ab52f868bc6ad5",$r="4dac2913d9c35a6be4f63647dfd8c23006a0e89fb273c5f987e656931490861b0612aef3a48489006ef5b5f51ed6c8edb3f7cdc191609af59a4df5854a25b1a9",Jr="acd9837a1472711ff2b63ba0de667fa4a4a56a8b0f4cbb0a555f73d1bc529e9ecf865b709fd8235c3db05bcf1539de1e594d3a8275fe0784a9f5241d8895b328";qr.cross=function(e){if(e){var t="";for(var n=0;n<e.length;)n+1<e.length?(t+=e[n+1],t+=e[n]):t+=e[n],n+=2;return t}return null},qr.reverse=function(e){if(e){var t="";for(var n=e.length;n>0;n--)t+=e[n-1];return t}return null},qr.v=function(e){if(e){var t=qr;t.start=null,t.beginDate=null,t.end=null,t.endDate=null,t.gis=null,t["3D"]=null,t["3d"]=null,t.l=null,t.__li__=null;if(e.indexOf("signature=")>0){var n=e.split("signature="),r=n[0],i=n[1],s=new Or;s.setPublic(Rr,Ur);var o=i,u=o.length,a=256,f=0,l="",c="";while(f<u)l=o.substr(f,a),c+=s.decrypt(l),f+=a;if(c===r)return t.i(e),!0}}return!1},qr.i=function(e){var n=qr;n.__li__=e;var r=e.split("\n"),i,s,o,u,a;for(i=0;i<r.length;i++)s=r[i],a=s.split("="),o=a[0],u=a[1],n[o]=u;n.start!=t&&(n.beginDate=new Date(Date.parse(n.start.replace(/-/g,"/")))),n.end!=t&&(n.endDate=new Date(Date.parse(n.end.replace(/-/g,"/"))));var f=n.gis;f!=t&&(f=parseInt(f)),f&&(n._isPermissionGIS=!0);var l=n["3D"]||n["3d"];l!=t&&(l=parseInt(l)),l&&(n._isPermission3D=!0),n.l!=t&&(n.version=n.l)};var Kr=function(e){return e.__li__!==t&&e._isPermission3D},Qr=function(e){if(!Kr(e))return!0;var t=new Date;return e.beginDate!=null&&e.beginDate.getTime()-t.getTime()>=0||e.endDate!=null&&e.endDate.getTime()-t.getTime()<=0},Gr=function(e){return e.type===2?!0:!1},Yr=function(e){return Qr(e)?!1:e._isPermissionGIS};qr.$z=function(e){var t=new Or;t.setPublic(Rr,Ur);var n=e,r=n.length,i=256,s=0,o="",u="";while(s<r)o=n.substr(s,i),u+=t.decrypt(o),s+=i;return u},qr.twm=function(e){var n=qr,r=n.$z("4cd18113d0c7046bfe51f7a3fbd41c2b7cf14dd785d6ea7cec9da17710d3acfb8ce0cb9cf10839f4bd51e88819de19cdc0db09278584396156fcb65abe0353ac49d01326b30efa0ea98a07da9f8ceeb7572fc1b37b5965ba6103ccba4913b62e36e49425c6ff21a2f008830c59cff8f29058769f858c8a9f0bab3eaea7fb8a9e"),i=this.type,s=this.markText,o=n.$z("648be38cd61c870e95ffc1ea0676af40736c1365015abc326e891a4de67b4de3d4b05da70b9aebedc83ec26ecf71eb74c72f42f6d9a4be2d507d2f67d2860b7b66e3ba1d565e15923f2db335ff922eef17c01b59818b583d5656412d6cc9d9ba70001c2c88e3efd492c6b13a07fda5f325b333138a2036f4696542ec137cc341");e[o]=n.__li__;var u=e;u._xyz=null;if(i==="3"&&!Qr(qr)&&s===t)return;e.DEBUG&&(console.log("license: "+qr.__li__),console.log("license Type : "+i),console.log("beginDate: "+qr.beginDate),console.log("endDate: "+qr.endDate),console.log("mark: "+s)),e.__liLabel==t&&(e.__liLabel=document.createElement("div")),n.startDate===t&&(n.startDate=new Date);var a=(new Date).getTime()-n.startDate.getTime(),f=i==="2"?7200:300;if(a<1e3*f)return;var l=Qr(n)&&a>1e3*f,c=s;l?c=n.$z("0dd629dbd0ce341ecdd447e35ddc3135a0b46916f7571a687f38ae665cf0ae095fee885e14329caa75112d8787508da17285b0897845d8ccae73e6a2727dd19f1ca335fe139d0e60d240f9ececc78f81c2c5667f51aeed4135b9c4bb436b8acb7cd418eeeb404bc4f3bcdedb481ac0edff7644435ce2b9f2bda78c892bd56d73"):i!="2"||c!==t&&c!=""?i=="1"&&!s&&(c=r):c=n.$z("644d54bf9c59afbd8a742a9e7e2731f23f149ccb7f04c3547548c50ac2d77faea108b55f1f6261e99869f1c06b84e8abdefdf45b5170048531421f3d528123972ba2f03d70f37c33f1341dc12f986e0089e42bab517e2a05b455d12d90991bbba9bc45c715a81943062ea5fa5408c8b1b9270d260cc5a67b38ecc4178ce512fc");if(c===t)return;var h=u.__liLabel;h.innerHTML=c,h.type=i,h.mark=s,h.expired=l,u._xyz=h,l&&(u.getView().style.opacity=.1)},P.validateLicense(G),n.Material=function(e){n.PropertyChangeDispatcher.call(this),this.id=n.MaterialIdCount++,this.type="basic",this.shaderID="",this.uniforms=t,this.vertexShader="",this.fragmentShader="",this.alarmColor=null,this.name="",this.side=n.FrontSide,this.fog=!0,this.normalType=t,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=n.NoColors,this.blendMode=n.NormalBlending,this.blendSrc=n.SrcAlphaFactor,this.blendDst=n.OneMinusSrcAlphaFactor,this.blendEquation=n.AddEquation,this.depthTest=!0,this.depthMask=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.transparent=!1,this.opacity=1,this.visible=!0,this.needsUpdate=!0,this.setValues(e),this.useCount=0,this.styleMap={},this.offset=new s(0,0),this.repeat=new s(1,1),this.gradient={},this.gradientType=1,this.gradientCenter=new s(.5,.5),this.outline=0},n.extend(n.Material,n.PropertyChangeDispatcher,{generateKey:function(){},setMap:function(e,t){t==null&&(t="map");if(this[t]===e)return;var n=this[t];this[t]=e,this.firePropertyChange(t,n,e),this.onMapChanged(n,e)},handleTextureChange:function(e){if(e.property==="image"){var t=this;this.firePropertyChange("needsUpdate",!1,!0)}else e.property==="disposed"},onPropertyChange:function(e,t,n){},onMapChanged:function(e,t){},setColor:function(e){if(this.color===e)return;var t=this.color.clone();e instanceof n.Color?this.color.copy(e):this.color.set(e),this.firePropertyChange("color",t,e)},setPropertyValue:function(e,t){if(this[e]===t)return;var r=this[e];if(r instanceof n.Color)t!=null&&(r=r.clone(),t instanceof n.Color?this[e].copy(t):this[e].set(t));else if(e=="gradient"){var i={};for(var s in t)t[s]instanceof n.Color?i[s]=t[s]:i[s]=new n.Color(t[s]);this[e]=i}else this[e]=t;this._uniqueCode=null,this.firePropertyChange(e,r,t)},isTextureStyle:function(e){return this._type==="terrain"?e.startsWith("texture1.")||e.startsWith("texture2.")||e.startsWith("textureb.")||e.startsWith("texturen.")||e.startsWith("texturebp."):e.startsWith("texture.")||e.startsWith("lightmap")||e.startsWith("envmap")||e.startsWith("normalmap")||e.startsWith("specularmap")},setNeedsUpdate:function(e){},getShaderID:function(){return this instanceof n.BasicMaterial&&(this.shaderID="basic"),this.shaderID},setupMaterialShader:function(){var e=this.getShaderID(),t=n.ShaderLib[e];this.uniforms=n.UniformsUtils.clone(t.uniforms),this.vertexShader=t.vertexShader,this.fragmentShader=t.fragmentShader},refreshUniforms:function(e,t){this.refreshUniformsCommon(e,t),this.refreshUniformsSpecific(e,t)},loadGleyePosition:function(e,t,r){if(this instanceof n.ShaderMaterial||this instanceof n.PhongMaterial||this.envMap||this._type==="phong")if(e.gleyePosition!=null){var i=t.worldMatrix.getPosition();r.uniform3f(e.gleyePosition,i.x,i.y,i.z)}},loadViewMatrix:function(e,t,n){(this.type==="lambert"||this.type==="phong"||material.skinning)&&e.viewMatrix!==null&&n.uniformMatrix4fv(p_uniforms.viewMatrix,!1,t.worldMatrixInverse.elements)},refreshUniformsSpecific:function(e){},refreshUniformsCommon:function(e){var r=this.uniforms,i=this;r.opacity.value=i.opacity;var s=P.getObjectCount(this.gradient)>0;e?r.diffuse.value.copyGammaToLinear(this.alarmColor?this.alarmColor:this.color):r.diffuse.value=this.alarmColor?this.alarmColor:this.color;if(s){var o=[],u=[];for(var a in this.gradient)o.push(a);o.sort();for(var f=0;f<o.length;f++)u.push(this.gradient[o[f]]);r.gradientColor.value=u,r.gradientStop.value=o,r.gradientType.value=this.gradientType}r.map.value=i.map,r.lightMap.value=i.lightMap,r.specularMap.value=i.specularMap,i.bumpMap&&(r.bumpMap.value=i.bumpMap,r.bumpScale.value=i.bumpScale),i.normalMap&&i._type==="phong"&&(r.normalMap.value=i.normalMap,r.normalScale.value.copy(i.normalScale));var l;i.map?l=i.map:i.specularMap?l=i.specularMap:i.normalMap&&i._type==="phong"?l=i.normalMap:i.bumpMap&&i._type==="phong"&&(l=i.bumpMap);if(l!=t){var c=this.offset,h=this.repeat;r.offsetRepeat.value.set(c.x,c.y,h.x,h.y),r.flipX.value=l.flipX?1:0,r.mapLoaded.value=1,l._image&&!l._image.loaded&&r.offsetRepeat.value.set(0,0,1,1)}r.envMap.value=i.envMap,r.flipEnvMap.value=1,e?r.reflectivity.value=i.reflectRatio*i.reflectRatio:r.reflectivity.value=i.reflectRatio,r.refractionRatio.value=i.refractionRatio,r.combine.value=i.combine,r.useRefract.value=i.envMap&&i.envMap.mapping instanceof n.CubeRefractionMapping},loadGeneralUniforms:function(){},getNormalType:function(){var e=this&&this.normalType!==t&&this.normalType===n.NormalTypeSmooth;return e?n.SmoothShading:n.FlatShading},isVertexColor:function(){return this.vertexColors?this.vertexColors:!1},needUV:function(){return this.map||this.lightMap||this.bumpMap||this.normalMap||this.specularMap?!0:!0},setValues:function(e){if(e===t)return;for(var r in e){var i=e[r];if(i===t){console.warn("TGL.Material: '"+r+"' parameter is undefined.");continue}if(r in this){var s=this[r];s instanceof n.Color&&i instanceof n.Color?s.copy(i):s instanceof n.Color?s.set(i):s instanceof n.XiangliangThree&&i instanceof n.XiangliangThree?s.copy(i):this[r]=i}}},isCustomAttributesNeedUpdate:function(){if(!this.attributes)return!1;for(var e in this.attributes)if(this.attributes[e].needsUpdate)return!0;return!1},clearCustomAttributes:function(){if(this.attributes)for(var e in this.attributes)this.attributes[e].needsUpdate=!1},clone:function(e){return e===t&&(e=new n.Material),e.name=this.name,e.side=this.side,e.blendMode=this.blendMode,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.depthTest=this.depthTest,e.depthMask=this.depthMask,e.polygonOffset=this.polygonOffset,e.polygonOffsetFactor=this.polygonOffsetFactor,e.polygonOffsetUnits=this.polygonOffsetUnits,e.alphaTest=this.alphaTest,e.transparent=this.transparent,e.opacity=this.opacity,e.visible=this.visible,e.normalType=this.normalType,e.wireframe=this.wireframe,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.wireframeLinewidth=this.wireframeLinewidth,e.gradient=this.gradient,e.gradientType=this.gradientType,e.outline=this.outline,e},dispose:function(){this.firePropertyChange("disposed",!1,!0)}}),n.MaterialIdCount=0,n.EntityMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.map=null,this.ambient=new n.Color(16777215),this.emissive=new n.Color(0),this.specular=new n.Color(1118481),this.specularStrength=1,this.shininess=30,this.wrapAround=!1,this.wrapRGB=new n.XiangliangThree(1,1,1),this.lightMap=null,this.specularMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new n.XiangliangTwo(1,1),this.envMap=null,this.combine=n.MultiplyOperation,this.reflectRatio=1,this.refractionRatio=.98,this.fog=!0,this.shading=n.SmoothShading,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.metal=!1,this.perPixel=!0,this.map1=null,this.map2=null,this.blendMap=null,this.detailMap=null,this.specularMap=null,this.blendRange=new s(0,1),this.setValues(e)},n.extend(n.EntityMaterial,n.Material,{getShaderID:function(){return this.getType()},getUniqueCode:function(){if(this._uniqueCode!=null)return this._uniqueCode;var e=this._type+" "+this.color.r+this.color.g+this.color.b+" "+this.ambient.getUniqueCode()+" "+this.emissive.getUniqueCode()+this.specular.getUniqueCode()+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth+" "+this.polygonOffset+" "+this.polygonOffsetFactor+" "+this.polygonOffsetUnits+" "+this.overdraw+" "+this.shininess+" "+this.metal+" "+this.specularStrength;this.alphaTest&&(e+=this.alphaTest),e+=" "+this.normalType+" ",e+=this.repeat.x+" "+this.repeat.y+this.offset.x+" "+this.offset.y,e+=" "+this.blendRange.x+" "+this.blendRange.y,e+=" "+this.normalScale.x+" "+this.normalScale.y,e+=" "+this.reflectRatio,this.map&&(e+=this.map.getUniqueCode()),this.map1&&(e+=this.map1.getUniqueCode()),this.map2&&(e+=this.map2.getUniqueCode()),this.blendMap&&(e+=this.blendMap.getUniqueCode()),this.normalMap&&(e+=this.normalMap.getUniqueCode()),this.lightMap&&(e+=this.lightMap.getUniqueCode()),this.envMap&&(e+=this.envMap.getUniqueCode()),this.specularMap&&(e+=this.specularMap.getUniqueCode()),this.alarmColor&&(e+=" "+this.alarmColor.getUniqueCode());if(this.gradient)for(var t in this.gradient)e+=" "+t+":"+this.gradient[t].getUniqueCode();return e+=" "+this.gradientType,e+=" "+this.outline,e+=this.combine,this._uniqueCode=e,e},loadViewMatrix:function(e,t,n){(this._type==="lambert"||this._type==="phong"||material.skinning)&&e.viewMatrix!==null&&n.uniformMatrix4fv(p_uniforms.viewMatrix,!1,t.worldMatrixInverse.elements)},onMapChanged:function(e,t){n.TexturePool.useTexture(t),n.TexturePool.unUseTexture(e);if(t){var r=t.getUniqueCode();n.TexturePool.getTexture(r)==null&&n.TexturePool.setTexture(r,t)}},setType:function(e){if(this._type===e)return;var t=this._type;this._type=e,this.firePropertyChange("type",t,e),this.onTypeChanged(t,e)},onTypeChanged:function(){},getType:function(){return this._type},setStyle:function(e,t){if(e==null)return;this.styleMap==null&&(this.styleMap={});var r=this.styleMap[e];return t==null?delete this.styleMap[e]:this.styleMap[e]=t,this.firePropertyChange(n.Styles.PREFIX_STYLE+e,r,t),this.onStyleChanged(e,r,t),this},getStyle:function(e,t){t==null&&(t=!0);var r;return this.styleMap!=null&&(r=this.styleMap[e]),r==null&&t&&(r=n.Styles.getStyle(e)),r},clone:function(e){return e=e||new n.EntityMaterial,n.Material.prototype.clone.call(this,e),e._type=this._type,e.color.copy(this.color),e.setMap(this.map,"map"),e.setMap(this.map1,"map1"),e.setMap(this.map2,"map2"),e.setMap(this.blendMap,"blendMap"),e.setMap(this.normalMap,"normalMap"),e.setMap(this.specularMap,"specularMap"),e.setMap(this.envMap,"envMap"),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.metal=this.metal,e.perPixel=this.perPixel,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.setMap(this.lightMap,"lightMap"),e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalScale.copy(this.normalScale),e.combine=this.combine,e.reflectRatio=this.reflectRatio,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e.specularStrength=this.specularStrength,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.blendRange.copy(this.blendRange),e},refreshUniformsSpecific:function(e){var t=this.uniforms;this._type==="lambert"?(e?(t.ambient.value.copyGammaToLinear(this.ambient),t.emissive.value.copyGammaToLinear(this.emissive)):(t.ambient.value=this.ambient,t.emissive.value=this.emissive),this.wrapAround&&t.wrapRGB.value.copy(this.wrapRGB)):this._type==="phong"&&(t.shininess.value=this.shininess,e?(t.ambient.value.copyGammaToLinear(this.alarmColor?this.alarmColor:this.ambient),t.emissive.value.copyGammaToLinear(this.emissive),t.specular.value.copyGammaToLinear(this.specular)):(t.ambient.value=this.alarmColor?this.alarmColor:this.ambient,t.emissive.value=this.emissive,t.specular.value=this.specular),t.uspecularStrength.value=this.specularStrength,this.wrapAround&&t.wrapRGB.value.copy(this.wrapRGB))},refreshUniformsCommon:function(e){if(this._type==="terrain"){var t=this.uniforms;t.enableDiffuse1.value=this.map?1:0,t.tDiffuse1.value=this.map,t.enableDiffuse2.value=this.map1?1:0,t.tDiffuse2.value=this.map1,t.enableDiffuse3.value=this.map2?1:0,t.tDiffuse3.value=this.map2,t.enableDisplacement.value=this.blendMap?1:0,t.tDisplacement.value=this.blendMap,t.uRepeatOverlay.value=this.repeat,this.blendRangeArray==null&&(this.blendRangeArray=[0,1]),this.blendRangeArray[0]=this.blendRange.x,this.blendRangeArray[1]=this.blendRange.y,t.blendRange.value=this.blendRangeArray}else if(this._type==="outline"){var t=this.uniforms;t.diffuse.value=this.color,t.outline_offset.value=this.outline}else n.Material.prototype.refreshUniformsCommon.call(this,e)}}),n.BlurMaterial=function(){n.Material.call(this),this.orientation=0,this.blurAmount=5,this.blurScale=1,this.blurStrength=1,this.useBlur=1,this.texelSize=new s(512,512),this.blurGlobalAlpha=1},n.extend(n.BlurMaterial,n.Material,{refreshUniformsCommon:function(e){var t=this.uniforms;t.map.value=this.map,t.orientation.value=this.orientation,t.blurAmount.value=this.blurAmount,t.blurScale.value=this.blurScale,t.blurStrength.value=this.blurStrength,t.useBlur.value=this.useBlur,t.texelSize.value=this.texelSize,t.blurGlobalAlpha.value=this.blurGlobalAlpha},getShaderID:function(){return"blur"}}),n.DeferredMaterial=function(e){e=e||{},n.Material.call(this,e),this.linearDepth=30,this.isNormal=e.isNormal!==t?e.isNormal:0},n.extend(n.DeferredMaterial,n.Material,{getShaderID:function(){return"deferred"},refreshUniformsCommon:function(e){var t=this.uniforms;t.linearDepth.value=this.linearDepth,t.isNormal.value=this.isNormal}}),n.SSAOMaterial=function(e){n.Material.call(this),this.map1=null,this.map2=null,this.occluderBias=.05,this.samplingRadius=20,this.attenuation=new s(1,.02),this.texelSize=new s(1/512,1/512)},n.extend(n.SSAOMaterial,n.Material,{getShaderID:function(){return"ssao"},refreshUniformsCommon:function(e){var t=this.uniforms;t.map0.value=this.map,t.map1.value=this.map1,t.map2.value=this.map2,t.occluderBias.value=this.occluderBias,t.samplingRadius.value=this.samplingRadius,t.attenuation.value=this.attenuation,t.texelSize.value=this.texelSize}}),n.BasicMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.map=null,this.setValues(e),this.offset=new s(0,0),this.repeat=new s(1,1)},n.extend(n.BasicMaterial,n.Material,{getShaderID:function(){return"basic"},clone:function(){var e=new n.BasicMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e},getUniqueCode:function(){var e=this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return e+=this.repeat.x+" "+this.repeat.y+this.offset.x+" "+this.offset.y,this.map&&(e+=this.map.getUniqueCode()),e}}),n.LambertMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.ambient=new n.Color(16777215),this.emissive=new n.Color(0),this.wrapAround=!1,this.wrapRGB=new n.XiangliangThree(1,1,1),this.map=null,this.lightMap=null,this.specularMap=null,this.envMap=null,this.combine=n.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=n.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=n.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},n.extend(n.LambertMaterial,n.Material,{clone:function(){var e=new n.LambertMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.lightMap=this.lightMap,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},getShaderID:function(){return"lambert"},refreshUniformsSpecific:function(e){var t=this.uniforms;e?(t.ambient.value.copyGammaToLinear(this.ambient),t.emissive.value.copyGammaToLinear(this.emissive)):(t.ambient.value=this.ambient,t.emissive.value=this.emissive),this.wrapAround&&t.wrapRGB.value.copy(this.wrapRGB)}}),n.PhongMaterial=function(e){n.Material.call(this),this._type="basic",this.color=new n.Color(16777215),this.ambient=new n.Color(16777215),this.emissive=new n.Color(0),this.specular=new n.Color(1118481),this.shininess=30,this.metal=!1,this.perPixel=!0,this.wrapAround=!1,this.wrapRGB=new n.XiangliangThree(1,1,1),this.map=null,this.lightMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new n.XiangliangTwo(1,1),this.specularMap=null,this.envMap=null,this.combine=n.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=n.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=n.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e),this.offset=new s(0,0),this.repeat=new s(1,1)},n.extend(n.PhongMaterial,n.Material,{getUniqueCode:function(){var e="phong "+this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return e+=this.repeat.x+" "+this.repeat.y+this.offset.x+" "+this.offset.y,this.map&&(e+=this.map.getUniqueCode()),e},clone:function(){var e=new n.PhongMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.metal=this.metal,e.perPixel=this.perPixel,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.lightMap=this.lightMap,e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.normalMap=this.normalMap,e.normalScale.copy(this.normalScale),e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},getShaderID:function(){return"phong"},refreshUniformsSpecific:function(e){var t=this.uniforms;t.shininess.value=this.shininess,e?(t.ambient.value.copyGammaToLinear(this.ambient),t.emissive.value.copyGammaToLinear(this.emissive),t.specular.value.copyGammaToLinear(this.specular)):(t.ambient.value=this.ambient,t.emissive.value=this.emissive,t.specular.value=this.specular),this.wrapAround&&t.wrapRGB.value.copy(material.wrapRGB)}}),n.LineMaterial=function(e){n.Material.call(this),this.color=new n.Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.dashed=!0,this.scale=1,this.dashSize=3,this.gapSize=1,this.vertexColors=!1,this.fog=!0,this.setValues(e)},n.extend(n.LineMaterial,n.Material,{clone:function(){var e=new n.LineMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.linewidth=this.linewidth,e.linecap=this.linecap,e.linejoin=this.linejoin,e.dashed=this.dashed,e.scale=this.scale,e.dashSize=this.dashSize,matetial.gapSize=this.gapSize,e.vertexColors=this.vertexColors,e.fog=this.fog,e},getShaderID:function(){return this.dashed?"dashed":"basic"},refreshUniforms:function(e){Zr(this.uniforms,this),this.dashed&&ei(this.uniforms,this)}}),n.ArrayMaterial=function(e){this.materials=e||[]},n.extend(n.ArrayMaterial,Object,{clone:function(){var e=new n.ArrayMaterial;for(var t=0;t<this.materials.length;t++){var r=this.materials[t],i=this.materials.indexOf(r);e.materials[i]!=null?e.materials.push(e.materials[i]):e.materials.push(r.clone())}return e}}),n.BillboardMaterial=function(e){n.Material.call(this),this.alignment=n.BillboardAlignment.center.clone(),this.fog=!1,this.color=new n.Color(16777215),this.map=null,this.rotation=0,this.fog=!1,this.offset=new n.XiangliangTwo(0,0),this.repeat=new n.XiangliangTwo(1,1),this.transparent=!0,this.setValues(e),this.depthMask=!0,this.vertical=!1,this.alphaTest=.5},n.extend(n.BillboardMaterial,n.Material,{clone:function(e){return e=e?e:new n.BillboardMaterial,n.Material.prototype.clone.call(this,e),e.alignment.copy(this.alignment),e.color.copy(this.color),e.map=this.map,e.rotation=this.rotation,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.fog=this.fog,e.vertical=this.vertical,e.transparent=this.transparent,e.alphaTest=this.alphaTest,e},getUniqueCode:function(){var e="Billboard "+this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return e+=this.vertical+" "+this.alphaTest+" "+this.alignment.x+" "+this.alignment.y,e+=this.repeat.x+" "+this.repeat.y,e+=this.offset.x+" "+this.offset.y,this.map&&(e+=this.map.getUniqueCode()),e}}),n.BillboardAlignment={},n.BillboardAlignment.topLeft=new n.XiangliangTwo(.5,-0.5),n.BillboardAlignment.topCenter=new n.XiangliangTwo(0,-0.5),n.BillboardAlignment.topRight=new n.XiangliangTwo(-0.5,-0.5),n.BillboardAlignment.centerLeft=new n.XiangliangTwo(.5,0),n.BillboardAlignment.center=new n.XiangliangTwo(0,0),n.BillboardAlignment.centerRight=new n.XiangliangTwo(-0.5,0),n.BillboardAlignment.bottomLeft=new n.XiangliangTwo(.5,.5),n.BillboardAlignment.bottomCenter=new n.XiangliangTwo(0,.5),n.BillboardAlignment.bottomRight=new n.XiangliangTwo(-0.5,.5);var ti=function(e){n.Material.call(this),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms={},this.defines={},this.attributes=null,this.shaderID=e.shaderID||"depth",this._type="shader",this.shading=n.SmoothShading,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.vertexColors=n.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName="position",this.setValues(e)};n.ShaderMaterial=ti,n.extend(n.ShaderMaterial,n.Material,{clone:function(){var e=new n.ShaderMaterial;return n.Material.prototype.clone.call(this,e),e.fragmentShader=this.fragmentShader,e.vertexShader=this.vertexShader,e.uniforms=n.UniformsUtils.clone(this.uniforms),e.attributes=this.attributes,e.defines=this.defines,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.fog=this.fog,e.lights=this.lights,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},needUV:function(){return!0},getShaderID:function(){return null},refreshUniformsCommon:function(e,t){}}),n.TransformGizmoMaterial=function(e){n.BasicMaterial.call(this),this.depthTest=!1,this.depthMask=!1,this.side=n.DoubleSide,this.transparent=!0,this.setValues(e)},n.extend(n.TransformGizmoMaterial,n.BasicMaterial,{getUniqueCode:function(){var e=this.id+"TransformGizmo "+this.color.r+this.color.g+this.color.b+" "+this.transparent+" "+this.visible+" "+this.opacity+" "+this.depthTest+""+this.depthMask+" "+this.side+" "+this.wireframe+" "+this.wireframeLinewidth;return this.map&&(e+=this.map.getUniqueCode()),e}});var ni={pools:{},useTimes:{},size:0,getMaterial:function(e){return ni.pools[e]},setMaterial:function(e,t){ni.size++,ni.pools[e]=t},useMaterial:function(e){if(e){var t=e.id,n=ni.useTimes[t]||0;n++,ni.useTimes[t]=n}},unUseMaterial:function(e){if(e){var t=e.id,n=ni.useTimes[t]||0;n--,ni.useTimes[t]=n;if(n<=0){var r=e.getUniqueCode();delete ni.pools[r],ni.size--,e.dispose()}}}};n.MaterialPool=ni,ni.DefaultMaterial=new n.EntityMaterial,ni.TestMaterial=new n.EntityMaterial,ni.DefaultBillBoardMaterial=new n.BillboardMaterial,ni.DefaultLineMaterial=new n.LineMaterial;var ri={pools:{},useTimes:{},size:0,getMaterial:function(e){return ni.pools[e]},setMaterial:function(e,t){ri.size++,ri.pools[e]=t},useMaterial:function(e){if(e){var t=e.id,n=ri.useTimes[t]||0;n++,ri.useTimes[t]=n}},unUseMaterial:function(e){if(e){var t=e.id,n=ri.useTimes[t]||0;n--,ri.useTimes[t]=n;if(n<=0){var r=e.getUniqueCode();delete ri.pools[r],ri.size--,e.dispose()}}}};n.ParticleMaterial=function(e){n.Material.call(this),this.color=new n.Color(16777215),this.map=null,this.size=2,this.sizeAttenuation=!1,this.vertexColors=!1,this.fog=!0,this.setValues(e)},n.extend(n.ParticleMaterial,n.Material,{clone:function(){var e=new n.ParticleMaterial;return n.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.size=this.size,e.sizeAttenuation=this.sizeAttenuation,e.vertexColors=this.vertexColors,e.fog=this.fog,e},getShaderID:function(){return this.shaderID="particle_basic",this.shaderID},refreshUniforms:function(e){ii(this.uniforms,this)}}),n.Light=function(e,t){n.Element.call(this,t),this.color=new n.Color(e),this.ambient=new n.Color,this.diffuse=new n.Color,this.specular=new n.Color,this.castShadow=!1,this.onlyShadow=!1},n.extend(n.Light,n.Element,{__accessor:["color","ambient","diffuse","specular"],constructor:n.Light,className:"TGL.Light",setCastShadow:function(e){this.castShadow=e},setOnlyShadow:function(e){this.onlyShadow=e},refreshShadowUniforms:function(e,t){var r=this;if(e.shadowMatrix&&r.castShadow)if(r instanceof n.SpotLight||r instanceof n.DirectionalLight&&!r.shadowCascade)return e.shadowMap.value[t]=r.shadowMap,e.shadowMapSize.value[t]=r.shadowMapSize,e.shadowMatrix.value[t]=r.shadowMatrix,e.shadowDarkness.value[t]=r.shadowDarkness,e.shadowBias.value[t]=r.shadowBias,!0},refreshUniformsPointShadow:function(e,t){var r=this;if(e.pShadowMap&&r.castShadow&&r instanceof n.PointLight)return e.pShadowMap.value[t]=r.shadowMap,e.pShadowMapSize.value[t]=r.shadowMapSize,e.pShadowDarkness.value[t]=r.shadowDarkness||.5,e.pPosition.value[t]=r.getPosition(),!0}}),n.PositionLight=function(){},n.PointLight=function(e,r,i,s){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var o=arguments[0];e=o.hex,r=o.intensity,i=o.intensity,s=o.id}n.Light.call(this,e,s),this.position=new n.XiangliangThree(0,0,0),this.intensity=r!==t?r:1,this.distance=i!==t?i:0,this.shadowGleyeNear=10,this.shadowGleyeFar=1e4,this.shadowMapWidth=512,this.shadowMapHeight=512},n.extend(n.PointLight,n.Light,{constructor:n.PointLight,className:"TGL.PointLight",__accessor:["intensity","distance"]}),n.SpotLight=function(e,r,i,s,o){n.Light.call(this,e),this._position=new n.XiangliangThree
(0,1,0),this.target=new n.Element,this.intensity=r!==t?r:1,this.distance=i!==t?i:0,this.angle=s!==t?s:Math.PI/2,this.exponent=o!==t?o:10,this.shadowGleyeNear=100,this.shadowGleyeFar=5e3,this.shadowGleyeFov=50,this.shadowGleyeVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowMap=null,this.shadowMapSize=null,this.shadowGleye=null,this.shadowMatrix=null},n.extend(n.SpotLight,n.Light,{__accessor:["color","ambient","diffuse","specular","intensity","distance","angle","exponent"],constructor:n.SpotLight,className:"TGL.SpotLight"}),n.DirectionalLight=function(e,r,i){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var s=arguments[0];e=s.hex,r=s.intensity,i=s.id}n.Light.call(this,e,i),this.direction=new n.XiangliangThree(0,1,0),this.position=new n.XiangliangThree(0,1,0),this.target=new n.Element,this.intensity=r!==t?r:1,this.shadowGleyeNear=50,this.shadowGleyeFar=5e3,this.shadowGleyeLeft=-500,this.shadowGleyeRight=500,this.shadowGleyeTop=500,this.shadowGleyeBottom=-500,this.shadowGleyeVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new n.XiangliangThree(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.shadowMap=null,this.shadowMapSize=null,this.shadowGleye=null,this.shadowMatrix=null},n.extend(n.DirectionalLight,n.Light,{className:"TGL.DirectionalLight"}),n.AmbientLight=function(e,t){if(arguments.length===1&&arguments[0]instanceof Object&&!Array.isArray(arguments[0])){var r=arguments[0];e=r.hex,t=r.id}n.Light.call(this,e,t)},n.extend(n.AmbientLight,n.Light,{constructor:n.AmbientLight,className:"TGL.AmbientLight",clone:function(){var e=new n.AmbientLight;return n.Light.prototype.clone.call(this,e),e}}),n.Gleye=function(){n.Element.call(this),this.projectionMatrix=new n.Mat4,this.projectionMatrixInverse=new n.Mat4,this.worldMatrixInverse=new n.Mat4,this.target=new n.XiangliangThree,this.setPosition(0,0,500)},n.extend(n.Gleye,n.Element,{constructor:n.Gleye,updateGleyeMatrix:function(e){var t=this.matrix.clone();this.matrix.lookAt(this._position,this.target,this.up),this.rotationAutoUpdate&&this._rotation.setEulerFromRotationMatrix(this.matrix),!t.equals(this.matrix)&&e&&this.firePropertyChange("matrix",t,this.matrix)},lookAt:function(e,n){n===t&&(n=!0),this.target=e,this.updateGleyeMatrix(n)},look:function(e){this.lookAt(e,!0)},onUpChanged:function(e,t){this.updateGleyeMatrix()},getTarget:function(){return this.target},t:function(){return this.getTarget()},getDistance:function(){return(new o).subVectors(this._position,this.target).length()},lookAtElement:function(e,t,r){t instanceof o?(r=t,t=this.getDistance()):r=r||new o(0,0,1),e instanceof n.Element&&(t=t?t:this.getDistance(),this.setPosition(e.worldPosition(r,t)),this.look(e.getWorldPosition()))}}),n.OrthoGleye=function(e,t,r,i){n.Gleye.call(this),this.width=e||1,this.aspect=t||1,this.near=r||.1,this.far=i||1e4,this.updateProjectionMatrix()},n.extend(n.OrthoGleye,n.Gleye,{constructor:n.OrthoGleye,className:"TGL.OrthoGleye",__accessor:["width","aspect","near","far"],updateProjectionMatrix:function(){var e=this.getDistance(),t=e*this.width/2,n=-t,r=e/this.aspect*this.width/2,i=-r;this.projectionMatrix.makeOrthographic(n,t,r,i,this.near,this.far)},onPropertyChange:function(){this.updateProjectionMatrix()},updateGleyeMatrix:function(e){n.Gleye.prototype.updateGleyeMatrix.call(this,e),this.updateProjectionMatrix()}}),n.PerspectiveGleye=function(e,r,i,s){n.Gleye.call(this),this.fov=e!==t?e:50,this.aspect=r!==t?r:1,this.near=i!==t?i:1,this.far=s!==t?s:5e4,this.updateProjectionMatrix()},n.extend(n.PerspectiveGleye,n.Gleye,{constructor:n.PerspectiveGleye,className:"TGL.PerspectiveGleye",__accessor:["fov","aspect","near","far"],updateProjectionMatrix:function(){this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},onPropertyChange:function(){this.updateProjectionMatrix()}}),n.GleyeHelper=function(e){function c(e,t,n){h(e,n),h(t,n)}function h(e,i){r.vertices.push(new n.XiangliangThree),r.colors.push(new n.Color(i)),s[e]===t&&(s[e]=[]),s[e].push(r.vertices.length-1)}var r=new n.Entity,i=new n.LineMaterial({color:16777215,vertexColors:n.FaceColors}),s={},o=16755200,u=16711680,a=43775,f=16777215,l=3355443;c("n1","n2",o),c("n2","n4",o),c("n4","n3",o),c("n3","n1",o),c("f1","f2",o),c("f2","f4",o),c("f4","f3",o),c("f3","f1",o),c("n1","f1",o),c("n2","f2",o),c("n3","f3",o),c("n4","f4",o),c("p","n1",u),c("p","n2",u),c("p","n3",u),c("p","n4",u),c("u1","u2",a),c("u2","u3",a),c("u3","u1",a),c("c","t",f),c("p","c",l),c("cn1","cn2",l),c("cn3","cn4",l),c("cf1","cf2",l),c("cf3","cf4",l),n.Line.call(this,r.vertices,r.colors,i,n.LinePieces),this.gleye=e,this.worldMatrix=e.worldMatrix,this.matrixAutoUpdate=!1,this.pointMap=s,this.update()},n.GleyeHelper.prototype=Object.create(n.Line.prototype),n.GleyeHelper.prototype.update=function(){var e=new n.XiangliangThree,r=new n.Gleye,i=new n.Projector;return function(){function u(s,o,u,a){e.set(o,u,a),i.unprojectVector(e,r);var f=n.pointMap[s];if(f!==t)for(var l=0,c=f.length;l<c;l++)n.vertices[f[l]].copy(e)}var n=this,s=1,o=1;r.projectionMatrix.copy(this.gleye.projectionMatrix),u("c",0,0,-1),u("t",0,0,1),u("n1",-s,-o,-1),u("n2",s,-o,-1),u("n3",-s,o,-1),u("n4",s,o,-1),u("f1",-s,-o,1),u("f2",s,-o,1),u("f3",-s,o,1),u("f4",s,o,1),u("u1",s*.7,o*1.1,-1),u("u2",-s*.7,o*1.1,-1),u("u3",0,o*2,-1),u("cf1",-s,0,1),u("cf2",s,0,1),u("cf3",0,-o,1),u("cf4",0,o,1),u("cn1",-s,0,-1),u("cn2",s,0,-1),u("cn3",0,-o,-1),u("cn4",0,o,-1),this.verticesNeedUpdate=!0}}();var si=function(){n.Element.call(this)};si.prototype=Object.create(n.Element.prototype),si.prototype.updateworldMatrix=function(e){this.matrixAutoUpdate&&this.updateMatrix();if(this.worldMatrixNeedsUpdate||e)this._parent?(this.worldMatrix.multiplyMatrices(this._parent.worldMatrix,this.matrix),this.worldMatrix.decompose(this.translationWorld,this.QuatWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.QuatObject,this.scaleObject),this.worldMatrix.compose(this.translationWorld,this.QuatObject,this.scaleWorld)):this.worldMatrix.copy(this.matrix),this.worldMatrixNeedsUpdate=!1,e=!0;for(var t=0,n=this.getChildren().size();t<n;t++)this.getChildren().get(t).updateworldMatrix(e)},si.prototype.translationWorld=new n.XiangliangThree,si.prototype.translationObject=new n.XiangliangThree,si.prototype.QuatWorld=new n.Quat,si.prototype.QuatObject=new n.Quat,si.prototype.scaleWorld=new n.XiangliangThree,si.prototype.scaleObject=new n.XiangliangThree;var oi=function(){function v(e,t){var r=new n.DirectionalLight;r.isVirtual=!0,r.onlyShadow=!0,r.castShadow=!0,r.shadowGleyeNear=e.shadowGleyeNear,r.shadowGleyeFar=e.shadowGleyeFar,r.shadowGleyeLeft=e.shadowGleyeLeft,r.shadowGleyeRight=e.shadowGleyeRight,r.shadowGleyeBottom=e.shadowGleyeBottom,r.shadowGleyeTop=e.shadowGleyeTop,r.shadowGleyeVisible=e.shadowGleyeVisible,r.shadowDarkness=e.shadowDarkness,r.shadowBias=e.shadowCascadeBias[t],r.shadowMapWidth=e.shadowCascadeWidth[t],r.shadowMapHeight=e.shadowCascadeHeight[t],r.pointsWorld=[],r.pointsFrustum=[];var i=r.pointsWorld,s=r.pointsFrustum;for(var o=0;o<8;o++)i[o]=new n.XiangliangThree,s[o]=new n.XiangliangThree;var u=e.shadowCascadeNearZ[t],a=e.shadowCascadeFarZ[t];return s[0].set(-1,-1,u),s[1].set(1,-1,u),s[2].set(-1,1,u),s[3].set(1,1,u),s[4].set(-1,-1,a),s[5].set(1,-1,a),s[6].set(-1,1,a),s[7].set(1,1,a),r}function m(e,t){var n=e.shadowCascadeArray[t];n.position.copy(e.position),n.target.position.copy(e.target.position),n.lookAt(n.target),n.shadowGleyeVisible=e.shadowGleyeVisible,n.shadowDarkness=e.shadowDarkness,n.shadowBias=e.shadowCascadeBias[t];var r=e.shadowCascadeNearZ[t],i=e.shadowCascadeFarZ[t],s=n.pointsFrustum;s[0].z=r,s[1].z=r,s[2].z=r,s[3].z=r,s[4].z=i,s[5].z=i,s[6].z=i,s[7].z=i}function g(e,t){var n=t.shadowGleye,r=t.pointsFrustum,i=t.pointsWorld;h.set(Infinity,Infinity,Infinity),p.set(-Infinity,-Infinity,-Infinity);for(var s=0;s<8;s++){var o=i[s];o.copy(r[s]),oi.__projector.unprojectVector(o,e),o.applyMatrix4(n.worldMatrixInverse),o.x<h.x&&(h.x=o.x),o.x>p.x&&(p.x=o.x),o.y<h.y&&(h.y=o.y),o.y>p.y&&(p.y=o.y),o.z<h.z&&(h.z=o.z),o.z>p.z&&(p.z=o.z)}n.left=h.x,n.right=p.x,n.top=p.y,n.bottom=h.y,n.updateProjectionMatrix()}function y(e){return e.material instanceof n.ArrayMaterial?e.material.materials[0]:e.material}var e,r,i,u,a,f,l=new n.Frustum,c=new n.Mat4,h=new n.XiangliangThree,p=new n.XiangliangThree,d=new n.XiangliangThree;this.init=function(t){e=t._gl,r=t;var s=n.ShaderLib.depthRGBA,o=n.UniformsUtils.clone(s.uniforms);i=new ti({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o}),_depthCubeMaterial=new ti({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o,refreshUniformsCommon:function(e){this.uniforms.isCube.value=1}}),u=new ti({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o,morphTargets:!0}),a=new ti({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o,skinning:!0}),f=new ti({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o,morphTargets:!0,skinning:!0}),i._shadowPass=!0,u._shadowPass=!0,a._shadowPass=!0,f._shadowPass=!0},this.render=function(e,t){if(!r._shadowMapEnable)return;this.update(e,t)},this.update=function(h,p){var b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P=[],H=0,B=null;e.clearColor(1,1,1,1),e.disable(e.BLEND),e.enable(e.CULL_FACE),e.frontFace(e.CCW),r.shadowMapCullFace===n.CullFaceFront?e.cullFace(e.FRONT):e.cullFace(e.BACK),r.setDepthTest(!0);var j=h.getLights();for(b=0,w=j.size();b<w;b++){_=j.get(b);if(!_.castShadow)continue;if(_ instanceof n.DirectionalLight&&_.shadowCascade)for(x=0;x<_.shadowCascadeCount;x++){var F;if(!_.shadowCascadeArray[x]){F=v(_,x),F.originalGleye=p;var I=new si;I.position=_.shadowCascadeOffset,I.add(F),I.add(F.target),p.add(I),_.shadowCascadeArray[x]=F}else F=_.shadowCascadeArray[x];m(_,x),P[H]=F,H++}else P[H]=_,H++}for(b=0,w=P.length;b<w;b++){_=P[b];if(!_.shadowMap){var q=n.LinearFilter;r.shadowMapType===n.PCFSoftShadowMap&&(q=n.NearestFilter);var R={minFilter:q,magFilter:q,format:n.RGBAFormat};_ instanceof n.PointLight?(_.shadowMap=new J(_.shadowMapWidth,_.shadowMapHeight,R),_.shadowMapSize=new s(_.shadowMapWidth,_.shadowMapHeight),_.shadowMatrix=new n.Mat4):(_.shadowMap=new $(_.shadowMapWidth,_.shadowMapHeight,R),_.shadowMapSize=new s(_.shadowMapWidth,_.shadowMapHeight),_.shadowMatrix=new n.Mat4)}if(!_.shadowGleye){if(_ instanceof n.SpotLight)_.shadowGleye=new n.PerspectiveGleye(_.shadowGleyeFov,_.shadowMapWidth/_.shadowMapHeight,_.shadowGleyeNear,_.shadowGleyeFar);else if(_ instanceof n.DirectionalLight)_.shadowGleye=new n.OrthoGleye(_.shadowGleyeLeft,_.shadowGleyeRight,_.shadowGleyeTop,_.shadowGleyeBottom,_.shadowGleyeNear,_.shadowGleyeFar);else{if(!(_ instanceof n.PointLight)){console.error("Unsupported light type for shadow");continue}_.shadowGleye=new n.PerspectiveGleye(90,1,_.shadowGleyeNear,_.shadowGleyeFar)}_.shadowGleye.updateWorldMatrix();var U=h.getRoots(),z=U.size(),W;for(var X=0;X<z;X++)W=U.get(X),W.updateWorldMatrix()}_.shadowGleyeVisible&&!_.gleyeHelper&&(_.gleyeHelper=new n.GleyeHelper(_.shadowGleye),_.shadowGleye.addChild(_.gleyeHelper),_.shadowGleye.updateWorldMatrix(!0),r.helperBox.add(_.shadowGleye),r.helperBox.add(_.gleyeHelper)),_.isVirtual&&F.originalGleye==p&&g(p,_);var V=_ instanceof n.PointLight?6:1,K=[new o(1,0,0),new o(-1,0,0),new o(0,1,0),new o(0,-1,0),new o(0,0,1),new o(0,0,-1)];for(var H=0;H<V;H++){if(_.debugFace!=null&&H!=_.debugFace)continue;T=_.shadowMap,N=_.shadowMatrix,C=_.shadowGleye,C._position.setFromMatrixPosition(_.worldMatrix),_.target?d.setFromMatrixPosition(_.target.worldMatrix):d=C._position.clone().add(K[H]),C.lookAt(d),C.updateWorldMatrix(!0),C.worldMatrixInverse.getInverse(C.worldMatrix),_.gleyeHelper&&(_.gleyeHelper.visible=_.shadowGleyeVisible),_.shadowGleyeVisible&&_.gleyeHelper.update(),N.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),N.multiply(C.projectionMatrix),N.multiply(C.worldMatrixInverse),c.multiplyMatrices(C.projectionMatrix,C.worldMatrixInverse),l.setFromMatrix(c),T.activeCubeFace=H,r.debugPointLight==t&&r.setRenderTarget(T),r.clear(),D=r.glNodeList;for(E=0,S=D.length;E<S;E++)O=D[E],M=O.node,O.render=!1,M._visible&&M.castShadow&&(!(M instanceof n.Node||M instanceof n.Particle)||!M.frustumCulled||l.intersectsObject(M))&&(M._modelViewMatrix.multiplyMatrices(C.worldMatrixInverse,M.worldMatrix),O.render=!0);var Q,G,Y;for(E=0,S=D.length;E<S;E++)O=D[E],O.render&&(M=O.node,L=O.group,Q=y(M),G=!1,Y=!1,M.customDepthMaterial?A=M.customDepthMaterial:Y?A=G?f:a:G?A=u:V==1?A=i:A=_depthCubeMaterial,M instanceof n.BufferNode||r.renderGroup(C,h.getLights(),A,L,M))}}var Z=r.getClearColor(),et=r.getClearAlpha();e.clearColor(Z.r,Z.g,Z.b,et),e.enable(e.BLEND),r.shadowMapCullFace===n.CullFaceFront&&e.cullFace(e.BACK)}};oi.__projector=new n.Projector,n.Picking=function(e,t,r,i,s,o){this.gl3dview=o,this.origin=e,this.gleyeUp=r,this.direction=t,this.near=i||0,this.far=s||Infinity,this.ray=new n.Ray(e,t),this.ray.direction.length>0&&this.ray.direction.normalize()},n.Picking.testPlane=new n.Plane(1,1),n.Picking.prototype={constructor:n.Picking,precision:1e-4,linePrecision:2,matrixPosition:new n.XiangliangThree,set:function(e,t){this.origin=e,this.direction=t,this.ray.set(e,t),this.ray.direction.length>0&&this.ray.direction.normalize()},intersectObject:function(e,t,n){var r=[];return t===!0&&di(e,this,r,n),pi(e,this,r,n),r.sort(hi),r},intersectObjects:function(e,t,n){e._as&&(e=e._as);var r=[];for(var i=0,s=e.length;i<s;i++)pi(e[i],this,r,n,this.gl3dview),t===!0&&di(e[i],this,r,n,this.gl3dview);return r.sort(hi),r}};var ui=new n.Ray,ai=new n.Mat4,fi=new n.math.Plane,li=new n.XiangliangThree,ci=new n.BoundingSphere,mi=function(e){arguments.length>0&&this.init(e)};mi.prototype.init=function(e){this.status=e,this.points=new Array},mi.prototype.appendPoint=function(e){this.points.push(e)},mi.prototype.appendPoints=function(e){this.points=this.points.concat(e)},mi.intersectShapes=function(e,t){var n=e.getIntersectionParams(),r=t.getIntersectionParams(),i;if(n!=null&&r!=null)if(n.name=="Path")i=mi.intersectPathShape(e,t);else if(r.name=="Path")i=mi.intersectPathShape(t,e);else{var s,o;n.name<r.name?(s="intersect"+n.name+r.name,o=n.params.concat(r.params)):(s="intersect"+r.name+n.name,o=r.params.concat(n.params));if(!(s in mi))throw new Error("Intersection not available: "+s);i=mi[s].apply(null,o)}else i=new mi("No Intersection");return i},mi.intersectPathShape=function(e,t){return e.intersectShape(t)},mi.intersectBezier2Bezier2=function(e,t,n,r,i,o){var u,a,f,l,c,h,p,d,v=new mi("No Intersection"),m;u=t.multiply(-2),f=e.add(u.add(n)),u=e.multiply(-2),a=t.multiply(2),l=u.add(a),c=new s(e.x,e.y),u=i.multiply(-2),h=r.add(u.add(o)),u=r.multiply(-2),a=i.multiply(2),p=u.add(a),d=new s(r.x,r.y);if(f.y==0){var g=f.x*(c.y-d.y),y=g-l.x*l.y,b=g+y,w=l.y*l.y;m=new Polynomial(f.x*h.y*h.y,2*f.x*p.y*h.y,f.x*p.y*p.y-h.x*w-h.y*g-h.y*y,-p.x*w-p.y*g-p.y*y,(c.x-d.x)*w+(c.y-d.y)*y)}else{var g=f.x*h.y-f.y*h.x,y=f.x*p.y-p.x*f.y,b=l.x*f.y-l.y*f.x,w=c.y-d.y,E=f.y*(c.x-d.x)-f.x*w,S=-l.y*b+f.y*E,x=b*b;m=new Polynomial(g*g,2*g*y,(-h.y*x+f.y*y*y+f.y*g*E+g*S)/f.y,(-p.y*x+f.y*y*E+y*S)/f.y,(w*x+E*S)/f.y)}var T=m.getRoots();for(var N=0;N<T.length;N++){var C=T[N];if(0<=C&&C<=1){var k=(new Polynomial(f.x,l.x,c.x-d.x-C*p.x-C*C*h.x)).getRoots(),L=(new Polynomial(f.y,l.y,c.y-d.y-C*p.y-C*C*h.y)).getRoots();if(k.length>0&&L.length>0){var A=1e-4;e:for(var O=0;O<k.length;O++){var M=k[O];if(0<=M&&M<=1)for(var _=0;_<L.length;_++)if(Math.abs(M-L[_])<A){v.points.push(h.multiply(C*C).add(p.multiply(C).add(d)));break e}}}}}return v.points.length>0&&(v.status="$Intersection"),v},mi.intersectBezier2Bezier3=function(e,t,n,r,i,o,u){var a,f,l,c,h,p,d,v,m,g,y,b=new mi("No Intersection");a=t.multiply(-2),h=e.add(a.add(n)),a=e.multiply(-2),f=t.multiply(2),p=a.add(f),d=new s(e.x,e.y),a=r.multiply(-1),f=i.multiply(3),l=o.multiply(-3),c=a.add(f.add(l.add(u))),v=new Vector2D(c.x,c.y),a=r.multiply(3),f=i.multiply(-6),l=o.multiply(3),c=a.add(f.add(l)),m=new Vector2D(c.x,c.y),a=r.multiply(-3),f=i.multiply(3),l=a.add(f),g=new Vector2D(l.x,l.y),y=new Vector2D(r.x,r.y);var w=d.x*d.x,E=d.y*d.y,S=p.x*p.x,x=p.y*p.y,T=h.x*h.x,N=h.y*h.y,C=y.x*y.x,k=y.y*y.y,L=g.x*g.x,A=g.y*g.y,O=m.x*m.x,M=m.y*m.y,_=v.x*v.x,D=v.y*v.y,P=new Polynomial(-2*h.x*h.y*v.x*v.y+T*D+N*_,-2*h.x*h.y*m.x*v.y-2*h.x*h.y*m.y*v.x+2*N*m.x*v.x+2*T*m.y*v.y,-2*h.x*g.x*h.y*v.y-2*h.x*h.y*g.y*v.x-2*h.x*h.y*m.x*m.y+2*g.x*N*v.x+N*O+T*(2*g.y*v.y+M),2*d.x*h.x*h.y*v.y+2*d.y*h.x*h.y*v.x+p.x*p.y*h.x*v.y+p.x*p.y*h.y*v.x-2*y.x*h.x*h.y*v.y-2*h.x*y.y*h.y*v.x-2*h.x*g.x*h.y*m.y-2*h.x*h.y*g.y*m.x-2*d.x*N*v.x-2*d.y*T*v.y+2*y.x*N*v.x+2*g.x*N*m.x-x*h.x*v.x-S*h.y*v.y+T*(2*y.y*v.y+2*g.y*m.y),2*d.x*h.x*h.y*m.y+2*d.y*h.x*h.y*m.x+p.x*p.y*h.x*m.y+p.x*p.y*h.y*m.x-2*y.x*h.x*h.y*m.y-2*h.x*y.y*h.y*m.x-2*h.x*g.x*h.y*g.y-2*d.x*N*m.x-2*d.y*T*m.y+2*y.x*N*m.x-x*h.x*m.x-S*h.y*m.y+L*N+T*(2*y.y*m.y+A),2*d.x*h.x*h.y*g.y+2*d.y*h.x*g.x*h.y+p.x*p.y*h.x*g.y+p.x*p.y*g.x*h.y-2*y.x*h.x*h.y*g.y-2*h.x*y.y*g.x*h.y-2*d.x*g.x*N-2*d.y*T*g.y+2*y.x*g.x*N-x*h.x*g.x-S*h.y*g.y+2*T*y.y*g.y,-2*d.x*d.y*h.x*h.y-d.x*p.x*p.y*h.y-d.y*p.x*p.y*h.x+2*d.x*h.x*y.y*h.y+2*d.y*y.x*h.x*h.y+p.x*y.x*p.y*h.y+p.x*p.y*h.x*y.y-2*y.x*h.x*y.y*h.y-2*d.x*y.x*N+d.x*x*h.x+d.y*S*h.y-2*d.y*T*y.y-y.x*x*h.x-S*y.y*h.y+w*N+E*T+C*N+T*k),H=P.getRootsInInterval(0,1);for(var B=0;B<H.length;B++){var j=H[B],F=(new Polynomial(h.x,p.x,d.x-y.x-j*g.x-j*j*m.x-j*j*j*v.x)).getRoots(),I=(new Polynomial(h.y,p.y,d.y-y.y-j*g.y-j*j*m.y-j*j*j*v.y)).getRoots();if(F.length>0&&I.length>0){var q=1e-4;e:for(var R=0;R<F.length;R++){var U=F[R];if(0<=U&&U<=1)for(var z=0;z<I.length;z++)if(Math.abs(U-I[z])<q){b.points.push(v.multiply(j*j*j).add(m.multiply(j*j).add(g.multiply(j).add(y))));break e}}}}return b.points.length>0&&(b.status="Intersection"),b},mi.intersectBezier2Circle=function(e,t,n,r,i){return mi.intersectBezier2Ellipse(e,t,n,r,i,i)},mi.intersectBezier2Ellipse=function(e,t,n,r,i,o){var u,a,f,l,c,h=new mi("No Intersection");u=t.multiply(-2),f=e.add(u.add(n)),u=e.multiply(-2),a=t.multiply(2),l=u.add(a),c=new s(e.x,e.y);var p=i*i,d=o*o,v=(new Polynomial(d*f.x*f.x+p*f.y*f.y,2*(d*f.x*l.x+p*f.y*l.y),d*(2*f.x*c.x+l.x*l.x)+p*(2*f.y*c.y+l.y*l.y)-2*(d*r.x*f.x+p*r.y*f.y),2*(d*l.x*(c.x-r.x)+p*l.y*(c.y-r.y)),d*(c.x*c.x+r.x*r.x)+p*(c.y*c.y+r.y*r.y)-2*(d*r.x*c.x+p*r.y*c.y)-p*d)).getRoots();for(var m=0;m<v.length;m++){var g=v[m];0<=g&&g<=1&&h.points.push(f.multiply(g*g).add(l.multiply(g).add(c)))}return h.points.length>0&&(h.status="Intersection"),h},mi.intersectBezier2Line=function(e,t,n,r,i){var o,u,a,f,l,c,h,p=r.min(i),d=r.max(i),v=new mi("No Intersection");o=t.multiply(-2),a=e.add(o.add(n)),o=e.multiply(-2),u=t.multiply(2),f=o.add(u),l=new s(e.x,e.y),h=new Vector2D(r.y-i.y,i.x-r.x),c=r.x*i.y-i.x*r.y,roots=(new Polynomial(h.dot(a),h.dot(f),h.dot(l)+c)).getRoots();for(var m=0;m<roots.length;m++){var g=roots[m];if(0<=g&&g<=1){var y=e.lerp(t,g),b=t.lerp(n,g),w=y.lerp(b,g);r.x==i.x?p.y<=w.y&&w.y<=d.y&&(v.status="Intersection",v.appendPoint(w)):r.y==i.y?p.x<=w.x&&w.x<=d.x&&(v.status="Intersection",v.appendPoint(w)):w.gte(p)&&w.lte(d)&&(v.status="Intersection",v.appendPoint(w))}}return v},mi.intersectBezier2Polygon=function(e,t,n,r){var i=new mi("No Intersection"),s=r.length;for(var o=0;o<s;o++){var u=r[o],a=r[(o+1)%s],f=mi.intersectBezier2Line(e,t,n,u,a);i.appendPoints(f.points)}return i.points.length>0&&(i.status="Intersection"),i},mi.intersectBezier2Rectangle=function(e,t,n,r,i){var o=r.min(i),u=r.max(i),a=new s(u.x,o.y),f=new s(o.x,u.y),l=mi.intersectBezier2Line(e,t,n,o,a),c=mi.intersectBezier2Line(e,t,n,a,u),h=mi.intersectBezier2Line(e,t,n,u,f),p=mi.intersectBezier2Line(e,t,n,f,o),d=new mi("No Intersection");return d.appendPoints(l.points),d.appendPoints(c.points),d.appendPoints(h.points),d.appendPoints(p.points),d.points.length>0&&(d.status="Intersection"),d},mi.intersectBezier3Bezier3=function(e,t,n,r,i,s,o,u){var a,f,l,c,h,p,d,v,m,g,y,b,w=new mi("No Intersection");a=e.multiply(-1),f=t.multiply(3),l=n.multiply(-3),c=a.add(f.add(l.add(r))),h=new Vector2D(c.x,c.y),a=e.multiply(3),f=t.multiply(-6),l=n.multiply(3),c=a.add(f.add(l)),p=new Vector2D(c.x,c.y),a=e.multiply(-3),f=t.multiply(3),l=a.add(f),d=new Vector2D(l.x,l.y),v=new Vector2D(e.x,e.y),a=i.multiply(-1),f=s.multiply(3),l=o.multiply(-3),c=a.add(f.add(l.add(u))),m=new Vector2D(c.x,c.y),a=i.multiply(3),f=s.multiply(-6),l=o.multiply(3),c=a.add(f.add(l)),g=new Vector2D(c.x,c.y),a=i.multiply(-3),f=s.multiply(3),l=a.add(f),y=new Vector2D(l.x,l.y),b=new Vector2D(i.x,i.y);var E=v.x*v.x,S=v.x*v.x*v.x,x=v.y*v.y,T=v.y*v.y*v.y,N=d.x*d.x,C=d.x*d.x*d.x,k=d.y*d.y,L=d.y*d.y*d.y,A=p.x*p.x,O=p.x*p.x*p.x,M=p.y*p.y,_=p.y*p.y*p.y,D=h.x*h.x,P=h.x*h.x*h.x,H=h.y*h.y,B=h.y*h.y*h.y,j=b.x*b.x,F=b.x*b.x*b.x,I=b.y*b.y,q=b.y*b.y*b.y,R=y.x*y.x,U=y.x*y.x*y.x,z=y.y*y.y,W=g.x*g.x,X=g.x*g.x*g.x,V=g.y*g.y,$=m.x*m.x,J=m.x*m.x*m.x,K=m.y*m.y,Q=m.y*m.y*m.y,G=new Polynomial(-P*Q+B*J-3*h.x*H*$*m.y+3*D*h.y*m.x*K,-6*h.x*g.x*H*m.x*m.y+6*D*h.y*g.y*m.x*m.y+3*g.x*B*$-3*P*g.y*K-3*h.x*H*g.y*$+3*D*g.x*h.y*K,-6*y.x*h.x*H*m.x*m.y-6*h.x*g.x*H*g.y*m.x+6*D*g.x*h.y*g.y*m.y+3*y.x*B*$+3*W*B*m.x+3*y.x*D*h.y*K-3*h.x*y.y*H*$-3*h.x*W*H*m.y+D*h.y*m.x*(6*y.y*m.y+3*V)+P*(-y.y*K-2*V*m.y-m.y*(2*y.y*m.y+V)),d.x*p.y*h.x*h.y*m.x*m.y-d.y*p.x*h.x*h.y*m.x*m.y+6*y.x*g.x*B*m.x+3*d.x*p.x*h.x*h.y*K+6*v.x*h.x*H*m.x*m.y-3*d.x*p.x*H*m.x*m.y-3*d.y*p.y*h.x*h.y*$-6*v.y*D*h.y*m.x*m.y-6*b.x*h.x*H*m.x*m.y+3*d.y*p.y*D*m.x*m.y-2*p.x*M*h.x*m.x*m.y-6*y.x*h.x*g.x*H*m.y-6*y.x*h.x*H*g.y*m.x-6*h.x*y.y*g.x*H*m.x+6*y.x*D*h.y*g.y*m.y+2*A*p.y*h.y*m.x*m.y+X*B-3*v.x*B*$+3*v.y*P*K+3*b.x*B*$+_*h.x*$-O*h.y*K-3*v.x*D*h.y*K+3*v.y*h.x*H*$-2*d.x*p.y*D*K+d.x*p.y*H*$-d.y*p.x*D*K+2*d.y*p.x*H*$+3*b.x*D*h.y*K-p.x*M*h.y*$-3*b.y*h.x*H*$+A*p.y*h.x*K-3*h.x*W*H*g.y+D*h.y*m.x*(6*b.y*m.y+6*y.y*g.y)+D*g.x*h.y*(6*y.y*m.y+3*V)+P*(-2*y.y*g.y*m.y-b.y*K-g.y*(2*y.y*m.y+V)-m.y*(2*b.y*m.y+2*y.y*g.y)),6*d.x*p.x*h.x*h.y*g.y*m.y+d.x*p.y*h.x*g.x*h.y*m.y+d.x*p.y*h.x*h.y*g.y*m.x-d.y*p.x*h.x*g.x*h.y*m.y-d.y*p.x*h.x*h.y*g.y*m.x-6*d.y*p.y*h.x*g.x*h.y*m.x-6*v.x*g.x*B*m.x+6*b.x*g.x*B*m.x+6*v.y*P*g.y*m.y+2*_*h.x*g.x*m.x-2*O*h.y*g.y*m.y+6*v.x*h.x*g.x*H*m.y+6*v.x*h.x*H*g.y*m.x+6*v.y*h.x*g.x*H*m.x-3*d.x*p.x*g.x*H*m.y-3*d.x*p.x*H*g.y*m.x+2*d.x*p.y*g.x*H*m.x+4*d.y*p.x*g.x*H*m.x-6*v.x*D*h.y*g.y*m.y-6*v.y*D*g.x*h.y*m.y-6*v.y*D*h.y*g.y*m.x-4*d.x*p.y*D*g.y*m.y-6*b.x*h.x*g.x*H*m.y-6*b.x*h.x*H*g.y*m.x-2*d.y*p.x*D*g.y*m.y+3*d.y*p.y*D*g.x*m.y+3*d.y*p.y*D*g.y*m.x-2*p.x*M*h.x*g.x*m.y-2*p.x*M*h.x*g.y*m.x-2*p.x*M*g.x*h.y*m.x-6*b.y*h.x*g.x*H*m.x-6*y.x*h.x*y.y*H*m.x-6*y.x*h.x*g.x*H*g.y+6*b.x*D*h.y*g.y*m.y+2*A*p.y*h.x*g.y*m.y+2*A*p.y*g.x*h.y*m.y+2*A*p.y*h.y*g.y*m.x+3*y.x*W*B+3*R*B*m.x-3*h.x*y.y*W*H-3*R*h.x*H*m.y+D*g.x*h.y*(6*b.y*m.y+6*y.y*g.y)+D*h.y*m.x*(6*b.y*g.y+3*z)+y.x*D*h.y*(6*y.y*m.y+3*V)+P*(-2*b.y*g.y*m.y-m.y*(2*b.y*g.y+z)-y.y*(2*y.y*m.y+V)-g.y*(2*b.y*m.y+2*y.y*g.y)),d.x*y.x*p.y*h.x*h.y*m.y+d.x*p.y*h.x*y.y*h.y*m.x+d.x*p.y*h.x*g.x*h.y*g.y-d.y*p.x*y.x*h.x*h.y*m.y-d.y*p.x*h.x*y.y*h.y*m.x-d.y*p.x*h.x*g.x*h.y*g.y-6*d.y*y.x*p.y*h.x*h.y*m.x-6*v.x*y.x*B*m.x+6*b.x*y.x*B*m.x+2*y.x*_*h.x*m.x+6*v.x*y.x*h.x*H*m.y+6*v.x*h.x*y.y*H*m.x+6*v.x*h.x*g.x*H*g.y+6*v.y*y.x*h.x*H*m.x-3*d.x*p.x*y.x*H*m.y-3*d.x*p.x*y.y*H*m.x-3*d.x*p.x*g.x*H*g.y+2*d.x*y.x*p.y*H*m.x+4*d.y*p.x*y.x*H*m.x-6*v.y*y.x*D*h.y*m.y-6*v.y*D*y.y*h.y*m.x-6*v.y*D*g.x*h.y*g.y-6*b.x*y.x*h.x*H*m.y-6*b.x*h.x*y.y*H*m.x-6*b.x*h.x*g.x*H*g.y+3*d.y*y.x*p.y*D*m.y-3*d.y*p.y*h.x*W*h.y+3*d.y*p.y*D*y.y*m.x+3*d.y*p.y*D*g.x*g.y-2*p.x*y.x*M*h.x*m.y-2*p.x*y.x*M*h.y*m.x-2*p.x*M*h.x*y.y*m.x-2*p.x*M*h.x*g.x*g.y-6*b.y*y.x*h.x*H*m.x-6*y.x*h.x*y.y*g.x*H+6*b.y*D*y.y*h.y*m.x+2*A*y.x*p.y*h.y*m.y+2*A*p.y*y.y*h.y*m.x+2*A*p.y*g.x*h.y*g.y-3*v.x*W*B+3*b.x*W*B+3*R*g.x*B+_*h.x*W+3*v.y*h.x*W*H+d.x*p.y*W*H+2*d.y*p.x*W*H-p.x*M*W*h.y-3*b.y*h.x*W*H-3*R*h.x*H*g.y+A*p.y*h.x*(2*y.y*m.y+V)+d.x*p.x*h.x*h.y*(6*y.y*m.y+3*V)+y.x*D*h.y*(6*b.y*m.y+6*y.y*g.y)+O*h.y*(-2*y.y*m.y-V)+v.y*P*(6*y.y*m.y+3*V)+d.y*p.x*D*(-2*y.y*m.y-V)+d.x*p.y*D*(-4*y.y*m.y-2*V)+v.x*D*h.y*(-6*y.y*m.y-3*V)+D*g.x*h.y*(6*b.y*g.y+3*z)+b.x*D*h.y*(6*y.y*m.y+3*V)+P*(-2*b.y*y.y*m.y-g.y*(2*b.y*g.y+z)-b.y*(2*y.y*m.y+V)-y.y*(2*b.y*m.y+2*y.y*g.y)),-v.x*d.x*p.y*h.x*h.y*m.y+v.x*d.y*p.x*h.x*h.y*m.y+6*v.x*d.y*p.y*h.x*h.y*m.x-6*v.y*d.x*p.x*h.x*h.y*m.y-v.y*d.x*p.y*h.x*h.y*m.x+v.y*d.y*p.x*h.x*h.y*m.x+d.x*d.y*p.x*p.y*h.x*m.y-d.x*d.y*p.x*p.y*h.y*m.x+d.x*b.x*p.y*h.x*h.y*m.y+d.x*b.y*p.y*h.x*h.y*m.x+d.x*y.x*p.y*h.x*h.y*g.y+d.x*p.y*h.x*y.y*g.x*h.y-b.x*d.y*p.x*h.x*h.y*m.y-6*b.x*d.y*p.y*h.x*h.y*m.x-d.y*p.x*b.y*h.x*h.y*m.x-d.y*p.x*y.x*h.x*h.y*g.y-d.y*p.x*h.x*y.y*g.x*h.y-6*d.y*y.x*p.y*h.x*g.x*h.y-6*v.x*b.x*B*m.x-6*v.x*y.x*g.x*B-2*v.x*_*h.x*m.x+6*b.x*y.x*g.x*B+2*b.x*_*h.x*m.x+2*y.x*_*h.x*g.x+2*v.y*O*h.y*m.y-6*v.x*v.y*h.x*H*m.x+3*v.x*d.x*p.x*H*m.y-2*v.x*d.x*p.y*H*m.x-4*v.x*d.y*p.x*H*m.x+3*v.y*d.x*p.x*H*m.x+6*v.x*v.y*D*h.y*m.y+6*v.x*b.x*h.x*H*m.y-3*v.x*d.y*p.y*D*m.y+2*v.x*p.x*M*h.x*m.y+2*v.x*p.x*M*h.y*m.x+6*v.x*b.y*h.x*H*m.x+6*v.x*y.x*h.x*H*g.y+6*v.x*h.x*y.y*g.x*H+4*v.y*d.x*p.y*D*m.y+6*v.y*b.x*h.x*H*m.x+2*v.y*d.y*p.x*D*m.y-3*v.y*d.y*p.y*D*m.x+2*v.y*p.x*M*h.x*m.x+6*v.y*y.x*h.x*g.x*H-3*d.x*b.x*p.x*H*m.y+2*d.x*b.x*p.y*H*m.x+d.x*d.y*M*h.x*m.x-3*d.x*p.x*b.y*H*m.x-3*d.x*p.x*y.x*H*g.y-3*d.x*p.x*y.y*g.x*H+2*d.x*y.x*p.y*g.x*H+4*b.x*d.y*p.x*H*m.x+4*d.y*p.x*y.x*g.x*H-2*v.x*A*p.y*h.y*m.y-6*v.y*b.x*D*h.y*m.y-6*v.y*b.y*D*h.y*m.x-6*v.y*y.x*D*h.y*g.y-2*v.y*A*p.y*h.x*m.y-2*v.y*A*p.y*h.y*m.x-6*v.y*D*y.y*g.x*h.y-d.x*d.y*A*h.y*m.y-2*d.x*k*h.x*h.y*m.x+3*b.x*d.y*p.y*D*m.y-2*b.x*p.x*M*h.x*m.y-2*b.x*p.x*M*h.y*m.x-6*b.x*b.y*h.x*H*m.x-6*b.x*y.x*h.x*H*g.y-6*b.x*h.x*y.y*g.x*H+3*d.y*b.y*p.y*D*m.x+3*d.y*y.x*p.y*D*g.y+3*d.y*p.y*D*y.y*g.x-2*p.x*b.y*M*h.x*m.x-2*p.x*y.x*M*h.x*g.y-2*p.x*y.x*M*g.x*h.y-2*p.x*M*h.x*y.y*g.x-6*b.y*y.x*h.x*g.x*H-k*p.x*p.y*h.x*m.x+2*b.x*A*p.y*h.y*m.y+6*b.y*D*y.y*g.x*h.y+2*N*d.y*h.x*h.y*m.y+N*p.x*p.y*h.y*m.y+2*A*b.y*p.y*h.y*m.x+2*A*y.x*p.y*h.y*g.y+2*A*p.y*y.y*g.x*h.y+U*B+3*E*B*m.x-3*x*P*m.y+3*j*B*m.x+L*D*m.x-C*H*m.y-d.x*k*D*m.y+N*d.y*H*m.x-3*E*h.x*H*m.y+3*x*D*h.y*m.x-N*M*h.x*m.y+k*A*h.y*m.x-3*R*h.x*y.y*H-3*j*h.x*H*m.y+3*I*D*h.y*m.x+d.x*p.x*h.x*h.y*(6*b.y*m.y+6*y.y*g.y)+O*h.y*(-2*b.y*m.y-2*y.y*g.y)+v.y*P*(6*b.y*m.y+6*y.y*g.y)+d.y*p.x*D*(-2*b.y*m.y-2*y.y*g.y)+A*p.y*h.x*(2*b.y*m.y+2*y.y*g.y)+d.x*p.y*D*(-4*b.y*m.y-4*y.y*g.y)+v.x*D*h.y*(-6*b.y*m.y-6*y.y*g.y)+b.x*D*h.y*(6*b.y*m.y+6*y.y*g.y)+y.x*D*h.y*(6*b.y*g.y+3*z)+P*(-2*b.y*y.y*g.y-I*m.y-y.y*(2*b.y*g.y+z)-b.y*(2*b.y*m.y+2*y.y*g.y)),-v.x*d.x*p.y*h.x*h.y*g.y+v.x*d.y*p.x*h.x*h.y*g.y+6*v.x*d.y*p.y*h.x*g.x*h.y-6*v.y*d.x*p.x*h.x*h.y*g.y-v.y*d.x*p.y*h.x*g.x*h.y+v.y*d.y*p.x*h.x*g.x*h.y+d.x*d.y*p.x*p.y*h.x*g.y-d.x*d.y*p.x*p.y*g.x*h.y+d.x*b.x*p.y*h.x*h.y*g.y+d.x*b.y*p.y*h.x*g.x*h.y+d.x*y.x*p.y*h.x*y.y*h.y-b.x*d.y*p.x*h.x*h.y*g.y-6*b.x*d.y*p.y*h.x*g.x*h.y-d.y*p.x*b.y*h.x*g.x*h.y-d.y*p.x*y.x*h.x*y.y*h.y-6*v.x*b.x*g.x*B-2*v.x*_*h.x*g.x+2*b.x*_*h.x*g.x+2*v.y*O*h.y*g.y-6*v.x*v.y*h.x*g.x*H+3*v.x*d.x*p.x*H*g.y-2*v.x*d.x*p.y*g.x*H-4*v.x*d.y*p.x*g.x*H+3*v.y*d.x*p.x*g.x*H+6*v.x*v.y*D*h.y*g.y+6*v.x*b.x*h.x*H*g.y-3*v.x*d.y*p.y*D*g.y+2*v.x*p.x*M*h.x*g.y+2*v.x*p.x*M*g.x*h.y+6*v.x*b.y*h.x*g.x*H+6*v.x*y.x*h.x*y.y*H+4*v.y*d.x*p.y*D*g.y+6*v.y*b.x*h.x*g.x*H+2*v.y*d.y*p.x*D*g.y-3*v.y*d.y*p.y*D*g.x+2*v.y*p.x*M*h.x*g.x-3*d.x*b.x*p.x*H*g.y+2*d.x*b.x*p.y*g.x*H+d.x*d.y*M*h.x*g.x-3*d.x*p.x*b.y*g.x*H-3*d.x*p.x*y.x*y.y*H+4*b.x*d.y*p.x*g.x*H-2*v.x*A*p.y*h.y*g.y-6*v.y*b.x*D*h.y*g.y-6*v.y*b.y*D*g.x*h.y-6*v.y*y.x*D*y.y*h.y-2*v.y*A*p.y*h.x*g.y-2*v.y*A*p.y*g.x*h.y-d.x*d.y*A*h.y*g.y-2*d.x*k*h.x*g.x*h.y+3*b.x*d.y*p.y*D*g.y-2*b.x*p.x*M*h.x*g.y-2*b.x*p.x*M*g.x*h.y-6*b.x*b.y*h.x*g.x*H-6*b.x*y.x*h.x*y.y*H+3*d.y*b.y*p.y*D*g.x+3*d.y*y.x*p.y*D*y.y-2*p.x*b.y*M*h.x*g.x-2*p.x*y.x*M*h.x*y.y-k*p.x*p.y*h.x*g.x+2*b.x*A*p.y*h.y*g.y-3*d.y*R*p.y*h.x*h.y+6*b.y*y.x*D*y.y*h.y+2*N*d.y*h.x*h.y*g.y+N*p.x*p.y*h.y*g.y+2*A*b.y*p.y*g.x*h.y+2*A*y.x*p.y*y.y*h.y-3*v.x*R*B+3*b.x*R*B+3*E*g.x*B-3*x*P*g.y+3*j*g.x*B+R*_*h.x+L*D*g.x-C*H*g.y+3*v.y*R*h.x*H-d.x*k*D*g.y+d.x*R*p.y*H+2*d.y*p.x*R*H+N*d.y*g.x*H-p.x*R*M*h.y-3*b.y*R*h.x*H-3*E*h.x*H*g.y+3*x*D*g.x*h.y-N*M*h.x*g.y+k*A*g.x*h.y-3*j*h.x*H*g.y+3*I*D*g.x*h.y+A*p.y*h.x*(2*b.y*g.y+z)+d.x*p.x*h.x*h.y*(6*b.y*g.y+3*z)+O*h.y*(-2*b.y*g.y-z)+v.y*P*(6*b.y*g.y+3*z)+d.y*p.x*D*(-2*b.y*g.y-z)+d.x*p.y*D*(-4*b.y*g.y-2*z)+v.x*D*h.y*(-6*b.y*g.y-3*z)+b.x*D*h.y*(6*b.y*g.y+3*z)+P*(-2*b.y*z-I*g.y-b.y*(2*b.y*g.y+z)),-v.x*d.x*p.y*h.x*y.y*h.y+v.x*d.y*p.x*h.x*y.y*h.y+6*v.x*d.y*y.x*p.y*h.x*h.y-6*v.y*d.x*p.x*h.x*y.y*h.y-v.y*d.x*y.x*p.y*h.x*h.y+v.y*d.y*p.x*y.x*h.x*h.y-d.x*d.y*p.x*y.x*p.y*h.y+d.x*d.y*p.x*p.y*h.x*y.y+d.x*b.x*p.y*h.x*y.y*h.y+6*d.x*p.x*b.y*h.x*y.y*h.y+d.x*b.y*y.x*p.y*h.x*h.y-b.x*d.y*p.x*h.x*y.y*h.y-6*b.x*d.y*y.x*p.y*h.x*h.y-d.y*p.x*b.y*y.x*h.x*h.y-6*v.x*b.x*y.x*B-2*v.x*y.x*_*h.x+6*v.y*b.y*P*y.y+2*b.x*y.x*_*h.x+2*v.y*O*y.y*h.y-2*O*b.y*y.y*h.y-6*v.x*v.y*y.x*h.x*H+3*v.x*d.x*p.x*y.y*H-2*v.x*d.x*y.x*p.y*H-4*v.x*d.y*p.x*y.x*H+3*v.y*d.x*p.x*y.x*H+6*v.x*v.y*D*y.y*h.y+6*v.x*b.x*h.x*y.y*H-3*v.x*d.y*p.y*D*y.y+2*v.x*p.x*y.x*M*h.y+2*v.x*p.x*M*h.x*y.y+6*v.x*b.y*y.x*h.x*H+4*v.y*d.x*p.y*D*y.y+6*v.y*b.x*y.x*h.x*H+2*v.y*d.y*p.x*D*y.y-3*v.y*d.y*y.x*p.y*D+2*v.y*p.x*y.x*M*h.x-3*d.x*b.x*p.x*y.y*H+2*d.x*b.x*y.x*p.y*H+d.x*d.y*y.x*M*h.x-3*d.x*p.x*b.y*y.x*H+4*b.x*d.y*p.x*y.x*H-6*v.x*b.y*D*y.y*h.y-2*v.x*A*p.y*y.y*h.y-6*v.y*b.x*D*y.y*h.y-6*v.y*b.y*y.x*D*h.y-2*v.y*A*y.x*p.y*h.y-2*v.y*A*p.y*h.x*y.y-d.x*d.y*A*y.y*h.y-4*d.x*b.y*p.y*D*y.y-2*d.x*k*y.x*h.x*h.y+3*b.x*d.y*p.y*D*y.y-2*b.x*p.x*y.x*M*h.y-2*b.x*p.x*M*h.x*y.y-6*b.x*b.y*y.x*h.x*H-2*d.y*p.x*b.y*D*y.y+3*d.y*b.y*y.x*p.y*D-2*p.x*b.y*y.x*M*h.x-k*p.x*y.x*p.y*h.x+6*b.x*b.y*D*y.y*h.y+2*b.x*A*p.y*y.y*h.y+2*N*d.y*h.x*y.y*h.y+N*p.x*p.y*y.y*h.y+2*A*b.y*y.x*p.y*h.y+2*A*b.y*p.y*h.x*y.y+3*E*y.x*B-3*x*P*y.y+3*j*y.x*B+L*y.x*D-C*y.y*H-3*I*P*y.y-d.x*k*D*y.y+N*d.y*y.x*H-3*E*h.x*y.y*H+3*x*y.x*D*h.y-N*M*h.x*y.y+k*A*y.x*h.y-3*j*h.x*y.y*H+3*I*y.x*D*h.y,v.x*v.y*d.x*p.y*h.x*h.y-v.x*v.y*d.y*p.x*h.x*h.y+v.x*d.x*d.y*p.x*p.y*h.y-v.y*d.x*d.y*p.x*p.y*h.x-v.x*d.x*b.y*p.y*h.x*h.y+6*v.x*b.x*d.y*p.y*h.x*h.y+v.x*d.y*p.x*b.y*h.x*h.y-v.y*d.x*b.x*p.y*h.x*h.y-6*v.y*d.x*p.x*b.y*h.x*h.y+v.y*b.x*d.y*p.x*h.x*h.y-d.x*b.x*d.y*p.x*p.y*h.y+d.x*d.y*p.x*b.y*p.y*h.x+d.x*b.x*b.y*p.y*h.x*h.y-b.x*d.y*p.x*b.y*h.x*h.y-2*v.x*b.x*_*h.x+2*v.y*O*b.y*h.y-3*v.x*v.y*d.x*p.x*H-6*v.x*v.y*b.x*h.x*H+3*v.x*v.y*d.y*p.y*D-2*v.x*v.y*p.x*M*h.x-2*v.x*d.x*b.x*p.y*H-v.x*d.x*d.y*M*h.x+3*v.x*d.x*p.x*b.y*H-4*v.x*b.x*d.y*p.x*H+3*v.y*d.x*b.x*p.x*H+6*v.x*v.y*b.y*D*h.y+2*v.x*v.y*A*p.y*h.y+2*v.x*d.x*k*h.x*h.y+2*v.x*b.x*p.x*M*h.y+6*v.x*b.x*b.y*h.x*H-3*v.x*d.y*b.y*p.y*D+2*v.x*p.x*b.y*M*h.x+v.x*k*p.x*p.y*h.x+v.y*d.x*d.y*A*h.y+4*v.y*d.x*b.y*p.y*D-3*v.y*b.x*d.y*p.y*D+2*v.y*b.x*p.x*M*h.x+2*v.y*d.y*p.x*b.y*D+d.x*b.x*d.y*M*h.x-3*d.x*b.x*p.x*b.y*H-2*v.x*A*b.y*p.y*h.y-6*v.y*b.x*b.y*D*h.y-2*v.y*b.x*A*p.y*h.y-2*v.y*N*d.y*h.x*h.y-v.y*N*p.x*p.y*h.y-2*v.y*A*b.y*p.y*h.x-2*d.x*b.x*k*h.x*h.y-d.x*d.y*A*b.y*h.y+3*b.x*d.y*b.y*p.y*D-2*b.x*p.x*b.y*M*h.x-b.x*k*p.x*p.y*h.x+3*x*d.x*p.x*h.x*h.y+3*d.x*p.x*I*h.x*h.y+2*b.x*A*b.y*p.y*h.y-3*E*d.y*p.y*h.x*h.y+2*N*d.y*b.y*h.x*h.y+N*p.x*b.y*p.y*h.y-3*j*d.y*p.y*h.x*h.y-S*B+T*P+F*B-q*P-3*v.x*j*B-v.x*L*D+3*E*b.x*B+v.y*C*H+3*v.y*I*P+b.x*L*D+E*_*h.x-3*x*b.y*P-x*O*h.y+j*_*h.x-C*b.y*H-O*I*h.y-v.x*N*d.y*H+v.y*d.x*k*D-3*v.x*x*D*h.y-v.x*k*A*h.y+v.y*N*M*h.x-d.x*k*b.y*D+3*E*v.y*h.x*H+E*d.x*p.y*H+2*E*d.y*p.x*H-2*x*d.x*p.y*D-x*d.y*p.x*D+N*b.x*d.y*H-3*v.x*I*D*h.y+3*v.y*j*h.x*H+d.x*j*p.y*H-2*d.x*I*p.y*D+b.x*k*A*h.y-d.y*p.x*I*D-E*p.x*M*h.y-3*E*b.y*h.x*H+3*x*b.x*D*h.y+x*A*p.y*h.x-N*b.y*M*h.x+2*j*d.y*p.x*H+3*b.x*I*D*h.y-j*p.x*M*h.y-3*j*b.y*h.x*H+A*I*p.y*h.x),Y=G.getRootsInInterval(0,1);for(var Z=0;Z<Y.length;Z++){var et=Y[Z],tt=(new Polynomial(h.x,p.x,d.x,v.x-b.x-et*y.x-et*et*g.x-et*et*et*m.x)).getRoots(),nt=(new Polynomial(h.y,p.y,d.y,v.y-b.y-et*y.y-et*et*g.y-et*et*et*m.y)).getRoots();if(tt.length>0&&nt.length>0){var rt=1e-4;e:for(var it=0;it<tt.length;it++){var st=tt[it];if(0<=st&&st<=1)for(var ot=0;ot<nt.length;ot++)if(Math.abs(st-nt[ot])<rt){w.points.push(m.multiply(et*et*et).add(g.multiply(et*et).add(y.multiply(et).add(b))));break e}}}}return w.points.length>0&&(w.status="Intersection"),w},mi.intersectBezier3Circle=function(e,t,n,r,i,s){return mi.intersectBezier3Ellipse(e,t,n,r,i,s,s)},mi.intersectBezier3Ellipse=function(e,t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v=new mi("No Intersection");u=e.multiply(-1),a=t.multiply(3),f=n.multiply(-3),l=u.add(a.add(f.add(r))),c=new Vector2D(l.x,l.y),u=e.multiply(3),a=t.multiply(-6),f=n.multiply(3),l=u.add(a.add(f)),h=new Vector2D(l.x,l.y),u=e.multiply(-3),a=t.multiply(3),f=u.add(a),p=new Vector2D(f.x,f.y),d=new Vector2D(e.x,e.y);var m=s*s,g=o*o,y=new Polynomial(c.x*c.x*g+c.y*c.y*m,2*(c.x*h.x*g+c.y*h.y*m),2*(c.x*p.x*g+c.y*p.y*m)+h.x*h.x*g+h.y*h.y*m,2*c.x*g*(d.x-i.x)+2*c.y*m*(d.y-i.y)+2*(h.x*p.x*g+h.y*p.y*m),2*h.x*g*(d.x-i.x)+2*h.y*m*(d.y-i.y)+p.x*p.x*g+p.y*p.y*m,2*p.x*g*
(d.x-i.x)+2*p.y*m*(d.y-i.y),d.x*d.x*g-2*d.y*i.y*m-2*d.x*i.x*g+d.y*d.y*m+i.x*i.x*g+i.y*i.y*m-m*g),b=y.getRootsInInterval(0,1);for(var w=0;w<b.length;w++){var E=b[w];v.points.push(c.multiply(E*E*E).add(h.multiply(E*E).add(p.multiply(E).add(d))))}return v.points.length>0&&(v.status="Intersection"),v},mi.intersectBezier3Line=function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m=i.min(s),g=i.max(s),y=new mi("No Intersection");o=e.multiply(-1),u=t.multiply(3),a=n.multiply(-3),f=o.add(u.add(a.add(r))),l=new Vector2D(f.x,f.y),o=e.multiply(3),u=t.multiply(-6),a=n.multiply(3),f=o.add(u.add(a)),c=new Vector2D(f.x,f.y),o=e.multiply(-3),u=t.multiply(3),a=o.add(u),h=new Vector2D(a.x,a.y),p=new Vector2D(e.x,e.y),v=new Vector2D(i.y-s.y,s.x-i.x),d=i.x*s.y-s.x*i.y,roots=(new Polynomial(v.dot(l),v.dot(c),v.dot(h),v.dot(p)+d)).getRoots();for(var b=0;b<roots.length;b++){var w=roots[b];if(0<=w&&w<=1){var E=e.lerp(t,w),S=t.lerp(n,w),x=n.lerp(r,w),T=E.lerp(S,w),N=S.lerp(x,w),C=T.lerp(N,w);i.x==s.x?m.y<=C.y&&C.y<=g.y&&(y.status="Intersection",y.appendPoint(C)):i.y==s.y?m.x<=C.x&&C.x<=g.x&&(y.status="Intersection",y.appendPoint(C)):C.gte(m)&&C.lte(g)&&(y.status="Intersection",y.appendPoint(C))}}return y},mi.intersectBezier3Polygon=function(e,t,n,r,i){var s=new mi("No Intersection"),o=i.length;for(var u=0;u<o;u++){var a=i[u],f=i[(u+1)%o],l=mi.intersectBezier3Line(e,t,n,r,a,f);s.appendPoints(l.points)}return s.points.length>0&&(s.status="Intersection"),s},mi.intersectBezier3Rectangle=function(e,t,n,r,i,o){var u=i.min(o),a=i.max(o),f=new s(a.x,u.y),l=new s(u.x,a.y),c=mi.intersectBezier3Line(e,t,n,r,u,f),h=mi.intersectBezier3Line(e,t,n,r,f,a),p=mi.intersectBezier3Line(e,t,n,r,a,l),d=mi.intersectBezier3Line(e,t,n,r,l,u),v=new mi("No Intersection");return v.appendPoints(c.points),v.appendPoints(h.points),v.appendPoints(p.points),v.appendPoints(d.points),v.points.length>0&&(v.status="Intersection"),v},mi.intersectCircleCircle=function(e,t,n,r){var i,o=t+r,u=Math.abs(t-r),a=e.distanceFrom(n);if(a>o)i=new mi("Outside");else if(a<u)i=new mi("Inside");else{i=new mi("Intersection");var f=(t*t-r*r+a*a)/(2*a),l=Math.sqrt(t*t-f*f),c=e.lerp(n,f/a),h=l/a;i.points.push(new s(c.x-h*(n.y-e.y),c.y+h*(n.x-e.x))),i.points.push(new s(c.x+h*(n.y-e.y),c.y-h*(n.x-e.x)))}return i},mi.intersectCircleEllipse=function(e,t,n,r,i){return mi.intersectEllipseEllipse(e,t,t,n,r,i)},mi.intersectCircleLine=function(e,t,n,r){var i,s=(r.x-n.x)*(r.x-n.x)+(r.y-n.y)*(r.y-n.y),o=2*((r.x-n.x)*(n.x-e.x)+(r.y-n.y)*(n.y-e.y)),u=e.x*e.x+e.y*e.y+n.x*n.x+n.y*n.y-2*(e.x*n.x+e.y*n.y)-t*t,a=o*o-4*s*u;if(a<0)i=new mi("Outside");else if(a==0)i=new mi("Tangent");else{var f=Math.sqrt(a),l=(-o+f)/(2*s),c=(-o-f)/(2*s);(l<0||l>1)&&(c<0||c>1)?l<0&&c<0||l>1&&c>1?i=new mi("Outside"):i=new mi("Inside"):(i=new mi("Intersection"),0<=l&&l<=1&&i.points.push(n.lerp(r,l)),0<=c&&c<=1&&i.points.push(n.lerp(r,c)))}return i},mi.intersectCirclePolygon=function(e,t,n){var r=new mi("No Intersection"),i=n.length,s;for(var o=0;o<i;o++){var u=n[o],a=n[(o+1)%i];s=mi.intersectCircleLine(e,t,u,a),r.appendPoints(s.points)}return r.points.length>0?r.status="Intersection":r.status=s.status,r},mi.intersectCircleRectangle=function(e,t,n,r){var i=n.min(r),o=n.max(r),u=new s(o.x,i.y),a=new s(i.x,o.y),f=mi.intersectCircleLine(e,t,i,u),l=mi.intersectCircleLine(e,t,u,o),c=mi.intersectCircleLine(e,t,o,a),h=mi.intersectCircleLine(e,t,a,i),p=new mi("No Intersection");return p.appendPoints(f.points),p.appendPoints(l.points),p.appendPoints(c.points),p.appendPoints(h.points),p.points.length>0?p.status="Intersection":p.status=f.status,p},mi.intersectEllipseEllipse=function(e,t,n,r,i,o){var u=[n*n,0,t*t,-2*n*n*e.x,-2*t*t*e.y,n*n*e.x*e.x+t*t*e.y*e.y-t*t*n*n],a=[o*o,0,i*i,-2*o*o*r.x,-2*i*i*r.y,o*o*r.x*r.x+i*i*r.y*r.y-i*i*o*o],f=mi.bezout(u,a),l=f.getRoots(),c=.001,h=(u[0]*u[0]+2*u[1]*u[1]+u[2]*u[2])*c,p=(a[0]*a[0]+2*a[1]*a[1]+a[2]*a[2])*c,d=new mi("No Intersection");for(var v=0;v<l.length;v++){var m=new Polynomial(u[0],u[3]+l[v]*u[1],u[5]+l[v]*(u[4]+l[v]*u[2])),g=m.getRoots();for(var y=0;y<g.length;y++){var b=(u[0]*g[y]+u[1]*l[v]+u[3])*g[y]+(u[2]*l[v]+u[4])*l[v]+u[5];Math.abs(b)<h&&(b=(a[0]*g[y]+a[1]*l[v]+a[3])*g[y]+(a[2]*l[v]+a[4])*l[v]+a[5],Math.abs(b)<p&&d.appendPoint(new s(g[y],l[v])))}}return d.points.length>0&&(d.status="Intersection"),d},mi.intersectEllipseLine=function(e,t,n,r,i){var s,o=new Vector2D(r.x,r.y),u=Vector2D.fromPoints(r,i),a=new Vector2D(e.x,e.y),f=o.subtract(a),l=new Vector2D(u.x/(t*t),u.y/(n*n)),c=new Vector2D(f.x/(t*t),f.y/(n*n)),h=u.dot(l),p=u.dot(c),e=f.dot(c)-1,d=p*p-h*e;if(d<0)s=new mi("Outside");else if(d>0){var v=Math.sqrt(d),m=(-p-v)/h,g=(-p+v)/h;(m<0||1<m)&&(g<0||1<g)?m<0&&g<0||m>1&&g>1?s=new mi("Outside"):s=new mi("Inside"):(s=new mi("Intersection"),0<=m&&m<=1&&s.appendPoint(r.lerp(i,m)),0<=g&&g<=1&&s.appendPoint(r.lerp(i,g)))}else{var y=-p/h;0<=y&&y<=1?(s=new mi("Intersection"),s.appendPoint(r.lerp(i,y))):s=new mi("Outside")}return s},mi.intersectEllipsePolygon=function(e,t,n,r){var i=new mi("No Intersection"),s=r.length;for(var o=0;o<s;o++){var u=r[o],a=r[(o+1)%s],f=mi.intersectEllipseLine(e,t,n,u,a);i.appendPoints(f.points)}return i.points.length>0&&(i.status="Intersection"),i},mi.intersectEllipseRectangle=function(e,t,n,r,i){var o=r.min(i),u=r.max(i),a=new s(u.x,o.y),f=new s(o.x,u.y),l=mi.intersectEllipseLine(e,t,n,o,a),c=mi.intersectEllipseLine(e,t,n,a,u),h=mi.intersectEllipseLine(e,t,n,u,f),p=mi.intersectEllipseLine(e,t,n,f,o),d=new mi("No Intersection");return d.appendPoints(l.points),d.appendPoints(c.points),d.appendPoints(h.points),d.appendPoints(p.points),d.points.length>0&&(d.status="Intersection"),d},mi.intersectLineLine=function(e,t,n,r){var i,o=(r.x-n.x)*(e.y-n.y)-(r.y-n.y)*(e.x-n.x),u=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(r.y-n.y)*(t.x-e.x)-(r.x-n.x)*(t.y-e.y);if(a!=0){var f=o/a,l=u/a;0<=f&&f<=1&&0<=l&&l<=1?(i=new mi("Intersection"),i.points.push(new s(e.x+f*(t.x-e.x),e.y+f*(t.y-e.y)))):i=new mi("No Intersection")}else o==0||u==0?i=new mi("Coincident"):i=new mi("Parallel");return i},mi.intersectLinePolygon=function(e,t,n){var r=new mi("No Intersection"),i=n.length;for(var s=0;s<i;s++){var o=n[s],u=n[(s+1)%i],a=mi.intersectLineLine(e,t,o,u);r.appendPoints(a.points)}return r.points.length>0&&(r.status="Intersection"),r},mi.intersectLineRectangle=function(e,t,n,r){var i=n.min(r),o=n.max(r),u=new s(o.x,i.y),a=new s(i.x,o.y),f=mi.intersectLineLine(i,u,e,t),l=mi.intersectLineLine(u,o,e,t),c=mi.intersectLineLine(o,a,e,t),h=mi.intersectLineLine(a,i,e,t),p=new mi("No Intersection");return p.appendPoints(f.points),p.appendPoints(l.points),p.appendPoints(c.points),p.appendPoints(h.points),p.points.length>0&&(p.status="Intersection"),p},mi.intersectPolygonPolygon=function(e,t){var n=new mi("No Intersection"),r=e.length;for(var i=0;i<r;i++){var s=e[i],o=e[(i+1)%r],u=mi.intersectLinePolygon(s,o,t);n.appendPoints(u.points)}return n.points.length>0&&(n.status="Intersection"),n},mi.intersectPolygonRectangle=function(e,t,n){var r=t.min(n),i=t.max(n),o=new s(i.x,r.y),u=new s(r.x,i.y),a=mi.intersectLinePolygon(r,o,e),f=mi.intersectLinePolygon(o,i,e),l=mi.intersectLinePolygon(i,u,e),c=mi.intersectLinePolygon(u,r,e),h=new mi("No Intersection");return h.appendPoints(a.points),h.appendPoints(f.points),h.appendPoints(l.points),h.appendPoints(c.points),h.points.length>0&&(h.status="Intersection"),h},mi.intersectRayRay=function(e,t,n,r){var i,o=(r.x-n.x)*(e.y-n.y)-(r.y-n.y)*(e.x-n.x),u=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(r.y-n.y)*(t.x-e.x)-(r.x-n.x)*(t.y-e.y);if(a!=0){var f=o/a;i=new mi("Intersection"),i.points.push(new s(e.x+f*(t.x-e.x),e.y+f*(t.y-e.y)))}else o==0||u==0?i=new mi("Coincident"):i=new mi("Parallel");return i},mi.intersectRectangleRectangle=function(e,t,n,r){var i=e.min(t),o=e.max(t),u=new s(o.x,i.y),a=new s(i.x,o.y),f=mi.intersectLineRectangle(i,u,n,r),l=mi.intersectLineRectangle(u,o,n,r),c=mi.intersectLineRectangle(o,a,n,r),h=mi.intersectLineRectangle(a,i,n,r),p=new mi("No Intersection");return p.appendPoints(f.points),p.appendPoints(l.points),p.appendPoints(c.points),p.appendPoints(h.points),p.points.length>0&&(p.status="Intersection"),p},mi.bezout=function(e,t){var n=e[0]*t[1]-t[0]*e[1],r=e[0]*t[2]-t[0]*e[2],i=e[0]*t[3]-t[0]*e[3],s=e[0]*t[4]-t[0]*e[4],o=e[0]*t[5]-t[0]*e[5],u=e[1]*t[2]-t[1]*e[2],a=e[1]*t[4]-t[1]*e[4],f=e[1]*t[5]-t[1]*e[5],l=e[2]*t[3]-t[2]*e[3],c=e[3]*t[4]-t[3]*e[4],h=e[3]*t[5]-t[3]*e[5],p=f+c,d=a-l;return new Polynomial(n*u-r*r,n*d+i*u-2*r*s,n*p+i*d-s*s-2*r*o,n*h+i*p-2*s*o,i*h-o*o)},n.Intersection=mi,n.AreaPicking=function(e,t){this.gl3dview=e,this.bounding=t,this.cache={}},n.extend(n.AreaPicking,Object,{intersectObjects:function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n];this.intersectObject(r,t)}return t},getViewPoint:function(e,t){var n=t.vertices[e].clone(),r=this.cache[t.getId()][n.x+" "+n.y+" "+n.z];return r?r:(n.applyMatrix4(t.worldMatrix),r=this.gl3dview.getViewPosition(n),r.y=r.h-r.y,r)},intersectObject:function(e,t){if(e instanceof n.Entity){this.cache[e.getId()]={};for(var r=0;r<e.vertices.length;r++){var i=e.vertices[r].clone();i.applyMatrix4(e.worldMatrix);var s=this.gl3dview.getViewPosition(i);s.y=s.h-s.y,this.cache[e.getId()][i.x+" "+i.y+" "+i.z]=s;if(s.x>this.bounding.x&&s.y>this.bounding.y&&s.x<this.bounding.x+this.bounding.w&&s.y<this.bounding.y+this.bounding.h){var o={element:e};t.push(o);return}}}}}),n.BaseInteraction=function(e){this.gl3dview=e,this.view=e.getView()||document},n.addEventListener=function(e,t,n,r){var i="_"+e+"_";if(r[i])return;var s=function(e){r[t](e)};r[i]=s,n.addEventListener(e,s,!1)},n.removeEventListener=function(e,t,n){var r="_"+e+"_",i=n[r];i&&(t.removeEventListener(e,i,!1),delete n[r])},n.extend(n.BaseInteraction,Object,{onPropertyChange:function(){},firePropertyChange:function(){},setUp:function(){},tearDown:function(){},update:function(){},addListener:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];n.addEventListener(t,"handle_"+t,this.gl3dview.getRootView(),this)}},removeListener:function(){for(var e=0;e<arguments.length;e++){var t=arguments[e];n.removeEventListener(arguments[e],this.gl3dview.getRootView(),this)}},isCtrlDown:function(e){return e.ctrlKey||e.metaKey},isFinished:function(){return!0}}),n.DefaultInteraction=function(t){n.BaseInteraction.call(this,t),this.screen={width:0,height:0,offsetLeft:0,offsetTop:0},this.radius=this.screen.width/4,this.domElement=this.gl3dview.getRootView(),this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.easing=!0,this.dynamicDampingFactor=.05,this.timeInterval=2e3,this.minDistance=0,this.maxDistance=Infinity,this.keys=[65,83,68],this.lastPosition=new n.XiangliangThree;var r=this.STATE.NONE,i=this.STATE.NONE,s=new n.XiangliangThree,u=new n.XiangliangThree,a=new n.XiangliangThree,f=new n.XiangliangTwo,l=new n.XiangliangTwo,c=0,p=0,d=new n.XiangliangTwo,v=new n.XiangliangTwo;Rr;var m=0,g,y;this.object=this.gl3dview._gleye,this.object.target||(this.object.target=new n.XiangliangThree),this.movementSpeed=1,this.lookSpeed=.005,this.keyboardEnable=!0,this.lookVertical=!0,this.autoForward=!1,this.fpsMode=!1,this.dragMode=!0,this.activeLook=!1,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0,this.mouseX=0,this.mouseY=0,this.lat=0,this.lon=0,this.phi=0,this.theta=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.freeze=!1,this.mouseDragOn=!1,this.viewHalfX=0,this.viewHalfY=0,this.lastX=0,this.lastY=0,this.touchSeq=[1,2,3],this.gl3dview.getRootView().addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.yRistrict=!0,this.yLowerLimitAngle=-Math.PI/2,this.yUpLimitAngle=Math.PI/2,this.updateIntervalTime=0;var b=null;this.handleResize=function(){this.screen.width=e.innerWidth,this.screen.height=e.innerHeight,this.screen.offsetLeft=0,this.screen.offsetTop=0,this.radius=(this.screen.width+this.screen.height)/4},this.handleResize(),this.handle_mousedown=function(e){if(h.isCtrlDown(e))return;e.preventDefault();if(this.fpsMode){this.domElement!==document&&this.domElement.focus();if(this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.lastX=e.pageX,this.lastY=e.pageY,this.mouseDragOn=!0}else r===this.STATE.NONE&&(r=e.button),r===this.STATE.ROTATE&&!this.noRotate?(u=a=this.getMouseProjectionOnBall(e.clientX,e.clientY),g=y=this.getRotateY(e.clientX,e.clientY)):this.state===this.STATE.ZOOM&&!this.noZoom?f=l=this.getMouseOnScreen(e.clientX,e.clientY):r===this.STATE.PAN&&!this.noPan&&(d=v=this.getMouseOnScreen(e.clientX,e.clientY));this.beforeUpdate(),this.addListener("mousemove","mouseup")},this.handle_mousemove=function(e){if(e.stop)return;e.preventDefault(),this.fpsMode?this.dragMode?this.mouseDragOn?(this.mouseX=(e.pageX-this.lastX)*300,this.mouseY=(e.pageY-this.lastY)*300,this.lastX=e.pageX,this.lastY=e.pageY):(this.mouseX=0,this.mouseY=0):this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY):r===this.STATE.ROTATE&&!this.noRotate?(a=this.getMouseProjectionOnBall(e.clientX,e.clientY),y=this.getRotateY(e.clientX,e.clientY)):r===this.STATE.ZOOM&&!this.noZoom?l=this.getMouseOnScreen(e.clientX,e.clientY):r===this.STATE.PAN&&!this.noPan&&(v=this.getMouseOnScreen(e.clientX,e.clientY));var t=(new Date).getTime();if(this._lt==null)this.update();else{if(t-this._lt<this.updateIntervalTime)return;this.update()}this._lt=t},this.handle_mouseup=function(e){e.preventDefault();if(this.fpsMode){if(this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.lastX=0,this.lastY=0,this.dragMode&&(this.mouseX=0,this.mouseY=0),this.mouseDragOn=!1}else r=this.STATE.NONE;this.removeListener("mousemove","mouseup"),this.update()},this.handle_touchstart=function(e){if(this.enabled===!1)return;switch(e.touches.length){case this.touchSeq[1]:r=this.STATE.TOUCH_ROTATE,u=this.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY),g=y=this.getRotateY(e.touches[0].pageX,e.touches[0].pageY),a.copy(u);break;case this.touchSeq[2]:r=this.STATE.TOUCH_ZOOM;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;p=c=Math.sqrt(t*t+n*n);break;case this.touchSeq[3]:r=this.STATE.TOUCH_PAN,d.copy(this.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY)),v.copy(d);break;default:r=this.STATE.NONE}this.update()},this.handle_touchmove=function(e){if(this.enabled===!1)return;e.preventDefault();switch(e.touches.length){case this.touchSeq[1]:a=this.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY,a),y=this.getRotateY(e.touches[0].pageX,e.touches[0].pageY);break;case this.touchSeq[2]:var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;p=Math.sqrt(t*t+n*n);break;case this.touchSeq[3]:v=this.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY,v);break;default:r=this.STATE.NONE}this.update()},this.handle_touchend=function(e){if(this.enabled===!1)return;switch(e.touches.length){case 0:u.copy(this.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY,a));break;case 1:c=p=0;break;case 2:v.copy(this.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY)),d.copy(v)}r=this.STATE.NONE,this.update()},this.handle_DOMMouseScroll=function(e){this.handle_mousewheel(e)},this.handle_mousewheel=function(e){e.preventDefault();var t=0;e.wheelDelta?e.wheelDelta%120===0?t=e.wheelDelta/40:t=e.wheelDelta:e.detail&&(t=-e.detail/3),t&&(f.y+=1/t*.01),this.mouseMoving=!0,this.update()},this.handle_dblclick=function(e){if(!this.isCtrlDown(e))return;var t=this.gl3dview.getElementsByMouseEvent(e);t.length>0&&(b=t[0]),this.update()},this.getMouseOnScreen=function(e,t){return new n.XiangliangTwo((e-this.screen.offsetLeft)/this.radius*.5,(t-this.screen.offsetTop)/this.radius*.5)},this.getRotateY=function(e,t){if(this.yRistrict){var n=(this.screen.height*.5+this.screen.offsetTop-t)/this.screen.height*2;return n}},this.handle_keydown=function(e){if(!this.keyboardEnable)return;switch(e.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze}this.update()},this.handle_keyup=function(e){if(!this.keyboardEnable)return;switch(e.keyCode){case 38:case 87:this.moveForward=!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}this.update()},this.getMouseProjectionOnBall=function(e,t){if(this.yRistrict){var r=new n.XiangliangThree((e-this.screen.width*.5-this.screen.offsetLeft)/(this.screen.width*.5),0,0),i=r.length();return i>1?r.normalize():r.z=Math.sqrt(1-i*i),r.normalize()}var r=new n.XiangliangThree((e-this.screen.width*.5-this.screen.offsetLeft)/this.radius,(this.screen.height*.5+this.screen.offsetTop-t)/this.radius,0),i=r.length();i>1?r.normalize():r.z=Math.sqrt(1-i*i),s.copy(this.object._position).sub(this.object.target);var o=this.object.up.clone().setLength(r.y);return o.add(this.object.up.clone().cross(s).setLength(r.x)),o.add(s.setLength(r.z)),o},this.rotateGleye=function(){var e=u.dot(a)/u.length()/a.length(),t=Math.acos(e),r=!this.easing||Math.abs(t)<1e-4,i=!1;if(t){var o=(new n.XiangliangThree).crossVectors(u,a).normalize(),f=new n.Quat;f.setFromAxisAngle(o,-t*this.dynamicDampingFactor*this.rotateSpeed),r?(f.setFromAxisAngle(o,-t*this.rotateSpeed),s.applyQuaternion(f),this.object.up.applyQuaternion(f),u.copy(a)):(f.setFromAxisAngle(o,-t*this.dynamicDampingFactor*this.rotateSpeed),s.applyQuaternion(f),this.object.up.applyQuaternion(f),f.setFromAxisAngle(o,t*this.dynamicDampingFactor),u.applyQuaternion(f),i=!0)}var r=!this.easing||Math.abs(y-g)<1e-4,l=(y-g)*s.length();if(!P.isNaN(l))if(r)l&&this.yRistrict&&this.limitY(l),g=y;else{var l=l*this.dynamicDampingFactor;l&&this.yRistrict&&this.limitY(l),g+=(y-g)*this.dynamicDampingFactor,i=!0}i&&this.gl3dview.dirtyGl3dview()},this.limitY=function(e){var t=s.length();Math.abs(s.x)<=.1*t&&Math.abs(s.z)<=.1*t&&(s.x=.1*t);var n=s.x,r=s.z,i=Math.sqrt(n*n+r*r),o=Math.tan(this.yLowerLimitAngle)*i,u=Math.tan(this.yUpLimitAngle)*i;s.y-=e,s.y>u?s.y=u:s.y<o&&(s.y=o)},this.getValueByTime=function(e,t){var n=(new Date).getTime(),r=n-this._timeStart;return r>this.timeInterval?t:e+(t-e)*r/this.timeInterval},this.zoomGleye=function(){if(r===this.STATE.TOUCH_ZOOM){var e=c/p;c=p,s.multiplyScalar(e)}else{var t=this.zoomSpeed;this.easing||(t*=5);var e;e=1+(l.y-f.y)*t,e!==1&&e>0&&(s.multiplyScalar(e),!this.easing||Math.abs(l.y-f.y)<.001?f.copy(l):(f.y+=(l.y-f.y)*this.dynamicDampingFactor,this.gl3dview.dirtyGl3dview()))}},this.panGleye=function(){var e=v.clone().sub(d);if(e.lengthSq()){e.multiplyScalar(s.length()*this.panSpeed);var t=s.clone().cross(this.object.up).setLength(e.x);t.add(this.object.up.clone().setLength(e.y)),this.object._position.add(t),this.object.target.add(t),d=v,this.gl3dview.dirtyGl3dview()}},this.checkAngles=function(){},this.checkDistances=function(){if(!this.noZoom||!this.noPan)s.lengthSq()>this.maxDistance*this.maxDistance&&this.object._position.addVectors(this.object.target,s.setLength(this.maxDistance)),s.lengthSq()<this.minDistance*this.minDistance&&this.object._position.addVectors(this.object.target,s.setLength(this.minDistance))},this.updateFPS=function(){var e=2;if(this.freeze)return;if(this.heightSpeed){var t=n.Math.clamp(this.object._position.y,this.heightMin,this.heightMax),r=t-this.heightMin;this.autoSpeedFactor=e*r*this.heightCoef}else this.autoSpeedFactor=0;var i=e*this.movementSpeed;if(this.moveForward||this.autoForward&&!this.moveBackward){var u=this.object._position.clone();this.object.translateZ(-(i+this.autoSpeedFactor));var a=this.object.target,f=this.object._position,l=new o,c=new o;l.subVectors(f,a),c.subVectors(u,a),l.z*c.z<=0&&this.object.target.subVectors(this.object._position,s)}this.moveBackward&&this.object.translateZ(i),this.moveLeft&&(this.object.translateX(-i),this.object.target.subVectors(this.object._position,s)),this.moveRight&&(this.object.translateX(i),this.object.target.subVectors(this.object._position,s)),this.moveUp&&(this.object.translateY(i),this.object.target.subVectors(this.object._position,s)),this.moveDown&&(this.object.translateY(-i),this.object.target.subVectors(this.object._position,s));var h=e*this.lookSpeed;!this.activeLook&&!this.dragMode&&(h=0);var p=.1;this.constrainVertical&&(p=Math.PI/(this.verticalMax-this.verticalMin)),this.lon+=this.mouseX*h,this.dragMode&&(this.mouseX=0),this.lookVertical&&(this.lat-=this.mouseY*h*p),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=n.Math.degToRad(90-this.lat),this.theta=n.Math.degToRad(this.lon),this.constrainVertical&&(this.phi=n.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax));if(this.fpsMode){var d=this.object.target,f=this.object._position;d.x=f.x+100*Math.sin(this.phi)*Math.sin(this.theta),d.y=f.y+100*Math.cos(this.phi),d.z=f.z-100*Math.sin(this.phi)*Math.cos(this.theta),this.object.look(d)}},this.update=function(){s.subVectors(this.object._position,this.object.target),!this.noRotate&&!this.fpsMode&&this.rotateGleye(),!this.noZoom&&!this.fpsMode&&this.zoomGleye(),!this.noPan&&!this.fpsMode&&this.panGleye();if(b&&b.element&&this.gl3dview.doubleClickToLookAtFunction(b.element)){this.object.target=b.point;var e=this.object._position.distanceTo(this.object.target),t=b.face.normal.clone();t=t.applyMatrix4((new n.Mat4).extractRotation(b.element.worldMatrix)),t.normalize(),s=t.multiplyScalar(e),b=null}this.object.setPosition(this.object._position.clone().addVectors(this.object.target,s)),this.updateFPS(),this.fpsMode||(this.checkDistances(),this.object.look(this.object.target)),this.lastPosition.distanceToSquared(this.object._position)>0&&this.lastPosition.copy(this.object._position)}},n.extend(n.DefaultInteraction,n.BaseInteraction,{STATE:{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},__accessor:["rotateSpeed","zoomSpeed","panSpeed","yLowerLimitAngle","yUpLimitAngle","minDistance","maxDistance","easing","touchSeq"],setUp:function(){this.addListener("mousedown","touchstart","touchend","touchmove","mousewheel","DOMMouseScroll","dblclick","keydown","keyup")},tearDown:function(){this.removeListener("mousedown","touchstart","touchend","touchmove","mousewheel","DOMMouseScroll","dblclick","keydown","keyup")},beforeUpdate:function(){},setUpdateIntervalTime:function(e){this.updateIntervalTime=e}}),n.SelectionInteraction=function(e){n.BaseInteraction.call(this,e),this.selectUnVisible=!0,this.ctrlDown=!1,this.deleteTimeoutId=null,this._areaPickingLevel=1},n.extend(n.SelectionInteraction,n.BaseInteraction,{constructor:n.SelectionInteraction,setAreaPickingLevel:function(e){this._areaPickingLevel=e},getAreaPickingLevel:function(){return this._areaPickingLevel},setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},setFocus:function(e){if(document.activeElement===e)return;var t,n,r=document.documentElement,i=document.body,s;r&&(p.isIE||p.isOpera||r.scrollLeft||r.scrollTop)&&(t=r.scrollLeft,n=r.scrollTop,s=r),e.focus(),s&&(s.scrollLeft=t,s.scrollTop=n)},handle_mousedown:function(e){if(e.stop==1)return;if(h.isRightClick(e))return;this.setFocus(this.gl3dview.getView()),this.isCtrlDown(e)?(this.addListener("mousemove","mouseup"),this.ctrlDownEvent=e):this.gl3dview.getServa().clearSelection();var t=this.gl3dview.getElementsByMouseEvent(e,!0),n=this.gl3dview.getFirstSelectElement(t);this.gl3dview.getServa().getSelectionContainer().appendSelection(n),this.gl3dview.onSelect(n)},handle_mousemove:function(e){var t=this.getBoundingByMouseEvent(e,this.ctrlDownEvent,this.gl3dview.devicePixelRatio);this.mousemoved=!0,this.gl3dview.areaPickingRect=t,this.gl3dview.paintTopCanvas()},handle_mouseup:function(e){this.gl3dview.areaPickingRect=null,this.gl3dview.paintTopCanvas();var t=this.getBoundingByMouseEvent(e,this.ctrlDownEvent);this.removeListener("mousemove","mouseup"),this.ctrlDownEvent=null;if(t&&this.mousemoved){var n=this.gl3dview.getElementsByBounding(t,!0,this._areaPickingLevel),r=new N;if(n.length>0)for(var i=0;i<n.length;i++){var s=n[i].element;this.gl3dview.selectable(n[i])&&r.add(s)}r.size()>0&&this.gl3dview.getServa().getSelectionContainer().appendSelection(r)}},getBoundingByMouseEvent:function(e,t,n){if(!e||!t)return;var r=this.gl3dview.getView().getBoundingClientRect(),i=e.clientX-r.left,s=e.clientY-r.top,o=t.clientX-r.left,u=t.clientY-r.top,a=n||1,f=Math.min(i,o)*a,l=Math.min(s,u)*a,c=Math.abs(i-o)*a,h=Math.abs(s-u)*a;return c===0&&h===0?null:{x:f,y:l,w:c,h:h}}}),n.TransformGizmo=function(){var e=new n.TransformGizmoMaterial({color:16711680}),r=new n.TransformGizmoMaterial({color:65280}),i=new n.TransformGizmoMaterial({color:255});this.handleGizmos={X:[new n.Cylinder(e,.005,.005,1,4,1,!1,!1),new o(.5,0,0),new o(0,0,-Math.PI/2)],Y:[new n.Cylinder(r,.005,.005,1,4,1,!1,!1),new o(0,.5,0)],Z:[new n.Cylinder(i,.005,.005,1,4,1,!1,!1),new o(0,0,.5),new o(Math.PI/2,0,0)]};var s=!1,u=!1;this.showHelpers=!0,this.showable=!0,this.init=function(){n.Element.call(this),this.handles=new n.Element,this.pickers=new n.Element,this.planes=new n.Element,this.addChild(this.handles),this.addChild(this.pickers),this.addChild(this.planes);var e=new n.BasicMaterial({wireframe:!1,color:65535,side:n.DoubleSide}),t=new n.Plane(e,5e4,5e4,2,2),r={XY:new n.Plane(e,5e4,5e4,2,2),YZ:new n.Plane(e,5e4,5e4,2,2),XZ:new n.Plane(e,5e4,5e4,2,2),XYZE:new n.Plane(e,5e4,5e4,2,2)};r.YZ._rotation.set(0,Math.PI/2,0),r.XZ._rotation.set(-Math.PI/2,0,0);for(var i in r)r[i].name=i,this.planes.addChild(r[i]),this.planes[i]=r[i],r[i]._visible=!0;for(var i in this.handleGizmos){var s=this.handleGizmos[i][0];s.name=i,this.handleGizmos[i][1]&&s._position.set(this.handleGizmos[i][1].x,this.handleGizmos[i][1].y,this.handleGizmos[i][1].z),this.handleGizmos[i][2]&&s._rotation.set(this.handleGizmos[i][2].x,this.handleGizmos[i][2].y,this.handleGizmos[i][2].z),s.mode=this.mode,this.handles.addChild(s);if(this.pickerGizmos&&this.pickerGizmos[i]){var o=this.pickerGizmos[i][0];this.pickerGizmos[i][1]&&o._position.set(this.pickerGizmos[i][1].x,this.pickerGizmos[i][1].y,this.pickerGizmos[i][1].z),this.pickerGizmos[i][2]&&o._rotation.set(this.pickerGizmos[i][2].x,this.pickerGizmos[i][2].y,this.pickerGizmos[i][2].z)}else var o=s.clone();o.mode=this.mode,o.name=i,this.pickers.addChild(o)}this.iterator(function(e){e instanceof n.Entity&&n.Utils.transformElement(e)})},this.hide=function(){this.handles.getChildren().forEach(function(e){e._visible=!1}),this.pickers.getChildren().forEach(function(e){e._visible=!1}),this.planes.getChildren().forEach(function(e){e._visible=!1})},this.show=function(){var e=this;this.handles.getChildren().forEach(function(t){t._visible=e.showHelpers&&e.showable}),this.pickers.getChildren().forEach(function(e){e._visible=s}),this.activePlane&&(this.activePlane._visible=u)},this.highlight=function(e){var r;for(var i in this.handleGizmos)r=this.handleGizmos[i][0],r.oldColor&&(r.material instanceof n.ArrayMaterial?(r.material.materials[0].color.copy(r.oldColor),r.material.materials[0].opacity=r.oldOpacity):(r.material.color.copy(r.oldColor),r.material.opacity=r.oldOpacity),r.oldColor=null);this.handleGizmos[e]&&(r=this.handleGizmos[e][0],r.material instanceof n.ArrayMaterial?(r.oldColor=r.oldColor||r.material.materials[0].color.clone(),r.oldOpacity=r.oldOpacit!==t?r.oldOpacity:r.material.materials[0].opacity,r.material.materials[0].opacity=1):(r.oldColor=r.oldColor||r.material.color.clone(),r.oldOpacity=r.material.opacity,r.setStyle("material.opacity",1)))},this.init()},n.TransformGizmo.prototype=Object.create(n.Element.prototype),n.TransformGizmo.prototype.update=function(e,t){var n=new o(0,0,0),r=new o(0,1,0),i=new l;for(var s=0;s<this.getChildren().size();s++)for(var u=0;u<this.getChildren().get(s).getChildren().size();u++){var a=this.getChildren().get(s).getChildren().get(u);a.name.search("E")!=-1?(a.quaternion.setFromRotationMatrix(i.lookAt(t,n,r)),a._rotation.setEulerFromQuaternion(a.quaternion)):(a.quaternion.setFromEuler(e),a._rotation.setEulerFromQuaternion(a.quaternion))}},n.TransformGizmoTranslate=function(){n.TransformGizmo.call(this);var e=new n.TransformGizmoMaterial({color:16711680,opacity:.2}),t=new n.TransformGizmoMaterial({color:65280,opacity:.2}),r=new n.TransformGizmoMaterial({color:255,opacity:.2}),i=new n.Arrow(e,1,.03,.2,.05,30),s=new n.Arrow(t,1,.03,.2,.05,30),u=new n.Arrow(r,1,.03,.2,.05,30),a=new n.TransformGizmoMaterial({color:255,opacity:.5}),f=new n.TransformGizmoMaterial({color:16711680,opacity:.5}),c=new n.TransformGizmoMaterial({color:65280,opacity:.5}),h=new n.TransformGizmoMaterial({color:16777215,opacity:.5}),p=new n.Circle(a,.5,10,0,Math.PI/2),d=new n.Circle(f,.5,10,0,Math.PI/2),v=new n.Circle(c,.5,10,0,Math.PI/2),m=new n.Octahedron(h,1e-4,0);this.handleGizmos={X:[i,new o(1.6,0,0),new o(0,0,-Math.PI/2)],Y:[s,new o(0,1.6,0)],Z:[u,new o(0,0,1.6),new o(Math.PI/2,0,0)],XYZ:[m],XY:[p,new o(0,0,0)],YZ:[d,new o(0,0,0),new o(Math.PI/2,Math.PI/2,0)],XZ:[v,new o(0,0,0),new o(Math.PI/2,0,0)]};var h=new n.TransformGizmoMaterial({color:16711680,opacity:.25}),g=new n.TransformGizmoMaterial({color:65280,opacity:.25}),y=new n.TransformGizmoMaterial({color:255,opacity:.25}),b=new n.Cylinder(h,.075,0,1.2,4,1,!1),w=new n.Cylinder(g,.075,0,1.2,4,1,!1),E=new n.Cylinder(y,.075,0,1.2,4,1,!1),m=new n.Octahedron(h,1e-4,0);this.pickerGizmos={X:[b,new o(1.6,0,0),new o(0,0,-Math.PI/2)],Y:[w,new o(0,1.6,0)],Z:[E,new o(0,0,1.6),new o(Math.PI/2,0,0)],XYZ:[m]},this.setActivePlane=function(e,t){var n=new l;t.applyProjection(n.getInverse(n.extractRotation(this.planes.XY.worldMatrix))),e=="X"&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)),e=="Y"&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)),e=="Z"&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)),e=="XYZ"&&(this.activePlane=this.planes.XYZE),e=="XY"&&(this.activePlane=this.planes.XY),e=="YZ"&&(this.activePlane=this.planes.YZ),e=="XZ"&&(this.activePlane=this.planes.XZ),this.hide(),this.show()},this.init()},n.TransformGizmoTranslate.prototype=Object.create(n.TransformGizmo.prototype),n.TransformGizmoTranslate.prototype.mode="translate",n.TransformGizmoRotate=function(){n.TransformGizmo.call(this);var e=new n.TransformGizmoMaterial({color:16711680,opacity:.2}),t=new n.TransformGizmoMaterial({color:65280,opacity:.2}),r=new n.TransformGizmoMaterial({color:255,opacity:.2}),i=new n.TransformGizmoMaterial({color:16776960}),s=new n.TransformGizmoMaterial({color:7895160,opacity:.25}),s=new n.TransformGizmoMaterial({color:16711680}),u=new n.Torus(e,1,.02,4,32,Math.PI),a=new n.Torus(t,1,.02,4,32,Math.PI),f=new n.Torus(r,1,.02,4,32,Math.PI),c=new n.Torus(i,1.25,.01,4,64),h=new n.Torus(s,1,.01,4,64);this.handleGizmos={X:[u,new o(0,0,0),new o(0,-Math.PI/2,-Math.PI/2)],Y:[a,new o(0,0,0),new o(Math.PI/2,0,0)],Z:[f,new o(0,0,0),new o(0,0,-Math.PI/2)]};var p=new n.TransformGizmoMaterial({color:16711680,opacity:.25}),d=new n.TransformGizmoMaterial({color:65280,opacity:.25}),v=new n.TransformGizmoMaterial({color:255,opacity:.25}),m=new n.TransformGizmoMaterial({color:983040,opacity:.25}),g=new n.Torus(p,1,.05,4,12,Math.PI),y=new n.Torus(d,1,.05,4,12,Math.PI),b=new n.Torus(v,1,.05,4,12,Math.PI),w=new n.Torus(m,1,.05,2,24);this.pickerGizmos={X:[g,new o(0,0,0),new o(0,-Math.PI/2,-Math.PI/2)],Y:[y,new o(0,0,0),new o(Math.PI/2,0,0)],Z:[b,new o(0,0,0),new o(0,0,-Math.PI/2)]},this.setActivePlane=function(e){e=="E"&&(this.activePlane=this.planes.XYZE),e=="X"&&(this.activePlane=this.planes.YZ),e=="Y"&&(this.activePlane=this.planes.XZ),e=="Z"&&(this.activePlane=this.planes.XY),this.hide(),this.show()},this.update=function(e,t){n.TransformGizmo.prototype.update.apply(this,arguments);var r={handles:this.handles,pickers:this.pickers},i=new l,s=new n.Euler(0,0,1),u=new n.Quat,a=new o(1,0,0),f=new o(0,1,0),c=new o(0,0,1),h=new n.Quat,p=new n.Quat,d=new n.Quat,v=t.clone();s.copy(this.planes.XY._rotation),u.setFromEuler(s),i.makeRotationFromQuaternion(u).getInverse(i),v.applyProjection(i);for(var m in r)for(var g=0;g<r[m].getChildren().size;g++){var y=r[m].getChildren().get(g);u.setFromEuler(s),y.name=="X"&&(h.setFromAxisAngle(a,Math.atan2(-v.y,v.z)),u.multiplyQuaternions(u,h),y.quaternion.copy(u)),y.name=="Y"&&(p.setFromAxisAngle(f,Math.atan2(v.x,v.z)),u.multiplyQuaternions(u,p),y.quaternion.copy(u)),y.name=="Z"&&(d.setFromAxisAngle(c,Math.atan2(v.y,v.x)),u.multiplyQuaternions(u,d),y.quaternion.copy(u))}},this.init()},n.TransformGizmoRotate
.prototype=Object.create(n.TransformGizmo.prototype),n.TransformGizmoRotate.prototype.mode="rotate",n.TransformGizmoScale=function(){n.TransformGizmo.call(this);var e=new n.TransformGizmoMaterial({color:11184810,opacity:1}),t=new n.TransformGizmoMaterial({color:16711680,opacity:.2}),r=new n.TransformGizmoMaterial({color:65280,opacity:.2}),i=new n.TransformGizmoMaterial({color:255,opacity:.2}),s=new n.Cube(e,.25,.25,.25),u=new n.Cylinder(null,.1,.1,1,4,1,!1),a=new n.Cube(e,.225,.225,.225),f=new n.Cylinder(null,.1,0,1,20,1,!0);f._position.y=.05;var f=n.Utils.createElement(u,f,t),c=n.Utils.createElement(u,f,r),h=n.Utils.createElement(u,f,i),p=new n.Cylinder(t,.08,0,1,4,1,!1),d=new n.Cylinder(r,.08,0,1,4,1,!1),v=new n.Cylinder(i,.08,0,1,4,1,!1),m=new n.Element;m.material=new n.BasicMaterial;var g=new n.Element;g.material=new n.BasicMaterial;var y=new n.Element;y.material=new n.BasicMaterial,this.handleGizmos={X:[p,new o(.5,0,0),new o(0,0,-Math.PI/2)],Y:[d,new o(0,.5,0)],Z:[v,new o(0,0,.5),new o(Math.PI/2,0,0)],XY:[m],YZ:[g],XZ:[y],XYZ:[s]};var b=new n.TransformGizmoMaterial({color:16711680,opacity:.25}),w=new n.TransformGizmoMaterial({color:65280,opacity:.25}),E=new n.TransformGizmoMaterial({color:255,opacity:.25}),S=new n.Cylinder(b,.125,0,1,4,1,!1),x=new n.Cylinder(w,.125,0,1,4,1,!1),T=new n.Cylinder(E,.125,0,1,4,1,!1);this.pickerGizmos={X:[S,new o(.6,0,0),new o(Math.PI/4,0,-Math.PI/2)],Y:[x,new o(0,.6,0),new o(0,Math.PI/4,0)],Z:[T,new o(0,0,.6),new o(Math.PI/2,Math.PI/4,0)],XYZ:[a]},this.setActivePlane=function(e,t){var n=new l;t.applyProjection(n.getInverse(n.extractRotation(this.planes.XY.worldMatrix))),e=="X"?(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z)&&(this.activePlane=this.planes.XZ)):e=="Y"?(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z)&&(this.activePlane=this.planes.YZ)):e=="Z"?(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y)&&(this.activePlane=this.planes.YZ)):e=="XYZ"?this.activePlane=this.planes.XYZE:this.activePlane=this.planes[e],this.hide(),this.show()},this.init()},n.TransformGizmoScale.prototype=Object.create(n.TransformGizmo.prototype),n.TransformGizmoScale.prototype.mode="scale",n.EditInteraction=function(r){function $(t){if(f.gl3dview._keyboardRemoveEnabled&&t.keyCode==46&&r.getServa().getSelectionContainer().size()>0){var n="Delete?";e.confirm(n)&&r.getServa().removeSelection()}}function J(t){t.touches.length===1&&(f.deleteTimeoutId=setTimeout(function(){var n=f.gl3dview.getElementsByMouseEvent(t,f.selectUnVisible);if(n.length>0){var r=n[0],i="Delete?";e.confirm(i)&&f.gl3dview.getServa().remove(r.element)}},300))}function K(e){clearTimeout(f.deleteTimeoutId)}function Q(e){clearTimeout(f.deleteTimeoutId)}function G(e){f.update()}function Y(e){if(!f.object||c)return;e.preventDefault(),e.stopPropagation();var t=e.touches?e.touches[0]:e,n=at(t,f.filterIntersectPicker(f.pickers));if(n)f.axis=n.object.name,f.setMode(n.object.mode);else{var r=rt(e);r===f.object||r!=null&&r.editTransformToParent&&r.isDescendantOf(f.object)?(f.axis=f.getAxis(),f.setMode(f.getMode())):f.axis=!1}f.update(!0)}function tt(e){if(e.stop)return;et.set(e.clientX,e.clientY);if(!f.showHelpers||!f.axis)ut(e),Y(e);if(!f.object||c){f.gl3dview.dirtyGl3dview();return}e.preventDefault(),e.stopPropagation();var n=e.touches?e.touches[0]:e;if(n.button===0||n.button==t){var i=f.filterIntersectPicker(f.pickers),s=at(n,i),o=rt(e);s||(o===f.object||o!=null&&o.editTransformToParent&&o.isDescendantOf(f.object))&&f.getDefaultPickers()&&(s={object:f.getDefaultPickers()});if(s){f.axis=s.object.name,N.copy(X).sub(U).normalize(),f.gizmo[h].setActivePlane(f.axis,N);var u=at(n,[f.gizmo[h].activePlane]);!u&&o&&(u=at(n,[o]));if(u){j.copy(f.object._position),F.copy(f.object._scale),I.extractRotation(f.object.matrix),W.extractRotation(f.object.worldMatrix);var a=f.object.getParent();a==t&&(a=r),q.extractRotation(a.worldMatrix),R.getScaleFromMatrix(C.getInverse(a.worldMatrix)),w.copy(u.point)}}}f.update(!0),c=!0}function nt(e){if(!f.object||!f.axis||!c)return;e.preventDefault(),e.stopPropagation(),e.stop=!0;var t=e.touches?e.touches[0]:e,n=at(t,[f.gizmo[h].activePlane]);n||(n=at(t,[f.object]));if(n){f.moving?r.fireInteractionEvent({kind:"liveMoveBetween",event:Ur}):(r.fireInteractionEvent({kind:"liveMoveStart",event:Ur}),f.moving=!0),b.copy(n.point);if(h=="translate"&&f.translateable){b.sub(w),b.multiply(R),f.space=="local"&&(b.applyMatrix4(C.getInverse(W)),f.axis.search("X")==-1&&(b.x=0),f.axis.search("Y")==-1&&(b.y=0),f.axis.search("Z")==-1&&(b.z=0),b.applyMatrix4(I),f.object.setPosition(j.clone().add(b)));if(f.space=="world"||f.axis.search("XYZ")!=-1){f.axis.search("X")==-1&&(b.x=0),f.axis.search("Y")==-1&&(b.y=0),f.axis.search("Z")==-1&&(b.z=0),b.applyMatrix4(C.getInverse(q)),f.object._position.copy(j);var i=f.object._position.clone().add(b);f.snap&&(f.axis.search("X")!=-1&&(i.x=Math.round(f.object._position.x/f.snap)*f.snap),f.axis.search("Y")!=-1&&(i.y=Math.round(f.object._position.y/f.snap)*f.snap),f.axis.search("Z")!=-1&&(i.z=Math.round(f.object._position.z/f.snap)*f.snap)),f.object.setPosition(i)}}else if(h=="scale"&&f.scaleable){b.sub(w),b.multiply(R);var s=f.object._scale.clone(),o=(f.scaleRate||1)/10;if(f.axis=="XYZ")l=1+b.y*o,s.x=F.x*l,s.y=F.y*l,s.z=F.z*l;else if(f.axis==="XY"){var u=1+b.x*o,a=1+b.y*o;if(f.forceSameScale){var l=Math.max(u,a);s.x=F.x*l,s.y=F.y*l}else s.x=F.x*u,s.y=F.y*a}else if(f.axis==="YZ"){var p=1+b.z*o,a=1+b.y*o;if(f.forceSameScale){var l=Math.max(p,a);s.z=F.z*l,s.y=F.y*l}else s.z=F.z*p,s.y=F.y*a}else if(f.axis==="XZ"){var u=1+b.x*o,p=1+b.z*o;if(f.forceSameScale){var l=Math.max(u,a);s.x=F.x*l,s.z=F.z*l}else s.x=F.x*u,s.z=F.z*p}else b.applyMatrix4(C.getInverse(W)),f.axis=="X"&&(s.x=F.x*(1+b.x*o)),f.axis=="Y"&&(s.y=F.y*(1+b.y*o)),f.axis=="Z"&&(s.z=F.z*(1+b.z*o));f.object.setScale(s)}else if(h=="rotate"&&f.rotateable){b.sub(U),b.multiply(R),k.copy(w).sub(U),k.multiply(R);if(f.axis=="E")b.applyMatrix4(C.getInverse(T)),k.applyMatrix4(C.getInverse(T)),E.set(Math.atan2(b.z,b.y),Math.atan2(b.x,b.z),Math.atan2(b.y,b.x)),S.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),L.setFromRotationMatrix(C.getInverse(q)),B.setFromAxisAngle(N,E.z-S.z),_.setFromRotationMatrix(W),L.multiplyQuaternions(L,B),L.multiplyQuaternions(L,_),f.object.quaternion.copy(L);else if(f.axis=="XYZE")B.setFromEuler(b.clone().cross(k).normalize()),L.setFromRotationMatrix(C.getInverse(q)),D.setFromAxisAngle(B,-b.clone().angleTo(k)),_.setFromRotationMatrix(W),L.multiplyQuaternions(L,D),L.multiplyQuaternions(L,_),f.object.quaternion.copy(L);else if(f.space=="local"){b.applyMatrix4(C.getInverse(W)),k.applyMatrix4(C.getInverse(W)),E.set(Math.atan2(b.z,b.y),Math.atan2(b.x,b.z),Math.atan2(b.y,b.x)),S.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),_.setFromRotationMatrix(I),D.setFromAxisAngle(A,E.x-S.x),P.setFromAxisAngle(O,E.y-S.y),H.setFromAxisAngle(M,E.z-S.z),f.axis=="X"&&_.multiplyQuaternions(_,D),f.axis=="Y"&&_.multiplyQuaternions(_,P),f.axis=="Z"&&_.multiplyQuaternions(_,H),f.object.quaternion.copy(_);var d=f.object._rotation.clone();d.setEulerFromQuaternion(_),f.object.setRotation(d)}else if(f.space=="world"){E.set(Math.atan2(b.z,b.y),Math.atan2(b.x,b.z),Math.atan2(b.y,b.x)),S.set(Math.atan2(k.z,k.y),Math.atan2(k.x,k.z),Math.atan2(k.y,k.x)),L.setFromRotationMatrix(C.getInverse(q)),D.setFromAxisAngle(A,E.x-S.x),P.setFromAxisAngle(O,E.y-S.y),H.setFromAxisAngle(M,E.z-S.z),_.setFromRotationMatrix(W),f.axis=="X"&&L.multiplyQuaternions(L,D),f.axis=="Y"&&L.multiplyQuaternions(L,P),f.axis=="Z"&&L.multiplyQuaternions(L,H),L.multiplyQuaternions(L,_),f.object.quaternion.copy(L);var d=f.object._rotation.clone();d.setEulerFromQuaternion(L),f.object.setRotation(d)}}f.changed=!0}f.update(!0),f.updateTextNote(e,f.object)}function rt(e){var t=f.gl3dview.getElementsByMouseEvent(e);return r.getFirstEditElement(t)}function it(e){if(e instanceof n.ArrayMaterial){var t=m.materials;for(var r in t)it(t[r])}else e.orignalDepthTest=e.depthTest,e.orignalDepthMask=e.depthMask,e.depthTest=!1,e.depthMask=!1}function st(e){if(e instanceof n.ArrayMaterial){var t=m.materials;for(var r in t)st(t[r])}else e.depthTest=e.orignalDepthTest,e.depthMask=e.orignalDepthMask}function ot(e){return e&&e.editTransformToParent&&e.getParent()?ot(e.getParent()):e}function ut(e){Z===null&&(Z=new s),Z.set(e.clientX,e.clientY),r.getServa().clearEditing();if(Z.distanceTo(et)===0){var t=f.gl3dview.getElementsByMouseEvent(e),n=r.getFirstEditElement(t);n&&(n!==f.object,f.object=n,f.translateable&&f.gizmo.translate.show(),f.rotateable&&f.gizmo.rotate.show(),f.scaleable&&f.gizmo.scale.show()),n||(f.gizmo[h].hide(),f.gizmo.translate.hide(),f.gizmo.rotate.hide(),f.gizmo.scale.hide(),f.object=null)}else f.changed&&f.onElementPropertyChanged&&(f.changed=!1,f.moving=!1,f.onElementPropertyChanged(e,f.object),r.fireInteractionEvent({kind:"liveMoveEnd",event:{e:e,source:f.object,time:(new Date).getTime()}}));f.axis=!1,c=!1,f.update(!0),f.hideTextNote()}function at(e,t){if(!t)return null;var n=f.gl3dview.getPickingByEvent(e),r=n.intersectObjects(t,!0,!0);return r[0]?r[0]:!1}n.BaseInteraction.call(this,r);var i=new n.Element,u=r.getGleye(),a=r.getRootView();a=a!==t?a:document,this.domElement=a,this.gizmo={},this.gizmo.translate=new n.TransformGizmoTranslate,this.gizmo.rotate=new n.TransformGizmoRotate,this.gizmo.scale=new n.TransformGizmoScale,i.addChild(this.gizmo.translate),i.addChild(this.gizmo.rotate),i.addChild(this.gizmo.scale),this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.object=!1,this.snap=!1,this.space="local",this.size=1,this.axis=!1;var f=this;this.scaleable=!0,this.rotateable=!0,this.translateable=!0,this.setShowHelpers(!0);var c=!1,h="translate",p="XY",d={type:"change"},v=new n.Picking,g=new n.Projector,y=new o,b=new o,w=new o,E=new o,S=new o,x=1,T=new l,N=new o,C=new l,k=new o,L=new n.Quat,A=new o(1,0,0),O=new o(0,1,0),M=new o(0,0,1),_=new n.Quat,D=new n.Quat,P=new n.Quat,H=new n.Quat,B=new n.Quat,j=new o,F=new o,I=new l,q=new l,R=new o,U=new o,z=new n.Euler,W=new l,X=new o,V=new n.Euler;this.showNote=!0,this.handleServaChange=function(e){e.kind=="remove"?e.data==f.object&&(f.gizmo.translate.hide(),f.gizmo.rotate.hide(),f.gizmo.scale.hide()):e.kind=="clear"&&(f.gizmo.translate.hide(),f.gizmo.rotate.hide(),f.gizmo.scale.hide())},this.gl3dview.getServa().addServaChangeListener(this.handleServaChange,this),this.gl3dview.addPropertyChangeListener(function(e){if(e.property=="dataBox"){var t=e.oldValue,n=e.value;t.removeServaChangeListener(this.handleServaChange),n.addServaChangeListener(this.handleServaChange,this)}}),this.defaultMode="TranslateXY",this.pickers=[],this.gizmo.translate.pickers.getChildren().forEach(function(e){f.pickers.push(e)}),this.gizmo.rotate.pickers.getChildren().forEach(function(e){f.pickers.push(e)}),this.gizmo.scale.pickers.getChildren().forEach(function(e){f.pickers.push(e)}),this.attach=function(e){f.object=e,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide(),this.gizmo[h].show(),f.update()},this.detach=function(e){f.object=!1,this.axis=!1,this.gizmo.translate.hide(),this.gizmo.rotate.hide(),this.gizmo.scale.hide()},this.setMode=function(e){h=e?e:h,this.update()},this.setUp=function(){a.addEventListener("mousedown",tt,!1),a.addEventListener("touchstart",tt,!1),a.addEventListener("mousemove",Y,!1),a.addEventListener("touchmove",Y,!1),a.addEventListener("mousemove",nt,!1),a.addEventListener("touchmove",nt,!1),a.addEventListener("mouseup",ut,!1),a.addEventListener("mouseout",ut,!1),a.addEventListener("touchend",ut,!1),a.addEventListener("touchcancel",ut,!1),a.addEventListener("touchleave",ut,!1),a.addEventListener("keydown",$,!1),a.addEventListener("touchstart",J,!1),a.addEventListener("touchmove",K,!1),a.addEventListener("touchend",Q,!1),a.addEventListener("mousewheel",G,!1),f.gl3dview.helperBox.addByDescendant(i)},this.tearDown=function(){a.removeEventListener("mousedown",tt,!1),a.removeEventListener("touchstart",tt,!1),a.removeEventListener("mousemove",Y,!1),a.removeEventListener("touchmove",Y,!1),a.removeEventListener("mousemove",nt,!1),a.removeEventListener("touchmove",nt,!1),a.removeEventListener("mouseup",ut,!1),a.removeEventListener("mouseout",ut,!1),a.removeEventListener("touchend",ut,!1),a.removeEventListener("touchcancel",ut,!1),a.removeEventListener("touchleave",ut,!1),a.removeEventListener("keydown",$,!1),a.removeEventListener("touchstart",J,!1),a.removeEventListener("touchmove",K,!1),a.removeEventListener("touchend",Q,!1),a.removeEventListener("mousewheel",G,!1),f.gizmo.translate.hide(),f.gizmo.rotate.hide(),f.gizmo.scale.hide(),f.gl3dview.helperBox.removeByDescendant(i)},this.setSnap=function(e){f.snap=e},this.setSize=function(e){f.size=e,f.dispatchEvent(d),this.update()},this.setSpace=function(e){f.space=e,this.update()},this.update=function(e){if(!f.object)return;f.object.updateWorldMatrix(),U.getPositionFromMatrix(f.object.worldMatrix),z.setFromRotationMatrix(C.extractRotation(f.object.worldMatrix)),u.updateWorldMatrix(),X.getPositionFromMatrix(u.worldMatrix),V.setFromRotationMatrix(C.extractRotation(u.worldMatrix)),x=U.distanceTo(X)/12*f.size,i.setPosition(U),i.setScale(x,x,x),N.copy(X).sub(U).normalize(),this.gizmo.scale.update(z,N),f.space=="local"?(this.gizmo.translate.update(z,N),this.gizmo.rotate.update(z,N)):(this.gizmo.translate.update(new n.Euler,N),this.gizmo.rotate.update(new n.Euler,N)),this.gizmo.translate.highlight(null),this.gizmo.rotate.highlight(null),this.gizmo.scale.highlight(null),this.gizmo[h].highlight(f.axis),i.updateWorldMatrix(!0),e&&f.gl3dview.dirtyGl3dview()},this.getDefaultPickers=function(){return this.defaultMode==="TranslateX"?f.gizmo.translate.pickers.getChildren().get(0):this.defaultMode==="TranslateY"?f.gizmo.translate.pickers.getChildren().get(1):this.defaultMode==="TranslateZ"?f.gizmo.translate.pickers.getChildren().get(2):this.defaultMode==="TranslateXY"?f.gizmo.translate.pickers.getChildren().get(4):this.defaultMode==="TranslateYZ"?f.gizmo.translate.pickers.getChildren().get(5):this.defaultMode==="TranslateXZ"?f.gizmo.translate.pickers.getChildren().get(6):this.defaultMode==="TranslateXYZ"?f.gizmo.translate.pickers.getChildren().get(3):this.defaultMode==="RotateX"?f.gizmo.rotate.pickers.getChildren().get(0):this.defaultMode==="RotateY"?f.gizmo.rotate.pickers.getChildren().get(1):this.defaultMode==="RotateZ"?f.gizmo.rotate.pickers.getChildren().get(2):this.defaultMode==="ScaleX"?f.gizmo.scale.pickers.getChildren().get(0):this.defaultMode==="ScaleY"?f.gizmo.scale.pickers.getChildren().get(1):this.defaultMode==="ScaleZ"?f.gizmo.scale.pickers.getChildren().get(2):this.defaultMode==="ScaleXYZ"?f.gizmo.scale.pickers.getChildren().get(6):this.defaultMode==="ScaleXY"?f.gizmo.scale.pickers.getChildren().get(3):this.defaultMode==="ScaleYZ"?f.gizmo.scale.pickers.getChildren().get(4):this.defaultMode==="ScaleXZ"?f.gizmo.scale.pickers.getChildren().get(5):null},this.getMode=function(){var e=this.defaultMode;return e.startsWith("Translate")?"translate":e.startsWith("Rotate")?"rotate":e.startsWith("Scale")?"scale":"translate"},this.getAxis=function(){var e=this.defaultMode;return e.endsWith("XYZ")?"XYZ":e.endsWith("XY")?"XY":e.endsWith("YZ")?"YZ":e.endsWith("XZ")?"XZ":e.endsWith("Y")?"X":e.endsWith("Y")?"Y":e.endsWith("Z")?"Z":""};var Z=null,et=new s;this.filterIntersectPicker=function(e){var t=[];if(!this.showHelpers)return t;for(var n=0;n<e.length;n++){var r=e[n];r.getParent()===this.gizmo.translate.pickers&&this.translateable&&t.push(r),r.getParent()===this.gizmo.rotate.pickers&&this.rotateable&&t.push(r),r.getParent()===this.gizmo.scale.pickers&&this.scaleable&&t.push(r)}return t}},n.extend(n.EditInteraction,n.BaseInteraction,{setShowHelpers:function(e){this.showHelpers=e,this.gizmo.translate.showHelpers=e,this.gizmo.rotate.showHelpers=e,this.gizmo.scale.showHelpers=e,this.resetHelpers()},onElementPropertyChanged:function(e,t){},resetHelpers:function(){this.showHelpers&&this.translateable&&this.object?this.gizmo.translate.show():this.gizmo.translate.hide(),this.showHelpers&&this.rotateable&&this.object?this.gizmo.rotate.show():this.gizmo.rotate.hide(),this.showHelpers&&this.scaleable&&this.object?this.gizmo.scale.show():this.gizmo.scale.hide(),this.update(!0)},setShowNote:function(e){this.showNote=e},setScaleable:function(e){this.scaleable=e,this.gizmo.scale.showable=e,this.resetHelpers()},setRotateable:function(e){this.rotateable=e,this.gizmo.rotate.showable=e,this.resetHelpers()},setTranslateable:function(e){this.translateable=e,this.gizmo.translate.showable=e,this.resetHelpers()},setDefaultMode:function(e){this.defaultMode=e},setScaleRate:function(e){this.scaleRate=e||1},setForceSameScale:function(e){this.forceSameScale=e},setSpaceMode:function(e){e=="world"?this.space="world":this.space="local",this.update()},createTextNote:function(){this.textNote=document.createElement("div"),this.textNote.style.position="relative",this.textNote.style.color="black",this.textNote.style.height="0px",this.textNote.style.zIndex="1000",this.domElement.appendChild(this.textNote);var e=document.createElement("table");this.noteTable=e,this.textNote.appendChild(this.noteTable);var t=e.createTHead();e.style.borderLeft="1px solid #ffa500",e.style.borderTop="1px solid #ffa500",e.style.fontSize="14px",e.style.backgroundColor="rgba(255, 170, 13, 0.5)",e.setAttribute("border",0),e.setAttribute("cellspacing",0),e.setAttribute("cellpadding",0);for(var n=0;n<4;n++){var r=document.createElement("tr");for(var i=0;i<4;i++){var s=document.createElement("td");s.style.borderRight="1px solid #ffa500",s.style.borderBottom="1px solid #ffa500",s.style.paddingLeft="5px",s.style.paddingRight="5px",s.style.paddingTop="2px",s.style.paddingBottom="2px",n==0&&i>0||n>0&&i==0?(s.style.textAlign="center",s.style.fontWeight="bold"):s.style.textAlign="right",r.appendChild(s)}e.appendChild(r)}},showTextNote:function(){if(!this.showNote)return;this.textNote==null&&this.createTextNote(),this.textNote.style.display=""},hideTextNote:function(){this.textNote&&(this.textNote.style.display="none")},updateTextNote:function(e,t){if(t==null||!this.showNote)return;var n=this.gl3dview.getRootView().getBoundingClientRect();this.showTextNote(),this.textNote.style.top=e.clientY-n.top+20+"px",this.textNote.style.left=e.clientX-n.left+20+"px";var r=t.getRotation(),i=t.getPosition(),s=t.getScale(),o=[[" ","x","y","z"],["p",i.x,i.y,i.z],["r",r.x,r.y,r.z],["s",s.x,s.y,s.z]],u=this.noteTable;for(var a=0;a<4;a++)for(var f=0;f<4;f++){var l=o[a][f];a>0&&f>0&&(a==2?l=(l*180/Math.PI).toFixed(0)+"&deg;":l=l.toFixed(2)),u.rows[a].cells[f].innerHTML=""+l}}});var gi=1e-5,yi=0,bi=1,wi=2,Ei=3;n.CSG=function(e){var t,r,i,o,u,a,f,c=[],h;if(!(e instanceof n.Element)){if(e instanceof Ti)return this.tree=e,this.matrix=new l,this;throw"TGL.CSG: Given geometry is unsupported"}e.computeNodeData&&e.computeNodeData(),e.updateWorldMatrix(!0),this.matrix=e.worldMatrix.clone();for(t=0,r=e.faces.length;t<r;t++){i=e.faces[t],u=e.uvs[t],a=e.uv2s[t],f=new Si;if(i instanceof O)o=e.vertices[i.a],o=new xi(o.x,o.y,o.z,i.vertexNormals[0],new s(u[0].x,u[0].y),a[0].clone()),o.materialIndex=i.materialIndex,o.applyMatrix4(this.matrix),f.vertices.push(o),o=e.vertices[i.b],o=new xi(o.x,o.y,o.z,i.vertexNormals[1],new s(u[1].x,u[1].y),a[1].clone()),o.materialIndex=i.materialIndex,o.applyMatrix4(this.matrix),f.vertices.push(o),o=e.vertices[i.c],o=new xi(o.x,o.y,o.z,i.vertexNormals[2],new s(u[2].x,u[2].y),a[2].clone()),o.applyMatrix4(this.matrix),o.materialIndex=i.materialIndex,f.vertices.push(o);else{if(!(i instanceof M))throw"Invalid face type at index "+t;o=e.vertices[i.a],o=new xi(o.x,o.y,o.z,i.vertexNormals[0],new s(u[0].x,u[0].y),a[0].clone()),o.materialIndex=i.materialIndex,o.applyMatrix4(this.matrix),f.vertices.push(o),o=e.vertices[i.b],o=new xi(o.x,o.y,o.z,i.vertexNormals[1],new s(u[1].x,u[1].y),a[1].clone()),o.materialIndex=i.materialIndex,o.applyMatrix4(this.matrix),f.vertices.push(o),o=e.vertices[i.c],o=new xi(o.x,o.y,o.z,i.vertexNormals[2],new s(u[2].x,u[2].y),a[2].clone()),o.materialIndex=i.materialIndex,o.applyMatrix4(this.matrix),f.vertices.push(o),o=e.vertices[i.d],o=new xi(o.x,o.y,o.z,i.vertexNormals[3],new s(u[3].x,u[3].y),a[3].clone()),o.applyMatrix4(this.matrix),o.materialIndex=i.materialIndex,f.vertices.push(o)}isNaN(f.calculateProperties().w)?console.log("Not right polygon"):c.push(f)}this.tree=new Ti(c),this.tree.materialSize=e.getMaterialSize?e.getMaterialSize():0;if(e.material instanceof n.ArrayMaterial)this.tree.material=e.material;else{var p=new n.ArrayMaterial;this.tree.material=p;for(var t=0;t<this.tree.materialSize;t++)p.push(e.material)}},n.CSG.prototype.substract=function(e){var t=this.tree.clone(),r=e.tree.clone();return t.sumMateriaSize(r),t.invert(),t.clipTo(r),r.clipTo(t),r.invert(),r.clipTo(t),r.invert(),t.build(r.allPolygons()),t.invert(),t=new n.CSG(t),t.matrix=this.matrix,t},n.CSG.prototype.union=function(e){var t=this.tree.clone(),r=e.tree.clone();return t.sumMateriaSize(r),t.clipTo(r),r.clipTo(t),r.invert(),r.clipTo(t),r.invert(),t.build(r.allPolygons()),t=new n.CSG(t),t.matrix=this.matrix,t},n.CSG.prototype.intersect=function(e){var t=this.tree.clone(),r=e.tree.clone();return t.sumMateriaSize(r),t.invert(),r.clipTo(t),r.invert(),t.clipTo(r),r.clipTo(t),t.build(r.allPolygons()),t.invert(),t=new n.CSG(t),t.matrix=this.matrix,t},n.CSG.prototype.inverse=function(){var e=this.tree.clone();return e.polygons.map(function(e){e.flip()}),e=new n.CSG(e),e},n.CSG.prototype.toGeometry=function(e){var t,r,i=(new l).getInverse(this.matrix),u=new n.Entity(this.tree.material,e),a=this.tree.allPolygons(),f=a.length,c,h,p={},d,v,m,g,y,b,w;for(t=0;t<f;t++){c=a[t],h=c.vertices.length;for(r=2;r<h;r++){b=[],w=[],g=c.vertices[0],b.push(new s(g.uv.x,g.uv.y)),w.push(g.uv2.clone());var E=g.materialIndex;g=new o(g.x,g.y,g.z),typeof p[g.x+","+g.y+","+g.z]!="undefined"?d=p[g.x+","+g.y+","+g.z]:(u.vertices.push(g),d=p[g.x+","+g.y+","+g.z]=u.vertices.length-1),g=c.vertices[r-1],b.push(new s(g.uv.x,g.uv.y)),w.push(g.uv2.clone()),g=new o(g.x,g.y,g.z),typeof p[g.x+","+g.y+","+g.z]!="undefined"?v=p[g.x+","+g.y+","+g.z]:(u.vertices.push(g),v=p[g.x+","+g.y+","+g.z]=u.vertices.length-1),g=c.vertices[r],b.push(new s(g.uv.x,g.uv.y)),w.push(g.uv2.clone()),g=new o(g.x,g.y,g.z),typeof p[g.x+","+g.y+","+g.z]!="undefined"?m=p[g.x+","+g.y+","+g.z]:(u.vertices.push(g),m=p[g.x+","+g.y+","+g.z]=u.vertices.length-1),y=new O(d,v,m,new o(c.normal.x,c.normal.y,c.normal.z)),y.materialIndex=E||0,u.faces.push(y),u.uvs.push(b),u.uv2s.push(w)}}return u},n.CSG.prototype.toMesh=function(e){var t=this.toGeometry(e);return t.computeBizBox(),t};var Si=function(e,n,r){e instanceof Array||(e=[]),this.vertices=e,e.length>0?this.calculateProperties():this.normal=this.w=t};Si.prototype.calculateProperties=function(){var e=this.vertices[0],t=this.vertices[1],n=this.vertices[2],r=t.clone().subtract(e),i=n.clone().subtract(e);return this.normal=r.cross(i).normalize(),this.w=this.normal.clone().dot(e),this},Si.prototype.clone=function(){var e,t,n=new Si;for(e=0,t=this.vertices.length;e<t;e++)n.vertices.push(this.vertices[e].clone());return n.calculateProperties(),n},Si.prototype.flip=function(){var e,t=[];this.normal.multiplyScalar(-1),this.w*=-1;for(e=this.vertices.length-1;e>=0;e--)t.push(this.vertices[e]);return this.vertices=t,this},Si.prototype.classifyVertex=function(e){var t=this.normal.dot(e)-this.w;return t<-gi?wi:t>gi?bi:yi},Si.prototype.classifySide=function(e){var t,n,r,i=0,s=0,o=e.vertices.length;for(t=0;t<o;t++)n=e.vertices[t],r=this.classifyVertex(n),r===bi?i++:r===wi&&s++;return i>0&&s===0?bi:i===0&&s>0?wi:i===0&&s===0?yi:Ei},Si.prototype.splitPolygon=function(e,t,n,r,i){var s=this.classifySide(e);if(s===yi)(this.normal.dot(e.normal)>0?t:n).push(e);else if(s===bi)r.push(e);else if(s===wi)i.push(e);else{var o,u,a,f,l,c,h,p,d,v=[],m=[];for(u=0,o=e.vertices.length;u<o;u++)a=(u+1)%o,c=e.vertices[u],h=e.vertices[a],f=this.classifyVertex(c),l=this.classifyVertex(h),f!=wi&&v.push(c),f!=bi&&m.push(c),(f|l)===Ei&&(p=(this.w-this.normal.dot(c))/this.normal.dot(h.clone().subtract(c)),d=c.interpolate(h,p),v.push(d),m.push(d));v.length>=3&&r.push((new Si(v)).calculateProperties()),m.length>=3&&i.push((new Si(m)).calculateProperties())}},n.CSG.Polygon=Si;var xi=function(e,t,n,r,i,u){this.x=e,this.y=t,this.z=n,this.normal=r||new o,this.uv=i||new s,this.uv2=u||new s};xi.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},xi.prototype.clone=function(){var e=new xi(this.x,this.y,this.z,this.normal.clone(),this.uv.clone(),this.uv2.clone());return e.materialIndex=this.materialIndex,e},xi.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},xi.prototype.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},xi.prototype.multiplyScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this},xi.prototype.cross=function(e){var t=this.x,n=this.y,r=this.z;return this.x=n*e.z-r*e.y,this.y=r*e.x-t*e.z,this.z=t*e.y-n*e.x,this},xi.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return this.x/=e,this.y/=e,this.z/=e,this},xi.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},xi.prototype.lerp=function(e,t){return this.add(e.clone().subtract(this).multiplyScalar(t)),this.normal.add(e.normal.clone().sub(this.normal).multiplyScalar(t)),this.uv.add(e.uv.clone().sub(this.uv).multiplyScalar(t)),this.uv2.add(e.uv2.clone().sub(this.uv2).multiplyScalar(t)),this},xi.prototype.interpolate=function(e,t){return this.clone().lerp(e,t)},xi.prototype.applyMatrix4=function(e){var t=this.x,n=this.y,r=this.z,i=e.elements;return this.x=i[0]*t+i[4]*n+i[8]*r+i[12],this.y=i[1]*t+i[5]*n+i[9]*r+i[13],this.z=i[2]*t+i[6]*n+i[10]*r+i[14],this},n.CSG.Vertex=xi;var Ti=function(e){var n,r,i=[],s=[];this.polygons=[],this.front=this.back=t;if(!(e instanceof Array&&e.length!==0))return;this.divider=e[0].clone();for(n=0,r=e.length;n<r;n++)this.divider.splitPolygon(e[n],this.polygons,this.polygons,i,s);i.length>0&&(this.front=new Ti(i)),s.length>0&&(this.back=new Ti(s))};Ti.isConvex=function(e){var t,n;for(t=0;t<e.length;t++)for(n=0;n<e.length;n++)if(t!==n&&e[t].classifySide(e[n])!==wi)return!1;return!0},Ti.prototype.build=function(e){var t,n,r=[],i=[];this.divider||(this.divider=e[0].clone());for(t=0,n=e.length;t<n;t++)this.divider.splitPolygon(e[t],this.polygons,this.polygons,r,i);r.length>0&&(this.front||(this.front=new Ti),this.front.build(r)),i.length>0&&(this.back||(this.back=new Ti),this.back.build(i))},Ti.prototype.allPolygons=function(){var e=this.polygons.slice();return this.front&&(e=e.concat(this.front.allPolygons())),this.back&&(e=e.concat(this.back.allPolygons())),e},Ti.prototype.clone=function(){var e=new Ti;this.divider&&(e.divider=this.divider.clone()),e.polygons=this.polygons.map(function(e){return e.clone()}),e.front=this.front&&this.front.clone(),e.back=this.back&&this.back.clone(),e.materialSize=this.materialSize,e.material=new n.ArrayMaterial;if(this.material)for(var t=0;t<this.material.materials.length;t++)e.material.materials.push(this.material.materials[t]);return e},Ti.prototype.invert=function(){var e,t,n;for(e=0,t=this.polygons.length;e<t;e++)this.polygons[e].flip();return this.divider&&this.divider.flip(),this.front&&this.front.invert(),this.back&&this.back.invert(),n=this.front,this.front=this.back,this.back=n,this},Ti.prototype.clipPolygons=function(e){var t,n,r,i;if(!this.divider)return e.slice();r=[],i=[];for(t=0,n=e.length;t<n;t++)this.divider.splitPolygon(e[t],r,i,r,i);return this.front&&(r=this.front.clipPolygons(r)),this.back?i=this.back.clipPolygons(i):i=[],r.concat(i)},Ti.prototype.clipTo=function(e){this.polygons=e.clipPolygons(this.polygons),this.front&&this.front.clipTo(e),this.back&&this.back.clipTo(e)},Ti.prototype.sumMateriaSize=function(e){e.changeMaterialIndex(this.materialSize),this.materialSize=this.materialSize+e.materialSize;for(var t=0;t<e.material.materials.length;t++)this.material.materials.push(e.material.materials[t])},Ti.prototype.changeMaterialIndex=function(e){for(var t=0;t<this.polygons.length;t++){var n=this.polygons[t];for(var r=0;r<n.vertices.length;r++){var i=n.vertices[r];i.materialIndex=i.materialIndex+e}}this.front&&this.front.changeMaterialIndex(e),this.back&&this.back.changeMaterialIndex(e)},n.CSG.Node=Ti,n.XmlSerializer=function(e,t,r){this.dataBox=e,this.settings=t?t:new n.SerializationSettings,this.filterFunction=r,this.ref=0,this.refMap={},this.idMap={},this.xmlString=""},n.extend(n.XmlSerializer,Object,{serialize:function(){return this.xmlString="<TGL version='"+n.version+"' platform='html5'>\n",this.serializeBody(),this.xmlString+="</TGL>\n",this.xmlString},serializeBody:function(){this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isServaSerializable&&(this.xmlString+="<dataBox class='"+this.dataBox.getClassName()+"'>\n",this.dataBox.serializeXml(this,this.dataBox.newInstance()),this.xmlString+="</dataBox>\n"),this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(e){this.refMap[e.getId()]=this.ref++,e.getChildren().forEach(this.initRefs,this)},isSerializable:function(e){return this.dataBox.contains(e)?this.filterFunction&&!this.filterFunction(e)?!1:!0:!1},getPropertyType:function(e,t){var n=this.settings.getPropertyType(t);return n||e.__SizePropeties&&e.__SizePropeties.indexOf(t)!=-1&&(n="number"),n},serializeData:function(e){if(this.isSerializable(e)){var t=e.newInstance(),n=this.refMap[e.getId()];this.xmlString+="<data class='"+e.getClassName()+"' ref='"+n+"'",this.settings.getPropertyType("id")!=null&&(this.xmlString+=" id='"+e.getId()+"'"),this.xmlString+=">\n",e.serializeXml(this,t),this.xmlString+="</data>\n"}e.getChildren().forEach(this.serializeData,this)},serializePropertyXml:function(e,t,r){var i=this.getPropertyType(e,t);if(i){var s=n.getValue(e,t,i),o=n.getValue(r,t,i);s!==o&&this.serializeValue("p",t,s,o,i)}},serializeStyleXml:function(e,t,n){var r=this.settings.getStyleType(t);if(r){var i=e.getStyle(t),s=n.getStyle(t);i!=s&&this.serializeValue("s",t,i,s,r)}},serializeClientXml:function(e,t,n){var r=this.settings.getClientType(t);if(r!=null){var i=e.getClient(t),s=n.getClient(t);i!=s&&this.serializeValue("c",t,i,s,r)}},serializeValue:function(e,t,n,r,i){e==="s"&&(n=this.flattenArray(n),n instanceof Array&&i!=="string"&&i!=="color"&&i!=="number"&&(i="list."+i,n=new N(n)));if(n==null)this.xmlString+="	<"+e+" n='"+t+"' none=''/>\n";else if(i==="cdata")this.xmlString+="	<"+e+" n='"+t+"'><![CDATA["+n+"]]></"+e+">\n";else if(i==="data"){var s=this.refMap[n.getId()];s!=null&&(this.xmlString+="	<"+e+" n='"+t+"' ref='"+s+"'/>\n")}else if(i==="vec2"){if(!r||n.x!==r.x||n.y!==r.y)this.xmlString+="	<"+e+" n='"+t+"' x='"+n.x+"' y='"+n.y+"'/>\n"}else if(i==="vec3"){if(!r||n.x!==r.x||n.y!==r.y||n.z!=r.z)this.xmlString+="	<"+e+" n='"+t+"' x='"+n.x+"' y='"+n.y+"' z='"+n.z+"'/>\n"}else i==="list.vec2"?(this.xmlString+="	<"+e+" n='"+t+"'>\n",n instanceof Array&&(n=new N(n)),n.forEach(function(t){if(t instanceof Array){this.xmlString+="	<"+e+">\n";for(var n=0;n<t.length;n++){var r=t[n];this.xmlString+="		<p x='"+r.x+"' y='"+r.y+"'/>\n"}this.xmlString+="	</"+e+">\n"}else this.xmlString+="		<p x='"+t.x+"' y='"+t.y+"'/>\n"},this),this.xmlString+="	</"+e+">\n"):i==="list.vec3"?(this.xmlString+="	<"+e+" n='"+t+"'>\n",n instanceof Array&&(n=new N(n)),n.forEach(function(t){if(t instanceof Array){this.xmlString+="	<"+e+">\n";for(var n=0;n<t.length;n++){var r=t[n];this.xmlString+="	<"+e+"' x='"+r.x+"' y='"+r.y+"' z='"+r.z+"'/>\n"}this.xmlString+="	</"+e+">\n"}else this.xmlString+="		<"+e+"' x='"+t.x+"' y='"+t.y+"' z='"+t.z+"'/>\n"},this),this.xmlString+="	</"+e+">\n"):i==="list.string"||i==="list.number"||i==="list.color"?(this.xmlString+="	<"+e+" n='"+t+"'>\n",n.forEach(function(e){this.xmlString+="		<s>"+e+"</s>\n"},this),this.xmlString+="	</"+e+">\n"):this.xmlString+="	<"+e+" n='"+t+"'>"+n+"</"+e+">\n"},flattenArray:function(e){if(e instanceof Array){for(var t=0;t<e.length-1;t++)if(e[t]!=e[t+1]){if(!e[t]||!e[t].equals)return e;if(!e[t].equals(e[t+1]))return e}return e[0]}return e},deserialize:function(e,t){n.isDeserializing=!0,this.xmlString=e;var r=n.xml(e).documentElement;this.refMap={},this.idMap={};var i=new N,s=new N,o,u,a,f=r.getElementsByTagName("data"),l=f.length;for(a=0;a<l;a++){u=f[a];var c=u.getAttribute("class"),h=this.settings.getPropertyType("id");if(h&&u.hasAttribute("id")){var p=null;if(h==="string")p=u.getAttribute("id");else if(h==="int")p=parseInt(u.getAttribute("id"));else{if(h!=="number")throw"Unsupported id type '"+h+"'";p=parseFloat(u.getAttribute("id"))}if(u.getAttribute("action")==="remove"){this.dataBox.removeById(p);continue}o=this.dataBox.getDataById(p),
o||(o=n.newInstance(c,p))}else o=n.newInstance(c);if(u.hasAttribute("ref")){var d=u.getAttribute("ref");this.refMap[d]=o}i.add(o),s.add(u),this.idMap[o.getId()]=o}this.dataBox.forEach(function(e){this.idMap[e.getId()]=e},this),l=i.size();for(a=0;a<l;a++){o=i.get(a);if(this.dataBox.containsById(o.getId()))continue;t&&!o.getParent()&&o.setParent(t),this.dataBox.add(o)}for(a=0;a<l;a++)o=i.get(a),u=s.get(a),o.deserializeXml(this,u);this.settings.isServaSerializable&&r.getElementsByTagName("dataBox").length===1&&this.dataBox.deserializeXml(this,r.getElementsByTagName("dataBox")[0]),n.isDeserializing=!1},deserializePropertyXml:function(e,t,r){var i=this.getPropertyType(e,r);i&&n.setValue(e,r,this.deserializeValue(t,i))},deserializeStyleXml:function(e,t,n){var r=this.settings.getStyleType(n);r&&e.setStyle(n,this.deserializeValue(t,r))},deserializeClientXml:function(e,t,n){var r=this.settings.getClientType(n);r&&e.setClient(n,this.deserializeValue(t,r))},deserializePoint:function(e){var t=e.getAttribute("x")?parseFloat(e.getAttribute("x")):null,r=e.getAttribute("a")?parseFloat(e.getAttribute("a")):null;if(t!=null){var i=e.getAttribute("y")?parseFloat(e.getAttribute("y")):null,s=e.getAttribute("z")?parseFloat(e.getAttribute("z")):null,o=e.getAttribute("w")?parseFloat(e.getAttribute("w")):null;return o!=null?new n.Vec4(t,i,s,o):s!=null?new n.XiangliangThree(t,i,s):new n.XiangliangTwo(t,i)}if(r!=null){var u=e.getAttribute("b")?parseFloat(e.getAttribute("b")):null,a=e.getAttribute("c")?parseFloat(e.getAttribute("c")):null,f=e.getAttribute("d")?parseFloat(e.getAttribute("d")):null;return f!=null?new n.Face4(r,u,a,f):new n.Face3(r,u,a)}return null},arrayStyleValue:function(e,t){var r=[];if(e.indexOf(",")){r=e.split(",");if(t==="string")return r;if(t==="number"){var i=[];for(var s=0;s<r.length;s++)i.push(parseFloat(r[s]));return i}if(t==="color"){var o=[];for(var s=0;s<r.length;s++)o.push(new n.Color(r[s]));return o}}},deserializeValue:function(e,t,r){if(e.hasAttribute("@none"))return null;var i=e.nodeName==="s",s=i&&e.textContent.indexOf(",")!==-1;if(t==="string")return s?this.arrayStyleValue(e.textContent,t):e.textContent;if(t==="color")return s?this.arrayStyleValue(e.textContent,t):e.textContent;if(t==="number")return s?this.arrayStyleValue(e.textContent,t):parseFloat(e.textContent);if(t==="boolean")return e.textContent==="true";if(t==="int")return parseInt(e.textContent);if(t==="point")return this.deserializePoint(e);if(t==="vec2"){var o=parseFloat(e.getAttribute("x")),u=parseFloat(e.getAttribute("y"));if(!isNaN(o)&&!isNaN(u)||!i)return new n.XiangliangTwo(o,u);t="list.point"}if(t==="vec3"){var o=parseFloat(e.getAttribute("x")),u=parseFloat(e.getAttribute("y")),a=parseFloat(e.getAttribute("z"));return new n.XiangliangThree(o,u,a)}if(t==="data"){var f=e.getAttribute("ref"),l=this.refMap[f];return l?l:this.idMap[f]}var c,h,p,d;if(t==="list.point"){var v=new N,m=e.getElementsByTagName("p");c=m.length;for(d=0;d<c;d++){var g=m[d];v.add(this.deserializePoint(g))}return i?v._as:v}if(t==="list.string"){var y=new N;p=e.getElementsByTagName("s"),c=p.length;for(d=0;d<c;d++)y.add(p[d].textContent);return y}if(t==="list.number"){h=new N,p=e.getElementsByTagName("s"),c=p.length;for(d=0;d<c;d++)h.add(parseFloat(p[d].textContent));return h}if(t==="array.string")return e.textContent.split(",");if(t==="array.number"){h=e.textContent.split(","),c=h.length;for(d=0;d<c;d++)h[d]=parseFloat(h[d]);return h}return t==="rectangle"?{x:parseFloat(e.getAttribute("x")),y:parseFloat(e.getAttribute("y")),width:parseFloat(e.getAttribute("w")),height:parseFloat(e.getAttribute("h"))}:e.textContent}}),n.addMethod(n.Data,{serializeXml:function(e,t){if(this.__SizePropeties&&this.__SizePropeties.length){var n,r;for(n=0,r=this.__SizePropeties.length;n<r;n++)this.serializePropertyXml(e,this.__SizePropeties[n],t)}else this.serializePropertyXml(e,"materialSize",t),this.vertices&&this.vertices.length&&this.serializePropertyXml(e,"vertices",t),this.faces&&this.faces.length&&this.serializePropertyXml(e,"faces",t),this.uvs&&this.uvs.length&&this.serializePropertyXml(e,"uvs",t);if(e.settings.isClientSerializable&&this._clientMap)for(var i in this._clientMap)this.serializeClientXml(e,i,t);this.serializePropertyXml(e,"name",t),this.serializePropertyXml(e,"parent",t)},serializePropertyXml:function(e,t,n){e.serializePropertyXml(this,t,n)},serializeClientXml:function(e,t,n){e.serializeClientXml(this,t,n)},deserializeXml:function(e,t){var n=t.getElementsByTagName("p"),r=n.length,i,s,o,u;for(i=0;i<r;i++)s=n[i],s.hasAttribute("n")&&this.deserializePropertyXml(e,s,s.getAttribute("n"));if(e.settings.isClientSerializable){o=t.getElementsByTagName("c"),r=o.length;for(i=0;i<r;i++)u=o[i],u.hasAttribute("n")&&this.deserializeClientXml(e,u,u.getAttribute("n"))}},deserializePropertyXml:function(e,t,n){e.deserializePropertyXml(this,t,n)},deserializeClientXml:function(e,t,n){e.deserializeClientXml(this,t,n)}}),n.addMethod(n.Element,{serializeXml:function(e,t){if(e.settings.isStyleSerializable&&this.styleMap)for(var r in this.styleMap)this.isSideStyle(r)||this.serializeStyleXml(e,r,t);this.serializePropertyXml(e,"position",t),this.serializePropertyXml(e,"rotation",t),this.serializePropertyXml(e,"scale",t),n.Element.superClass.serializeXml.call(this,e,t),this._alarmState.getHighestNativeAlarmSeverity()&&e.settings.getPropertyType("alarmState")==="alarmstate"&&(e.xmlString+="	<p n='alarmState'>\n",n.AlarmSeverity.forEach(function(t){var n=this.getNewAlarmCount(t);n>0&&(e.xmlString+="		<n n='"+t.name+"' c='"+n+"'/>\n")},this._alarmState),n.AlarmSeverity.forEach(function(t){var n=this.getAcknowledgedAlarmCount(t);n>0&&(e.xmlString+="		<a n='"+t.name+"' c='"+n+"'/>\n")},this._alarmState),e.xmlString+="	</p>\n")},serializeStyleXml:function(e,t,n){e.serializeStyleXml(this,t,n)},deserializeXml:function(e,t){n.Element.superClass.deserializeXml.call(this,e,t);if(e.settings.isStyleSerializable){var r=t.getElementsByTagName("s"),i=r.length,s,o;for(s=0;s<i;s++)o=r[s],o.hasAttribute("n")&&this.deserializeStyleXml(e,o,o.getAttribute("n"))}},deserializeStyleXml:function(e,t,n){e.deserializeStyleXml(this,t,n)},deserializePropertyXml:function(e,t,r){if(r==="alarmState"){if(e.settings.getPropertyType("alarmState")==="alarmstate"){var i,s,o,u,a=t.getElementsByTagName("n");for(o=0;o<a.length;o++)u=a[o],s=twaver.AlarmSeverity.getByName(u.getAttribute("n")),this._alarmState.setNewAlarmCount(s,parseInt(u.getAttribute("c")));a=t.getElementsByTagName("a");for(o=0;o<a.length;o++)u=a[o],s=twaver.AlarmSeverity.getByName(u.getAttribute("n")),this._alarmState.setAcknowledgedAlarmCount(s,parseInt(u.getAttribute("c")))}}else n.Element.superClass.deserializePropertyXml.call(this,e,t,r)}}),n.addMethod(n.Serva,{serializeXml:function(e,t){if(e.settings.isClientSerializable&&this._clientMap)for(var n in this._clientMap)this.serializeClientXml(e,n,t);this.serializePropertyXml(e,"name",t)},serializePropertyXml:function(e,t,n){e.serializePropertyXml(this,t,n)},serializeClientXml:function(e,t,n){e.serializeClientXml(this,t,n)},deserializeXml:function(e,t){var n=t.getElementsByTagName("p"),r=n.length,i,s,o,u;for(i=0;i<r;i++)s=n[i],s.hasAttribute("n")&&this.deserializePropertyXml(e,s,s.getAttribute("n"));if(e.settings.isClientSerializable){o=t.getElementsByTagName("c"),r=o.length;for(i=0;i<r;i++)u=o[i],u.hasAttribute("n")&&this.deserializeClientXml(e,u,u.getAttribute("n"))}},deserializePropertyXml:function(e,t,n){e.deserializePropertyXml(this,t,n)},deserializeClientXml:function(e,t,n){e.deserializeClientXml(this,t,n)}}),n.JsonSerializer=function(e,t,r){this.dataBox=e,this.settings=t?t:new n.SerializationSettings,this.filterFunction=r,this.ref=0,this.refMap={},this.idMap={},this.jsonObject={}},n.extend(n.JsonSerializer,Object,{constructor:n.JsonSerializer,className:"TGL.JsonSerializer",serialize:function(){return this.jsonObject={v:n.version,platform:"html5"},this.serializeBody(),JSON.stringify(this.jsonObject)},serializeBody:function(){this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this);if(this.settings.isServaSerializable){var e={"class":this.dataBox.getClassName(),p:{},s:{},c:{}};this.jsonObject.dataBox=e,this.dataBox.serializeJson(this,this.dataBox.newInstance(),e),P.isEmptyObject(e.p)&&delete e.p,P.isEmptyObject(e.s)&&delete e.s,P.isEmptyObject(e.c)&&delete e.c}this.jsonObject.datas=[],this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(e){this.refMap[e.getId()]=this.ref++,e.getChildren().forEach(this.initRefs,this);if(e instanceof n.ComboNode)for(var t=0;t<e.combos.length;t++){var r=e.combos[t];this.refMap[r.getId()]||(this.refMap[r.getId()]=this.ref++)}},isSerializable:function(e){return this.dataBox.contains(e)?this.filterFunction&&!this.filterFunction(e)?!1:!0:!1},serializeData:function(e){if(this.isSerializable(e)){var t=e.newInstance(),n=this.refMap[e.getId()],r={"class":e.getClassName(),ref:n,p:{},s:{},c:{}};this.settings.getPropertyType("id")&&(this.jsonObject.id=e.getId()),this.jsonObject.datas.push(r),e.serializeJson(this,t,r),P.isEmptyObject(r.p)&&delete r.p,P.isEmptyObject(r.s)&&delete r.s,P.isEmptyObject(r.c)&&delete r.c}e.getChildren().forEach(this.serializeData,this)},serializeDataValue:function(e){var t=e.newInstance(),n=this.refMap[e.getId()],r={"class":e.getClassName(),ref:n,p:{},s:{},c:{}};return e.serializeJson(this,t,r),P.isEmptyObject(r.p)&&delete r.p,P.isEmptyObject(r.s)&&delete r.s,P.isEmptyObject(r.c)&&delete r.c,r},getPropertyType:function(e,t){var n=this.settings.getPropertyType(t);return n||(e.__bool&&e.__bool.indexOf(t)!=-1?n="boolean":e.__SizePropeties&&e.__SizePropeties.indexOf(t)!=-1&&(n="number")),n},getStyleType:function(e,t){e.isSideStyle(t)&&(t=t.substr(t.indexOf(".")+1));var n=this.settings.getStyleType(t);return n},serializePropertyJson:function(e,t,r,i){var s=this.getPropertyType(e,t);if(s){var o=n.getValue(e,t,s),u=n.getValue(r,t,s);o!==u&&(o&&o.equals?!o.equals(u)&&this.serializeValue(t,o,u,s,i.p):this.serializeValue(t,o,u,s,i.p))}},serializeStyleJson:function(e,t,n,r){var i=this.getStyleType(e,t);if(i){var s=e.getStyle(t),o=n.getStyle(t);t.startsWith("m.")&&(s=this.flattenArray(s),o=this.flattenArray(o)),t.endsWith(".image")&&(s=this.encodeURI(s),o=this.encodeURI(o)),s!=o&&(s&&s.equals?!s.equals(o)&&this.serializeValue(t,s,o,i,r.s):this.serializeValue(t,s,o,i,r.s))}},serializeClientJson:function(e,t,n,r){var i=this.settings.getClientType(t);if(i!=null){var s=e.getClient(t),o=n.getClient(t);s!=o&&(s&&s.equals?!s.equals(o)&&this.serializeValue(t,s,o,i,r.c):this.serializeValue(t,s,o,i,r.c))}},serializeValue:function(e,t,n,r,i){if(t==null)i[e]=null;else if(t instanceof N)i[e]=t._as;else if(r==="data"){var s=this.refMap[t.getId()];s!=null&&(i[e]=s)}else if(r==="data.list"){var o=[];for(var u=0;u<t.length;u++)o.push(this.serializeDataValue(t[u]));i[e]=o}else if(r==="serializeabe.list"){var o=[];for(var u=0;u<t.length;u++)o.push(t[u].serializeJsonValue());i[e]=o}else t.serializeJsonValue?i[e]=t.serializeJsonValue():i[e]=t},deserialize:function(e,t){n.isDeserializing=!0,this.jsonObject=JSON.parse(e),this.refMap={},this.idMap={};var r=new N,i=new N,s,o=this.jsonObject.datas.length;this.deserializeStartCreateData!=null&&this.deserializeStartCreateData(o);for(var u=0;u<o;u++){var a=this.jsonObject.datas[u],f=a["class"],l=this.settings.getPropertyType("id");if(l&&a.id!=null){if(a.action==="remove"){this.dataBox.removeById(a.id);continue}s=this.dataBox.getDataById(a.id),s||(s=n.newInstance(f,a.id))}else{var c={};s=n.newInstance(f)}a.ref!=null&&(this.refMap[a.ref]=s),r.add(s),i.add(a),this.idMap[s.getId()]=s,this.deserializeCreateData&&this.deserializeCreateData(u,o)}this.dataBox.forEach(function(e){this.idMap[e.getId()]=e},this),o=r.size(),this.deserializeStartFillData&&this.deserializeStartFillData(o);for(u=0;u<o;u++)s=r.get(u),s.deserializeJson(this,i.get(u)),this.deserializeFillData&&this.deserializeFillData(u,o);this.deserializeStartAddData&&this.deserializeStartAddData(o);for(u=0;u<o;u++){s=r.get(u);if(this.dataBox.containsById(s.getId()))continue;t&&!s.getParent()&&s.setParent(t),s.getClassName()==="TGL.Entity"&&(s.computed=!1,s.computeNodeData()),this.dataBox.add(s),this.deserializeAddData&&this.deserializeAddData(u,o)}this.settings.isServaSerializable&&this.jsonObject.dataBox&&this.dataBox.deserializeJson(this,this.jsonObject.dataBox),n.isDeserializing=!1},deserializePropertyJson:function(e,t,r){var i=this.getPropertyType(e,r);i&&n.setValue(e,r,this.deserializeValue(t,i))},deserializeStyleJson:function(e,t,n){var r=this.getStyleType(e,n);if(r){var i=this.deserializeValue(t,r);i._as&&(i=i._as),e.setStyle(n,i)}},deserializeClientJson:function(e,t,n){var r=this.settings.getClientType(n);r&&e.setClient(n,this.deserializeValue(t,r))},getClassName:function(e){if(e==null)return;if(e.class)return e.class;if(e.w!==t&&e.x!==t&&e.y!==t&&e.z!==t)return"TGL.Vec4";if(e.x!==t&&e.y!==t&&e.z!==t)return"TGL.XiangliangThree";if(e.x!==t&&e.y!==t)return"TGL.XiangliangTwo";if(e.a!==t&&e.b!==t&&e.c!==t&&e.d!==t)return"TGL.Face4";if(e.a!==t&&e.b!==t&&e.c!==t)return"TGL.Face3"},translateJson:function(e){if(e==null)return;if(this.getClassName(e)!=null){var t=n.newInstance(this.getClassName(e));if(t.deserializeJsonValue)t.deserializeJsonValue(e);else for(var r in e)t[r]=e[r];return t}if(e instanceof Array)for(var i=0;i<e.length;i++)e[i]=this.translateJson(e[i]);return e},isChinese:function(e){return e=e||"",escape(e).indexOf("%u")>0},encodeURI:function(e){if(e instanceof Array){for(var t=0;t<e.length;t++)e[t]=this.encodeURI(e[t]);return e}return typeof e=="string"&&this.isChinese(e)?encodeURI(e):e},flattenArray:function(e){if(e instanceof Array){for(var t=0;t<e.length-1;t++)if(e[t]!=e[t+1]){if(!e[t]||!e[t].equals)return e;if(!e[t].equals(e[t+1]))return e}return e[0]}return e},deserializeValue:function(e,r){if(r==="data"){var i=this.refMap[e];return i?i:this.idMap[e]}if(r==="data.list"){var s=[],o,u;for(var a=0;a<e.length;a++)o=e[a],u=n.newInstance(o.class),o.ref!=null&&(this.refMap[o.ref]=u),u.deserializeJson(this,o),s.push(u);return s}if(r==="color"&&e.r!=t){var f=new n.Color;return f.setRGB(e.r,e.g,e.b),f}if(e.class==="TGL.Path"){var l=new n.Path;return l.deserializeJsonValue(e),l}if(e instanceof Array){for(var a=0;a<e.length;a++)e[a]=this.translateJson(e[a]);return e}return this.getClassName(e)!=null?this.translateJson(e):e}}),n.addMethod(n.Serva,{serializeJson:function(e,t,n){if(e.settings.isClientSerializable&&this._clientMap)for(var r in this._clientMap)this.serializeClientJson(e,r,t,n);this.serializePropertyJson(e,"name",t,n)},serializePropertyJson:function(e,t,n,r){e.serializePropertyJson(this,t,n,r)},serializeClientJson:function(e,t,n,r){e.serializeClientJson(this,t,n,r)},deserializeJson:function(e,t){var n;for(n in t.p)this.deserializePropertyJson(e,t.p[n],n);if(e.settings.isClientSerializable)for(n in t.c)this.deserializeClientJson(e,t.c[n],n)},deserializePropertyJson:function(e,t,n){e.deserializePropertyJson(this,t,n)},deserializeClientJson:function(e,t,n){e.deserializeClientJson(this,t,n)}}),n.addMethod(n.Data,{serializeJson:function(e,t,r){if(this.__SizePropeties&&this.__SizePropeties.length){var i,s;for(i=0,s=this.__SizePropeties.length;i<s;i++)this.serializePropertyJson(e,this.__SizePropeties[i],t,r)}else this.materialSize&&this.serializePropertyJson(e,"materialSize",t,r),this instanceof n.Entity&&(this.vertices&&this.vertices.length&&this.serializePropertyJson(e,"vertices",t,r),this.faces&&this.faces.length&&this.serializePropertyJson(e,"faces",t,r),this.uvs&&this.uvs.length&&this.serializePropertyJson(e,"uvs",t,r),this.uv2s&&this.uv2s.length&&this.serializePropertyJson(e,"uv2s",t,r));if(e.settings.isClientSerializable&&this._clientMap)for(var o in this._clientMap)this.serializeClientJson(e,o,t,r);this.serializePropertyJson(e,"name",t,r),this.serializePropertyJson(e,"parent",t,r)},serializePropertyJson:function(e,t,n,r){e.serializePropertyJson(this,t,n,r)},serializeClientJson:function(e,t,n,r){e.serializeClientJson(this,t,n,r)},deserializeJson:function(e,t){var n;for(n in t.p)this.deserializePropertyJson(e,t.p[n],n);if(e.settings.isClientSerializable)for(n in t.c)this.deserializeClientJson(e,t.c[n],n)},deserializePropertyJson:function(e,t,n){e.deserializePropertyJson(this,t,n)},deserializeClientJson:function(e,t,n){e.deserializeClientJson(this,t,n)}}),n.addMethod(n.Element,{serializeJson:function(e,t,r){if(e.settings.isStyleSerializable&&this.styleMap)for(var i in this.styleMap)this.isSideStyle(i)||this.serializeStyleJson(e,i,t,r);n.Element.superClass.serializeJson.call(this,e,t,r),this.serializePropertyJson(e,"position",t,r),this.serializePropertyJson(e,"rotation",t,r),this.serializePropertyJson(e,"scale",t,r);if(this._alarmState.getHighestNativeAlarmSeverity()&&e.settings.getPropertyType("alarmState")==="alarmstate"){var s={n:{},a:{}};r.p.alarmState=s,n.AlarmSeverity.forEach(function(e){var t=this.getNewAlarmCount(e);t>0&&(s.n[e.name]=t)},this._alarmState),n.AlarmSeverity.forEach(function(e){var t=this.getAcknowledgedAlarmCount(e);t>0&&(s.a[e.name]=t)},this._alarmState),P.isEmptyObject(s.n)&&delete s.n,P.isEmptyObject(s.a)&&delete s.a,P.isEmptyObject(s)&&delete r.p.alarmState}},serializeStyleJson:function(e,t,n,r){e.serializeStyleJson(this,t,n,r)},deserializeJson:function(e,t){n.Element.superClass.deserializeJson.call(this,e,t);if(e.settings.isStyleSerializable)for(var r in t.s)this.deserializeStyleJson(e,t.s[r],r)},deserializeStyleJson:function(e,t,n){e.deserializeStyleJson(this,t,n)},deserializePropertyJson:function(e,t,r){if(r==="alarmState"){if(e.settings.getPropertyType("alarmState")==="alarmstate"){var i;for(i in t.n)this._alarmState.setNewAlarmCount(twaver.AlarmSeverity.getByName(i),t.n[i]);for(i in t.a)this._alarmState.setAcknowledgedAlarmCount(twaver.AlarmSeverity.getByName(i),t.a[i])}}else n.Element.superClass.deserializePropertyJson.call(this,e,t,r)}}),n.addMethod(n.Light,{serializeJson:function(e,t,r){n.Light.superClass.serializeJson.call(this,e,t,r),this.serializePropertyJson(e,"color",t,r),this.serializePropertyJson(e,"ambient",t,r),this.serializePropertyJson(e,"diffuse",t,r),this.serializePropertyJson(e,"specular",t,r),this.serializePropertyJson(e,"castShadow",t,r),this.serializePropertyJson(e,"onlyShadow",t,r);if(t.__accessor&&t.__accessor.length)for(var i=0;i<t.__accessor.length;i++)this.serializePropertyJson(e,t.__accessor[i],t,r)}});var Ni=n.Animate=function(e){var t=this;t.type=e.type==null?"number":e.type,t.delay=e.delay==null?0:e.delay,t.dur=e.dur==null?1e3:e.dur,t.interval=e.interval==null?0:e.interval,t.finish=e.finish==null?t.delay+t.dur+t.interval:e.finish,t.repeat=e.repeat==null?1:e.repeat,t.reverse=e.reverse==null?!0:e.reverse,t.easing=e.easing==null?"easeNone":e.easing,t.onUpdate=e.onUpdate,t.onDone=e.onDone,t.onStop=e.onStop,t.onPlay=e.onPlay,t.attr=e.attr,t.source=e.source,t.filter=e.filter,t.from=e.from,t.to=e.to,t.start=null,t.time=0,t.total=0,t.count=0,t.started=!1,t.stopped=!1,t.id=Hi++};n.extend(n.Animate,Object,{play:function(){return Ci(this)},stop:function(e){return Ai(this,e)},clone:function(){return new Ni(this)},chain:function(e){var t=this,n;return t.onDone?(n=t.onDone,t.onDone=function(){n.call(t),e.play()}):t.onDone=function(){e.play()},t}});var Pi={},Hi=1,Bi=!1;(function ji(e){requestAnimationFrame(ji),Bi&&(Bi=!1,Mi(e))})(0)})(window);
!function(a,b){function c(a,b,c){null!=a&&("number"==typeof a?this.fromNumber(a,b,c):null==b&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))}function d(){return new c(null)}function e(a,b,c,d,e,f){for(;--f>=0;){var g=b*this[a++]+c[d]+e;e=Math.floor(g/67108864),c[d++]=67108863&g}return e}function f(a,b,c,d,e,f){for(var g=32767&b,h=b>>15;--f>=0;){var i=32767&this[a],j=this[a++]>>15,k=h*i+j*g;i=g*i+((32767&k)<<15)+c[d]+(1073741823&e),e=(i>>>30)+(k>>>15)+h*j+(e>>>30),c[d++]=1073741823&i}return e}function g(a,b,c,d,e,f){for(var g=16383&b,h=b>>14;--f>=0;){var i=16383&this[a],j=this[a++]>>14,k=h*i+j*g;i=g*i+((16383&k)<<14)+c[d]+e,e=(i>>28)+(k>>14)+h*j,c[d++]=268435455&i}return e}function h(a){return dc.charAt(a)}function j(a,b){var c=ec[a.charCodeAt(b)];return null==c?-1:c}function k(a){for(var b=this.t-1;b>=0;--b)a[b]=this[b];a.t=this.t,a.s=this.s}function l(a){this.t=1,this.s=0>a?-1:0,a>0?this[0]=a:-1>a?this[0]=a+DV:this.t=0}function m(a){var b=d();return b.fromInt(a),b}function n(a,b){var d;if(16==b)d=4;else if(8==b)d=3;else if(256==b)d=8;else if(2==b)d=1;else if(32==b)d=5;else{if(4!=b)return void this.fromRadix(a,b);d=2}this.t=0,this.s=0;for(var e=a.length,f=!1,g=0;--e>=0;){var h=8==d?255&a[e]:j(a,e);0>h?"-"==a.charAt(e)&&(f=!0):(f=!1,0==g?this[this.t++]=h:g+d>this.DB?(this[this.t-1]|=(h&(1<<this.DB-g)-1)<<g,this[this.t++]=h>>this.DB-g):this[this.t-1]|=h<<g,g+=d,g>=this.DB&&(g-=this.DB))}8==d&&0!=(128&a[0])&&(this.s=-1,g>0&&(this[this.t-1]|=(1<<this.DB-g)-1<<g)),this.clamp(),f&&c.ZERO.subTo(this,this)}function o(){for(var a=this.s&this.DM;this.t>0&&this[this.t-1]==a;)--this.t}function p(a){if(this.s<0)return"-"+this.negate().toString(a);var b;if(16==a)b=4;else if(8==a)b=3;else if(2==a)b=1;else if(32==a)b=5;else{if(4!=a)return this.toRadix(a);b=2}var c,d=(1<<b)-1,e=!1,f="",g=this.t,i=this.DB-g*this.DB%b;if(g-->0)for(i<this.DB&&(c=this[g]>>i)>0&&(e=!0,f=h(c));g>=0;)b>i?(c=(this[g]&(1<<i)-1)<<b-i,c|=this[--g]>>(i+=this.DB-b)):(c=this[g]>>(i-=b)&d,0>=i&&(i+=this.DB,--g)),c>0&&(e=!0),e&&(f+=h(c));return e?f:"0"}function q(){var a=d();return c.ZERO.subTo(this,a),a}function r(){return this.s<0?this.negate():this}function s(a){var b=this.s-a.s;if(0!=b)return b;var c=this.t;if(b=c-a.t,0!=b)return b;for(;--c>=0;)if(0!=(b=this[c]-a[c]))return b;return 0}function t(a){var b,c=1;return 0!=(b=a>>>16)&&(a=b,c+=16),0!=(b=a>>8)&&(a=b,c+=8),0!=(b=a>>4)&&(a=b,c+=4),0!=(b=a>>2)&&(a=b,c+=2),0!=(b=a>>1)&&(a=b,c+=1),c}function u(){return this.t<=0?0:this.DB*(this.t-1)+t(this[this.t-1]^this.s&this.DM)}function v(a,b){var c;for(c=this.t-1;c>=0;--c)b[c+a]=this[c];for(c=a-1;c>=0;--c)b[c]=0;b.t=this.t+a,b.s=this.s}function w(a,b){for(var c=a;c<this.t;++c)b[c-a]=this[c];b.t=Math.max(this.t-a,0),b.s=this.s}function x(a,b){var c,d=a%this.DB,e=this.DB-d,f=(1<<e)-1,g=Math.floor(a/this.DB),h=this.s<<d&this.DM;for(c=this.t-1;c>=0;--c)b[c+g+1]=this[c]>>e|h,h=(this[c]&f)<<d;for(c=g-1;c>=0;--c)b[c]=0;b[g]=h,b.t=this.t+g+1,b.s=this.s,b.clamp()}function y(a,b){b.s=this.s;var c=Math.floor(a/this.DB);if(c>=this.t)return void(b.t=0);var d=a%this.DB,e=this.DB-d,f=(1<<d)-1;b[0]=this[c]>>d;for(var g=c+1;g<this.t;++g)b[g-c-1]|=(this[g]&f)<<e,b[g-c]=this[g]>>d;d>0&&(b[this.t-c-1]|=(this.s&f)<<e),b.t=this.t-c,b.clamp()}function z(a,b){for(var c=0,d=0,e=Math.min(a.t,this.t);e>c;)d+=this[c]-a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){for(d-=a.s;c<this.t;)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;c<a.t;)d-=a[c],b[c++]=d&this.DM,d>>=this.DB;d-=a.s}b.s=0>d?-1:0,-1>d?b[c++]=this.DV+d:d>0&&(b[c++]=d),b.t=c,b.clamp()}function A(a,b){var d=this.abs(),e=a.abs(),f=d.t;for(b.t=f+e.t;--f>=0;)b[f]=0;for(f=0;f<e.t;++f)b[f+d.t]=d.am(0,e[f],b,f,0,d.t);b.s=0,b.clamp(),this.s!=a.s&&c.ZERO.subTo(b,b)}function B(a){for(var b=this.abs(),c=a.t=2*b.t;--c>=0;)a[c]=0;for(c=0;c<b.t-1;++c){var d=b.am(c,b[c],a,2*c,0,1);(a[c+b.t]+=b.am(c+1,2*b[c],a,2*c+1,d,b.t-c-1))>=b.DV&&(a[c+b.t]-=b.DV,a[c+b.t+1]=1)}a.t>0&&(a[a.t-1]+=b.am(c,b[c],a,2*c,0,1)),a.s=0,a.clamp()}function C(a,b,e){var f=a.abs();if(!(f.t<=0)){var g=this.abs();if(g.t<f.t)return null!=b&&b.fromInt(0),void(null!=e&&this.copyTo(e));null==e&&(e=d());var h=d(),i=this.s,j=a.s,k=this.DB-t(f[f.t-1]);k>0?(f.lShiftTo(k,h),g.lShiftTo(k,e)):(f.copyTo(h),g.copyTo(e));var l=h.t,m=h[l-1];if(0!=m){var n=m*(1<<this.F1)+(l>1?h[l-2]>>this.F2:0),o=this.FV/n,p=(1<<this.F1)/n,q=1<<this.F2,r=e.t,s=r-l,u=null==b?d():b;for(h.dlShiftTo(s,u),e.compareTo(u)>=0&&(e[e.t++]=1,e.subTo(u,e)),c.ONE.dlShiftTo(l,u),u.subTo(h,h);h.t<l;)h[h.t++]=0;for(;--s>=0;){var v=e[--r]==m?this.DM:Math.floor(e[r]*o+(e[r-1]+q)*p);if((e[r]+=h.am(0,v,e,s,0,l))<v)for(h.dlShiftTo(s,u),e.subTo(u,e);e[r]<--v;)e.subTo(u,e)}null!=b&&(e.drShiftTo(l,b),i!=j&&c.ZERO.subTo(b,b)),e.t=l,e.clamp(),k>0&&e.rShiftTo(k,e),0>i&&c.ZERO.subTo(e,e)}}}function D(a){var b=d();return this.abs().divRemTo(a,null,b),this.s<0&&b.compareTo(c.ZERO)>0&&a.subTo(b,b),b}function E(a){this.m=a}function F(a){return a.s<0||a.compareTo(this.m)>=0?a.mod(this.m):a}function G(a){return a}function H(a){a.divRemTo(this.m,null,a)}function I(a,b,c){a.multiplyTo(b,c),this.reduce(c)}function J(a,b){a.squareTo(b),this.reduce(b)}function K(){if(this.t<1)return 0;var a=this[0];if(0==(1&a))return 0;var b=3&a;return b=b*(2-(15&a)*b)&15,b=b*(2-(255&a)*b)&255,b=b*(2-((65535&a)*b&65535))&65535,b=b*(2-a*b%this.DV)%this.DV,b>0?this.DV-b:-b}function L(a){this.m=a,this.mp=a.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<a.DB-15)-1,this.mt2=2*a.t}function M(a){var b=d();return a.abs().dlShiftTo(this.m.t,b),b.divRemTo(this.m,null,b),a.s<0&&b.compareTo(c.ZERO)>0&&this.m.subTo(b,b),b}function N(a){var b=d();return a.copyTo(b),this.reduce(b),b}function O(a){for(;a.t<=this.mt2;)a[a.t++]=0;for(var b=0;b<this.m.t;++b){var c=32767&a[b],d=c*this.mpl+((c*this.mph+(a[b]>>15)*this.mpl&this.um)<<15)&a.DM;for(c=b+this.m.t,a[c]+=this.m.am(0,d,a,b,0,this.m.t);a[c]>=a.DV;)a[c]-=a.DV,a[++c]++}a.clamp(),a.drShiftTo(this.m.t,a),a.compareTo(this.m)>=0&&a.subTo(this.m,a)}function P(a,b){a.squareTo(b),this.reduce(b)}function Q(a,b,c){a.multiplyTo(b,c),this.reduce(c)}function R(){return 0==(this.t>0?1&this[0]:this.s)}function S(a,b){if(a>4294967295||1>a)return c.ONE;var e=d(),f=d(),g=b.convert(this),h=t(a)-1;for(g.copyTo(e);--h>=0;)if(b.sqrTo(e,f),(a&1<<h)>0)b.mulTo(f,g,e);else{var i=e;e=f,f=i}return b.revert(e)}function T(a,b){var c;return c=256>a||b.isEven()?new E(b):new L(b),this.exp(a,c)}function U(){var a=d();return this.copyTo(a),a}function V(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function W(){return 0==this.t?this.s:this[0]<<24>>24}function X(){return 0==this.t?this.s:this[0]<<16>>16}function Y(a){return Math.floor(Math.LN2*this.DB/Math.log(a))}function Z(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function $(a){if(null==a&&(a=10),0==this.signum()||2>a||a>36)return"0";var b=this.chunkSize(a),c=Math.pow(a,b),e=m(c),f=d(),g=d(),h="";for(this.divRemTo(e,f,g);f.signum()>0;)h=(c+g.intValue()).toString(a).substr(1)+h,f.divRemTo(e,f,g);return g.intValue().toString(a)+h}function _(a,b){this.fromInt(0),null==b&&(b=10);for(var d=this.chunkSize(b),e=Math.pow(b,d),f=!1,g=0,h=0,i=0;i<a.length;++i){var k=j(a,i);0>k?"-"==a.charAt(i)&&0==this.signum()&&(f=!0):(h=b*h+k,++g>=d&&(this.dMultiply(e),this.dAddOffset(h,0),g=0,h=0))}g>0&&(this.dMultiply(Math.pow(b,g)),this.dAddOffset(h,0)),f&&c.ZERO.subTo(this,this)}function aa(a,b,d){if("number"==typeof b)if(2>a)this.fromInt(1);else for(this.fromNumber(a,d),this.testBit(a-1)||this.bitwiseTo(c.ONE.shiftLeft(a-1),ia,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(b);)this.dAddOffset(2,0),this.bitLength()>a&&this.subTo(c.ONE.shiftLeft(a-1),this);else{var e=new Array,f=7&a;e.length=(a>>3)+1,b.nextBytes(e),f>0?e[0]&=(1<<f)-1:e[0]=0,this.fromString(e,256)}}function ba(){var a=this.t,b=new Array;b[0]=this.s;var c,d=this.DB-a*this.DB%8,e=0;if(a-->0)for(d<this.DB&&(c=this[a]>>d)!=(this.s&this.DM)>>d&&(b[e++]=c|this.s<<this.DB-d);a>=0;)8>d?(c=(this[a]&(1<<d)-1)<<8-d,c|=this[--a]>>(d+=this.DB-8)):(c=this[a]>>(d-=8)&255,0>=d&&(d+=this.DB,--a)),0!=(128&c)&&(c|=-256),0==e&&(128&this.s)!=(128&c)&&++e,(e>0||c!=this.s)&&(b[e++]=c);return b}function ca(a){return 0==this.compareTo(a)}function da(a){return this.compareTo(a)<0?this:a}function ea(a){return this.compareTo(a)>0?this:a}function fa(a,b,c){var d,e,f=Math.min(a.t,this.t);for(d=0;f>d;++d)c[d]=b(this[d],a[d]);if(a.t<this.t){for(e=a.s&this.DM,d=f;d<this.t;++d)c[d]=b(this[d],e);c.t=this.t}else{for(e=this.s&this.DM,d=f;d<a.t;++d)c[d]=b(e,a[d]);c.t=a.t}c.s=b(this.s,a.s),c.clamp()}function ga(a,b){return a&b}function ha(a){var b=d();return this.bitwiseTo(a,ga,b),b}function ia(a,b){return a|b}function ja(a){var b=d();return this.bitwiseTo(a,ia,b),b}function ka(a,b){return a^b}function la(a){var b=d();return this.bitwiseTo(a,ka,b),b}function ma(a,b){return a&~b}function na(a){var b=d();return this.bitwiseTo(a,ma,b),b}function oa(){for(var a=d(),b=0;b<this.t;++b)a[b]=this.DM&~this[b];return a.t=this.t,a.s=~this.s,a}function pa(a){var b=d();return 0>a?this.rShiftTo(-a,b):this.lShiftTo(a,b),b}function qa(a){var b=d();return 0>a?this.lShiftTo(-a,b):this.rShiftTo(a,b),b}function ra(a){if(0==a)return-1;var b=0;return 0==(65535&a)&&(a>>=16,b+=16),0==(255&a)&&(a>>=8,b+=8),0==(15&a)&&(a>>=4,b+=4),0==(3&a)&&(a>>=2,b+=2),0==(1&a)&&++b,b}function sa(){for(var a=0;a<this.t;++a)if(0!=this[a])return a*this.DB+ra(this[a]);return this.s<0?this.t*this.DB:-1}function ta(a){for(var b=0;0!=a;)a&=a-1,++b;return b}function ua(){for(var a=0,b=this.s&this.DM,c=0;c<this.t;++c)a+=ta(this[c]^b);return a}function va(a){var b=Math.floor(a/this.DB);return b>=this.t?0!=this.s:0!=(this[b]&1<<a%this.DB)}function wa(a,b){var d=c.ONE.shiftLeft(a);return this.bitwiseTo(d,b,d),d}function xa(a){return this.changeBit(a,ia)}function ya(a){return this.changeBit(a,ma)}function za(a){return this.changeBit(a,ka)}function Aa(a,b){for(var c=0,d=0,e=Math.min(a.t,this.t);e>c;)d+=this[c]+a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){for(d+=a.s;c<this.t;)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;c<a.t;)d+=a[c],b[c++]=d&this.DM,d>>=this.DB;d+=a.s}b.s=0>d?-1:0,d>0?b[c++]=d:-1>d&&(b[c++]=this.DV+d),b.t=c,b.clamp()}function Ba(a){var b=d();return this.addTo(a,b),b}function Ca(a){var b=d();return this.subTo(a,b),b}function Da(a){var b=d();return this.multiplyTo(a,b),b}function Ea(){var a=d();return this.squareTo(a),a}function Fa(a){var b=d();return this.divRemTo(a,b,null),b}function Ga(a){var b=d();return this.divRemTo(a,null,b),b}function Ha(a){var b=d(),c=d();return this.divRemTo(a,b,c),new Array(b,c)}function Ia(a){this[this.t]=this.am(0,a-1,this,0,0,this.t),++this.t,this.clamp()}function Ja(a,b){if(0!=a){for(;this.t<=b;)this[this.t++]=0;for(this[b]+=a;this[b]>=this.DV;)this[b]-=this.DV,++b>=this.t&&(this[this.t++]=0),++this[b]}}function Ka(){}function La(a){return a}function Ma(a,b,c){a.multiplyTo(b,c)}function Na(a,b){a.squareTo(b)}function Oa(a){return this.exp(a,new Ka)}function Pa(a,b,c){var d=Math.min(this.t+a.t,b);for(c.s=0,c.t=d;d>0;)c[--d]=0;var e;for(e=c.t-this.t;e>d;++d)c[d+this.t]=this.am(0,a[d],c,d,0,this.t);for(e=Math.min(a.t,b);e>d;++d)this.am(0,a[d],c,d,0,b-d);c.clamp()}function Qa(a,b,c){--b;var d=c.t=this.t+a.t-b;for(c.s=0;--d>=0;)c[d]=0;for(d=Math.max(b-this.t,0);d<a.t;++d)c[this.t+d-b]=this.am(b-d,a[d],c,0,0,this.t+d-b);c.clamp(),c.drShiftTo(1,c)}function Ra(a){this.r2=d(),this.q3=d(),c.ONE.dlShiftTo(2*a.t,this.r2),this.mu=this.r2.divide(a),this.m=a}function Sa(a){if(a.s<0||a.t>2*this.m.t)return a.mod(this.m);if(a.compareTo(this.m)<0)return a;var b=d();return a.copyTo(b),this.reduce(b),b}function Ta(a){return a}function Ua(a){for(a.drShiftTo(this.m.t-1,this.r2),a.t>this.m.t+1&&(a.t=this.m.t+1,a.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);a.compareTo(this.r2)<0;)a.dAddOffset(1,this.m.t+1);for(a.subTo(this.r2,a);a.compareTo(this.m)>=0;)a.subTo(this.m,a)}function Va(a,b){a.squareTo(b),this.reduce(b)}function Wa(a,b,c){a.multiplyTo(b,c),this.reduce(c)}function Xa(a,b){var c,e,f=a.bitLength(),g=m(1);if(0>=f)return g;c=18>f?1:48>f?3:144>f?4:768>f?5:6,e=8>f?new E(b):b.isEven()?new Ra(b):new L(b);var h=new Array,i=3,j=c-1,k=(1<<c)-1;if(h[1]=e.convert(this),c>1){var l=d();for(e.sqrTo(h[1],l);k>=i;)h[i]=d(),e.mulTo(l,h[i-2],h[i]),i+=2}var n,o,p=a.t-1,q=!0,r=d();for(f=t(a[p])-1;p>=0;){for(f>=j?n=a[p]>>f-j&k:(n=(a[p]&(1<<f+1)-1)<<j-f,p>0&&(n|=a[p-1]>>this.DB+f-j)),i=c;0==(1&n);)n>>=1,--i;if((f-=i)<0&&(f+=this.DB,--p),q)h[n].copyTo(g),q=!1;else{for(;i>1;)e.sqrTo(g,r),e.sqrTo(r,g),i-=2;i>0?e.sqrTo(g,r):(o=g,g=r,r=o),e.mulTo(r,h[n],g)}for(;p>=0&&0==(a[p]&1<<f);)e.sqrTo(g,r),o=g,g=r,r=o,--f<0&&(f=this.DB-1,--p)}return e.revert(g)}function Ya(a){var b=this.s<0?this.negate():this.clone(),c=a.s<0?a.negate():a.clone();if(b.compareTo(c)<0){var d=b;b=c,c=d}var e=b.getLowestSetBit(),f=c.getLowestSetBit();if(0>f)return b;for(f>e&&(f=e),f>0&&(b.rShiftTo(f,b),c.rShiftTo(f,c));b.signum()>0;)(e=b.getLowestSetBit())>0&&b.rShiftTo(e,b),(e=c.getLowestSetBit())>0&&c.rShiftTo(e,c),b.compareTo(c)>=0?(b.subTo(c,b),b.rShiftTo(1,b)):(c.subTo(b,c),c.rShiftTo(1,c));return f>0&&c.lShiftTo(f,c),c}function Za(a){if(0>=a)return 0;var b=this.DV%a,c=this.s<0?a-1:0;if(this.t>0)if(0==b)c=this[0]%a;else for(var d=this.t-1;d>=0;--d)c=(b*c+this[d])%a;return c}function $a(a){var b=a.isEven();if(this.isEven()&&b||0==a.signum())return c.ZERO;for(var d=a.clone(),e=this.clone(),f=m(1),g=m(0),h=m(0),i=m(1);0!=d.signum();){for(;d.isEven();)d.rShiftTo(1,d),b?(f.isEven()&&g.isEven()||(f.addTo(this,f),g.subTo(a,g)),f.rShiftTo(1,f)):g.isEven()||g.subTo(a,g),g.rShiftTo(1,g);for(;e.isEven();)e.rShiftTo(1,e),b?(h.isEven()&&i.isEven()||(h.addTo(this,h),i.subTo(a,i)),h.rShiftTo(1,h)):i.isEven()||i.subTo(a,i),i.rShiftTo(1,i);d.compareTo(e)>=0?(d.subTo(e,d),b&&f.subTo(h,f),g.subTo(i,g)):(e.subTo(d,e),b&&h.subTo(f,h),i.subTo(g,i))}return 0!=e.compareTo(c.ONE)?c.ZERO:i.compareTo(a)>=0?i.subtract(a):i.signum()<0?(i.addTo(a,i),i.signum()<0?i.add(a):i):i}function _a(a){var b,c=this.abs();if(1==c.t&&c[0]<=fc[fc.length-1]){for(b=0;b<fc.length;++b)if(c[0]==fc[b])return!0;return!1}if(c.isEven())return!1;for(b=1;b<fc.length;){for(var d=fc[b],e=b+1;e<fc.length&&gc>d;)d*=fc[e++];for(d=c.modInt(d);e>b;)if(d%fc[b++]==0)return!1}return c.millerRabin(a)}function ab(a){var b=this.subtract(c.ONE),e=b.getLowestSetBit();if(0>=e)return!1;var f=b.shiftRight(e);a=a+1>>1,a>fc.length&&(a=fc.length);for(var g=d(),h=0;a>h;++h){g.fromInt(fc[Math.floor(Math.random()*fc.length)]);var i=g.modPow(f,this);if(0!=i.compareTo(c.ONE)&&0!=i.compareTo(b)){for(var j=1;j++<e&&0!=i.compareTo(b);)if(i=i.modPowInt(2,this),0==i.compareTo(c.ONE))return!1;if(0!=i.compareTo(b))return!1}}return!0}function bb(){this.i=0,this.j=0,this.S=new Array}function cb(a){var b,c,d;for(b=0;256>b;++b)this.S[b]=b;for(c=0,b=0;256>b;++b)c=c+this.S[b]+a[b%a.length]&255,d=this.S[b],this.S[b]=this.S[c],this.S[c]=d;this.i=0,this.j=0}function db(){var a;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,a=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=a,this.S[a+this.S[this.i]&255]}function eb(){return new bb}function fb(a){ic[jc++]^=255&a,ic[jc++]^=a>>8&255,ic[jc++]^=a>>16&255,ic[jc++]^=a>>24&255,jc>=kc&&(jc-=kc)}function gb(){fb((new Date).getTime())}function hb(){if(null==hc){for(gb(),hc=eb(),hc.init(ic),jc=0;jc<ic.length;++jc)ic[jc]=0;jc=0}return hc.next()}function ib(a){var b;for(b=0;b<a.length;++b)a[b]=hb()}function jb(){}function kb(a,b){return new c(a,b)}function lb(a,b){if(b<a.length+11)return null;for(var d=new Array,e=a.length-1;e>=0&&b>0;){var f=a.charCodeAt(e--);128>f?d[--b]=f:f>127&&2048>f?(d[--b]=63&f|128,d[--b]=f>>6|192):(d[--b]=63&f|128,d[--b]=f>>6&63|128,d[--b]=f>>12|224)}d[--b]=0;for(var g=new jb,h=new Array;b>2;){for(h[0]=0;0==h[0];)g.nextBytes(h);d[--b]=h[0]}return d[--b]=2,d[--b]=0,new c(d)}function mb(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function nb(a,b){this.n=kb(a,16),this.e=parseInt(b,16)}function ob(a){return a.modPowInt(this.e,this.n)}function pb(a){var b=lb(a,this.n.bitLength()+7>>3);if(null==b)return null;var c=this.doPrivate(b);if(null==c)return null;var d=c.toString(16);return 0==(1&d.length)?d:"0"+d}function qb(a,b){for(var c=a.toByteArray(),d=0;d<c.length&&0==c[d];)++d;if(c.length-d!=b-1||2!=c[d])return null;for(++d;0!=c[d];)if(++d>=c.length)return null;for(var e="";++d<c.length;){var f=255&c[d];128>f?e+=String.fromCharCode(f):f>191&&224>f?(e+=String.fromCharCode((31&f)<<6|63&c[d+1]),++d):(e+=String.fromCharCode((15&f)<<12|(63&c[d+1])<<6|63&c[d+2]),d+=2)}return e}function rb(a,b,c){this.n=kb(a,16),this.e=parseInt(b,16),this.d=kb(c,16)}function sb(a,b,c,d,e,f,g,h){this.n=kb(a,16),this.e=parseInt(b,16),this.d=kb(c,16),this.p=kb(d,16),this.q=kb(e,16),this.dmp1=kb(f,16),this.dmq1=kb(g,16),this.coeff=kb(h,16)}function tb(a){if(null==this.p||null==this.q)return a.modPow(this.d,this.n);for(var b=a.mod(this.p).modPow(this.dmp1,this.p),c=a.mod(this.q).modPow(this.dmq1,this.q);b.compareTo(c)<0;)b=b.add(this.p);return b.subtract(c).multiply(this.coeff).mod(this.p).multiply(this.q).add(c)}function ub(a){var b=kb(a,16),c=this.doPublic(b);return null==c?null:qb(c,this.n.bitLength()+7>>3)}function vb(a,b,c){var d=0,e=0,f=b.split("\n"),g=2*a.measureText("e").width;return f.forEach(function(b){if(c){var f,h,i,j,k,l=b.split(" "),m=l.length,n="";for(i=0;m>i;i++)if(f=l[i]+(i===m-1?"":" "),h=n+f,j=a.measureText(h).width,c>j)n=h;else if(j==c)n="",e+=g;else{for(k=0;k<f.length;k++)if(h=n+f.substr(0,k+1),a.measureText(h).width>c){n=f.substring(k,f.length),e+=g;break}for(;n.length>0&&a.measureText(n).width>c;)for(k=0;k<n.length;k++)if(h=n.substr(0,k+1),a.measureText(h).width>c){n=n.substring(k,n.length),e+=g;break}}}else j=a.measureText(b).width,d=j>d?j:d;e+=g}),d=c?c:d,{w:d,h:e}}function wb(a,b,c,d){var e,f=a.animate,g=d._now,h=d._shapeDataIndex,i=c._animates;if(i||(i=c._animates={}),h.length)for(var j=0;j<h.length;j++){e=h[j];var k=i[e];k||(k=i[e]={}),i=k}else e=h;var l=i[e];l||(l=i[e]={},f.forEach(function(e){var f,h=e.attr,i=l[h];e={attr:h,to:e.to,type:e.type||"number",delay:e.delay||0,dur:e.dur||1e3,interval:e.interval||0,finish:e.finish,repeat:e.repeat||1,reverse:null==e.reverse?!0:e.reverse,onDone:e.onDone,easing:e.easing,trigger:null==e.to,start:g,time:0,total:0,count:0,started:!1,stopped:!1,current:null},Array.isArray(e.dur)&&(e.groupDur=e.dur.slice(0,e.dur.length-1),e.dur=e.dur[e.dur.length-1],e.groupDurTotal=e.groupDur.reduce(function(a,b,c){return e.groupDur[c]=a+b},0),e.groupIndex=0,e.groupTime=0,e.groupStart=g),null==e.finish&&(e.finish=e.delay+e.dur+e.interval),i?Array.isArray(i)?(i.push(e),i=i[i.length-2]):l[h]=[i,e]:(f=Yc(c,b,a,h,d),l[h]=e),i&&(f=i.to,"group_set"===i.type&&(f=f[f.length-1])),e.from=f,e.trigger||(e.started=!0,Fb(e),Gb(e))})),f=l,Object.keys(f).forEach(function(e){var h=f[e];if(Array.isArray(h)){var i=h[h.length-1];i.count+1===i.repeat?h.forEach(function(e){xb(e,a,b,c,d,!0)}):i.count+1<i.repeat&&(i.total>=i.finish&&h.forEach(function(a){a.trigger||(a.started=!0),a.stopped=!1,a.time=0,a.start=g,a.total=0,"group_set"===a.type&&(a.groupIndex=0,a.groupTime=0,a.groupStart=g)}),h.forEach(function(e){xb(e,a,b,c,d,!1)}))}else xb(h,a,b,c,d,!0)})}function xb(a,b,c,d,e,f){if(a.trigger){var g=Yc(d,c,b,a.attr,e,null,!1);if(!a.started){if(g===a.from)return;a.started=!0,a.start=e._now,a.to=g,Fb(a),Gb(a)}a.started&&g!==a.to&&(a.start=e._now,a.from=a.current,a.to=g,a.time=0,a.total=0,a.count=0,Fb(a),Gb(a))}if(a.started&&!a.stopped){var h=e._now,i=h-a.start;if(i>=a.delay&&(a.total=i,i-=a.delay,a.time=i>a.dur?a.dur:i,"group_set"===a.type&&(a.groupTime=h-a.groupStart,a.groupStart===a.start&&(a.groupTime-=a.delay),a.groupTime>=a.groupDur[a.groupIndex]&&a.groupIndex++,a.groupTime>=a.groupDurTotal&&(a.groupIndex=0,a.groupTime=a.groupTime-a.groupDurTotal,a.groupStart=h)),a.total>=a.finish))if(a.count++,"group_set"===a.type,a.count>=a.repeat)a.time=a.dur,a.stopped=!0,a.trigger&&(a.from=a.to,a.to=null,a.start=null,a.time=0,a.total=0,a.count=0,a.started=!1,a.stopped=!1),a.onDone&&a.onDone.call(c,d,e);else if(f&&(a.time=0,a.start=h,a.total=0,a.reverse)){var j=a.from;a.from=a.to,a.to=j,Gb(a)}e&&!e._invalidate&&(e._invalidate=!0)}}function yb(a){if(!hd[a.id]){if(jd=!0,hd[a.id]=a,null==a.from&&a.attr&&a.source){var b;a.from=(b=a.attr.match(/^S[:@](.*)/i))?a.source.getStyle(b[1]):(b=a.attr.match(/^C[:@](.*)/i))?a.source.getClient(b[1]):Ib.Util.getValue(a.source,a.attr)}Fb(a),Gb(a)}return a.resume(),a}function zb(a,b){return hd[a.id]&&(null==b&&(b=!0),b&&Eb(a,a.to),a.onStop&&a.onStop(),a.time=0,a.total=0,a.start=null,a.count=0,a.started=!1,a.stopped=!1,a.paused=!1,a.pausedTime=null,a.pausedTotal=0,a._oldSpeed=null,a._speedTotal=0,a._speedTime=null,a._percent=0,a._percentSet=null,a._percentDiff=0,delete hd[a.id]),a}function Ab(a){null==a&&(a=!0),Object.keys(hd).forEach(function(b){var c=hd[b];c&&(a&&Eb(c,c.to),c.onStop&&c.onStop())}),hd={}}function Bb(){Object.keys(hd).forEach(function(a){var b=hd[a];b&&b.pause()})}function Cb(){Object.keys(hd).forEach(function(a){var b=hd[a];b&&b.resume()})}function Db(a){Object.keys(hd).forEach(function(b){var c=hd[b];if(c&&(null==c.start&&(c._speedTime=c.start=a),null!=c._percentSet&&(c._percentDiff+=(c._percentSet-c._percent)*c.finish),!c.paused||(c.pausedTime||(c.pausedTime=a),null!=c._percentSet))){if(null==c._percentSet&&c.pausedTime&&(c.pausedTotal+=(a-c.pausedTime)*(c._oldSpeed||c._speed),c.pausedTime=null),c._oldSpeed&&!c.pausedTime&&(c._speedTotal=(a-c._speedTime)*c._oldSpeed-c.pausedTotal+c._percentDiff+c._speedTotal,c._percentDiff=0,c.pausedTotal=0,c._speedTime=a,c._oldSpeed=null),c.total=(a-c._speedTime)*c._speed-c.pausedTotal+c._percentDiff+c._speedTotal,null!=c._percentSet&&c.pausedTime&&(c.total-=(a-c.pausedTime)*(c._oldSpeed||c._speed)),c._percent=c.total>=c.finish?1:c.total/c.finish,c.total>c.delay){c.time=c.total-c.delay;var d=!1;if(c.time>=c.dur&&(c.time=c.dur,d=!0),!c.stopped&&Eb(c,Hb(c)),c.stopped=d,c.total>=c.finish)if(c.count++,c.count>=c.repeat)zb(c,!1),c.onDone&&c.onDone();else if(c.time=0,c.total=0,c.start=null,c.stopped=!1,c.reverse){var e=c.from;c.from=c.to,c.to=e,Gb(c)}}c.paused||!jd&&(jd=!0),null!=c._percentSet&&(c._percentSet=null)}})}function Eb(a,b){if(a.started||(a.started=!0,a.onPlay&&a.onPlay()),a.filter&&(b=a.filter(b)),a.attr&&a.source){var c;(c=a.attr.match(/^S[:@](.*)/i))?a.source.setStyle(c[1],b):(c=a.attr.match(/^C[:@](.*)/i))?a.source.setClient(c[1],b):Ib.Util.setValue(a.source,a.attr,b)}a.onUpdate&&a.onUpdate(b)}function Fb(a){var b=a.type,c=a.from,d=a.to;"number"===b?(a.from=c||0,a.to=d||0):"point"===b?(c?c.length&&(a.from={x:c[0],y:c[1]}):a.from="scale"===a.attr?{x:1,y:1}:{x:0,y:0},d?d.length&&(a.to={x:d[0],y:d[1]}):a.to="scale"===a.attr?{x:1,y:1}:{x:0,y:0}):"rect"===b?(c?c.length&&(a.from={x:c[0],y:c[1],w:c[2],h:c[3]}):a.from={x:0,y:0,w:0,h:0},d?d.length&&(a.to={x:d[0],y:d[1],w:d[2],h:d[3]}):a.to={x:0,y:0,w:0,h:0}):"color"===b&&(a.from=rd(c),a.to=rd(d)),a.current=a.from}function Gb(a){var b=a.type,c=a.from,d=a.to;"number"===b?a.delta=d-c:"point"===b?a.delta={x:d.x-c.x,y:d.y-c.y}:"rect"===b?a.delta={x:d.x-c.x,y:d.y-c.y,w:d.w-c.w,h:d.h-c.h}:"color"===b&&(a.delta={r:d.r-c.r,g:d.g-c.g,b:d.b-c.b,a:d.a-c.a})}function Hb(a,b){var c=a.type,d=a.delta,e=a.from,f=a.time,g=a.dur,h=kd[a.easing||"easeNone"];return h||(h=kd.easeNone),"number"===c?b=h(f,e,d,g):"point"===c?b={x:h(f,e.x,d.x,g),y:h(f,e.y,d.y,g)}:"rect"===c?b={x:h(f,e.x,d.x,g),y:h(f,e.y,d.y,g),w:h(f,e.w,d.w,g),h:h(f,e.h,d.h,g)}:"color"===c?b="rgba("+Math.floor(h(f,e.r,d.r,g))+","+Math.floor(h(f,e.g,d.g,g))+","+Math.floor(h(f,e.b,d.b,g))+","+Math.floor(h(f,e.a,d.a,g))+")":"set"===c?a.time&&(b=a.to):"group_set"===c&&(b=a.to[a.groupIndex]),a.current=b,b}var Ib={};Ib._isInitializing=!1;var Jb={isDeserializing:!1,isCalculatingBus:!1,images:{},registerImage:function(a,b,c,d,e){Jb.images[a]=new Ib.ImageAsset(a,b,c,d,e),xd(a)},getRegisteredImageNames:function(){return Object.keys(Jb.images)},unregisterImage:function(a){delete Jb.images[a]},getImageAsset:function(a){return Jb.images[a]},showVersion:function(a){Jb.isCtrlDown(a)&&a.shiftKey&&76==a.keyCode&&alert("TWaver HTML5 "+Ib.Util.getVersion()+"\n"+Kb)},callLater:function(a,b,c,d){return setTimeout(function(){a.apply(b,c)},d||Cd.CALL_LATER_DELAY)},isEmptyObject:function(a){for(var b in a)return!1;return!0},xml:function(b){if(a.DOMParser)return(new DOMParser).parseFromString(b,"text/xml");var c=new ActiveXObject("Microsoft.XmlDOM");return c.async=!1,c.loadXml(b),c},num:function(a){return"number"==typeof a&&!isNaN(a)&&isFinite(a)},getter:function(a){var b=a.charAt(0).toUpperCase()+a.slice(1),c=/ble$/.test(a)||/ed$/.test(a)?"is":"get";return c+b},setter:function(a){var b=a.charAt(0).toUpperCase()+a.slice(1);return"set"+b},_id:["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],id:function(){for(var a=[],b=0;32>b;b++)a[b]=this._id[Math.floor(16*Math.random())];return a[12]="4",a[16]=this._id[3&a[16]|8],a.join("")},keys:function(a){var b=new md;for(var c in a)b.add(c);return b},es:["toString","toLocaleString","valueOf"],ip:function(a,b){var c="_"+b;a[Jb.getter(b)]=function(){return this[c]},a[Jb.setter(b)]=function(a){var d=this[c];this[c]=a,this.firePropertyChange(b,d,a)}},validateLicense:function(a){Kb=a,nc()},ibool:function(a,b){var c="_"+b,d=b.charAt(0).toUpperCase()+b.slice(1);a["is"+d]=function(){return this[c]},a[Jb.setter(b)]=function(a){var d=this[c];this[c]=a,this.firePropertyChange(b,d,a)}},getValue:function(a,b,c){var d=b.charAt(0).toUpperCase()+b.slice(1),e="get"+d,f="is"+d;return c?"boolean"===c?a[f]():a[e]():a[e]?a[e]():a[f]?a[f]():a[b]},setValue:function(a,b,c){a["set"+b.charAt(0).toUpperCase()+b.slice(1)](c)},clone:function(a){if(!a)return null;var b={};for(var c in a)b[c]=a[c];return b},cloneRect:function(a){return a?{x:a.x,y:a.y,width:a.width,height:a.height}:null},classCache:{},getClass:function(b){var c=Jb.classCache[b];if(!c){var d=b.split("."),e=d.length;c=a;for(var f=0;e>f;f++)c=c[d[f]];Jb.classCache[b]=c}return c},newInstance:function(a){var b=Jb.getClass(a);if(!b)return null;var c=arguments.length,d=arguments;if(1===c)return new b;if(2===c)return new b(d[1]);if(3===c)return new b(d[1],d[2]);if(4===c)return new b(d[1],d[2],d[3]);if(5===c)return new b(d[1],d[2],d[3],d[4]);if(6===c)return new b(d[1],d[2],d[3],d[4],d[5]);if(7===c)return new b(d[1],d[2],d[3],d[4],d[5],d[6]);if(8===c)return new b(d[1],d[2],d[3],d[4],d[5],d[6],d[7]);throw"don't support args more than 7"},addMethod:function(a,b){var c=a.prototype;for(var d in b)c[d]=b[d]},ext:function(a,b,c){var d;if("string"==typeof a&&(d=a,a=Jb.getClass(a)),b){var e=function(){};e.prototype=b.prototype,a.prototype=new e,a.prototype.constructor=a,a.superClass=b.prototype,b.prototype.constructor==Object.prototype.constructor&&(b.prototype.constructor=b)}if(d&&(a.prototype.getClassName=function(){return d}),c){var f=a.prototype;for(var g in c)Rb.ext(g,f,c);for(var h=Jb.es.length,i=0;h>i;i++)g=Jb.es[i],c.hasOwnProperty(g)&&!c.propertyIsEnumerable(g)&&(f[g]=c[g])}},setViewBounds:function(a,b){if(a)if(a.adjustBounds)a.adjustBounds(b);else{var c=a.style;!c&&a.getView()&&(c=a.getView().style),c&&(c.position="absolute",c.left=b.x+"px",c.top=b.y+"px",c.width=b.width+"px",c.height=b.height+"px")}},getImageSrc:function(a){var b=Jb.getImageAsset(a);return b?b.getSrc()?b.getSrc():b.getImage().getAttribute("src"):a},nextColorCount:0,nextColor:function(){return Jb.nextColorCount>=Cd.COLORS.length&&(Jb.nextColorCount=0),Cd.COLORS[Jb.nextColorCount++]},isCtrlDown:function(a){return a.ctrlKey||a.metaKey},isShiftDown:function(a){return a.shiftKey},isAltDown:function(a){return a.altKey},setText:function(a,b,c){c?Qb.isFirefox?a.textContent=b:a.innerText=b:a.innerHTML=b},fillDescendant:function(a,b){b.add(a),a.hasChildren()&&a.getChildren().forEach(function(a){Jb.fillDescendant(a,b)})}},Kb=(Date,"l=1.0\ntype=1\ngis=1\n3d=0\nstart=2015-09-01\nend=2015-12-31\nnote=This license applies to the evaluation version of TWaver. The License is limited to noncommercial use. Noncommercial use relates only to educational, research, personal or evaluation purposes. Any other use is commercial use. You may not use the Software in connection with any business activities.And You are not permitted to modify the software or attempt to decipher, decompile, disassemble or reverse engineer this Software.\nsignature=60a71f854d055d7810a58e634b478dfcd94241823f4e725d358349d02dc408e6292b011e3711b6a784f42e44376003d5d9101871e0d347ccae4311f1084882cd0a6e38aa77b081ab86ac7acf5067b9ec1c57393e78ae8b88d004b9f527a5ca9183d1f450f1e0e71d73ca6451056b8596180316134306fff2926b9e6aaeeab87602674668aa5c9c084fc6ac6625515dbafb2119c0890f3f686b3ac1841efbe1670f2c87fac3b4ca9064fdbc8534d26050cedf601563fac9afd689968f70aaac72372bad0639bdb603a598917450937614048ac062aa30628a88056425f5365492899fd020f606eac1da5d2bc1b2a7f22e76aca7ec57458e81e6ec260ed13c8a20175069e9e707d4b6e5324f8fd7e7d519fe52fbc6e54eb77dcd8c83337c2f954c5950ec506b1165005193a1325c725a9de2002e0d9a0efc7806f51506699e3d451f65a3dec05b5c519bdc9d99abe8983c14dd470826bd58e4fd7e683d64396edd081a76854588caed8d43a8c1a6156e89f42a772a4b3ad3fe614915e579ce7d731aab5314563ebd3c1d5a63b766644352b1252c5a0284222726704323de34401550b5fdc230e0bf49883f4c99791b5afd7101bfb9b2f4f25b6640efad5077faaa45164c5ceb61b20a78546e1110719c39e2d26203aa2209f818cb5ac74bb3b37535ace12db632c1ad0a77b2acb71e78a1920833fbf45bb6fbe78a4e56aba9901d345632b6444c9905a5f95d3c3f747de92a554ae1a85cab00b929ea3e3d0b8d6278a358248e77dd44b152a14dc9d0ce90d191fbb6e6a9967df6bbfe96f41126d3db939610b4d2b3ae3a6f61a389532b2a3fde84af8642df938ee0a2e90d21c250bd85b8ee049e02e79e33b9e9548b10064706f5dda5bbfb806b7efd6fd25957ee");a.twaver=Ib,a._twaver=Jb,Ib.animate={},Ib.gl3dview={},Ib.gl3dview.interaction={},Ib.controls={},Ib.charts={},Ib.layout={};var Lb,Mb,Nb=a.navigator,Ob=a.document,Pb=a.Image;a.document||(Mb=!0,Lb=require("canvas"),Pb=Lb.Image,Nb={userAgent:""},Ob={});var Qb=function(){var a={},b=Nb.userAgent.toLowerCase();return a.isOpera=/opera/.test(b),a.isIE=/msie/.test(b)||/trident/.test(b),a.isFirefox=/firefox/i.test(b),a.isChrome=/chrome/i.test(b),a.isSafari=!a.isChrome&&/safari/i.test(b),a.isIPhone=/iphone/.test(b),a.isIPod=/ipod/.test(b),a.isIPad=/ipad/.test(b),a.isAndroid=/android/i.test(b),a.isWebOS=/webos/i.test(b),a.isMSToucheable=Nb.msMaxTouchPoints&&Nb.msMaxTouchPoints>1,a.isTouchable="ontouchend"in Ob||a.isMSToucheable,a}();Jb.ua=Qb;var Rb={__accessor:function(a,b){for(var c=b.__accessor,d=c.length,e=0;d>e;e++)Jb.ip(a,c[e])},__bool:function(a,b){for(var c=b.__bool,d=c.length,e=0;d>e;e++)Jb.ibool(a,c[e])},__client:function(a,b){a.getClient=function(a){return this._clientMap[a]},a.setClient=function(a,b){var c=this._clientMap[a];return null==b?delete this._clientMap[a]:this._clientMap[a]=b,this.firePropertyChange("C:"+a,c,b)&&this.onClientChanged(a,c,b),this},a.getClientProperties=function(){return Jb.keys(this._clientMap)},a.onClientChanged=function(a,b,c){}},__style:function(a,c){a.getStyle=function(a,c){var d=this._styleMap[a];return c===b&&(c=!0),null==d&&c?Ib.Styles.getStyle(a):d},a.setStyle=function(a,b){var c=this._styleMap[a];return null==b?delete this._styleMap[a]:this._styleMap[a]=b,this.firePropertyChange("S:"+a,c,b)&&this.onStyleChanged(a,c,b),this},a.getStyleProperties=function(){return Jb.keys(this._styleMap)},a.onStyleChanged=function(a,b,c){}},__new:function(a,b){a.newInstance=function(){var a=Jb.getClass(this.getClassName());if(!a)return null;var b=arguments.length,c=arguments;if(0===b)return new a;if(1===b)return new a(c[0]);if(2===b)return new a(c[0],c[1]);if(3===b)return new a(c[0],c[1],c[2]);if(4===b)return new a(c[0],c[1],c[2],c[3]);if(5===b)return new a(c[0],c[1],c[2],c[3],c[4]);if(6===b)return new a(c[0],c[1],c[2],c[3],c[4],c[5]);if(7===b)return new a(c[0],c[1],c[2],c[3],c[4],c[5],c[6]);throw"don't support args more than 7";

}},__property:function(a,b){a.getValue=function(a,b){return"accessor"===this._propertyType?Jb.getValue(a,this._propertyName):"style"===this._propertyType&&a.getStyle?a.getStyle(this._propertyName):"client"===this._propertyType&&a.getClient?a.getClient(this._propertyName):"field"===this._propertyType?a[this._propertyName]:null},a.setValue=function(a,b,c){if("accessor"===this._propertyType)a[Jb.setter(this._propertyName)](b);else{if("style"===this._propertyType&&a.setStyle)return a.setStyle(this._propertyName,b);if("client"===this._propertyType&&a.setClient)return a.setClient(this._propertyName,b);"field"===this._propertyType&&(a[this._propertyName]=b)}}},map:{__accessor:1,__bool:1,__client:1,__style:1,__new:1,__tree:1,__property:1},ext:function(a,b,c){1===Rb.map[a]?Rb[a](b,c):b[a]=c[a]}};Jb.extend=Rb;var Sb=function(a,b,c,d,e,f){this.setMatrix(a,b,c,d,e,f)};Sb.identity=function(){return new Sb(1,0,0,1,0,0)},Sb.prototype.setMatrix=function(a,b,c,d,e,f){this._m11=a,this._m12=b,this._m21=c,this._m22=d,this._offsetX=e,this._offsetY=f,this._type=4,0!=this._m21||0!=this._m12?this._type=4:((1!=this._m11||1!=this._m22)&&(this._type=2),(0!=this._offsetX||0!=this._offsetY)&&(this._type|=1),0==(3&this._type)&&(this._type=0))},Sb.prototype.transform=function(){var a;if(a=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],!a||!Jb.num(a.x)||!Jb.num(a.y))throw"arguments should contain x, y";switch(this._type){case 0:return{x:a.x,y:a.y};case 1:return{x:this._offsetX+a.x,y:this._offsetY+a.y};case 2:return{x:a.x*this._m11,y:a.y*this._m22};case 3:return{x:a.x*this._m11+this._offsetX,y:a.y*this._m22+this._offsetY}}return{x:this._m11*a.x+a.y*this._m21+this._offsetX,y:this._m22*a.y+a.x*this._m12+this._offsetY}},Sb.prototype.translate=function(a,b){this.multiply(new Sb(1,0,0,1,a,b))},Sb.prototype.scale=function(a,b){this.multiply(new Sb(a,0,0,b,0,0))},Sb.prototype.rotate=function(a,b,c){a=a*Math.PI/180;var d=Math.sin(a),e=Math.cos(a),f=b*(1-e)+c*d,g=c*(1-e)-b*d;this.multiply(new Sb(e,d,-d,e,f,g))},Sb.prototype.skew=function(a,b){this.multiply(new Sb(1,Math.tan(b*Math.PI/180),Math.tan(a*Math.PI/180),1,0,0))},Sb.prototype.multiply=function(a){var b=this,c=a,d=b._type,e=c._type;if(0!=e)if(0==d)b.setMatrix(c._m11,c._m12,c._m21,c._m22,c._offsetX,c._offsetY);else if(1==e)b._offsetX+=c._offsetX,b._offsetY+=c._offsetY,4!=d&&(b._type|=1);else if(1==d){var f=b._offsetX,g=b._offsetY;b.setMatrix(c._m11,c._m12,c._m21,c._m22,c._offsetX,c._offsetY),b._offsetX=f*c._m11+g*c._m21+c._offsetX,b._offsetY=f*c._m12+g*c._m22+c._offsetY,b._type=4==e?4:3}else switch(d<<4|e){case 34:return b._m11*=c._m11,void(b._m22*=c._m22);case 35:return b._m11*=c._m11,b._m22*=c._m22,b._offsetX=c._offsetX,b._offsetY=c._offsetY,void(b._type=3);case 36:case 52:case 66:case 67:case 68:return void b.setMatrix(b._m11*c._m11+b._m12*c._m21,b._m11*c._m12+b._m12*c._m22,b._m21*c._m11+b._m22*c._m21,b._m21*c._m12+b._m22*c._m22,b._offsetX*c._m11+b._offsetY*c._m21+c._offsetX,b._offsetX*c._m12+b._offsetY*c._m22+c._offsetY);case 50:return b._m11*=c._m11,b._m22*=c._m22,b._offsetX*=c._m11,void(b._offsetY*=c._m22);case 51:return b._m11*=c._m11,b._m22*=c._m22,b._offsetX=c._m11*b._offsetX+c._offsetX,void(b._offsetY=c._m22*b._offsetY+c._offsetY)}};var Tb={getDistance:function(a,b){var c=b.x-a.x,d=b.y-a.y;return Math.sqrt(c*c+d*d)},getCenterPoint:function(a,b){return a&&b?{x:(a.x+b.x)/2,y:(a.y+b.y)/2}:null==b&&a.width?{x:a.x+a.width/2,y:a.y+a.height/2}:void 0},isPointInPolygon:function(a,b){a=a._as;var c=0,d=0,e=!1,f=a.length;for(c=0,d=f-1;f>c;d=c++){var g=a[c],h=a[d];g.y>b.y!=h.y>b.y&&b.x<(h.x-g.x)*(b.y-g.y)/(h.y-g.y)+g.x&&(e=!e)}return e},unionRect:function(a,b){if(a&&!b)return Jb.cloneRect(a);if(!a&&b)return Jb.cloneRect(b);if(a&&b){var c={};return c.x=Math.min(a.x,b.x),c.y=Math.min(a.y,b.y),c.width=Math.max(a.x+a.width,b.x+b.width)-c.x,c.height=Math.max(a.y+a.height,b.y+b.height)-c.y,c}return null},intersects:function(a,b){if(!a||!b)return!1;var c=b.width,d=b.height,e=a.width,f=a.height;if(0>=e||0>=f||0>=c||0>=d)return!1;var g=b.x,h=b.y,i=a.x,j=a.y;return e+=i,f+=j,c+=g,d+=h,(i>e||e>g)&&(j>f||f>h)&&(g>c||c>i)&&(h>d||d>j)},intersection:function(a,b){if(!a||!b)return!1;var c=b.x,d=b.y,e=a.x,f=a.y,g=c;g+=b.width;var h=d;h+=b.height;var i=e;i+=a.width;var j=f;return j+=a.height,e>c&&(c=e),f>d&&(d=f),g>i&&(g=i),h>j&&(h=j),g-=c,h-=d,0===g||0===h?null:{x:c,y:d,width:g,height:h}},contains:function(a,b){var c=b.x,d=b.y,e=b.width,f=b.height,g=a.width,h=a.height;if(0>(g|h|e|f))return!1;var i=a.x,j=a.y;if(i>c||j>d)return!1;if(g+=i,e+=c,c>=e){if(g>=i||e>g)return!1}else if(g>=i&&e>g)return!1;if(h+=j,f+=d,d>=f){if(h>=j||f>h)return!1}else if(h>=j&&f>h)return!1;return!0},getLinePoints:function(a){if(!a)return null;var b=new md;return a.forEach(function(a){b.addAll(a)}),b},getLineRect:function(a){var b=Tb.getLinePoints(a);return Tb.getRect(b)},getRect:function(a,b){if(!a)return null;a._as&&(a=a._as);var c=a.length;if(0>=c)return null;var d=a[0];b=b||{x:null,y:null,width:0,height:0};for(var e=0;c>e;e++)if(d=a[e],d instanceof md)Tb.getRect(d,b);else{null==b.x&&(b.x=d.x,b.y=d.y);var f=Math.min(b.x,d.x),g=Math.min(b.y,d.y),h=Math.max(b.x+b.width,d.x),i=Math.max(b.y+b.height,d.y);b.x=f,b.y=g,b.width=h-f,b.height=i-g}return b},addPadding:function(a,b,c,d){d=d||-1;var e=b.getStyle(c)*d;0!=e&&Tb.grow(a,e,e),e=b.getStyle(c+".left")*d,0!=e&&(a.x-=e,a.width+=e),e=b.getStyle(c+".right")*d,0!=e&&(a.width+=e),e=b.getStyle(c+".top")*d,0!=e&&(a.y-=e,a.height+=e),e=b.getStyle(c+".bottom")*d,0!=e&&(a.height+=e),a.width<0&&(a.width=-a.width,a.x-=a.width),a.height<0&&(a.height=-a.height,a.y-=a.height)},grow:function(a,b,c){if(null==a)return null;null==c&&(c=b);var d=a.width+b+b;if(!(0>d)){var e=a.height+c+c;if(!(0>e))return a.x-=b,a.y-=c,a.width=d,a.height=e,a}},containsPoint:function(a,b,c){return arguments.length<3&&(c=b.y,b=b.x),!a||b<a.x||c<a.y||b>a.x+a.width||c>a.y+a.height?!1:!0},getHotSpot:function(a,b,c,d,e){if("oval"===e){var f=.35;return{x:a+.5*c+c*f,y:b+d/2-Math.sqrt(.25-f*f)*d}}if("circle"===e){var g=a+c/2,h=b+d/2,i=Math.min(c,d)/2;a=g-i,b=h-i,c=2*i,d=2*i;var j=c/2,k=d/2,l=j*k/Math.sqrt(j*j+k*k);return{x:a+c/2+l,y:b+d/2-l}}var m={x:a+c,y:b};return c>3&&(m.x-=3),d>3&&(m.y+=3),m},getCircleRect:function(a){var b=Math.min(a.width,a.height)/2;return{x:a.x+a.width/2-b,y:a.y+a.height/2-b,width:2*b,height:2*b}},getEllipsePoint:function(a,b){if(!a||!b)return null;var c=a.x+a.width/2,d=a.y+a.height/2,e=b.x-c,f=b.y-d,g=a.width/2,h=a.height/2,i=Math.sqrt(1/(1/g/g+f*f/e/e/h/h));0>e&&(i=-i);var j;return j=0==e?f>0?h:-h:i*f/e,{x:c+i,y:d+j}},createMatrix:function(a,b,c){var d=Math.sin(a),e=Math.cos(a),f=b*(1-e)+c*d,g=c*(1-e)-b*d;return new Sb(e,d,-d,e,f,g)},calculatePointInfoAlongLineBySegments:function(a,b,c,d,e){return Tb.calculatePointInfoAlongLine(Tb.getPointObject(a,b),c,d,e)},calculatePointInfoAlongLine:function(a,c,d,e){if(c=c===b?!0:c,d=d||0,e=e||0,!a||a.size()<2)throw"must more than two points";if(!c){var f=Tb.reversePath(a);return Tb.calculatePointInfoAlongLine(f,!0,d,e)}a._as&&(a=a._as);var g,h,i,j,k,l=0,m=0,n=a.length;for(j=0;n>j;j++)if(k=a[j],0!=j){if(0>=d){i=Tb.calculatePointInfoOnStraightLine(Tb._getPoint(h),Tb._getControlPoint(k),d,e),g=i;break}if(m=Tb._getLength(k,h),l+m>d){i=Tb.getPathInfo(k,h,d-l,e,m),g=i;break}l+=m,h=k}else h=k;if(null==g){var o,p;h=a[n-1],p=Tb._getPoint(h),h instanceof md&&(h=h._as),o=h instanceof Array?Tb._getControlPoint(h):Tb._getPoint(a[n-2]);var q=Math.atan2(p.y-o.y,p.x-o.x);i=Tb.transformPoint(p,q,d-l,e),i.angle=q,g=i}return g},reversePath:function(a){var b,c=new md,d=null;a._as&&(a=a._as);for(var e=a.length-1;e>=0;e--)b=a[e],c.add(Tb._getReversePath(b,d)),d=b;return c},_getPoint:function(a){return a._as&&(a=a._as),a instanceof Array?a[a.length-1]:a},_getControlPoint:function(a){return a._as&&(a=a._as),a instanceof Array?a[a.length-2]:a},_getReversePath:function(a,b){var c=Tb._getPoint(a);return b&&b._as&&(b=b._as),null!=b&&b instanceof Array?new md(2==b.length?[b[0],c]:[b[1],b[0],c]):c},_getLength:function(a,b){var c=Tb._getPoint(b),d=Tb._getPoint(a);if(a instanceof md&&(a=a._as),a instanceof Array)return Tb.calculateCurveLength(c,a,1);var e=d.y-c.y,f=d.x-c.x;return Math.sqrt(f*f+e*e)},getPathInfo:function(a,b,c,d,e){var f,g=Tb._getPoint(b),h=Tb._getPoint(a);if(a instanceof md&&(a=a._as),a instanceof Array){0>e&&(e=Tb._getLength(a,b));var i=c/e,j=Tb.calculatePointInfoOnCurveLine(g,a,i);g=j.point,f=j.angle,c=0}else f=Math.atan2(h.y-g.y,h.x-g.x);return Tb.transformPoint(g,f,c,d)},transformPoint:function(a,b,c,d){var e={x:c,y:d},f=Tb.createMatrix(b,0,0);return e=f.transform(e),e.x+=a.x,e.y+=a.y,{point:e,angle:b}},calculatePointInfoOnStraightLine:function(a,b,c,d){var e=Math.atan2(b.y-a.y,b.x-a.x);return Tb.transformPoint(a,e,c,d)},calculatePointInfoOnCurveLine:function(a,b,c){if(0>c||c>1)throw"Illegal arguments";return b._as&&(b=b._as),2==b.length?Tb._calculatePointInfoOnCurveLine2(a,b[0],b[1],c):Tb._calculatePointInfoOnCurveLine3(a,b[0],b[1],b[2],c)},_calculatePointInfoOnCurveLine2:function(a,b,c,d){var e=2*(a.x+c.x-2*b.x)*d+2*b.x-2*a.x,f=2*(a.y+c.y-2*b.y)*d+2*b.y-2*a.y,g=Math.atan2(f,e),h=(a.x+c.x-2*b.x)*d*d+(2*b.x-2*a.x)*d+a.x,i=(a.y+c.y-2*b.y)*d*d+(2*b.y-2*a.y)*d+a.y;return{point:{x:h,y:i},angle:g}},_calculatePointInfoOnCurveLine3:function(a,b,c,d,e){var f,g,h;f=1-e,g=f*f*f,h=e*e*e;var i=g*a.x+3*e*f*f*b.x+3*e*e*f*c.x+h*d.x,j=g*a.y+3*e*f*f*b.y+3*e*e*f*c.y+h*d.y;return{point:{x:i,y:j},angle:Math.atan2(Tb._bezeSpeedY(a,b,c,d,e),Tb._bezeSpeedX(a,b,c,d,e))}},calculateCurveLength:function(a,b,c){return b._as&&(b=b._as),2==b.length?Tb._calculateCurveLength(a,b[0],b[1],c):Tb._calculateBezierCurveLength(a,b[0],b[1],b[2],c)},_calculateCurveLength:function(a,b,c,d){if(0>=d||d>1)return 0;var e=Math.floor(d*(Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y))+Math.sqrt((c.x-b.x)*(c.x-b.x)+(c.y-b.y)*(c.y-b.y)))/2),f=0;0>=e&&(e=1);for(var g,h,i=d/e,j=0,k=0;e>k;k++)j=i*k,g=2*(a.x+c.x-2*b.x)*j+2*b.x-2*a.x,h=2*(a.y+c.y-2*b.y)*j+2*b.y-2*a.y,g*=i,h*=i,f+=Math.sqrt(g*g+h*h);return f},_calculateBezierCurveLength:function(a,b,c,d,e){if(0>=e||e>1)return 0;var f=1e4,g=Math.floor(f*e);if(1==(1&g)&&g++,0==g)return 0;var h,i=Math.floor(g/2),j=0,k=0,l=e/g;for(h=0;i>h;h++)j+=Tb._bezeSpeed(a,b,c,d,(2*h+1)*l);for(h=1;i>h;h++)k+=Tb._bezeSpeed(a,b,c,d,2*h*l);return(Tb._bezeSpeed(a,b,c,d,0)+Tb._bezeSpeed(a,b,c,d,1)+2*k+4*j)*l/3},_bezeSpeedX:function(a,b,c,d,e){var f=1-e;return-3*a.x*f*f+3*b.x*f*f-6*b.x*f*e+6*c.x*f*e-3*c.x*e*e+3*d.x*e*e},_bezeSpeedY:function(a,b,c,d,e){var f=1-e;return-3*a.y*f*f+3*b.y*f*f-6*b.y*f*e+6*c.y*f*e-3*c.y*e*e+3*d.y*e*e},_bezeSpeed:function(a,b,c,d,e){var f=Tb._bezeSpeedX(a,b,c,d,e),g=Tb._bezeSpeedY(a,b,c,d,e);return Math.sqrt(f*f+g*g)},getPointObject:function(a,b){if(b&&0!=b.size()){var c=new md;b=b._as,a=a._as;var d,e,f=0,g=b.length,h=a.length;for(d=0;g>d&&(e=b[d],f!=h);d++)"cubicto"===e?h-2>f&&c.add([a[f++],a[f++],a[f++]]):"quadto"===e?h-1>f&&c.add([a[f++],a[f++]]):h>f&&c.add(a[f++]);for(;h>f;f++)c.add(a[f]);return c}return a},calculateLineLength:function(a,b){if(!a||a.size()<2)return 0;if(b)return Tb.calculateLineLength(Tb.getPointObject(a,b));a=a._as;var c,d,e,f,g,h,i,j=a.length,k=0;for(c=0;j>c;c++)f=a[c],0!=c?(e=f,e instanceof md&&(e=e._as),e instanceof Array?(g=Tb.calculateCurveLength(d,e,1),d=e[e.length-1]):(i=f.y-d.y,h=f.x-d.x,g=Math.sqrt(h*h+i*i),d=e),k+=g):d=f;return k},toDegrees:function(a){return 180*a/Math.PI},toRadians:function(a){return a/180*Math.PI},getRadiansBetweenLines:function(a,b){return Math.atan2(b.y-a.y,b.x-a.x)},getAngle:function(a,b){return a.x===b.x?b.y===a.y?0:b.y>a.y?Math.PI/2:-Math.PI/2:Math.atan((b.y-a.y)/(b.x-a.x))}};Jb.math=Tb;var Ub={getPoints:function(a){var b=new md;return a.forEach(function(a){b.add({x:a.x,y:a.y}),b.add({x:a.x+a.width,y:a.y+a.height}),b.add({x:a.x+a.width,y:a.y}),b.add({x:a.x,y:a.y+a.height})}),b},rectangle:function(a){var b;return a.forEach(function(a){b=Tb.unionRect(b,a)}),b},oval:function(a){var b=Ub.rectangle(a),c=0,d=b.height/b.width,e=d*d,f=b.x+b.width/2,g=b.y+b.height/2,h=Ub.getPoints(a);h.forEach(function(a){var b=a.x-f,d=a.y-g,h=b*b+d*d/e;h>c&&(c=h)}),c=Math.sqrt(c);var i=d*c;return{x:f-c,y:g-i,width:2*c,height:2*i}},circle:function(a){var b=Ub.rectangle(a),c=0,d=b.x+b.width/2,e=b.y+b.height/2,f=Ub.getPoints(a);return f.forEach(function(a){var b=a.x-d,f=a.y-e,g=b*b+f*f;g>c&&(c=g)}),c=Math.sqrt(c),{x:d-c,y:e-c,width:2*c,height:2*c}},roundrect:function(a){var b=Ub.rectangle(a),c=Math.min(b.width,b.height)/16;return Tb.grow(b,c,c),b},star:function(a){var b=Ub.rectangle(a);return Tb.grow(b,b.width,b.height),b},triangle:function(a){var b=Ub.rectangle(a);return b.x-=b.width/2,b.width*=2,b.y-=b.height,b.height*=2,b},hexagon:function(a){var b=Ub.rectangle(a);return b.x-=b.width/2,b.width*=2,b},pentagon:function(a){var b=Ub.rectangle(a);return b.x-=b.width/6,b.width+=b.width/3,b.y-=b.height/4,b.height+=b.height/4,b},diamond:function(a){var b=Ub.rectangle(a);return b.x-=b.width/2,b.width+=b.width,b.y-=b.height/2,b.height+=b.height,b}};Jb.group=Ub;var Vb={"topleft.topleft":function(a,b){return{x:a.x-b.width,y:a.y-b.height}},"topleft.topright":function(a,b){return{x:a.x,y:a.y-b.height}},"top.top":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y-b.height}},"topright.topleft":function(a,b){return{x:a.x+a.width-b.width,y:a.y-b.height}},"topright.topright":function(a,b){return{x:a.x+a.width,y:a.y-b.height}},topleft:function(a,b){return{x:a.x-b.width/2,y:a.y-b.height/2}},top:function(a,b){return{x:a.x-b.width/2+a.width/2,y:a.y-b.height/2}},topright:function(a,b){return{x:a.x-b.width/2+a.width,y:a.y-b.height/2}},"topleft.bottomleft":function(a,b){return{x:a.x-b.width,y:a.y}},"topleft.bottomright":function(a,b){return{x:a.x,y:a.y}},"top.bottom":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y}},"topright.bottomleft":function(a,b){return{x:a.x-b.width+a.width,y:a.y}},"topright.bottomright":function(a,b){return{x:a.x+a.width,y:a.y}},"left.left":function(a,b){return{x:a.x-b.width,y:a.y+a.height/2-b.height/2}},left:function(a,b){return{x:a.x-b.width/2,y:a.y+a.height/2-b.height/2}},"left.right":function(a,b){return{x:a.x,y:a.y+a.height/2-b.height/2}},center:function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height/2-b.height/2}},"right.left":function(a,b){return{x:a.x+a.width-b.width,y:a.y+a.height/2-b.height/2}},right:function(a,b){return{x:a.x+a.width-b.width/2,y:a.y+a.height/2-b.height/2}},"right.right":function(a,b){return{x:a.x+a.width,y:a.y+a.height/2-b.height/2}},"bottomleft.topleft":function(a,b){return{x:a.x-b.width,y:a.y+a.height-b.height}},"bottomleft.topright":function(a,b){return{x:a.x,y:a.y+a.height-b.height}},"bottom.top":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height-b.height}},"bottomright.topleft":function(a,b){return{x:a.x+a.width-b.width,y:a.y+a.height-b.height}},"bottomright.topright":function(a,b){return{x:a.x+a.width,y:a.y+a.height-b.height}},bottomleft:function(a,b){return{x:a.x-b.width/2,y:a.y+a.height-b.height/2}},bottom:function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height-b.height/2}},bottomright:function(a,b){return{x:a.x+a.width-b.width/2,y:a.y+a.height-b.height/2}},"bottomleft.bottomleft":function(a,b){return{x:a.x-b.width,y:a.y+a.height}},"bottomleft.bottomright":function(a,b){return{x:a.x,y:a.y+a.height}},"bottom.bottom":function(a,b){return{x:a.x+a.width/2-b.width/2,y:a.y+a.height}},"bottomright.bottomleft":function(a,b){return{x:a.x+a.width-b.width,y:a.y+a.height}},"bottomright.bottomright":function(a,b){return{x:a.x+a.width,y:a.y+a.height}},get:function(a,b,c){if(!b)throw"refRect can not be null";c||(c={width:0,height:0});var d=Vb[a];if(d)return d(b,c);throw"Can not resolve '"+a+"' position"}};Jb.position=Vb;var Wb={preventDefault:function(a){Cd.KEEP_DEFAULT_FUNCTION(a)||(a.preventDefault?a.preventDefault():a.preventManipulation?a.preventManipulation():a.returnValue=!1)},insertAfter:function(a,b){return b?b.parentNode.insertBefore(a,b.nextSibling):a.parentNode.insertBefore(a,a.parentNode.firstChild),a},forEach:function(a,b,c){if(Wb.isVisible(a)){for(var d=a.childNodes.length,e=0;d>e;e++)Wb.forEach(a.childNodes[e],b,c);c?b.call(c,a):b(a)}},setVisible:function(a,b){a.style.display=b?"block":"none"},isVisible:function(a){return"style"in a&&"none"!==a.style.display},release:function(a){for(var b=a.childNodes.length,c=0;b>c;c++)Wb.release(a.childNodes[c]);b>0&&Wb.clear(a),a._pool&&a._pool.release(a)},clear:function(a){for(;a.firstChild;)a.removeChild(a.firstChild)},setZoom:function(a,b){var c=a.style;if(c.setProperty)if(Qb.isFirefox)c.setProperty("-moz-transform","scale("+b+")",null),c.setProperty("-moz-transform-origin","0 0",null);else if(Qb.isOpera)c.setProperty("-o-transform","scale("+b+")",null),c.setProperty("-o-transform-origin","0 0",null);else if(Qb.isChrome||Qb.isSafari){c.setProperty("-webkit-transform","scale("+b+")",null),c.setProperty("-webkit-transform-origin","0 0",null);var d=null;a._webkitInvaildateDiv?d=a._webkitInvaildateDiv:(d=Ob.createElement("div"),a._webkitInvaildateDiv=d),d.parentNode&&d.parentNode==a?a.removeChild(d):a.appendChild(d)}else Qb.isIE?(c.setProperty("-ms-transform","scale("+b+")",null),c.setProperty("-ms-transform-origin","0 0",null)):(c.setProperty("transform","scale("+b+")",null),c.setProperty("transform-origin","0 0",null))},setCSSStyle:function(a,b,c){a.style.setProperty(b,c,null)},removeCSSStyle:function(a,b){a.style.removeProperty(b)},getCSSStyle:function(a,b){return a.style.getPropertyValue(b)},setBorderRaidus:function(a,b){Qb.isFirefox?a.style.MozBorderRadius=b:a.style.borderRadius=b},createSelect:function(a,b){var c,d,e,f=Ob.createElement("select");if(Array.isArray(a))for(c=0;c<a.length;c++)d=a[c],e=Ob.createElement("option"),e.innerHTML=d,e.setAttribute("value",d),d===b&&e.setAttribute("selected","true"),f.appendChild(e);else for(c=0;c<a.values.length;c++)d=a.values[c],e=Ob.createElement("option"),e.innerHTML=a.map[d],e.setAttribute("value",d),d===b&&e.setAttribute("selected","true"),f.appendChild(e);return f},createImg:function(a){var b=Ob.createElement("img");return b.style.position="absolute","string"==typeof a&&b.setAttribute("src",a),b},createView:function(a,b){var c=Ob.createElement("div");return c.style.position=Cd.VIEW_POSITION,c.style.fontSize=Cd.VIEW_FONT_SIZE,c.style.fontFamily=Cd.VIEW_FONT_FAMILY,c.style.cursor="default",c.style.outline="none",c.style.textAlign="left",c.style.msTouchAction="none",c.tabIndex=0,b||(c.onmousedown=Wb.preventDefault),c.style.setProperty&&(c.style.setProperty("-khtml-user-select","none",null),c.style.setProperty("-webkit-user-select","none",null),c.style.setProperty("-moz-user-select","none",null),c.style.setProperty("-webkit-tap-highlight-color","rgba(0, 0, 0, 0)",null)),a&&(c.style.overflow=a),c},createDiv:function(){var a=Ob.createElement("div");return a.style.position="absolute",a.style.msTouchAction="none",a},createCanvas:function(a,b){if(a=a||0,b=b||0,Mb){var c=require("canvas");return new c(a,b)}var d=Ob.createElement("canvas");return d.style.position="absolute",d.style.msTouchAction="none",d.width=a,d.height=b,d},setCanvas:function(a,b,c,d,e){2===arguments.length&&(c=b.y,d=b.width,e=b.height,b=b.x),a.style.left=b+"px",a.style.top=c+"px",a.setAttribute("width",d),a.setAttribute("height",e),a._viewRect={x:b,y:c,width:d,height:e};var f=a.getContext("2d");return 0!==f.shadowBlur&&(f.shadowOffsetX=0,f.shadowOffsetY=0,f.shadowBlur=0,f.shadowColor="rgba(0,0,0,0.0)"),f.clearRect(0,0,d,e),f.translate(-b,-c),f},setImg:function(a,b,c){a.setAttribute("src",b),a.style.left=c.x+"px",a.style.top=c.y+"px",a.style.width=c.width+"px",a.style.height=c.height+"px",a._viewRect=Jb.clone(c)},setDiv:function(a,b,c,d,e){d=Jb.num(d)?d:0,a.style.left=b.x-d+"px",a.style.top=b.y-d+"px",a.style.width=b.width+"px",a.style.height=b.height+"px",a._viewRect=Jb.clone(b),a.style.backgroundColor=c?c:"",a.style.border=d>0?d+"px "+e+" solid":""},addEventListener:function(a,b,c,d){var e="_"+a+"_";if(!d[e]){var f=function(a){f.instance[f.method](a)};f.method=b,f.instance=d,d[e]=f,c.addEventListener(a,f,!1)}},removeEventListener:function(a,b,c){var d="_"+a+"_",e=c[d];e&&(b.removeEventListener(a,e,!1),delete c[d])},isValidEvent:function(a,b){if(!b)return!1;if(b.target===a)if(Qb.isFirefox){if(a.clientHeight<a.scrollHeight&&b.layerX<25)return!1;if(a.clientWidth<a.scrollWidth&&b.layerY<25)return!1}else if(b.offsetX>a.clientWidth||b.offsetY>a.clientHeight)return!1;return!0},getLogicalPoint:function(a,b,c,d){c=c?c:1;var e,f=a.getBoundingClientRect();if(Qb.isTouchable&&b.changedTouches&&b.changedTouches.length>0){var g=b.changedTouches[0],h=Qb.isAndroid?0:zc.scrollLeft(),i=Qb.isAndroid?0:zc.scrollTop();e={x:(g.clientX+a.scrollLeft-f.left-h)/c,y:(g.clientY+a.scrollTop-f.top-i)/c}}else{if(!Wb.isValidEvent(a,b))return null;e={x:(b.clientX-f.left+a.scrollLeft)/c,y:(b.clientY-f.top+a.scrollTop)/c}}return e},handle_mousedown:function(b,c){Wb.target&&Wb.handle_mouseup(c),a.addEventListener("mousemove",Wb.handle_mousemove,!1),a.addEventListener("mouseup",Wb.handle_mouseup,!1),Wb.target=b},handle_mousemove:function(a){Wb.target.handle_mousemove&&Wb.target.handle_mousemove(a),Wb.target.handleMouseMove&&Wb.target.handleMouseMove(a)},handle_mouseup:function(b){Wb.target.handle_mouseup&&Wb.target.handle_mouseup(b),Wb.target.handleMouseUp&&Wb.target.handleMouseUp(b),a.removeEventListener("mousemove",Wb.handle_mousemove,!1),a.removeEventListener("mouseup",Wb.handle_mouseup,!1),delete Wb.target},getClientPoint:function(a){return{x:a.clientX,y:a.clientY}},windowWidth:function(){return"number"==typeof a.innerWidth?a.innerWidth:Ob.documentElement&&Ob.documentElement.clientWidth?Ob.documentElement.clientWidth:Ob.body&&Ob.body.clientWidth?Ob.body.clientWidth:0},windowHeight:function(){return"number"==typeof a.innerHeight?a.innerHeight:Ob.documentElement&&Ob.documentElement.clientHeight?Ob.documentElement.clientHeight:Ob.body&&Ob.body.clientHeight?Ob.body.clientHeight:0}};Jb.html=Wb;var Xb={cache:{},g:Wb.createCanvas().getContext("2d"),getTextSize:function(a,b){Xb.g.font=a?a:Cd.FONT;var c=Xb.cache[Xb.g.font];c||(c=2*Xb.g.measureText("e").width+4,Xb.cache[Xb.g.font]=c),b=b||"",b=String(b);for(var d,e=b.split("\n"),f=e.length,g=0,h=f-1;h>=0;h--)d=Xb.g.measureText(e[h]).width,d>g&&(g=d);return{width:g+4,height:c*f}},drawText:function(a,c,d,e,f,g){c=c||"",c=String(c),e||(e=Cd.FONT);var h="center";g&&(h=g),a.font=e,a.fillStyle=f,a.textAlign=h,a.textBaseline="middle";var i,j,k=c.split("\n"),l=k.length,m=0;d?d.width===b?(i=d.x,j=d.y):(m=d.height/l,"left"==h?i=d.x:"center"==h&&(i=d.x+d.width/2),j=d.y+m/2):(i=0,j=0),Qb.isOpera&&(j-=2);for(var n=0;l>n;n++)"right"==h&&(a.textAlign="left",i=d.x+d.width-Xb.getTextSize(e,k[n]).width),a.fillText(k[n],i,j),j+=m},drawArc:function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s;if(Math.abs(e)>2*Math.PI&&(e=2*Math.PI),m=Math.ceil(Math.abs(e)/(Math.PI/4)),i=e/m,j=-i,k=-d,m>0){n=b+Math.cos(d)*f,o=c+Math.sin(-d)*g,h?a.lineTo(n,o):a.moveTo(n,o);for(var t=0;m>t;t++)k+=j,l=k-j/2,p=b+Math.cos(k)*f,q=c+Math.sin(k)*g,r=b+Math.cos(l)*(f/Math.cos(j/2)),s=c+Math.sin(l)*(g/Math.cos(j/2)),a.quadraticCurveTo(r,s,p,q)}},dashedLine:function(a,b,c,d,e,f,g){var h=f-d,i=g-e,j=Math.sqrt(h*h+i*i);if(0!=j){h/=j,i/=j;for(var k=j,l=-c.offset,m=c.drawing,n=c.patternIndex;k>l;)l+=b[n],l>=k&&(c.offset=b[n]-(l-k),c.patternIndex=n,c.drawing=m,l=k),m?a.lineTo(d+l*h,e+l*i):a.moveTo(d+l*h,e+l*i),m=!m,n=(n+1)%b.length}},drawLinePoints:function(a,b,c,d,e){var f,g,h,i,j,k,l=0,m=0,n=b.size();if(k=c&&c.length>0?new uc(a,c[0],c.length>1?c[1]:c[0]):a,d)for(m=0,j=d.size();j>m;m++)if(f=d.get(m),"moveto"===f&&n>l)g=b.get(l++),k.moveTo(g.x,g.y);else if("lineto"===f&&n>l)g=b.get(l++),k.lineTo(g.x,g.y);else if("cubicto"===f&&n-2>l)g=b.get(l++),h=b.get(l++),i=b.get(l++),k.bezierCurveTo(g.x,g.y,h.x,h.y,i.x,i.y);else{if(!("quadto"===f&&n-1>l))throw"Can not resolve segment '"+f+"'";g=b.get(l++),h=b.get(l++),k.quadraticCurveTo(g.x,g.y,h.x,h.y)}else this._drawLine(b,k);e&&k.closePath()},_drawLine:function(a,b){var c,d,e,f,g,h=0,i=a.size();for(c=a.get(0),b.moveTo(c.x,c.y),h=1;i>h;h++)g=a.get(h),g.size?(f=g.size(),2===f?(c=g.get(0),d=g.get(1),b.quadraticCurveTo(c.x,c.y,d.x,d.y)):3===f&&(c=g.get(0),d=g.get(1),e=g.get(2),b.bezierCurveTo(c.x,c.y,d.x,d.y,e.x,e.y))):b.lineTo(g.x,g.y)},drawRoundRect:function(a,b,c,d,e,f,g,h,i){6===arguments.length&&(g=f,h=f,i=f);var j=b+d,k=c+e,l=e>d?2*d:2*e;f=l>f?f:l,g=l>g?g:l,h=l>h?h:l,i=l>i?i:l;var m=.292893218813453*i,n=.585786437626905*i;a.moveTo(j,k-i),a.quadraticCurveTo(j,k-n,j-m,k-m),a.quadraticCurveTo(j-n,k,j-i,k),m=.292893218813453*h,n=.585786437626905*h,a.lineTo(b+h,k),a.quadraticCurveTo(b+n,k,b+m,k-m),a.quadraticCurveTo(b,k-n,b,k-h),m=.292893218813453*f,n=.585786437626905*f,a.lineTo(b,c+f),a.quadraticCurveTo(b,c+n,b+m,c+m),a.quadraticCurveTo(b+n,c,b+f,c),m=.292893218813453*g,n=.585786437626905*g,a.lineTo(j-g,c),a.quadraticCurveTo(j-n,c,j-m,c+m),a.quadraticCurveTo(j,c+n,j,c+g),a.lineTo(j,k-i)},drawVector:function(a,b,c,d,e,f,g){var h;4===arguments.length?(e=d.y,f=d.width,g=d.height,d=d.x):5===arguments.length&&"roundrect"===b&&(h=e,e=d.y,f=d.width,g=d.height,d=d.x);var i=Xb["_"+b];i&&(a.beginPath(),c&&c.length>0&&(a=new uc(a,c[0],c.length>1?c[1]:c[0])),5===arguments.length&&"roundrect"===b?i(a,{x:d,y:e,width:f,height:g},h):i(a,d,e,f,g))},_rectangle:function(a,b,c,d,e){a.rect(b,c,d,e)},_circle:function(a,b,c,d,e){var f=b+d/2,g=c+e/2,h=Math.min(d,e)/2;a instanceof uc?Xb.drawArc(a,f,g,0,2*Math.PI,h,h,!1):a.arc(f,g,h,0,2*Math.PI,!0)},_oval:function(a,b,c,d,e){if(a instanceof uc)Xb.drawArc(a,b+d/2,c+e/2,0,2*Math.PI,d/2,e/2,!1);else{var f=.5522848,g=d/2*f,h=e/2*f,i=b+d,j=c+e,k=b+d/2,l=c+e/2;a.moveTo(b,l),a.bezierCurveTo(b,l-h,k-g,c,k,c),a.bezierCurveTo(k+g,c,i,l-h,i,l),a.bezierCurveTo(i,l+h,k+g,j,k,j),a.bezierCurveTo(k-g,j,b,l+h,b,l)}},_roundrect:function(a,b,c,d,e){if(3===arguments.length){var f=c;c=b.y,d=b.width,e=b.height,b=b.x,f.topLeft>=0?Xb.drawRoundRect(a,b,c,d,e,f.topLeft):Xb.drawRoundRect(a,b,c,d,e,Math.min(Math.min(d,e)/4,10))}else Xb.drawRoundRect(a,b,c,d,e,Math.min(Math.min(d,e)/4,10))},_star:function(a,b,c,d,e){var f=2*d,g=2*e,h=b+d/2,i=c+e/2;a.moveTo(h-f/4,i-g/12),a.lineTo(b+.306*d,c+.579*e),a.lineTo(h-f/6,i+g/4),a.lineTo(b+d/2,c+.733*e),a.lineTo(h+f/6,i+g/4),a.lineTo(b+.693*d,c+.579*e),a.lineTo(h+f/4,i-g/12),a.lineTo(b+.611*d,c+.332*e),a.lineTo(h+0,i-g/4),a.lineTo(b+.388*d,c+.332*e),a.closePath()},_triangle:function(a,b,c,d,e){a.moveTo(b+d/2,c),a.lineTo(b+d,c+e),a.lineTo(b,c+e),a.closePath()},_hexagon:function(a,b,c,d,e){a.moveTo(b,c+e/2),a.lineTo(b+d/4,c+e),a.lineTo(b+3*d/4,+c+e),a.lineTo(b+d,c+e/2),a.lineTo(b+3*d/4,c),a.lineTo(b+d/4,c),a.closePath()},_pentagon:function(a,b,c,d,e){var f=2*d,g=2*e,h=b+d/2,i=c+e/2;a.moveTo(h-f/4,i-g/12),a.lineTo(h-f/6,i+g/4),a.lineTo(h+f/6,i+g/4),a.lineTo(h+f/4,i-g/12),a.lineTo(h+0,i-g/4),a.closePath()},_diamond:function(a,b,c,d,e){a.moveTo(b+d/2,c),a.lineTo(b,c+e/2),a.lineTo(b+d/2,c+e),a.lineTo(b+d,c+e/2),a.closePath()},fill:function(a,b,c,d,e,f,g,h){var i=Zb[c];a.fillStyle=i?5===arguments.length?i(a,b,d,e.x,e.y,e.width,e.height):i(a,b,d,e,f,g,h):b},createRadialGradient:function(a,b,c,d,e,f,g,h,i){var j=a.createRadialGradient(d+f*h,e+g*i,Math.min(f,g)/24,d+f/2,e+g/2,Math.max(f,g)/2);return j.addColorStop(0,c),j.addColorStop(1,b),j},drawPath:function(a,b,c,d,e,f,g,h){var i=a._element,j=a.getBodyRect();d&&Tb.addPadding(j,i,c+".padding",1);var k=Jb.clone(j),l=i.getStyle(c+".outline.width");l>0&&Tb.grow(k,l/2,l/2);var m=a.setShadow(a,b,k);0!=i.getAngle()&&(i instanceof Ld||(j=i.getOriginalRect()),Ib.Util.rotateCanvas(m,j,i.getAngle()));var n,o=i.getStyle(c+".fill");if(o){n=a._innerColor&&!vc.hasDefault(a._element)?a._innerColor:i.getStyle(c+".fill.color");var p=i.getStyle(c+".gradient");p?Xb.fill(m,n,p,i.getStyle(c+".gradient.color"),j):m.fillStyle=n}var q=i.getStyle(c+".shape"),r=i.getStyle("group.shape.roundrect.radius");if(o){if(m.beginPath(),f)Xb.drawLinePoints(m,f,null,g,h);else if("roundrect"===q&&"group"===c){var s={};s.topLeft=r,s.topRight=r,s.bottomLeft=r,s.bottomRight=r,Xb.drawVector(m,q,null,j,s)}else Xb.drawVector(m,q,null,j);m.fill()}if(l>0){if(m.lineWidth=l,m.lineCap=i.getStyle(c+".cap"),m.lineJoin=i.getStyle(c+".join"),m.strokeStyle=i.getStyle(c+".outline.color"),m.beginPath(),f)Xb.drawLinePoints(m,f,e,g,h);else if("roundrect"===q&&"group"===c){var s={};s.topLeft=r,s.topRight=r,s.bottomLeft=r,s.bottomRight=r,Xb.drawVector(m,q,e,j,s)}else Xb.drawVector(m,q,e,j);m.stroke()}return k},draw3DRect:function(a,b,c,d,e,f,g){if(0!==c){arguments.length<=4&&(g=d.height,f=d.width,e=d.y,d=d.x);var h=c>0;c=Math.abs(c);var i,j;if(a.lineWidth=1,a.lineCap="square",1===c)i=Xb.brighter(b),j=Xb.darker(b),a.strokeStyle=h?i:j,a.beginPath(),a.moveTo(d,e),a.lineTo(d,e+g),a.moveTo(d,e),a.lineTo(d+f,e),a.closePath(),a.stroke(),a.strokeStyle=h?j:i,a.beginPath(),a.moveTo(d,e+g),a.lineTo(d+f,e+g),a.moveTo(d+f,e),a.lineTo(d+f,e+g),a.closePath(),a.stroke();else for(var k=2*c,l=50/k,m=0;k>m;m++)i=Xb.brighter(b,50-m*l),j=Xb.darker(b,50-m*l),d+=.5,e+=.5,f-=1,g-=1,a.strokeStyle=h?i:j,a.beginPath(),a.moveTo(d,e),a.lineTo(d,e+g),a.moveTo(d,e),a.lineTo(d+f,e),a.closePath(),a.stroke(),a.strokeStyle=h?j:i,a.beginPath(),a.moveTo(d,e+g),a.lineTo(d+f,e+g),a.moveTo(d+f,e),a.lineTo(d+f,e+g),a.closePath(),a.stroke()}},brighter:function(a,b){return b||(b=50),Xb.adjustBrightness2(a,b)},darker:function(a,b){return b||(b=50),Xb.adjustBrightness2(a,-b)},adjustBrightness2:function(a,b){var c,d,e;if(0===b)return a;var f=rd(a);return 0>b?(b=(100+b)/100,c=Math.ceil(f.r*b),d=Math.ceil(f.g*b),e=Math.ceil(f.b*b)):(b/=100,c=f.r,d=f.g,e=f.b,c+=(255-c)*b,d+=(255-d)*b,e+=(255-e)*b,c=Math.min(Math.ceil(c),255),d=Math.min(Math.ceil(d),255),e=Math.min(Math.ceil(e),255)),"rgba("+c+","+d+","+e+",1)"},getColorArray:function(a){return qd.clearRect(0,0,1,1),qd.fillStyle=a,qd.fillRect(0,0,1,1),qd.getImageData(0,0,1,1).data},hit:function(a,b,c,d){if(!a)return!1;var e=a._viewRect;if(!e)return!1;if(b-=e.x,c-=e.y,0>b||0>c||b>=e.width||c>=e.height)return!1;try{for(var f=a.getContext("2d").getImageData(b,c,1,1),g=f.data,h=0,i=g.length;i>h;h+=4)if(0!==g[h+3])return!0}catch(j){return!0}return!1},intersects:function(a,b){if(!a)return!1;if(b=Tb.intersection(b,a._viewRect),!b)return!1;b.x-=a._viewRect.x,b.y-=a._viewRect.y;try{for(var c=a.getContext("2d").getImageData(b.x,b.y,b.width,b.height),d=c.data,e=0,f=d.length;f>e;e+=4)if(0!==d[e+3])return!0}catch(g){}return!1},strokeRect:function(a,b,c,d){b&&(a.beginPath(),a.strokeStyle=c?c:Ib.Util.randomColor(),a.lineWidth=d?d:2,a.strokeRect(b.x,b.y,b.width,b.height),a.stroke())}};Jb.g=Xb;var Yb,Zb={"linear.southwest":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e+g,d+f,e);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.southeast":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e+g,d,e);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.northwest":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e+g,d,e);return h.addColorStop(0,b),h.addColorStop(1,c),h},"linear.northeast":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e,d,e+g);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.north":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d,e+g);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.south":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d,e+g);return h.addColorStop(0,b),h.addColorStop(1,c),h},"linear.west":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e);return h.addColorStop(0,c),h.addColorStop(1,b),h},"linear.east":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e);return h.addColorStop(0,b),h.addColorStop(1,c),h},"radial.center":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.5,.5)},"radial.southwest":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.25,.75)},"radial.southeast":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.75,.75)},"radial.northwest":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.25,.25)},"radial.northeast":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.75,.25);

},"radial.north":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.5,.25)},"radial.south":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.5,.75)},"radial.west":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.25,.5)},"radial.east":function(a,b,c,d,e,f,g){return Xb.createRadialGradient(a,b,c,d,e,f,g,.75,.5)},"spread.horizontal":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.vertical":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d,e+g);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.diagonal":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d+f,e,d,e+g);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.antidiagonal":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e,d+f,e+g);return h.addColorStop(0,b),h.addColorStop(.5,c),h.addColorStop(1,b),h},"spread.north":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e-g/4,d,e+g+g/4);return h.addColorStop(0,b),h.addColorStop(1/3,c),h.addColorStop(2/3,b),h.addColorStop(1,c),h},"spread.south":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d,e-g/4,d,e+g+g/4);return h.addColorStop(0,c),h.addColorStop(1/3,b),h.addColorStop(2/3,c),h.addColorStop(1,b),h},"spread.west":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d-f/4,e,d+f+f/4,e);return h.addColorStop(0,b),h.addColorStop(1/3,c),h.addColorStop(2/3,b),h.addColorStop(1,c),h},"spread.east":function(a,b,c,d,e,f,g){var h=a.createLinearGradient(d-f/4,e,d+f+f/4,e);return h.addColorStop(0,c),h.addColorStop(1/3,b),h.addColorStop(2/3,c),h.addColorStop(1,b),h}},$b=0xdeadbeefcafe,_b=15715070==(16777215&$b);_b&&"Microsoft Internet Explorer"==Nb.appName?(c.prototype.am=f,Yb=30):_b&&"Netscape"!=Nb.appName?(c.prototype.am=e,Yb=26):(c.prototype.am=g,Yb=28),c.prototype.DB=Yb,c.prototype.DM=(1<<Yb)-1,c.prototype.DV=1<<Yb;var ac=52;c.prototype.FV=Math.pow(2,ac),c.prototype.F1=ac-Yb,c.prototype.F2=2*Yb-ac;var bc,cc,dc="0123456789abcdefghijklmnopqrstuvwxyz",ec=new Array;for(bc="0".charCodeAt(0),cc=0;9>=cc;++cc)ec[bc++]=cc;for(bc="a".charCodeAt(0),cc=10;36>cc;++cc)ec[bc++]=cc;for(bc="A".charCodeAt(0),cc=10;36>cc;++cc)ec[bc++]=cc;E.prototype.convert=F,E.prototype.revert=G,E.prototype.reduce=H,E.prototype.mulTo=I,E.prototype.sqrTo=J,L.prototype.convert=M,L.prototype.revert=N,L.prototype.reduce=O,L.prototype.mulTo=Q,L.prototype.sqrTo=P,c.prototype.copyTo=k,c.prototype.fromInt=l,c.prototype.fromString=n,c.prototype.clamp=o,c.prototype.dlShiftTo=v,c.prototype.drShiftTo=w,c.prototype.lShiftTo=x,c.prototype.rShiftTo=y,c.prototype.subTo=z,c.prototype.multiplyTo=A,c.prototype.squareTo=B,c.prototype.divRemTo=C,c.prototype.invDigit=K,c.prototype.isEven=R,c.prototype.exp=S,c.prototype.toString=p,c.prototype.negate=q,c.prototype.abs=r,c.prototype.compareTo=s,c.prototype.bitLength=u,c.prototype.mod=D,c.prototype.modPowInt=T,c.ZERO=m(0),c.ONE=m(1),Ka.prototype.convert=La,Ka.prototype.revert=La,Ka.prototype.mulTo=Ma,Ka.prototype.sqrTo=Na,Ra.prototype.convert=Sa,Ra.prototype.revert=Ta,Ra.prototype.reduce=Ua,Ra.prototype.mulTo=Wa,Ra.prototype.sqrTo=Va;var fc=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],gc=(1<<26)/fc[fc.length-1];c.prototype.chunkSize=Y,c.prototype.toRadix=$,c.prototype.fromRadix=_,c.prototype.fromNumber=aa,c.prototype.bitwiseTo=fa,c.prototype.changeBit=wa,c.prototype.addTo=Aa,c.prototype.dMultiply=Ia,c.prototype.dAddOffset=Ja,c.prototype.multiplyLowerTo=Pa,c.prototype.multiplyUpperTo=Qa,c.prototype.modInt=Za,c.prototype.millerRabin=ab,c.prototype.clone=U,c.prototype.intValue=V,c.prototype.byteValue=W,c.prototype.shortValue=X,c.prototype.signum=Z,c.prototype.toByteArray=ba,c.prototype.equals=ca,c.prototype.min=da,c.prototype.max=ea,c.prototype.and=ha,c.prototype.or=ja,c.prototype.xor=la,c.prototype.andNot=na,c.prototype.not=oa,c.prototype.shiftLeft=pa,c.prototype.shiftRight=qa,c.prototype.getLowestSetBit=sa,c.prototype.bitCount=ua,c.prototype.testBit=va,c.prototype.setBit=xa,c.prototype.clearBit=ya,c.prototype.flipBit=za,c.prototype.add=Ba,c.prototype.subtract=Ca,c.prototype.multiply=Da,c.prototype.divide=Fa,c.prototype.remainder=Ga,c.prototype.divideAndRemainder=Ha,c.prototype.modPow=Xa,c.prototype.modInverse=$a,c.prototype.pow=Oa,c.prototype.gcd=Ya,c.prototype.isProbablePrime=_a,c.prototype.square=Ea,bb.prototype.init=cb,bb.prototype.next=db;var hc,ic,jc,kc=256;if(null==ic){ic=new Array,jc=0;var lc;if("Netscape"==Nb.appName&&Nb.appVersion<"5"&&a.crypto){var mc=a.crypto.random(32);for(lc=0;lc<mc.length;++lc)ic[jc++]=255&mc.charCodeAt(lc)}for(;kc>jc;)lc=Math.floor(65536*Math.random()),ic[jc++]=lc>>>8,ic[jc++]=255&lc;jc=0,gb()}jb.prototype.nextBytes=ib;mb.prototype.doPublic=ob,mb.prototype.setPublic=nb,mb.prototype.encrypt=pb,mb.prototype.doPrivate=tb,mb.prototype.setPrivate=rb,mb.prototype.setPrivateEx=sb,mb.prototype.decrypt=ub;var nc=function(){oc.v(Kb)},oc={},pc="6a384c1259bdb5e731ec96b3174683f48a2c56a85e52e7a5bb20b58711ce50c1a294bd5e1d1752e766085e9ae94bae6d217c25dbb5fcdb86a8a9a7e180fa066723d00fcb85fcf7c9d29f8cc8859f53244a49c0bc30dcc45156daf8843ce1d24fe8ebc9a3c186bb26e9d0714041aef160304c1db8cc5728cf4acb39d29755f319",qc="10001";oc.cross=function(a){if(a){for(var b="",c=0;c<a.length;)c+1<a.length?(b+=a[c+1],b+=a[c]):b+=a[c],c+=2;return b}return null},oc.reverse=function(a){if(a){for(var b="",c=a.length;c>0;c--)b+=a[c-1];return b}return null},oc.v=function(a){if(a){var b=oc;if(b.start=null,b.beginDate=null,b.end=null,b.endDate=null,b.gis=null,b["3D"]=null,b["3d"]=null,b.l=null,b.__li__=null,a.indexOf("signature=")>0){var c=a.split("signature="),d=c[0],e=c[1],f=new mb;f.setPublic(pc,qc);for(var g=e,h=g.length,i=256,j=0,k="",l="";h>j;)k=g.substr(j,i),l+=f.decrypt(k),j+=i;if(l===d)return b.i(a),!0}}return!1},oc.i=function(a){var c=oc;c.__li__=a;var d,e,f,g,h,i=a.split("\n");for(d=i.length-1;d>=0;d--)e=i[d],h=e.split("="),f=h[0],g=h[1],c[f]=g;c.start!=b&&(c.beginDate=new Date(Date.parse(c.start.replace(/-/g,"/")))),c.end!=b&&(c.endDate=new Date(Date.parse(c.end.replace(/-/g,"/"))));var j=c.gis;j!=b&&(j=parseInt(j)),j&&(c._isPermissionGIS=!0);var k=c["3D"]||c["3d"];k!=b&&(k=parseInt(k)),k&&(c._isPermission3D=!0),c["3D"]&&(c._isPermission3D=!0),c.l!=b&&(c.version=c.l)};var rc=function(a){return a.__li__!==b&&!a._isPermission3D},sc=function(a){if(!rc(a))return!0;var b=new Date;return null!=a.beginDate&&a.beginDate.getTime()-b.getTime()>=0||null!=a.endDate&&a.endDate.getTime()-b.getTime()<=0},tc=function(){return sc(oc)?!1:oc._isPermissionGIS};oc.$z=function(a){var b=new mb;b.setPublic(pc,qc);for(var c=a,d=c.length,e=256,f=0,g="",h="";d>f;)g=c.substr(f,e),h+=b.decrypt(g),f+=e;return h},oc.twm=function(a){var c=oc,d=c.$z("4cd18113d0c7046bfe51f7a3fbd41c2b7cf14dd785d6ea7cec9da17710d3acfb8ce0cb9cf10839f4bd51e88819de19cdc0db09278584396156fcb65abe0353ac49d01326b30efa0ea98a07da9f8ceeb7572fc1b37b5965ba6103ccba4913b62e36e49425c6ff21a2f008830c59cff8f29058769f858c8a9f0bab3eaea7fb8a9e"),e=this.type,f=this.markText,g=c.$z("648be38cd61c870e95ffc1ea0676af40736c1365015abc326e891a4de67b4de3d4b05da70b9aebedc83ec26ecf71eb74c72f42f6d9a4be2d507d2f67d2860b7b66e3ba1d565e15923f2db335ff922eef17c01b59818b583d5656412d6cc9d9ba70001c2c88e3efd492c6b13a07fda5f325b333138a2036f4696542ec137cc341");if(a[g]=c.__li__,"3"!==e||sc(oc)||f!==b){a.__liLabel==b&&(a.__liLabel=Ob.createElement("div")),c.startDate===b&&(c.startDate=new Date);var h=(new Date).getTime()-c.startDate.getTime();if(!(3e5>h)){var i=sc(c)&&h>3e5,j=f;if(i?j=c.$z("0dd629dbd0ce341ecdd447e35ddc3135a0b46916f7571a687f38ae665cf0ae095fee885e14329caa75112d8787508da17285b0897845d8ccae73e6a2727dd19f1ca335fe139d0e60d240f9ececc78f81c2c5667f51aeed4135b9c4bb436b8acb7cd418eeeb404bc4f3bcdedb481ac0edff7644435ce2b9f2bda78c892bd56d73"):"2"!=e||j!==b&&""!=j?"1"!=e||f||(j=d):j=c.$z("644d54bf9c59afbd8a742a9e7e2731f23f149ccb7f04c3547548c50ac2d77faea108b55f1f6261e99869f1c06b84e8abdefdf45b5170048531421f3d528123972ba2f03d70f37c33f1341dc12f986e0089e42bab517e2a05b455d12d90991bbba9bc45c715a81943062ea5fa5408c8b1b9270d260cc5a67b38ecc4178ce512fc"),j!==b){var k=a,l=k.__liLabel;if(l.innerHTML=j,k._rootCanvas)l.type=e,l.mark=f,l.expired=i,k._xyz=l;else{var m=0,n=0;l.style.position="absolute";var o=k.getView().style;f!=b&&null!=f&&""!=f||"2"==e?(m=10-k.getView().scrollLeft,n=10-k.getView().scrollTop):(m=o.width.replace("px","")/2-50-k.getView().scrollLeft,n=o.height.replace("px","")/2-k.getView().scrollTop),l.style.right=m+"px",l.style.bottom=n+"px",l.style.fontSize="120%",i&&(k.getView().style.opacity=.1,l.style.color="red",l.style.fontSize="150%"),k.getView().appendChild(l)}}}}},Jb.validateLicense(Kb);var uc=function(a,b,c){this.g=a,this.onLength=b,this.offLength=c,this.isLine=!0,this.overflow=0,this.dashLength=b+c,this.pen={x:0,y:0}};Jb.ext(uc,Object,{_curveaccuracy:6,moveTo:function(a,b){this.pen={x:a,y:b},this.g.moveTo(a,b),this.start||(this.start={x:a,y:b})},lineTo:function(a,b){var c=a-this.pen.x,d=b-this.pen.y,e=Math.atan2(d,c),f=Math.cos(e),g=Math.sin(e),h=this.lineLength(this.pen.x,this.pen.y,a,b);if(this.overflow){if(this.overflow>h)return this.isLine?this._lineTo(a,b):this.moveTo(a,b),void(this.overflow-=h);if(this.isLine?this._lineTo(this.pen.x+f*this.overflow,this.pen.y+g*this.overflow):this.moveTo(this.pen.x+f*this.overflow,this.pen.y+g*this.overflow),h-=this.overflow,this.overflow=0,this.isLine=!this.isLine,!h)return}var i=Math.floor(h/this.dashLength);if(i){for(var j=f*this.onLength,k=g*this.onLength,l=f*this.offLength,m=g*this.offLength,n=0;i>n;n++)this.isLine?(this._lineTo(this.pen.x+j,this.pen.y+k),this.moveTo(this.pen.x+l,this.pen.y+m)):(this.moveTo(this.pen.x+l,this.pen.y+m),this._lineTo(this.pen.x+j,this.pen.y+k));h-=this.dashLength*i}this.isLine?h>this.onLength?(this._lineTo(this.pen.x+f*this.onLength,this.pen.y+g*this.onLength),this.moveTo(a,b),this.overflow=this.offLength-(h-this.onLength),this.isLine=!1):(this._lineTo(a,b),h==this.onLength?(this.overflow=0,this.isLine=!this.isLine):(this.overflow=this.onLength-h,this.moveTo(a,b))):h>this.offLength?(this.moveTo(this.pen.x+f*this.offLength,this.pen.y+g*this.offLength),this._lineTo(a,b),this.overflow=this.onLength-(h-this.offLength),this.isLine=!0):(this.moveTo(a,b),h==this.offLength?(this.overflow=0,this.isLine=!this.isLine):this.overflow=this.offLength-h)},quadraticCurveTo:function(a,b,c,d){var e,f=this.pen.x,g=this.pen.y,h=this.curveLength(f,g,a,b,c,d),i=0,j=0;if(this.overflow){if(this.overflow>h)return this.isLine?this._curveTo(a,b,c,d):this.moveTo(c,d),void(this.overflow-=h);if(i=this.overflow/h,e=this.curveSliceUpTo(f,g,a,b,c,d,i),this.isLine?this._curveTo(e[2],e[3],e[4],e[5]):this.moveTo(e[4],e[5]),this.overflow=0,this.isLine=!this.isLine,!h)return}var k=h-h*i,l=Math.floor(k/this.dashLength),m=this.onLength/h,n=this.offLength/h;if(l)for(var o=0;l>o;o++)this.isLine?(j=i+m,e=this.curveSlice(f,g,a,b,c,d,i,j),this._curveTo(e[2],e[3],e[4],e[5]),i=j,j=i+n,e=this.curveSlice(f,g,a,b,c,d,i,j),this.moveTo(e[4],e[5])):(j=i+n,e=this.curveSlice(f,g,a,b,c,d,i,j),this.moveTo(e[4],e[5]),i=j,j=i+m,e=this.curveSlice(f,g,a,b,c,d,i,j),this._curveTo(e[2],e[3],e[4],e[5])),i=j;k=h-h*i,this.isLine?k>this.onLength?(j=i+m,e=this.curveSlice(f,g,a,b,c,d,i,j),this._curveTo(e[2],e[3],e[4],e[5]),this.moveTo(c,d),this.overflow=this.offLength-(k-this.onLength),this.isLine=!1):(e=this.curveSliceFrom(f,g,a,b,c,d,i),this._curveTo(e[2],e[3],e[4],e[5]),h==this.onLength?(this.overflow=0,this.isLine=!this.isLine):(this.overflow=this.onLength-k,this.moveTo(c,d))):k>this.offLength?(j=i+n,e=this.curveSlice(f,g,a,b,c,d,i,j),this.moveTo(e[4],e[5]),e=this.curveSliceFrom(f,g,a,b,c,d,j),this._curveTo(e[2],e[3],e[4],e[5]),this.overflow=this.onLength-(k-this.offLength),this.isLine=!0):(this.moveTo(c,d),k==this.offLength?(this.overflow=0,this.isLine=!this.isLine):this.overflow=this.offLength-k)},bezierCurveTo:function(a,b,c,d,e,f){this.pen={x:e,y:f};var g=[this.onLength,this.offLength];this.g.setLineDash&&this.g.setLineDash(g),this.g.lineDash=g,this.g.bezierCurveTo(a,b,c,d,e,f)},rect:function(a,b,c,d){this.pen={x:a,y:b},this.moveTo(a,b),this.lineTo(a,b+d),this.lineTo(a+c,b+d),this.lineTo(a+c,b),this.lineTo(a,b)},closePath:function(){this.lineTo(this.start.x,this.start.y)},lineLength:function(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)},curveLength:function(a,b,c,d,e,f,g){for(var h,i,j,k,l,m,n,o=0,p=a,q=b,r=g>0?g:this._curveaccuracy,s=1;r>=s;s++)j=s/r,k=1-j,l=k*k,m=2*j*k,n=j*j,h=l*a+m*c+n*e,i=l*b+m*d+n*f,o+=this.lineLength(p,q,h,i),p=h,q=i;return o},curveSlice:function(a,b,c,d,e,f,g,h){if(0==g)return this.curveSliceUpTo(a,b,c,d,e,f,h);if(1==h)return this.curveSliceFrom(a,b,c,d,e,f,g);var i=this.curveSliceUpTo(a,b,c,d,e,f,h);return i.push(g/h),this.curveSliceFrom.apply(this,i)},curveSliceUpTo:function(a,b,c,d,e,f,g){if(1!=g){var h=c+(e-c)*g,i=d+(f-d)*g;c=a+(c-a)*g,d=b+(d-b)*g,e=c+(h-c)*g,f=d+(i-d)*g}return[a,b,c,d,e,f]},curveSliceFrom:function(a,b,c,d,e,f,g){if(1!=g){var h=a+(c-a)*g,i=b+(d-b)*g;c+=(e-c)*g,d+=(f-d)*g,a=h+(c-h)*g,b=i+(d-i)*g}return[a,b,c,d,e,f]},_lineTo:function(a,b){(a!=this.pen.x||b!=this.pen.y)&&(this.pen={x:a,y:b},this.g.lineTo(a,b))},_curveTo:function(a,b,c,d){(a!=c||b!=d||c!=this.pen.x||d!=this.pen.y)&&(this.pen={x:c,y:d},this.g.quadraticCurveTo(a,b,c,d))}}),Jb.DashedLine=uc;var vc={DEFAULTS:{"default":1,"default.vector":1,"vector.default":1},VECTORS:{vector:1,"default.vector":1,"vector.default":1},hasDefault:function(a){if(a instanceof Jd){var b=a.getStyle("body.type");return 1===vc.DEFAULTS[b]}return!0},hasVector:function(a){if(a instanceof Jd){var b=a.getStyle("body.type");return 1===vc.VECTORS[b]}return!1},hasAgentLinks:function(a){for(var b=a.getChildrenSize(),c=0;b>c;c++){var d=a.getChildAt(c);if(d instanceof Jd&&vc.hasAgentLinks(d))return!0}return a.hasAgentLinks()},getParents:function(a,b,c){c||(c=!0);for(var d=new md,e=a._parent;null!=e&&e!==b;)d.add(e,0),e=e._parent;return c&&null!=e&&e===b&&d.add(e,0),d},getSubGl3dview:function(a){if(!a)return null;if(a instanceof Ib.Link){var b=a._fromAgent,c=a._toAgent;if(!b||!c)return null;var d=vc.getSubGl3dview(b),e=vc.getSubGl3dview(c);return d===e?d:null}var f=a._parent;if(!f)return null;for(;f instanceof Ib.Link&&!f.ISubGl3dview;)f=f._parent;return f.ISubGl3dview?f:vc.getSubGl3dview(f)},figureSameSubGl3dviewAgent:function(a){if(!a)return null;for(var b=a._parent;b instanceof Ld;){if(!(b._parent instanceof Ld))return b.isExpanded()?a:b;b.isExpanded()||(a=b),b=b._parent}return a},figureSpanSubGl3dviewAgent:function(a,b){if(!a||!b)return null;var c=vc.getSubGl3dview(a),d=vc.getSubGl3dview(b);if(c!=d){for(;null!=d&&c!=d;)d=vc.getSubGl3dview(d);if(c===d)return a;var e=new md;e.add(a,0);for(var f=a._parent;f instanceof Jd&&!b.isDescendantOf(f);)e.add(f,0),f=f._parent;for(var g=e.size(),h=0;g>h;h++){var i=e.get(h);if(i instanceof Ld&&!i.isExpanded())return i;if(i.ISubGl3dview)return i}return a}return a},figureFromAgent:function(a){if(a.isLooped())return a.getFromNode();var b=vc.figureSameSubGl3dviewAgent(a.getFromNode()),c=vc.figureSameSubGl3dviewAgent(a.getToNode());return b===c?a.getFromNode():vc.figureSpanSubGl3dviewAgent(b,c)},figureToAgent:function(a){if(a.isLooped())return a.getToNode();var b=vc.figureSameSubGl3dviewAgent(a.getFromNode()),c=vc.figureSameSubGl3dviewAgent(a.getToNode());return b===c?a.getToNode():vc.figureSpanSubGl3dviewAgent(c,b)},getBundleLinks:function(a,b){if(!a||!b)return null;var c,d,e,f;if(a===b){if(f=a.getLoopedLinks(),!f)return null;f=new md(f)}else{var g=a.getAgentLinks(),h=b.getAgentLinks();if(!g||!h)return null;for(d=g.size(),c=0;d>c;c++)e=g.get(c),h.contains(e)&&(f||(f=new md),f.add(e))}if(null!=f)for(c=0;c<f.size();c++)e=f.get(c),e.getStyle("link.bundle.enable")||(e._setBundleLinks(null),f.removeAt(c),c--);return f},resetBundleLinks:function(a,b){var c=vc.getBundleLinks(a,b);if(c&&0!==c.size()){var d=null;if(1===c.size())return d=c.get(0),void d._setBundleLinks(null);var e,f,g=new md;for(e=0;e<c.size();e++)d=c.get(e),f=d.getStyle("link.bundle.id"),g.indexOf(f)<0&&g.add(f);g.sort();var h,i,j=new md;for(i=0;i<g.size();i++){f=g.get(i);var k=new md;for(e=0;e<c.size();e++)d=c.get(e),f===d.getStyle("link.bundle.id")&&k.add(d);h=new Ib.BundleLinks(k,j),j.add(h)}for(i=0;i<j.size();i++)for(h=j.get(i),e=0;e<h.getLinks().size();e++)d=h.getLinks().get(e),d._setBundleLinks(h)}},moveElements:function(a,b,c,d){for(var e=vc.filterMovingElements(a,d),f=e.size(),g=0;f>g;g++)e.get(g).translate(b,c)},filterMovingElements:function(a,b){for(var c=new md,d=a.size(),e=0;d>e;e++){var f=a.get(e);if(f instanceof Jd&&(!b||b(f))){for(var g=!0,h=c.toArray(),i=0;i<h.length;i++){var j=h[i];g&&j instanceof Ib.Follower&&f instanceof Ib.Follower&&f.isLoopedHostOn(j)?g=!1:j instanceof Ib.Follower&&j.isHostOn(f)?c.remove(j):g&&f instanceof Ib.Follower&&j instanceof Jd&&f.isHostOn(j)?g=!1:vc.isDescendantOfGroup(j,f)?c.remove(j):g&&vc.isDescendantOfGroup(f,j)&&(g=!1)}g&&c.add(f)}}return c},isDescendantOfGroup:function(a,b){if(!(a&&b instanceof Ld))return!1;if(!b.hasChildren())return!1;for(a=a._parent;a instanceof Ld;){if(a===b)return!0;a=a._parent}return!1}};Jb.element=vc;var wc={between:function(a,b,c){return c>=a&&b>=c?!0:c>=b&&a>=c?!0:!1},considerEast:function(a,b,c){return b?wc.between(b.x,c.x,a.x)?c.x>b.x:Math.abs(b.x-a.x)>Math.abs(c.x-a.x):!0},considerWest:function(a,b,c){return b?wc.between(b.x,c.x,a.x)?c.x<b.x:Math.abs(b.x-a.x)>Math.abs(c.x-a.x):!0},considerNorth:function(a,b,c){return b?wc.between(b.y,c.y,a.y)?c.y<b.y:Math.abs(b.y-a.y)>Math.abs(c.y-a.y):!0},considerSouth:function(a,b,c){return b?wc.between(b.y,c.y,a.y)?c.y>b.y:Math.abs(b.y-a.y)>Math.abs(c.y-a.y):!0},getHorizontalPoint:function(a,b,c){return wc.between(b.x,c.x,a.x)?{x:a.x,y:b.y}:Math.abs(a.x-b.x)<Math.abs(a.x-c.x)?{x:b.x,y:b.y}:{x:c.x,y:c.y}},getVerticalPoint:function(a,b,c){return wc.between(b.y,c.y,a.y)?{x:b.x,y:a.y}:Math.abs(a.y-b.y)<Math.abs(a.y-c.y)?{x:b.x,y:b.y}:{x:c.x,y:c.y}},getPoint:function(a,b,c,d,e){var f=Math.abs(d.x-c.x)>Math.abs(d.y-c.y);if("south"===e)return f&&wc.considerSouth(b,a,c)?wc.getHorizontalPoint(b,c,d):null;if("north"===e)return f&&wc.considerNorth(b,a,c)?wc.getHorizontalPoint(b,c,d):null;if("west"===e)return!f&&wc.considerWest(b,a,c)?wc.getVerticalPoint(b,c,d):null;if("east"===e)return!f&&wc.considerEast(b,a,c)?wc.getVerticalPoint(b,c,d):null;if("nearby"===e){var g;return g=f?wc.getHorizontalPoint(b,c,d):wc.getVerticalPoint(b,c,d),!a||Tb.getDistance(a,b)>Tb.getDistance(g,b)?g:null}return null},getBusPoint:function(a,b,c){var d,e=a.size();if(e>0){for(var f=a.get(0),g=1;e>g;g++){var h=a.get(g),i=wc.getPoint(d,b,f,h,c);i&&(d=i),f=h}d||(d={x:f.x,y:f.y})}return d}};Jb.bus=wc;var xc={createFromPoint:function(a,b){var c=a._element;if(!c.getFromAgent())return{x:0,y:0};var d,e=c.getStyle("link.from.position"),f=c.getStyle("link.from.xoffset"),g=c.getStyle("link.from.yoffset");if(a._gl3dview._edgeDetect){var h=c.getFromAgent(),i=c.getToAgent(),j=h.getImage(),k=Jb.images[j],l=h.getCenterLocation(),m=i.getCenterLocation(),n=this._getPointAngleDegree(m.x,m.y,l.x,l.y),o={x:0,y:0};if(k){var p=k._image;if(p&&cd(p)||p&&Ib.Util.getImageAsset(j)._cache)return cd(p)?k._edgeData||(k._edgeData=k._createEdgeData(p)):"object"==typeof p&&(k._edgeData||(k._edgeData=k._createEdgeData(Ib.Util.getImageAsset(j)._cache))),o.x=k._edgeData[n].x+h.getRect().x,o.y=k._edgeData[n].y+h.getRect().y,o}}if(!Jb.isCalculatingBus){if(Jb.isCalculatingBus=!0,c.getFromAgent()instanceof Ib.Bus){var q=c.getFromAgent();if(vc.hasVector(q)){var r=b?b._getElementZoomRect(a,q.getRect()):q.getRect(),s=q.getStyle("vector.shape");if("oval"===s)d=Tb.getEllipsePoint(r,xc.createToPoint(a));else if("circle"===s)d=Tb.getEllipsePoint(Tb.getCircleRect(r),xc.createToPoint(a));else if("rectangle"===s||"roundrect"===s){var t=new md;t.add({x:q.x,y:q.y}),t.add({x:q.x+q.width,y:q.y}),t.add({x:q.x+q.width,y:q.y+q.height}),t.add({x:q.x,y:q.y+q.height}),t.add({x:q.x,y:q.y}),t=b?b._getShapeNodeZoomPoints(a,t):t,d=wc.getBusPoint(t,xc.createToPoint(a),q.getStyle("bus.style"))}}else{var t=b?b._getShapeNodeZoomPoints(a,q.getPoints()):q.getPoints();d=wc.getBusPoint(t,xc.createToPoint(a),q.getStyle("bus.style"))}}Jb.isCalculatingBus=!1}return d?(d.x+=f,d.y+=g):d=a._gl3dview.getPosition(e,c.getFromAgent(),null,f,g,!0),d},createToPoint:function(a,b){var c=a._element;if(!c.getToAgent())return{x:0,y:0};var d,e=c.getStyle("link.to.position"),f=c.getStyle("link.to.xoffset"),g=c.getStyle("link.to.yoffset");if(a._gl3dview._edgeDetect){var h=c.getFromAgent(),i=c.getToAgent(),j=i.getImage(),k=Jb.images[j],l=h.getLocation(),m=i.getCenterLocation(),n=this._getPointAngleDegree(l.x,l.y,m.x,m.y),o={x:0,y:0};if(k){var p=k._image;if(p&&cd(p)||p&&Ib.Util.getImageAsset(j)._cache)return cd(p)?k._edgeData||(k._edgeData=k._createEdgeData(p)):"object"==typeof p&&(k._edgeData||(k._edgeData=k._createEdgeData(Ib.Util.getImageAsset(j)._cache))),o.x=k._edgeData[n].x+i.getRect().x,o.y=k._edgeData[n].y+i.getRect().y,o}}if(!Jb.isCalculatingBus){if(Jb.isCalculatingBus=!0,c.getToAgent()instanceof Ib.Bus){var q=c.getToAgent();if(vc.hasVector(q)){var r=b?b._getElementZoomRect(a,q.getRect()):q.getRect(),s=q.getStyle("vector.shape");if("oval"===s)d=Tb.getEllipsePoint(r,xc.createFromPoint(a));else if("circle"===s)d=Tb.getEllipsePoint(Tb.getCircleRect(r),xc.createFromPoint(a));else if("rectangle"===s||"roundrect"===s){var t=new md;t.add({x:q.x,y:q.y}),t.add({x:q.x+q.width,y:q.y}),t.add({x:q.x+q.width,y:q.y+q.height}),t.add({x:q.x,y:q.y+q.height}),t.add({x:q.x,y:q.y}),t=b?b._getShapeNodeZoomPoints(a,t):t,d=wc.getBusPoint(t,xc.createFromPoint(a),q.getStyle("bus.style"))}}else{var t=b?b._getShapeNodeZoomPoints(a,q.getPoints()):q.getPoints();d=wc.getBusPoint(t,xc.createFromPoint(a),q.getStyle("bus.style"))}}Jb.isCalculatingBus=!1}return d?(d.x+=f,d.y+=g):d=a._gl3dview.getPosition(e,c.getToAgent(),null,f,g,!0),d},fillLoopedPoints:function(a,b,c){var d,e=xc.getBundleGap(a,!0),f=e,g=a.getStyle("link.looped.type"),h=a.getStyle("link.looped.direction");if("north"===h)return"arc"===g?xc.drawArc(b.x+b.width/2,b.y,0,Math.PI,e,e,!1,c):(d={x:b.x+b.width/2,y:b.y},c.add({x:d.x+f,y:d.y}),c.add({x:d.x+f,y:d.y-e}),c.add({x:d.x-f,y:d.y-e}),c.add({x:d.x-f,y:d.y})),{x:b.x+b.width/2,y:b.y-e};if("northeast"===h)return"arc"===g?xc.drawArc(b.x+b.width,b.y,1.5*Math.PI,1.5*Math.PI,e,e,!1,c):(d={x:b.x+b.width,y:b.y},c.add({x:d.x,y:d.y+f}),c.add({x:d.x+f,y:d.y+f}),c.add({x:d.x+f,y:d.y-e}),c.add({x:d.x-f,y:d.y-e}),c.add({x:d.x-f,y:d.y})),{x:b.x+b.width+.707*e,y:b.y-.707*e};if("east"===h)return"arc"===g?xc.drawArc(b.x+b.width,b.y+b.height/2,1.5*Math.PI,Math.PI,e,e,!1,c):(d={x:b.x+b.width,y:b.y+b.height/2},c.add({x:d.x,y:d.y-f}),c.add({x:d.x+e,y:d.y-f}),c.add({x:d.x+e,y:d.y+f}),c.add({x:d.x,y:d.y+f})),{x:b.x+b.width+e,y:b.y+b.height/2};if("southeast"===h)return"arc"===g?xc.drawArc(b.x+b.width,b.y+b.height,Math.PI,1.5*Math.PI,e,e,!1,c):(d={x:b.x+b.width,y:b.y+b.height},c.add({x:d.x,y:d.y-f}),c.add({x:d.x+f,y:d.y-f}),c.add({x:d.x+f,y:d.y+e}),c.add({x:d.x-f,y:d.y+e}),c.add({x:d.x-f,y:d.y})),{x:b.x+b.width+.707*e,y:b.y+b.height+.707*e};if("south"===h)return"arc"===g?xc.drawArc(b.x+b.width/2,b.y+b.height,Math.PI,Math.PI,e,e,!1,c):(d={x:b.x+b.width/2,y:b.y+b.height},c.add({x:d.x-f,y:d.y}),c.add({x:d.x-f,y:d.y+e}),c.add({x:d.x+f,y:d.y+e}),c.add({x:d.x+f,y:d.y})),{x:b.x+b.width/2,y:b.y+b.height+e};if("southwest"===h)return"arc"===g?xc.drawArc(b.x,b.y+b.height,.5*Math.PI,1.5*Math.PI,e,e,!1,c):(d={x:b.x,y:b.y+b.height},c.add({x:d.x,y:d.y-f}),c.add({x:d.x-f,y:d.y-f}),c.add({x:d.x-f,y:d.y+e}),c.add({x:d.x+f,y:d.y+e}),c.add({x:d.x+f,y:d.y})),{x:b.x-.707*e,y:b.y+b.height+.707*e};if("west"===h)return"arc"===g?xc.drawArc(b.x,b.y+b.height/2,.5*Math.PI,Math.PI,e,e,!1,c):(d={x:b.x,y:b.y+b.height/2},c.add({x:d.x,y:d.y-f}),c.add({x:d.x-e,y:d.y-f}),c.add({x:d.x-e,y:d.y+f}),c.add({x:d.x,y:d.y+f})),{x:b.x-e,y:b.y+b.height/2};if("northwest"===h)return"arc"===g?xc.drawArc(b.x,b.y,0,1.5*Math.PI,e,e,!1,c):(d={x:b.x,y:b.y},c.add({x:d.x,y:d.y+f}),c.add({x:d.x-f,y:d.y+f}),c.add({x:d.x-f,y:d.y-e}),c.add({x:d.x+f,y:d.y-e}),c.add({x:d.x+f,y:d.y})),{x:b.x-.707*e,y:b.y-.707*e};throw"Can not resolve link looped direction '"+h+"'"},drawArc:function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s;if(Math.abs(d)>2*Math.PI&&(d=2*Math.PI),m=Math.ceil(Math.abs(d)/(Math.PI/4)),i=d/m,j=-i,k=-c,m>0){n=a+Math.cos(c)*e,o=b+Math.sin(-c)*f,h.add({x:n,y:o});for(var t=0;m>t;t++){k+=j,l=k-j/2,p=a+Math.cos(k)*e,q=b+Math.sin(k)*f,r=a+Math.cos(l)*(e/Math.cos(j/2)),s=b+Math.sin(l)*(f/Math.cos(j/2));var u=new md;u.add({x:r,y:s}),u.add({x:p,y:q}),h.add(u)}}},fillBundlePoints:function(a,c,d,e,f,g){{var h;a._element.getBundleCount(),a._element.getBundleIndex(),a.getStyle("link.bundle.expanded")}if("parallel"!==c&&0===(h=xc.getBundleGap(a,!1)))return f.add(d),f.add(e),Tb.getCenterPoint(d,e);h===b&&(h=xc.getBundleGap(a,!1));var i=xc.getBundleOffset(a),j=Tb.getDistance(d,e);if(g){var k=g.getSizeZoom();i*=k,h*=k}("arc"===c||"triangle"===c)&&f.add({x:0,y:0}),"arc"===c&&f.add({x:0,y:h}),f.add({x:i,y:h}),f.add({x:j-i,y:h}),"arc"===c&&f.add({x:j,y:h}),("arc"===c||"triangle"===c)&&f.add({x:j,y:0});for(var l=Math.atan2(e.y-d.y,e.x-d.x),m=Tb.createMatrix(l,0,0),n=0,o=f.size();o>n;n++){var p=f.get(n);p=m.transform(p),p.x+=d.x,p.y+=d.y,f.set(n,p)}if("arc"===c){var q=Tb.getCenterPoint(f.get(2),f.get(3)),r=new md;return r.add(f.get(1)),r.add(f.get(2)),f.set(1,r),r=new md,r.add(f.get(4)),r.add(f.get(5)),f.set(4,r),f.removeAt(5),f.removeAt(2),q}return xc.calculateCenterPoint(f)},calculateCenterPoint:function(a){var b=a.size();if(null==a||1>b)return{x:0,y:0};if(b%2===0){var c=b/2,d=a.get(c-1),e=a.get(c);return{x:(d.x+e.x)/2,y:(d.y+e.y)/2}}return a.get((b-1)/2)},getBundleOffset:function(a){var b=Tb.getDistance(a.getFromPoint(),a.getToPoint()),c=a.getStyle("link.bundle.offset");return b>2*c?c:b/2},getBundleGap:function(a,b){var c=a._element;if(!c.getBundleLinks())return b?c.getStyle("link.looped.gap"):0;for(var d=b?"link.looped.gap":"link.bundle.gap",e=null,f=0,g=0,h=c.getBundleLinks().getSiblings(),i=0,j=c.getStyle("link.bundle.independent"),k=c.getStyle("link.bundle.group.gap"),l=0,m=h.size();m>l;l++){var n=h.get(l);if(!j||n===c.getBundleLinks()){for(var o=0,p=n.getLinks().size();p>o;o++){var q=n.getLinks().get(o);if(j===q.getStyle("link.bundle.independent")&&a._gl3dview.isVisible(q)){if(null==e)e=q,i=q.getStyle(d);else{var r=q.getStyle(d);g+=i/2+r/2,i=r}q===c&&(f=g+k/2)}}g+=k}}if(b)return g-f+i;var s=f-g/2;return null!=e&&c.getFromAgent()!==e.getFromAgent()&&(s=-s),s},isTargetPriority:function(a,b,c){if(a){if(b.height<c.height)return b.height+c.height<Math.max(b.y+b.height,c.y+c.height)-Math.min(b.y,c.y)+b.height/2}else if(b.width<c.width)return b.width+c.width<Math.max(b.x+b.width,c.x+c.width)-Math.min(b.x,c.x)+b.width/2;return!0},calculateOrthogonalAndFlexionalLinkPoints:function(a,b,c,d){var e=xc.isHorizontal(a,b,c,d),f=new md;if(xc.isFlexionalTypeLink(a))xc.flexional(e,b,c,f,d.getStyle("link.extend"));else{xc.orthogonal(a,b,c,f,e,d);var g=xc.isSplitByPercent(a,d),h=g?xc.calculateSplitValueByPercent(a,e,b,c,d.getStyle("link.split.percent")):d.getStyle("link.split.value");0===h&&(e=!e)}var i;0===f.size()?xc.isTargetPriority(e,b,c)?(i={x:c.x+c.width/2,y:c.y+c.height/2},f.add(xc.rectanglePerimeter(b,!0,i)),f.add(xc.rectanglePerimeter(c,!1,f.get(f.size()-1)))):(i={x:b.x+b.width/2,y:b.y+b.height/2},i=xc.rectanglePerimeter(c,!1,i),f.add(xc.rectanglePerimeter(b,!0,i)),f.add(i)):(i=f.get(0),f.add(xc.rectanglePerimeter(b,!0,i),0),f.add(xc.rectanglePerimeter(c,!1,f.get(f.size()-1))));var j=f.size();if(2>j)return f;for(var k=f.get(0),l=1;j-1>l;l++){var m=f.get(l);m.x===k.x&&m.y===k.y&&(f.remove(m),j--,l--),k=m}return f},isHorizontal:function(a,b,c,d){if(a){if("flexional.horizontal"===a||"orthogonal.horizontal"===a||"orthogonal.H.V"===a||"extend.left"===a||"extend.right"===a)return!0;if("flexional.vertical"===a||"orthogonal.vertical"===a||"orthogonal.V.H"===a||"extend.top"===a||"extend.bottom"===a)return!1}var e=xc.calculateXGap(b,c),f=xc.calculateYGap(b,c);return e>=f},flexional:function(a,b,c,d,e){a?xc.flexionalHorizontal(b,c,d,e):xc.flexionalVertical(b,c,d,e)},isSplitByPercent:function(a,b){return b.getStyle("link.split.by.percent")},isExtendTypeLink:function(a){return a&&("extend.top"===a||"extend.left"===a||"extend.bottom"===a||"extend.right"===a)},isFlexionalTypeLink:function(a){return a&&("flexional"===a||"flexional.horizontal"===a||"flexional.vertical"===a)},calculateControlPoint:function(a,b,c,d,e){if("orthogonal.H.V"===a||"orthogonal.V.H"===a)return{x:d.x+d.width/2,y:d.y+d.height/2};var f;if(xc.isExtendTypeLink(a)){var g=Math.min(c.y,d.y),h=Math.min(c.x,d.x),i=Math.max(c.y+c.height,d.y+d.height),j=Math.max(c.x+c.width,d.x+d.width);if(f=e.getStyle("link.extend"),"extend.top"===a)return{x:(h+j)/2,y:g-f};if("extend.left"===a)return{x:h-f,y:(g+i)/2};if("extend.bottom"===a)return{x:(h+j)/2,y:i+f};if("extend.right"===a)return{x:j+f,y:(g+i)/2}}var k=xc.isSplitByPercent(a,e);if(f=k?xc.calculateSplitValueByPercent(a,b,c,d,e.getStyle("link.split.percent")):e.getStyle("link.split.value"),f===Number.NEGATIVE_INFINITY||f===Number.POSITIVE_INFINITY)return{x:d.x+d.width/2,y:d.y+d.height/2};if(0===f)return{x:c.x+c.width/2,y:c.y+c.height/2};if(b){var l=c.x+c.x+c.width<d.x+d.x+d.width;return{x:xc.calculateSplitLocation(l,f,c.x,c.width),y:c.y+c.height/2}}var m=c.y+c.y+c.height<d.y+d.y+d.height;return{x:c.x+c.width/2,y:xc.calculateSplitLocation(m,f,c.y,c.height)}},calculateGap:function(a,b,c,d){var e=Math.max(b,d)-Math.min(a,c);return e-(b-a+d-c)},calculateXGap:function(a,b){var c=Math.max(a.x+a.width,b.x+b.width)-Math.min(a.x,b.x);return c-a.width-b.width},calculateYGap:function(a,b){var c=Math.max(a.y+a.height,b.y+b.height)-Math.min(a.y,b.y);return c-a.height-b.height},calculateSplitValueByPercent:function(a,b,c,d,e){var f=xc.calculateSplitGapByPercent(e,b,c,d);return f*e},calculateSplitGapByPercent:function(a,b,c,d,e){return b?xc._calculateSplitGapByPercent(a,c.x,c.x+c.width,d.x,d.x+d.width):xc._calculateSplitGapByPercent(a,c.y,c.y+c.height,d.y,d.y+d.height)},_calculateSplitGapByPercent:function(a,b,c,d,e){var f=xc.calculateGap(b,c,d,e),g=d+e>b+c;if(f>0){if(1===a)return f+(e-d)/2;if(a>=0&&1>a)return f;if(0>a)return g?d-b:c-e}return Math.abs(g&&a>0||!g&&0>a?c-e:b-d)},calculateSplitPercentByControlPoint:function(a,b,c,d){return b?xc.calculateSplitPercent(a.x,c.x,c.x+c.width,d.x,d.x+d.width):xc.calculateSplitPercent(a.y,c.y,c.y+c.height,d.y,d.y+d.height)},calculateSplitPercent:function(a,b,c,d,e){if(a>=b&&c>=a)return 0;var f=xc.calculateGap(b,c,d,e);if(f>0&&a>=d&&e>=a)return 1;var g=d+e>b+c;if(f>0){if(a>Math.min(c,e)&&a<Math.max(b,d))return Math.abs(a-(g?c:b))/f;if(g){if(b>a)return(a-b)/(d-b)}else if(a>c)return(c-a)/(c-e)}return a>c?(g?a-c:c-a)/Math.abs(c-e):(g?a-b:b-a)/Math.abs(b-d)},calculateSplitLocation:function(a,b,c,d){return a===b>0?c+d+Math.abs(b):c-Math.abs(b)},calculateAngle:function(a,b){if(0!==a&&0!==b)return Math.atan2(a,b);if(0===a){if(b>0)return 0;if(0>b)return Math.PI}return a>0?Math.PI/2:-Math.PI/2},drawCorner:function(a,b){var c=a.size();if(!(3>c)){var d=b.getStyle("link.corner");if("none"!==d){for(var e,f,g,h,i=b.getStyle("link.xradius"),j=b.getStyle("link.yradius"),k=a.get(0),l=a.get(1),m=2;c>m;m++){var n=a.get(m),o=l.x-k.x,p=l.y-k.y,q=n.x-l.x,r=n.y-l.y,s=0===p;if(0===o&&0===r||0===p&&0===q)if(s?(e=Math.min(2===m?Math.abs(o):Math.abs(o)/2,i),f=Math.min(m===c-1?Math.abs(r):Math.abs(r)/2,j),g={x:l.x-(o>0?e:-e),y:l.y},h={x:l.x,y:l.y+(r>0?f:-f)}):(e=Math.min(m===c-1?Math.abs(q):Math.abs(q)/2,i),
f=Math.min(2===m?Math.abs(p):Math.abs(p)/2,j),g={x:l.x,y:l.y-(p>0?f:-f)},h={x:l.x+(q>0?e:-e),y:l.y}),a.remove(l),m--,c--,(g.x!==k.x||g.y!==k.y)&&(a.add(g,m),m++,c++),"bevel"===d)a.add(h,m),m++,c++;else if("round"===d){var t=new md;t.add(l),t.add(h),a.add(t,m),m++,c++}k=l,l=n}h&&h.x===l.x&&h.y===l.y&&a.remove(l)}}},orthogonal:function(a,b,c,d,e,f){var g=f.getStyle("link.control.point"),h=null==g;if(g){var i=Tb.unionRect(b,c);Tb.containsPoint(i,g)||(e=xc.calculateIsHorizontalByControlPoint(g.x,g.y,i.y,i.x,i.y+i.height,i.x+i.width))}else g=xc.calculateControlPoint(a,e,b,c,f);e?xc.sideToSide(b,c,g,d,h):xc.topToBottom(b,c,g,d,h)},calculateIsHorizontalByControlPoint:function(a,b,c,d,e,f){return c>b&&c-b>d-a&&c-b>a-f||b>e&&b-e>d-a&&b-e>a-f?!1:!0},contains:function(a,b,c){return b>=a.x&&b<=a.x+a.width&&c>=a.y&&c<=a.y+a.height},topToBottom:function(a,b,c,d,e){var f=Math.max(a.y,b.y),g=Math.min(a.y+a.height,b.y+b.height),h=c?c.y:g+(f-g)/2,i=a.x+a.width/2,j=b.x+b.width/2;if(!e&&c&&(c.x>=a.x&&c.x<=a.x+a.width&&(i=c.x),c.x>=b.x&&c.x<=b.x+b.width&&(j=c.x)),xc.contains(b,i,h)||xc.contains(a,i,h)||d.add({x:i,y:h}),xc.contains(b,j,h)||xc.contains(a,j,h)||d.add({x:j,y:h}),0===d.size())if(c)xc.contains(b,c.x,h)||xc.contains(a,c.x,h)||d.add({x:c.x,y:h});else{var k=Math.max(a.x,b.x),l=Math.min(a.x+a.width,b.x+b.width);d.add({x:k+(l-k)/2,y:h})}},sideToSide:function(a,b,c,d,e){var f=Math.max(a.x,b.x),g=Math.min(a.x+a.width,b.x+b.width),h=c?c.x:g+(f-g)/2,i=a.y+a.height/2,j=b.y+b.height/2;if(!e&&c&&(c.y>=a.y&&c.y<=a.y+a.height&&(i=c.y),c.y>=b.y&&c.y<=b.y+b.height&&(j=c.y)),xc.contains(b,h,i)||xc.contains(a,h,i)||d.add({x:h,y:i}),xc.contains(b,h,j)||xc.contains(a,h,j)||d.add({x:h,y:j}),0===d.size())if(c)xc.contains(b,h,c.y)||xc.contains(a,h,c.y)||d.add({x:h,y:c.y});else{var k=Math.max(a.y,b.y),l=Math.min(a.y+a.height,b.y+b.height);d.add({x:h,y:k+(l-k)/2})}},flexionalHorizontal:function(a,b,c,d){var e=b.x+b.width<a.x,f=a.x+a.width<b.x,g=e?a.x:a.x+a.width,h=a.y+a.height/2,i=f?b.x:b.x+b.width,j=b.y+b.height/2,k=d,l=e?-k:k,m={x:g+l,y:h};l=f?-k:k;var n={x:i+l,y:j};if(e===f){var o=e?Math.min(g,i)-d:Math.max(g,i)+d;c.add({x:o,y:h}),c.add({x:o,y:j})}else if(m.x<n.x===e){var p=h+(j-h)/2;c.add(m),c.add({x:m.x,y:p}),c.add({x:n.x,y:p}),c.add(n)}else c.add(m),c.add(n)},flexionalVertical:function(a,b,c,d){var e=b.y+b.height<a.y,f=a.y+a.height<b.y,g=a.x+a.width/2,h=e?a.y:a.y+a.height,i=b.x+b.width/2,j=f?b.y:b.y+b.height,k=d,l=e?-k:k,m={x:g,y:h+l};l=f?-k:k;var n={x:i,y:j+l};if(e===f){var o=e?Math.min(h,j)-d:Math.max(h,j)+d;c.add({x:g,y:o}),c.add({x:i,y:o})}else if(m.y<n.y===e){var p=g+(i-g)/2;c.add(m),c.add({x:p,y:m.y}),c.add({x:p,y:n.y}),c.add(n)}else c.add(m),c.add(n)},rectanglePerimeter:function(a,b,c){var d=a.x+a.width/2,e=a.y+a.height/2,f=c.x-d,g=c.y-e,h=Math.atan2(g,f),i={x:0,y:0},j=Math.PI,k=Math.PI/2,l=k-h,m=Math.atan2(a.height,a.width);return-j+m>h||h>j-m?(i.x=a.x,i.y=e-a.width*Math.tan(h)/2):-m>h?(i.y=a.y,i.x=d-a.height*Math.tan(l)/2):m>h?(i.x=a.x+a.width,i.y=e+a.width*Math.tan(h)/2):(i.y=a.y+a.height,i.x=d+a.height*Math.tan(l)/2),c.x>=a.x&&c.x<=a.x+a.width?i.x=c.x:c.y>=a.y&&c.y<=a.y+a.height&&(i.y=c.y),c.x<a.x?i.x=a.x:c.x>a.x+a.width&&(i.x=a.x+a.width),c.y<a.y?i.y=a.y:c.y>a.y+a.height&&(i.y=a.y+a.height),i},isSplitTypeLink:function(a){return a&&("orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.vertical"===a)},isOrthogonalOrFlexionalLink:function(a){if(a instanceof Ib.ShapeLink)return!1;if(a.isLooped())return!1;var b=a.getStyle("link.type");return xc.isOrthogonalOrFlexionalType(b)},isOrthogonalLink:function(a){if(a instanceof Ib.ShapeLink)return!1;if(a.isLooped())return!1;var b=a.getStyle("link.type");return xc.isOrthogonalType(b)},isOrthogonalOrFlexionalType:function(a){return"orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.H.V"===a||"orthogonal.vertical"===a||"orthogonal.V.H"===a||"extend.top"===a||"extend.left"===a||"extend.bottom"===a||"extend.right"===a||"flexional"===a||"flexional.horizontal"===a||"flexional.vertical"===a},isOrthogonalType:function(a){return"orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.H.V"===a||"orthogonal.vertical"===a||"orthogonal.V.H"===a||"extend.top"===a||"extend.left"===a||"extend.bottom"===a||"extend.right"===a},hasControlPoint:function(a){return"orthogonal"===a||"orthogonal.horizontal"===a||"orthogonal.vertical"===a||"extend.bottom"===a||"extend.left"===a||"extend.right"===a||"extend.top"===a},getControlPoint:function(a,b,c){if(!a)throw"link can't be null";var d=a.getStyle("link.type");if(!xc.hasControlPoint(d))return null;var e=a.getStyle("link.control.point");if(e)return e;var f,g;if(null==b?(f=a.getFromAgent().getRect(),g=a.getToAgent().getRect()):(f=xc.getLinkSourceBounds(b,c),g=xc.getLinkTargetBounds(b,c)),null==f||null==g)return null;var h=xc.isHorizontal(d,f,g,a);return xc.calculateControlPoint(a.getStyle("link.type"),h,f,g,a)},getSplitValueByControlPoint:function(a,b,c,d,e){if("extend.top"===b)return Math.min(c.y,d.y)-a.y;if("extend.left"===b)return Math.min(c.x,d.x)-a.x;if("extend.bottom"===b)return a.y-Math.max(c.y+c.height,d.y+d.height);if("extend.right"===b)return a.x-Math.max(c.x+c.width,d.x+d.width);var f;if(e){var g=c.x+c.x+c.width<d.x+d.x+d.width;return f=g?a.x-c.x+c.width:c.x-a.x,f>0?f:f>-c.width?0:f+c.width}var h=c.y+c.y+c.height<d.y+d.y+d.height;return f=h?a.y-c.y-c.height:c.y-a.y,f>0?f:f>-c.height?0:f+c.height},isHorizontalByControlPoint:function(a,b,c,d,e){var f=Tb.unionRect(c,d);return Tb.containsPoint(f,a)?xc.isHorizontal(b,c,d,e):xc.calculateIsHorizontalByControlPoint(a.x,a.y,f.y,f.x,f.y+f.height,f.x+f.width)},setParamsByControlPoint:function(a,b,c,d,e){var f=xc.isHorizontalByControlPoint(a,d,b,c,e),g=e.getStyle("link.control.point");if((g||"orthogonal"===d||"orthogonal.horizontal"===d||"orthogonal.vertical"===d)&&e.setStyle("link.type",f?"orthogonal.horizontal":"orthogonal.vertical"),g)return void e.setStyle("link.control.point",a);var h=xc.getSplitValueByControlPoint(a,d,b,c,f);if(xc.isExtendTypeLink(d))return void e.setStyle("link.extend",h);var i=xc.isSplitByPercent(d,e);return i?0===h?void e.setStyle("link.split.percent",0):void e.setStyle("link.split.percent",xc.calculateSplitPercentByControlPoint(a,f,b,c)):void e.setStyle("link.split.value",h)},getLinkNodeBounds:function(a,b,c,d,e,f){if(f){var g=f.getLocationZoom();f.getSizeZoom(a)}if(null==a)return null;var h;if(d)f?(h=a.getZoomBodyRect(),h.x+=b,h.y+=c):(h=a.getBodyRect(),h.x+=b,h.y+=c);else{var i=a.getGl3dview().getPosition(e,a,null,b,c);h=f?{x:i.x*g,y:i.y*g,width:1,height:1}:{x:i.x,y:i.y,width:1,height:1}}return h},getLinkSourceBounds:function(a,b){var c=a._element,d=a.getGl3dview().getElementUI(c.getFromAgent());if(null==d)return null;var e=c.getStyle("link.from.position"),f=c.getStyle("link.from.xoffset"),g=c.getStyle("link.from.yoffset"),h=c.getStyle("link.from.at.edge");return xc.getLinkNodeBounds(d,f,g,h,e,b)},getLinkTargetBounds:function(a,b){var c=a._element,d=a.getGl3dview().getElementUI(c.getToAgent());if(null==d)return null;var e=c.getStyle("link.to.position"),f=c.getStyle("link.to.xoffset"),g=c.getStyle("link.to.yoffset"),h=c.getStyle("link.to.at.edge");return xc.getLinkNodeBounds(d,f,g,h,e,b)},orthogonalAndFlexional:function(a,b,c){var d=xc.getLinkSourceBounds(a,c);if(null==d)return null;var e=xc.getLinkTargetBounds(a,c);if(null==e)return null;var f=xc.calculateOrthogonalAndFlexionalLinkPoints(b,d,e,a._element);return xc.offsetLink(a,f),a.setHotSpot(xc.calculateCenterPoint(f)),"flexional"!==b&&xc.drawCorner(f,a._element),f},offsetLink:function(a,b){var c=a._element,d=c.isBundleAgent();if(!d){var e=xc.getBundleGap(a,!1);if(0!==e)for(var f,g,h=!1,i=!1,j=b.get(0),k=Jb.clone(j),l=1,m=b.size();m>l;l++){var n=b.get(l),o=n.x-k.x,p=n.y-k.y;k=Jb.clone(n),g=xc.calculateAngle(o,p),0===o?((g-f)%Math.PI===0&&(g-f)%(2*Math.PI)!==0&&(h=!h,h&&(p=-p)),(g-f)%Math.PI!==0&&(j.x+=0>p?e:-e),n.x+=0>p?e:-e):0===p&&((g-f)%Math.PI===0&&(g-f)%(2*Math.PI)!==0&&(i=!i,i&&(o=-o)),f&&(g-f)%Math.PI===0||(j.y-=0>o?e:-e),n.y-=0>o?e:-e),f=g,j=n}}},_getPointAngleDegree:function(a,b,c,d){var e=c-a,f=d-b,g=Math.atan2(f,e);return g=g/Math.PI*180,g=parseInt(g)+180,g%=360}};Jb.link=xc;var yc={findMoveToBottomDatas:function(a,b,c){for(var d=0;d<c.size();d++){var e=c.get(d);a.contains(e)&&b.add(e)}for(d=0;d<c.size();d++)e=c.get(d),yc.findMoveToBottomDatas(a,b,e.getChildren())},findMoveToTopDatas:function(a,b,c){for(var d=0;d<c.size();d++){var e=c.get(c.size()-1-d);a.contains(e)&&b.add(e)}for(d=0;d<c.size();d++)e=c.get(d),yc.findMoveToTopDatas(a,b,e.getChildren())},findMoveUpDatas:function(a,b,c){for(var d=!1,e=0;e<c.size();e++){var f=c.get(e);a.contains(f)?d&&b.add(f):d=!0}for(e=0;e<c.size();e++)f=c.get(e),yc.findMoveUpDatas(a,b,f.getChildren())},findMoveDownDatas:function(a,b,c){for(var d=!1,e=0;e<c.size();e++){var f=c.get(c.size()-1-e);a.contains(f)?d&&b.add(f):d=!0}for(e=0;e<c.size();e++)f=c.get(e),yc.findMoveDownDatas(a,b,f.getChildren())},doLayout:function(a,b){b=b||{},b.type=b.type||"round",b.animate=b.animate||!0,b.elements=b.elements||new Ib.List,b.repulsion=b.repulsion||1,b.expandGroup=b.expandGroup||!1;var c=new Ib.layout.AutoLayouter(a.getElementBox());c.getElements=function(){}}};Jb.box=yc;var zc={scrollLeft:function(){return zc._filterResults(a.pageXOffset?a.pageXOffset:0,Ob.documentElement?Ob.documentElement.scrollLeft:0,Ob.body?Ob.body.scrollLeft:0)},scrollTop:function(){return zc._filterResults(a.pageYOffset?a.pageYOffset:0,Ob.documentElement?Ob.documentElement.scrollTop:0,Ob.body?Ob.body.scrollTop:0)},_filterResults:function(a,b,c){var d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d},isSingleTouch:function(a){return a.touches&&1==a.touches.length},isMultiTouch:function(a){return a.touches&&a.touches.length>1},getDistance:function(a){if(!zc.isMultiTouch(a))return 0;var b=a.touches[0],c=a.touches[1];return Math.sqrt(Math.pow(b.clientX-c.clientX,2)+Math.pow(b.clientY-c.clientY,2))}};Jb.touch=zc;var Ac={_string:function(a,b,c,d){var e=c._stringPool.get();e.style.whiteSpace="nowrap",e.style.verticalAlign="middle",e.style.padding="0px 2px",Jb.setText(e,a,d),e.setAttribute("title",a),b.appendChild(e)},_boolean:function(a,b,c){var d=c._booleanPool.get();b._editInfo?(d._editInfo=b._editInfo,delete b._editInfo,d.disabled=!1):d.disabled=!0,d.keepDefault=!0,d.type="checkbox",d.style.margin="0px 2px",d.style.verticalAlign="middle",d.checked=a,b.appendChild(d),""===b.style.textAlign&&(b.style.textAlign="center")},_color:function(a,b,c){var d=c._colorPool.get();d.style.width="100%",d.style.height="100%",d.style.backgroundColor=a,d.setAttribute("title",a),b.appendChild(d)},render:function(a,b,c,d,e){if(null!=b){var f=Ac["_"+a];f?f(b,c,d,e):"boolean"==typeof b?Ac._boolean(b,c,d,e):Ac._string(b,c,d,e)}}};Jb.render=Ac;var Bc={toolTipDiv:null,getToolTipDiv:function(){if(!Bc.toolTipDiv){Bc.toolTipDiv=Ob.createElement("div");var a=Cd,b=Bc.toolTipDiv.style;b.position="absolute",b.color=a.TOOLTIP_COLOR,b.background=a.TOOLTIP_BACKGROUND,b.fontSize=a.TOOLTIP_FONT_SIZE,b.padding=a.TOOLTIP_PADDING,b.border=a.TOOLTIP_BORDER,b.borderRadius=a.TOOLTIP_BORDER_RADIUS,b.boxShadow=a.TOOLTIP_BOX_SHADOW,b.zIndex=a.TOOLTIP_ZINDEX,b.setProperty&&b.setProperty("-webkit-box-shadow",a.TOOLTIP_BOX_SHADOW,null)}return Bc.toolTipDiv},isToolTipVisible:function(){return Bc.getToolTipDiv().parentNode?!0:!1},hideToolTip:function(){if(Bc._clearTimeout(),Bc._clearDismiss(),Bc.isToolTipVisible()){var a=Bc.getToolTipDiv();a.parentNode&&a.parentNode.removeChild(a)}},showToolTip:function(a,b){return a&&b?void(Bc.isToolTipVisible()||Bc._reshow_timeout?Bc._showToolTip(a,b):(Bc._clearTimeout(),Bc._show_timeout=setTimeout(function(){Bc._showToolTip(a,b)},Cd.TOOLTIP_INITIAL_DELAY))):void Bc.hideToolTip()},_showToolTip:function(a,b){var c,d,e;a.target?(c=a.clientX,d=a.clientY):(c=a.x,d=a.y),e=Bc.getToolTipDiv(),Wb.clear(e),b instanceof Element?e.appendChild(b):e.innerHTML=b,e.style.left=c+Cd.TOOLTIP_XOFFSET+"px",e.style.top=d+Cd.TOOLTIP_YOFFSET+"px",e.parentNode||Ob.body.appendChild(e),Bc._clearDismiss(),Bc._dismiss_timeout=setTimeout(Bc.hideToolTip,Cd.TOOLTIP_DISMISS_DELAY),Bc._clearReshow(),Bc._reshow_timeout=setTimeout(Bc._clearReshow,Cd.TOOLTIP_RESHOW_DELAY)},_clearDismiss:function(){Bc._dismiss_timeout&&(clearTimeout(Bc._dismiss_timeout),Bc._dismiss_timeout=null)},_clearReshow:function(){Bc._reshow_timeout&&(clearTimeout(Bc._reshow_timeout),Bc._reshow_timeout=null)},_clearTimeout:function(){Bc._show_timeout&&(clearTimeout(Bc._show_timeout),Bc._show_timeout=null)},resetToolTip:function(){Bc.hideToolTip(),Bc.toolTipDiv=null}};Jb.popup=Bc;var Cc={handleClicked:function(a,b,c){if(Qb.isTouchable||0===b.button)if(c){var d=Dc(c);d&&d.onClick&&d.onClick(c,a),a.onClickElement(c,b),a.fireInteractionEvent({kind:"clickElement",event:b,element:c})}else a.onClickBackground(b),a.fireInteractionEvent({kind:"clickBackground",event:b})},handleDoubleClicked:function(a,b,c){if((Qb.isTouchable||0===b.button)&&!a.isEditingElement()){if(c){var d=Dc(c);d&&d.onDoubleClick&&d.onDoubleClick(c,a),a.onDoubleClickElement(c,b),a.fireInteractionEvent({kind:"doubleClickElement",event:b,element:c})}else a.onDoubleClickBackground(b),a.fireInteractionEvent({kind:"doubleClickBackground",event:b});c?c instanceof Ib.Link&&a.isDoubleClickToLinkBundle()?c.ISubGl3dview&&a.isDoubleClickToSubGl3dview()&&!Jb.isCtrlDown(b)?(a.isDoubleClickToEmptySubGl3dview()||c.getChildrenSize()>0)&&a.setCurrentSubGl3dview(c,a.isSubGl3dviewAnimate(),function(){a.fireInteractionEvent({kind:"enterSubGl3dview",event:b,element:c})}):c.reverseBundleExpanded()&&a.fireInteractionEvent({kind:"bundleLink",event:b,element:c}):c.ISubGl3dview&&a.isDoubleClickToSubGl3dview()?(a.isDoubleClickToEmptySubGl3dview()||c.getChildrenSize()>0)&&a.setCurrentSubGl3dview(c,a.isSubGl3dviewAnimate(),function(){a.fireInteractionEvent({kind:"enterSubGl3dview",event:b,element:c})}):c instanceof Ld&&a.isDoubleClickToGroupExpand()&&(c.reverseExpanded(),a.fireInteractionEvent({kind:"expandGroup",event:b,element:c})):a.isDoubleClickToUpSubGl3dview()&&a.upSubGl3dview(a.isSubGl3dviewAnimate(),function(){a.fireInteractionEvent({kind:"upSubGl3dview",event:b})})}},handleKeyDown:function(a,b){Jb.isCtrlDown(b)&&65==b.keyCode?(a.isKeyboardSelectEnabled()&&a.selectAll().size()>0&&a.fireInteractionEvent({kind:"selectAll"}),Wb.preventDefault(b)):46==b.keyCode?(a.isKeyboardRemoveEnabled()&&a.removeSelection()&&a.fireInteractionEvent({kind:"removeElement"}),Wb.preventDefault(b)):Jb.showVersion(b)},handleLongClicked:function(a,b,c){if(Qb.isTouchable||0===b.button)if(c){var d=Dc(c);d&&d.onLongClick&&d.onLongClick(c,a),a.onLongClickElement(c,b),a.fireInteractionEvent({kind:"longClickElement",event:b,element:c})}else a.onLongClickBackground(b),a.fireInteractionEvent({kind:"longClickBackground",event:b})}},Dc=function(a){if(a&&a._image){if("object"==typeof a._image)return a._image;var b=Jb.getImageAsset(a._image);if(b)return b._image}return null};Jb.interaction=Cc;var Ec=function(a){return a.trim()[0].match(/[mlhvcsqta]/i)?Kc(a):Gc(a)},Fc={},Gc=function(a){var b=Fc[a];return b?b:(Fc[a]=b=[],a.trim().split(" ").forEach(function(a){a=a.split(","),b.push(2===a.length?{x:parseFloat(a[0]),y:parseFloat(a[1])}:a[0])}),b)},Hc={},Ic=/[mlhvcsqtaz][\d.,\-\s]*/gi,Jc=/-?(\d)+(\.(\d)+)?/g,Kc=function(a){var b,c=Hc[a];return c?c:(b=a.trim().match(Ic),Hc[a]=c=[],b&&b.forEach(function(a){var b,d=a[0],e=a.match(Jc),f=e&&e.length;if(c.push(a={c:d}),f)switch(e.forEach(function(a,b){e[b]=parseFloat(a)}),d){case"M":case"m":case"L":case"l":for(b=0;f>b;b+=2)0!==b&&c.push(a={c:"M"===d||"L"===d?"L":"l"}),a.x=e[b],a.y=e[b+1];break;case"H":case"h":for(b=0;f>b;b++)0!==b&&c.push(a={c:d}),a.x=e[b];break;case"V":case"v":for(b=0;f>b;b++)0!==b&&c.push(a={c:d}),a.y=e[b];break;case"C":case"c":for(b=0;f>b;b+=6)0!==b&&c.push(a={c:d}),a.x1=e[b],a.y1=e[b+1],a.x2=e[b+2],a.y2=e[b+3],a.x=e[b+4],a.y=e[b+5];break;case"S":case"s":for(b=0;f>b;b+=4)0!==b&&c.push(a={c:d}),a.x2=e[b],a.y2=e[b+1],a.x=e[b+2],a.y=e[b+3];break;case"Q":case"q":for(b=0;f>b;b+=4)0!==b&&c.push(a={c:d}),a.x1=e[b],a.y1=e[b+1],a.x=e[b+2],a.y=e[b+3];break;case"T":case"t":for(b=0;f>b;b+=2)0!==b&&c.push(a={c:d}),a.x=e[b],a.y=e[b+1]}}),c)},Lc=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=a.transform&&Mc(a.transform);return o&&o.length&&(c=Sb.identity(),o.forEach(function(a){var b=a[0];"matrix"===b?c.multiply(new Sb(a[1],a[2],a[3],a[4],a[5],a[6])):"translate"===b?c.translate(a[1]||0,a[2]||0):"scale"===b?c.scale(a[1]||1,a[2]||a[1]||1):"rotate"===b?c.rotate(a[1]||0,a[2]||0,a[3]||0):"skewX"===b?c.skew(a[1]||0,0):"skewY"===b&&c.skew(0,a[1]||0)})),"linear"===a.type?(f=a.x1||0,g=a.y1||0,h=a.x2||0,i=a.y2||0,c&&(d=c.transform(f,g),f=d.x,g=d.y,d=c.transform(h,i),h=d.x,i=d.y),e=b.createLinearGradient(f,g,h,i)):"radial"===a.type&&(j=a.fx||0,k=a.fy||0,l=a.cx||0,m=a.cy||0,n=a.r||0,null==a.fx&&(j=l),null==a.fy&&(k=m),e=b.createRadialGradient(j,k,0,l,m,n)),e&&a.stop&&a.stop.length&&a.stop.forEach(function(a){e.addColorStop(parseFloat(a.offset),sd(a.color,b._color))}),e},Mc=function(a){return a.replace(/[\s\r\t\n]+/gm," ").trim().replace(/\)(\s?,\s?)/g,") ").split(/\s(?=[a-z])/).map(function(a){return a.replace(")","").trim().split(/\s*\(\s*|\s+,?\s*|,\s*/).map(function(a,b){return 0===b?a:parseFloat(a)})})},Nc=function(a,b,c,d,e,f,g){var h,i,j,k,l=1;"object"!=typeof b&&(i=b,h=Jb.images[b],b=h&&h.getImage()),cd(b)?a.drawImage(h?h.getImage(c):b,Math.round(d.x),Math.round(d.y),d.width,d.height):b&&"object"==typeof b&&(a._data=e,a._view=f,i?(j=d.width/(b.w&&Yc(e,b,b,"w")||e.getWidth()),k=d.height/(b.h&&Yc(e,b,b,"h")||e.getHeight()),f&&(l=f.getSizeZoom?f.getSizeZoom()*f.getGraphicsZoom():f.getZoom()),!h._cache||Math.max(j*l,k*l)>1?Oc(a,b,c,d,e,f,g):a.drawImage(c?h.getImage(c):h._cache,Math.round(d.x),Math.round(d.y),d.width,d.height)):Oc(a,b,c,d,e,f,g),a._data=null,a._view=null)},Oc=function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=e&&e.getStyle("image.state");if(p=a._vector,w=a._color,q=a._fill,r=a._pattern,s=a._lineWidth,t=a._alpha,u=a._sx,v=a._sy,m=b,Yc(e,m,m,"visible",f)!==!1){for(a._color=c,h=Yc(e,m,m,"v",f),i=h&&h.length,y=m.w&&Yc(e,m,m,"w")||e.getWidth(),z=m.h&&Yc(e,m,m,"h")||e.getHeight(),n=d.width/y,o=d.height/z,g===!0?(a._fill=null,a._pattern=null,a._lineWidth=null,a._alpha=null):(a._sx=n,a._sy=o),a.save(),a.translate(d.x+d.width/2,d.y+d.height/2),(1!==n||1!==o)&&a.scale(n,o),m.origin&&a.translate((m.origin.x-.5)*y,(m.origin.y-.5)*z),a._vector=m,m.clip&&(a.beginPath(),m.clip===!0?a.rect(-(m.origin?m.origin.x:.5)*y,-(m.origin?m.origin.y:.5)*z,y,z):m.clip.length?m.clip.forEach(function(b){a.drawShape(b)}):a.drawShape(m.clip),a.clip()),Tc(e,m,m,a,f),j=0,i=h.length;i>j;j++)l=h[j],a._shapeData=l,f&&(f._shapeDataIndex=j,l.animate&&wb(l,m,e,f)),x=Yc(e,m,l,"state",f),Yc(e,m,l,"visible",f)===!1||x&&!(Array.isArray(x)?x.indexOf(A)>=0:x===A)||(k=Qc[l.shape],k&&(a.save(),"vector"===l.shape||"g"===l.shape?k(a,l,e,f):Tc(e,m,l,a,f,function(){k(a,l,e,f)}),a.restore())),f&&(f._shapeDataIndex=null),a._shapeData=null;a.restore(),a._vector=p,a._shapeData=null,a._color=w,a._fill=q,a._pattern=r,a._lineWidth=s,a._alpha=t,a._sx=u,a._sy=v}},Pc=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o=a._vector,p=o.origin,q=o.w&&Yc(d,o,o,"w")||d.getWidth(),r=o.h&&Yc(d,o,o,"h")||d.getHeight();if("string"==typeof b?(n=Jb.images[b],n&&(h=n.getWidth(),i=n.getHeight())):(h=b.w&&Yc(d,b,b,"w"),i=b.h&&Yc(d,b,b,"h")),h&&i&&c)for(j=c.w/h*a._sx,k=c.h/i*a._sy,f=c.x-q/2*(a._sx-1),g=c.y-r/2*(a._sy-1),p&&(f-=(p.x-.5)*q*(a._sx-1),g-=(p.y-.5)*r*(a._sy-1)),(1!==a._sx||1!==a._sy)&&(a.scale(1/a._sx,1/a._sy),f+=((p?p.x:.5)*q+c.x)*(a._sx-1),g+=((p?p.x:.5)*r+c.y)*(a._sy-1)),c={x:0,y:0,width:h,height:i},l=0;j>l;l++)for(m=0;k>m;m++)c.x=l*h+f,c.y=m*i+g,Nc(a,b,null,c,d,e,!0)},Qc={line:function(a,b,c,d){var e,f,g,h,i=Yc(c,a._vector,b,"p1",d),j=Yc(c,a._vector,b,"p2",d);i?(e=Zc(i.length?i[0]:i.x,a),f=$c(i.length?i[1]:i.y,a)):(e=Yc(c,a._vector,b,"x1",d,!0),f=Yc(c,a._vector,b,"y1",d,!1)),j?(g=Zc(j.length?j[0]:j.x,a),h=$c(j.length?j[1]:j.y,a)):(g=Yc(c,a._vector,b,"x2",d,!0),h=Yc(c,a._vector,b,"y2",d,!1)),a.moveTo(e,f),a.lineTo(g,h)},rect:function(a,b,c,d){var e,f,g,h,i=Yc(c,a._vector,b,"rect",d),j=Yc(c,a._vector,b,"r",d);i?(Array.isArray(i)?(e=i[0],f=i[1],g=i[2],h=i[3]):(e=i.x,f=i.y,g=i.w,h=i.h),e=Zc(e,a),f=$c(f,a),g=Zc(g,a),h=$c(h,a)):(e=Yc(c,a._vector,b,"x",d,!0),f=Yc(c,a._vector,b,"y",d,!1),g=Yc(c,a._vector,b,"w",d,!0),h=Yc(c,a._vector,b,"h",d,!1)),a.drawRoundRect(e,f,g,h,j),(a._gradientFunc||a._pattern)&&(a._rect={x:e,y:f,w:g,h:h})},circle:function(a,b,c,d){var e=Yc(c,a._vector,b,"cx",d,!0),f=Yc(c,a._vector,b,"cy",d,!1),g=a._vector.w&&Yc(c,a._vector,a._vector,"w")||c.getWidth(),h=a._vector.h&&Yc(c,a._vector,a._vector,"h")||c.getHeight(),i=_c(Yc(c,a._vector,b,"r",d),Math.min(g,h),b,a._vector),j=Yc(c,a._vector,b,"startAngle",d),k=Yc(c,a._vector,b,"endAngle",d),l=Yc(c,a._vector,b,"anticlockwise",d),m=Yc(c,a._vector,b,"close",d);null==j&&(j=0),null==k&&(k=360),null==l&&(l=!1),m&&a.moveTo(e,f),a.arc(e,f,i,j/180*Math.PI,k/180*Math.PI,l),m&&a.closePath(),(a._gradientFunc||a._pattern)&&(a._rect={x:e-i,y:f-i,w:2*i,h:2*i})},ellipse:function(a,b,c,d){var e=Yc(c,a._vector,b,"cx",d,!0),f=Yc(c,a._vector,b,"cy",d,!1),g=Yc(c,a._vector,b,"rx",d,!0),h=Yc(c,a._vector,b,"ry",d,!1),i=Yc(c,a._vector,b,"startAngle",d),j=Yc(c,a._vector,b,"endAngle",d),k=Yc(c,a._vector,b,"anticlockwise",d),l=Yc(c,a._vector,b,"close",d);null==i&&(i=0),null==j&&(j=360),null==k&&(k=!1),l&&a.moveTo(e,f),a.ellipse(e,f,g,h,0,i/180*Math.PI,j/180*Math.PI,k),l&&a.closePath(),(a._gradientFunc||a._pattern)&&(a._rect={x:e-g,y:f-h,w:2*g,h:2*h})},path:function(a,b,c,d){var e=Yc(c,a._vector,b,"data",d);a.drawPath(e)},text:function(a,b,c,d){var e=Yc(c,a._vector,b,"text",d),f=Yc(c,a._vector,b,"x",d,!0),g=Yc(c,a._vector,b,"y",d,!1),h=Yc(c,a._vector,b,"w",d,!0);if(null!=e){e=String(e);var i=e.split("\n"),j=2*a.measureText("e").width,k=vb(a,e,h);g-=(k.h/j-1)/2*j,i.forEach(function(b){if(h){var c,d,e,i,k,l=b.split(" "),m=l.length,n="";for(e=0;m>e;e++)if(c=l[e]+(e===m-1?"":" "),d=n+c,i=a.measureText(d).width,h>i)n=d;else if(i==h)a.fillText(n,f,g),n="",g+=j;else{for(k=0;k<c.length;k++)if(d=n+c.substr(0,k+1),a.measureText(d).width>h){a.fillText(d.substring(0,d.length-1),f,g),n=c.substring(k,c.length),g+=j;break}for(;n.length>0&&a.measureText(n).width>h;)for(k=0;k<n.length;k++)if(d=n.substr(0,k+1),a.measureText(d).width>h){a.fillText(n.substr(0,k),f,g),n=n.substring(k,n.length),g+=j;break}}a.fillText(n,f,g)}else a.fillText(b,f,g);g+=j})}},draw:function(a,b,c,d){var e,f,g=b.draw;"string"==typeof g&&((e=g.match(Wc))?(f="with(data) { "+e[1]+" }",g=new Function("g","data","view",f)):g=dd[g]),"function"==typeof g&&g.call(a._vector,a,c,d)},vector:function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r=a._vector,s=Yc(c,r,b,"name",d),t=Yc(c,r,b,"x",d,!0),u=Yc(c,r,b,"y",d,!1),v=Yc(c,r,b,"w",d),w=Yc(c,r,b,"h",d);if("string"==typeof s?(l=Jb.images[s],k=l&&l._image):k=s,k)if(cd(k))null!=v&&null!=w?a.drawImage(k,t,u,Zc(v,a),$c(w,a)):a.drawImage(k,t,u);else{for(m=Yc(c,k,k,"v",d),n=m&&m.length,o=k.w&&Yc(c,k,k,"w"),p=k.h&&Yc(c,k,k,"h"),null!=v&&null!=w?(v=Zc(v,a),w=$c(w,a)):(v=o,w=p),a.save(),h=a._lineWidth,i=a._fill,j=a._alpha,Tc(c,k,k,a,d),Tc(c,r,b,a,d),a.translate(t,u),a.scale(v/o,w/p),k.origin&&a.translate((k.origin.x-.5)*o,(k.origin.y-.5)*p),k.clip&&(a.beginPath(),k.clip===!0?a.rect(-(k.origin?k.origin.x:.5)*o,-(k.origin?k.origin.y:.5)*p,o,p):k.clip.length?k.clip.forEach(function(b){a.drawShape(b)}):a.drawShape(k.clip),a.clip()),q=a._shapeData,a._vector=k,e=0;n>e;e++)f=m[e],a._shapeData=f,d&&(d._shapeDataIndex.length?d._shapeDataIndex.push(e):d._shapeDataIndex=[d._shapeDataIndex,e],f.animate&&wb(f,r,c,d)),Yc(c,k,f,"visible",d)!==!1&&(g=Qc[f.shape],g&&(a.save(),"vector"===f.shape||"g"===f.shape?g(a,f,c,d):Tc(c,k,f,a,d,function(){g(a,f,c,d)}),a.restore())),d&&d._shapeDataIndex.pop();a._vector=r,a._shapeData=q,a._lineWidth=h,a._fill=i,a._alpha=j,a.restore()}},g:function(a,b,c,d){var e,f,g,h,i,j=Yc(c,a._vector,b,"v",d);j&&j.length&&(a.save(),f=a._lineWidth,g=a._fill,h=a._alpha,i=a._shapeData,Tc(c,a._vector,b,a,d),j.forEach(function(b){Yc(c,a._vector,b,"visible",d)!==!1&&(e=Qc[b.shape],e&&(a.save(),a._shapeData=b,"vector"===b.shape||"g"===b.shape?e(a,b,c,d):Tc(c,a._vector,b,a,d,function(){e(a,b,c,d)}),a.restore()))}),a._lineWidth=f,a._fill=g,a._alpha=h,a._shapeData=i,a.restore())}};Qc.image=Qc.vector;var Rc=Object.keys(Qc),Sc={M:function(a,b){return a.moveTo(b.x,b.y),a._path_start=b,a._rect&&bd(a._rect,b.x,b.y),b},m:function(a,b,c){return c&&(b={x:c.x+b.x,y:c.y+b.y}),a.moveTo(b.x,b.y),a._path_start=b,a._rect&&bd(a._rect,b.x,b.y),b},Z:function(a){return a.closePath(),a._path_start},z:function(a){return a.closePath(),a._path_start},L:function(a,b){return a.lineTo(b.x,b.y),a._rect&&bd(a._rect,b.x,b.y),b},l:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y};return a.lineTo(d.x,d.y),a._rect&&bd(a._rect,d.x,d.y),d},H:function(a,b,c){var d={x:b.x,y:c.y};return a.lineTo(d.x,d.y),a._rect&&bd(a._rect,d.x,d.y),d},h:function(a,b,c){var d={x:c.x+b.x,y:c.y};return a.lineTo(d.x,d.y),a._rect&&bd(a._rect,d.x,d.y),d},V:function(a,b,c){var d={x:c.x,y:b.y};return a.lineTo(d.x,d.y),a._rect&&bd(a._rect,d.x,d.y),d},v:function(a,b,c){var d={x:c.x,y:c.y+b.y};return a.lineTo(d.x,d.y),a._rect&&bd(a._rect,d.x,d.y),d},Q:function(a,b){return a._preQ_x=b.x1,a._preQ_y=b.y1,a.quadraticCurveTo(b.x1,b.y1,b.x,b.y),a._rect&&(bd(a._rect,b.x1,b.y1),bd(a._rect,b.x,b.y)),b},q:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=a._preQ_x=c.x+b.x1,f=a._preQ_y=c.y+b.y1;return a.quadraticCurveTo(e,f,d.x,d.y),a._rect&&(bd(a._rect,e,f),bd(a._rect,d.x,d.y)),d},T:function(a,b,c){var d=a._preQ_x=2*c.x-a._preQ_x,e=a._preQ_y=2*c.y-a._preQ_y;return a.quadraticCurveTo(d,e,b.x,b.y),a._rect&&(bd(a._rect,d,e),bd(a._rect,b.x,b.y)),b},t:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=a._preQ_x=2*c.x-a._preQ_x,f=a._preQ_y=2*c.y-a._preQ_y;return a.quadraticCurveTo(e,f,d.x,d.y),a._rect&&(bd(a._rect,e,f),bd(a._rect,d.x,d.y)),d},C:function(a,b){return a._preC_x=b.x2,a._preC_y=b.y2,a.bezierCurveTo(b.x1,b.y1,b.x2,b.y2,b.x,b.y),a._rect&&(bd(a._rect,b.x1,b.y1),bd(a._rect,b.x2,b.y2),bd(a._rect,b.x,b.y)),b},c:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=c.x+b.x1,f=c.y+b.y1,g=a._preC_x=c.x+b.x2,h=a._preC_y=c.y+b.y2;return a.bezierCurveTo(e,f,g,h,d.x,d.y),a._rect&&(bd(a._rect,e,f),bd(a._rect,g,h),bd(a._rect,d.x,d.y)),d},S:function(a,b,c){var d=2*c.x-a._preC_x,e=2*c.y-a._preC_y;return a._preC_x=b.x2,a._preC_y=b.y2,a.bezierCurveTo(d,e,b.x2,b.y2,b.x,b.y),a._rect&&(bd(a._rect,d,e),bd(a._rect,b.x2,b.y2),bd(a._rect,b.x,b.y)),b},s:function(a,b,c){var d={x:c.x+b.x,y:c.y+b.y},e=2*c.x-a._preC_x,f=2*c.y-a._preC_y,g=a._preC_x=c.x+b.x2,h=a._preC_y=c.y+b.y2;return a.bezierCurveTo(e,f,g,h,d.x,d.y),a._rect&&(bd(a._rect,e,f),bd(a._rect,g,h),bd(a._rect,d.x,d.y)),d}},Tc=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t=Yc(a,b,c,"line",e),u=Yc(a,b,c,"fill",e),v=Yc(a,b,c,"fillRule",e)||"nonzero",w=Yc(a,b,c,"gradient",e),x=Yc(a,b,c,"gradientColor",e),y=Yc(a,b,c,"pattern",e),z=Yc(a,b,c,"font",e),A=Yc(a,b,c,"textAlign",e)||"center",B=Yc(a,b,c,"textBaseline",e)||"middle",C=Yc(a,b,c,"translate",e),D=Yc(a,b,c,"rotate",e),E=Yc(a,b,c,"rotateOrigin",e),F=Yc(a,b,c,"scale",e),G=Yc(a,b,c,"transform",e),H=Yc(a,b,c,"alpha",e),I=d._lineWidth,J=d._fill,K=d._pattern,L=d._alpha,M=d._gradientFunc;if(t?(g=t.color,h=t.width,i=t.cap,j=t.join,k=t.miterLimit,l=t.dash,m=t.dashOffset):(g=Yc(a,b,c,"lineColor",e),h=Yc(a,b,c,"lineWidth",e),i=Yc(a,b,c,"lineCap",e),j=Yc(a,b,c,"lineJoin",e),k=Yc(a,b,c,"miterLimit",e),l=Yc(a,b,c,"lineDash",e),m=Yc(a,b,c,"lineDashOffset",e)),null!=g&&(d.strokeStyle=sd(g,d._color)),null!=h&&(d.lineWidth=d._lineWidth=e&&e.getSizeZoom?h/e.getSizeZoom():h),null!=i&&(d.lineCap=i),null!=j&&(d.lineJoin=j),null!=k&&(d.miterLimit=k),null!=l&&(d.lineDash=l,d.setLineDash(l)),null!=m&&(d.lineDashOffset=m),y?d._pattern=y:(u&&(d.fillStyle=d._fill=sd(u,d._color)),w&&("string"==typeof w?o=Zb[w]:(o=Zb[w.type],w.color&&(x=w.color),o||(w=Lc(w,d))),d._gradientFunc=o)),null!=z&&(d.font=z),null!=A&&(d.textAlign=A),null!=B&&(d.textBaseline=B),Uc(a,b,c,d,e),null!=G)"string"==typeof G&&(G=Mc(G)),G.length&&G.forEach(function(a){var b=a[0];"matrix"===b?d.transform(a[1],a[2],a[3],a[4],a[5],a[6]):"translate"===b?d.translate(a[1]||0,a[2]||0):"scale"===b?d.scale(a[1]||1,a[2]||a[1]||1):"rotate"===b?a.length>2?(d.translate(a[2],a[3]),d.rotate(a[1]),d.translate(-a[2],-a[3])):d.rotate(a[1]):"skewX"===b?d.transform(1,0,Math.tan(a[1]*Math.PI/180),1,0,0):"skewY"===b&&d.transform(1,Math.tan(a[1]*Math.PI/180),0,1,0,0)});else{if(null!=C&&(Array.isArray(C)?(r=C[0],s=C[1]):"object"==typeof C?(r=C.x,s=C.y):(r=C,s=0),r=Zc(r,d),s=$c(s,d),(0!==r||0!==s)&&d.translate(r,s)),null!=D&&D%360!==0){var N,O;E&&(Array.isArray(E)?(N=E[0],O=E[1]):"object"==typeof E?(N=E.x,O=E.y):N=O=E,N=Zc(N,d),O=$c(O,d),(0!==N||0!==O)&&d.translate(N,O)),d.rotate(D*Math.PI/180),E&&(0!==N||0!==O)&&d.translate(-N,-O)}null!=F&&(Array.isArray(F)?(p=F[0],q=F[1]):"object"==typeof F?(p=F.x,q=F.y):p=q=F,(1!==p||1!==q)&&d.scale(p,q))}null!=H&&(d.globalAlpha=d._alpha=null!=L?L*H:H),f&&(d.beginPath(),f(),n=d._rect||c.rect,d._pattern?(d._lineWidth>0&&d.stroke(),d.clip(),Pc(d,d._pattern,n,a,e)):(o&&n&&(w=o(d,sd(u||"#000000",d._color),sd(x||"#FFFFFF",d._color),n.x,n.y,n.w,n.h)),w&&(d.fillStyle=d._fill=w),d._fill&&d.fill(v),d._lineWidth>0&&d.stroke()),d._lineWidth=I,d._fill=J,d._pattern=K,d._alpha=L,d._gradientFunc=M,d._rect=null)},Uc=function(a,b,c,d,e){var f,g,h,i,j=Yc(a,b,c,"shadow",e);j?(f=j.offsetX,g=j.offsetY,h=j.blur,i=j.color):(f=Yc(a,b,c,"shadowOffsetX",e),g=Yc(a,b,c,"shadowOffsetY",e),h=Yc(a,b,c,"shadowBlur",e),i=Yc(a,b,c,"shadowColor",e)),null!=f&&(d.shadowOffsetX=f),null!=g&&(d.shadowOffsetY=g),null!=h&&(d.shadowBlur=h),null!=i&&(d.shadowColor=i)},Vc=/<%=([\s\S]+?)%>/,Wc=/<%([\s\S]+?)%>/,Xc=new RegExp([Vc.source,Wc.source].join("|")),Yc=function(a,c,d,e,f,g,h){var i,j,k,l,m,n=d[e],o=typeof n;if("string"===o&&(i=n.match(Xc))?(j="with(data) { "+(i[1]?"return "+i[1]:i[2])+" }",k=new Function("data","view",j),n=k.call(c,a,f)):"function"===o&&(n=n.call(c,a,f)),g===!0?(l=c.w&&Yc(a,c,c,"w")||a.getWidth(),(d.rel===!0||d.rel===b&&c.rel)&&1>=n&&n>=-1?n*=l:"string"==typeof n&&(n=parseInt(n)/100*l),n=n||0):g===!1&&(m=c.h&&Yc(a,c,c,"h")||a.getHeight(),(d.rel===!0||d.rel===b&&c.rel)&&1>=n&&n>=-1?n*=m:"string"==typeof n&&(n=parseInt(n)/100*m),n=n||0),h!==!1&&f&&a&&d.animate&&a._animates){var p,q=a._animates,r=f._shapeDataIndex;if(r.length)for(var s=0;s<r.length;s++)p=r[s],q=q[p];else p=r;var t=q[p],u=t[e];if(u)if(Array.isArray(u))for(var s=u.length-1;s>=0;s--){var v=u[s];if((v.stopped||v.time>0)&&v.started)return Hb(v,n)}else if(u.started)return Hb(u,n)}return n},Zc=function(a,c){if(!a)return 0;var d=c._vector.w&&Yc(c._data,c._vector,c._vector,"w")||c._data.getWidth();return(c._shapeData&&c._shapeData.rel===!0||(!c._shapeData||c._shapeData.rel===b)&&c._vector.rel)&&1>=a&&a>=-1?a*d:"string"==typeof a?parseInt(a)/100*d:a},$c=function(a,c){if(!a)return 0;var d=c._vector.h&&Yc(c._data,c._vector,c._vector,"h")||c._data.getHeight();return(c._shapeData&&c._shapeData.rel===!0||(!c._shapeData||c._shapeData.rel===b)&&c._vector.rel)&&1>=a&&a>=-1?a*d:"string"==typeof a?parseInt(a)/100*d:a},_c=function(a,c,d,e){return a?(d.rel===!0||d.rel===b&&e.rel)&&1>=a&&a>=-1?a*c:"string"==typeof a?parseInt(a)/100*c:a:0},ad=(a.CanvasRenderingContext2D||Lb.Context2d).prototype;ad.drawShape=function(a){var b=this,c=b._vector,d=b._shapeData,e=b._data,f=b._view,g=Qc[a.shape];g&&(b.save(),b._shapeData=a,"vector"===a.shape||"g"===a.shape?g(b,a,e,f):Tc(e,c,a,b,f,function(){g(b,a,e,f)}),b._shapeData=d,b.restore())},ad.drawPath=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this;if("string"==typeof a&&(a=Ec(a)),j=a?a.length:0,!(1>=j)){if((n._gradientFunc||n._pattern)&&(n._rect=k={x:0,y:0,w:0,h:0}),b=a&&a[0]&&a[0].c,b||(c=a&&a[0]&&null!=a[0].x,d="z"===a[j-1]||"Z"===a[j-1],d&&j--),b){for(e=0;j>e;e++)g=a[e],h=Sc[g.c],h&&(f=h(n,g,f));n._path_start=null,n._preC_x=null,n._preC_y=null,n._preQ_x=null,n._preQ_y=null}else if(c){for(i=a[0],l=Zc(i.x,n),m=$c(i.y,n),n.moveTo(l,m),k&&bd(k,l,m),e=1;j>e;e++)i=a[e],l=Zc(i.x,n),m=$c(i.y,n),n.lineTo(l,m),
k&&bd(k,l,m);d&&n.closePath()}else{for(l=Zc(a[0],n),m=$c(a[1],n),n.moveTo(l,m),k&&bd(k,l,m),e=2;j>e;e+=2)l=Zc(a[e],n),m=$c(a[e+1],n),n.lineTo(l,m),k&&bd(k,l,m);d&&n.closePath()}return a}};var bd=function(a,b,c){var d=Math.min(a.x,b),e=Math.max(a.x+a.w,b),f=Math.min(a.y,c),g=Math.max(a.y+a.h,c);a.x=d,a.y=f,a.w=e-d,a.h=g-f};ad._fillPath=function(a,b){var c=this;c.beginPath(),c.fillStyle=a,c.drawPath(b),c.fill()},ad._fillRect=function(a,b,c,d,e){var f=this;f.beginPath(),f.fillStyle=a,f.rect(b,c,d,e),f.fill()},ad.ellipse||(ad.ellipse=function(a,b,c,d){var e=this,f=.5522848,g=c*f,h=d*f,i=a+c,j=b+d,k=a-c,l=b-d;e.moveTo(k,b),e.bezierCurveTo(k,b-h,a-g,l,a,l),e.bezierCurveTo(a+g,l,i,b-h,i,b),e.bezierCurveTo(i,b+h,a+g,j,a,j),e.bezierCurveTo(a-g,j,k,b+h,k,b)}),ad.drawRoundRect=function(a,b,c,d,e){var f=this;if(!e)return void f.rect(a,b,c,d);var g,h,i,j;if(Array.isArray(e))if(1===e.length)g=h=i=j=e[0];else if(2===e.length)g=h=e[0],i=j=e[1];else{if(4!==e.length)return void f.rect(a,b,c,d);g=e[0],h=e[1],i=e[2],j=e[3]}else g=h=i=j=e;var k=a+c,l=b+d,m=d>c?2*c:2*d;g=m>g?g:m,h=m>h?h:m,i=m>i?i:m,j=m>j?j:m;var n=.292893218813453*j,o=.585786437626905*j;f.moveTo(k,l-j),f.quadraticCurveTo(k,l-o,k-n,l-n),f.quadraticCurveTo(k-o,l,k-j,l),n=.292893218813453*i,o=.585786437626905*i,f.lineTo(a+i,l),f.quadraticCurveTo(a+o,l,a+n,l-n),f.quadraticCurveTo(a,l-o,a,l-i),n=.292893218813453*g,o=.585786437626905*g,f.lineTo(a,b+g),f.quadraticCurveTo(a,b+o,a+n,b+n),f.quadraticCurveTo(a+o,b,a+g,b),n=.292893218813453*h,o=.585786437626905*h,f.lineTo(k-h,b),f.quadraticCurveTo(k-o,b,k-n,b+n),f.quadraticCurveTo(k,b+o,k,b+h),f.lineTo(k,l-j)};var cd=function(a){return Lb?a instanceof Lb||a instanceof Pb:a instanceof HTMLImageElement||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement},dd={},ed=function(a,b){"function"==typeof b&&(dd[a]=b)},fd=function(a,b){"function"==typeof b&&Rc.indexOf(a)<0&&(Qc[a]=b)};!function(){for(var b=["webkit","moz"],c=0;c<b.length&&!a.requestAnimationFrame;++c){var d=b[c];a.requestAnimationFrame=a[d+"RequestAnimationFrame"],a.cancelAnimationFrame=a[d+"CancelAnimationFrame"]||a[d+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(a.navigator.userAgent)||!a.requestAnimationFrame||!a.cancelAnimationFrame){var e=0;a.requestAnimationFrame=function(a){var b=Date.now(),c=Math.max(e+16,b);return setTimeout(function(){a(e=c)},c-b)},a.cancelAnimationFrame=clearTimeout}}();var gd=Ib.Animate=function(a){var b=this;b.type=null==a.type?"number":a.type,b.delay=null==a.delay?0:a.delay,b.dur=null==a.dur?1e3:a.dur,b.interval=null==a.interval?0:a.interval,b.finish=null==a.finish?b.delay+b.dur+b.interval:a.finish,null==a.finish?b.finish=b.delay+b.dur+b.interval:(b.finish=a.finish,b.interval=b.finish-b.delay-b.dur),b.repeat=null==a.repeat?1:a.repeat,b.reverse=null==a.reverse?!0:a.reverse,b.easing=null==a.easing?"easeNone":a.easing,b.onUpdate=a.onUpdate,b.onDone=a.onDone,b.onStop=a.onStop,b.onPlay=a.onPlay,b.attr=a.attr,b.source=a.source,b.filter=a.filter,b.from=a.from,b.to=a.to,b.start=null,b.time=0,b.total=0,b.count=0,b.started=!1,b.stopped=!1,b.paused=!1,b.pausedTime=null,b.pausedTotal=0,b._speed=1,b._oldSpeed=null,b._speedTotal=0,b._speedTime=null,b._percent=0,b._percentSet=null,b._percentDiff=0,b.id=id++};Jb.ext("twaver.Animate",Object,{play:function(){return yb(this)},stop:function(a){return zb(this,a)},pause:function(){this.stopped||(this.paused=!0)},resume:function(){this.paused&&(this.paused=!1,jd=!0)},isPaused:function(){return this.paused},percent:function(a){return null==a?this._percentSet||this._percent:(this._percentSet=0>a?0:a>100?100:a,this.paused&&(jd=!0),this.started||(this.play(),this.pause()),this)},speed:function(a){return null==a?this._speed:(a=0>a?1:a,a!==this.speed&&(this.stopped||(this._oldSpeed=this._speed),this._speed=a),this)},clone:function(){return new gd(this)},chain:function(a){var b,c=this;return c.next=a,a.pre=c,c.onDone?(b=c.onDone,c.onDone=function(){b.call(c),a.play()}):c.onDone=function(){a.play()},c}});var hd={},id=1,jd=!1;!function Gf(a){requestAnimationFrame(Gf),jd&&(jd=!1,Db(a))}(0);var kd={easeNone:function(a,b,c,d){return c*a/d+b},easeIn:function(a,b,c,d){return c*(a/=d)*a+b},easeOut:function(a,b,c,d){return-c*(a/=d)*(a-2)+b},easeBoth:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},easeInStrong:function(a,b,c,d){return c*(a/=d)*a*a*a+b},easeOutStrong:function(a,b,c,d){return-c*((a=a/d-1)*a*a*a-1)+b},easeBothStrong:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},elasticIn:function(a,b,c,d,e,f){var g;return 0===a?b:1===(a/=d)?b+c:(f||(f=.3*d),!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),-(e*Math.pow(2,10*(a-=1))*Math.sin(2*(a*d-g)*Math.PI/f))+b)},elasticOut:function(a,b,c,d,e,f){var g;return 0===a?b:1===(a/=d)?b+c:(f||(f=.3*d),!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),e*Math.pow(2,-10*a)*Math.sin(2*(a*d-g)*Math.PI/f)+c+b)},elasticBoth:function(a,b,c,d,e,f){var g;return 0===a?b:2===(a/=d/2)?b+c:(f||(f=.3*d*1.5),!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),1>a?-.5*e*Math.pow(2,10*(a-=1))*Math.sin(2*(a*d-g)*Math.PI/f)+b:e*Math.pow(2,-10*(a-=1))*Math.sin(2*(a*d-g)*Math.PI/f)*.5+c+b)},backIn:function(a,c,d,e,f){return f===b&&(f=1.70158),a===e&&(a-=.001),d*(a/=e)*a*((f+1)*a-f)+c},backOut:function(a,b,c,d,e){return"undefined"==typeof e&&(e=1.70158),c*((a=a/d-1)*a*((e+1)*a+e)+1)+b},backBoth:function(a,b,c,d,e){return"undefined"==typeof e&&(e=5.70158),(a/=d/2)<1?c/2*a*a*(((e*=1.525)+1)*a-e)+b:c/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b},bounceIn:function(a,b,c,d){return c-kd.bounceOut(d-a,0,c,d)+b},bounceOut:function(a,b,c,d){return(a/=d)<1/2.75?7.5625*c*a*a+b:2/2.75>a?c*(7.5625*(a-=1.5/2.75)*a+.75)+b:2.5/2.75>a?c*(7.5625*(a-=2.25/2.75)*a+.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+.984375)+b},bounceBoth:function(a,b,c,d){return d/2>a?.5*kd.bounceIn(2*a,0,c,d)+b:.5*kd.bounceOut(2*a-d,0,c,d)+.5*c+b}},ld={draw:function(a,b){var c=null==b.getCurrentSubGl3dview()?b.getElementBox():b.getCurrentSubGl3dview(),d=c.getStyle("background.type");"image"==d?this.drawImage(a,c,b):"vector"==d?this.drawVector(a,c):"image.vector"==d?(this.drawImage(a,c,b),this.drawVector(a,c)):"vector.image"==d&&(this.drawVector(a,c),this.drawImage(a,c,b))},drawImage:function(a,b,c){var d=b.getStyle("background.image"),e=Jb.getImageAsset(d);if(null!=e){var f={x:0,y:0,width:a.canvas.width,height:a.canvas.height};"none"==b.getStyle("background.image.stretch")&&(f.width=e.getWidth(),f.height=e.getHeight());var g=b.getStyle("background.image.padding");if(g&&Tb.grow(f,g,g),"tile"==b.getStyle("background.image.stretch")){if(cd(e.getImage()))for(var h=0;h<f.width;h+=e.getWidth())for(var i=0;i<f.height;i+=e.getHeight())a.drawImage(e.getImage(),h,i)}else("fill"==b.getStyle("background.image.stretch")||"none"==b.getStyle("background.image.stretch"))&&Nc(a,e.getImage(),null,f,b,c)}},drawVector:function(a,b){var c={x:0,y:0,width:a.canvas.width,height:a.canvas.height},d=b.getStyle("background.outline.width"),e=(b.getStyle("background.outline.color"),b.getStyle("background.vector.fill")),f=b.getStyle("background.vector.fill.color"),g=b.getStyle("background.vector.padding"),h=b.getStyle("background.vector.shape"),i=b.getStyle("background.vector.pattern");g&&Tb.grow(c,g,g);var j=b.getStyle("background.vector.gradient");e&&(j?Xb.fill(a,f,j,b.getStyle("background.vector.gradient.color"),c):a.fillStyle=f,Xb.drawVector(a,h,i,c),a.fill()),d>0&&(a.lineWidth=d,a.strokeStyle=b.getStyle("background.outline.color"),Xb.drawVector(a,h,i,c),a.stroke())}};Ib.Pool=function(a,b){this.func="string"==typeof a?function(){return Ob.createElement(a)}:a,this.tagName=a,null!=b&&(this.redundancy=b)},Jb.ext("twaver.Pool",Object,{redundancy:2,currentIndex:-1,get:function(){if(this.currentIndex++,this.currentIndex===this.size()){var a=this.func();return a._pool=this,a.style.margin="0px",a.style.padding="0px",this.list||(this.list=new md),this.list.add(a),a}return this.list.get(this.currentIndex)},release:function(a){this.list&&this.list.remove(a)>=0&&(delete a._selectData,delete a._expandData,delete a._checkData,delete a._editInfo,delete a.keepDefault,a.style.margin="0px",a.style.padding="0px",a.style.backgroundColor="",a.removeAttribute("title"),"img"===this.tagName&&a.removeAttribute&&(a.removeAttribute("width"),a.removeAttribute("height"),a.removeAttribute("src")),this.list.add(a),this.currentIndex--)},reset:function(){this.currentIndex=-1},clear:function(){if(this.list)for(;this.redundancy+this.currentIndex<this.list.size()-1;)delete this.list.removeAt(this.list.size()-1)._pool},size:function(){return this.list?this.list.size():0}}),Ib.Util={getVersion:function(){return"5.2.7"},registerImage:function(a,b,c,d,e){Jb.registerImage(a,b,c,d,e)},getRegisteredImageNames:function(){return Jb.getRegisteredImageNames()},unregisterImage:function(a){Jb.unregisterImage(a)},getImageAsset:function(a){return Jb.getImageAsset(a)},validateLicense:function(a){Jb.validateLicense(a)},getLicense:function(){return Kb},isPermissionGIS:function(){return tc()},moveElements:function(a,b,c,d,e){if((0!==b||0!==c)&&a&&!a.isEmpty()){var f,g,h=Ib.animate.AnimateManager;h.endAnimate(),a=vc.filterMovingElements(a),d&&(f=new md,g=new md),a.forEach(function(a){a instanceof Jd&&(d?(f.add(a),g.add({x:a.getX()+b,y:a.getY()+c})):a.translate(b,c))}),d?h.start(new Ib.animate.AnimateLocation(f,g,e)):e&&e()}},isTypeOf:function(a,b){if(a===b)return!0;for(var c=a.superClass;c;){if(c===b.prototype)return!0;c=c.constructor.superClass}return!1},setFocus:function(a){if(Ob.activeElement!==a){var b,c,d,e=Ob.documentElement,f=Ob.body;e&&(Qb.isIE||Qb.isOpera||e.scrollLeft||e.scrollTop)?(b=e.scrollLeft,c=e.scrollTop,d=e):f&&(b=f.scrollLeft,c=f.scrollTop,d=f),a.focus(),d&&(d.scrollLeft=b,d.scrollTop=c)}},isOpera:Qb.isOpera,isIE:Qb.isIE,isFirefox:Qb.isFirefox,isChrome:Qb.isChrome,isSafari:Qb.isSafari,isIPhone:Qb.isIPhone,isIPod:Qb.isIPod,isIPad:Qb.isIPad,isAndroid:Qb.isAndroid,isWebOS:Qb.isWebOS,isTouchable:Qb.isTouchable,ext:function(a,b,c){Jb.ext(a,b,c)},getValue:function(a,b,c){return Jb.getValue(a,b,c)},setValue:function(a,b,c){Jb.setValue(a,b,c)},grow:function(a,b,c){Tb.grow(a,b,c)},containsPoint:function(a,b,c){return Tb.containsPoint.apply(null,arguments)},intersects:function(a,b){return Tb.intersects(a,b)},getRect:function(a){return Tb.getRect(a)},unionRect:function(a,b){return Tb.unionRect(a,b)},createDiv:function(){return Wb.createDiv()},createCanvas:function(){return Wb.createCanvas()},setCanvas:function(a,b,c,d,e){return Wb.setCanvas.apply(null,arguments)},drawVector:function(a,b,c,d,e,f,g){Xb.drawVector.apply(null,arguments)},fill:function(a,b,c,d,e,f,g,h){Xb.fill.apply(null,arguments)},getClass:function(a){return Jb.getClass(a)},getAllClassNames:function(){var a,b=[];for(a in Jb.classCache)b.push(a);return b},newInstance:function(a){return Jb.newInstance.apply(null,arguments)},isDeserializing:function(){return Jb.isDeserializing},addEventListener:function(a,b,c,d){Wb.addEventListener(a,b,c,d)},removeEventListener:function(a,b,c){Wb.removeEventListener(a,b,c)},drawArrow:function(a,b,c,d,e,f,g,h,i,j,k,l){nd.drawArrow.apply(null,arguments)},calculatePointAngleAlongLine:function(a,b,c,d,e){return Tb.calculatePointInfoAlongLineBySegments(a,b,c,d,e)},getSubGl3dview:function(a){return vc.getSubGl3dview(a)},transformPoint:function(a,b,c,d){return Tb.transformPoint(a,b,c,d)},getToolTipDiv:function(){return Bc.getToolTipDiv()},showToolTip:function(a,b){Bc.showToolTip(a,b)},hideToolTip:function(){Bc.hideToolTip()},resetToolTip:function(){Bc.resetToolTip()},setCSSStyle:function(a,b,c){Wb.setCSSStyle(a,b,c)},removeCSSStyle:function(a,b){Wb.removeCSSStyle(a,b)},getCSSStyle:function(a,b){return Wb.getCSSStyle(a,b)},toDegrees:function(a){return Tb.toDegrees(a)},toRadians:function(a){return Tb.toDegrees(a)},getRadiansBetweenLines:function(a,b){return Tb.getRadiansBetweenLines(a,b)},getElementsBounds:function(a,b){var c=null;return a.forEach(function(a){if(a.getRect){var d,e;b&&(e=b.getElementUI(a),e&&(d=e.getViewRect())),d||(d=a.getRect()),c=c?Ib.Util.unionRect(c,d):d}}),c},getPointIndex:function(a,b,c){if(c||(c=10),a)for(var d=a.size();d--;d>=0)if(Tb.getDistance(a.get(d),b)<=c)return d;return-1},registerVectorShape:function(a,b){Jb.g["_"+a]=b},rotateCanvas:function(a,b,c){a.translate(b.x+b.width/2,b.y+b.height/2),a.rotate(c*Math.PI/180),a.translate(-(b.x+b.width/2),-(b.y+b.height/2))},registerShape:function(a,b){fd(a,b)},registerDraw:function(a,b){ed(a,b)},getFilterColor:function(a,b){return sd(a,b)},registerGifImage:function(a,b){var c=arguments,d=new XMLHttpRequest;d.overrideMimeType("text/plain; charset=x-user-defined"),d.onload=function(b){var e=new Ed(d.response),f=new Fd(e);f.doParse();var g=setInterval(function(){if(f.loaded){clearInterval(g),Ib.Util.registerImage(a,f);for(var b=2;b<c.length;b++){var d=c[b];d.invalidateElementUIs&&d.invalidateElementUIs(),d.invalidateDisplay&&d.invalidateDisplay()}}},10)},d.open("POST",b,!0),d.send()},parseVectorData:function(a){return Ec(a)},getSharedLinks:function(a,b){var c=a.getLinks(),d=b.getLinks();if(c&&0!=c.size()&&d&&0!=d.size()){var e=c.size()>d.size()?c:d;return e.toList(function(c){return c.getFromNode()==a&&c.getToNode()==b||c.getFromNode()==b&&c.getToNode()==a})}return null},isSharedLinks:function(a,b){var c=!1,d=a.getLinks(),e=b.getLinks();if(d&&0!=d.size()&&e&&0!=e.size()){var f=d.size()>e.size()?d:e;f.forEach(function(d){return d.getFromNode()==a&&d.getToNode()==b||d.getFromNode()==b&&d.getToNode()==a?(c=!0,!1):!0})}return c},playAnimate:function(a){return yb(a)},pauseAnimate:function(a){a.pause()},resumeAnimate:function(a){a.resume()},stopAnimate:function(a,b){zb(a,b)},pauseAllAnimates:function(){Bb()},resumeAllAnimates:function(){Cb()},stopAllAnimates:function(a){Ab(a)},randomColor:function(){return"#"+("00000"+(16777216*Math.random()<<0).toString(16)).substr(-6)},getHSVColor:function(a,c,d){var e,f,g,h,i,j,k,l;switch(a&&c===b&&d===b&&(c=a.s,d=a.v,a=a.h),h=Math.floor(6*a),i=6*a-h,j=d*(1-c),k=d*(1-i*c),l=d*(1-(1-i)*c),h%6){case 0:e=d,f=l,g=j;break;case 1:e=k,f=d,g=j;break;case 2:e=j,f=d,g=l;break;case 3:e=j,f=k,g=d;break;case 4:e=l,f=j,g=d;break;case 5:e=d,f=j,g=k}var m="#"+toHex(255*e)+toHex(255*f)+toHex(255*g);return m},toHex:function(a){var b=parseInt(a).toString(16);return 1==b.length&&(b="0"+b),b},makeHighRes:function(b){var c=b.getContext("2d"),d=a.devicePixelRatio||1,e=c.webkitBackingStorePixelRatio||c.mozBackingStorePixelRatio||c.msBackingStorePixelRatio||c.oBackingStorePixelRatio||c.backingStorePixelRatio||1,f=d/e;if(d!==e){var g=b.width,h=b.height;b.width=Math.round(g*f),b.height=Math.round(h*f),b.style.width=g+"px",b.style.height=h+"px",c.scale(f,f)}}},Jb.ext("twaver.Util",Object,{});var md=function(){if(this._as=[],1===arguments.length){var a=arguments[0];if(a instanceof md&&(a=a._as),a instanceof Array)for(var b=a.length,c=0;b>c;c++)this._as.push(a[c]);else null!=a&&this._as.push(a)}else if(arguments.length>1)for(b=arguments.length,c=0;b>c;c++)this._as.push(arguments[c])};Ib.List=md,Jb.ext("twaver.List",Object,{size:function(){return this._as.length},isEmpty:function(){return 0===this._as.length},add:function(a,c){return c===b?this._as.push(a):this._as.splice(c,0,a)},addAll:function(a){if(a instanceof md&&(a=a._as),a instanceof Array)for(var b=a.length,c=0;b>c;c++)this._as.push(a[c]);else this._as.push(a)},get:function(a){return this._as[a]},remove:function(a){var b=this._as.indexOf(a);return b>=0&&b<this._as.length&&this.removeAt(b),b},removeAt:function(a){return this._as.splice(a,1)[0]},set:function(a,b){return this._as[a]=b},clear:function(){return this._as.splice(0,this._as.length)},contains:function(a){return this.indexOf(a)>=0},indexOf:function(a){return this._as.indexOf(a)},forEach:function(a,b){for(var c=this._as.length,d=0;c>d;d++){var e=this._as[d];b?a.call(b,e):a(e)}},forEachReverse:function(a,b){for(var c=this._as.length,d=c-1;d>=0;d--){var e=this._as[d];b?a.call(b,e):a(e)}},toArray:function(a,b){if(a){for(var c=[],d=this._as.length,e=0;d>e;e++){var f=this._as[e];b?a.call(b,f)&&c.push(f):a(f)&&c.push(f)}return c}return this._as.concat()},toList:function(a,b){if(a){for(var c=new md,d=this._as.length,e=0;d>e;e++){var f=this._as[e];b?a.call(b,f)&&c.add(f):a(f)&&c.add(f)}return c}return new md(this)},sort:function(a){return a?this._as.sort(a):this._as.sort(),this},toString:function(){return this._as.toString()}});var nd={shapeMap:{},init:function(){nd.register("arrow.standard",nd.createStandardArrow()),nd.register("arrow.delta",nd.createDeltaArrow()),nd.register("arrow.diamond",nd.createDiamondArrow()),nd.register("arrow.short",nd.createShortArrow()),nd.register("arrow.slant",nd.createSlantArrow())},createStandardArrow:function(){var a=new md;return a.add({x:-1,y:-5/9}),a.add({x:-0.75,y:0}),a.add({x:-1,y:5/9}),a.add({x:0,y:0}),a.add({x:-1,y:-5/9}),a},createDeltaArrow:function(){var a=new md;return a.add({x:-1,y:-5/9}),a.add({x:-1,y:5/9}),a.add({x:0,y:0}),a.add({x:-1,y:-5/9}),a},createDiamondArrow:function(){var a=new md;return a.add({x:-7/12,y:5/9}),a.add({x:-14/12,y:0}),a.add({x:-7/12,y:-5/9}),a.add({x:0,y:0}),a.add({x:-7/12,y:5/9}),a},createShortArrow:function(){var a=new md;return a.add({x:-8/12,y:6/9}),a.add({x:-5/12,y:0}),a.add({x:-8/12,y:-6/9}),a.add({x:0,y:0}),a.add({x:-8/12,y:6/9}),a},createSlantArrow:function(){var a=new md;return a.add({x:-1,y:-5/9}),a.add({x:-6.5/12,y:0}),a.add({x:-0.75,y:4/9}),a.add({x:0,y:0}),a.add({x:-1,y:-5/9}),a},register:function(a,b){nd.shapeMap[a]=b},getShape:function(a){if(a)return nd.shapeMap[a];throw"shape type can't be null"},getArrowRect:function(a,b,c,d,e,f,g,h,i){var j=nd.getShape(d);if(!j||j.size()<=0)return null;if(g>0&&1>g){var k;k=a.getLineLength?a.getLineLength():a._element.getLineLength(),g*=k}else a.getLineLength&&(g+=nd.calculateArrowXOffsetAtEdge(b,a,c,i));i&&(g*=i.getLocationZoom(),h*=i.getLocationZoom());var l,m,n,o=Tb.calculatePointInfoAlongLine(b,c,g,h),p=o.point,q=o.angle,r=j._as,s=r.length,t=new md;for(n=new Sb(e,0,0,f,p.x,p.y),l=0;s>l;l++)t.add(n.transform(r[l]));for(n=Tb.createMatrix(q+Math.PI,p.x,p.y),l=0;s>l;l++)m=t.get(l),m instanceof md&&(m=m._as),m instanceof Array?(m[0]=n.transform(m[0]),m[1]=n.transform(m[1])):t.set(l,n.transform(m));return Tb.getLineRect(t)},drawArrow:function(a,b,c,d,e,f,g,h,i,j,k,l,m){i=i||0,j=j||0,k=k||0;var n=k>=0&&l;if(g||n){var o=nd.getShape(f);if(o&&!(o.size()<=0)){var p=Tb.calculatePointInfoAlongLine(d,e,i,j),q=p.point,r=p.angle;if(m._gl3dview._debug&&m._element instanceof Ib.Link){if(e)var s={x:m._arrowFromRect.x,y:m._arrowFromRect.y,width:m._arrowFromRect.width,height:m._arrowFromRect.height};else var s={x:m._arrowToRect.x,y:m._arrowToRect.y,width:m._arrowToRect.width,height:m._arrowToRect.height};Xb.strokeRect(a,s,"#CD5B45")}g&&(a.fillStyle=h),a.beginPath(),n&&(a.lineWidth=k,a.strokeStyle=l),nd._drawArrow(a,o,r,q,b,c),g&&a.fill(),n&&a.stroke()}}},_drawArrow:function(a,b,c,d,e,f){b=b._as;var g,h,i,j=b.length,k=new md;for(i=new Sb(e,0,0,f,d.x,d.y),g=0;j>g;g++)k.add(i.transform(b[g]));k=k._as,i=Tb.createMatrix(c+Math.PI,d.x,d.y);var l=k[0];for(l=i.transform(l),a.moveTo(l.x,l.y),g=1;j>g;g++)h=k[g],h instanceof md&&(h=h._as),h instanceof Array?(h[0]=i.transform(h[0]),h[1]=i.transform(h[1]),a.quadraticCurveTo(h[0].x,h[0].y,h[1].x,h[1].y)):(h=i.transform(h),a.lineTo(h.x,h.y))},drawLinkArrow:function(a,b,c,d){c.size()<2||(a._element.getStyle("arrow.from")&&nd._drawFromArrow(a,b,c,d),a._element.getStyle("arrow.to")&&nd._drawToArrow(a,b,c,d))},_drawFromArrow:function(a,b,c,d){var e=a._element,f=e.getStyle("arrow.from.fill"),g=e.getStyle("arrow.from.outline.width");if(f||g>=0){var h=e.getStyle("arrow.from.width"),i=e.getStyle("arrow.from.height"),j=e.getStyle("arrow.from.xoffset");if(j>0&&1>j){var k;k=a.getLineLength?a.getLineLength():a._element.getLineLength(),j*=k}else a.getLineLength&&(j+=nd.calculateArrowXOffsetAtEdge(c,a,!0,d));var l=e.getStyle("arrow.from.yoffset"),m=e.getStyle("arrow.from.shape");j=a._gl3dview._edgeDetect?0:j,l=a._gl3dview._edgeDetect?0:l,d&&(j*=d.getLocationZoom(),l*=d.getLocationZoom()),nd.drawArrow(b,h,i,c,!0,m,f,e.getStyle("arrow.from.color"),j,l,g,e.getStyle("arrow.from.outline.color"),a)}},_drawToArrow:function(a,b,c,d){var e=a._element,f=e.getStyle("arrow.to.fill"),g=e.getStyle("arrow.to.outline.width");if(f||g>=0){var h=e.getStyle("arrow.to.width"),i=e.getStyle("arrow.to.height"),j=e.getStyle("arrow.to.xoffset");if(j>0&&1>j){var k;k=a.getLineLength?a.getLineLength():a._element.getLineLength(),j*=k}else a.getLineLength&&(j+=nd.calculateArrowXOffsetAtEdge(c,a,!1));var l=e.getStyle("arrow.to.yoffset"),m=e.getStyle("arrow.to.shape");d&&(j*=d.getLocationZoom(),l*=d.getLocationZoom()),j=a._gl3dview._edgeDetect?0:j,l=a._gl3dview._edgeDetect?0:l,nd.drawArrow(b,h,i,c,!1,m,f,e.getStyle("arrow.to.color"),j,l,g,e.getStyle("arrow.to.outline.color"),a)}},calculateArrowXOffsetAtEdge:function(a,b,c,d){if(null==a||a.size()<2)return 0;var e=b._element,f=e.getStyle(c?"arrow.from.at.edge":"arrow.to.at.edge");if(!f)return 0;var g=b._gl3dview.getElementUI(c?e.getFromAgent():e.getToAgent());if(!g)return 0;if(d)var h=g.getZoomBodyRect();else var h=g._bodyRect;if(null==h)return 0;for(var i=Tb._getPoint(a.get(c?0:a.size()-1)),j=0,k=b.getLineLength();nd._containsByInt(h,Math.floor(i.x),Math.floor(i.y),!1)&&k>j;)i=Tb.calculatePointInfoAlongLine(a,c,j++).point;return j},_containsByInt:function(a,c,d,e){return e=e===b?!0:e,e?c>=Math.floor(a.x)&&c<=Math.floor(a.x+a.width)&&d>=Math.floor(a.y)&&d<=Math.floor(a.y+a.height):c>Math.floor(a.x)&&c<Math.floor(a.x+a.width)&&d>Math.floor(a.y)&&d<Math.floor(a.y+a.height)}};nd.init(),Jb.arrow=nd,Ib.EventDispatcher=function(){},Jb.ext("twaver.EventDispatcher",null,{contains:function(a,b){if(this._ls)for(var c,d=0,e=this._ls.size();e>d;d++)if(c=this._ls.get(d),a===c.l&&b===c.s)return!0;return!1},add:function(a,b,c){var d={l:a,s:b,a:c};this._ls||(this._ls=new md),this._f?(this._addPendings||(this._addPendings=new md),this._addPendings.add(d)):d.a?this._ls.add(d,0):this._ls.add(d)},remove:function(a,b){this._ls&&(this._f?(this._removePendings||(this._removePendings=new md),this._removePendings.add({l:a,s:b})):this._remove(a,b))},_remove:function(a,b){for(var c,d=0,e=this._ls.size();e>d;d++)if(c=this._ls.get(d),c.l===a&&c.s===b)return void this._ls.removeAt(d)},fire:function(a){if(this._ls){var b,c,d=this._ls.size();for(this._f=!0,b=0;d>b;b++)c=this._ls.get(b),c.s?c.l.call(c.s,a):c.l(a);if(this._f=!1,this._removePendings){for(d=this._removePendings.size(),b=0;d>b;b++)c=this._removePendings.get(b),this._remove(c.l,c.s);delete this._removePendings}if(this._addPendings){for(d=this._addPendings.size(),b=0;d>b;b++)c=this._addPendings.get(b),c.a?this._ls.add(c,0):this._ls.add(c);delete this._addPendings}}}}),Ib.ImageAsset=function(a,b,c,d,e){this._name=a,this._width=c,this._height=d,this._svg=e,this._edgeData,"string"==typeof b?this._src=b:"function"==typeof b?this._func=b:cd(b)?this._image=b:"object"==typeof b&&(this._image=b,this._width=b.w||b.width,this._height=b.h||b.height,b.cache!==!1&&yd(b)&&(wd(a,b),this._cache=Bd(b)))},Jb.ext("twaver.ImageAsset",Object,{getName:function(){return this._name},getSrc:function(){return this._src},isSvg:function(){return this._svg},getImage:function(a,b,c){if(!a||!this._image)return this._image;this._map||(this._map={});var d;d=this._svg&&3===arguments.length?a+","+b+","+c:a;var e=this._map[d];return e?e:(e=td(this._cache||this._image,rd(a),this._svg?b:this.getWidth(),this._svg?c:this.getHeight()),this._map[d]=e,e)},getWidth:function(){return this._width},getHeight:function(){return this._height},getFunction:function(){return this._func},_createEdgeData:function(a){var b=300,c=b/a.width;a.height<a.width&&(c=b/a.height);var d=Math.floor(a.width*c),e=Math.floor(a.height*c);this.tempCanvas||(this.tempCanvas=Ob.createElement("canvas"),this.ctx=this.tempCanvas.getContext("2d")),this.tempCanvas.width=d,this.tempCanvas.height=e,this.ctx.clearRect(0,0,d,e),this.ctx.drawImage(a,0,0,d,e);for(var f=this.ctx.getImageData(0,0,d,e),g=!0,h=[],i=0,j=d,k=e;k>i;i++)for(var l=0;j>l;l++){var m=4*(i*j+l),n=this._isTransparentPoint(f.data,m),o=g!=n||!n&&(0==l||l==j-1);if(o){var p=n?1:0;h.push({x:l-p,y:i})}g=n}g=!0;for(var l=0,j=d,k=e;j>l;l++)for(var i=0;k>i;i++){var m=4*(i*j+l),n=this._isTransparentPoint(f.data,m),o=g!=n||!n&&(0==i||i==k-1);if(o){var p=n?1:0;h.push({x:l,y:i-p})}g=n}for(var q=j/2,r=k/2,s=[],t=0;360>t;t++)s.push({x:q,y:r,dist:0});for(var t=0,u=h.length;u>t;t++){var v=h[t],w=this._getPointAngleDegree(v.x,v.y,q,r),x=this._getPointDist(v.x,v.y,q,r);s[w].dist<x&&(s[w]={x:v.x,y:v.y,dist:x})}for(var t=0,u=s.length;u>t;t++){var o=s[t];o.x=o.x/c,o.y=o.y/c,delete o.dist}return s},_isTransparentPoint:function(a,b){return a[b]+a[b+1]+a[b+2]+a[b+3]==0},_getPointAngleDegree:function(a,b,c,d){var e=c-a,f=d-b,g=Math.atan2(f,e);return g=g/Math.PI*180,g=parseInt(g)+180,g%=360},_getPointDist:function(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)}});var od={},pd=Wb.createCanvas();pd.width=1,pd.height=1;var qd=pd.getContext("2d"),rd=function(a){a=a||"black";var b,c=od[a];return c||(qd.clearRect(0,0,1,1),qd.fillStyle=a,qd.fillRect(0,0,1,1),b=qd.getImageData(0,0,1,1).data,c=od[a]={r:b[0],g:b[1],b:b[2],a:b[3]}),c},sd=function(a,b){if(!b)return a;b=rd(b),a=rd(a);var c=.3*a.r+.59*a.g+.11*a.b;return"rgba("+Math.floor(b.r*c/255)+","+Math.floor(b.g*c/255)+","+Math.floor(b.b*c/255)+","+a.a+")"},td=function(a,b,c,d){var e=Wb.createCanvas(c,d),f=e.getContext("2d");f.drawImage(a,0,0,c,d);try{for(var g=f.getImageData(0,0,c,d),h=g.data,i=0,j=h.length;j>i;i+=4){var k=.3*h[i+0]+.59*h[i+1]+.11*h[i+2];h[i+0]=Math.floor(b.r*k/255),h[i+1]=Math.floor(b.g*k/255),h[i+2]=Math.floor(b.b*k/255)}f.putImageData(g,0,0)}catch(l){return a}return e},ud={},vd=function(a,b){if(a){var c=typeof a;"string"===c&&(a.match(Xc)||Jb.images[a]||(ud[a]||(ud[a]=[])).push(b))}},wd=function(a,b){b.pattern&&vd(b.pattern,a),b.v&&b.v.forEach(function(b){b.pattern&&vd(b.pattern,a)})},xd=function(a){var b=ud[a];b&&(b.forEach(function(a){var b=Jb.images[a];b._cache=Bd(b._image)}),delete ud[a])},yd=function(a){return a.w&&a.h?zd(a):!1},zd=function(a){return!Object.keys(a).some(function(b){if(/^on/.test(b))return!1;var c=a[b],d=Ad(c);return d||"v"!==b||(d=c.some(function(a){if("draw"===a.shape)return!0;if("vector"===a.shape){var b=Jb.images[a.name];if(b&&!b._cache)return!0}var c=Object.keys(a).some(function(b){return"state"===b||"animate"===b?!0:Ad(a[b])});return c?!0:"g"===a.shape&&a.v&&a.v.length?!zd(a):!1})),d})},Ad=function(a){var b=typeof a;return"string"===b&&a.match(Xc)||"function"===b},Bd=function(a){var b=Wb.createCanvas(a.w,a.h),c=b.getContext("2d");return Oc(c,a,null,{x:0,y:0,width:a.w,height:a.h}),b},Cd={COLORS:["#6495ED","#FFFF00","#00FFFF","#FF0000","#7FFF00","#E0A580","#5FC0CB","#FA00F0","#A1BC50","#FFD700","#4169E1","#E5A5F5","#1E90FF","#696969","#FF6347","#00BFEF","#FFD700","#80E090","#5F9EA0","#A000FF","#7FAF00","#228BA2","#FF00FF","#7FFFD4","#800000","#0000CD","#20B2AA","#D2691E","#6495BD","#DC143C","#F0A8AF","#008B8B","#800080","#B8860B","#4B0082","#00FF00","#FFA500","#FF4500","#FFFF00","#9ACD32","#00008B","#FF1493","#ADFF2F","#4682B4","#00C0B1"],CALL_LATER_DELAY:17,SCROLL_BAR_WIDTH:17,SELECT_COLOR:"#C2CFF1",FOCUS_ON_CLICK:!0,VIEW_POSITION:"absolute",VIEW_FONT_SIZE:"12px",VIEW_FONT_FAMILY:"arial, tahoma, helvetica, sans-serif",TOOLTIP_BACKGROUND:"lightyellow",TOOLTIP_FONT_SIZE:"12px",TOOLTIP_COLOR:"black",TOOLTIP_PADDING:"4px 8px",TOOLTIP_BORDER:"1px solid gray",TOOLTIP_BORDER_RADIUS:"6px",TOOLTIP_XOFFSET:12,TOOLTIP_YOFFSET:12,TOOLTIP_BOX_SHADOW:"0px 0px 3px #AAA",TOOLTIP_ZINDEX:1e5,TOOLTIP_INITIAL_DELAY:750,TOOLTIP_RESHOW_DELAY:500,TOOLTIP_DISMISS_DELAY:4e3,ZOOM_MAX:5,ZOOM_MIN:.1,ZOOM_INCREMENT:1.3,ZOOM_ANIMATE:!0,COLUMN_INNER_TEXT:!0,COLUMN_WIDTH:80,COLUMN_HORIZONTAL_ALIGN:"",COLUMN_PROPERTY_TYPE:"accessor",COLUMN_VALUE_TYPE:"string",COLUMN_EDITABLE:!1,COLUMN_SORTABLE:!0,COLUMN_VISIBLE:!0,COLUMN_RESIZABLE:!0,COLUMN_MOVABLE:!0,COLUMN_RENDER_CELL:null,COLUMN_RENDER_HEADER:null,PROPERTY_INNER_TEXT:!0,PROPERTY_HORIZONTAL_ALIGN:"",PROPERTY_PROPERTY_TYPE:"accessor",PROPERTY_VALUE_TYPE:"string",PROPERTY_EDITABLE:!1,PROPERTY_CATEGORY_NAME:null,PROPERTY_RENDER_NAME:null,PROPERTY_RENDER_VALUE:null,PROPERTY_RENDER_EDITOR:null,TAB_WIDTH:100,TAB_CLOSABLE:!1,TAB_RESIZABLE:!0,TAB_MOVABLE:!0,TAB_DISABLED:!1,TAB_VISIBLE:!0,ACCORDION_EXPAND_ICON:"expand_icon",ACCORDION_COLLAPSE_ICON:"collapse_icon",ACCORDION_TITLE_HEIGHT:20,ACCORDION_TITLE_BACKGROUND:"#EBEBEB",ACCORDION_BORDER_BOTTOM_COLOR:"lightgray",ACCORDION_ICON_POSITION:"left",TITLEPANE_TITLE_HEIGHT:20,TITLEPANE_TITLE_BACKGROUND:"#DDD",TITLEPANE_TITLE_HORIZONTAL_ALIGN:"left",BORDERPANE_HGAP:0,BORDERPANE_VGAP:0,CHARTPANE_TITLE_HEIGHT:20,CHARTPANE_TITLE_HORIZONTAL_ALIGN:"center",CHARTPANE_LEGEND_ORIENTATION:"bottom",CHARTPANE_LEGEND_WIDTH:80,LEGENDPANE_ICON_WIDTH:10,LEGENDPANE_ICON_HEIGHT:10,LEGENDPANE_ICON_RADIUS:0,LEGENDPANE_ROW_HEIGHT:20,LEGENDPANE_ORIENTATION:"horizontal",LEGENDPANE_HIDDEN_COLOR:"#BABBBC",LEGENDPANE_SELECT_BACKGROUND_COLOR:"#00007D",LEGENDPANE_SELECT_FOREGROUND_COLOR:"#FFFFFF",CHART_TOOLTIP_ENABLED:!0,CHART_SELECT_TOLERANCE:0,CHART_XGAP:6,CHART_YGAP:6,CHART_XZOOM_ENABLED:!0,CHART_YZOOM_ENABLED:!0,CHART_XTRANSLATE_ENABLED:!0,CHART_YTRANSLATE_ENABLED:!0,CHART_DOUBLE_CLICK_TO_RESET:!0,CHART_VALUE_VISIBLE:!0,CHART_VALUE_FONT:null,CHART_BACKGROUND_VISIBLE:!1,CHART_BACKGROUND_FILL:!0,CHART_BACKGROUND_FILL_COLOR:"rgba(50,50,50,0.11)",CHART_BACKGROUND_OUTLINE_WIDTH:1,CHART_BACKGROUND_OUTLINE_COLOR:"rgba(50,50,50,0.11)",CHART_BACKGROUND_GRADIENT:"linear.north",CHART_BACKGROUND_GRADIENT_COLOR:"#FFFFFF",PIECHART_TYPE:"oval",PIECHART_START_ANGLE:0,PIECHART_SELECT_OFFSET:5,PIECHART_SHADOW_OFFSET:1,PIECHART_SHADOW_COLOR:"#C2CFF1",PIECHART_LINE_RATE:.5,PIECHART_DONUT_RATE:.5,PIECHART_VALUE_POSITION:.5,BARCHART_TYPE:"default",BARCHART_UPPER_LIMIT:null,BARCHART_LOWER_LIMIT:0,BARCHART_XAXIS_LINE_COLOR:"#808080",BARCHART_XAXIS_LINE_WIDTH:1,BARCHART_XAXIS_TEXT_COLOR:"#000000",BARCHART_XAXIS_TEXT_FONT:null,BARCHART_YAXIS_LINE_COLOR:"#808080",BARCHART_YAXIS_LINE_WIDTH:1,BARCHART_YAXIS_TEXT_COLOR:"#000000",BARCHART_YAXIS_TEXT_FONT:null,BARCHART_XSCALE_TEXT_FONT:null,BARCHART_XSCALE_TEXT_COLOR:"#000000",BARCHART_XSCALE_TEXT_ORIENTATION:"horizontal",BARCHART_YSCALE_TEXT_VISIBLE:!0,BARCHART_YSCALE_TEXT_COLOR:"#000000",BARCHART_YSCALE_TEXT_FONT:null,BARCHART_YSCALE_LINE_COLOR:"#808080",BARCHART_YSCALE_LINE_WIDTH:.3,BARCHART_YSCALE_VALUE_GAP:0,BARCHART_YSCALE_PIXEL_GAP:20,BARCHART_YSCALE_MIN_TEXT_VISIBLE:!1,LINECHART_INTERRUPTABLE:!0,LINECHART_UPPER_LIMIT:null,LINECHART_LOWER_LIMIT:null,LINECHART_XAXIS_LINE_COLOR:"#808080",LINECHART_XAXIS_LINE_WIDTH:1,LINECHART_XAXIS_TEXT_COLOR:"#000000",LINECHART_XAXIS_TEXT_FONT:null,LINECHART_YAXIS_LINE_COLOR:"#808080",LINECHART_YAXIS_LINE_WIDTH:1,LINECHART_YAXIS_TEXT_COLOR:"#000000",LINECHART_YAXIS_TEXT_FONT:null,LINECHART_XSCALE_TEXT_FONT:null,LINECHART_XSCALE_TEXT_COLOR:"#000000",LINECHART_XSCALE_TEXT_ORIENTATION:"horizontal",LINECHART_XSCALE_LINE_COLOR:"#808080",LINECHART_XSCALE_LINE_WIDTH:.3,LINECHART_YSCALE_TEXT_VISIBLE:!0,LINECHART_YSCALE_TEXT_COLOR:"#000000",LINECHART_YSCALE_TEXT_FONT:null,LINECHART_YSCALE_LINE_COLOR:"#808080",LINECHART_YSCALE_LINE_WIDTH:.3,LINECHART_YSCALE_VALUE_GAP:0,LINECHART_YSCALE_PIXEL_GAP:20,LINECHART_YSCALE_MIN_TEXT_VISIBLE:!1,LINECHART_VALUESPANCOUNT:1,BUBBLECHART_UPPER_LIMIT:null,BUBBLECHART_LOWER_LIMIT:null,BUBBLECHART_XAXIS_UPPER_LIMIT:null,BUBBLECHART_XAXIS_LOWER_LIMIT:null,BUBBLECHART_XAXIS_LINE_COLOR:"#808080",BUBBLECHART_XAXIS_LINE_WIDTH:1,BUBBLECHART_XAXIS_TEXT_COLOR:"#000000",BUBBLECHART_XAXIS_TEXT_FONT:null,BUBBLECHART_YAXIS_LINE_COLOR:"#808080",BUBBLECHART_YAXIS_LINE_WIDTH:1,BUBBLECHART_YAXIS_TEXT_COLOR:"#000000",BUBBLECHART_YAXIS_TEXT_FONT:null,BUBBLECHART_XSCALE_TEXT_FONT:null,BUBBLECHART_XSCALE_TEXT_COLOR:"#000000",BUBBLECHART_XSCALE_TEXT_ORIENTATION:"horizontal",BUBBLECHART_XSCALE_LINE_COLOR:"#808080",BUBBLECHART_XSCALE_LINE_WIDTH:.3,BUBBLECHART_YSCALE_TEXT_VISIBLE:!0,BUBBLECHART_YSCALE_TEXT_COLOR:"#000000",BUBBLECHART_YSCALE_TEXT_FONT:null,
BUBBLECHART_YSCALE_LINE_COLOR:"#808080",BUBBLECHART_YSCALE_LINE_WIDTH:.3,BUBBLECHART_YSCALE_VALUE_GAP:0,BUBBLECHART_YSCALE_PIXEL_GAP:20,BUBBLECHART_YSCALE_MIN_TEXT_VISIBLE:!1,BUBBLECHART_SELECT_SHADOW_COLOR:"#000000",BUBBLECHART_SELECT_SHADOW_OFFSET:3,RADARCHART_AXIS_TEXT_FONT:null,RADARCHART_AXIS_TEXT_COLOR:"#000000",RADARCHART_AXIS_TEXT_VISIBLE:!0,RADARCHART_SCALE_TEXT_FONT:null,RADARCHART_SCALE_TEXT_COLOR:"#000000",RADARCHART_SCALE_TEXT_VISIBLE:!0,RADARCHART_AXIS_VISIBLE:!0,RADARCHART_AXIS_LINE_COLOR:"#808080",RADARCHART_AXIS_LINE_WIDTH:3,RADARCHART_AXIS_START_ANGLE:0,RADARCHART_RING_VISIBLE:!0,RADARCHART_RING_TYPE:"line",RADARCHART_RING_LINE_COLOR:"#808080",RADARCHART_RING_LINE_WIDTH:1,RADARCHART_SCALE_COUNT:5,RADARCHART_SCALE_MAXVALUE:1,RADARCHART_SCALE_MINVALUE:0,RADARCHART_ANCHOR_VISIBLE:!0,RADARCHART_AREA_FILL:!0,RADARCHART_AREA_FILL_ALPHA:.2,RADARCHART_AREA_SELECT_FILL_ALPHA:.5,DIALCHART_UPPER_LIMIT:100,DIALCHART_LOWER_LIMIT:0,DIALCHART_START_ANGLE:0,DIALCHART_END_ANGLE:360,DIALCHART_INNER_RADIUS:.8,DIALCHART_COLOR_RANGE_FILL_COLOR:"#808080",DIALCHART_OUTLINE_WIDTH:0,DIALCHART_OUTLINE_COLOR:"#808080",DIALCHART_SCALE_INSIDE:!0,DIALCHART_MAJOR_SCALE_COUNT:11,DIALCHART_MAJOR_SCALE_LINE_WIDTH:2,DIALCHART_MAJOR_SCALE_LINE_LENGTH:8,DIALCHART_MAJOR_SCALE_LINE_COLOR:"#000000",DIALCHART_MINOR_SCALE_COUNT:4,DIALCHART_MINOR_SCALE_LINE_WIDTH:1,DIALCHART_MINOR_SCALE_LINE_LENGTH:4,DIALCHART_MINOR_SCALE_LINE_COLOR:"#000000",DIALCHART_SCALE_TEXT_VISIBLE:!0,DIALCHART_SCALE_UPPER_LIMIT_TEXT_VISIBLE:!0,DIALCHART_SCALE_LOWER_LIMIT_TEXT_VISIBLE:!0,DIALCHART_SCALE_TEXT_FONT:null,DIALCHART_SCALE_TEXT_COLOR:"#000000",DIALCHART_PIVOT_RADIUS:10,DIALCHART_PIVOT_FILL:!0,DIALCHART_PIVOT_FILL_COLOR:"#808080",DIALCHART_PIVOT_OUTLINE_WIDTH:0,DIALCHART_PIVOT_OUTLINE_COLOR:"#808080",DIALCHART_VALUE_POSITION:.5,DIALCHART_INNER_DARKER_RADIUS:10,DIALCHART_OUTER_BRIGHTER_RADIUS:10,DIALCHART_SELECT_SHADOW_COLOR:"#000000",DIALCHART_SELECT_SHADOW_OFFSET:3,TABPANE_TAB_GAP:1,TABPANE_TAB_RADIUS:0,TABPANE_TAB_HEIGHT:24,TABPANE_TAB_ORIENTATION:"top",TABPANE_RESIZE_TOLERANCE:3,TABPANE_TAB_BACKGROUND:"#EBEBEB",TABPANE_DISABLED_COLOR:"#BABBBC",TABPANE_SELECT_BACKGROUND:"white",TABPANE_MOVE_BACKGROUND:"rgba(184,211,240,0.7)",TABPANE_INSERT_BACKGROUND:"orange",TABPANE_HORIZONTAL_ALIGN:"center",TABPANE_CLOSE_ICON:"close_icon",TABPANE_SELECT_NEXT_ON_CLOSE:!0,TABPANE_SELECT_NEXT_ON_INVISIBLE:!0,LISTBASE_INNER_TEXT:!0,LIST_ROW_HEIGHT:19,LIST_INDENT:2,LIST_ROW_LINE_WIDTH:0,LIST_ROW_LINE_COLOR:"#DDD",LIST_MAKE_VISIBLE_ON_SELECTED:!0,LIST_KEYBOARD_REMOVE_ENABLED:!0,LIST_KEYBOARD_SELECT_ENABLED:!0,TREE_ROW_HEIGHT:19,TREE_INDENT:16,TREE_ROW_LINE_WIDTH:0,TREE_ROW_LINE_COLOR:"#DDD",TREE_MAKE_VISIBLE_ON_SELECTED:!0,TREE_KEYBOARD_REMOVE_ENABLED:!0,TREE_KEYBOARD_SELECT_ENABLED:!0,TREE_EXPAND_ICON:"expand_icon",TREE_COLLAPSE_ICON:"collapse_icon",TREE_LINE_TYPE:"none",TREE_LINE_THICKNESS:2,TREE_LINE_COLOR:"#000000",TREE_LINE_ALPHA:1,TREE_LINE_DASH:[4,2],TREE_TOOLTIP_ENABLED:!0,TABLE_ROW_HEIGHT:19,TABLE_ROW_LINE_WIDTH:1,TABLE_ROW_LINE_COLOR:"#DDD",TABLE_COLUMN_LINE_WIDTH:1,TABLE_COLUMN_LINE_COLOR:"#DDD",TABLE_MAKE_VISIBLE_ON_SELECTED:!0,TABLE_KEYBOARD_REMOVE_ENABLED:!0,TABLE_KEYBOARD_SELECT_ENABLED:!0,TABLE_EDITABLE:!1,TABLEHEADER_HEIGHT:24,TABLEHEADER_RESIZE_TOLERANCE:3,TABLEHEADER_BACKGROUND:"#EBEBEB",TABLEHEADER_MOVE_BACKGROUND:"rgba(184,211,240,0.7)",TABLEHEADER_INSERT_BACKGROUND:"orange",TABLEHEADER_COLUMN_LINE_COLOR:"#DDD",TABLEHEADER_SORT_DESC_ICON:"sort_desc",TABLEHEADER_SORT_ASC_ICON:"sort_asc",TABLEHEADER_SORT_ICON_POSITION:"98% 50%",TREETABLE_ROW_HEIGHT:19,TREETABLE_INDENT:16,TREETABLE_ROW_LINE_WIDTH:1,TREETABLE_ROW_LINE_COLOR:"#DDD",TREETABLE_COLUMN_LINE_WIDTH:1,TREETABLE_COLUMN_LINE_COLOR:"#DDD",TREETABLE_MAKE_VISIBLE_ON_SELECTED:!0,TREETABLE_KEYBOARD_REMOVE_ENABLED:!0,TREETABLE_KEYBOARD_SELECT_ENABLED:!0,TREETABLE_EXPAND_ICON:"expand_icon",TREETABLE_COLLAPSE_ICON:"collapse_icon",TREETABLE_EDITABLE:!1,PROPERTYSHEET_AUTO_ADJUSTABLE:!0,PROPERTYSHEET_INDENT:16,PROPERTYSHEET_ROW_HEIGHT:19,PROPERTYSHEET_ROW_LINE_WIDTH:1,PROPERTYSHEET_COLUMN_LINE_WIDTH:1,PROPERTYSHEET_BORDER_COLOR:"#EBEBEB",PROPERTYSHEET_EXPAND_ICON:"expand_icon",PROPERTYSHEET_COLLAPSE_ICON:"collapse_icon",PROPERTYSHEET_PROPERTY_NAME_WIDTH:100,PROPERTYSHEET_PROPERTY_NAME_HORIZONTAL_ALIGN:"",PROPERTYSHEET_SUM_WIDTH:200,PROPERTYSHEET_RESIZE_TOLERANCE:3,PROPERTYSHEET_EDITABLE:!1,PROPERTYSHEET_CATEGORIZABLE:!0,PROPERTYSHEET_EXPAND_CATEGORY:!0,POPUPMENU_SUBNENU_ENABLE_ICON:"submenu_enable_icon",POPUPMENU_SUBNENU_DISABLE_ICON:"submenu_disable_icon",POPUPMENU_CHECKBOX_SELECTED_ICON:"checkbox_selected_icon",POPUPMENU_CHECKBOX_UNSELECTED_ICON:"checkbox_unselected_icon",POPUPMENU_RADIOBUTTON_SELECTED_ICON:"radiobutton_selected_icon",POPUPMENU_RADIOBUTTON_UNSELECTED_ICON:"radiobutton_unselected_icon",SPLITPANE_ORIENTATION:"horizontal",SPLITPANE_POSITION:.5,SPLITPANE_DIVIDER_WIDTH:6,SPLITPANE_DIVIDER_BACKGROUND:"#CCCCFF",SPLITPANE_DIVIDER_OPACITY:.5,SPLITPANE_MASK_BACKGROUND:"",NODE_WIDTH:50,NODE_HEIGHT:50,IMAGE_NODE:"node_image",IMAGE_GROUP:"group_image",IMAGE_SUBNETWORK:"subgl3dview_image",ICON_DATABOX:"databox_icon",ICON_DATA:"data_icon",ICON_NODE:"node_icon",ICON_LINK:"link_icon",ICON_GROUP:"group_icon",ICON_SUBNETWORK:"subgl3dview_icon",ICON_GRID:"grid_icon",ICON_BUS:"bus_icon",ICON_SHAPENODE:"shapenode_icon",ICON_SHAPELINK:"shapelink_icon",ICON_LINKSUBNETWORK:"linksubgl3dview_icon",ICON_SHAPESUBNETWORK:"shapesubgl3dview_icon",LAYER_DEFAULT_ID:"default",LAYER_DEFAULT_NAME:"default",ATTACHMENT_POINTER_LENGTH:10,ATTACHMENT_POINTER_WIDTH:8,ATTACHMENT_CORNER_RADIUS:5,ATTACHMENT_CONTENT_WIDTH:30,ATTACHMENT_CONTENT_HEIGHT:20,ATTACHMENT_POSITION:"topright.topright",ATTACHMENT_XOFFSET:0,ATTACHMENT_YOFFSET:0,ATTACHMENT_PADDING:0,ATTACHMENT_PADDING_LEFT:0,ATTACHMENT_PADDING_RIGHT:0,ATTACHMENT_PADDING_TOP:0,ATTACHMENT_PADDING_BOTTOM:0,ATTACHMENT_DIRECTION:"right",ATTACHMENT_FILL:!1,ATTACHMENT_FILL_COLOR:"#000000",ATTACHMENT_GRADIENT:null,ATTACHMENT_GRADIENT_COLOR:"#FFFFFF",ATTACHMENT_OUTLINE_WIDTH:-1,ATTACHMENT_OUTLINE_COLOR:"#000000",ATTACHMENT_CAP:"butt",ATTACHMENT_JOIN:"miter",ATTACHMENT_SHADOWABLE:!0,NETWORK_TOOLTIP_ENABLED:!0,NETWORK_SELECT_MODE:"mix",NETWORK_MAKE_VISIBLE_ON_SELECTED:!0,NETWORK_NO_AGENT_LINK_VISIBLE:!1,NETWORK_REMOVE_ELEMENTUI_ON_INVISIBLE:!1,NETWORK_SUBNETWORK_ANIMATE:!0,NETWORK_SENDTOTOP_ON_SELECTED:!0,NETWORK_KEYBOARD_REMOVE_ENABLED:!0,NETWORK_KEYBOARD_SELECT_ENABLED:!0,NETWORK_RECT_SELECT_ENABLED:!0,NETWORK_DOUBLECLICK_TO_SUBNETWORK:!0,NETWORK_DOUBLECLICK_TO_UPSUBNETWORK:!0,NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK:!0,NETWORK_DOUBLECLICK_TO_LINKBUNDLE:!0,NETWORK_DOUBLECLICK_TO_GROUPEXPAND:!0,NETWORK_SELECT_OUTLINE_COLOR:"#2877A8",NETWORK_SELECT_OUTLINE_WIDTH:1,NETWORK_SELECT_FILL_COLOR:"rgba(184,211,240,0.4)",NETWORK_LAZYMOVE_OUTLINE_COLOR:"#2877A8",NETWORK_LAZYMOVE_OUTLINE_WIDTH:1,NETWORK_LAZYMOVE_FILL_COLOR:"rgba(184,211,240,0.4)",NETWORK_LAZYMOVE_FILL:!0,NETWORK_LAZYMOVE_ANIMATE:!0,NETWORK_RESIZE_POINT_SIZE:3,NETWORK_RESIZE_POINT_FILL_COLOR:"#FFFFFF",NETWORK_RESIZE_POINT_OUTLINE_COLOR:"#000000",NETWORK_RESIZE_POINT_OUTLINE_WIDTH:1,NETWORK_RESIZE_LINE_COLOR:"#000000",NETWORK_RESIZE_LINE_WIDTH:1,NETWORK_RESIZE_ANIMATE:!0,NETWORK_EDIT_POINT_SIZE:3,NETWORK_EDIT_POINT_FILL_COLOR:"#FFFF00",NETWORK_EDIT_POINT_OUTLINE_COLOR:"#000000",NETWORK_EDIT_POINT_OUTLINE_WIDTH:1,NETWORK_EDIT_LINE_COLOR:"rgba(184,211,240,0.7)",NETWORK_EDIT_LINE_WIDTH:2,NETWORK_ROTATE_POINT_SIZE:5,NETWORK_ROTATE_POINT_FILL_COLOR:"#FFFF00",NETWORK_ROTATE_POINT_OFFSET:15,NETWORK_ROTATE_POINT_OUTLINE_WIDTH:1,NETWORK_ROTATE_POINT_OUTLINE_COLOR:"rgba(0,0,0,1)",NETWORK_ROTATE_SCALE_FILL_COLOR:"rgb(227,166,103)",NETWORK_ROTATE_SCALE_FONT_COLOR:"#FFFFFF",NETWORK_ROTATE_SCALE_WIDTH:30,NETWORK_ROTATE_SCALE_HEIGHT:20,NETWORK_LIMIT_ELEMENT_INPOSITIVE_LOCATION:!0,NETWORK_LINK_FLOW_STEPPING:3,NETWORK_LINK_FLOW_COLOR:"#FF0000",NETWORK_LINK_FLOW_INTERVAL:600,NETWORK_SELECTION_TOLERANCE:2,NETWORK_TRANSPARENT_SELECTION_ENABLE:!1,SHOW_ALARM_IN_ATTACHMENT_DIV:!0,SHOW_LABEL_IN_ATTACHMENT_DIV:!1,SHOW_LABEL2_IN_ATTACHMENT_DIV:!1,SHOW_ICON_IN_ATTACHMENT_DIV:!1,SHOW_EDIT_IN_ATTACHMENT_DIV:!1,OVERVIEW_FILL_COLOR:"rgba(184,211,240,0.4)",OVERVIEW_OUTLINE_COLOR:"#B8D3F0",OVERVIEW_OUTLINE_WIDTH:1,OVERVIEW_SELECT_COLOR:"#0000FF",OVERVIEW_SELECT_WIDTH:1,OVERVIEW_PADDING:1,OVERVIEW_ANIMATE:!0,OVERVIEW_MAX_PACKING_WIDTH:-1,OVERVIEW_MAX_PACKING_HEIGHT:-1,TOUCH_MOVE_THRESHOLD:5,TOUCH_RECT_SELECT_THRESHOLD:20,TOUCH_ZOOM_THRESHOLD:30,LINK_BUNDLE_AGENT_FUNCTION:null,IS_LINK_ADJUSTED_TO_BOTTOM:!1,ELEMENTUI_FUNCTION:function(a,b){var c=b.getElementUIClass();return c?new c(a,b):null},CANVASUI_FUNCTION:function(a,b){var c=b.getCanvasUIClass();return c?new c(a,b):null},VECTORUI_FUNCTION:function(a,b){var c=b.getVectorUIClass();return c?new c(a,b):null},KEEP_DEFAULT_FUNCTION:function(a){return a.target.keepDefault||a.target.getAttribute("keepDefault")?!0:a.target.parentNode&&(a.target.parentNode.keepDefault||a.target.parentNode.getAttribute("keepDefault"))?!0:a.shiftKey?!0:!1},SORT_FUNCTION:function(a,c){if(a===c)return 0;if(null==a&&null!=c)return 1;if(null!=a&&null==c)return-1;if(null==a&&null==c)return 0;var d,e=typeof a,f=typeof c;return"string"===e&&"string"===f&&(d=a.localeCompare(c)),"number"===e&&"number"===f&&(d=a-c),d===b&&(d=(""+a).localeCompare(""+c)),d>0?1:0>d?-1:0},CENTER_LOCATION:!1};!function(){var b=Cd;if(a.OverrideTWaverDefaults)for(var c in OverrideTWaverDefaults)b[c]=OverrideTWaverDefaults[c];b.FONT=b.VIEW_FONT_SIZE&&b.VIEW_FONT_FAMILY?b.VIEW_FONT_SIZE+" "+b.VIEW_FONT_FAMILY:Ob.createElement("canvas").getContext("2d").font,b.CHART_VALUE_FONT||(b.CHART_VALUE_FONT="10px "+b.VIEW_FONT_FAMILY),b.BARCHART_XSCALE_TEXT_FONT||(b.BARCHART_XSCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY),b.BARCHART_YSCALE_TEXT_FONT||(b.BARCHART_YSCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY),b.BARCHART_XAXIS_TEXT_FONT||(b.BARCHART_XAXIS_TEXT_FONT="12px "+b.VIEW_FONT_FAMILY),b.BARCHART_YAXIS_TEXT_FONT||(b.BARCHART_YAXIS_TEXT_FONT="12px "+b.VIEW_FONT_FAMILY),b.LINECHART_XSCALE_TEXT_FONT||(b.LINECHART_XSCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY),b.LINECHART_YSCALE_TEXT_FONT||(b.LINECHART_YSCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY),b.LINECHART_XAXIS_TEXT_FONT||(b.LINECHART_XAXIS_TEXT_FONT="12px "+b.VIEW_FONT_FAMILY),b.LINECHART_YAXIS_TEXT_FONT||(b.LINECHART_YAXIS_TEXT_FONT="12px "+b.VIEW_FONT_FAMILY),b.BUBBLECHART_XAXIS_TEXT_FONT||(b.BUBBLECHART_XAXIS_TEXT_FONT="12px "+b.VIEW_FONT_FAMILY),b.BUBBLECHART_YAXIS_TEXT_FONT||(b.BUBBLECHART_YAXIS_TEXT_FONT="12px "+b.VIEW_FONT_FAMILY),b.BUBBLECHART_XSCALE_TEXT_FONT||(b.BUBBLECHART_XSCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY),b.BUBBLECHART_YSCALE_TEXT_FONT||(b.BUBBLECHART_YSCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY),b.RADARCHART_AXIS_TEXT_FONT||(b.RADARCHART_AXIS_TEXT_FONT="12px "+b.VIEW_FONT_FAMILY),b.RADARCHART_SCALE_TEXT_FONT||(b.RADARCHART_SCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY),b.DIALCHART_SCALE_TEXT_FONT||(b.DIALCHART_SCALE_TEXT_FONT="10px "+b.VIEW_FONT_FAMILY)}(),Ib.Defaults=Cd,Jb.ext("twaver.Defaults",Object,{}),Ib.Colors={orange:"#EC6C00",orange_light:"#EF8200",orange_dark:"#EA5404",gray_light:"#666666",gray_dark:"#242424",green_light:"#57AB9A",green_dark:"#238475",blue_light:"#61B6D8",blue_dark:"#0089C1"},Ib.SerializationSettings=function(){var a=Ib.SerializationSettings;this.isServaSerializable=a.isServaSerializable,this.isLayerBoxSerializable=a.isLayerBoxSerializable,this.isStyleSerializable=a.isStyleSerializable,this.isClientSerializable=a.isClientSerializable,this.isImageSerializable=a.isImageSerializable,this._pm=Jb.clone(a._pm),this._sm=Jb.clone(a._sm),this._cm=Jb.clone(a._cm)},function(){var a=Ib.SerializationSettings;a.isServaSerializable=!0,a.isLayerBoxSerializable=!0,a.isStyleSerializable=!0,a.isClientSerializable=!0,a.isImageSerializable=!0,a._pm={},a._sm={},a._cm={},a.setPropertyType=function(b,c){a._pm[b]=c},a.getPropertyType=function(b){return a._pm[b]},a.setStyleType=function(b,c){a._sm[b]=c},a.getStyleType=function(b){return a._sm[b]},a.setClientType=function(b,c){a._cm[b]=c},a.getClientType=function(b){return a._cm[b]}}(),Jb.ext("twaver.SerializationSettings",Object,{setPropertyType:function(a,b){this._pm[a]=b},getPropertyType:function(a){return this._pm[a]},setStyleType:function(a,b){this._sm[a]=b},getStyleType:function(a){return this._sm[a]},setClientType:function(a,b){this._cm[a]=b},getClientType:function(a){return this._cm[a]}}),Ib.Styles={_m:{},setStyle:function(a,b){null==b?delete Ib.Styles._m[a]:Ib.Styles._m[a]=b},getStyle:function(a){return Ib.Styles._m[a]},getStyleProperties:function(){return Jb.keys(Ib.Styles._m)}},function(){var a=function(a,b){Ib.SerializationSettings.setPropertyType(a,b)};a("name","cdata"),a("name2","cdata"),a("icon","string"),a("toolTip","cdata"),a("parent","data"),a("layerId","string"),a("alarmState","alarmstate"),a("image","string"),a("location","point"),a("width","number"),a("height","number"),a("expanded","boolean"),a("host","data"),a("fromNode","data"),a("toNode","data"),a("points","list.point"),a("segments","list.string"),a("angle","number"),a("visible","boolean"),a=function(a,b,c){null==c&&(c=null!=b?typeof b:"string"),Ib.Styles.setStyle(a,b),Ib.SerializationSettings.setStyleType(a,c)},a("chart.color",null),a("chart.value",0),a("chart.values",null,"list.number"),a("chart.value.color","#000000"),a("chart.value.font",null),a("chart.line.width",2),a("chart.marker.size",6),a("chart.marker.shape","circle"),a("chart.bubble.shape","circle"),a("chart.names",null,"list.string"),a("chart.xaxis.values",null,"list.number"),a("chart.yaxis.values",null,"list.number"),a("dialchart.rear.extension",0),a("dialchart.base.width",5),a("dialchart.top.width",0),a("dialchart.radius",.8),a("inner.color",null),a("outer.shape","rectangle"),a("outer.color",null),a("outer.width",2),a("outer.padding",1),a("outer.padding.left",0),a("outer.padding.right",0),a("outer.padding.top",0),a("outer.padding.bottom",0),a("outer.cap","butt"),a("outer.join","miter"),a("shadow.color",null),a("shadow.xoffset",3),a("shadow.yoffset",3),a("shadow.blur",6),a("select.style","shadow"),a("select.color","rgba(0, 0, 0, 0.7)"),a("select.shape","rectangle"),a("select.width",2),a("select.padding",2),a("select.padding.left",0),a("select.padding.right",0),a("select.padding.top",0),a("select.padding.bottom",0),a("select.cap","butt"),a("select.join","miter"),a("whole.alpha",1),a("body.type","default"),a("gl3dview.label",null,"cdata"),a("image.padding",0),a("image.padding.left",0),a("image.padding.right",0),a("image.padding.top",0),a("image.padding.bottom",0),a("image.state",null),a("vector.shape","rectangle"),a("vector.fill",!0),a("vector.fill.color","#CCCCFF"),a("vector.outline.width",-1),a("vector.outline.pattern",null,"array.number"),a("vector.outline.color","#5B5B5B"),a("vector.gradient","none"),a("vector.gradient.color","#FFFFFF"),a("vector.padding",0),a("vector.padding.left",0),a("vector.padding.right",0),a("vector.padding.top",0),a("vector.padding.bottom",0),a("vector.cap","butt"),a("vector.join","miter"),a("vector.deep",0),a("group.shape","rectangle"),a("group.fill",!0),a("group.fill.color","#CCCCFF"),a("group.outline.width",-1),a("group.outline.color","#5B5B5B"),a("group.gradient","none"),a("group.gradient.color","#FFFFFF"),a("group.padding",5),a("group.padding.left",0),a("group.padding.right",0),a("group.padding.top",0),a("group.padding.bottom",0),a("group.cap","butt"),a("group.join","miter"),a("group.deep",1),a("group.shape.roundrect.radius",-1),a("label.alpha",1),a("label.color","#000000"),a("label.font",null),a("label.position","bottom.bottom"),a("label.direction","below"),a("label.corner.radius",0),a("label.pointer.length",0),a("label.pointer.width",8),a("label.xoffset",0),a("label.yoffset",2),a("label.padding",0),a("label.padding.left",0),a("label.padding.right",0),a("label.padding.top",0),a("label.padding.bottom",0),a("label.fill",!1),a("label.fill.color","#C0C0C0"),a("label.gradient","none"),a("label.gradient.color","#FFFFFF"),a("label.outline.width",-1),a("label.outline.color","#000000"),a("label.cap","butt"),a("label.join","miter"),a("label.shadowable",!0),a("label.align","center"),a("link.label.rotatable",!1),a("label2.alpha",1),a("label2.color","#000000"),a("label2.font",null),a("label2.position","top.top"),a("label2.direction","below"),a("label2.corner.radius",0),a("label2.pointer.length",0),a("label2.pointer.width",8),a("label2.xoffset",0),a("label2.yoffset",-2),a("label2.padding",0),a("label2.padding.left",0),a("label2.padding.right",0),a("label2.padding.top",0),a("label2.padding.bottom",0),a("label2.fill",!1),a("label2.fill.color","#C0C0C0"),a("label2.gradient","none"),a("label2.gradient.color","#FFFFFF"),a("label2.outline.width",-1),a("label2.outline.color","#000000"),a("label2.cap","butt"),a("label2.join","miter"),a("label2.shadowable",!0),a("link.label2.rotatable",!1),a("icons.names",null,"array.string"),a("icons.colors",null,"array.string"),a("icons.position",null,"array.string"),a("icons.orientation",null,"array.string"),a("icons.xoffset",[0],"array.number"),a("icons.yoffset",[0],"array.number"),a("icons.xgap",[1],"array.number"),a("icons.ygap",[1],"array.number"),a("alarm.alpha",1),a("alarm.color","#000000"),a("alarm.font",null),a("alarm.position","hotspot"),a("alarm.direction","aboveright"),a("alarm.corner.radius",5),a("alarm.pointer.length",10),a("alarm.pointer.width",8),a("alarm.xoffset",0),a("alarm.yoffset",0),a("alarm.padding",0),a("alarm.padding.left",0),a("alarm.padding.right",0),a("alarm.padding.top",0),a("alarm.padding.bottom",0),a("alarm.gradient","none"),a("alarm.gradient.color","#FFFFFF"),a("alarm.outline.width",-1),a("alarm.outline.color","#000000"),a("alarm.cap","butt"),a("alarm.join","miter"),a("alarm.shadowable",!0),a("link.color","#658DC1"),a("link.width",3),a("link.cap","butt"),a("link.join","miter"),a("link.type","arc"),a("link.pattern",null,"array.number"),a("link.extend",20),a("link.control.point",null,"point"),a("link.bundle.id",0),a("link.bundle.enable",!0),a("link.bundle.expanded",!0),a("link.bundle.independent",!1),a("link.bundle.offset",20),a("link.bundle.gap",12),a("link.bundle.group.gap",0),a("link.looped.gap",6),a("link.looped.direction","northwest"),a("link.looped.type","arc"),a("link.from.position","center"),a("link.from.xoffset",0),a("link.from.yoffset",0),a("link.from.at.edge",!0),a("link.to.position","center"),a("link.to.xoffset",0),a("link.to.yoffset",0),a("link.to.at.edge",!0),a("link.split.by.percent",!0),a("link.split.percent",.5),a("link.split.value",20),a("link.corner","round"),a("link.xradius",8),a("link.yradius",8),a("link.flow",!1),a("link.flow.converse",!1),a("link.handler.alpha",1),a("link.handler.color","#000000"),a("link.handler.font",null),a("link.handler.position","topleft.topleft"),a("link.handler.direction","below"),a("link.handler.corner.radius",0),a("link.handler.pointer.length",0),a("link.handler.pointer.width",8),a("link.handler.xoffset",0),a("link.handler.yoffset",0),a("link.handler.padding",0),a("link.handler.padding.left",0),a("link.handler.padding.right",0),a("link.handler.padding.top",0),a("link.handler.padding.bottom",0),a("link.handler.fill",!1),a("link.handler.fill.color","#C0C0C0"),a("link.handler.gradient","none"),a("link.handler.gradient.color","#FFFFFF"),a("link.handler.outline.width",-1),a("link.handler.outline.color","#000000"),a("link.handler.cap","butt"),a("link.handler.join","miter"),a("link.handler.shadowable",!0),a("follower.row.index",0),a("follower.column.index",0),a("follower.row.span",1),a("follower.column.span",1),a("follower.padding",0),a("follower.padding.left",0),a("follower.padding.right",0),a("follower.padding.top",0),a("follower.padding.bottom",0),a("follower.fill.cell",!0),a("follower.cell.position","center"),a("grid.row.count",1),a("grid.column.count",1),a("grid.row.percents",null,"array.number"),a("grid.column.percents",null,"array.number"),a("grid.border",1),a("grid.border.left",0),a("grid.border.right",0),a("grid.border.top",0),a("grid.border.bottom",0),a("grid.padding",1),a("grid.padding.left",0),a("grid.padding.right",0),a("grid.padding.top",0),a("grid.padding.bottom",0),a("grid.fill",!0),a("grid.fill.color","#C0C0C0"),a("grid.deep",1),a("grid.cell.deep",-1),a("shapelink.type","lineto"),a("shapenode.closed",!1),a("shapenode.pattern",null,"array.number"),a("bus.style","nearby"),a("arrow.from",!1),a("arrow.from.fill",!0),a("arrow.from.shape","arrow.standard"),a("arrow.from.color","#000000"),a("arrow.from.xoffset",0),a("arrow.from.yoffset",0),a("arrow.from.width",12),a("arrow.from.height",9),a("arrow.from.outline.color","#000000"),a("arrow.from.outline.width",-1),a("arrow.from.at.edge",!0),a("arrow.to",!1),a("arrow.to.fill",!0),a("arrow.to.shape","arrow.standard"),a("arrow.to.color","#000000"),a("arrow.to.xoffset",0),a("arrow.to.yoffset",0),a("arrow.to.width",12),a("arrow.to.height",9),a("arrow.to.outline.color","#000000"),a("arrow.to.outline.width",-1),a("arrow.to.at.edge",!0),a("background.image",null),a("background.type","none"),a("background.outline.width",-1),a("background.outline.color",null),a("background.vector.padding",0),a("background.image.padding",0),a("background.image.stretch","fill"),a("background.vector.fill",null),a("background.vector.fill.color",null),a("background.vector.gradient",!1),a("background.vector.gradient.color",null),a("background.vector.shape","rectangle"),a("background.outline.pattern",null,"array.number"),a("attachment.label.style","html"),a("attachment.alarm.style","html")}(),Jb.ext("twaver.Styles",Object,{}),Ib.PropertyChangeDispatcher=function(){this._dispatcher=new Ib.EventDispatcher},Jb.ext("twaver.PropertyChangeDispatcher",Object,{addPropertyChangeListener:function(a,b,c){this._dispatcher.add(a,b,c)},removePropertyChangeListener:function(a,b){this._dispatcher.remove(a,b)},firePropertyChange:function(a,b,c){if(b==c)return!1;var d={property:a,oldValue:b,newValue:c,source:this};return this._dispatcher.fire(d),this.onPropertyChanged(d),!0},onPropertyChanged:function(a){}}),Ib.animate.Animate=function(){},Jb.ext("twaver.animate.Animate",Object,{current:0,step:8,delay:4,finishFunction:null,shouldBeFinished:!1,getCurrentDelay:function(){return this.delay*this.current+1},action:function(a){}}),Ib.animate.AnimateProperty=function(a,b,c){this.objects=a,this.newValues=b,this.finishFunction=c,this.oldValues=new md;for(var d=this.objects.size(),e=0;d>e;e++){var f=this.objects.get(e);this.oldValues.add(this.getPropertyValue(f))}},Jb.ext("twaver.animate.AnimateProperty",Ib.animate.Animate,{action:function(a){for(var b=this.objects.size(),c=0;b>c;c++){var d=this.objects.get(c),e=this.oldValues.get(c),f=this.newValues.get(c);this.currentAction(d,e,f,a)}},getPropertyValue:function(a){},currentAction:function(a,b,c,d){}}),Ib.animate.AnimateBounds=function(a,b,c){this.node=a,this.newBounds=b,this.oldBounds=a.getRect(),this.finishFunction=c},Jb.ext("twaver.animate.AnimateBounds",Ib.animate.Animate,{shouldBeFinished:!0,action:function(a){var b=this.oldBounds,c=this.newBounds;this.node.setLocation(b.x+(c.x-b.x)*a,b.y+(c.y-b.y)*a),this.node.setSize(b.width+(c.width-b.width)*a,b.height+(c.height-b.height)*a)}}),Ib.animate.AnimateCenterLocation=function(a,b,c){Ib.animate.AnimateCenterLocation.superClass.constructor.call(this,a,b,c)},Jb.ext("twaver.animate.AnimateCenterLocation",Ib.animate.AnimateProperty,{getPropertyValue:function(a){return a.getCenterLocation()},currentAction:function(a,b,c,d){var e=b.x+(c.x-b.x)*d,f=b.y+(c.y-b.y)*d;a.setCenterLocation(e,f)}}),Ib.animate.AnimateLocation=function(a,b,c){Ib.animate.AnimateLocation.superClass.constructor.call(this,a,b,c)},Jb.ext("twaver.animate.AnimateLocation",Ib.animate.AnimateProperty,{getPropertyValue:function(a){return a.getLocation()},currentAction:function(a,b,c,d){var e=b.x+(c.x-b.x)*d,f=b.y+(c.y-b.y)*d;a.setLocation(e,f)}}),Ib.animate.AnimateScrollPosition=function(a,b,c){this.view=a,this.oldHorizontalOffset=a.scrollLeft,this.oldVerticalOffset=a.scrollTop,this.newHorizontalOffset=b,this.newVerticalOffset=c},Jb.ext("twaver.animate.AnimateScrollPosition",Ib.animate.Animate,{action:function(a){this.view.scrollLeft=this.oldHorizontalOffset+(this.newHorizontalOffset-this.oldHorizontalOffset)*a,this.view.scrollTop=this.oldVerticalOffset+(this.newVerticalOffset-this.oldVerticalOffset)*a}}),Ib.animate.AnimateZoom=function(a,b,c){this.view=a,this.oldZoom=a.getZoom(),this.newZoom=b,this.finishFunction=c},Jb.ext("twaver.animate.AnimateZoom",Ib.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setZoom(this.oldZoom+(this.newZoom-this.oldZoom)*a,!1)}}),Ib.animate.AnimateXZoom=function(a,b,c){this.view=a,this.oldXZoom=a.getXZoom(),this.newXZoom=b,this.finishFunction=c},Jb.ext("twaver.animate.AnimateXZoom",Ib.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setXZoom(this.oldXZoom+(this.newXZoom-this.oldXZoom)*a,!1)}}),Ib.animate.AnimateYZoom=function(a,b,c){this.view=a,this.oldYZoom=a.getYZoom(),this.newYZoom=b,this.finishFunction=c},Jb.ext("twaver.animate.AnimateYZoom",Ib.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setYZoom(this.oldYZoom+(this.newYZoom-this.oldYZoom)*a,!1)}}),Ib.animate.AnimateXYZoom=function(a,b,c,d){this.view=a,this.oldXZoom=a.getXZoom(),this.newXZoom=b,this.oldYZoom=a.getYZoom(),this.newYZoom=c,this.finishFunction=d},Jb.ext("twaver.animate.AnimateXYZoom",Ib.animate.Animate,{shouldBeFinished:!0,action:function(a){this.view.setXZoom(this.oldXZoom+(this.newXZoom-this.oldXZoom)*a,!1),this.view.setYZoom(this.oldYZoom+(this.newYZoom-this.oldYZoom)*a,!1)}}),Ib.animate.AnimateSubGl3dview=function(a,b,c){this.gl3dview=a,this.subGl3dview=b,this.finishFunction=c},Jb.ext("twaver.animate.AnimateSubGl3dview",Ib.animate.Animate,{shouldBeFinished:!0,action:function(a){a>.5?(this.gl3dview.getView().style.opacity=2*a-1,this.gl3dview._setCurrentSubGl3dview(this.subGl3dview)):this.gl3dview.getView().style.opacity=1-2*a}}),Ib.animate.AnimateManager={timer:null,animate:null,start:function(a,b){var c=Ib.animate.AnimateManager;a.current<0&&(a.current=0),b?Jb.callLater(c.startImpl,null,[a],b):c.startImpl(a)},startImpl:function(a){var b=Ib.animate.AnimateManager;b.animate&&b.endAnimate(),b.animate=a,b.timer=setTimeout(b.tick,a.getCurrentDelay())},tick:function(){var a=Ib.animate.AnimateManager,b=a.animate;if(b){if(b.current<0)return void b.current++;b.current<b.step&&(b.current++,b.action(b.current/b.step),a.timer=setTimeout(a.tick,b.getCurrentDelay())),b.current>=b.step&&a.endAnimate()}},endAnimate:function(){var a=Ib.animate.AnimateManager;if(a.animate){a.animate.shouldBeFinished&&a.animate.current<a.animate.step&&(a.animate.current=a.animate.step,a.animate.action(a.animate.current/a.animate.step));var b=a.animate.finishFunction;a.animate=null,a.timer&&(clearTimeout(a.timer),a.timer=null),b&&b()}else a.timer&&(clearTimeout(a.timer),a.timer=null)}},Ib.Serva=function(a){Ib.Serva.superClass.constructor.apply(this,arguments),1===arguments.length&&(this._name=a),this._dataList=new md,this._dataMap={},this._rootList=new md,this._rootMap={},this._clientMap={},this._dataBoxChangeDispatcher=new Ib.EventDispatcher,this._dataPropertyChangeDispatcher=new Ib.EventDispatcher,this._hierarchyChangeDispatcher=new Ib.EventDispatcher,this._selectionContainer=new Ib.SelectionContainer(this)},Jb.ext("twaver.Serva",Ib.PropertyChangeDispatcher,{IClient:!0,__client:1,__new:1,_limit:-1,_name:"Serva",_icon:Cd.ICON_DATABOX,__accessor:["name","icon","toolTip"],getSelectionContainer:function(){return this._selectionContainer},size:function(){return this._dataList.size()},isEmpty:function(){return this._dataList.isEmpty()},getLimit:function(){return this._limit},setLimit:function(a){var b=this._limit;this._limit=a,this.firePropertyChange("limit",b,a),this._checkLimit()},_checkLimit:function(){this._limit>=0&&this.size()>this._limit&&this.removeFirst(this.size()-this._limit)},removeFirst:function(a){for(0===arguments.length&&(a=1);a>0&&this._dataList.size()>0;){var b=this._dataList.get(0);this.remove(b),a--}},getSiblings:function(a){if(!this.contains(a))throw a+" dosen't belong to this dataBox";var b=a.getParent();return b?b.getChildren():this._rootList},getRoots:function(){return this._rootList},getSiblingIndex:function(a){return a.getParent()?a.getParent().getChildren().indexOf(a):this._rootList.indexOf(a)},getDatas:function(){return this._dataList},getDataAt:function(a){return this._dataList.get(a)},toDatas:function(a,b){return this._dataList.toList(a,b)},forEach:function(a,b){this._dataList.forEach(a,b)},forEachReverse:function(a,b){this._dataList.forEachReverse(a,b)},forEachByDepthFirst:function(a,b,c){if(b)this._depthFirst(a,b,c);else for(var d=this._rootList.size(),e=0;d>e;e++){var f=this._rootList.get(e);if(this._depthFirst(a,f,c)===!1)return}},_depthFirst:function(a,b,c){for(var d=b.getChildrenSize(),e=0;d>e;e++){var f=b.getChildAt(e);if(this._depthFirst(a,f,c)===!1)return!1}if(c){if(a.call(c,b)===!1)return!1}else if(a(b)===!1)return!1},forEachByBreadthFirst:function(a,b,c){var d=new md;for(b?d.add(b):this._rootList.forEach(d.add,d);d.size()>0;)if(b=d.removeAt(0),b.getChildren().forEach(d.add,d),c){if(a.call(c,b)===!1)return}else if(a(b)===!1)return},add:function(a,b){if(a){1===arguments.length&&(b=-1);var c=a.getId();if(this._dataMap.hasOwnProperty(c))throw"Data with ID '"+c+"' already exists";this._dataMap[c]=a,this._dataList.add(a),a.getParent()||(this._rootMap[c]=a,b>=0?this._rootList.add(a,b):this._rootList.add(a)),a.addPropertyChangeListener(this.handleDataPropertyChange,this,!0),this._dataBoxChangeDispatcher.fire({kind:"add",data:a}),this._checkLimit()}},remove:function(a){this.removeById(a.getId())},removeSelection:function(){this._selectionContainer.toSelection().forEach(function(a){this.remove(a)},this)},removeById:function(a){var b=this.getDataById(a);b&&(b instanceof Ib.Link&&(b.setFromNode(null),b.setToNode(null)),b instanceof Jd&&b.getLinks()&&b.getLinks().toList().forEach(function(a){this.remove(a)},this),b instanceof Jd&&b.getFollowers()&&b.getFollowers().toList().forEach(function(a){a.setHost(null)}),b instanceof Ib.Follower&&b.getHost()&&b.setHost(null),b.toChildren().forEach(function(a){this.remove(a)},this),b.getParent()&&b.getParent().removeChild(b),this._dataList.remove(b),delete this._dataMap[a],this._rootMap[a]&&(delete this._rootMap[a],this._rootList.remove(b)),this._dataBoxChangeDispatcher.fire({kind:"remove",data:b}),b.removePropertyChangeListener(this.handleDataPropertyChange,this))},clear:function(){if(this._dataList.size()>0){this._dataList.forEach(function(a){a.removePropertyChangeListener(this.handleDataPropertyChange,this)},this);var a=this._dataList.toList();this._dataList.clear(),this._dataMap={},this._rootList.clear(),this._rootMap={},this._dataBoxChangeDispatcher.fire({kind:"clear",datas:a})}},getDataById:function(a){return this._dataMap[a]},containsById:function(a){return this._dataMap.hasOwnProperty(a)},contains:function(a){return a?this._dataMap[a._id]===a:!1},moveTo:function(a,b){if(!this.contains(a))throw a+" dosen't belong to this dataBox";var c=this.getSiblings(a),d=c.indexOf(a);d===b||0>d||b>=0&&b<=c.size()&&(c.remove(a),b>c.size()&&b--,c.add(a,b),this._hierarchyChangeDispatcher.fire({data:a,oldIndex:d,newIndex:b}))},moveUp:function(a){var b=this.getSiblings(a);this.moveTo(a,b.indexOf(a)-1)},moveDown:function(a){var b=this.getSiblings(a);this.moveTo(a,b.indexOf(a)+1)},moveToTop:function(a){this.moveTo(a,0)},moveToBottom:function(a){var b=this.getSiblings(a);this.moveTo(a,b.size())},moveSelectionUp:function(a){a||(a=this._selectionContainer);var b=new md;yc.findMoveUpDatas(a,b,this._rootList),b.forEach(this.moveUp,this)},moveSelectionDown:function(a){a||(a=this._selectionContainer);var b=new md;yc.findMoveDownDatas(a,b,this._rootList),b.forEach(this.moveDown,this)},moveSelectionToTop:function(a){a||(a=this._selectionContainer);var b=new md;yc.findMoveToTopDatas(a,b,this._rootList),b.forEach(this.moveToTop,this)},moveSelectionToBottom:function(a){a||(a=this._selectionContainer);var b=new md;yc.findMoveToBottomDatas(a,b,this._rootList),b.forEach(this.moveToBottom,this)},handleDataPropertyChange:function(a){
var b=a.source;if("parent"===a.property){var c=b.getId();b.getParent()?this._rootMap[c]&&(delete this._rootMap[c],this._rootList.remove(b)):this._rootMap[c]||(this._rootMap[c]=b,this._rootList.add(b))}this.onDataPropertyChanged(b,a),this._dataPropertyChangeDispatcher.fire(a)},onDataPropertyChanged:function(a,b){},addServaChangeListener:function(a,b,c){this._dataBoxChangeDispatcher.add(a,b,c)},removeServaChangeListener:function(a,b){this._dataBoxChangeDispatcher.remove(a,b)},addDataPropertyChangeListener:function(a,b,c){this._dataPropertyChangeDispatcher.add(a,b,c)},removeDataPropertyChangeListener:function(a,b){this._dataPropertyChangeDispatcher.remove(a,b)},addHierarchyChangeListener:function(a,b,c){this._hierarchyChangeDispatcher.add(a,b,c)},removeHierarchyChangeListener:function(a,b){this._hierarchyChangeDispatcher.remove(a,b)},getRandomData:function(a){if(a){for(var b=new Ib.List,c=0;c<this._dataList.size()-1;c++){var d=this._dataList.get(c);d instanceof a&&b.add(d)}if(0==b.size())return null}var e=a?b.get(parseInt(Math.random()*b.size())):this._dataList.get(parseInt(Math.random()*this._dataList.size()));return e}}),Ib.ElementBox=function(a){Ib.ElementBox.superClass.constructor.apply(this,arguments),this._styleMap={},this._alarmBox=new Ib.AlarmBox(this),this._layerBox=new Ib.LayerBox(this),this._alarmStatePropagator=new Ib.AlarmStatePropagator(this),this._alarmStatePropagator.setEnable(!0),this._indexChangeDispatcher=new Ib.EventDispatcher},Ib.ElementBox.IS_INTERESTED_ADJUSTELEMENTINDEX_PROPERTY={fromAgent:1,toAgent:1,expanded:1,parent:1,host:1},Jb.ext("twaver.ElementBox",Ib.Serva,{IStyle:!0,__style:1,_name:"ElementBox",add:function(a,b){if(a){if(!a.IElement)throw"Only IElement can be added into ElementBox";Ib.ElementBox.superClass.add.apply(this,arguments),this.adjustElementIndex(a)}},onDataPropertyChanged:function(a,b){Ib.ElementBox.IS_INTERESTED_ADJUSTELEMENTINDEX_PROPERTY[b.property]&&this.adjustElementIndex(a),Ib.ElementBox.superClass.onDataPropertyChanged.apply(this,arguments)},addIndexChangeListener:function(a,b,c){this._indexChangeDispatcher.add(a,b,c)},removeIndexChangeListener:function(a,b){this._indexChangeDispatcher.remove(a,b)},sendToTop:function(a){if(this.contains(a)){if(a!==this.getDatas().get(this.size()-1)){var b=this.getDatas().indexOf(a);this.getDatas().removeAt(b),this.getDatas().add(a),this._indexChangeDispatcher.fire({element:a,oldIndex:b,newIndex:this.size()-1})}a instanceof Ib.Link&&(a.getFromAgent()&&!a.getFromAgent().isAdjustedToBottom()&&this.sendToTop(a.getFromAgent()),a.getToAgent()&&!a.getToAgent().isAdjustedToBottom()&&this.sendToTop(a.getToAgent())),a instanceof Jd&&a.getFollowers()&&a.getFollowers().forEach(function(b){b.isRelatedTo(a)||a instanceof Ib.Follower&&b.isLoopedHostOn(a)||this.sendToTop(b)},this),a.ISubGl3dview||a instanceof Ld&&!a.isExpanded()||a.getChildren().forEach(function(a){a instanceof Ib.Link||this.sendToTop(a)},this)}},sendToBottom:function(a,b){if(a!==b&&this.contains(a)&&(!b||this.contains(b))){var c=this.getDatas().remove(a),d=0;b&&(d=this.getDatas().indexOf(b)),this.getDatas().add(a,d),c!=d&&(this._indexChangeDispatcher.fire({element:a,oldIndex:c,newIndex:d}),!a.getParent()||a.getParent().ISubGl3dview||a.getParent()instanceof Ib.Link||this.sendToBottom(a.getParent(),a))}},fireIndexChange:function(a,b,c){this._indexChangeDispatcher.fire({element:a,oldIndex:b,newIndex:c})},adjustElementIndex:function(a){this.contains(a)&&(a.isAdjustedToBottom()?(this.sendToBottom(a),a.getChildren().forEach(this.adjustElementIndex,this)):this.sendToTop(a))},forEachByLayer:function(a,b,c){var d=this.size(),e=this.getDatas();if(b)for(var f=0;d>f;f++){var g=e.get(f);if(this._layerBox.getLayerByElement(g)===b)if(c){if(a.call(c,g)===!1)return}else if(a(g)===!1)return}else this._layerBox.forEachByDepthFirst(function(b){for(var f=0;d>f;f++){var g=e.get(f);if(this._layerBox.getLayerByElement(g)===b)if(c){if(a.call(c,g)===!1)return}else if(a(g)===!1)return}},null,this)},forEachByLayerReverse:function(a,b,c){var d=new md;this.forEachByLayer(function(a){d.add(a,0)},b),d.forEach(a,c)},getLayerBox:function(){return this._layerBox},getAlarmBox:function(){return this._alarmBox},getAlarmStatePropagator:function(){return this._alarmStatePropagator},startBatch:function(a,b){Ib._isInitializing=!0,Ib._bundleLinks={},Ib._links={},a.call(b);var c,d;for(var e in Ib._links)c=Ib._links[e],c._checkAgentNodeImpl();for(var e in Ib._bundleLinks)d=Ib._bundleLinks[e],vc.resetBundleLinks(d[0],d[1]);Ib._bundleLinks=null,Ib._links=null,Ib._isInitializing=!1}}),Ib.SelectionContainer=function(a){Ib.SelectionContainer.superClass.constructor.apply(this,arguments),this._selectionMode="multipleSelection",this._selectionList=new md,this._selectionChangeDispatcher=new Ib.EventDispatcher,this._selectionMap={},this._setServa(a)},Jb.ext("twaver.SelectionContainer",Ib.PropertyChangeDispatcher,{getSelectionMode:function(){return this._selectionMode},setSelectionMode:function(a){if(this._selectionMode!==a&&("noneSelection"===a||"singleSelection"===a||"multipleSelection"===a)){this.clearSelection();var b=this._selectionMode;this._selectionMode=a,this.firePropertyChange("selectionMode",b,this._selectionMode)}},getServa:function(){return this._dataBox},_setServa:function(a){if(!a)throw"dataBox can not be null";if(this._dataBox!==a){this._dataBox&&(this.clearSelection(),this._dataBox.removeServaChangeListener(this.handleServaChange,this));var b=this._dataBox;this._dataBox=a,this._dataBox.addServaChangeListener(this.handleServaChange,this,!0),this.firePropertyChange("dataBox",b,this._dataBox)}},dispose:function(){this.clearSelection(),this._dataBox.removeServaChangeListener(this.handleServaChange,this)},handleServaChange:function(a){if("remove"===a.kind){var b=a.data;this.contains(b)&&(this._selectionList.remove(b),delete this._selectionMap[b.getId()],this.fireSelectionChange("remove",new md(b)))}else"clear"===a.kind&&this.clearSelection()},getFilterFunction:function(){return this._filterFunction},setFilterFunction:function(a){if(this._filterFunction!==a){this.clearSelection();var b=this._filterFunction;this._filterFunction=a,this.firePropertyChange("filterFunction",b,this._filterFunction)}},fireSelectionChange:function(a,b,c){c&&(this._selectionList.forEach(function(a){c.contains(a)?c.remove(a):c.add(a)}),b=c.toList()),this._selectionChangeDispatcher.fire({kind:a,datas:new md(b)})},addSelectionChangeListener:function(a,b,c){this._selectionChangeDispatcher.add(a,b,c)},removeSelectionChangeListener:function(a,b){this._selectionChangeDispatcher.remove(a,b)},_filterList:function(a,b){for(var c=new md(a),d=0;d<c.size();d++){var e=c.get(d);(this._filterFunction&&!this._filterFunction(e)||b&&this.contains(e)||!b&&!this.contains(e)||!this._dataBox.contains(e))&&(c.removeAt(d),d--)}return c},appendSelection:function(a){if("noneSelection"!==this._selectionMode){var b=this._filterList(a,!0);if(!b.isEmpty()){var c=null;"singleSelection"===this._selectionMode&&(c=new md(this._selectionList),this._selectionList.clear(),this._selectionMap={},b=new md(b.get(b.size()-1)));for(var d=0;d<b.size();d++){var e=b.get(d);this._selectionList.add(e),this._selectionMap[e.getId()]=e}this.fireSelectionChange("append",b,c)}}},removeSelection:function(a){var b=this._filterList(a);if(0!==b.size()){for(var c=0;c<b.size();c++){var d=b.get(c);this._selectionList.remove(d),delete this._selectionMap[d.getId()]}this.fireSelectionChange("remove",b)}},toSelection:function(a,b){return this._selectionList.toList(a,b)},getSelection:function(){return this._selectionList},setSelection:function(a){if("noneSelection"!==this._selectionMode&&(0!==this._selectionList.size()||null!=a)){var b=new md(this._selectionList);this._selectionList.clear(),this._selectionMap={};var c=this._filterList(a,!0);"singleSelection"===this._selectionMode&&c.size()>1&&(c=new md(c.get(c.size()-1)));for(var d=0;d<c.size();d++){var e=c.get(d);this._selectionList.add(e),this._selectionMap[e.getId()]=e}this.fireSelectionChange("set",null,b)}},clearSelection:function(){if(this._selectionList.size()>0){var a=this._selectionList.toList();this._selectionList.clear(),this._selectionMap={},this.fireSelectionChange("clear",a)}},selectAll:function(){if("noneSelection"!==this._selectionMode){var a=this._dataBox.toDatas(),b=0,c=null;if(this._filterFunction)for(b=0;b<a.size();b++)c=a.get(b),this._filterFunction(c)||(a.removeAt(b),b--);var d=new md(this._selectionList);for(this._selectionList.clear(),this._selectionMap={},"singleSelection"===this._selectionMode&&a.size()>1&&(a=new md(a.get(a.size()-1))),b=0;b<a.size();b++)c=a.get(b),this._selectionList.add(c),this._selectionMap[c.getId()]=c;this.fireSelectionChange("all",null,d)}},size:function(){return this._selectionList.size()},contains:function(a){return a?null!=this._selectionMap[a.getId()]:!1},getLastData:function(){return this._selectionList.size()>0?this._selectionList.get(this._selectionList.size()-1):null},getFirstData:function(){return this._selectionList.size()>0?this._selectionList.get(0):null},isSelectable:function(a){return a?"noneSelection"===this._selectionMode?!1:this._filterFunction&&!this._filterFunction(a)?!1:!0:!1}}),Ib.QuickFinder=function(a,b,c,d,e){if(this._map={},!a)throw"dataBox can not be null";if(!b)throw"propertyName can not be null";this._dataBox=a,this._propertyName=b,this._propertyType=c||"accessor","accessor"===this._propertyType&&(this._getter=Jb.getter(b)),this._valueFunction=d||this.getValue,this._filterFunction=e||this.isInterested,this._dataBox.forEach(this._addData,this),this._dataBox.addServaChangeListener(this.handleServaChange,this,!0),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this,!0)},Jb.ext("twaver.QuickFinder",Object,{_NULL_:"twaver-null-key",getValueFunction:function(){return this._valueFunction},getFilterFunction:function(){return this._filterFunction},handleServaChange:function(a){"add"===a.kind?this._addData(a.data):"remove"===a.kind?this._removeData(a.data):"clear"===a.kind&&(this._map={})},handleDataPropertyChange:function(a){if(this._filterFunction.call(this,a.source)){if("accessor"===this._propertyType&&this._propertyName===a.property);else if("style"===this._propertyType&&a.source.IStyle&&"S:"+this._propertyName===a.property);else if("client"!==this._propertyType||"C:"+this._propertyName!==a.property)return;var b=this._getMap(a.oldValue);b&&b.remove(a.source),this._addData(a.source)}},_getMap:function(a){return a=null==a?this._NULL_:a,this._map[a]},find:function(a){var b=this._getMap(a);return b?b.toList():new md},findFirst:function(a){var b=this._getMap(a);return!b||b.isEmpty()?null:b.get(0)},_addData:function(a){if(this._filterFunction.call(this,a)){var b=this._valueFunction.call(this,a),c=this._getMap(b);c||(c=new md,b=null==b?this._NULL_:b,this._map[b]=c),c.add(a)}},_removeData:function(a){if(this._filterFunction.call(this,a)){var b=this._valueFunction.call(this,a),c=this._getMap(b);c&&(c.remove(a),c.isEmpty()&&(b=null==b?this._NULL_:b,delete this._map[b]))}},dispose:function(){this._dataBox.removeServaChangeListener(this.handleServaChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this),delete this._dataBox},getServa:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isInterested:function(a){return("style"!==this._propertyType||a.IStyle)&&("accessor"!==this._propertyType||this._valueFunction!==this.getValue||a[this._getter])?!0:!1},getValue:function(a){return"accessor"===this._propertyType?a[this._getter]():"style"===this._propertyType&&a.getStyle?a.getStyle(this._propertyName):"client"===this._propertyType&&a.getClient?a.getClient(this._propertyName):null}}),Ib.PropertyPropagator=function(a,b,c){if(!a)throw"dataBox can not be null";if(!b)throw"propertyName can not be null";this._dataBox=a,this._propertyName=b,this._propertyType=c||"accessor","accessor"===this._propertyType&&(this._getter=Jb.getter(b),this._setter=Jb.setter(b)),this._enable=!1,this._isPropagating=!1},Jb.ext("twaver.PropertyPropagator",Object,{getServa:function(){return this._dataBox},getPropertyType:function(){return this._propertyType},getPropertyName:function(){return this._propertyName},isEnable:function(){return this._enable},setEnable:function(a){this._enable!==a&&(this._enable=a,this._enable?(this._dataBox.addServaChangeListener(this.handleServaChange,this),this._dataBox.addDataPropertyChangeListener(this.handleDataPropertyChange,this),this._dataBox.forEach(function(a){this.propagate(a)},this)):(this._dataBox.removeServaChangeListener(this.handleServaChange,this),this._dataBox.removeDataPropertyChangeListener(this.handleDataPropertyChange,this)))},handleServaChange:function(a){a.data&&this.propagate(a.data)},handleDataPropertyChange:function(a){if(this.isInterestedProperty(a))this.propagate(a.source);else if("parent"===a.property){var b=a.oldValue;b&&this.propagate(b),this.propagate(a.source)}},isInterestedProperty:function(a){return"accessor"===this._propertyType&&this._propertyName===a.property?!0:"style"===this._propertyType&&a.IElement&&"S:"+this._propertyName===a.property?!0:"client"===this._propertyType&&"C:"+this._propertyName===a.property?!0:!1},propagate:function(a){a&&!this._isPropagating&&(this._isPropagating=!0,this.propagateToTop(a),this._isPropagating=!1)},propagateToTop:function(a){for(this.propagateToParent(null,a);a&&a.getParent();)this.propagateToParent(a,a.getParent()),a=a.getParent()},propagateToParent:function(a,b){}}),Ib.AlarmStatePropagator=function(a){Ib.AlarmStatePropagator.superClass.constructor.call(this,a,"alarmState")},Jb.ext("twaver.AlarmStatePropagator",Ib.PropertyPropagator,{handleDataPropertyChange:function(a){"enablePropagation"===a.property?this.propagate(a.source):Ib.AlarmStatePropagator.superClass.handleDataPropertyChange.call(this,a)},propagateToParent:function(a,b){var c=null;b.getChildren().forEach(function(a){var b=a.getAlarmState().getHighestOverallAlarmSeverity();Ib.AlarmSeverity.compare(b,c)>0&&(c=b)}),b.getAlarmState().setPropagateSeverity(c)}}),Ib.AlarmSeverity=function(a,b,c,d,e){this.value=a,this.name=b,this.nickName=c,this.color=d,this.displayName=e},Jb.ext("twaver.AlarmSeverity",Object,{toString:function(){return this.displayName?this.displayName:this.name}}),function(){var a=Ib.AlarmSeverity;a.severities=new md,a._vm={},a._nm={},a._cp=function(a,b){if(a&&b){var c=a.value-b.value;return c>0?1:0>c?-1:0}return a&&!b?1:!a&&b?-1:0},a.forEach=function(b,c){a.severities.forEach(b,c)},a.getSortFunction=function(){return a._cp},a.setSortFunction=function(b){a._cp=b,a.severities.sort(b)},a.add=function(b,c,d,e,f){var g=new a(b,c,d,e,f);return a._vm[b]=g,a._nm[c]=g,a.severities.add(g),a.severities.sort(a._cp),g},a.remove=function(b){var c=a._nm[b];return c&&(delete a._nm[b],delete a._vm[c.value],a.severities.remove(c)),c},a.CRITICAL=a.add(500,"Critical","C","#FF0000"),a.MAJOR=a.add(400,"Major","M","#FFA000"),a.MINOR=a.add(300,"Minor","m","#FFFF00"),a.WARNING=a.add(200,"Warning","W","#00FFFF"),a.INDETERMINATE=a.add(100,"Indeterminate","N","#C800FF"),a.CLEARED=a.add(0,"Cleared","R","#00FF00"),a.isClearedAlarmSeverity=function(a){return a?0===a.value:!1},a.getByName=function(b){return a._nm[b]},a.getByValue=function(b){return a._vm[b]},a.clear=function(){a.severities.clear(),a._vm={},a._nm={}},a.compare=function(b,c){return a._cp(b,c)}}(),Ib.AlarmState=function(a){this._e=a,this._nm={},this._am={},this._ps=null,this._haa=null,this._hna=null,this._hoa=null,this._hta=null,this._hls=!1,this._aac=0,this._nac=0},Jb.ext("twaver.AlarmState",Object,{_ep:!0,_f:function(){this._c1(),this._c2(),this._c3(),this._c4(),this._c5(),this._c6(),this._c7(),this._e.firePropertyChange("alarmState",null,this)},getHighestAcknowledgedAlarmSeverity:function(){return this._haa},getHighestNewAlarmSeverity:function(){return this._hna},getHighestOverallAlarmSeverity:function(){return this._hoa},getHighestNativeAlarmSeverity:function(){return this._hta},hasLessSevereNewAlarms:function(){return this._hls},_c1:function(){var a=null;for(var b in this._am)b=Ib.AlarmSeverity.getByName(b),Ib.AlarmSeverity.isClearedAlarmSeverity(b)||0!==this.getAcknowledgedAlarmCount(b)&&(a=a&&Ib.AlarmSeverity.compare(a,b)>0?a:b);this._haa=a},_c2:function(){var a=null;for(var b in this._nm)b=Ib.AlarmSeverity.getByName(b),Ib.AlarmSeverity.isClearedAlarmSeverity(b)||0!==this.getNewAlarmCount(b)&&(a=a&&Ib.AlarmSeverity.compare(a,b)>0?a:b);this._hna=a},_c3:function(){if(!this._hna)return void(this._hls=!1);for(var a in this._nm)if(a=Ib.AlarmSeverity.getByName(a),!Ib.AlarmSeverity.isClearedAlarmSeverity(a)&&0!==this.getNewAlarmCount(a)&&Ib.AlarmSeverity.compare(this._hna,a)>0)return void(this._hls=!0);this._hls=!1},_c4:function(){var a=this._haa,b=this._hna,c=this._ps;this._hoa=a,Ib.AlarmSeverity.compare(b,this._hoa)>0&&(this._hoa=b),Ib.AlarmSeverity.compare(c,this._hoa)>0&&(this._hoa=c)},_c5:function(){var a=this._haa,b=this._hna;this._hta=a,Ib.AlarmSeverity.compare(b,this._hta)>0&&(this._hta=b)},increaseAcknowledgedAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._am[a.name];null==c&&(c=0),c+=b,this._am[a.name]=c,this._f()}},increaseNewAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._nm[a.name];null==c&&(c=0),c+=b,this._nm[a.name]=c,this._f()}},decreaseAcknowledgedAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._am[a.name];if(null==c&&(c=0),c-=b,0>c)throw"Alarm count can not be negative";this._am[a.name]=c,this._f()}},decreaseNewAlarm:function(a,b){if(null==b&&(b=1),0!==b){var c=this._nm[a.name];if(null==c&&(c=0),c-=b,0>c)throw"Alarm count can not be negative";this._nm[a.name]=c,this._f()}},acknowledgeAlarm:function(a){this.decreaseNewAlarm(a,1),this.increaseAcknowledgedAlarm(a,1)},acknowledgeAllAlarms:function(a){if(a){var b=this.getNewAlarmCount(a);this.decreaseNewAlarm(a,b),this.increaseAcknowledgedAlarm(a,b)}else for(var c in this._nm)this.acknowledgeAllAlarms(Ib.AlarmSeverity.getByName(c))},_c6:function(){this._aac=0;for(var a in this._am)a=Ib.AlarmSeverity.getByName(a),this._aac+=this.getAcknowledgedAlarmCount(a)},getAcknowledgedAlarmCount:function(a){if(a){var b=this._am[a.name];return null==b?0:b}return this._aac},getAlarmCount:function(a){return this.getAcknowledgedAlarmCount(a)+this.getNewAlarmCount(a)},_c7:function(){this._nac=0;for(var a in this._nm)a=Ib.AlarmSeverity.getByName(a),this._nac+=this.getNewAlarmCount(a)},getNewAlarmCount:function(a){if(a){var b=this._nm[a.name];return null==b?0:b}return this._nac},setNewAlarmCount:function(a,b){this._nm[a.name]=b,this._f()},removeAllNewAlarms:function(a){a?delete this._nm[a]:this._nm={},this._f()},setAcknowledgedAlarmCount:function(a,b){this._am[a.name]=b,this._f()},removeAllAcknowledgedAlarms:function(a){a?delete this._am[a.name]:this._am={},this._f()},isEmpty:function(){return null==this._hoa},clear:function(){this._am={},this._nm={},this._f()},getPropagateSeverity:function(){return this._ps},setPropagateSeverity:function(a){if(this._ep||(a=null),this._ps!==a){var b=this._ps;this._ps=a,this._f(),this._e.firePropertyChange("propagateSeverity",b,a)}},isEnablePropagation:function(){return this._ep},setEnablePropagation:function(a){var b=this._ep;this._ep=a,this._e.firePropertyChange("enablePropagation",b,a)&&(a||this.setPropagateSeverity(null))}}),Ib.AlarmBox=function(a){if(!a)throw"elementBox can not be null.";Ib.AlarmBox.superClass.constructor.call(this),this._elementBox=a,this._alarmElementMapping=new Ib.AlarmElementMapping(this,a),this._elementBox.addServaChangeListener(this.handleElementBoxChange,this,!0),this.addServaChangeListener(this.handleAlarmBoxChange,this,!0),this.addDataPropertyChangeListener(this.handleAlarmPropertyChange,this,!0)},Jb.ext("twaver.AlarmBox",Ib.Serva,{__accessor:["removeAlarmWhenElementIsRemoved"],_name:"AlarmBox",_removeAlarmWhenAlarmIsCleared:!1,_removeAlarmWhenElementIsRemoved:!0,getElementBox:function(){return this._elementBox},isRemoveAlarmWhenAlarmIsCleared:function(){return this._removeAlarmWhenAlarmIsCleared},setRemoveAlarmWhenAlarmIsCleared:function(a){var b=this._removeAlarmWhenAlarmIsCleared;this._removeAlarmWhenAlarmIsCleared=a,this.firePropertyChange("removeAlarmWhenAlarmIsCleared",b,a),a&&this.toDatas(function(a){return a.isCleared()}).forEach(this.remove,this)},getAlarmElementMapping:function(){return this._alarmElementMapping},setAlarmElementMapping:function(a){if(!a)throw"alarmElementMapping can not be null";if(this._alarmElementMapping!==a){var b=this._alarmElementMapping;this.getDatas().forEach(this._decreaseAlarmState,this),this._alarmElementMapping=a,this.getDatas().forEach(this._increaseAlarmState,this),this.firePropertyChange("alarmElementMapping",b,a)}},handleElementBoxChange:function(a){"add"===a.kind?this.handleElementAdded(a.data):"remove"===a.kind?(this.handleElementRemoved(a.data),this._removeAlarmWhenElementIsRemoved&&this.removeAlarmsByElement(a.data)):"clear"===a.kind&&(a.datas.forEach(this.handleElementRemoved,this),this._removeAlarmWhenElementIsRemoved&&this.clear())},handleAlarmBoxChange:function(a){"add"===a.kind?this._increaseAlarmState(a.data):"remove"===a.kind?this._decreaseAlarmState(a.data):"clear"===a.kind&&a.datas.forEach(this._decreaseAlarmState,this)},handleAlarmPropertyChange:function(a){var b=a.source;b.isCleared()||("alarmSeverity"===a.property?this.handleAlarmSeverityChange(b,a):"acked"===a.property&&this.handleAckedChange(b,a)),"cleared"===a.property&&(b.isCleared()?(this._decreaseAlarmState(b,!0),this._removeAlarmWhenAlarmIsCleared&&this.remove(b)):this._increaseAlarmState(b,!0))},handleAckedChange:function(a,b){if(a.getAlarmSeverity()){var c=this.getCorrespondingElements(a);if(c)for(var d=0;d<c.size();d++){var e=c.get(d);b.oldValue?e.getAlarmState().decreaseAcknowledgedAlarm(a.getAlarmSeverity()):e.getAlarmState().decreaseNewAlarm(a.getAlarmSeverity()),b.newValue?e.getAlarmState().increaseAcknowledgedAlarm(a.getAlarmSeverity()):e.getAlarmState().increaseNewAlarm(a.getAlarmSeverity())}}},handleAlarmSeverityChange:function(a,b){var c=b.oldValue,d=b.newValue,e=this.getCorrespondingElements(a);if(e)for(var f=0;f<e.size();f++){var g=e.get(f);c&&(a.isAcked()?g.getAlarmState().decreaseAcknowledgedAlarm(c):g.getAlarmState().decreaseNewAlarm(c)),d&&(a.isAcked()?g.getAlarmState().increaseAcknowledgedAlarm(d):g.getAlarmState().increaseNewAlarm(d))}},getCorrespondingAlarms:function(a){return this._alarmElementMapping.getCorrespondingAlarms(a)},getCorrespondingElements:function(a){return this._alarmElementMapping.getCorrespondingElements(a)},handleElementAdded:function(a){var b=this.getCorrespondingAlarms(a);if(b)for(var c=0;c<b.size();c++){var d=b.get(c);if(!d.isCleared()){var e=d.getAlarmSeverity();e&&(d.isAcked()?a.getAlarmState().increaseAcknowledgedAlarm(e):a.getAlarmState().increaseNewAlarm(e))}}},_increaseAlarmState:function(a,b){if(!a.isCleared()||b){var c=a.getAlarmSeverity();if(c){var d=this.getCorrespondingElements(a);if(d)for(var e=0;e<d.size();e++){var f=d.get(e);a.isAcked()?f.getAlarmState().increaseAcknowledgedAlarm(c):f.getAlarmState().increaseNewAlarm(c)}}}},_decreaseAlarmState:function(a,b){if(!a.isCleared()||b){var c=a.getAlarmSeverity();if(c){var d=this.getCorrespondingElements(a);if(d)for(var e=0;e<d.size();e++){var f=d.get(e);a.isAcked()?f.getAlarmState().decreaseAcknowledgedAlarm(c):f.getAlarmState().decreaseNewAlarm(c)}}}},handleElementRemoved:function(a){var b=this.getCorrespondingAlarms(a);b&&b.forEach(function(b){!b.isCleared()&&b.getAlarmSeverity()&&(b.isAcked()?a.getAlarmState().decreaseAcknowledgedAlarm(b.getAlarmSeverity()):a.getAlarmState().decreaseNewAlarm(b.getAlarmSeverity()))})},removeAlarmsByElement:function(a){var b=this.getCorrespondingAlarms(a);b&&b.forEach(this.remove,this)},add:function(a,b){if(!a.IAlarm)throw"Only IAlarm can be added into AlarmBox";this._removeAlarmWhenAlarmIsCleared&&a.isCleared()||Ib.AlarmBox.superClass.add.apply(this,arguments)}}),Ib.AlarmElementMapping=function(a,b){if(!b)throw"ElementBox can not be null";if(!a)throw"AlarmBox can not be null";this._elementBox=b,this._alarmBox=a,this._alarmsFinder=new Ib.QuickFinder(a,"elementId")},Jb.ext("twaver.AlarmElementMapping",Object,{getCorrespondingAlarms:function(a){return this._alarmsFinder.find(a.getId())},getCorrespondingElements:function(a){var b=this._elementBox.getDataById(a.getElementId());return new md(b)},dispose:function(){this._alarmsFinder.dispose(),delete this._elementBox,delete this._alarmBox,delete this._alarmsFinder}}),Ib.AlarmStateStatistics=function(a){Ib.AlarmStateStatistics.superClass.constructor.apply(this,arguments),this.sumNew=0,this.sumAcked=0,this.sumTotal=0,this.severtiyMap={},this.elementMap={},this.setElementBox(a)},Jb.ext("twaver.AlarmStateStatistics",Ib.PropertyChangeDispatcher,{getElementBox:function(){return this._elementBox},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._elementBox!==a){var b=this._elementBox;b&&(b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removeServaChangeListener(this.handleElementBoxChange,this),this.severtiyMap={},this.elementMap={}),this._elementBox=a,this.reset(),a.addDataPropertyChangeListener(this.handleElementPropertyChange,this),a.addServaChangeListener(this.handleElementBoxChange,this),this.firePropertyChange("elementBox",b,a)}},dispose:function(){this._elementBox.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),this._elementBox.removeServaChangeListener(this.handleElementBoxChange,this),delete this._elementBox},handleElementPropertyChange:function(a){"alarmState"===a.property&&(this.increase(a.source),this.fireAlarmStateChange())},handleElementBoxChange:function(a){"add"===a.kind?(this.increase(a.data),this.fireAlarmStateChange()):"remove"===a.kind?(this.decrease(a.data),this.fireAlarmStateChange()):"clear"===a.kind&&(this.severtiyMap={},this.elementMap={},this.fireAlarmStateChange())},fireAlarmStateChange:function(){this.sumAcked=0,this.sumNew=0,this.sumTotal=0,Ib.AlarmSeverity.forEach(function(a){var b=this.getSumInfo(a);this.sumAcked+=b.ackedCount,this.sumNew+=b.newCount,this.sumTotal+=b.totalCount},this),this.firePropertyChange("alarmState",!1,!0)},getNewAlarmCount:function(a){if(!a)return this.sumNew;var b=this.getSumInfo(a);return b.newCount},getAcknowledgedAlarmCount:function(a){if(!a)return this.sumAcked;var b=this.getSumInfo(a);return b.ackedCount},getTotalAlarmCount:function(a){if(!a)return this.sumTotal;var b=this.getSumInfo(a);return b.totalCount},getSumInfo:function(a){var b=this.severtiyMap[a.name];return b||(b={},b.newCount=0,b.ackedCount=0,b.totalCount=0,this.severtiyMap[a.name]=b),b},decrease:function(a){var b=this.elementMap[a.getId()];b&&(delete this.elementMap[a.getId()],Ib.AlarmSeverity.forEach(function(a){var c=b[a.name],d=this.getSumInfo(a);d.newCount=d.newCount-c.newCount,d.ackedCount=d.ackedCount-c.ackedCount,d.totalCount=d.totalCount-c.totalCount},this))},increase:function(a){if(this.decrease(a),!this._filterFunction||this._filterFunction(a)){var b={};this.elementMap[a.getId()]=b,Ib.AlarmSeverity.forEach(function(c){var d={};d.newCount=a.getAlarmState().getNewAlarmCount(c),d.ackedCount=a.getAlarmState().getAcknowledgedAlarmCount(c),d.totalCount=a.getAlarmState().getAlarmCount(c),b[c.name]=d;var e=this.getSumInfo(c);e.newCount=e.newCount+d.newCount,e.ackedCount=e.ackedCount+d.ackedCount,e.totalCount=e.totalCount+d.totalCount},this)}},reset:function(){this.severtiyMap={},this.elementMap={},this._elementBox.forEach(this.increase,this),this.fireAlarmStateChange()},setFilterFunction:function(a){var b=this._filterFunction;this._filterFunction=a,this.reset(),this.firePropertyChange("filterFunction",b,a)},getFilterFunction:function(){return _filterFunction}}),Ib.LayerBox=function(a){Ib.LayerBox.superClass.constructor.call(this),this._elementBox=a,this._defaultLayer=new Ib.Layer(Cd.LAYER_DEFAULT_ID,Cd.LAYER_DEFAULT_NAME),this.add(this._defaultLayer)},Jb.ext("twaver.LayerBox",Ib.Serva,{_name:"LayerBox",getElementBox:function(){return this._elementBox},getDefaultLayer:function(){return this._defaultLayer},add:function(a,b){if(!a.ILayer)throw"Only ILayer can be added into LayerBox";Ib.LayerBox.superClass.add.apply(this,arguments)},removeById:function(a){if(a===this._defaultLayer.getId())throw"Cannot remove default layer";Ib.LayerBox.superClass.removeById.call(this,a)},getLayerByElement:function(a){if(!a)return null;if(a._layerId===Cd.LAYER_DEFAULT_ID)return this._defaultLayer;var b=this.getDataById(a.getLayerId());return b?b:this._defaultLayer},clear:function(){this.toDatas().forEach(function(a){a!=this._defaultLayer&&this.removeById(a.getId())},this)}}),Ib.BundleLinks=function(a,b){this._links=a,this._siblings=b;var c,d,e=Ib.Styles.getStyle("link.bundle.expanded");for(c=0;c<a.size();c++){d=a.get(c);var f=d.getStyle("link.bundle.expanded",!1);if(null!=f){e=f;break}}if(null==e&&(e=!0),Cd.LINK_BUNDLE_AGENT_FUNCTION){var g=Cd.LINK_BUNDLE_AGENT_FUNCTION(a);null==g?g=a.get(0):g!=a.get(0)&&(a.remove(g),a.add(g,0))}for(c=0;c<a.size();c++)a.get(c).setStyle("link.bundle.expanded",e)},Jb.ext("twaver.BundleLinks",Object,{getLinks:function(){return this._links},getSiblings:function(){return this._siblings},forEachSiblingLink:function(a,b){this._siblings.forEach(function(c){c.getLinks().forEach(a,b)})}});var Dd={bitsToNum:function(a){return a.reduce(function(a,b){return 2*a+b},0)},byteToBitArr:function(a){for(var b=[],c=7;c>=0;c--)b.push(!!(a&1<<c));return b},lzwDecode:function(a,b){for(var c,d,e=0,f=function(a){for(var c=0,d=0;a>d;d++)b.charCodeAt(e>>3)&1<<(7&e)&&(c|=1<<d),e++;return c},g=[],h=1<<a,i=h+1,j=a+1,k=[],l=function(){k=[],j=a+1;for(var b=0;h>b;b++)k[b]=[b];k[h]=[],k[i]=null};;)if(d=c,c=f(j),c!==h){if(c===i)break;if(c<k.length)d!==h&&k.push(k[d].concat(k[c][0]));else{if(c!==k.length)throw new Error("Invalid LZW code.");k.push(k[d].concat(k[d][0]))}g.push.apply(g,k[c]),k.length===1<<j&&12>j&&j++}else l();return g}},Ed=function(a){this.data=a,this.len=this.data.length,this.pos=0};Jb.ext(Ed,Object,{readByte:function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return 255&this.data.charCodeAt(this.pos++)},readBytes:function(a){for(var b=[],c=0;a>c;c++)b.push(this.readByte());return b},read:function(a){for(var b="",c=0;a>c;c++)b+=String.fromCharCode(this.readByte());return b},readUnsigned:function(){var a=this.readBytes(2);return(a[1]<<8)+a[0]}});var Fd=function(a){var b,c=a,d=null,e=null,f=null,g=0,h=null,i=null,j=null;this.frames=[],this.size={};var k=this,l=Ob.createElement("canvas");this.loaded=!1;var m=function(){d=null,e=null,h=f,f=null,i=null};this.doParse=function(){Gd(c,t)};var n=function(a){b=a,k.size.width=b.width,k.size.height=b.height},o=function(a){p(),m(),d=a.transparencyGiven?a.transparencyIndex:null,e=a.delayTime,f=a.disposalMethod},p=function(){i&&k.frames.push({data:i.getImageData(0,0,b.width,b.height),delay:e})},q=function(a){i||(i=l.getContext("2d"));var c=k.frames.length,e=a.lctFlag?a.lct:b.gct;c>0&&(3===h?i.putImageData(k.frames[g].data,0,0):g=c-1,2===h&&(j||i.clearRect(j.leftPos,j.topPos,j.width,j.height)));var f=i.getImageData(a.leftPos,a.topPos,a.width,a.height);a.pixels.forEach(function(a,b){a!==d&&(f.data[4*b+0]=e[a][0],f.data[4*b+1]=e[a][1],f.data[4*b+2]=e[a][2],f.data[4*b+3]=255)}),i.putImageData(f,a.leftPos,a.topPos),j=a},r=function(){},s=function(a){return function(b){a(b)}},t={hdr:s(n),gce:s(o),com:s(r),app:{NETSCAPE:s(r)},img:s(q),eof:function(a){p(),k.loaded=!0}}},Gd=function(a,b){b||(b={});var c=function(b){for(var c=[],d=0;b>d;d++)c.push(a.readBytes(3));return c},d=function(){var b,c;c="";do b=a.readByte(),c+=a.read(b);while(0!==b);return c},e=function(){var d={};if(d.sig=a.read(3),d.ver=a.read(3),"GIF"!==d.sig)throw new Error("Not a GIF file.");d.width=a.readUnsigned(),d.height=a.readUnsigned();var e=Dd.byteToBitArr(a.readByte());d.gctFlag=e.shift(),d.colorRes=Dd.bitsToNum(e.splice(0,3)),d.sorted=e.shift(),d.gctSize=Dd.bitsToNum(e.splice(0,3)),
d.bgColor=a.readByte(),d.pixelAspectRatio=a.readByte(),d.gctFlag&&(d.gct=c(1<<d.gctSize+1)),b.hdr&&b.hdr(d)},f=function(c){var e=function(c){var d=(a.readByte(),Dd.byteToBitArr(a.readByte()));c.reserved=d.splice(0,3),c.disposalMethod=Dd.bitsToNum(d.splice(0,3)),c.userInput=d.shift(),c.transparencyGiven=d.shift(),c.delayTime=a.readUnsigned(),c.transparencyIndex=a.readByte(),c.terminator=a.readByte(),b.gce&&b.gce(c)},f=function(a){a.comment=d(),b.com&&b.com(a)},g=function(c){a.readByte();c.ptHeader=a.readBytes(12),c.ptData=d(),b.pte&&b.pte(c)},h=function(c){{var e=function(c){a.readByte();c.unknown=a.readByte(),c.iterations=a.readUnsigned(),c.terminator=a.readByte(),b.app&&b.app.NETSCAPE&&b.app.NETSCAPE(c)},f=function(a){a.appData=d(),b.app&&b.app[a.identifier]&&b.app[a.identifier](a)};a.readByte()}switch(c.identifier=a.read(8),c.authCode=a.read(3),c.identifier){case"NETSCAPE":e(c);break;default:f(c)}},i=function(a){a.data=d(),b.unknown&&b.unknown(a)};switch(c.label=a.readByte(),c.label){case 249:c.extType="gce",e(c);break;case 254:c.extType="com",f(c);break;case 1:c.extType="pte",g(c);break;case 255:c.extType="app",h(c);break;default:c.extType="unknown",i(c)}},g=function(e){var f=function(a,b){for(var c=new Array(a.length),d=a.length/b,e=function(d,e){var f=a.slice(e*b,(e+1)*b);c.splice.apply(c,[d*b,b].concat(f))},f=[0,4,2,1],g=[8,8,4,2],h=0,i=0;4>i;i++)for(var j=f[i];d>j;j+=g[i])e(j,h),h++;return c};e.leftPos=a.readUnsigned(),e.topPos=a.readUnsigned(),e.width=a.readUnsigned(),e.height=a.readUnsigned();var g=Dd.byteToBitArr(a.readByte());e.lctFlag=g.shift(),e.interlaced=g.shift(),e.sorted=g.shift(),e.reserved=g.splice(0,2),e.lctSize=Dd.bitsToNum(g.splice(0,3)),e.lctFlag&&(e.lct=c(1<<e.lctSize+1)),e.lzwMinCodeSize=a.readByte();var h=d();e.pixels=Dd.lzwDecode(e.lzwMinCodeSize,h),e.interlaced&&(e.pixels=f(e.pixels,e.width)),b.img&&b.img(e)},h=function(){var c={};switch(c.sentinel=a.readByte(),String.fromCharCode(c.sentinel)){case"!":c.type="ext",f(c);break;case",":c.type="img",g(c);break;case";":c.type="eof",b.eof&&b.eof(c);break;default:throw new Error("Unknown block: 0x"+c.sentinel.toString(16))}"eof"!==c.type&&setTimeout(h,0)},i=function(){e(),setTimeout(h,0)};i()},Hd=function(a,b,c){var d=Ob.createElement("canvas");return Id(d,b.width,b.height),d.getContext("2d").clearRect(0,0,b.width,b.height),d.getContext("2d").putImageData(a[c].data,0,0),d},Id=function(a,b,c){a.width=b,a.height=c,a.style.width=b+"px",a.style.height=c+"px"};Ib.Data=function(a){if(Ib.Data.superClass.constructor.apply(this,arguments),this._childList=new md,this._childMap={},this._clientMap={},a===b||null===a)this._id=Jb.id();else if("string"==typeof a||"number"==typeof a||"boolean"==typeof a)this._id=a;else{for(var c in a)if("clients"===c)for(var d in a.clients)this._clientMap[d]=a.clients[d];else if("styles"===c)for(var e in a.styles)this._styleMap[e]=a.styles[e];else null!=a[c]&&(this["_"+c]=a[c]);null==this._id&&(this._id=Jb.id())}},Jb.ext("twaver.Data",Ib.PropertyChangeDispatcher,{IData:!0,IClient:!0,__client:1,__new:1,_parent:null,__accessor:["name","name2","icon","toolTip"],_icon:Cd.ICON_DATA,getId:function(){return this._id},getChildren:function(){return this._childList},getChildrenSize:function(){return this._childList.size()},toChildren:function(a,b){return this._childList.toList(a,b)},addChild:function(a,c){return c===b&&(c=this._childList.size()),a&&a!==this?this._childMap[a.getId()]?!1:this.isDescendantOf(a)?!1:(a.getParent()&&a.getParent().removeChild(a),(0>c||c>this._childList.size())&&(c=this._childList.size()),this._childList.add(a,c),this._childMap[a._id]=a,a.setParent(this),this.firePropertyChange("children",null,a),this.onChildAdded(a,c),!0):!1},onChildAdded:function(a,b){},removeChild:function(a){if(!a)return!1;if(!this._childMap[a._id])return!1;var b=this._childList.remove(a);return delete this._childMap[a._id],this.firePropertyChange("children",a,null),a.setParent(null),this.onChildRemoved(a,b),!0},onChildRemoved:function(a,b){},getChildAt:function(a){return this._childList.get(a)},clearChildren:function(){if(0===this._childList.size())return!1;for(var a=this._childList.toArray(),b=a.length,c=0;b>c;c++)this.removeChild(a[c]);return this.onChildrenCleared(a),!0},onChildrenCleared:function(a){},getParent:function(){return this._parent},setParent:function(a){if(!(this._isUpdatingParent||this._parent===a||this===a||a&&a.isDescendantOf(this))){var b=this._parent;this._parent=a,this._isUpdatingParent=!0,b&&b.removeChild(this),a&&a.addChild(this),delete this._isUpdatingParent,this.firePropertyChange("parent",b,a),this.onParentChanged(b,a)}},onParentChanged:function(a,b){},hasChildren:function(){return this._childList.size()>0},isRelatedTo:function(a){return a?this.isDescendantOf(a)||a.isDescendantOf(this):!1},isParentOf:function(a){return a?null!=this._childMap[a._id]:!1},isDescendantOf:function(a){if(!a)return!1;if(!a.hasChildren())return!1;for(var b=this._parent;b;){if(a===b)return!0;b=b.getParent()}return!1},toString:function(){return this.getName()?this.getName():this._id}}),Ib.Alarm=function(a,b,c,d,e){Ib.Alarm.superClass.constructor.call(this,a),this._elementId=b,this._alarmSeverity=c,this._acked=d||!1,this._cleared=e||!1},Jb.ext("twaver.Alarm",Ib.Data,{IAlarm:!0,getElementId:function(){return this._elementId},__accessor:["acked","cleared","alarmSeverity"]}),Ib.Layer=function(a){Ib.Layer.superClass.constructor.call(this,a)},Jb.ext("twaver.Layer",Ib.Data,{ILayer:!0,__accessor:["visible","movable","editable","rotatable"],_visible:!0,_movable:!0,_editable:!0,_rotatable:!0,_name:"Default"}),Ib.Element=function(a){this._styleMap=this._styleMap||{},this._alarmState=new Ib.AlarmState(this),Ib.Element.superClass.constructor.call(this,a)},Jb.ext("twaver.Element",Ib.Data,{IElement:!0,IStyle:!0,__accessor:["layerId"],__bool:["visible"],__style:1,_layerId:Cd.LAYER_DEFAULT_ID,_visible:!0,getAlarmState:function(){return this._alarmState},isAdjustedToBottom:function(){return!1},getElementUIClass:function(){return null},getCanvasUIClass:function(){return null},getVectorUIClass:function(){return null},s:function(a,c){return c===b?this.getStyle(a):(this.setStyle(a,c),this)}}),Ib.Dummy=function(a){Ib.Dummy.superClass.constructor.call(this,a)},Jb.ext("twaver.Dummy",Ib.Element,{IDummy:!0});var Jd=function(a){this._location={x:0,y:0},Jd.superClass.constructor.call(this,a)};Ib.Node=Jd,Jd.IS_INTERESTED_NODE_PROPERTY={location:1,width:1,height:1,expanded:1},Jb.ext("twaver.Node",Ib.Element,{_icon:Cd.ICON_NODE,_image:Cd.IMAGE_NODE,_angle:0,getLoopedLinks:function(){return this._loopedLinks},getLinks:function(){return this._links},getAgentLinks:function(){return this._agentLinks},getFollowers:function(){return this._followers},_addFollower:function(a){this._followers||(this._followers=new md),this._followers.add(a)},_removeFollower:function(a){this._followers.remove(a),this._followers.isEmpty()&&delete this._followers},getFromLinks:function(){return this._fromLinks},getToLinks:function(){return this._toLinks},_addFromLink:function(a){this._allLinks||(this._allLinks=new md),this._fromLinks||(this._fromLinks=new md),this._allLinks.add(a),this._fromLinks.add(a),this._resetLinkSet()},_addToLink:function(a){this._allLinks||(this._allLinks=new md),this._toLinks||(this._toLinks=new md),this._allLinks.add(a),this._toLinks.add(a),this._resetLinkSet()},_removeFromLink:function(a){this._allLinks.remove(a),this._fromLinks.remove(a),0===this._allLinks.size()&&delete this._allLinks,0===this._fromLinks.size()&&delete this._fromLinks,this._resetLinkSet()},_removeToLink:function(a){this._allLinks.remove(a),this._toLinks.remove(a),0===this._allLinks.size()&&delete this._allLinks,0===this._toLinks.size()&&delete this._toLinks,this._resetLinkSet()},_resetLinkSet:function(){if(delete this._loopedLinks,!this._allLinks||0===this._allLinks.size())return void delete this._links;var a;this._allLinks.forEach(function(b){b.isLooped()&&(a||(a={}),a[b._id]||(this._loopedLinks||(this._loopedLinks=new md),this._loopedLinks.add(b),a[b._id]=b))},this),a?(this._links=new md,this._allLinks.forEach(function(b){a[b._id]?a[b._id]!==!1&&(a[b._id]=!1,this._links.add(b)):this._links.add(b)},this)):this._links=this._allLinks},hasAgentLinks:function(){return null!=this._agentLinks&&!this._agentLinks.isEmpty()},getFromAgentLinks:function(){return this._fromAgentLinks},getToAgentLinks:function(){return this._toAgentLinks},_addFromAgentLink:function(a){this._fromAgentLinks||(this._fromAgentLinks=new md),this._allAgentLinks||(this._allAgentLinks=new md),this._fromAgentLinks.add(a),this._allAgentLinks.add(a),this._resetAgentLinkSet()},_addToAgentLink:function(a){this._toAgentLinks||(this._toAgentLinks=new md),this._allAgentLinks||(this._allAgentLinks=new md),this._toAgentLinks.add(a),this._allAgentLinks.add(a),this._resetAgentLinkSet()},_removeFromAgentLink:function(a){this._fromAgentLinks.remove(a),this._allAgentLinks.remove(a),0===this._fromAgentLinks.size()&&delete this._fromAgentLinks,0===this._allAgentLinks.size()&&delete this._allAgentLinks,this._resetAgentLinkSet()},_removeToAgentLink:function(a){this._toAgentLinks.remove(a),this._allAgentLinks.remove(a),0===this._toAgentLinks.size()&&delete this._toAgentLinks,0===this._allAgentLinks.size()&&delete this._allAgentLinks,this._resetAgentLinkSet()},_resetAgentLinkSet:function(){if(delete this._agentLinks,this._allAgentLinks&&0!==this._allAgentLinks.size()){var a={};this._allAgentLinks.forEach(function(b){a[b._id]?this._agentLinks||(this._agentLinks=new md):a[b._id]=b},this),this._agentLinks?this._allAgentLinks.forEach(function(b){a[b._id]&&(this._agentLinks.add(b),delete a[b._id])},this):this._agentLinks=this._allAgentLinks}},getImage:function(){return this._image},setImage:function(a){var b=this._image,c=this.getWidth(),d=this.getHeight();this._image=a,this.firePropertyChange("image",b,a),this.firePropertyChange("width",c,this.getWidth()),this.firePropertyChange("height",d,this.getHeight())},getX:function(){return this._location.x},getY:function(){return this._location.y},setX:function(a){this.setLocation(a,this._location.y)},setY:function(a){this.setLocation(this._location.x,a)},getLocation:function(){return this._location},setLocation:function(a,b){var c;if(c=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],Jb.num(c.x)&&Jb.num(c.y)&&(c.x!==this._location.x||c.y!==this._location.y)){var d=this._location;this._location=c,this.firePropertyChange("location",d,c)}},getCenterLocation:function(){return Cd.CENTER_LOCATION?this._location:{x:this.getX()+this.getWidth()/2,y:this.getY()+this.getHeight()/2}},setCenterLocation:function(a,b){var c;c=2===arguments.length?{x:arguments[0],y:arguments[1]}:Jb.clone(arguments[0]),Jb.num(c.x)&&Jb.num(c.y)&&(Cd.CENTER_LOCATION||(c.x-=this.getWidth()/2,c.y-=this.getHeight()/2),this.setLocation(c))},translate:function(a,b){this.setLocation(this.getX()+a,this.getY()+b)},getWidth:function(){if(Jb.num(this._width)&&this._width>=0)return this._width;if("object"!=typeof this._image){var a=Jb.getImageAsset(this._image);if(a){var b=a.getWidth();return Jb.num(b)&&b>=0?b:(a=a._image,Yc(this,a,a,"w"))}}else if(this._image)return this._image.w;return Cd.NODE_WIDTH},setWidth:function(a){var b=this._width;this._width=a,this.firePropertyChange("width",b,a)},getHeight:function(){if(Jb.num(this._height)&&this._height>=0)return this._height;if("object"!=typeof this._image){var a=Jb.getImageAsset(this._image);if(a){var b=a.getHeight();return Jb.num(b)&&b>=0?b:(a=a._image,Yc(this,a,a,"h"))}}else if(this._image)return this._image.h;return Cd.NODE_HEIGHT},setHeight:function(a){var b=this._height;this._height=a,this.firePropertyChange("height",b,a)},setSize:function(){2===arguments.length?(this.setWidth(arguments[0]),this.setHeight(arguments[1])):(this.setWidth(arguments[0].width),this.setHeight(arguments[0].height))},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getRect:function(){var a=this.getOriginalRect();if(0===this._angle)return a;for(var b=Tb.createMatrix(this._angle*Math.PI/180,a.x+a.width/2,a.y+a.height/2),c=[{x:a.x,y:a.y},{x:a.x+a.width,y:a.y},{x:a.x+a.width,y:a.y+a.height},{x:a.x,y:a.y+a.height}],d=0,e=c.length;e>d;d++)c[d]=b.transform(c[d]);var f=Tb.getRect(c);return f},getOriginalRect:function(){var a=this,b=a.getWidth(),c=a.getHeight();return Cd.CENTER_LOCATION?{x:a._location.x-b/2,y:a._location.y-c/2,width:b,height:c}:{x:a.getX(),y:a.getY(),width:b,height:c}},getAngle:function(){return this._angle},setAngle:function(a){var b=this._angle;this._angle=a%360,this.firePropertyChange("angle",b,this._angle)},onParentChanged:function(a,b){Jd.superClass.onParentChanged.call(this,a,b),this._checkLinkAgent()},_checkLinkAgent:function(){if(Ib._isInitializing){if(this._links)for(var a=this._links.size(),b=0;a>b;b++)this._links.get(b)._checkAgentNode()}else Ib.ElementBox.prototype.startBatch(function(){if(this._links)for(var a=this._links.size(),b=0;a>b;b++)this._links.get(b)._checkAgentNode()},this)},onPropertyChanged:function(a){if(Jd.superClass.onPropertyChanged.call(this,a),this._followers)for(var b=this._followers.size(),c=0;b>c;c++)this._followers.get(c).handleHostPropertyChange(a);this.getParent()instanceof Ld&&Jd.IS_INTERESTED_NODE_PROPERTY[a.property]&&this.getParent().updateLocationFromChildren()},getElementUIClass:function(){return Ib.gl3dview.NodeUI},getCanvasUIClass:function(){return Ib.canvas.NodeUI},getVectorUIClass:function(){return Ib.vector.NodeUI}});var Kd=function(a){Kd.superClass.constructor.call(this,a)};Ib.HTMLNode=Kd,Jb.ext("twaver.HTMLNode",Ib.Node,{getElementUIClass:function(){return Ib.gl3dview.HTMLNodeUI},getCanvasUIClass:function(){return Ib.canvas.HTMLNodeUI},getVectorUIClass:function(){return Ib.vector.HTMLNodeUI}}),Ib.Link=function(a,b,c){Ib.Link.superClass.constructor.call(this,a instanceof Jd?null:a),a instanceof Jd&&(c=b,b=a),this.setFromNode(b),this.setToNode(c)},Ib.Link.IS_INTERESTED_BUNDLE_STYLE={"link.bundle.enable":1,"link.bundle.id":1,"link.bundle.independent":1},Jb.ext("twaver.Link",Ib.Element,{_fromNode:null,_toNode:null,_fromAgent:null,_toAgent:null,_icon:Cd.ICON_LINK,getFromNode:function(){return this._fromNode},getToNode:function(){return this._toNode},getFromAgent:function(){return this._fromAgent},getToAgent:function(){return this._toAgent},setFromNode:function(a){if(this._fromNode!==a){var b=this._fromNode;this._fromNode=a,b&&b._removeFromLink(this),this._fromNode&&this._fromNode._addFromLink(this),this._checkAgentNode(),this.firePropertyChange("fromNode",b,a)}},setToNode:function(a){if(this._toNode!==a){var b=this._toNode;this._toNode=a,b&&b._removeToLink(this),this._toNode&&this._toNode._addToLink(this),this._checkAgentNode(),this.firePropertyChange("toNode",b,a)}},isLooped:function(){return this._fromNode===this._toNode&&null!=this._fromNode&&null!=this._toNode},_checkAgentNode:function(){Ib._isInitializing?Ib._links[this._id]||(Ib._links[this._id]=this):this._checkAgentNodeImpl()},_checkAgentNodeImpl:function(){var a,b,c=vc.figureFromAgent(this),d=this;this._fromAgent!=c&&(a=this._fromAgent,this._fromAgent&&this._fromAgent._removeFromAgentLink(this),this._fromAgent=c,this._fromAgent&&this._fromAgent._addFromAgentLink(this),this.firePropertyChange("fromAgent",a,this._fromAgent),Ib._isInitializing?(a&&this._toAgent&&(b=a._id+":"+this._toAgent._id,Ib._bundleLinks[b]||(Ib._bundleLinks[b]=[a,this._toAgent])),this._fromAgent&&this._toAgent&&(b=this._fromAgent._id+":"+this._toAgent._id,Ib._bundleLinks[b]||(Ib._bundleLinks[b]=[this._fromAgent,this._toAgent]))):(vc.resetBundleLinks(a,d._toAgent),vc.resetBundleLinks(d._fromAgent,d._toAgent)));var e=vc.figureToAgent(this);this._toAgent!=e&&(a=this._toAgent,this._toAgent&&this._toAgent._removeToAgentLink(this),this._toAgent=e,this._toAgent&&this._toAgent._addToAgentLink(this),this.firePropertyChange("toAgent",a,this._toAgent),Ib._isInitializing?(a&&this._fromAgent&&(b=a._id+":"+this._fromAgent._id,Ib._bundleLinks[b]||(Ib._bundleLinks[b]=[a,this._fromAgent])),this._toAgent&&this._fromAgent&&(b=this._toAgent._id+":"+this._fromAgent._id,Ib._bundleLinks[b]||(Ib._bundleLinks[b]=[this._toAgent,this._fromAgent]))):(vc.resetBundleLinks(a,d._fromAgent),vc.resetBundleLinks(d._toAgent,d._fromAgent)))},_setBundleLinks:function(a){this._bundleLinks=a,this.firePropertyChange("bundleLinks",!0,!1)},getBundleLinks:function(){return this._bundleLinks},getBundleCount:function(){return this._bundleLinks?this._bundleLinks.getLinks().size():1},getBundleIndex:function(){return this._bundleLinks?this._bundleLinks.getLinks().indexOf(this):0},reverseBundleExpanded:function(){if(this._bundleLinks&&this._bundleLinks.getLinks().size()>0){var a,b,c=this._bundleLinks.getLinks(),d=!this.getStyle("link.bundle.expanded");for(a=0;a<c.size();a++)b=c.get(a),b.setStyle("link.bundle.expanded",d);var e=this._bundleLinks.getSiblings();for(a=0;a<e.size();a++){var f=e.get(a);if(f!=this._bundleLinks){c=f.getLinks();for(var g=0;g<c.size();g++)b=c.get(g),b.firePropertyChange("bundleLinks",null,f)}}return!0}return!1},isBundleAgent:function(){return null!=this._bundleLinks&&this._bundleLinks.getLinks().size()>1&&this===this._bundleLinks.getLinks().get(0)&&!this.getStyle("link.bundle.expanded")},onStyleChanged:function(a,b,c){Ib.Link.superClass.onStyleChanged.call(this,a,b,c),Ib.Link.IS_INTERESTED_BUNDLE_STYLE[a]&&vc.resetBundleLinks(this._toAgent,this._fromAgent)},getElementUIClass:function(){return Ib.gl3dview.LinkUI},getCanvasUIClass:function(){return Ib.canvas.LinkUI},getVectorUIClass:function(){return Ib.vector.LinkUI},isAdjustedToBottom:function(){return Cd.IS_LINK_ADJUSTED_TO_BOTTOM}}),Ib.HTMLLink=function(a,b,c){Ib.HTMLLink.superClass.constructor.call(this,a,b,c)},Ib.Util.ext("twaver.HTMLLink",Ib.Link,{getElementUIClass:function(){return Ib.gl3dview.HTMLLinkUI},getCanvasUIClass:function(){return Ib.canvas.HTMLLinkUI},getVectorUIClass:function(){return Ib.vector.HTMLLinkUI}}),Ib.Follower=function(a){this._isUpdatingFollower=!1,this._isUpdatingLocation=!1,Ib.Follower.superClass.constructor.call(this,a)},Ib.Follower.IS_INTERESTED_HOST_GRID_PROPERTY={location:1,width:1,height:1,"S:grid.row.count":1,"S:grid.column.count":1,"S:grid.row.percents":1,"S:grid.column.percents":1,"S:grid.border":1,"S:grid.border.left":1,"S:grid.border.right":1,"S:grid.border.top":1,"S:grid.border.bottom":1,"S:grid.padding":1,"S:grid.padding.left":1,"S:grid.padding.right":1,"S:grid.padding.top":1,"S:grid.padding.bottom":1},Ib.Follower.IS_INTERESTED_FOLLOWER_STYLE={"follower.row.index":1,"follower.column.index":1,"follower.row.span":1,"follower.column.span":1,"follower.padding":1,"follower.padding.left":1,"follower.padding.right":1,"follower.padding.top":1,"follower.padding.bottom":1},Jb.ext("twaver.Follower",Jd,{_host:null,getHost:function(){return this._host},setHost:function(a){if(this!==a&&this._host!==a){var b=this._host;b&&b._removeFollower(this),this._host=a,this._host&&this._host._addFollower(this),this.firePropertyChange("host",b,a),this.onHostChanged(b,a)}},onStyleChanged:function(a,b,c){Ib.Follower.superClass.onStyleChanged.call(this,a,b,c),Ib.Follower.IS_INTERESTED_FOLLOWER_STYLE[a]&&this.updateFollower(null)},setLocation:function(){this._isUpdatingLocation||(this._isUpdatingLocation=!0,Ib.Follower.superClass.setLocation.apply(this,arguments),this._isUpdatingLocation=!1)},onHostChanged:function(a,b){this.updateFollower(null)},handleHostPropertyChange:function(a){this.updateFollower(a)},updateFollower:function(a){this._isUpdatingFollower||Jb.isDeserializing||(this._isUpdatingFollower=!0,this.updateFollowerImpl(a),this._isUpdatingFollower=!1)},updateFollowerImpl:function(a){var b=this.getHost();if(b instanceof Ib.Grid){if(!a||Ib.Follower.IS_INTERESTED_HOST_GRID_PROPERTY[a.property]){var c=this.getStyle("follower.row.index"),d=this.getStyle("follower.column.index"),e=b.getCellRect(c,d);if(!e)return;var f=this.getStyle("follower.row.span"),g=this.getStyle("follower.column.span");if(1!=f||1!=g){var h=b.getCellRect(c+f-1,d+g-1);h&&(e=Tb.unionRect(e,h))}if(Tb.addPadding(e,this,"follower.padding"),this.getStyle("follower.fill.cell"))this.setLocation(e.x,e.y),this.setWidth(e.width),this.setHeight(e.height);else{var i=this.getStyle("follower.cell.position");e=Vb.get(i,e,this.getRect()),this.setLocation(e.x,e.y)}}}else if(null!=a&&"location"===a.property){var j=a.oldValue,k=a.newValue,l=this.getLocation();this.setLocation(l.x+(k.x-j.x),l.y+(k.y-j.y))}},isHostOn:function(a){if(!a)return!1;for(var b={},c=this._host;c&&c!=this&&!b[c.getId()];){if(c===a)return!0;b[c.getId()]=c,c=c instanceof Ib.Follower?c.getHost():null}return!1},isLoopedHostOn:function(a){return this.isHostOn(a)&&a.isHostOn(this)}});var Ld=function(a){this._isUpdatingLocationFromChildren=!1,this._isAdjusting=!1,this._expanded=!1,Ld.superClass.constructor.call(this,a)};Ib.Group=Ld,Jb.ext("twaver.Group",Ib.Follower,{_image:Cd.IMAGE_GROUP,_icon:Cd.ICON_GROUP,isAdjustedToBottom:function(){return this.isExpanded()&&vc.hasAgentLinks(this)},onChildAdded:function(a,b){Ld.superClass.onChildAdded.apply(this,arguments),this.updateLocationFromChildren()},onChildRemoved:function(a,b){Ld.superClass.onChildRemoved.apply(this,arguments),this.updateLocationFromChildren()},updateLocationFromChildren:function(){if(!this._isAdjusting&&!Jb.isDeserializing){for(var a,b,c=0,d=this.getChildrenSize();d>c;c++)b=this.getChildAt(c),b instanceof Jd&&(a=Tb.unionRect(a,this.getChildRect(b)));a&&(this._isUpdatingLocationFromChildren=!0,this.setLocation(a.x+a.width/2-this.getWidth()/2,a.y+a.height/2-this.getHeight()/2),this._isUpdatingLocationFromChildren=!1)}},getChildRect:function(a){var b;return a instanceof Jd&&(a instanceof Ld?(a.isExpanded()&&a.getChildren().forEach(function(c){b=Tb.unionRect(b,a.getChildRect(c))}),b||(b=a.getRect())):b=a.getRect()),b},setLocation:function(){if(!this._isAdjusting){var a;if(a=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],!Jb.isDeserializing&&!this._isUpdatingLocationFromChildren){this._isAdjusting=!0;var b=a.x-this.getX(),c=a.y-this.getY();vc.moveElements(this.getChildren(),b,c),this._isAdjusting=!1}Ld.superClass.setLocation.call(this,a)}},reverseExpanded:function(){this.setExpanded(!this.isExpanded())},isExpanded:function(){return this._expanded},setExpanded:function(a){if(this._expanded!==a){var b=this._expanded;this._expanded=a,this.firePropertyChange("expanded",b,this._expanded),this._checkLinkAgent()}},_checkLinkAgent:function(){Ld.superClass._checkLinkAgent.call(this);for(var a=this.getChildrenSize(),b=0;a>b;b++){var c=this.getChildAt(b);c instanceof Jd&&c._checkLinkAgent()}},getElementUIClass:function(){return Ib.gl3dview.GroupUI},getCanvasUIClass:function(){return Ib.canvas.GroupUI},getVectorUIClass:function(){return Ib.vector.GroupUI}}),Ib.SubGl3dview=function(a){Ib.SubGl3dview.superClass.constructor.call(this,a)},Jb.ext("twaver.SubGl3dview",Ib.Follower,{ISubGl3dview:!0,_image:Cd.IMAGE_SUBNETWORK,_icon:Cd.ICON_SUBNETWORK,_checkLinkAgent:function(){Ib.SubGl3dview.superClass._checkLinkAgent.call(this);for(var a=this.getChildrenSize(),b=0;a>b;b++){var c=this.getChildAt(b);c instanceof Jd&&c._checkLinkAgent()}}}),Ib.Grid=function(a){Ib.Grid.superClass.constructor.call(this,a)},Jb.ext("twaver.Grid",Ib.Follower,{_icon:Cd.ICON_GRID,_image:null,getCellObject:function(a,b){1===arguments.length&&(b=a.y,a=a.x);for(var c=this.getStyle("grid.row.count"),d=this.getStyle("grid.column.count"),e=0;c>e;e++)for(var f=0;d>f;f++){var g=this.getCellRect(e,f);if(Tb.containsPoint(g,a,b))return{rowIndex:e,columnIndex:f,rect:g}}return null},getCellRect:function(a,b){var c=this.getStyle("grid.row.count"),d=this.getStyle("grid.column.count");if(0>=c||0>=d)return null;if(0>a||a>=c)return null;if(0>b||b>=d)return null;var e=this.getRect();Tb.addPadding(e,this,"grid.border");var f=0,g=this.getStyle("grid.row.percents"),h=this.getStyle("grid.column.percents");if(g&&g.length===c){var i=0;for(f=0;a>f;f++)i+=e.height*g[f];e.y+=i,e.height=e.height*g[a]}else e.height=e.height/c,e.y+=e.height*a;if(h&&h.length===d){var j=0;for(f=0;b>f;f++)j+=e.width*h[f];e.x+=j,e.width=e.width*h[b]}else e.width=e.width/d,e.x+=e.width*b;return Tb.addPadding(e,this,"grid.padding"),e},getElementUIClass:function(){return Ib.gl3dview.GridUI},getCanvasUIClass:function(){return Ib.canvas.GridUI},getVectorUIClass:function(){return Ib.vector.GridUI}}),Ib.ShapeNode=function(a){this._isUpdatingShapeNode=!1,this._points=new md,Ib.ShapeNode.superClass.constructor.call(this,a)},Jb.ext("twaver.ShapeNode",Ib.Follower,{_icon:Cd.ICON_SHAPENODE,__accessor:["segments"],getElementUIClass:function(){return Ib.gl3dview.ShapeNodeUI},getCanvasUIClass:function(){return Ib.canvas.ShapeNodeUI},getVectorUIClass:function(){return Ib.vector.ShapeNodeUI},getPoints:function(){return this._points},setPoints:function(a){a||(a=new md),this._points=a,this.firePointsChange()},getSegments:function(){return this._segments},setSegments:function(a){a||(a=new md),this._segments=a,this._reCalculateLineLength(),this.firePointsChange()},addPoint:function(a,b){this._points.add(a,b),this.firePointsChange()},setPoint:function(a,b){this._points.set(a,b),this.firePointsChange()},removePoint:function(a){this._points.remove(a),this.firePointsChange()},removeAt:function(a){this._points.removeAt(a),this.firePointsChange()},setWidth:function(a){if(1>a&&(a=1),!this._isUpdatingShapeNode&&!Jb.isDeserializing){this._isUpdatingShapeNode=!0;for(var b=0;b<this._points.size();b++){var c=this._points.get(b);c.x=(c.x-this.getX())*a/this.getWidth()+this.getX()}this.firePointsChange(),this._isUpdatingShapeNode=!1}Ib.ShapeNode.superClass.setWidth.apply(this,arguments)},setHeight:function(a){if(1>a&&(a=1),!this._isUpdatingShapeNode&&!Jb.isDeserializing){this._isUpdatingShapeNode=!0;for(var b=0;b<this._points.size();b++){var c=this._points.get(b);c.y=(c.y-this.getY())*a/this.getHeight()+this.getY()}this.firePointsChange(),this._isUpdatingShapeNode=!1}Ib.ShapeNode.superClass.setHeight.apply(this,arguments)},setLocation:function(){if(!this._isUpdatingShapeNode&&!Jb.isDeserializing){var a;if(a=2===arguments.length?{x:arguments[0],y:arguments[1]}:arguments[0],!Jb.num(a.x)||!Jb.num(a.y))return;var b=a.x-this.getX(),c=a.y-this.getY();if(0===b&&0===c)return;this._isUpdatingShapeNode=!0;for(var d=0;d<this._points.size();d++){var e=this._points.get(d);e.x+=b,e.y+=c}this.firePointsChange(),this._isUpdatingShapeNode=!1}Ib.ShapeNode.superClass.setLocation.apply(this,arguments)},firePointsChange:function(){if(!this._isUpdatingShapeNode&&!Jb.isDeserializing){var a=Tb.getRect(this._points);a?(this._isUpdatingShapeNode=!0,Cd.CENTER_LOCATION?this.setLocation(a.x+a.width/2,a.y+a.height/2):this.setLocation(a.x,a.y),this.setWidth(a.width),this.setHeight(a.height),this._isUpdatingShapeNode=!1):(this._isUpdatingShapeNode=!0,this.setWidth(0),this.setHeight(0),this._isUpdatingShapeNode=!1)}this._reCalculateLineLength(),this.firePropertyChange("points",null,this._points)},_reCalculateLineLength:function(){this._lineLength=null!=this._points&&this._points.size()>0?Tb.calculateLineLength(this._points,this._segments):0},getLineLength:function(){return this._lineLength}}),Ib.Bus=function(a){this._styleMap={},this._styleMap["vector.fill"]=!1,this._styleMap["shapenode.closed"]=!1,Ib.Bus.superClass.constructor.call(this,a)},Jb.ext("twaver.Bus",Ib.ShapeNode,{_icon:Cd.ICON_BUS,firePointsChange:function(){var a=this._points.size();if(!Jb.isDeserializing&&a>=2)for(var b=this._points.get(0),c=1;a>c;c++){var d=this._points.get(c);Math.abs(d.x-b.x)>Math.abs(d.y-b.y)?d.y=b.y:d.x=b.x,b=d}Ib.Bus.superClass.firePointsChange.apply(this,arguments)}}),Ib.ShapeLink=function(a,b,c){this._points=new md,this._styleMap={},this._styleMap["link.bundle.enable"]=!1,Ib.ShapeLink.superClass.constructor.call(this,a,b,c)},Jb.ext("twaver.ShapeLink",Ib.Link,{_icon:Cd.ICON_SHAPELINK,getElementUIClass:function(){return Ib.gl3dview.ShapeLinkUI},getCanvasUIClass:function(){return Ib.canvas.ShapeLinkUI},getVectorUIClass:function(){return Ib.vector.ShapeLinkUI},getPoints:function(){return this._points},setPoints:function(a){a||(a=new md),this._points=a,this.firePointsChange()},addPoint:function(a,b){this._points.add(a,b),this.firePointsChange()},setPoint:function(a,b){this._points.set(a,b),this.firePointsChange()},removePoint:function(a){this._points.remove(a),this.firePointsChange()},removeAt:function(a){this._points.removeAt(a),this.firePointsChange()},firePointsChange:function(){this.firePropertyChange("points",null,this._points)}}),Ib.ShapeSubGl3dview=function(a){Ib.ShapeSubGl3dview.superClass.constructor.call(this,a)},Jb.ext("twaver.ShapeSubGl3dview",Ib.ShapeNode,{ISubGl3dview:!0,_icon:Cd.ICON_SHAPESUBNETWORK,_checkLinkAgent:function(){Ib.ShapeSubGl3dview.superClass._checkLinkAgent.call(this);for(var a=this.getChildrenSize(),b=0;a>b;b++){var c=this.getChildAt(b);c instanceof Jd&&c._checkLinkAgent()}}}),Ib.LinkSubGl3dview=function(){Ib.LinkSubGl3dview.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.LinkSubGl3dview",Ib.Link,{ISubGl3dview:!0,_icon:Cd.ICON_LINKSUBNETWORK}),Ib.ShapeLinkSubGl3dview=function(){Ib.ShapeLinkSubGl3dview.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.ShapeLinkSubGl3dview",Ib.ShapeLink,{ISubGl3dview:!0,_icon:Cd.ICON_LINKSUBNETWORK}),Ib.RotatableNode=function(a){Ib.RotatableNode.superClass.constructor.call(this,a)},Jb.ext("twaver.RotatableNode",Ib.Follower,{getWidth:function(){return 0==this._angle?this._getOrignalWidth():this._getRotateRect().width},setWidth:function(a){},getHeight:function(){return 0==this._angle?this._getOrignalHeight():this._getRotateRect().height},setHeight:function(a){},getElementUIClass:function(){return Ib.gl3dview.RotatableNodeUI},getCanvasUIClass:function(){return Ib.canvas.RotatableNodeUI},getVectorUIClass:function(){return Ib.vector.RotatableNodeUI},_getRotateRect:function(){for(var a=this._getOrignalWidth(),b=this._getOrignalHeight(),c=Tb.createMatrix(this._angle*Math.PI/180,a/2,b/2),d=[{x:0,y:0},{x:a,y:0},{x:a,y:b},{x:0,y:b}],e=0,f=d.length;f>e;e++)d[e]=c.transform(d[e]);return Tb.getRect(d)},_getOrignalWidth:function(){return Ib.RotatableNode.superClass.getWidth.call(this)},_getOrignalHeight:function(){return Ib.RotatableNode.superClass.getHeight.call(this)}}),Ib.controls.ControlBase=function(){Ib.controls.ControlBase.superClass.constructor.apply(this,arguments),this._pools=new md},Jb.ext("twaver.controls.ControlBase",Ib.PropertyChangeDispatcher,{addPool:function(a){this._pools.contains(a)||this._pools.add(a)},removePool:function(a){this._pools.remove(a)},adjustBounds:function(a){var b=this._view.style;b.position="absolute",b.left=a.x+"px",b.top=a.y+"px",b.width=a.width+"px",b.height=a.height+"px",this.invalidate&&this.invalidate()},getView:function(){return this._view},invalidate:function(a){this._invalidate||(this._invalidate=!0,Jb.callLater(this.validate,this,null,a))},validate:function(){this._invalidate&&(this._invalidate=!1,0===this._view.offsetWidth&&0===this._view.offsetHeight&&null!==this._reinvalidateCount?(this._reinvalidateCount===b&&(this._reinvalidateCount=100),this._reinvalidateCount>0?this._reinvalidateCount--:this._reinvalidateCount=null,this.invalidate()):this.validateImpl())},validateImpl:function(){}}),Ib.controls.ViewBase=function(){Ib.controls.ViewBase.superClass.constructor.apply(this,arguments),this._interactionDispatcher=new Ib.EventDispatcher,this._viewDispatcher=new Ib.EventDispatcher},Jb.ext("twaver.controls.ViewBase",Ib.controls.ControlBase,{__bool:["focusOnClick"],_focusOnClick:Cd.FOCUS_ON_CLICK,getSelectionContainer:function(){return this._selectionContainer?this._selectionContainer:this._box.getSelectionContainer()},isShareSelectionContainer:function(){return null==this._selectionContainer},setShareSelectionContainer:function(a){var b=null==this._selectionContainer;b!==a&&(a?(this._box.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this._selectionContainer.removeSelectionChangeListener(this.handleSelectionChange,this),this._selectionContainer.dispose(),this._selectionContainer=null):(this._box.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this),
this._selectionContainer=new Ib.SelectionContainer(this._box),this._selectionContainer.addSelectionChangeListener(this.handleSelectionChange,this)),this.onShareSelectionContainerChanged(),this.firePropertyChange("shareSelectionContainer",b,a))},removeSelection:function(){if(0===this.getSelectionContainer().size())return null;var a=this.getSelectionContainer().toSelection();return a.forEach(function(a){this._box.remove(a)},this),a},selectAll:function(){var a=new md;return this._box.forEach(function(b){this.isVisible(b)&&a.add(b)},this),this.getSelectionContainer().setSelection(a),a},isSelected:function(a){return this.getSelectionContainer().contains(a)},isSelectable:function(a){return this.getSelectionContainer().isSelectable(a)},getLabel:function(a){return a.getName()},getToolTip:function(a){return a.getToolTip()},getIcon:function(a){return a.getIcon()},getSelectColor:function(a){return Cd.SELECT_COLOR},addViewListener:function(a,b,c){this._viewDispatcher.add(a,b,c)},removeViewListener:function(a,b){this._viewDispatcher.remove(a,b)},fireViewEvent:function(a){this._viewDispatcher.fire(a)},addInteractionListener:function(a,b,c){this._interactionDispatcher.add(a,b,c)},removeInteractionListener:function(a,b){this._interactionDispatcher.remove(a,b)},fireInteractionEvent:function(a){this._interactionDispatcher.fire(a)},invalidate:function(a){this._invalidate||(this._invalidate=!0,this.fireViewEvent({kind:"invalidate"}),Jb.callLater(this.validate,this,null,a))},validate:function(){this._invalidate&&(this._invalidate=!1,Mb||0!==this._view.offsetWidth||0!==this._view.offsetHeight||null===this._reinvalidateCount?(this._isValidating=!0,this.fireViewEvent({kind:"validateStart"}),this.validateImpl(),this.fireViewEvent({kind:"validateEnd"}),delete this._isValidating):(this._reinvalidateCount===b&&(this._reinvalidateCount=100),this._reinvalidateCount>0?this._reinvalidateCount--:this._reinvalidateCount=null,this.invalidate()))}}),Ib.controls.View=function(){Ib.controls.View.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.controls.View",Ib.controls.ViewBase,{_zoom:1,_maxZoom:Cd.ZOOM_MAX,_minZoom:Cd.ZOOM_MIN,getRootDiv:function(){return this._rootDiv},isValidEvent:function(a){return Wb.isValidEvent(this._view,a)},getAlarmFillColor:function(a){if(a.IElement){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b)return b.color}return null},getInnerColor:function(a){if(a.IElement){var b=a.getAlarmState().getHighestNativeAlarmSeverity();return b?b.color:a.getStyle("inner.color")}return null},getOuterColor:function(a){if(a.IElement){var b=a.getAlarmState().getPropagateSeverity();return b?b.color:a.getStyle("outer.color")}return null},zoomOverview:function(a){var b=Math.min(this._view.clientWidth/this._viewRect.width,this._view.clientHeight/this._viewRect.height);this.setZoom(b,a)},getLogicalPoint:function(a){return Wb.getLogicalPoint(this._view,a,this.getZoom(),this._rootDiv)},centerByLogicalPoint:function(a,b,c){c&&Ib.animate.AnimateManager.endAnimate();var d=this._view.scrollWidth-this._view.clientWidth,e=this._view.scrollHeight-this._view.clientHeight,f=(a-this._view.clientWidth/this._zoom/2)*this._zoom,g=(b-this._view.clientHeight/this._zoom/2)*this._zoom;0>f&&(f=0),0>g&&(g=0),f>d&&(f=d),g>e&&(g=e),c?Ib.animate.AnimateManager.start(new Ib.animate.AnimateScrollPosition(this._view,f,g)):(this._view.scrollLeft=f,this._view.scrollTop=g)},panByOffset:function(a,b){a*=this.getZoom(),b*=this.getZoom();var c=this._view.scrollLeft+a,d=this._view.scrollTop+b,e=this._view.scrollWidth-this._view.clientWidth,f=this._view.scrollHeight-this._view.clientHeight;0>c&&(c=0),c>e&&(c=e),0>d&&(d=0),d>f&&(d=f);var g={x:(c-this._view.scrollLeft)/this.getZoom(),y:(d-this._view.scrollTop)/this.getZoom()};return this._view.scrollLeft=c,this._view.scrollTop=d,g},getMaxZoom:function(){return this._maxZoom},setMaxZoom:function(a){if(!(0>a)){var b=this._maxZoom;this._maxZoom=a,this.firePropertyChange("maxZoom",b,a),this.getZoom()>a&&this.setZoom(a)}},getMinZoom:function(){return this._minZoom},setMinZoom:function(a){if(!(0>a)){var b=this._minZoom;this._minZoom=a,this.firePropertyChange("minZoom",b,a),this.getZoom()<a&&this.setZoom(a,!1)}},getZoom:function(){return this._zoom},onZoomChanged:function(a,b){},zoomIn:function(a){this.setZoom(this._zoom*Cd.ZOOM_INCREMENT,a)},zoomOut:function(a){this.setZoom(this._zoom/Cd.ZOOM_INCREMENT,a)},zoomReset:function(a){this.setZoom(1,a)},checkZoom:function(a){return a<this._minZoom&&(a=this._minZoom),a>this._maxZoom&&(a=this._maxZoom),a},setZoom:function(a,b){if(Jb.num(a)&&!(0>=a)&&(a=this.checkZoom(a),a!==this._zoom))if(null==b&&(b=Cd.ZOOM_ANIMATE),b)Ib.animate.AnimateManager.start(new Ib.animate.AnimateZoom(this,a));else{var c=(this._view.scrollLeft+this._view.clientWidth/2)/this._zoom,d=(this._view.scrollTop+this._view.clientHeight/2)/this._zoom,e=this._zoom;this._zoom=a,Wb.setZoom(this._rootDiv,a),this.firePropertyChange("zoom",e,a),this.onZoomChanged(e,a),this.centerByLogicalPoint(c,d,!1)}},setTouchZoom:function(a){this.setZoom(a,!1)}}),function(){var a=function(a,b,c,d){var e=new Pb;e.src=d,Ib.Util.registerImage(a,e,b,c)};a("subgl3dview_image",64,46,"data:image/png;base64,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"),a("bus_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAINJREFUeNqkU0EOgCAMo2Y/1P8Y/6NvnBADwTnGzHYiGetKW8DMKVJLChbVAwCNCrrzp5/Zg/4MaH0JMBOEh08o6OtxtgvXvkFuV/vFBeGEm0WZo8GgF+QlIkI2OrZq5WLAFjuy4DvVWXHl2VodyElMjkxAJNFm4EjmFGAqLKLf+RZgAKkFNRwzv7gHAAAAAElFTkSuQmCC"),a("data_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAMZJREFUeNqkU8ENwjAM9KEwWwaAKVA3iMQDtRtUTAEDdLZWMkkhIUljU4n7RInP9p3dgoiYBAzDgHAyfykA1rtzbr2bmpDDk5uBvu+ROO98pvs4FqRL10nCogokBS3UBaXCZg9JQ7JQY5qmZoK1trCQCuQJnoS9CsQZHKsNcOyWvS1ehdGqz8xyZ0BXEHG+PTdvj+uJkFsASsusdN5sQSKHGWgWfDxY1GcQfEIYIn4p+HuN+SqXRtL8+ZAOinwm5V+P8ZcAAwC0T1T5kpEqewAAAABJRU5ErkJggg=="),a("databox_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJpJREFUeNpi/P//PwMjI+N/BiIBUD0jMp8FpDm4cQ2DvYEiw8EL9/FqBqkBqUc3BGT7/0kbz/6HsXHhS/eewtWBXA7CYAMOX75PlCEgA9ANYYQaADbJVleRAShJ0Csw7+T5G2MaQCpgQReAuQAWqPhokAuYGCgEowZQwwBQuiYn/mGAEZaeYTkSlA6IBeCUCDMA2RBSsjZAgAEAOyp6/CYHWkwAAAAASUVORK5CYII="),a("grid_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAFdJREFUeNpi/P//PwMlgImBQsACIhgZGUl2BtDljCguAHkFhIMb1xBkU9ULjCATQV4A2UAsWFsfAvcCzEn/YQBoEEE2VD1Y76gXhpcXyM0LjJRmZ4AAAwCoyOJjz29PsAAAAABJRU5ErkJggg=="),a("group_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOFJREFUeNqUUwsOwjAILa67i2fwEMbEnUej55mJO4Rn8DBtglAh6YfOSdJkBfregwEgottiHiAlQuZjh68TQRJzI5L07nSbC//zOrUAmkxAJXBP2VgxRjpDK818z06gZIwrfSACF0iVVZrLiab7ownOl7PTV0QESsRgWqoHt80oD0fpy/BVhuZfsOpkC8LYxAkBw4YedOdDhuRny1UyZEPE334NvbZ6kBYeJGFPKFgp4HsUAqtI9u1AYipJgfQ+GjtQlPvPMkGlBHrLdFjeBeHruE+hYAxSo6C3jb4zyh8BBgBVL19PZ27iaAAAAABJRU5ErkJggg=="),a("group_image",32,29,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAdCAYAAADLnm6HAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABHNJREFUeNqsV1ts21QY/uy4zc1ZnZY2bdbSLMlKxUWkaBJMgJY9gARIax/2NokVofLARWjiBYRY2QMdCGlI440H1ok3btsQ0wAxNdvKpnYdyyYK7UZHVK1L2rRZLo3j2InDOaZD60psp+WXrDjO93/nO7/PfwkDAwu0Nh8jH30wZwc6/f43X9jVJ5gBn/zueJozgaNkUXLtMwLyLt4XDG4Vtj+/B8lMQRf7QLsb079PCpzJnaVnEsmIEeiZgD/Mu5yYT4uYiWd1sW1NTlCsWQGmzC00gOd5lFQVkqLoYiuViobVBNzf3BRaCfUaUyuV2AomXI1sNrmkRUeUZBRlBXJJRVFRdQUoZVXDclvbvUeImn6j3VmAqpjg5ra0xcL2nDwdwW1JQeP2HJLLki7frVQOo+OXwNnttv5fp65vKPSvvLhHmBgf77fV10XqWBaLZPGEgYC0KIFiOYfdBoY8OH72D8QS6ZoX3x1+CFarFZSnxS1gk9OBeUJ+00BAimAolnM6nQDDEDVAHVOpWQBD/Ow2GyhPoyDHWKjYkr+GVrv+GWBmE6BYIsChRYCz0Kt2AWR92GxWUJ7TFy7GWltb9l368ZteM77lcukE53A4tC91VAC7jggwVIANd3h+OHM+Qlj2ktvQv9U0EIAkSZibm7vbNUpcIxxPQsfQV2BhwDHrE2C320F5qPnaPCMkdVel9EdDQ8iLeex/5+27H4dYljnGnRo5B1EUMT1fwI2lUs0CHs9JOD9xGeNjY9i7u9dXkKTovZgvv/j8H+y2njX+3FxiHmKhgHiGhCir1CwgKxawsLgEynP06xO0aO2sxV+rhAopm9migrRUuwCJVDMS8nXXEE2ALMtIF2UskVJaqxWIgIqqrl8ATUGFkNDaLKu174RGjzYWykO9A17P+6pa2WEqhVnmDOfmnUgmk+gN2vBsZ33NAng1DxspIpTH1+H1Pdrz2OCHn34GpaQfFYe1Dm+9+nKY62jzpIcG3xU20gukXAZtzU0Rkoo+mo6/TMZxI6E/Dzz9sFdLXc7jad6pSIW+jQho2OSKjl2djOyiAwmdB8jrLMj6Ka3emQd+Gh2jeUvTp7/aTGBgwyv+cJNm5HLx2plQSmX9AkYuiuXqOUuorKoj1RZ/7fU34PcHMLj/PSwv5/4LMsgy7EtKuTz887kLyMoq7CERi/miroD5TB4Xr/wGrsPT8omqqlV3PjAwgIYGAd9/+xVmrledG46QjhiZjs0iSYtSehk3M6KugAUigGK5rqA/rAc89MEBOJy81qq7u4LVJyYL27eYSkV50hkXxCLmDCKQIhiK5do3e3VL59TUNdrZ0N3dddTgLMQ89zX5XKQtP+m14kGB1QVv4VVMrIwCRn9M6PkAGctN1fjnwk9ddjc2hcxgb6eWov/rWE7tVGS0ZyWjfEYRoxlkVoBAIhE2gYst5vKDpVJ51QR96PBhxONxfHzw4Oo+wFl2mBFAJ1W6+IgR0OGwD2/zda4Z32/99ScpTiU80fPIvT/1/y3AAMOmtJl1Hv9IAAAAAElFTkSuQmCC"),a("link_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAHVJREFUeNqkkwEOgCAIRaEr6nlqdR49I4XTzcqUn39jE5xP1C+LCPkjCl0Kq2NC5fYgRXlMSCw0K6Xozhqaol3ckj+QVwGFNIsI5HPCCunSLZDhGUcQ0033IOb3riE1CLJty/bTVubUBqDyc+Pm01oY8NQpwAAbUwhLBQIWcAAAAABJRU5ErkJggg=="),a("linksubgl3dview_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAU5JREFUeNqUUi1Tw0AQ3cukEY0AwdlDM8XRD41ARAAi/RHoCmQ7/QNofkTQFQh8W9kOOtgiQIBImTnuXbs3udAvduZms5t9b/fdrUiHGW2z0cOdLsdJ71GU46yfUrgL/PWx8HLxsUTOI3EE98mp9ZdXie0K8HgydYXtVtN6znHsTQAwdy2DOcY/TMFytkqogqskLIf6qQhYL7q/PI8cOIoiiuO69bvIRf3o5M/YANVqIZ03GjSbz2m5/KGiKDxgp90irbUINzEz2BSQEMKSwJiEwfgONmlFR4AAhg2yV0talWNfAbfJN4s7KHcCCcBPgy7WhobdM7q9uXbd3TPyhvEOwL4/30kpRVJKwrYySZ7nWABlzpsthM49R5lzYUhAruERr/P7CdZNPJJVakUiuOgAw9jSXOyUX8f4ZkCHGzQvAGIw4v9M4E0CMEh/BRgAwM37IYxGnbkAAAAASUVORK5CYII="),a("node_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAGBJREFUeNpiZGBg+M9AJvj//z8jC5RBsmZGRkYwzQITCGlaS7TmNXXBcDYTA4Vg1IDBYAAjJB2Rl5DgKRGWqshyATm2o3uBgcwMBbacBZdmZJfh8CJIASMLodxGCAAEGACTAB0gDBYjygAAAABJRU5ErkJggg=="),a("node_image",30,32,"data:image/png;base64,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"),a("shapelink_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAIJJREFUeNqkUwsOgCAIxeYN5Ty1Og+ekUarzRwQ5tsYDpTPExIzgwY86uWgtSTwIAF6KTvxg/sMliwwCy27mEVr2Xu7+TjaWm4JqxvKpW/iWowQprX2i8RXhS0xXv+WL0xiKIAVxKssa/0hEMuPiB4epNFxnh7lZG1jdCPdABGcAgwAc06H0rgwLSIAAAAASUVORK5CYII="),a("shapenode_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAI9JREFUeNq0UtsNgDAILI0jdZN2Ho3O027SnRA+MNb0QTWS8EPuLncAIKL5UvY5CEdC7h7pjrEtEABgqwucRCBFk7aAfo9uZJtwmXhQCLDyLJlrkSxaMuGgu8QZ8hVhYD8LVgZx9fMO1H9QKXbm+EJvBYwsuSYyFaEmUvyBUkQWCYUDfg5NV8/49xW6dQowAIJydCoPajIHAAAAAElFTkSuQmCC"),a("shapesubgl3dview_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATBJREFUeNpiDG5cw4ALbO/L+I/M9yyawYjMX1MXzMCCT/PXD69RxLgFREFiKIbADSjzlAfTjq6eYFtBmk+dPgNXaGZqAqZhYjA+igtAmmG2ImuG8UFyIFfAvIPTC+ia0Q2BeYehLpiRCeZfkO37d2/HqRmX4Yxc/CJwZ9+6fYeBEPjw4QOYNjczZfj//z8j3AuMjIjAvXnrNoomdTVVFDkonxEjEIEmgg1C1oAuhw5YQKEZGhHzH9kVbcuPoiiqirSGy5UUF8FtBwFwIK5esYQRaIMfyE/Y/A0yEGbopk2b/FACEeQ0mO1Ati+UvQndFciuAVkG5W5GMQDqV1+QAci2oxuAFC5+4MCBGQIzAEKBBbFimBxILc7MhOQiPzTxTcixwYhsOxLwRWJvxicHEGAAkPKxzyGuYWgAAAAASUVORK5CYII="),a("subgl3dview_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAOJJREFUeNqkUjsOwjAMzavSBQYY4FDM7SGYOUARHICZQ5SBiUPBAAMLIJk8aFASkoDgSVFlu/68Z6NatCqF3Woqrj2ZreHabVMpnUs+H/eerz8c0+cV0amuTK6XG69bDEWsa5hM0KafU/DZeJRCmBwWsXRUUwEU0Y5tRFLfgHRMARYDeoPRSyy383Zee0nsgO5rcROBzo19FUlOoYG0Bp/0IAW7y4LHQT5GB/UL4F6ie3mX0yFLoTQUTByQxE8lQ51wMRHx1Chd4FtkReQUj3VFktj97ZSDNYkK9h6L/03hLsAAjRx4oMVjqkMAAAAASUVORK5CYII="),a=function(a,b,c,d){Ib.Util.registerImage(a,d,b,c)},a("expand_icon",16,18,"data:image/gif;base64,R0lGODlhEAASAIcAADFKY0L/QpSlvZylvZytxqW11qm92r3GxrnK5MbGxsbW69jh8efv9+vz/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAAAEALAAAAAAQABIAAAhfAAMIHEiwoMGDCBMqXMjQ4AICEAcMECDgwEECDjJmbMAAwEWNDjgi8GgQ40YGCwyQLDjAAYCXL1UeFBAS5QIFBVYSFMBxwU0EOWcyUIDAQIGjOgcegMnUYsOnUKMiDAgAOw=="),a("collapse_icon",16,18,"data:image/gif;base64,R0lGODlhEAASAIcAADFKY0L/QpSlvZylvZytxqW11qm92r3GxrXI48bGxsbS59Te8efv9+vz/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAAAEALAAAAAAQABIAAAhhAAMIHEiwoMGDCBMqXMjQ4AICEAcMECDgwEECDjJmbMAAwEWNADgq8GgQY0YADBYYIFlwgAMAMGGuPCjAAUcACxQUYElQAMcFABQg2EmTgVADBZLyHHggplOLDaNKnYowIAA7"),a("close_icon",11,11,"data:image/gif;base64,R0lGODlhCwALAIcAAHd3d319fUD/QIODg4iIiI6Ojq6urri4uNnZ2eHh4eTk5Ofn5/Dw8PT09Pj4+Pn5+fz8/P39/f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAMAAAIALAAAAAALAAsAAAhdAAUIOECw4AGBAyUoXCjh4AEJDBA4mIiAQcMDERAUKOBgI4IIBCE0IECSZAMIBB8wYDCg5coHBBkkCECTZgIGMQ0AAKBgpwGcBxgsMLCgKFGcA1cqXXlQoMGCAgMCADs="),a("sort_desc",9,5,"data:image/gif;base64,R0lGODlhCQAFAJECAImJiezs7P///wAAACH5BAEAAAIALAAAAAAJAAUAAAIMDI4QYrnC0INxUnYLADs="),a("sort_asc",9,5,"data:image/gif;base64,R0lGODlhCQAFAJECAImJiezs7P///wAAACH5BAEAAAIALAAAAAAJAAUAAAIMlAWnwIrcDJwi2HsLADs="),a("submenu_enable_icon",8,8,"data:image/png;base64,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"),a("submenu_disable_icon",8,8,"data:image/png;base64,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"),a("checkbox_selected_icon",16,16,"data:image/png;base64,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"),
a("checkbox_unselected_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAiUlEQVR42qXM3QYFIRiF4d3dJpIhI5FKJCOSSHe7f9gn4ztZo3Wwzt6HvTbHfhdCeD8Nvw27Ad57OI4xUsA5BwMpJQpYa2Eg50wBYwwMlFIocJ4nDFzXRQGtNQzUWilwHAcMtNYooJSCgd47BaSUMDDGoIAQAgbmnBTgnMPAWosCcP3fDdjZNvABvRhVEQglsV8AAAAASUVORK5CYII="),a("radiobutton_selected_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAXFJREFUeNrUUz9rwkAUv0syBVxMm01L2lIdilOg4BcQ7eKcIV/AqZAxo1/B2a/QoSSTH6AQCoFMJUSig5C0EiPEv8G+Z604eJNTHxz37vf73Y977+7obrcjlwRHLoyLDYTThWmav6AgKDA9wrg6UF8wvO12O8RFt9s9bwACwvP8U6lUajWbzbYsy/eIR1Hk27b9GgSBlef5O7OEzWZzC5ufNU17gc01gEQcmCOGHGqYJaxWq1qj0WhzHFfwfZ84jrPHVVUliqIUkPM87wOg4KzBcrm8liTpbr1ek8FgQNI03eOz2Yzouk6QQw3zBFmWUewDxnQ6JUmSHHsDRz9qmD0A8ns8HgcortfrRxxzxJBDDfMEi8XC7ff7b4Zh3FSr1UKlUtnjlFI0mCOHGqZBHMd+GIbWZDIROp1OCxqH74HA9Q17vZ7luq4liqJ/uoee/oVyufxX/wPctwqpfKAieB9OsVj8xMVoNDpv8D8/048AAwDskrF8QGeJUgAAAABJRU5ErkJggg=="),a("radiobutton_unselected_icon",16,16,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAATVJREFUeNrUU71qhEAQ9q8S0mhip3C5kCpcFcgjiJfmal/BKr2lr2DtK1wR9BkCaYRUQTzUQtDE5sB/MTOJAQs3jVUGhp2Z75vPnV2XHseRWmMMtdJWC3DzxDTNnyLHbWC5A7+coA/wt77vT5hYlrUsAASKZdkHWZb3mqYdJEm6wXqWZYHneccwDN1hGF6II3Rddw3Nj7quP0HzDko8OsZYQww5RIGmaXaqqh4YhrnA3cwda4ghh3gGdV1fiaK4bdt28cAQQw5RoCxLGr/2lyGHOAKAn0mShDAnteSIIYcoUFWV7zjOM5DPuJPfxik+I4Yc4gh5ngdRFLlpmnKGYew3YFiH6zvZtu36vu/yPB/Me+j5W1AU5XstiuIW7vseQmmCMvg/XgVBeMckjuNlgf/5mL4EGAAhHbltcqEYDQAAAABJRU5ErkJggg==")}(),Rb.__tree=function(a,b){a._rootVisible=!0,a._initTree=function(a){this._rootData=null,this._expandMap={},this._levelMap={}},a.validateContainer=function(){this._rowDatas.clear(),this._levelMap={},this._dataRowMap={},this._currentLevel=0,this._rootData?this._rootVisible?this.isVisible(this._rootData)&&this._buildData(this._rootData):this._buildChildren(this._rootData):this._buildChildren(),delete this._currentLevel},a._buildData=function(a){this._dataRowMap[a.getId()]=this._rowDatas.size(),this._rowDatas.add(a),this._levelMap[a.getId()]=this._currentLevel,this.isExpanded(a)&&(this._currentLevel++,this._buildChildren(a),this._currentLevel--)},a._buildChildren=function(a){var b=a?a.getChildren():this._box.getRoots(),c=this.getCurrentSortFunction();c&&this.isChildrenSortable(a)?b.toList(this.isVisible,this).sort(c).forEach(function(a){this._buildData(a)},this):b.forEach(function(a){this.isVisible(a)&&this._buildData(a)},this)},a.getLevel=function(a){return this._levelMap[a.getId()]},a.getToggleImage=function(a){return a.getChildrenSize()>0?this.isExpanded(a)?this._expandIcon:this._collapseIcon:null},a.isCheckable=function(a){return this.isCheckMode()},a.isCheckMode=function(){return 1===Rb.__tree._checkMap[this._checkMode]},a.isChildrenSortable=function(a){return!0},a.handleServaChange=function(a){"remove"===a.kind?delete this._expandMap[a.data.getId()]:"clear"===a.kind&&(this._expandMap={}),this.invalidateContainer()},a.isExpanded=function(a){return 1===this._expandMap[a.getId()]},a.expand=function(a){if(!this.isExpanded(a)){for(var b=a.getParent();null!=b&&b!==this._rootData;)this._expandMap[b.getId()]=1,b=b.getParent();this._expandMap[a.getId()]=1,this.invalidateContainer()}},a.collapse=function(a){this.isExpanded(a)&&(delete this._expandMap[a.getId()],this.invalidateContainer())},a.expandAll=function(){this._box.forEach(function(a){this._expandMap[a.getId()]=1},this),this.invalidateContainer()},a.collapseAll=function(){this._expandMap={},this.invalidateContainer()},a._handleClick=function(a){if(this.isFocusOnClick()&&Ib.Util.setFocus(this._view),!this._isValidating){var b;if(a.target._expandData)b=a.target._expandData,this.isExpanded(b)?(this.collapse(b),this.fireInteractionEvent({kind:"collapse",data:b})):(this.expand(b),this.fireInteractionEvent({kind:"expand",data:b}));else if(a.target._selectData||a.target.parentNode._selectData){if(this._handlePressSelection(a.target._selectData||a.target.parentNode._selectData,a),this.isCheckMode()){var c=this.getRowIndexAt(a);c>=0&&this.__handleClick(a)}}else this._treeColumn?(b=this.getDataAt(a),b&&(this.isCheckMode()?a.target._checkData||this.__handleClick(a):this._handlePressSelection(b,a))):this.isCheckMode()&&!a.target._checkData&&this.__handleClick(a);if(this._currentEditor&&!this._isCommitting&&(this._isCommitting=!0,this.commitEditValue(this._currentEditor._editInfo,this._currentEditor)),this.updateCurrentEditor){var d=this;setTimeout(function(){d.updateCurrentEditor(a)},0)}}},a.__handleClick=function(a){var b=this.getDataAt(a),c=this.getRowIndexByData(b);if(this._focusedRow!==c){var d=this._rowDatas.get(this._focusedRow);this._focusedRow=c,d&&this.invalidateData(d),this.invalidateData(b)}},a.handleChange=function(a){if(!(this._isCommitting||this._isCanceling||this._isValidating)){var b=a.target._checkData;if(b){var c,d=this.isSelected(b),e=this.getSelectionContainer();if("default"===this._checkMode)d?e.removeSelection(b):e.appendSelection(b);else if("children"===this._checkMode)c=new md(b),c.addAll(b.getChildren());else if("descendant"===this._checkMode)c=new md,Jb.fillDescendant(b,c);else if("descendantAncestor"===this._checkMode&&(c=new md,Jb.fillDescendant(b,c),!d))for(var f=b.getParent();f;)c.add(f),f=f.getParent();d?e.removeSelection(c):e.appendSelection(c)}a.target._editInfo&&this.commitEditValue&&(this._isCommitting=!0,this.commitEditValue(a.target._editInfo,a.target))}},a.onLabelRendered=function(a,b,c,d,e,f){},a._renderTree=function(a,b,c,d){var e=this._levelMap[b.getId()],f=this.getToggleImage(b),g=this.getLineType(),h=this._indent,i=this.__spanPool.get();i.style.width=f?this._indent*e+"px":this._indent*(e+1)+"px",i.style.display="inline-block",i.style.position="relative",i.style.verticalAlign="top",i.style.margin="0px 1px 0px 1px",i.style.width=(e+1)*h+"px",a.appendChild(i);var j=b,k=j.getParent(),l=0;if("dotted"===g||"solid"===g){if(null==k){var m=this.getIcon(b);this._addLine(i,b,m,!0)}for(;null!==k;){var n=k.getChildren(),o=j===n.get(n.size()-1),m=this.getIcon(j);j.setClient("isLast",o),0==l&&this._addLine(i,b,m,o),l++,j=k,k=k.getParent()}}if(f){var p=this.__imagePool.get();p.setAttribute("src",Jb.getImageSrc(f)),p.style.verticalAlign="middle",p._expandData=b,p.style.position="absolute",p.style.right="0px",p.style.top=this.getRowHeight()/2-p.height/2+"px",i.appendChild(p)}var q=this.isCheckable(b),r="disabled"===this.getUncheckableStyle();if(q||r){var s=this._addCheckBox(a,b,d);s.disabled=!q}var m=this.getIcon(b);if(m){var t=this.isCheckMode()||this._treeColumn?null:b;this._addIcon(a,b,m,t)}var u=this.getLabel(b);u&&(i=this.__textPool.get(),i.style.whiteSpace="nowrap",i.style.verticalAlign="middle",i.style.padding="1px 2px 1px 2px",Jb.setText(i,u,this._treeColumn?this._treeColumn.isInnerText():this._innerText),this.isCheckMode()||this._treeColumn?this._focusedRow===c&&(i.style.backgroundColor=this.getSelectColor(b)):(i._selectData=b,i.style.backgroundColor=d?this.getSelectColor(b):""),this.onLabelRendered(i,b,u,c,e,d),a.appendChild(i))}},Rb.__tree._checkMap={"default":1,children:1,descendant:1,descendantAncestor:1},Ib.Column=function(a){Ib.Column.superClass.constructor.call(this,a)},Jb.ext("twaver.Column",Ib.Data,{IColumn:!0,__property:1,__accessor:["width","horizontalAlign","valueType","propertyType","propertyName","editable","visible","sortable","resizable","movable","sortDirection","sortFunction","enumInfo"],__bool:["innerText"],_innerText:Cd.COLUMN_INNER_TEXT,_width:Cd.COLUMN_WIDTH,_horizontalAlign:Cd.COLUMN_HORIZONTAL_ALIGN,_propertyName:null,_propertyType:Cd.COLUMN_PROPERTY_TYPE,_valueType:Cd.COLUMN_VALUE_TYPE,_editable:Cd.COLUMN_EDITABLE,_sortable:Cd.COLUMN_SORTABLE,_visible:Cd.COLUMN_VISIBLE,_resizable:Cd.COLUMN_RESIZABLE,_movable:Cd.COLUMN_MOVABLE,_sortDirection:"asc",_sortFunction:Cd.SORT_FUNCTION,_enumInfo:null,renderCell:Cd.COLUMN_RENDER_CELL,renderHeader:Cd.COLUMN_RENDER_HEADER,setParent:function(a){throw"parent not supported"}}),Ib.ColumnBox=function(a){Ib.ColumnBox.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.ColumnBox",Ib.Serva,{_name:"ColumnBox",add:function(a,b){if(!a.IColumn)throw"Only IColumn can be added into ColumnBox";Ib.ColumnBox.superClass.add.apply(this,arguments)}}),Ib.Property=function(a){Ib.Property.superClass.constructor.call(this,a)},Jb.ext("twaver.Property",Ib.Data,{IProperty:!0,__property:1,__accessor:["horizontalAlign","valueType","editable","propertyType","propertyName","categoryName","enumInfo"],__bool:["innerText"],_innerText:Cd.PROPERTY_INNER_TEXT,_horizontalAlign:Cd.PROPERTY_HORIZONTAL_ALIGN,_propertyName:null,_propertyType:Cd.PROPERTY_PROPERTY_TYPE,_valueType:Cd.PROPERTY_VALUE_TYPE,_editable:Cd.PROPERTY_EDITABLE,_categoryName:Cd.PROPERTY_CATEGORY_NAME,_enumInfo:null,renderName:Cd.PROPERTY_RENDER_NAME,renderValue:Cd.PROPERTY_RENDER_VALUE,isVisible:null,renderEditor:Cd.PROPERTY_RENDER_EDITOR,setParent:function(a){throw"parent not supported"},setPropertyName:function(a){var b=this._propertyName;this._propertyName=a,this.firePropertyChange("propertyName",b,a)},setPropertyType:function(a){var b=this._propertyType;this._propertyType=a,this.firePropertyChange("propertyType",b,a)}}),Ib.PropertyBox=function(a){Ib.PropertyBox.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.PropertyBox",Ib.Serva,{_name:"PropertyBox",add:function(a,b){if(!a.IProperty)throw"Only IProperty can be added into PropertyBox";Ib.PropertyBox.superClass.add.apply(this,arguments)}}),Ib.Tab=function(a){Ib.Tab.superClass.constructor.call(this,a)},Jb.ext("twaver.Tab",Ib.Data,{ITab:!0,__accessor:["view","width","closable","resizable","movable","disabled","visible"],_icon:null,_width:Cd.TAB_WIDTH,_closable:Cd.TAB_CLOSABLE,_resizable:Cd.TAB_RESIZABLE,_movable:Cd.TAB_MOVABLE,_disabled:Cd.TAB_DISABLED,_visible:Cd.TAB_VISIBLE,setParent:function(a){throw"parent not supported"}}),Ib.TabBox=function(a){Ib.TabBox.superClass.constructor.apply(this,arguments),this.getSelectionContainer().setSelectionMode("singleSelection")},Jb.ext("twaver.TabBox",Ib.Serva,{_name:"TabBox",add:function(a,b){if(!a.ITab)throw"Only ITab can be added into TabBox";Ib.TabBox.superClass.add.apply(this,arguments)}}),Ib.controls.ListBase=function(a){Ib.controls.ListBase.superClass.constructor.apply(this,arguments),this._invalidate=!1,this._invalidateContainer=!1,this._invalidateDisplay=!1,this._invalidateDatas=null,this._rowDatas=new md,this._startRowIndex=0,this._endRowIndex=0,this._renderMap={},this._dataRowMap={},this.__divPool=new Ib.Pool("div",20),this.__imagePool=new Ib.Pool("img",20),this.__canvasPool=new Ib.Pool("canvas",20),this.__spanPool=new Ib.Pool("span",20),this.__textPool=new Ib.Pool("span",20),this.__checkBoxPool=new Ib.Pool("input",20),this.__linePool=new Ib.Pool("canvas",20),this._pools.add(this.__divPool),this._pools.add(this.__linePool),this._pools.add(this.__imagePool),this._pools.add(this.__canvasPool),this._pools.add(this.__spanPool),this._pools.add(this.__textPool),this._pools.add(this.__checkBoxPool),this._view=Wb.createView("auto",!0),this._rootDiv=Wb.createDiv(),this._dataDiv=Wb.createDiv(),this._dataDiv.style.width="1px",this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._dataDiv),this.setServa(a?a:new Ib.Serva);var b=this;b.handleChange&&b._view.addEventListener("change",function(a){b.handleChange(a)},!1);var c;c=Qb.isMSToucheable?Ib.controls.ListBaseMSTouchInteraction:Qb.isTouchable?Ib.controls.ListBaseTouchInteraction:Ib.controls.ListBaseInteraction,c&&new c(this)},Jb.ext("twaver.controls.ListBase",Ib.controls.View,{__bool:["innerText"],_innerText:Cd.LISTBASE_INNER_TEXT,getDataDiv:function(){return this._dataDiv},getStartRowIndex:function(){return this._startRowIndex},getEndRowIndex:function(){return this._endRowIndex},getRowDatas:function(){return this._rowDatas},getRowIndexByData:function(a){return this._dataRowMap[a.getId()]},getRowIndexById:function(a){return this._dataRowMap[a]},getRowSize:function(){return this._rowDatas.size()},getServa:function(){return this._box},setServa:function(a){if(!a)throw"Serva can not be null";if(this._box!==a){var b=this._box;b&&(b.removeServaChangeListener(this.handleServaChange,this),b.removeDataPropertyChangeListener(this.handlePropertyChange,this),b.removeHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionContainer||b.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addServaChangeListener(this.handleServaChange,this),this._box.addDataPropertyChangeListener(this.handlePropertyChange,this),this._box.addHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionContainer?this._selectionContainer._setServa(a):this._box.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this.invalidateContainer(),this.firePropertyChange("dataBox",b,this._box)}},onPropertyChanged:function(a){"zoom"===a.property?this.invalidate():this.invalidateContainer()},invalidateContainer:function(){this._invalidateContainer||(this._invalidateContainer=!0,this._invalidateDisplay=!0,this._invalidateDatas=null,this.invalidate())},invalidateDisplay:function(){this._invalidateDisplay||(this._invalidateDisplay=!0,this._invalidateDatas=null,this.invalidate())},invalidateData:function(a){this._invalidateDisplay||(this._invalidateDatas||(this._invalidateDatas={}),this._invalidateDatas[a.getId()]=a,this.invalidate())},validateImpl:function(){var a=this._view.scrollLeft,b=this._view.scrollTop;this._invalidateContainer&&(this._invalidateContainer=!1,this.validateContainer()),this._invalidateDisplay&&(this._invalidateDisplay=!1,this._renderMap={},Wb.release(this._dataDiv),this._dataDiv.style.height=this.getRowSize()*this._rowHeight+"px");var c;if(this._invalidateDatas){for(c in this._invalidateDatas){var d=this._renderMap[c];d&&(Wb.release(d),this._dataDiv.removeChild(d),delete this._renderMap[c])}this._invalidateDatas=null}var e=this._view.scrollTop/this._zoom,f=this._view.clientHeight/this._zoom;this._startRowIndex=Math.floor(e/this._rowHeight)-2,this._endRowIndex=Math.ceil((e+f)/this._rowHeight)+2,this._startRowIndex<0&&(this._startRowIndex=0),this._endRowIndex>this._rowDatas.size()&&(this._endRowIndex=this._rowDatas.size());for(var g=this._rowHeight-this._rowLineWidth-2+"px",h=this._rowLineWidth+"px",i=this._startRowIndex;i<this._endRowIndex;i++){var j=this._rowDatas.get(i);c=j.getId();var k=this._renderMap[c];if(!k){k=this.__divPool.get();var l=k.style;l.position="absolute",l.whiteSpace="nowrap",l.lineHeight=g,l.top=i*this._rowHeight+"px",l.borderStyle="solid",l.borderWidth="0px",l.borderBottomWidth=h,l.borderBottomColor=this._rowLineColor,l.opacity=j.getStyle?j.getStyle("whole.alpha"):1,this._dataDiv.appendChild(k),this._renderMap[c]=k;var m=this.isSelected(j);this.renderData(k,j,i,m),this.onDataRendered(k,j,i,m)}}Jb.keys(this._renderMap).forEach(function(a){var b=this.getRowIndexById(a);if(b<this._startRowIndex||b>=this._endRowIndex){var c=this._renderMap[a];Wb.release(c),this._dataDiv.removeChild(c),delete this._renderMap[a]}},this),this._pools.forEach(function(a){a.clear()}),this._view.scrollLeft!==a&&(this._view.scrollLeft=a),this._view.scrollTop!==b&&(this._view.scrollTop=b),this.adjustRowSize(),this.onValidated()},adjustRowSize:function(){var a,b,c=this._rowHeight-this._rowLineWidth+"px",d=Math.floor((this._view.scrollLeft+this._view.clientWidth)/this._zoom)+"px";for(a in this._renderMap)b=this._renderMap[a],b.style.height=c,b.style.width=d},onValidated:function(){},onDataRendered:function(a,b,c,d){},_addCheckBox:function(a,b,c){var d=this.__checkBoxPool.get();return d.keepDefault=!0,d.type="checkbox",d.style.margin="0px 2px",d.style.verticalAlign="middle",d._checkData=b,d.checked=c,d.disabled=!1,a.appendChild(d),d},_addIcon:function(a,b,c,d){var e,f=Jb.getImageAsset(c),g=this.getInnerColor(b),h=this.getOuterColor(b),i=this.getAlarmFillColor(b);if(f&&f.getImage()){var j=f.getWidth(),k=f.getHeight();e=this.__canvasPool.get(),e.style.verticalAlign="middle",e.setAttribute("width",j),e.setAttribute("height",k);var l=e.getContext("2d");l.clearRect(0,0,j,k);var m={x:0,y:0,width:j,height:k};Nc(l,c,g,m,b,this),h&&(l.lineWidth=2,l.strokeStyle=h,l.beginPath(),l.rect(0,0,j,k),l.closePath(),l.stroke()),i&&(l.fillStyle=Xb.createRadialGradient(l,i,"white",1,k-9,8,8,.75,.25),l.beginPath(),l.arc(5,k-5,4,0,2*Math.PI,!0),l.closePath(),l.fill())}else e=this.__imagePool.get(),e.style.verticalAlign="middle",e.setAttribute("src",Jb.getImageSrc(c));e.style.margin="0px 1px 0px 1px",e._selectData=d,a.appendChild(e)},_addLine:function(a,b,c,d){{var e,f,g=this.__linePool.get(),h=Jb.getImageAsset(c),i=this.getToggleImage(b),j=this._levelMap[b.getId()],k=this._indent,l=k,m=k,n=0;this.isCheckable(b),"disabled"===this.getUncheckableStyle()}n=2,h&&(l=h.getWidth(),m=h.getHeight()),d?(e=(j+n-1)*k+l,f=this.getRowHeight()):(e=(j+n-1)*k+l,f=this.getRowHeight()),a.style.width=(j+n-1)*k+"px",a.style.height=f+"px";{var o=this.getLineType(),p=this.getLineColor(),q=this.getLineAlpha(),r=this.getLineThickness(),s=this.getLineDash();Jb.getImageSrc(i)}g.style.verticalAlign="top",g.style.margin="0px 0px 0px 0px",g.style.zIndex=-1,g.setAttribute("width",e),g.setAttribute("height",f);var t=g.getContext("2d");t.lineWidth=r,t.strokeStyle=p,t.globalAlpha=q,"dotted"===o&&t.setLineDash(s);var u=2*(j+n);if(d){var v=b,w=v.getParent();t.clearRect(0,0,e,f);null===w&&0!==b.getChildrenSize()&&this.isExpanded(b)&&(t.moveTo((j+n+1)*e/u,f/2+m/2),t.lineTo((j+n+1)*e/u,f),t.stroke());for(var x=2*j-1;x>=1;x-=2){if(v.getClient("isLast")){if(v=w,w=v.getParent(),(x+1)/2!=j)continue}else v=w,w=v.getParent();x==2*j-1?(t.moveTo((x+n)*e/u,0),t.lineTo((x+n)*e/u,f/2),t.stroke(),t.moveTo((x+n)*e/u,f/2),t.lineTo((x+n+1)*e/u,f/2),t.stroke(),0!==b.getChildrenSize()&&this.isExpanded(b)&&(t.moveTo((x+n+2)*e/u,f/2+m/2),t.lineTo((x+n+2)*e/u,f),t.stroke())):(t.moveTo((x+n)*e/u,0),t.lineTo((x+n)*e/u,f),t.stroke())}}else{var v=b,w=v.getParent();t.clearRect(0,0,e,f);for(var x=2*j-1;x>=1;x-=2){if(v.getClient("isLast")){if(v=w,w=v.getParent(),(x+1)/2!=j)continue}else v=w,w=v.getParent();t.moveTo((x+n)*e/u,0),t.lineTo((x+n)*e/u,f),t.stroke(),x==2*j-1&&(t.moveTo((x+n)*e/u,f/2),t.lineTo((x+n+1)*e/u,f/2),t.stroke(),0!==b.getChildrenSize()&&this.isExpanded(b)&&(t.moveTo((x+n+2)*e/u,f/2+m/2),t.lineTo((x+n+2)*e/u,f),t.stroke()))}}return a.appendChild(g),g},isVisible:function(a){return this._box.contains(a)?this._visibleFunction?this._visibleFunction(a):!0:!1},handleServaChange:function(a){this.invalidateContainer()},handlePropertyChange:function(a){"parent"===a.property?this.invalidateContainer():this.invalidateData(a.source)},handleHierarchyChange:function(a){this.invalidateContainer()},handleSelectionChange:function(a){a.datas.forEach(function(a){this.invalidateData(a)},this),this.onSelectionChanged(a)},getRowIndexAt:function(a){var b=this.getLogicalPoint(a);if(!b)return-1;var c=parseInt(b.y/this._rowHeight);return c>=0&&c<this._rowDatas.size()?c:-1},getDataAt:function(a){var b=this.getRowIndexAt(a);return b>=0?this._rowDatas.get(b):null},getCurrentSortFunction:function(){return this._sortFunction},validateContainer:function(){this._rowDatas.clear(),this._dataRowMap={},this._buildChildren(this._box.getRoots()),this._rowDatas=this._rowDatas.toList(this.isVisible,this);var a=this.getCurrentSortFunction();a&&this._rowDatas.sort(a);for(var b=this._rowDatas.size(),c=0;b>c;c++)this._dataRowMap[this._rowDatas.get(c).getId()]=c},_buildChildren:function(a){a.forEach(function(a){this._rowDatas.add(a),this._buildChildren(a.getChildren())},this)},_handlePressSelection:function(a,b){var c=this.getSelectionContainer();if(Jb.isCtrlDown(b))c.contains(a)?c.removeSelection(a):c.appendSelection(a);else if(b.shiftKey&&c.getLastData()){var d=c.getLastData(),e=this.getRowIndexByData(d),f=this.getRowIndexByData(a),g=new md;for(g.add(this.getRowDatas().get(e));e!==f;)e+=f>e?1:-1,g.add(this.getRowDatas().get(e));c.setSelection(g)}else 1===c.size()&&c.contains(a)||c.setSelection(a);this.fireInteractionEvent({kind:2===b.detail?"doubleClick":"click",data:a})},_handleClick:function(a){this.isFocusOnClick()&&Ib.Util.setFocus(this._view);var b=this.getDataAt(a);if(b){if(this.isCheckMode()&&!a.target._checkData){var c=this.getRowIndexByData(b);if(this._focusedRow!==c){var d=this._rowDatas.get(this._focusedRow);this._focusedRow=c,d&&this.invalidateData(d),this.invalidateData(b)}}this.isCheckMode()||this._handlePressSelection(b,a)}if(this._currentEditor&&this.commitEditValue(this._currentEditor._editInfo,this._currentEditor),this.updateCurrentEditor){var e=this;setTimeout(function(){e.updateCurrentEditor(a)},0)}},handleChange:function(a){if(!this._isCanceling&&!this._isValidating){var b=a.target._checkData;if(b){var c=this.isSelected(b),d=this.getSelectionContainer();c?d.removeSelection(b):d.appendSelection(b)}a.target._editInfo&&this.commitEditValue&&this.commitEditValue(a.target._editInfo,a.target)}},scrollToData:function(a){if(a){var b=this.getRowIndexById(a.getId());if(!(0>b)){var c=b*this._rowHeight*this._zoom,d=c+this._rowHeight*this._zoom,e=this._view.scrollTop;this._view.scrollTop>c&&(e=c),this._view.scrollTop+this._view.clientHeight<d&&(e=d-this._view.clientHeight),this._view.scrollTop!=e&&(this._view.scrollTop=e,this.invalidate())}}},makeVisible:function(a){this.isVisible(a)&&(this.expand&&this.expand(a),Jb.callLater(this.scrollToData,this,[a],2*Cd.CALL_LATER_DELAY))},onSelectionChanged:function(a){this._makeVisibleOnSelected&&("append"===a.kind||"set"===a.kind||"all"===a.kind)&&(this.expand&&this.getSelectionContainer().getSelection().forEach(function(a){a.getParent()&&this.expand(a.getParent())},this),Jb.callLater(this.scrollToData,this,[this.getSelectionContainer().getLastData()],2*Cd.CALL_LATER_DELAY))},onShareSelectionContainerChanged:function(){this.invalidateContainer()}}),Ib.controls.TableBase=function(a){this._columnBox=new Ib.ColumnBox,this._columnBox.addServaChangeListener(this.handleColumnBoxChange,this),this._columnBox.addDataPropertyChangeListener(this.handleColumnPropertyChange,this),this._columnBox.addHierarchyChangeListener(this.handleColumnHierarchyChange,this),Ib.controls.TableBase.superClass.constructor.apply(this,arguments),this._cellPool=new Ib.Pool("div",20),this._stringPool=new Ib.Pool("span",20),this._booleanPool=new Ib.Pool("input",20),this._colorPool=new Ib.Pool("div",20),this._pools.add(this._cellPool),this._pools.add(this._stringPool),this._pools.add(this._booleanPool),this._pools.add(this._colorPool)},Jb.ext("twaver.controls.TableBase",Ib.controls.ListBase,{getColumnBox:function(){return this._columnBox},handleColumnBoxChange:function(a){this.invalidateDisplay()},handleColumnPropertyChange:function(a){a.source!==this._sortColumn||"sortDirection"!==a.property&&"sortFunction"!==a.property&&"sortable"!==a.property?this.invalidateDisplay():this.invalidateContainer()},handleColumnHierarchyChange:function(a){this.invalidateDisplay()},renderData:function(a,b,c,d){for(var e,f=this._columnBox.getRoots(),g=f.size(),h=0,i=this._rowHeight-this._rowLineWidth+"px",j=0;g>j;j++){var k=f.get(j),l=k.getWidth();0>l&&(l=0);var m=Math.min(this._columnLineWidth,l);if(k.isVisible()){var n=this._cellPool.get();e=n.style,e.position="absolute",e.whiteSpace="nowrap",e.verticalAlign="middle",e.textAlign=k.getHorizontalAlign(),e.overflow="hidden",e.textOverflow="ellipsis",e.left=h+"px",e.width=l-m+"px",e.height=i,e.borderStyle="solid",e.borderWidth="0px",e.borderRightWidth=m+"px",e.borderRightColor=this._columnLineColor,0===j?(e.borderLeftWidth=m+"px",e.borderLeftColor=this._columnLineColor):e.borderLeftWidth="0px",a.appendChild(n);var o={data:b,value:this.getValue(b,k),div:n,view:this,column:k,rowIndex:c,selected:d};this.renderCell(o),this.onCellRendered(o),h+=l}}e=a.style,e.width=h+"px",e.height=i,e.backgroundColor=this.isCheckMode()&&this._focusedRow===c||!this.isCheckMode()&&d?this.getSelectColor(b):""},adjustRowSize:function(){},onCellRendered:function(a){},getCurrentSortFunction:function(){var a=this._sortColumn;if(a){var b=a.getSortFunction();if(b){var c=this,d="asc"===a.getSortDirection()?1:-1;return function(e,f){var g=c.getValue(e,a),h=c.getValue(f,a);return b.call(c,g,h,e,f)*d}}}return this._sortFunction},renderCell:function(a){var b=a.column;if(b.renderCell)return void b.renderCell(a);var c=a.value,d=b.getEnumInfo();d&&!Array.isArray(d)&&(c=d.map[c]),a.view.isCellEditable(a.data,b)&&(a.enumInfo=d,a.div._editInfo=a),Ac.render(b.getValueType(),c,a.div,a.view,b.isInnerText())},getValue:function(a,b){return b.getValue(a,this)},setValue:function(a,b,c){b.setValue(a,c,this)},getColumnAt:function(a){var b=this.getLogicalPoint(a);if(!b)return null;for(var c=this._columnBox.getRoots(),d=0,e=c.size(),f=0;e>d;d++){var g=c.get(d),h=g.getWidth();if(0>h&&(h=0),b.x>f&&b.x<f+h)return g;f+=h}return null},isCellEditable:function(a,b){return this.isEditable()&&b.isEditable()},commitEditValue:function(a,b){if(!this._isCanceling){var c;c="checkbox"===b.type?b.checked:b.value;var d=a.column,e=d.getValueType();if("int"===e&&"string"==typeof c?c=parseInt(c):"number"===e&&"string"==typeof c&&(c=parseFloat(c)),this.setValue(a.data,d,c),this._currentEditor){var f=this._currentEditor.parentNode,g=this._currentEditor;delete this._currentEditor,f&&f.removeChild(g),Ib.Util.setFocus(this._view)}delete this._isCommitting}},cancelEditing:function(){if(this._currentEditor){this._isCanceling=!0;var a=this._currentEditor.parentNode,b=this._currentEditor;delete this._currentEditor,a&&a.removeChild(b),Ib.Util.setFocus(this._view),delete this._isCanceling}},renderEditor:function(a){},onEditorRendered:function(a){},updateCurrentEditor:function(a){var b=a.target;if(b!==this._currentEditor&&b.parentNode!==this._currentEditor){for(var c;b&&b!==this._view&&!(c=b._editInfo);)b=b.parentNode;if(c&&b===c.div){var d=this.renderEditor&&this.renderEditor(c);d?(this._currentEditor=d.view,null!=c.value&&(this._currentEditor.value=c.value)):c.enumInfo?this._currentEditor=Wb.createSelect(c.enumInfo,c.value):(this._currentEditor=Ob.createElement("input"),null!=c.value&&(this._currentEditor.value=c.value));var e=this;if(this._currentEditor){if(d&&d.onKeyDown){var f=d.onKeyDown;f&&Array.isArray(f)&&e._currentEditor.addEventListener("keydown",function(a){for(var b=0;b<f.length;b++)if(f[b].combKey){var c=null;switch(f[b].combKey){case"ctrlKey":c=a.ctrlKey;break;case"shiftKey":c=a.shiftKey;break;case"altKey":c=a.altKey}a.keyCode===f[b].keyCode&&c&&f[b].handlerEvent&&f[b].handlerEvent(a)}else a.keyCode===f[b].keyCode&&f[b].handlerEvent&&f[b].handlerEvent(a)})}else this._currentEditor.addEventListener("keydown",function(a){var b=a.target._editInfo.view;13===a.keyCode&&a.shiftKey||(13===a.keyCode?b.commitEditValue(a.target._editInfo,a.target):27===a.keyCode&&b.cancelEditing())},!1);if(this._currentEditor.addEventListener("blur",function(a){var b=a.target._editInfo.view;b._isCanceling||b.commitEditValue(a.target._editInfo,a.target)},!1),this._currentEditor.keepDefault=!0,this._currentEditor._editInfo=c,!this._currentEditor.parentNode){var g=this._currentEditor.style;g.position="absolute",g.margin="0px",g.border="0px",g.padding="0px",g.left=c.div.style.left,g.top=c.div.parentNode.style.top,g.width=c.div.style.width,g.height=c.div.style.height,this._rootDiv.appendChild(this._currentEditor)}Ib.Util.setFocus(this._currentEditor)}}}},onColumnSorted:function(a){},getCurrentEditor:function(){return this._currentEditor}}),Ib.controls.List=function(a){Ib.controls.List.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.controls.List",Ib.controls.ListBase,{__accessor:["rowHeight","indent","rowLineWidth","rowLineColor","sortFunction","visibleFunction"],__bool:["makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_checkMode:!1,_rowHeight:Cd.LIST_ROW_HEIGHT,_indent:Cd.LIST_INDENT,_rowLineWidth:Cd.LIST_ROW_LINE_WIDTH,_rowLineColor:Cd.LIST_ROW_LINE_COLOR,_makeVisibleOnSelected:Cd.LIST_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Cd.LIST_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Cd.LIST_KEYBOARD_SELECT_ENABLED,isCheckMode:function(){return this._checkMode},setCheckMode:function(a){delete this._focusedRow;var b=this._checkMode;this._checkMode=a,this.firePropertyChange("checkMode",b,a)},isCheckable:function(a){return this._checkMode===!0},renderData:function(a,b,c,d){var e;this._indent>0&&(e=this.__spanPool.get(),e.style.width=this._indent+"px",e.style.display="inline-block",a.appendChild(e));var f=this.isCheckable(b);f&&this._addCheckBox(a,b,d);var g=this.getIcon(b);g&&this._addIcon(a,b,g);var h=this.getLabel(b);if(h){e=this.__textPool.get();var i=e.style;i.whiteSpace="nowrap",i.verticalAlign="middle",i.padding="1px 2px 1px 2px",i.display="inline-block",Jb.setText(e,h,this._innerText),this.onLabelRendered(e,b,h,c,d),a.appendChild(e)}a.style.backgroundColor=this.isCheckMode()?this._focusedRow===c?this.getSelectColor(b):"":d?this.getSelectColor(b):""},onLabelRendered:function(a,b,c,d,e){}}),Ib.controls.ListBaseInteraction=function(a){this.listBase=a,this.view=a._view;var b=this;this.view.addEventListener("scroll",function(a){b.handleScroll(a)},!1),this.view.addEventListener("mousedown",function(a){b.handleMouseDown(a)},!1),this.view.addEventListener("keydown",function(a){b.handleKeyDown(a)},!1)},Jb.ext("twaver.controls.ListBaseInteraction",Object,{handleMouseDown:function(a){var b=this.listBase;a.target!==b._currentEditor&&a.target.parentNode!==b._currentEditor&&b._handleClick(a)},handleKeyDown:function(a){var b=this.listBase;if(!b._currentEditor)if(Jb.isCtrlDown(a)&&65==a.keyCode)b.isKeyboardSelectEnabled()&&b.selectAll().size()>0&&b.fireInteractionEvent({kind:"selectAll"}),Wb.preventDefault(a);else if(46==a.keyCode)b.isKeyboardRemoveEnabled()&&b.removeSelection()&&b.fireInteractionEvent({kind:"removeElement"}),Wb.preventDefault(a);else if(b.isCheckMode()||38!==a.keyCode&&40!==a.keyCode&&37!==a.keyCode&&39!==a.keyCode)Jb.showVersion(a);else{var c=b.getSelectionContainer().getLastData();if(c)if(38===a.keyCode||40===a.keyCode){var d=b.getRowDatas(),e=b.getRowIndexByData(c);e>=0&&(38===a.keyCode?0!==e&&(c=d.get(e-1),b.getSelectionContainer().setSelection(c)):e!==d.size()-1&&(c=d.get(e+1),b.getSelectionContainer().setSelection(c)))}else!b.expand||37!==a.keyCode&&39!==a.keyCode||c.hasChildren()&&(37===a.keyCode?b.collapse(c):b.expand(c));else b.getRowDatas().size()>0&&(c=b.getRowDatas().get(0),b.getSelectionContainer().setSelection(c))}},handleScroll:function(a){this.listBase.invalidate()}}),Ib.controls.ListBaseTouchInteraction=function(a){this.listBase=a,this.view=a._view,Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.controls.ListBaseTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),this.lastPoint=this.listBase.getLogicalPoint(a),Wb.addEventListener("touchmove","handleTouchmove",this.view,this),Wb.addEventListener("touchend","handleTouchend",this.view,this),zc.isMultiTouch(a)&&(this.distance=zc.getDistance(a),this.zoom=this.listBase._zoom)},handleTouchmove:function(a){if(Wb.preventDefault(a),this.moved||(this.moved=!0),zc.isSingleTouch(a)){if(this.lastPoint){var b=this.listBase.getLogicalPoint(a),c=this.lastPoint.x-b.x,d=this.lastPoint.y-b.y,e=this.listBase.panByOffset(c,d);this.listBase.invalidate(),this.lastPoint.x-=c-e.x,this.lastPoint.y-=d-e.y}}else if(this.distance){var f=zc.getDistance(a)/this.distance;this.listBase.setZoom(this.zoom*f,!1)}},handleTouchend:function(a){Wb.preventDefault(a),this.moved||a.target===this.listBase._currentEditor||a.target.parentNode===this.listBase._currentEditor||this.listBase._handleClick(a),delete this.lastPoint,delete this.moved,delete this.distance,delete this.zoom,Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this)}}),Ib.controls.ListBaseMSTouchInteraction=function(a){Ib.controls.ListBaseMSTouchInteraction.superClass.constructor.apply(this,arguments),this._pointerMap={},this._pointerIdArray=[];var b=this;this.view.addEventListener("MSPointerDown",function(a){b.handleTouchstart(a)},!1),this.view.addEventListener("MSPointerMove",function(a){
b.handleTouchmove(a)},!1),this.view.addEventListener("MSPointerUp",function(a){b.handleTouchend(a)},!1),this.view.addEventListener("MSPointerCancel",function(a){b.handleTouchend(a)},!1),this.superHandleMouseDown=Ib.controls.ListBaseMSTouchInteraction.superClass.handleMouseDown},Jb.ext("twaver.controls.ListBaseMSTouchInteraction",Ib.controls.ListBaseInteraction,{handleMouseDown:function(a){},handleTouchstart:function(a){a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),this._pointerMap[a.pointerId]||null==this.listBase.getLogicalPoint(a)||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length&&a.pointerType==a.MSPOINTER_TYPE_MOUSE&&this.superHandleMouseDown(a),1==this._pointerIdArray.length?(this._startTouchPoint=this.listBase.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.listBase.getZoom())},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.listBase.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE&&this._startTouchPoint){var c=this.listBase.getLogicalPoint(a);if(null==c)return;var d=this._startTouchPoint.x-c.x,e=this._startTouchPoint.y-c.y,f=this.listBase.panByOffset(d,e);this.listBase.invalidate(),this._startTouchPoint.x-=d-f.x,this._startTouchPoint.y-=e-f.y}},handleTouchend:function(a){if(this._startTouchPoint&&1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.listBase.getLogicalPoint(a);if(b){var c=new Date;c.getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,b)<=20&&this.superHandleMouseDown(a)}}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Ib.controls.Tree=function(a){this._interactionDispatcher=new Ib.EventDispatcher,this._initTree(a),Ib.controls.Tree.superClass.constructor.apply(this,arguments),this.setToolTipEnabled(Cd.TREE_TOOLTIP_ENABLED)},Jb.ext("twaver.controls.Tree",Ib.controls.ListBase,{__tree:1,__accessor:["rootData","sortFunction","visibleFunction","indent","rowHeight","rowLineWidth","rowLineColor","expandIcon","collapseIcon","uncheckableStyle","lineType","lineColor","lineThickness","lineAlpha","lineDash"],__bool:["rootVisible","makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_checkMode:!1,_indent:Cd.TREE_INDENT,_rowHeight:Cd.TREE_ROW_HEIGHT,_rowLineWidth:Cd.TREE_ROW_LINE_WIDTH,_rowLineColor:Cd.TREE_ROW_LINE_COLOR,_makeVisibleOnSelected:Cd.TREE_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Cd.TREE_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Cd.TREE_KEYBOARD_SELECT_ENABLED,_expandIcon:Cd.TREE_EXPAND_ICON,_collapseIcon:Cd.TREE_COLLAPSE_ICON,_uncheckableStyle:"none",_lineType:Cd.TREE_LINE_TYPE,_lineColor:Cd.TREE_LINE_COLOR,_lineThickness:Cd.TREE_LINE_THICKNESS,_lineAlpha:Cd.TREE_LINE_ALPHA,_lineDash:Cd.TREE_LINE_DASH,getCheckMode:function(){return this._checkMode},setCheckMode:function(a){delete this._focusedRow;var b=this._checkMode;this._checkMode=a,this.firePropertyChange("checkMode",b,a)},renderData:function(a,b,c,d){this._renderTree(a,b,c,d)},isToolTipEnabled:function(){return this._toolTipEnabled?!0:!1},setToolTipEnabled:function(a){if(this._toolTipEnabled=a,a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){var c=b.getDataAt(a);if(!c)return void Bc.hideToolTip();if(b._preElement!==c){if(b._preElement=c,c){var d=b.getToolTip(c);return void Bc.showToolTip(a,d)}Bc.hideToolTip()}},this._view.addEventListener("mousemove",this._toolTipListener,!1),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Bc.hideToolTip(),this._view.removeEventListener("mousemove",this._toolTipListener,!1),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},getToolTip:function(a){return a.getToolTip()}}),Ib.controls.Table=function(a){this._checkColumn=new Ib.Column,this._checkColumn.setName("check"),this._checkColumn.setEditable(!0),this._checkColumn.setWidth(40),this._checkColumn.setHorizontalAlign("center"),this._checkColumn.renderCell=this.renderCheckCell;var b=this;this._checkColumn.getValue=function(a,c){return b.isSelected(a)},Ib.controls.Table.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.controls.Table",Ib.controls.TableBase,{__accessor:["rowHeight","rowLineWidth","rowLineColor","columnLineWidth","columnLineColor","sortFunction","visibleFunction","sortColumn"],__bool:["editable","makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_editable:Cd.TABLE_EDITABLE,_rowHeight:Cd.TABLE_ROW_HEIGHT,_rowLineWidth:Cd.TABLE_ROW_LINE_WIDTH,_rowLineColor:Cd.TABLE_ROW_LINE_COLOR,_columnLineWidth:Cd.TABLE_COLUMN_LINE_WIDTH,_columnLineColor:Cd.TABLE_COLUMN_LINE_COLOR,_makeVisibleOnSelected:Cd.TABLE_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Cd.TABLE_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Cd.TABLE_KEYBOARD_SELECT_ENABLED,getCheckColumn:function(){return this._checkColumn},isCheckMode:function(){return this._columnBox.contains(this._checkColumn)},setCheckMode:function(a){a!==this.isCheckMode()&&(delete this._focusedRow,a?this._columnBox.add(this._checkColumn,0):this._columnBox.remove(this._checkColumn),this.firePropertyChange("checkMode",!a,a))},renderCheckCell:function(a){var b=a.view._booleanPool.get();b.disabled=!1,b.type="checkbox",b.style.margin="0px 2px",b.style.verticalAlign="middle",b.checked=a.selected;var c=a.div;c.appendChild(b),""===c.style.textAlign&&(c.style.textAlign="center"),b._checkData=a.data}}),Ib.controls.TableHeader=function(a){Ib.controls.TableHeader.superClass.constructor.apply(this,arguments),this._invalidateScroll=!1,this._invalidateDisplay=!1,this._divPool=new Ib.Pool("div"),this._imagePool=new Ib.Pool("img"),this._textPool=new Ib.Pool("span"),this._resizePool=new Ib.Pool("div"),this._pools.add(this._divPool),this._pools.add(this._imagePool),this._pools.add(this._textPool),this._pools.add(this._resizePool),this._table=a,this._tableView=a.getView(),this._columnBox=a.getColumnBox(),this._columnBox.addServaChangeListener(this.handleColumnBoxChange,this),this._columnBox.addDataPropertyChangeListener(this.handleColumnPropertyChange,this),this._columnBox.addHierarchyChangeListener(this.handleColumnHierarchyChange,this);var b=this;a.getView().addEventListener("scroll",function(a){b.invalidateScroll()},!1),a.addPropertyChangeListener(function(a){b.invalidateDisplay()},this),this._view=Wb.createView("hidden"),this._view.tabIndex=-1,this._view.style.background=Cd.TABLEHEADER_BACKGROUND,this._rootDiv=Wb.createDiv(),this._view.appendChild(this._rootDiv),this.invalidateDisplay();var c;c=Qb.isTouchable&&!Qb.isMSToucheable?Ib.controls.TableHeaderTouchInteraction:Ib.controls.TableHeaderInteraction,c&&new c(this)},Jb.ext("twaver.controls.TableHeader",Ib.controls.ControlBase,{__accessor:["height","moveBackground","insertBackground","columnLineColor","resizeTolerance","sortDescIcon","sortAscIcon","sortIconPosition"],_height:Cd.TABLEHEADER_HEIGHT,_moveBackground:Cd.TABLEHEADER_MOVE_BACKGROUND,_insertBackground:Cd.TABLEHEADER_INSERT_BACKGROUND,_columnLineColor:Cd.TABLEHEADER_COLUMN_LINE_COLOR,_resizeTolerance:Cd.TABLEHEADER_RESIZE_TOLERANCE,_sortDescIcon:Cd.TABLEHEADER_SORT_DESC_ICON,_sortAscIcon:Cd.TABLEHEADER_SORT_ASC_ICON,_sortIconPosition:Cd.TABLEHEADER_SORT_ICON_POSITION,getRootDiv:function(){return this._rootDiv},handleColumnBoxChange:function(a){this.invalidateDisplay()},handleColumnPropertyChange:function(a){this.invalidateDisplay()},handleColumnHierarchyChange:function(a){this.invalidateDisplay()},onPropertyChanged:function(a){this.invalidateDisplay()},invalidateScroll:function(){this._invalidateScroll||(this._invalidateScroll=!0,this.invalidate())},invalidateDisplay:function(){this._invalidateDisplay||(this._invalidateDisplay=!0,this._invalidateScroll=!0,this.invalidate())},validate:function(){this._invalidate&&(this._invalidate=!1,this._invalidateDisplay&&(this._invalidateDisplay=!1,this.validateDisplay()),this._invalidateScroll&&(this._invalidateScroll=!1,this._rootDiv.style.left=-this._tableView.scrollLeft+"px"))},validateDisplay:function(){Wb.release(this._rootDiv);for(var a=this._table.getZoom(),b=this.getHeight()+"px",c=this.getHeight()-2+"px",d=this._table.getColumnBox().getRoots(),e=d.size(),f=0,g=this._table._columnLineWidth*a,h=0;e>h;h++){var i=d.get(h);if(i.isVisible()){var j=i.getWidth()*a;0>j&&(j=0);var k=Math.min(g,j),l=this._divPool.get();l._column=i;var m=l.style;m.position="absolute",m.whiteSpace="nowrap",m.lineHeight=c,m.overflow="hidden",m.textOverflow="ellipsis",m.backgroundPosition=this._sortIconPosition?this._sortIconPosition:"",m.backgroundRepeat="no-repeat",m.backgroundImage="",m.textAlign=i.getHorizontalAlign(),m.borderStyle="solid",m.borderWidth="0px",m.borderRightWidth=k+"px",m.borderRightColor=this._columnLineColor,0===h?(m.borderLeftWidth=k+"px",m.borderLeftColor=this._columnLineColor):m.borderLeftWidth="0px",m.left=f+"px",m.width=j-k+"px",m.height=b,l._x=f,l._width=j-k,this._rootDiv.insertBefore(l,this._rootDiv.firstChild),this.renderColumn(l,i),this.onColumnRendered(l,i),f+=j,i.isResizable()&&(l=this._resizePool.get(),l._resizeColumn=i,m=l.style,m.position="absolute",m.backgroundColor="white",m.opacity=0,m.left=f-k-this._resizeTolerance+"px",m.width=k+2*this._resizeTolerance+"px",m.height=b,this._rootDiv.appendChild(l))}}this._pools.forEach(function(a){a.clear()}),this._rootDiv.style.width=f+"px",this._rootDiv.style.height=b},renderColumn:function(a,b){if(b.renderHeader)b.renderHeader(a);else{var c=this._textPool.get();if(c.style.whiteSpace="nowrap",c.style.verticalAlign="middle",c.style.padding="1px 2px 1px 2px",c.innerHTML=b.getName()?b.getName():b.getPropertyName(),c.setAttribute("title",c.innerHTML),a.appendChild(c),Qb.isOpera){var d=a.cloneNode(!1);d.style.left="0px",d.style.top="0px",d.style.opacity=0,a.appendChild(d)}}if(this._table.getSortColumn()===b&&b.isSortable()){var e="asc"===b.getSortDirection()?this._sortAscIcon:this._sortDescIcon,f=Jb.getImageSrc(e);if(this._sortIconPosition&&""!==this._sortIconPosition)a.style.backgroundImage="url("+f+")";else{var g=this._imagePool.get();g.setAttribute("src",f),g.style.verticalAlign="middle",a.appendChild(g)}}},onColumnRendered:function(a,b){}}),Ib.controls.TableHeaderInteraction=function(a){this.header=a,this.table=a._table,this.view=a._view;var b=this;this.view.addEventListener("mousedown",function(a){b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Jb.ext("twaver.controls.TableHeaderInteraction",Object,{handleMouseDown:function(a){if(0===a.button){if(this.movableDiv)return void this.handleMouseUp(a);this.resizeColumn=a.target._resizeColumn,this.resizeColumn||(this.movableDiv=this.getMovableDivAt(a)),this.changeCursor(a),this._startClient=Wb.getClientPoint(a),this.lastX=this.getX(a),this._startLogicalX=this.lastX,Wb.handle_mousedown(this,a)}},changeCursor:function(a){var b="";if(a.target._resizeColumn)b="ew-resize";else{var c=this.getColumnAt(a);c&&(c.isMovable()||c.isSortable())&&(b="pointer")}this.view.style.cursor=b},handleMouseMove:function(a){if(null==this.lastX)return void this.changeCursor(a);if(Wb.target===this){var b=this._startLogicalX+a.clientX-this._startClient.x;if(this.resizeColumn){if(null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeColumn.getWidth()+(b-this.lastX)/this.table.getZoom();10>c&&(c=10,this.stopX=b),this.resizeColumn.setWidth(c),this.lastX=b}else if(this.movableDiv){var d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.header.getMoveBackground(),this.insertDiv=Wb.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.header.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.columnInfo=this.getColumnInfoAt(a),this.columnInfo&&(this.insertDiv.style.left=this.columnInfo.position)}}},handleMouseUp:function(a){if(0===a.button){var b;if(this.resizeColumn);else if(this.movableDiv&&this.columnInfo){b=this.movableDiv._column;var c=this.columnInfo.index;this.table.getColumnBox().moveTo(b,c)}else if(b=this.getColumnAt(a),b&&b.isSortable()){var d=b.getSortDirection();this.table.getSortColumn()===b?("desc"===d&&this.table.setSortColumn(null),b.setSortDirection("asc"===d?"desc":"asc")):this.table.setSortColumn(b),this.table.onColumnSorted(this.table.getSortColumn())}this.clear()}},clear:function(){this.view.style.cursor="",this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.columnInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeColumn,delete this.stopX,delete this.lastX,delete this._startClient,delete this._startLogicalX},getColumnAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Wb.getLogicalPoint(this.view,a);return b?b.x:null},getColumnInfoAt:function(a){for(var b=this._startLogicalX+a.clientX-this._startClient.x+this.table.getView().scrollLeft,c=this.table.getColumnBox().getRoots(),d=c.size(),e=this.table.getZoom(),f=0,g=!1,h=0;d>h;h++){var i=c.get(h);if(i===this.movableDiv._column&&(g=!0),i.isVisible()){var j=i.getWidth()*e;if(0>=j)continue;if(b>=f&&f+j>=b){var k=f+j/2>b;!g||i===this.movableDiv._column&&k||h--;var l=k?Math.max(0,h):Math.min(h+1,d),m=k?f:f+j;return m=Math.max(0,m-1),{index:l,column:i,position:m+"px"}}f+=j}}return this.columnInfo}}),Ib.controls.TableHeaderTouchInteraction=function(a){this.header=a,this.table=a._table,this.view=a._view,Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.controls.TableHeaderTouchInteraction",Object,{handleTouchstart:function(a){return Wb.preventDefault(a),this.movableDiv?void this.handleTouchend(a):(this.resizeColumn=a.target._resizeColumn,this.resizeColumn||(this.movableDiv=this.getMovableDivAt(a)),this.lastX=this.getX(a),Wb.addEventListener("touchmove","handleTouchmove",this.view,this),void Wb.addEventListener("touchend","handleTouchend",this.view,this))},handleTouchmove:function(a){if(Wb.preventDefault(a),null!=this.lastX){var b;if(this.resizeColumn){if(b=this.getX(a),null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeColumn.getWidth()+(b-this.lastX)/this.table.getZoom();0>c&&(c=0,this.stopX=b),this.resizeColumn.setWidth(c),this.lastX=b}else if(this.movableDiv){b=this.getX(a);var d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.header.getMoveBackground(),this.insertDiv=Wb.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.header.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.columnInfo=this.getColumnInfoAt(a),this.columnInfo&&(this.insertDiv.style.left=this.columnInfo.position)}}},handleTouchend:function(a){Wb.preventDefault(a);var b;if(this.resizeColumn);else if(this.movableDiv&&this.columnInfo){b=this.movableDiv._column;var c=this.columnInfo.index;this.table.getColumnBox().moveTo(b,c)}else if(b=this.getColumnAt(a),b&&b.isSortable()){var d=b.getSortDirection();this.table.getSortColumn()===b?("desc"===d&&this.table.setSortColumn(null),b.setSortDirection("asc"===d?"desc":"asc")):this.table.setSortColumn(b)}this.clear(),Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this)},clear:function(){this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.columnInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeColumn,delete this.stopX,delete this.lastX},getColumnAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._column);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Wb.getLogicalPoint(this.view,a);return b?b.x:null},getColumnInfoAt:function(a){for(var b=this.getX(a)+this.table.getView().scrollLeft,c=this.table.getColumnBox().getRoots(),d=c.size(),e=this.table.getZoom(),f=0,g=!1,h=0;d>h;h++){var i=c.get(h);if(i===this.movableDiv._column&&(g=!0),i.isVisible()){var j=i.getWidth()*e;if(0>=j)continue;if(b>=f&&f+j>=b){var k=f+j/2>b;!g||i===this.movableDiv._column&&k||h--;var l=k?Math.max(0,h):Math.min(h+1,d),m=k?f:f+j;return m=Math.max(0,m-1),{index:l,column:i,position:m+"px"}}f+=j}}return this.columnInfo}}),Ib.controls.TablePane=function(a,b){Ib.controls.TablePane.superClass.constructor.apply(this,arguments),this.invalidate(),this._table=a,this._tableHeader=b?b:new Ib.controls.TableHeader(a),this._view=Wb.createView("hidden",!0),this._view.tabIndex=-1,this._view.appendChild(this._tableHeader.getView()),this._view.appendChild(this._table.getView());var c=this;this._tableHeader.addPropertyChangeListener(function(a){"height"===a.property&&c.invalidate()})},Jb.ext("twaver.controls.TablePane",Ib.controls.ControlBase,{onPropertyChanged:function(a){this.invalidate()},getTable:function(){return this._table},getTableHeader:function(){return this._tableHeader},validateImpl:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight,c=this._tableHeader.getHeight();this._tableHeader.adjustBounds({x:0,y:0,width:a,height:c}),this._table.adjustBounds({x:0,y:c,width:a,height:Math.max(0,b-c)})}}),Ib.controls.TreeTable=function(a){this._treeColumn=new Ib.Column,this._treeColumn.setName("tree"),this._treeColumn.setWidth(120),this._treeColumn.renderCell=this.renderTreeCell,this._treeColumn.getValue=this.getTreeValue,this._treeColumn.setValue=this.setTreeValue,this._initTree(a),Ib.controls.TreeTable.superClass.constructor.apply(this,arguments),this._columnBox.add(this._treeColumn)},Jb.ext("twaver.controls.TreeTable",Ib.controls.TableBase,{__tree:1,__accessor:["sortFunction","visibleFunction","checkMode","rootData","sortColumn","indent","rowHeight","rowLineWidth","rowLineColor","columnLineWidth","columnLineColor","expandIcon","collapseIcon","uncheckableStyle","lineType","lineColor","lineThickness","lineAlpha","lineDash"],__bool:["editable","rootVisible","makeVisibleOnSelected","keyboardRemoveEnabled","keyboardSelectEnabled"],_editable:Cd.TREETABLE_EDITABLE,_indent:Cd.TREETABLE_INDENT,_rowHeight:Cd.TREETABLE_ROW_HEIGHT,_rowLineWidth:Cd.TREETABLE_ROW_LINE_WIDTH,_rowLineColor:Cd.TREETABLE_ROW_LINE_COLOR,_columnLineWidth:Cd.TREETABLE_COLUMN_LINE_WIDTH,_columnLineColor:Cd.TREETABLE_COLUMN_LINE_COLOR,_makeVisibleOnSelected:Cd.TREETABLE_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Cd.TREETABLE_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Cd.TREETABLE_KEYBOARD_SELECT_ENABLED,_expandIcon:Cd.TREETABLE_EXPAND_ICON,_collapseIcon:Cd.TREETABLE_COLLAPSE_ICON,_lineType:Cd.TREE_LINE_TYPE,_lineColor:Cd.TREE_LINE_COLOR,_lineThickness:Cd.TREE_LINE_THICKNESS,_lineAlpha:Cd.TREE_LINE_ALPHA,_lineDash:Cd.TREE_LINE_DASH,getTreeColumn:function(){return this._treeColumn},renderTreeCell:function(a){a.view._renderTree(a.div,a.data,a.rowIndex,a.selected)},getTreeValue:function(a,b){return b.getLabel(a)},setTreeValue:function(a,b,c){a.setName(b)}}),Ib.controls.PropertySheet=function(a){Ib.controls.PropertySheet.superClass.constructor.apply(this,arguments),this._currentRowIndex=-1,this._currentEditor=null,this._currentData=null,this._invalidate=!1,this._resizeDiv=Wb.createDiv(),this._resizeDiv.style.backgroundColor="white",this._resizeDiv.style.opacity=0,this._resizeDiv.style.top="0px",this._categoryList=new md,this._categoryMap={},this._rowList=new md,this._propertyBox=new Ib.PropertyBox,this._propertyBox.addServaChangeListener(this.invalidatePropertyBox,this),this._propertyBox.addDataPropertyChangeListener(this.invalidatePropertyBox,this),this._propertyBox.addHierarchyChangeListener(this.invalidatePropertyBox,this),this.__divPool=new Ib.Pool("div",2),this.__cellPool=new Ib.Pool("div",2),this.__imagePool=new Ib.Pool("img",2),this.__textPool=new Ib.Pool("span",2),this._stringPool=new Ib.Pool("span",2),this._booleanPool=new Ib.Pool("input",2),this._colorPool=new Ib.Pool("div",2),this._pools.add(this.__divPool),this._pools.add(this.__cellPool),this._pools.add(this.__imagePool),this._pools.add(this.__textPool),this._pools.add(this._stringPool),this._pools.add(this._booleanPool),this._pools.add(this._colorPool),this._view=Wb.createView("auto"),this._rootDiv=Wb.createDiv(),this._dataDiv=Wb.createDiv(),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._dataDiv),this.setServa(a?a:new Ib.Serva);var b=this;this._view.addEventListener("change",function(a){b.handleChange(a)},!1);var c;c=Qb.isMSToucheable?Ib.controls.PropertySheetMSTouchInteraction:Qb.isTouchable?Ib.controls.PropertySheetTouchInteraction:Ib.controls.PropertySheetInteraction,c&&new c(this)},Jb.ext("twaver.controls.PropertySheet",Ib.controls.View,{__accessor:["indent","rowHeight","sumWidth","propertyNameWidth","propertyNameHorizontalAlign","autoAdjustable","rowLineWidth","columnLineWidth","borderColor","categorizable","resizeTolerance","editable","selectColor","expandIcon","collapseIcon","sortFunction","visibleFunction"],_autoAdjustable:Cd.PROPERTYSHEET_AUTO_ADJUSTABLE,_selectColor:Cd.SELECT_COLOR,_categorizable:Cd.PROPERTYSHEET_CATEGORIZABLE,_editable:Cd.PROPERTYSHEET_EDITABLE,_propertyNameWidth:Cd.PROPERTYSHEET_PROPERTY_NAME_WIDTH,_propertyNameHorizontalAlign:Cd.PROPERTYSHEET_PROPERTY_NAME_HORIZONTAL_ALIGN,_sumWidth:Cd.PROPERTYSHEET_SUM_WIDTH,_indent:Cd.PROPERTYSHEET_INDENT,_rowHeight:Cd.PROPERTYSHEET_ROW_HEIGHT,_rowLineWidth:Cd.PROPERTYSHEET_ROW_LINE_WIDTH,_columnLineWidth:Cd.PROPERTYSHEET_COLUMN_LINE_WIDTH,_borderColor:Cd.PROPERTYSHEET_BORDER_COLOR,_expandIcon:Cd.PROPERTYSHEET_EXPAND_ICON,_collapseIcon:Cd.PROPERTYSHEET_COLLAPSE_ICON,_resizeTolerance:Cd.PROPERTYSHEET_RESIZE_TOLERANCE,getPropertyBox:function(){return this._propertyBox},getCurrentData:function(){return this._currentData},getDataDiv:function(){return this._dataDiv},getServa:function(){return this._box},setServa:function(a){if(!a)throw"Serva can not be null";if(this._box!==a){var b=this._box;b&&(b.removeDataPropertyChangeListener(this.handlePropertyChange,this),this._selectionContainer||b.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addDataPropertyChangeListener(this.handlePropertyChange,this),this._selectionContainer?this._selectionContainer._setServa(a):this._box.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this.invalidate(),this.firePropertyChange("dataBox",b,this._box)}},invalidatePropertyBox:function(){this._isValidating||this.invalidate()},onPropertyChanged:function(a){"zoom"!==a.property&&this.invalidate()},isVisible:function(a){return a.isVisible&&!a.isVisible(this._currentData,this)?!1:this._visibleFunction?this._visibleFunction(a):!0},handlePropertyChange:function(a){this._currentData===a.source&&this.invalidate()},handleSelectionChange:function(a){this._currentData!==this.getSelectionContainer().getLastData()&&(this._currentRowIndex=-1,this.invalidate())},isExpanded:function(a){if(!a)return!0;var b=this._categoryMap[a];return b?b.isExpanded:Cd.PROPERTYSHEET_EXPAND_CATEGORY},expand:function(a){if(a){var b=this._categoryMap[a];b&&!b.isExpanded&&(b.isExpanded=!0,this.invalidate())}},expandAll:function(){for(var a in this._categoryMap){var b=this._categoryMap[a];b&&(b.isExpanded=!0)}this.invalidate()},collapse:function(a){if(a){var b=this._categoryMap[a];b&&b.isExpanded&&(b.isExpanded=!1,this.invalidate())}},collapseAll:function(){for(var a in this._categoryMap){var b=this._categoryMap[a];b&&(b.isExpanded=!1)}this.invalidate()},getCategoryName:function(a){if(!this.isCategorizable())return"null";var b=a.getCategoryName();return b?b:"null"},validateContainer:function(){this._rowList.clear(),this._categoryList.clear();var a,b,c,d,e,f={},g=new md,h=this._currentData?this._propertyBox.getRoots():new md;for(d=h.size(),a=0;d>a;a++)e=h.get(a),this.isVisible(e)&&(g.add(e),c=this.getCategoryName(e),f[c]||(this._categoryList.add(c),f[c]={isExpanded:this.isExpanded(c),properties:new md}));for(this._sortFunction&&g.sort(this._sortFunction),this._categoryMap=f,d=g.size(),a=0;a<this._categoryList.size();a++){c=this._categoryList.get(a),"null"!==c&&this._rowList.add(c);var i=f[c];if(i.isExpanded)for(b=0;d>b;b++)e=g.get(b),this.getCategoryName(e)===c&&(i.properties.add(e),this._rowList.add({view:this,data:this._currentData,property:e,value:this._currentData?this.getValue(this._currentData,e):null}))}},adjustWidth:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight;a<=this._indent||0>=b||(a-=this._indent,this._rowList.size()*this._rowHeight>b&&(a-=Cd.SCROLL_BAR_WIDTH,0>=a)||(this._propertyNameWidth=0===this._sumWidth||this._propertyNameWidth>this._sumWidth?a/2:a*(this._propertyNameWidth/this._sumWidth),this._sumWidth=a,this._view.style.overflowX="hidden",this._view.style.overflowY="auto"))},validateDisplay:function(){var a=this._rowList.size(),b=this._borderColor,c=this._indent,d=this._rowHeight,e=this._propertyNameWidth,f=Math.max(0,this._sumWidth-e),g=this._rowLineWidth,h=this._columnLineWidth,i=d-g+"px",j=d-g-2+"px",k=c+"px",l=e-h+"px",m=f-h+"px",n=e+f+"px",o=g+"px",p=h+"px",q=e+"px",r=this._dataDiv,s=r.style;s.height=a*d+"px",s.width=c+e+f+"px";var t=this.__divPool.get();s=t.style,s.position="absolute",s.left="0px",s.top="0px",s.width=k,s.height=r.style.height,s.borderWidth="0px",s.backgroundColor=b,r.appendChild(t);for(var u=0;a>u;u++){var v=this._rowList.get(u),w=u*d+"px",x=this.__divPool.get();if(v.rowDiv=x,s=x.style,s.position="absolute",s.whiteSpace="nowrap",s.overflow="hidden",s.textOverflow="ellipsis",s.left=k,s.top=w,s.width=n,s.height=i,s.lineHeight=j,s.borderStyle="solid",s.borderWidth="0px",s.borderBottomWidth=o,s.borderBottomColor=b,r.appendChild(x),"string"==typeof v){s.backgroundColor=b,t=this.__divPool.get(),s=t.style,s.position="absolute",s.left="0px",s.top=w,s.width=k,s.height=i,s.lineHeight=j,s.borderWidth="0px",r.appendChild(t);var y=this.__imagePool.get(),z=this.isExpanded(v)?this._expandIcon:this._collapseIcon;y.setAttribute("src",Jb.getImageSrc(z)),s=y.style,s.verticalAlign="middle",y._expandData=v,t.appendChild(y),this.renderCategory(x,v),this.onCategoryRendered(x,v)}else{var A=v.property,B=this.__cellPool.get();v.nameRender=B,s=B.style,this._currentRowIndex===u&&(s.backgroundColor=this.getSelectColor()),s.position="absolute",s.verticalAlign="middle",s.textAlign=this._propertyNameHorizontalAlign,s.overflow="hidden",s.textOverflow="ellipsis",s.whiteSpace="nowrap",s.left="0px",s.top="0px",s.width=l,s.height=i,s.borderStyle="solid",s.borderWidth="0px",s.borderRightWidth=p,s.borderRightColor=b,x.appendChild(B),this.renderName(v),this.onNameRendered(v),B=this.__cellPool.get(),v.valueRender=B,s=B.style,s.position="absolute",s.verticalAlign="middle",s.textAlign=A.getHorizontalAlign(),s.whiteSpace="nowrap",s.overflow="hidden",s.textOverflow="ellipsis",s.left=q,s.top="0px",s.width=m,s.height=i,s.borderStyle="solid",s.borderWidth="0px",s.borderRightWidth=p,s.borderRightColor=b,x.appendChild(B),this.renderValue(v),this.onValueRendered(v)}}s=this._resizeDiv.style,s.left=c+e-h-this._resizeTolerance+"px",s.width=h+2*this._resizeTolerance+"px",s.height=r.style.height,r.appendChild(this._resizeDiv)},renderCategory:function(a,b){var c=this.__textPool.get(),d=c.style;d.fontWeight="bold",d.whiteSpace="nowrap",d.overflow="hidden",d.textOverflow="ellipsis",d.verticalAlign="middle",d.padding="1px 2px 1px 2px",c.innerHTML=b,c.setAttribute("title",b),a.appendChild(c)},onCategoryRendered:function(a,b){},renderName:function(a){if(a.property.renderName)return void a.property.renderName(a);var b=this.__textPool.get(),c=b.style;c.fontWeight="",c.whiteSpace="nowrap",c.verticalAlign="middle",c.padding="1px 2px 1px 2px";var d=a.property.getName();d||(d=a.property.getPropertyName()),b.innerHTML=d,b.setAttribute("title",d),a.nameRender.appendChild(b)},onNameRendered:function(a){},renderValue:function(a){var b=a.property;if(b.renderValue)return void b.renderValue(a);var c=a.value,d=b.getEnumInfo();d&&!Array.isArray(d)&&(c=d.map[c]),a.view.isCellEditable(a.data,b)&&(a.enumInfo=d,a.valueRender._editInfo=a),Ac.render(b.getValueType(),c,a.valueRender,a.view,b.isInnerText())},onValueRendered:function(a){},renderEditor:function(a){},onEditorRendered:function(a){},updateCurrentData:function(){this._currentData=this.getSelectionContainer().getLastData()},validateImpl:function(){var a=this._view.scrollLeft,b=this._view.scrollTop;Wb.release(this._dataDiv),this.updateCurrentData(),this.validateContainer(),this.isAutoAdjustable()&&this.adjustWidth(),this.validateDisplay(),this._pools.forEach(function(a){a.clear()}),this._view.scrollLeft!==a&&(this._view.scrollLeft=a),this._view.scrollTop!==b&&(this._view.scrollTop=b)},getValue:function(a,b){return a?b.getValue(a,this):null},setValue:function(a,b,c){a&&b.setValue(a,c,this)},isCellEditable:function(a,b){return a?this.isEditable()&&b.isEditable():!1},getRowIndexAt:function(a){var b=this.getLogicalPoint(a);if(!b)return-1;var c=parseInt(b.y/this._rowHeight);return c>=0&&c<this._rowList.size()?c:-1},handleChange:function(a){this._isCommitting||this._isCanceling||this._isValidating||a.target._editInfo&&this.commitEditValue&&this.commitEditValue(a.target._editInfo,a.target)},commitEditValue:function(a,b){var c;c="checkbox"===b.type?b.checked:b.value;var d=a.property,e=d.getValueType();if("int"===e&&"string"==typeof c)c=parseInt(c);else if("number"===e&&"string"==typeof c)c=parseFloat(c);else if("array.string"===e)c=c.split(",");else if("array.number"===e){c=c.split(",");for(var f=0,g=c.length;g>f;f++)c[f]=parseFloat(c[f])}if(this.setValue(a.data,d,c),Ib.Util.setFocus(this._view),this._currentEditor){var h=this._currentEditor.parentNode;h&&h.removeChild(this._currentEditor),delete this._currentEditor}delete this._isCommitting},cancelEditing:function(){if(this._currentEditor){var a=this._currentEditor.parentNode;a&&a.removeChild(this._currentEditor),delete this._currentEditor,delete this._isCanceling}},updateCurrentRowIndex:function(a){var b=this._rowList.size();(0>a||a>=b)&&(a=-1);var c,d=this._currentRowIndex;if(a!==d&&(d>=0&&b>d&&(c=this._rowList.get(d),c.nameRender&&(c.nameRender.style.backgroundColor="")),this._currentRowIndex=a),a>=0&&(c=this._rowList.get(a),c.nameRender&&(c.nameRender.style.backgroundColor=this.getSelectColor(),!this._currentEditor&&c.valueRender&&c.valueRender._editInfo))){var e=c.valueRender._editInfo,f=this.renderEditor&&this.renderEditor(c);f?(this._currentEditor=f.view,null!=e.value&&(this._currentEditor.value=e.value)):e.enumInfo?this._currentEditor=Wb.createSelect(e.enumInfo,e.value):(this._currentEditor=Ob.createElement("input"),
null!=e.value&&(this._currentEditor.value=e.value));var g=this;if(this._currentEditor){if(f&&f.onKeyDown){var h=f.onKeyDown;h&&Array.isArray(h)&&g._currentEditor.addEventListener("keydown",function(a){for(var b=0;b<h.length;b++)if(h[b].combKey){var c=null;switch(h[b].combKey){case"ctrlKey":c=a.ctrlKey;break;case"shiftKey":c=a.shiftKey;break;case"altKey":c=a.altKey}a.keyCode===h[b].keyCode&&c&&h[b].handlerEvent&&h[b].handlerEvent(a)}else a.keyCode===h[b].keyCode&&h[b].handlerEvent&&h[b].handlerEvent(a)})}else this._currentEditor.addEventListener("keydown",function(a){var b=a.target._editInfo.view;if(13!==a.keyCode||!a.shiftKey)if(13===a.keyCode){if(b._isCommitting)return;b._isCommitting=!0,b.commitEditValue(a.target._editInfo,a.target)}else 27===a.keyCode&&(b._isCanceling=!0,b.cancelEditing())},!1);if(this._currentEditor.addEventListener("blur",function(a){var b=a.target._editInfo.view;b._isCommitting||b._isCanceling||(b._isCommitting=!0,b.commitEditValue(a.target._editInfo,a.target))},!1),this._currentEditor.keepDefault=!0,this._currentEditor._editInfo=e,!this._currentEditor.parentNode){var i=this._currentEditor.style;i.position="absolute",i.margin="0px",i.border="0px",i.padding="0px",i.left=this._indent+this._propertyNameWidth+"px",i.top=c.rowDiv.style.top,i.width=c.valueRender.style.width,i.height=c.valueRender.style.height,this._rootDiv.appendChild(this._currentEditor)}Ib.Util.setFocus(this._currentEditor)}}}}),Ib.controls.PropertySheetInteraction=function(a){this.sheet=a,this.view=a._view,this.resizeDiv=a._resizeDiv;var b=this;this.view.addEventListener("mousedown",function(a){0===a.button&&b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Jb.ext("twaver.controls.PropertySheetInteraction",Object,{minGap:10,handleMouseDown:function(a){if(a.target!==this.sheet._currentEditor&&a.target.parentNode!==this.sheet._currentEditor&&(this.sheet.isFocusOnClick()&&Ib.Util.setFocus(this.view),!this.sheet._isValidating))if(a.target._expandData){var b=a.target._expandData;this.sheet.isExpanded(b)?this.sheet.collapse(b):this.sheet.expand(b)}else if(a.target===this.resizeDiv)this.lastX=this.getX(a),Wb.handle_mousedown(this,a);else{this.sheet._currentEditor&&!this.sheet._isCommitting&&(this.sheet._isCommitting=!0,this.sheet.commitEditValue(this.sheet._currentEditor._editInfo,this.sheet._currentEditor));var c=this.sheet.getRowIndexAt(a);this.sheet.updateCurrentRowIndex(c)}},handleMouseMove:function(a){if(null==this.lastX&&!Wb.target)return void this.changeCursor(a);if(Wb.target===this&&null!=this.lastX){var b=this.getX(a);if(null!=this.stopLeft){if(b<this.stopLeft)return;delete this.stopLeft}if(null!=this.stopRight){if(b>this.stopRight)return;delete this.stopRight}var c=this.sheet.getPropertyNameWidth()+(b-this.lastX);c<this.minGap?(c=this.minGap,this.stopLeft=b):c>this.sheet.getSumWidth()-this.minGap&&(c=this.sheet.getSumWidth()-this.minGap,this.stopRight=b),this.sheet.setPropertyNameWidth(c),this.lastX=b}},handleMouseUp:function(a){0===a.button&&(this.view.style.cursor="default",delete this.stopLeft,delete this.stopRight,delete this.lastX)},changeCursor:function(a){this.view.style.cursor=a.target===this.resizeDiv?"ew-resize":"default"},getX:function(a){return a.clientX/this.sheet.getZoom()}}),Ib.controls.PropertySheetTouchInteraction=function(a){this.sheet=a,this.view=a._view,this.resizeDiv=a._resizeDiv,Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.controls.PropertySheetTouchInteraction",Object,{minGap:10,handleTouchstart:function(a){Wb.preventDefault(a),a.target!==this.sheet._currentEditor&&a.target.parentNode!==this.sheet._currentEditor&&(this.sheet.isFocusOnClick()&&Ib.Util.setFocus(this.view),this.sheet._isValidating||(a.target===this.resizeDiv&&(this.lastX=this.getX(a)),this.lastPoint=this.sheet.getLogicalPoint(a),zc.isMultiTouch(a)&&(this.distance=zc.getDistance(a),this.zoom=this.sheet.getZoom()),Wb.addEventListener("touchmove","handleTouchmove",this.view,this),Wb.addEventListener("touchend","handleTouchend",this.view,this)))},handleTouchmove:function(a){if(Wb.preventDefault(a),this.moved||(this.moved=!0),null!=this.lastX){var b=this.getX(a);if(null!=this.stopLeft){if(b<this.stopLeft)return;delete this.stopLeft}if(null!=this.stopRight){if(b>this.stopRight)return;delete this.stopRight}var c=this.sheet.getPropertyNameWidth()+(b-this.lastX);c<this.minGap?(c=this.minGap,this.stopLeft=b):c>this.sheet.getSumWidth()-this.minGap&&(c=this.sheet.getSumWidth()-this.minGap,this.stopRight=b),this.sheet.setPropertyNameWidth(c),this.lastX=b}else if(zc.isSingleTouch(a)){if(this.lastPoint){var d=this.sheet.getLogicalPoint(a),e=this.lastPoint.x-d.x,f=this.lastPoint.y-d.y,g=this.sheet.panByOffset(e,f);this.lastPoint.x-=e-g.x,this.lastPoint.y-=f-g.y}}else if(this.distance){var h=zc.getDistance(a)/this.distance;this.sheet.setZoom(this.zoom*h,!1)}},handleTouchend:function(a){if(Wb.preventDefault(a),!this.moved)if(a.target._expandData){var b=a.target._expandData;this.sheet.isExpanded(b)?this.sheet.collapse(b):this.sheet.expand(b)}else if(a.target===this.resizeDiv);else{var c=this.sheet.getRowIndexAt(a);this.sheet.updateCurrentRowIndex(c)}delete this.stopLeft,delete this.stopRight,delete this.lastX,delete this.lastPoint,delete this.distance,delete this.zoom,delete this.moved,Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this)},getX:function(a){var b=a.changedTouches[0];return b.clientX}}),Ib.controls.PropertySheetMSTouchInteraction=function(a){this.sheet=a,this.view=a._view,this.resizeDiv=a._resizeDiv,this._pointerMap={},this._pointerIdArray=[];var b=this;this.view.addEventListener("MSPointerDown",function(a){b.handleTouchstart(a)},!1),this.view.addEventListener("MSPointerMove",function(a){b.handleTouchmove(a)},!1),this.view.addEventListener("MSPointerUp",function(a){b.handleTouchend(a)},!1),this.view.addEventListener("MSPointerCancel",function(a){b.handleTouchend(a)},!1),this.superHandleMouseDown=Ib.controls.PropertySheetMSTouchInteraction.superClass.handleMouseDown},Jb.ext("twaver.controls.PropertySheetMSTouchInteraction",Ib.controls.PropertySheetInteraction,{handleMouseDown:function(a){},handleTouchstart:function(a){a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),this._pointerMap[a.pointerId]||null==this.sheet.getLogicalPoint(a)||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length&&a.pointerType==a.MSPOINTER_TYPE_MOUSE&&this.superHandleMouseDown(a),1==this._pointerIdArray.length?(this._startTouchPoint=this.sheet.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.sheet.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.sheet.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE&&this._startTouchPoint){var c=this.sheet.getLogicalPoint(a);if(null==c)return;var d=this._startTouchPoint.x-c.x,e=this._startTouchPoint.y-c.y,f=this.sheet.panByOffset(d,e);this._startTouchPoint.x-=d-f.x,this._startTouchPoint.y-=e-f.y}},handleTouchend:function(a){if(1==this._pointerIdArray.length&&a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.sheet.getLogicalPoint(a),c=new Date;c.getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,b)<=20&&this.superHandleMouseDown(a)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Ib.controls.SplitPane=function(a,b,c,d){Ib.controls.SplitPane.superClass.constructor.apply(this,arguments),this._view=Wb.createView("hidden",!0),this._view.tabIndex=-1,this._dividerDiv=Wb.createDiv(),this._dividerDiv.tabIndex=-1,this._view.appendChild(this._dividerDiv),a&&this.setFirstView(a),b&&this.setNextView(b),c&&this.setOrientation(c),null!=d&&this.setPosition(d),this.setDividerDraggable(!0),this.invalidate();var e;e=Qb.isTouchable&&!Qb.isMSToucheable?Ib.controls.SplitPaneTouchInteraction:Ib.controls.SplitPaneInteraction,e&&new e(this)},Jb.ext("twaver.controls.SplitPane",Ib.controls.ControlBase,{__accessor:["orientation","dividerWidth","dividerBackground","dividerOpacity","maskBackground"],__bool:["dividerDraggable"],_position:Cd.SPLITPANE_POSITION,_orientation:Cd.SPLITPANE_ORIENTATION,_dividerWidth:Cd.SPLITPANE_DIVIDER_WIDTH,_dividerBackground:Cd.SPLITPANE_DIVIDER_BACKGROUND,_dividerOpacity:Cd.SPLITPANE_DIVIDER_OPACITY,_maskBackground:Cd.SPLITPANE_MASK_BACKGROUND,onPropertyChanged:function(a){this.invalidate()},getDividerDiv:function(){return this._dividerDiv},getPosition:function(){return this._position},setPosition:function(a){if(0>a&&(a=0),a>1&&(a=1),a!==this._position){var b=this._position;this._position=a,this.firePropertyChange("position",b,a)}},setFirstView:function(a){if(this._firstView!==a){var b=this._firstView;b&&this._view.removeChild(b.getView?b.getView():b),this._firstView=a,a&&(a.getView?this._view.insertBefore(a.getView(),this._dividerDiv):this._view.insertBefore(a,this._dividerDiv)),this.firePropertyChange("firstView",b,a)}},getFirstView:function(){return this._firstView},setNextView:function(a){if(this._nextView!==a){var b=this._nextView;b&&this._view.removeChild(b.getView?b.getView():b),this._nextView=a,a&&(a.getView?this._view.insertBefore(a.getView(),this._dividerDiv):this._view.insertBefore(a,this._dividerDiv)),this.firePropertyChange("nextView",b,a)}},getNextView:function(){return this._nextView},validateImpl:function(){var a=this._position,b=this._view.offsetWidth,c=this._view.offsetHeight,d=this._dividerWidth;if(d>=8||0===d?this._coverDiv&&(this._dividerDiv.removeChild(this._coverDiv),delete this._coverDiv):this._coverDiv||(this._coverDiv=Wb.createDiv(),this._coverDiv.tabIndex=-1,this._dividerDiv.appendChild(this._coverDiv)),"horizontal"===this._orientation){d>b&&(d=b);var e=(b-d)*a,f=b-d-e+1;Jb.setViewBounds(this._firstView,{x:0,y:0,width:e,height:c}),Jb.setViewBounds(this._nextView,{x:e+d,y:0,width:f,height:c}),Jb.setViewBounds(this._dividerDiv,{x:e,y:0,width:d,height:c}),this._dividerDiv.position=e,this._coverDiv&&Jb.setViewBounds(this._coverDiv,{x:d/2-4,y:0,width:8,height:c})}else{d>c&&(d=c);var g=(c-d)*a,h=c-d-g;Jb.setViewBounds(this._firstView,{x:0,y:0,width:b,height:g}),Jb.setViewBounds(this._nextView,{x:0,y:g+d,width:b,height:h}),Jb.setViewBounds(this._dividerDiv,{x:0,y:g,width:b,height:d}),this._dividerDiv.position=g,this._coverDiv&&Jb.setViewBounds(this._coverDiv,{x:0,y:d/2-4,width:b,height:8})}var i=this._dividerDiv.style;i.background=this._dividerBackground}}),Ib.controls.SplitPaneInteraction=function(a){this.splitPane=a,this.view=a._view,this.dividerDiv=a._dividerDiv;var b=this;this.view.addEventListener("mousedown",function(a){0===a.button&&b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Jb.ext("twaver.controls.SplitPaneInteraction",Object,{handleMouseDown:function(a){if(this.splitPane.isDividerDraggable())if(this.resizeDiv)this.clear(a);else if(a.target===this.dividerDiv||a.target===this.splitPane._coverDiv){this.resizeDiv=Wb.createDiv();var b=this.resizeDiv.style;b.left=this.dividerDiv.style.left,b.top=this.dividerDiv.style.top,b.width=this.dividerDiv.style.width,b.height=this.dividerDiv.style.height,b.opacity=this.splitPane.getDividerOpacity(),b.background=this.splitPane.getDividerBackground(),this.resizeDiv.lastPosition="horizontal"===this.splitPane._orientation?a.clientX:a.clientY,this.resizeDiv.maskDiv=Wb.createDiv(),b=this.resizeDiv.maskDiv.style,b.left="0px",b.top="0px",b.width=this.view.clientWidth+"px",b.height=this.view.clientHeight+"px",b.background=this.splitPane.getMaskBackground(),this.view.appendChild(this.resizeDiv.maskDiv),this.view.appendChild(this.resizeDiv),Wb.handle_mousedown(this,a),a.preventDefault()}},handleMouseMove:function(a){if(this.splitPane.isDividerDraggable())if(this.resizeDiv||Wb.target)this.resizeDiv&&Wb.target===this&&("horizontal"===this.splitPane._orientation?this.resizeDiv.style.left=this.dividerDiv.position+a.clientX-this.resizeDiv.lastPosition+"px":this.resizeDiv.style.top=this.dividerDiv.position+a.clientY-this.resizeDiv.lastPosition+"px");else{var b="horizontal"===this.splitPane._orientation?"ew-resize":"ns-resize";this.view.style.cursor=a.target===this.dividerDiv||a.target===this.splitPane._coverDiv?b:"default"}},handleMouseUp:function(a){this.splitPane.isDividerDraggable()&&0===a.button&&this.clear(a)},clear:function(a){if(this.resizeDiv){var b,c=this.splitPane._dividerWidth;if("horizontal"===this.splitPane._orientation){var d=this.view.clientWidth;c>d&&(c=d),b=this.dividerDiv.position+a.clientX-this.resizeDiv.lastPosition,this.splitPane.setPosition(b/(d-c))}else{var e=this.view.clientHeight;c>e&&(c=e),b=this.dividerDiv.position+a.clientY-this.resizeDiv.lastPosition,this.splitPane.setPosition(b/(e-c))}this.view.removeChild(this.resizeDiv.maskDiv),this.view.removeChild(this.resizeDiv),delete this.resizeDiv}}}),Ib.controls.SplitPaneTouchInteraction=function(a){this.splitPane=a,this.view=a._view,this.dividerDiv=a._dividerDiv,Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.controls.SplitPaneTouchInteraction",Object,{handleTouchstart:function(a){if(Wb.preventDefault(a),this.resizeDiv)this.clear(a);else if(a.target===this.dividerDiv||a.target===this.splitPane._coverDiv){this.resizeDiv=Wb.createDiv();var b=this.resizeDiv.style;b.left=this.dividerDiv.style.left,b.top=this.dividerDiv.style.top,b.width=this.dividerDiv.style.width,b.height=this.dividerDiv.style.height,b.opacity=this.splitPane.getDividerOpacity(),b.background=this.splitPane.getDividerBackground();var c=a.changedTouches[0];this.resizeDiv.lastPosition="horizontal"===this.splitPane._orientation?c.clientX:c.clientY,this.resizeDiv.maskDiv=Wb.createDiv();var b=this.resizeDiv.maskDiv.style;b.left="0px",b.top="0px",b.width=this.view.clientWidth+"px",b.height=this.view.clientHeight+"px",b.background=this.splitPane.getMaskBackground(),this.view.appendChild(this.resizeDiv.maskDiv),this.view.appendChild(this.resizeDiv)}Wb.addEventListener("touchmove","handleTouchmove",this.view,this),Wb.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(Wb.preventDefault(a),this.resizeDiv){var b=a.changedTouches[0];"horizontal"===this.splitPane._orientation?this.resizeDiv.style.left=this.dividerDiv.position+b.clientX-this.resizeDiv.lastPosition+"px":this.resizeDiv.style.top=this.dividerDiv.position+b.clientY-this.resizeDiv.lastPosition+"px"}else;},handleTouchend:function(a){Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this),this.clear(a)},clear:function(a){var b=a.changedTouches[0];if(this.resizeDiv){var c=this.splitPane._dividerWidth;if("horizontal"===this.splitPane._orientation){var d=this.view.clientWidth;c>d&&(c=d);var e=this.dividerDiv.position+b.clientX-this.resizeDiv.lastPosition;this.splitPane.setPosition(e/(d-c))}else{var f=this.view.clientHeight;c>f&&(c=f);var e=this.dividerDiv.position+b.clientY-this.resizeDiv.lastPosition;this.splitPane.setPosition(e/(f-c))}this.view.removeChild(this.resizeDiv.maskDiv),this.view.removeChild(this.resizeDiv),delete this.resizeDiv}}}),Ib.controls.TabPane=function(){Ib.controls.TabPane.superClass.constructor.apply(this,arguments),this._tabBox=new Ib.TabBox,this._tabBox.addServaChangeListener(this.handleTabChange,this),this._tabBox.addDataPropertyChangeListener(this.handleTabChange,this),this._tabBox.addHierarchyChangeListener(this.handleTabChange,this),this._tabBox.getSelectionContainer().addSelectionChangeListener(this.handleTabChange,this),this._view=Wb.createView("hidden",!0),this._tabDiv=Wb.createDiv(),this._tabDiv.onmousedown=Wb.preventDefault,this._tabDiv.onkeydown=Wb.preventDefault,this._contentDiv=Wb.createDiv(),this._view.appendChild(this._tabDiv),this._view.appendChild(this._contentDiv),this._divPool=new Ib.Pool("div"),this._iconPool=new Ib.Pool("img"),this._closePool=new Ib.Pool("img"),this._textPool=new Ib.Pool("span"),this._resizePool=new Ib.Pool("div"),this._pools.add(this._divPool),this._pools.add(this._iconPool),this._pools.add(this._closePool),this._pools.add(this._textPool),this._pools.add(this._resizePool),this.invalidateTab();var a;a=Qb.isTouchable&&!Qb.isMSToucheable?Ib.controls.TabPaneTouchInteraction:Ib.controls.TabPaneInteraction,a&&new a(this)},Jb.ext("twaver.controls.TabPane",Ib.controls.ControlBase,{__accessor:["tabGap","tabRadius","tabHeight","horizontalAlign","tabOrientation","resizeTolerance","tabBackground","selectBackground","moveBackground","insertBackground","closeIcon","disabledColor"],__bool:["selectNextOnClose","selectNextOnInVisible"],_tabGap:Cd.TABPANE_TAB_GAP,_tabRadius:Cd.TABPANE_TAB_RADIUS,_tabHeight:Cd.TABPANE_TAB_HEIGHT,_resizeTolerance:Cd.TABPANE_RESIZE_TOLERANCE,_tabOrientation:Cd.TABPANE_TAB_ORIENTATION,_tabBackground:Cd.TABPANE_TAB_BACKGROUND,_disabledColor:Cd.TABPANE_DISABLED_COLOR,_selectBackground:Cd.TABPANE_SELECT_BACKGROUND,_moveBackground:Cd.TABPANE_MOVE_BACKGROUND,_insertBackground:Cd.TABPANE_INSERT_BACKGROUND,_horizontalAlign:Cd.TABPANE_HORIZONTAL_ALIGN,_closeIcon:Cd.TABPANE_CLOSE_ICON,_selectNextOnClose:Cd.TABPANE_SELECT_NEXT_ON_CLOSE,_selectNextOnInVisible:Cd.TABPANE_SELECT_NEXT_ON_INVISIBLE,onPropertyChanged:function(a){this.invalidateTab()},getTabBox:function(){return this._tabBox},getTabDiv:function(){return this._tabDiv},getContentDiv:function(){return this._contentDiv},handleTabChange:function(a){if(this._selectNextOnInVisible&&"visible"===a.property&&!a.newValue&&this._tabBox.getSelectionContainer().contains(a.source)){for(var b,c,d=a.source,e=this._tabBox.getRoots().indexOf(d),f=this._tabBox.getRoots(),g=f.size(),h=e;g-1>h;)if(b=f.get(++h),b.isVisible()&&!b.isDisabled()){c=b;break}if(!c)for(h=e;h>0;)if(b=f.get(--h),b.isVisible()&&!b.isDisabled()){c=b;break}this._tabBox.getSelectionContainer().setSelection(c)}this.invalidateTab()},invalidateTab:function(a){this._invalidateTab||(this._invalidateTab=!0,this.invalidate(a))},validateImpl:function(){this._invalidateTab&&(this._invalidateTab=!1,this.validateTab());var a,b=this._view.offsetWidth,c=this._view.offsetHeight;"top"===this._tabOrientation?(this._tabDiv.style.top="0px",a={x:0,y:this._tabHeight,width:b,height:Math.max(0,c-this._tabHeight)}):(this._tabDiv.style.top=c-this._tabHeight+"px",a={x:0,y:0,width:b,height:Math.max(0,c-this._tabHeight)}),this._currentView&&Jb.setViewBounds(this._currentView,a)},getCurrentTab:function(){return this._currentTab},getCurrentView:function(){return this._currentView},onViewRemoved:function(a){},onViewAdded:function(a){},validateTab:function(){this._currentTab=this._tabBox.getSelectionContainer().getLastData();var a=this._currentTab?this._currentTab.getView():null;if(a!==this._currentView){var b,c;this._currentView&&(b=this._currentView.getView?this._currentView.getView():this._currentView,b.style.visibility="hidden",this.onViewRemoved(this._currentView)),a&&(c=a.getView?a.getView():a,c.style.visibility="inherit",c.parentNode||this._contentDiv.appendChild(c),this.onViewAdded(a)),this._currentView=a}Wb.release(this._tabDiv);for(var d=this._tabBox.getRoots(),e=this._tabHeight+"px",f=this._tabHeight-2+"px",g=this._tabRadius+"px",h=d.size(),i=0,j=0;h>j;j++){var k=d.get(j);if(k.isVisible()){var l=this._currentTab===k,m=k.getWidth();0>m&&(m=0);var n=Math.min(this._tabGap,m),o=this._divPool.get();o._tab=k;var p=o.style;p.position="absolute",p.whiteSpace="nowrap",p.lineHeight=f,p.overflow="hidden",p.textOverflow="ellipsis",p.background=l?this._selectBackground:this._tabBackground,p.textAlign=this._horizontalAlign,"top"===this._tabOrientation?(p.borderTopLeftRadius=g,p.borderTopRightRadius=g,p.borderBottomLeftRadius="0px",p.borderBottomRightRadius="0px"):(p.borderTopLeftRadius="0px",p.borderTopRightRadius="0px",p.borderBottomLeftRadius=g,p.borderBottomRightRadius=g),p.left=i+"px",p.width=m-n+"px",p.height=e,o._x=i,o._width=m-n,this.renderTab(o,k),this.onTabRendered(o,k),this._tabDiv.insertBefore(o,this._tabDiv.firstChild),i+=m,k.isResizable()&&(o=this._resizePool.get(),o._resizeTab=k,p=o.style,p.position="absolute",p.backgroundColor="white",p.opacity=0,p.left=i-n-this._resizeTolerance+"px",p.width=n+2*this._resizeTolerance+"px",p.height=e,this._tabDiv.appendChild(o))}}this._tabDiv.style.left="0px",this._tabDiv.style.width=i+"px",this._tabDiv.style.height=this._tabHeight+"px",this._pools.forEach(function(a){a.clear()})},renderTab:function(a,b){if(b.renderTab)b.renderTab(a);else{var c=b.getIcon();if(c){var d=this._iconPool.get();d.setAttribute("src",Jb.getImageSrc(c)),d.style.paddingLeft="4px",d.style.verticalAlign="middle",a.appendChild(d)}var e=b.getName();if(e){var f=this._textPool.get();f.style.whiteSpace="nowrap",f.style.verticalAlign="middle",f.style.padding="2px 4px",f.innerHTML=e,a.appendChild(f)}if(Qb.isOpera){var g=a.cloneNode(!1);g.style.left="0px",g.style.top="0px",g.style.opacity=0,a.appendChild(g)}}if(b.isClosable()){var h=this._tabRadius/4+2,d=this._closePool.get();d._closeTab=b,d.setAttribute("src",Jb.getImageSrc(this._closeIcon)),d.style.position="absolute",d.style.top=h+"px",d.style.right=h+"px",a.appendChild(d)}a.style.color=b.isDisabled()?this.getDisabledColor():""},onTabRendered:function(a,b){}}),Ib.controls.TabPaneInteraction=function(a){this.tabPane=a,this.view=a.getTabDiv();var b=this;this.view.addEventListener("mousedown",function(a){b.handleMouseDown(a)},!1),this.view.addEventListener("mousemove",function(a){b.handleMouseMove(a)},!1)},Jb.ext("twaver.controls.TabPaneInteraction",Object,{handleMouseDown:function(a){if(0===a.button){if(this.movableDiv)return void this.handleMouseUp(a);this.resizeTab=a.target._resizeTab,this.resizeTab||(this.movableDiv=this.getMovableDivAt(a)),this.changeCursor(a),this.lastX=this.getX(a),this._startClient=Wb.getClientPoint(a),this._startLogicalX=this.lastX,Wb.handle_mousedown(this,a)}},changeCursor:function(a){var b="";if(a.target._resizeTab)b="ew-resize";else{var c=this.getTabAt(a);!c||c.isDisabled()&&!c.isMovable()||(b="pointer")}this.view.style.cursor=b},handleMouseMove:function(a){if(null==this.lastX)return void this.changeCursor(a);if(Wb.target===this){var b=this._startLogicalX+a.clientX-this._startClient.x;if(this.resizeTab){if(null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeTab.getWidth()+(b-this.lastX);10>c&&(c=10,this.stopX=b),this.resizeTab.setWidth(c),this.lastX=b}else if(this.movableDiv){var d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.tabPane.getMoveBackground(),this.insertDiv=Wb.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.tabPane.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.tabInfo=this.getTabInfoAt(a),this.tabInfo&&(this.insertDiv.style.left=this.tabInfo.position)}}},handleMouseUp:function(a){if(0===a.button){if(this.resizeTab);else if(this.movableDiv&&this.tabInfo){var b=this.movableDiv._tab,c=this.tabInfo.index;this.tabPane.getTabBox().moveTo(b,c)}else{var d=this.tabPane.getTabBox(),b=a.target._closeTab;if(b)if(this.tabPane.isSelectNextOnClose()&&this.tabPane.getCurrentTab()===b){var e=d.getRoots(),c=e.indexOf(b);d.remove(b),e.size()>0&&(c>=e.size()&&(c=e.size()-1),d.getSelectionContainer().setSelection(e.get(c)))}else d.remove(b);else{var b=this.getTabAt(a);b&&!b.isDisabled()&&d.getSelectionContainer().setSelection(b)}}this.clear()}},clear:function(){this.view.style.cursor="",this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.tabInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeTab,delete this.stopX,delete this.lastX,delete this._startLogicalX,delete this._startClient},getTabAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Wb.getLogicalPoint(this.view,a);return b?b.x:null},getTabInfoAt:function(a){for(var b=this._startLogicalX+a.clientX-this._startClient.x,c=this.tabPane.getTabBox().getRoots(),d=c.size(),e=0,f=!1,g=0;d>g;g++){var h=c.get(g);if(h===this.movableDiv._tab&&(f=!0),h.isVisible()){var i=h.getWidth();if(0>=i)continue;if(b>=e&&e+i>=b){var j=e+i/2>b;!f||h===this.movableDiv._tab&&j||g--;var k=j?Math.max(0,g):Math.min(g+1,d),l=j?e:e+i;return l=Math.max(0,l-1),{index:k,tab:h,position:l+"px"}}e+=i}}return this.tabInfo}}),Ib.controls.TabPaneTouchInteraction=function(a){this.tabPane=a,this.view=a.getTabDiv(),Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.controls.TabPaneTouchInteraction",Object,{handleTouchstart:function(a){return Wb.preventDefault(a),this.movableDiv?void this.handleTouchend(a):(this.resizeTab=a.target._resizeTab,this.resizeTab||(this.movableDiv=this.getMovableDivAt(a)),this.lastX=this.getX(a),Wb.addEventListener("touchmove","handleTouchmove",this.view,this),void Wb.addEventListener("touchend","handleTouchend",this.view,this))},handleTouchmove:function(a){if(null!=this.lastX)if(this.resizeTab){var b=this.getX(a);if(null!=this.stopX){if(b<this.stopX)return;delete this.stopX}var c=this.resizeTab.getWidth()+(b-this.lastX);0>c&&(c=0,this.stopX=b),this.resizeTab.setWidth(c),this.lastX=b}else if(this.movableDiv){var b=this.getX(a),d=b-this.lastX;if(!this.cloneDiv){if(Math.abs(d)<3)return;this.cloneDiv=this.movableDiv.cloneNode(!0),this.cloneDiv._x=this.movableDiv._x,this.cloneDiv.style.background=this.tabPane.getMoveBackground(),this.insertDiv=Wb.createDiv(),this.insertDiv.style.width="1px",this.insertDiv.style.height=this.cloneDiv.style.height,this.insertDiv.style.background=this.tabPane.getInsertBackground(),this.movableDiv.parentNode.appendChild(this.cloneDiv),this.movableDiv.parentNode.appendChild(this.insertDiv)}var e=this.cloneDiv._x+d;this.cloneDiv.style.left=e+"px",this.cloneDiv._x=e,this.lastX=b,this.tabInfo=this.getTabInfoAt(a),this.tabInfo&&(this.insertDiv.style.left=this.tabInfo.position)}},handleTouchend:function(a){if(this.resizeTab);else if(this.movableDiv&&this.tabInfo){var b=this.movableDiv._tab,c=this.tabInfo.index;this.tabPane.getTabBox().moveTo(b,c)}else{var d=this.tabPane.getTabBox(),b=a.target._closeTab;if(b)if(this.tabPane.isSelectNextOnClose()&&this.tabPane.getCurrentTab()===b){var e=d.getRoots(),c=e.indexOf(b);d.remove(b),e.size()>0&&(c>=e.size()&&(c=e.size()-1),d.getSelectionContainer().setSelection(e.get(c)))}else d.remove(b);else{var b=this.getTabAt(a);b&&!b.isDisabled()&&d.getSelectionContainer().setSelection(b)}}this.clear(),Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this)},clear:function(){this.cloneDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.cloneDiv),this.insertDiv&&this.movableDiv&&this.movableDiv.parentNode.removeChild(this.insertDiv),delete this.movableDiv,delete this.tabInfo,delete this.insertDiv,delete this.cloneDiv,delete this.resizeTab,delete this.stopX,delete this.lastX},getTabAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b},getMovableDivAt:function(a){a=a.target;for(var b;a&&a!==this.view&&!(b=a._tab);)a=a.parentNode;return b&&b.isMovable()?a:null},getX:function(a){var b=Wb.getLogicalPoint(this.view,a);return b?b.x:null},getTabInfoAt:function(a){for(var b=this.getX(a),c=this.tabPane.getTabBox().getRoots(),d=c.size(),e=0,f=!1,g=0;d>g;g++){var h=c.get(g);if(h===this.movableDiv._tab&&(f=!0),h.isVisible()){var i=h.getWidth();if(0>=i)continue;if(b>=e&&e+i>=b){var j=e+i/2>b;!f||h===this.movableDiv._tab&&j||g--;var k=j?Math.max(0,g):Math.min(g+1,d),l=j?e:e+i;return l=Math.max(0,l-1),{index:k,tab:h,position:l+"px"}}e+=i}}return this.tabInfo}}),Ib.controls.TitlePane=function(a,b,c){Ib.controls.TitlePane.superClass.constructor.apply(this,arguments),this.invalidate(),this._titleDiv=Wb.createDiv(),this._titleDiv.tabIndex=-1,this._titleDiv.style.verticalAlign="middle",this._titleDiv.style.fontWeight="bold",this._titleDiv.style.textOverflow="ellipsis",this._titleDiv.style.overflow="hidden",this._titleDiv.style.whiteSpace="nowrap",this._titleDiv.onmousedown=Wb.preventDefault,this._span=Ob.createElement("span"),this._span.style.verticalAlign="middle",this._span.style.paddingLeft="4px",this._span.style.paddingRight="4px",this._img=Ob.createElement("img"),this._img.style.verticalAlign="middle",this._img.style.paddingLeft="4px",this._view=Wb.createView("hidden",!0),this._view.tabIndex=-1,this._view.appendChild(this._titleDiv),b&&this.setTitle(b),a&&this.setContent(a),c&&this.setIcon(c)},Jb.ext("twaver.controls.TitlePane",Ib.controls.ControlBase,{__accessor:["icon","title","titleHeight","titleHorizontalAlign","titleBackground"],_titleHeight:Cd.TITLEPANE_TITLE_HEIGHT,_titleBackground:Cd.TITLEPANE_TITLE_BACKGROUND,_titleHorizontalAlign:Cd.TITLEPANE_TITLE_HORIZONTAL_ALIGN,onPropertyChanged:function(a){this.invalidate()},getTitleDiv:function(){return this._titleDiv},getContent:function(){return this._content},setContent:function(a){if(this._content!==a){var b=this._content;b&&this._view.removeChild(b.getView?b.getView():b),this._content=a,a&&this._view.appendChild(a.getView?a.getView():a),this.firePropertyChange("content",b,a)}},validateImpl:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight,c=this._titleDiv.style;c.textAlign=this._titleHorizontalAlign,c.lineHeight=this._titleHeight-2+"px",c.background=this._titleBackground,Wb.clear(this._titleDiv),this._icon&&(this._img.setAttribute("src",Jb.getImageSrc(this._icon)),this._titleDiv.appendChild(this._img)),this._title&&(this._span.innerHTML=this._title,this._span.setAttribute("title",this._title),this._titleDiv.appendChild(this._span));var c=this._titleDiv.style;c.left="0px",c.top="0px",c.width=a+"px",c.height=this._titleHeight+"px",Jb.setViewBounds(this._content,{x:0,y:this._titleHeight,width:a,height:Math.max(b-this._titleHeight,0)})}}),Ib.controls.Accordion=function(){Ib.controls.Accordion.superClass.constructor.apply(this,arguments),this._titleMap={},this._titleList=new md,this._currentTitle=null,this._currentView=null,this._view=Wb.createView("hidden",!0),this.invalidate();var a=this;this._view.addEventListener("mousedown",function(b){a.handleMouseDown(b)},!1)},Jb.ext("twaver.controls.Accordion",Ib.controls.ControlBase,{__accessor:["expandIcon","collapseIcon","titleHeight","titleBackground","borderBottomColor","iconPosition"],_expandIcon:Cd.ACCORDION_EXPAND_ICON,_collapseIcon:Cd.ACCORDION_COLLAPSE_ICON,_titleHeight:Cd.ACCORDION_TITLE_HEIGHT,_titleBackground:Cd.ACCORDION_TITLE_BACKGROUND,_borderBottomColor:Cd.ACCORDION_BORDER_BOTTOM_COLOR,_iconPosition:Cd.ACCORDION_ICON_POSITION,onPropertyChanged:function(a){this.invalidate()},handleMouseDown:function(a){if(0===a.button){var b=a.target._title;b||(b=a.target.parentNode._title),b&&(this._currentTitle===b?this.collapse():this.expand(b))}},getTitles:function(){return this._titleList},getCurrentTitle:function(){return this._currentTitle},add:function(a,b){if(this._titleMap[a])throw"Title ' + title + ' already exists";

var c=Wb.createDiv();c._title=a,c.onmousedown=Wb.preventDefault,c.style.cursor="pointer",c.style.textAlign="left",c.style.textOverflow="ellipsis",c.style.whiteSpace="nowrap",c.style.overflow="hidden",c.style.borderBottomWidth="1px",c.style.borderBottomStyle="solid";var d=Ob.createElement("img");d.style.verticalAlign="middle",d.style.paddingLeft="4px";var e=Ob.createElement("span");if(e.style.verticalAlign="middle",e.style.paddingLeft="4px",e.innerHTML=a,e.setAttribute("title",a),this._view.appendChild(c),c.appendChild(d),c.appendChild(e),"right"==this._iconPosition){var f=d.style,g=(this._titleHeight-8)/2;f.marginTop=g+"px",f.right="15px",f.position="absolute"}this._titleMap[a]={content:b,titleDiv:c,span:e,img:d},this._titleList.add(a),this.invalidate()},remove:function(a){var b=this._titleMap[a];b&&this._view.removeChild(b.titleDiv),delete this._titleMap[a],this._titleList.remove(a),this.invalidate()},clear:function(){var a=this;Object.keys(a._titleMap).forEach(function(b){a._view.removeChild(a._titleMap[b].titleDiv)}),a._titleMap={},a._titleList.clear(),a.invalidate()},expand:function(a){this._titleMap[a]&&this._currentTitle!==a&&(this._currentTitle=a,this.onExpanded(a),this.invalidate())},onExpanded:function(a){},collapse:function(){this._currentTitle&&(this.onCollapsed(this._currentTitle),this._currentTitle=null,this.invalidate())},onCollapsed:function(a){},validateImpl:function(){var a=this._currentView;this._currentView=null;for(var b=this._view.offsetWidth,c=this._view.offsetHeight,d=this._titleList.size(),e=0,f=0;d>f;f++){var g=this._titleList.get(f),h=this._titleMap[g],i=h.titleDiv.style;i.lineHeight=this._titleHeight-3+"px",i.background=this._titleBackground,i.borderBottomColor=this._borderBottomColor,i.left="0px",i.top=e+"px",i.width=b+"px",i.height=this._titleHeight-1+"px";var j=this._currentTitle===g,k=j?this._expandIcon:this._collapseIcon;if(h.img.setAttribute("src",Jb.getImageSrc(k)),j){var l=Math.max(0,c-d*this._titleHeight);h.content&&(this._currentView=h.content.getView?h.content.getView():h.content,Jb.setViewBounds(h.content,{x:0,y:e+this._titleHeight,width:b,height:l})),e+=this._titleHeight+l}else e+=this._titleHeight}this._currentView&&this._currentView!==a&&this._view.appendChild(this._currentView),a&&a!==this._currentView&&this._view.removeChild(a)}}),Ib.controls.BorderPane=function(a,b,c,d,e){Ib.controls.BorderPane.superClass.constructor.apply(this,arguments),this.invalidate(),this._view=Wb.createView("hidden",!0),this._view.tabIndex=-1,a&&this.setCenter(a),b&&this.setTop(b),c&&this.setRight(c),d&&this.setBottom(d),e&&this.setLeft(e)},Jb.ext("twaver.controls.BorderPane",Ib.controls.ControlBase,{__accessor:["hGap","vGap","topHeight","bottomHeight","leftWidth","rightWidth"],_hGap:Cd.BORDERPANE_HGAP,_vGap:Cd.BORDERPANE_VGAP,_topHeight:0,_bottomHeight:0,_leftWidth:0,_rightWidth:0,onPropertyChanged:function(a){this.invalidate()},getCenter:function(){return this._center},setCenter:function(a){this._setContent("center",a)},getTop:function(){return this._top},setTop:function(a){this._setContent("top",a)},getRight:function(){return this._right},setRight:function(a){this._setContent("right",a)},getBottom:function(){return this._bottom},setBottom:function(a){this._setContent("bottom",a)},getLeft:function(){return this._left},setLeft:function(a){this._setContent("left",a)},_setContent:function(a,b){var c=this["_"+a];if(c!==b){if(c){var d=c.getView?c.getView():c;this._view.contains(d)&&this._view.removeChild(d)}this["_"+a]=b,b&&this._view.appendChild(b.getView?b.getView():b),this.firePropertyChange(a,c,b)}},validateImpl:function(){var a=this._view.offsetWidth,b=this._view.offsetHeight,c=0,d=0,e=a,f=b,g=0,h=0,i=0,j=0;this._top&&(g=this._topHeight||(this._top.getView?this._top.getView().offsetHeight:this._top.offsetHeight),d=g+this._vGap),this._bottom&&(h=this._bottomHeight||(this._bottom.getView?this._bottom.getView().offsetHeight:this._bottom.offsetHeight),f=b-h-this._vGap),this._left&&(i=this._leftWidth||(this._left.getView?this._left.getView().offsetWidth:this._left.offsetWidth),c=i+this._hGap),this._right&&(j=this._rightWidth||(this._right.getView?this._right.getView().offsetWidth:this._right.offsetWidth),e=a-j-this._hGap);var k=Math.max(0,e-c),l=Math.max(0,f-d);this._top&&Jb.setViewBounds(this._top,{x:0,y:0,width:a,height:g}),this._bottom&&Jb.setViewBounds(this._bottom,{x:0,y:f,width:a,height:h}),this._left&&Jb.setViewBounds(this._left,{x:0,y:d,width:i,height:l}),this._right&&Jb.setViewBounds(this._right,{x:e,y:d,width:j,height:l}),this._center&&Jb.setViewBounds(this._center,{x:c,y:d,width:k,height:l})}}),Ib.controls.PopupMenu=function(a){this._view=Wb.createDiv(),this._view.style.zIndex=100001,this._items=[],this._itemsMap={},this.setContextView(a);var b=this._view,c=this;b.addEventListener("mouseover",function(a){c._mouseOver=!0},!1),b.addEventListener("mouseout",function(a){c._mouseOver=!1},!1),b.oncontextmenu=function(a){a.preventDefault()},Wb.addEventListener("mousedown","_handleClick",b,this)},Jb.ext("twaver.controls.PopupMenu",Object,{_width:200,_menuItemHeight:25,_background:"#F9F9F9",_border:"2px outset white",_disabledColor:"#BABBBC",_focusColor:"#C2CFF1",_subMenuEnableIcon:Cd.POPUPMENU_SUBNENU_ENABLE_ICON,_subMenuDisableIcon:Cd.POPUPMENU_SUBNENU_DISABLE_ICON,_checkboxSelectedIcon:Cd.POPUPMENU_CHECKBOX_SELECTED_ICON,_checkboxUnselectedIcon:Cd.POPUPMENU_CHECKBOX_UNSELECTED_ICON,_radiobuttonSelectedIcon:Cd.POPUPMENU_RADIOBUTTON_SELECTED_ICON,_radiobuttonUnselectedIcon:Cd.POPUPMENU_RADIOBUTTON_UNSELECTED_ICON,getView:function(){return this._view},getContextView:function(){return this._contextView},setContextView:function(a){if(this._removeContextmenuListener(),this._contextView=a,a){var b=a.getView?a.getView():a;Qb.isTouchable?(b.addEventListener("touchstart",this._getTouchStartListener(),!1),b.addEventListener("touchmove",this._getTouchMoveListener(),!1),b.addEventListener("touchend",this._getTouchEndListener(),!1)):Wb.addEventListener("contextmenu","_handleContextmenu",b,this)}},getMenuItems:function(){return this._items},setMenuItems:function(a){if(this._items=[],this._itemsMap={},a)for(var b=0,c=a.length;c>b;b++)this.addMenuItem(a[b])},addMenuItem:function(a){a.separator!==!0&&(this._itemsMap[a.id||a.label]=a),this._items.push(a)},getMenuItem:function(a){return this._itemsMap[a]},addSeparator:function(){this.addMenuItem({separator:!0})},getMenuItemById:function(a){return this._itemsMap[a]},isVisible:function(a){return a.visible!==!1},isEnabled:function(a){return a.enabled!==!1},show:function(a){this.hide();var b,c,d=this._view,e=this._view.style;if(Qb.isTouchable?(b=a.changedTouches[0].clientX,c=a.changedTouches[0].clientY):(b=a.clientX,c=a.clientY),Wb.clear(d),this.renderMenu(d,this._items),0!==this._height){Wb.addEventListener(Qb.isTouchable?"touchstart":"mousedown","_handleBodyClicked",Ob.body,this);var f=Wb.windowWidth()-this._width-10,g=Wb.windowHeight()-this._height-10;b=b>f?f:b,c=c>g?g:c,b=0>b?0:b,c=0>c?0:c,e.left=b+zc.scrollLeft()+"px",e.top=c+zc.scrollTop()+"px",Ob.body.appendChild(d)}},_showMenuItem:function(a,b){this._hideMenuItem(b);var c=Ob.createElement("div");b.menuItem.childrenDiv=c;var d=c.style;d.color="#000000",d.position="absolute";var e=this._width,f=b.offsetTop,g=b.menuItem.items;if(this._itemsShow=!0,b.appendChild(c),Wb.clear(c),this.renderMenu(c,g),0!==this._height){var h=Wb.windowWidth()-this._width-10,i=Wb.windowHeight()-10,j=this._getPosition(this._view);e=j.left+this._width>h?-this._width:e,f=j.top+f+g.length*this._menuItemHeight>i?f-(g.length-1)*this._menuItemHeight:f,d.left=e+"px",d.top=f+"px",b.appendChild(c)}},hide:function(){Ob.body.contains(this._view)&&Ob.body.removeChild(this._view),delete this._mouseOver,delete this._itemsShow,Wb.removeEventListener(Qb.isTouchable?"touchstart":"mousedown",Ob.body,this)},_hideMenuItem:function(a){var b=a.menuItem.childrenDiv;b&&a.contains(b)&&a.removeChild(b),this._itemsShow=!1},dispose:function(){this._removeContextmenuListener(),this.hide()},onMenuShowing:function(a){return!0},onAction:function(a){},renderMenu:function(a,b){var c=a.style;c.background=this._background,c.border=this._border,c.width=this._width+"px",this._height=0,delete this._separator;for(var d,e=0,f=b.length;f>e;e++)if(d=b[e],this.isVisible(d))if(d.separator===!0)this._separator=!0;else{var g=Ob.createElement("div");this.isEnabled(d)&&this._addMouseoverListener(g,d),g.menuItem=d,a.appendChild(g),this.renderMenuItem(g,d),this.onMenuItemRendered(g,d),this._separator=!1,this._height+=this._menuItemHeight}},renderMenuItem:function(a,b){var c=a.style;c.height=this._menuItemHeight+"px",this._separator&&(c.borderTop="1px solid gray"),this.isEnabled(b)||(c.color=this._disabledColor);var d=Ob.createElement("span");c=d.style,c.position="absolute",c.width="25px",c.height=this._menuItemHeight+"px",c.lineHeight=this._menuItemHeight+"px",c.textAlign="center",a.appendChild(d);var e;if("check"===b.type?e=b.selected?this._checkboxSelectedIcon:this._checkboxUnselectedIcon:"radio"===b.type?e=b.selected?this._radiobuttonSelectedIcon:this._radiobuttonUnselectedIcon:b.icon&&(e=b.icon),e){var f=new Pb;f.src=Jb.getImageSrc(e),f.style.verticalAlign="middle",d.appendChild(f)}var g=Ob.createElement("label");if(Jb.setText(g,b.label,!0),c=g.style,c.position="absolute",c.height=this._menuItemHeight+"px",c.lineHeight=this._menuItemHeight+"px",c.left="25px",a.appendChild(g),b.items&&a.parentNode===this._view){var h=Ob.createElement("img");c=h.style,this.isEnabled(b)?h.setAttribute("src",Jb.getImageSrc(this._subMenuEnableIcon)):h.setAttribute("src",Jb.getImageSrc(this._subMenuDisableIcon));var i=(this._menuItemHeight-8)/2;c.marginTop=i+"px",c.right="5px",c.position="absolute",a.appendChild(h)}},onMenuItemRendered:function(a,b){},_addMouseoverListener:function(a,b){var c=this;a.addEventListener(Qb.isTouchable?"touchstart":"mouseover",function(d){a.style.background=c._focusColor,a.style.color="#FFFFFF",this===d.relatedTarget||this.contains(d.relatedTarget)||b.items&&!c._itemsShow&&a.parentNode==c._view&&c._showMenuItem(d,a)},!1),a.addEventListener(Qb.isTouchable?"touchend":"mouseout",function(d){if(a.style.background=c._background,a.style.color="#000000",this!==d.relatedTarget&&!this.contains(d.relatedTarget)&&b.items&&a.parentNode===c._view){var e=d.clientX,f=d.clientY,g=b.childrenDiv,h=c._getPosition(g);(e<h.left+2||e>h.left+g.offsetWidth-2||f<h.top+2||f>h.top+g.offsetHeight-2)&&c._hideMenuItem(a)}},!1)},_getPosition:function(a){for(var b=0,c=0;a;)c+=a.offsetLeft,b+=a.offsetTop,a=a.offsetParent;return{left:c,top:b}},_removeContextmenuListener:function(){var a=this._contextView;a&&(a=a.getView?a.getView():a,Qb.isTouchable?(a.removeEventListener("touchstart",this._getTouchStartListener(),!1),a.removeEventListener("touchmove",this._getTouchMoveListener(),!1),a.removeEventListener("touchend",this._getTouchEndListener(),!1)):Wb.removeEventListener("contextmenu",a,this))},_handleContextmenu:function(a){this.onMenuShowing(a)===!0&&this.show(a),a.preventDefault()},_handleBodyClicked:function(a){if(Qb.isTouchable){for(var b=a.target;b&&b!==this._view;)b=b.parentElement;b!==this._view&&this.hide()}else this._mouseOver||this.hide()},_handleClick:function(a){if(0===a.button){for(var b=a.target;!b.menuItem&&b.parentElement;)b=b.parentElement;var c=b?b.menuItem:null;c&&this.isEnabled(c)&&("check"===c.type&&(c.selected=!c.selected),"radio"===c.type&&(c.groupName?(c.selected=!0,this._items.forEach(function(a){c!==a&&a.groupName===c.groupName&&(a.selected=!1),a.items&&a.items.forEach(function(a){c!==a&&a.groupName===c.groupName&&(a.selected=!1)})})):c.selected=!c.selected),c.action&&c.action(c),this.onAction(c),c.items&&c.items.length>0||this.hide())}},_getTouchStartListener:function(){if(!this._touchStartListener){var a=this;this._touchStartListener=function(b){a._touchMoved=!1,a._lastTouch=new Date}}return this._touchStartListener},_getTouchMoveListener:function(){if(!this._touchMoveListener){var a=this;this._touchMoveListener=function(b){a._touchMoved=!0}}return this._touchMoveListener},_getTouchEndListener:function(){if(!this._touchEndListener){var a=this;this._touchEndListener=function(b){!a._touchMoved&&(new Date).getTime()-a._lastTouch.getTime()>1e3&&a._handleContextmenu(b)}}return this._touchEndListener},getWidth:function(){return this._width},setWidth:function(a){this._width=a},getMenuItemHeight:function(){return this._menuItemHeight},setMenuItemHeight:function(a){this._menuItemHeight=a},getBackground:function(){return this._background},setBackground:function(a){this._background=a},getBorder:function(){return this._border},setBorder:function(a){this._border=a},getDisabledColor:function(){return this._disabledColor},setDisabledColor:function(a){this._disabledColor=a},getFocusColor:function(){return this._focusColor},setFocusColor:function(a){this._focusColor=a},getSubMenuEnableIcon:function(){return this._subMenuEnableIcon},setSubMenuEnableIcon:function(a){this._subMenuEnableIcon=a},getSubMenuDisableIcon:function(){return this._subMenuDisableIcon},setSubMenuDisableIcon:function(a){this._subMenuDisableIcon=a},getCheckboxSelectedIcon:function(){return this._checkboxSelectedIcon},setCheckboxSelectedIcon:function(a){this._checkboxSelectedIcon=a},getCheckboxUnselectedIcon:function(){return this._checkboxUnselectedIcon},setCheckboxUnselectedIcon:function(a){this._checkboxUnselectedIcon=a},getRadiobuttonSelectedIcon:function(){return this._radiobuttonSelectedIcon},setRadiobuttonSelectedIcon:function(a){this._radiobuttonSelectedIcon=a},getRadiobuttonUnselectedIcon:function(){return this._radiobuttonUnselectedIcon},setRadiobuttonUnselectedIcon:function(a){this._radiobuttonUnselectedIcon=a}}),Ib.charts.IS_INVALIDATE_PROPERTY={xZoom:1,xTranslate:1,yZoom:1,yTranslate:1},Ib.charts.ChartBase=function(a){Ib.charts.ChartBase.superClass.constructor.apply(this,arguments),this._uniqueColors={},this._nonDataColors={},this._publishedDatas=new md,this._view=Wb.createView("hidden"),this._canvas=Wb.createCanvas(),this._view.appendChild(this._canvas),this.setServa(a?a:new Ib.ElementBox),this.invalidate();var b;b=Qb.isMSToucheable?Ib.charts.ChartMSTouchInteraction:Qb.isTouchable?Ib.charts.ChartTouchInteraction:Ib.charts.ChartInteraction,b&&new b(this),this.setToolTipEnabled(Cd.CHART_TOOLTIP_ENABLED)},Jb.ext("twaver.charts.ChartBase",Ib.controls.ViewBase,{__accessor:["xGap","yGap","xTranslate","yTranslate","valueVisible","sortFunction","visibleFunction","xTranslateEnabled","yTranslateEnabled","xZoomEnabled","yZoomEnabled","selectTolerance","backgroundVisible","backgroundFill","backgroundFillColor","backgroundOutlineWidth","backgroundOutlineColor","backgroundGradient","backgroundGradientColor","outerZoom"],__bool:["doubleClickToReset","focusOnClick"],_backgroundVisible:Cd.CHART_BACKGROUND_VISIBLE,_backgroundFill:Cd.CHART_BACKGROUND_FILL,_backgroundFillColor:Cd.CHART_BACKGROUND_FILL_COLOR,_backgroundOutlineWidth:Cd.CHART_BACKGROUND_OUTLINE_WIDTH,_backgroundOutlineColor:Cd.CHART_BACKGROUND_OUTLINE_COLOR,_backgroundGradient:Cd.CHART_BACKGROUND_GRADIENT,_backgroundGradientColor:Cd.CHART_BACKGROUND_GRADIENT_COLOR,_selectTolerance:Cd.CHART_SELECT_TOLERANCE,_doubleClickToReset:Cd.CHART_DOUBLE_CLICK_TO_RESET,_focusOnClick:Cd.FOCUS_ON_CLICK,_sortFunction:null,_visibleFunction:null,_canvasWidth:0,_canvasHeight:0,_outerZoomL:1,_xGap:Cd.CHART_XGAP,_yGap:Cd.CHART_YGAP,_xTranslate:0,_yTranslate:0,_xTranslateEnabled:Cd.CHART_XTRANSLATE_ENABLED,_yTranslateEnabled:Cd.CHART_YTRANSLATE_ENABLED,_xZoom:1,_yZoom:1,_maxZoom:Cd.ZOOM_MAX,_minZoom:Cd.ZOOM_MIN,_xZoomEnabled:Cd.CHART_XZOOM_ENABLED,_yZoomEnabled:Cd.CHART_YZOOM_ENABLED,_valueVisible:Cd.CHART_VALUE_VISIBLE,_valueFont:Cd.CHART_VALUE_FONT,isToolTipEnabled:function(){return this._toolTipListener?!0:!1},setToolTipEnabled:function(a){if(a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){Bc.showToolTip(a,b.getToolTip(a))},this._canvas.addEventListener("mousemove",this._toolTipListener,!0),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Bc.hideToolTip(),this._canvas.removeEventListener("mousemove",this._toolTipListener,!0),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},getToolTip:function(a){if(this._toolTipInfos){var b=this.getLogicalPoint(a);b.x-=this._xTranslate,b.y-=this._yTranslate;for(var c=this._toolTipInfos.size(),d=c-1;d>=0;d--){var e=this._toolTipInfos.get(d);if(e.rect&&Tb.containsPoint(e.rect,b))return this.getToolTipByData(e.data,e)}}else{var f=this.tryGetDataAt(a);if(f)return this.getToolTipByData(f,{value:this.getValue(f)})}return null},getToolTipByData:function(a,c){return c.value!==b?this.formatValueText(c.value,a):null},addToolTipInfo:function(a,b,c,d,e,f,g){this._toolTipInfos&&this._toolTipInfos.add({data:f,rect:{x:a,y:b,width:c,height:d},value:e,index:g})},getLogicalPoint:function(a){return Wb.getLogicalPoint(this._canvas,a,this._outerZoom)},getTextSize:function(a,b){var c=Xb.getTextSize(a,b);return c.width&&(c.width+=4),c},getUniqueColor:function(a,c){if(null==a)return null;var d;if(!c&&(d=this._nonDataColors[a]))return d;var e=Xb.getColorArray(a);if(!c)return d=255!=e[3]?a:"rgba("+e[0]+","+e[1]+","+e[2]+",0.99)",this._nonDataColors[a]=d,d;var f="rgb("+e[0]+","+e[1]+","+e[2]+")";if(this._uniqueColors[f]===b||this._uniqueColors[f]===c);else{var g=1,h=-1,i=1;for(Qb.isOpera&&(e=[e[0],e[1],e[2]]);;){if(e[0]+=g,e[0]>=255?(e[0]=255,g=-1):e[0]<=0&&(e[0]=0,g=1),f="rgb("+e[0]+","+e[1]+","+e[2]+")",this._uniqueColors[f]===b||this._uniqueColors[f]===c)break;if(e[1]+=h,e[1]>=255?(e[1]=255,h=-1):e[1]<=0&&(e[1]=0,h=1),f="rgb("+e[0]+","+e[1]+","+e[2]+")",this._uniqueColors[f]===b||this._uniqueColors[f]===c)break;if(e[2]+=i,e[2]>=255?(e[2]=255,i=-1):e[2]<=0&&(e[2]=0,i=1),f="rgb("+e[0]+","+e[1]+","+e[2]+")",this._uniqueColors[f]===b||this._uniqueColors[f]===c)break}}return this._uniqueColors[f]=c,f},tryGetDataAt:function(a,b){if((null==b||0>b)&&(b=this._selectTolerance),a.target&&(a=Wb.getLogicalPoint(this._canvas,arguments[0],this._outerZoom)),!a)return null;var c=a.x-b,d=a.y-b,e=2*b+1,f=2*b+1;try{for(var g=this._canvas.getContext("2d").getImageData(c,d,e,f).data,h=0,i=g.length;i>h;h+=4)if(255===g[h+3]){var j="rgb("+g[h]+","+g[h+1]+","+g[h+2]+")",k=this._uniqueColors[j];if(k)return k}}catch(l){}return null},_getPoint:function(){var a,b;if(2===arguments.length)a=arguments[0],b=arguments[1];else if(arguments[0].target){var c=Wb.getLogicalPoint(this._canvas,arguments[0],this._outerZoom);if(!c)return null;a=c.x,b=c.y}else a=arguments[0].x,b=arguments[0].y;return{x:a,y:b}},getDataAt:function(){var a=this._getPoint.apply(this,arguments),b=a.x,c=a.y;if(0>b||0>c||b>this._canvasWidth||c>this._canvasHeight)return null;try{var d=this._canvas.getContext("2d").getImageData(b,c,1,1).data;if(255===d[3]){var e="rgb("+d[0]+","+d[1]+","+d[2]+")",f=this._uniqueColors[e];if(f)return f}}catch(g){}return null},getBackgroundRect:function(){return this._backgroundRect},drawBackground:function(a,b){this._backgroundRect=Jb.clone(b),null!=b&&b.width>0&&b.height>0&&this._backgroundVisible&&(this._backgroundFill&&Xb.fill(a,this.getUniqueColor(this._backgroundFillColor),this._backgroundGradient,this.getUniqueColor(this._backgroundGradientColor),b),this._backgroundOutlineWidth>0&&(a.lineWidth=this._backgroundOutlineWidth,a.strokeStyle=this._backgroundOutlineColor),a.beginPath(),a.rect(b.x,b.y,b.width,b.height),a.closePath(),this._backgroundFill&&a.fill(),this._backgroundOutlineWidth>0&&a.stroke())},getName:function(a){return a.getName()},getColor:function(a){return a.getStyle?a.getStyle("chart.color"):a.getClient("chart.color")},getValue:function(a){return a.getStyle?a.getStyle("chart.value"):0},getValueColor:function(a){return a.getStyle?a.getStyle("chart.value.color"):Ib.Styles.getStyle("chart.value.color")},setValueFont:function(a){if(a!==this._valueFont){var b=a;this._valueFont=a,this.firePropertyChange("valueFont",b,a)}},getValueFont:function(a){if(a){var b=a.getStyle?a.getStyle("chart.value.font"):Ib.Styles.getStyle("chart.value.font");if(b)return b}return this._valueFont},formatValueText:function(a,b){return a},getCanvasWidth:function(){return this._canvasWidth},getCanvasHeight:function(){return this.canvasHeight},getCanvas:function(){return this._canvas},isVisible:function(a){return this._internalVisibleFunction&&!this._internalVisibleFunction(a)?!1:this._visibleFunction?this._visibleFunction(a):!0},onPropertyChanged:function(a){Ib.charts.IS_INVALIDATE_PROPERTY[a.property]?this.invalidate():this.invalidateContainer()},getServa:function(){return this._box},setServa:function(a){if(!a)throw"Serva can not be null";if(this._box!==a){var b=this._box;b&&(b.removeServaChangeListener(this.handleServaChange,this),b.removeDataPropertyChangeListener(this.handlePropertyChange,this),b.removeHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionContainer||b.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addServaChangeListener(this.handleServaChange,this),this._box.addDataPropertyChangeListener(this.handlePropertyChange,this),this._box.addHierarchyChangeListener(this.handleHierarchyChange,this),this._selectionContainer?this._selectionContainer._setServa(a):this._box.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this.invalidateContainer(),this.firePropertyChange("dataBox",b,this._box)}},handleServaChange:function(a){this.invalidateContainer()},handlePropertyChange:function(a){this.invalidateContainer()},handleHierarchyChange:function(a){this.invalidateContainer()},handleSelectionChange:function(a){this.invalidateContainer()},getUnfilteredDatas:function(){return this._unfilteredDatas?this._unfilteredDatas:this._publishedDatas},getPublishedDatas:function(){return this._publishedDatas},createPublishedDatas:function(){return this._unfilteredDatas=new md,this._buildChildren(this._box.getRoots(),this._unfilteredDatas),this._sortFunction&&this._unfilteredDatas.sort(this._sortFunction),this._unfilteredDatas.toList(this.isVisible,this)},_buildChildren:function(a,b){a.forEach(function(a){b.add(a),this._buildChildren(a.getChildren(),b)},this)},invalidateContainer:function(){this._invalidateContainer||(this._invalidateContainer=!0,this.invalidate())},validateImpl:function(){this._invalidateContainer&&(this._invalidateContainer=!1,this._uniqueColors={},this._nonDataColors={},this._publishedDatas=this.createPublishedDatas(),this._publishedDatas.forEach(function(a){a.IStyle?a.getStyle("chart.color")||a.setStyle("chart.color",Jb.nextColor()):a.getClient("chart.color")||a.setClient("chart.color",Jb.nextColor())}),this.validateContainer());var a=this._canvas.getContext("2d");this._canvasWidth=this._view.clientWidth,this._canvasHeight=this._view.clientHeight,this._canvas.setAttribute("width",this._canvasWidth),this._canvas.setAttribute("height",this._canvasHeight),a.clearRect(0,0,this._canvasWidth,this._canvasHeight),this._canvasWidth>0&&this._canvasHeight>0&&(a.translate(this._xTranslate,this._yTranslate),this._valueTexts=this._valueVisible?new md:null,this.validateDisplay(a,this._canvasWidth*this._xZoom,this._canvasHeight*this._yZoom),delete this._valueTexts,a.translate(-this._xTranslate,-this._yTranslate))},validateContainer:function(){},validateDisplay:function(a,b,c){},drawLine:function(a,b,c,d,e,f,g){c>0&&(a.lineWidth=c,a.strokeStyle=this.getUniqueColor(b),a.beginPath(),a.moveTo(d,e),a.lineTo(f,g),a.stroke())},drawValueTexts:function(a){this._valueTexts&&this._valueTexts.forEach(function(b){Xb.drawText(a,b.text,b,b.font,b.color)})},drawVerticalText:function(a,b,c,d,e){e=this.getUniqueColor(e),a.translate(c.x,c.y),a.rotate(-Math.PI/2),Xb.drawText(a,b,null,d,e),a.rotate(Math.PI/2),a.translate(-c.x,-c.y)},_getValueTextInfo:function(a,b){if(this._valueTexts){var c=this.formatValueText(b,a);if(c&&""!==c){var d=this.getValueColor(a),e={text:c,font:this.getValueFont(a),color:this.getUniqueColor(d,a)};return this._valueTexts.add(e),e}}return null},getMaxZoom:function(){return this._maxZoom},setMaxZoom:function(a){if(!(0>a)){var b=this._maxZoom;this._maxZoom=a,this.firePropertyChange("maxZoom",b,a),this.getXZoom()>a&&this.setXZoom(a,!1),this.getYZoom()>a&&this.setYZoom(a,!1)}},getMinZoom:function(){return this._minZoom},setMinZoom:function(a){if(!(0>a)){var b=this._minZoom;this._minZoom=a,this.firePropertyChange("minZoom",b,a),this.getXZoom()<a&&this.setXZoom(a),this.getYZoom()<a&&this.setYZoom(a)}},zoomIn:function(a){null==a&&(a=Cd.ZOOM_ANIMATE),a?Ib.animate.AnimateManager.start(new Ib.animate.AnimateXYZoom(this,this._xZoom*Cd.ZOOM_INCREMENT,this._yZoom*Cd.ZOOM_INCREMENT)):(this.xZoomIn(!1),this.yZoomIn(!1))},zoomOut:function(a){null==a&&(a=Cd.ZOOM_ANIMATE),a?Ib.animate.AnimateManager.start(new Ib.animate.AnimateXYZoom(this,this._xZoom/Cd.ZOOM_INCREMENT,this._yZoom/Cd.ZOOM_INCREMENT)):(this.xZoomOut(!1),this.yZoomOut(!1))},zoomReset:function(a){null==a&&(a=Cd.ZOOM_ANIMATE),a?Ib.animate.AnimateManager.start(new Ib.animate.AnimateXYZoom(this,1,1)):(this.xZoomReset(!1),this.yZoomReset(!1))},getXZoom:function(){return this._xZoom},onXZoomChanged:function(a,b){},xZoomIn:function(a){this.setXZoom(this._xZoom*Cd.ZOOM_INCREMENT,a)},xZoomOut:function(a){this.setXZoom(this._xZoom/Cd.ZOOM_INCREMENT,a)},xZoomReset:function(a){this.setXZoom(1,a)},setXZoom:function(a,b){if(Jb.num(a)&&!(0>=a)&&(a<this._minZoom&&(a=this._minZoom),a>this._maxZoom&&(a=this._maxZoom),a!==this.xZoom))if(null==b&&(b=Cd.ZOOM_ANIMATE),b)Ib.animate.AnimateManager.start(new Ib.animate.AnimateXZoom(this,a));else{var c=this._xZoom,d=this._xTranslate-(this._canvasWidth/2-this._xTranslate)/c*(a-c);this._xZoom=a,this.firePropertyChange("xZoom",c,a),this.onXZoomChanged(c,a),this.setXTranslate(d)}},getYZoom:function(){return this._yZoom},onYZoomChanged:function(a,b){},yZoomIn:function(a){this.setYZoom(this._yZoom*Cd.ZOOM_INCREMENT,a)},yZoomOut:function(a){this.setYZoom(this._yZoom/Cd.ZOOM_INCREMENT,a)},yZoomReset:function(a){this.setYZoom(1,a)},setYZoom:function(a,b){if(Jb.num(a)&&!(0>=a)&&(a<this._minZoom&&(a=this._minZoom),a>this._maxZoom&&(a=this._maxZoom),a!==this.YZoom))if(null==b&&(b=Cd.ZOOM_ANIMATE),b)Ib.animate.AnimateManager.start(new Ib.animate.AnimateYZoom(this,a));else{var c=this._yZoom,d=this._yTranslate-(this._canvasHeight/2-this._yTranslate)/c*(a-c);this._yZoom=a,this.firePropertyChange("yZoom",c,a),this.onYZoomChanged(c,a),this.setYTranslate(d)}}}),Ib.charts.ScaleChart=function(a){Ib.charts.ScaleChart.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.charts.ScaleChart",Ib.charts.ChartBase,{__accessor:["upperLimit","lowerLimit","xAxisText","xAxisLineColor","xAxisLineWidth","xAxisTextColor","xAxisTextFont","yAxisText","yAxisLineColor","yAxisLineWidth","yAxisTextColor","yAxisTextFont","xScaleTexts","xScaleTextFont","xScaleTextColor","xScaleTextOrientation","yScaleTextVisible","yScaleTextColor","yScaleTextFont","yScaleLineColor","yScaleLineWidth","yScaleValueGap","yScalePixelGap","yScaleMinTextVisible","valueSpanCount"],_reset:function(){this._map={},this._max=0,this._min=0,this._columnCount=this._xScaleTexts?this._xScaleTexts.size():0,null!=this._upperLimit&&(this._max=this._upperLimit),null!=this._lowerLimit&&(this._min=this._lowerLimit)},getMin:function(){return this._min},getMax:function(){return this._max},getRange:function(){return this._range},getColumnCount:function(){return this._columnCount},getColumnWidth:function(){return this._columnWidth},getValues:function(a){return a.getStyle?a.getStyle("chart.values"):null},formatYScaleText:function(a){return a.toFixed(2)},_initRange:function(){null==this._lowerLimit&&(this._min>=this._max&&(this._min=this._max-.1*Math.abs(this._max)),this._min=this._min-.1*(this._max-this._min)),this._range=this._max-this._min},_initValuesProportion:function(){this._publishedDatas.forEach(function(a){var b=this._map[a.getId()];b.values.forEach(function(a){b.proportions.add(null==a?null:0==this._range?0:a/this._range)},this)},this)},_commonValidateContainer:function(){this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a));b.size()>this._columnCount&&(this._columnCount=b.size());var c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a)};this._initInfo&&this._initInfo(a,c),this._map[a.getId()]=c,(null==this._upperLimit||null==this._lowerLimit)&&b.forEach(function(a){null!=a&&(null==this._upperLimit&&a>this._max&&(this._max=a),null==this._lowerLimit&&a<this._min&&(this._min=a))},this)},this),this._initRange(),this._initValuesProportion()},validateDisplay:function(a,b,c){var d=0;this._xAxisText&&(d=this.getTextSize(this._xAxisTextFont,this._xAxisText).height);var e=0;this._xScaleTexts&&this._xScaleTexts.forEach(function(a){var b=this.getTextSize(this._xScaleTextFont,a),c="vertical"===this._xScaleTextOrientation?b.width:b.height;c>e&&(e=c)},this);var f=c-this._yGap-d-e,g=f-this._yGap,h=null==this._upperLimit?.9*g:g,i=0;this._yAxisText&&(i=this.getTextSize(this._yAxisTextFont,this._yAxisText).height);var j,k;this._yScaleValueGap>0?(j=Math.max(this._yScaleValueGap/this._range*h,1),k=this._yScaleValueGap):(j=Math.max(this._yScalePixelGap,1),k=this._range*(j/h));var l,m,n=0,o=new md;if(this._yScaleTextVisible){l=this._yScaleMinTextVisible?0:j;for(var p=this._min+(this._yScaleMinTextVisible?0:k);g+1>=l;){if(m=this.formatYScaleText(p)){var q=this.getTextSize(this._yScaleTextFont,m);q.width>n&&(n=q.width),o.add({text:m,size:q,cursor:l})}l+=j,p+=k}}var r={x:this._xGap+i+n,y:this._yGap,width:b-this._xGap-i-n-this._xGap,height:c-this._yGap-e-d-this._yGap};if(this.drawBackground(a,r),this._columnWidth=this._columnCount>0?r.width/(3*this._columnCount+1)*2:r.width/2,0===this._columnWidth&&(this._columnWidth=1),this._yScaleLineWidth>0)for(l=0;g+1>=l;)this.drawLine(a,this._yScaleLineColor,this._yScaleLineWidth,r.x,f-l,r.x+r.width,f-l),l+=j;this._xAxisText&&Xb.drawText(a,this._xAxisText,{x:r.x+r.width/2,y:f+e+d/2},this._xAxisTextFont,this.getUniqueColor(this._xAxisTextColor)),this._yAxisText&&this.drawVerticalText(a,this._yAxisText,{x:this._xGap+i/2,y:g/2+this._yGap},this._yAxisTextFont,this.getUniqueColor(this._yAxisTextColor)),this.drawLine(a,this._yAxisLineColor,this._yAxisLineWidth,r.x,r.y+r.height,r.x,r.y);var s=this.getUniqueColor(this._yScaleTextColor);o.forEach(function(b){var c={x:this._xGap+i+n-b.size.width/2,y:f-b.cursor};Xb.drawText(a,b.text,c,this._yScaleTextFont,s)},this);var t=r.y+r.height+e/2;s=this.getUniqueColor(this._xScaleTextColor);for(var u=this._xScaleLineWidth>0?this.getUniqueColor(this._xScaleLineColor):null,v=0;v<this._columnCount;v++){var w=r.x+this._columnWidth*(1+1.5*v);if(this._xScaleTexts&&v<this._xScaleTexts.size()&&(m=this._xScaleTexts.get(v))){var x={x:w,y:t};"vertical"===this._xScaleTextOrientation?this.drawVerticalText(a,m,x,this._yScaleTextFont,s):this._valueSpanCount?v%this._valueSpanCount==0&&Xb.drawText(a,m,x,this._xScaleTextFont,s):Xb.drawText(a,m,x,this._xScaleTextFont,s)}"default"!==this._type&&u&&(this._valueSpanCount?v%this._valueSpanCount==0&&this.drawLine(a,u,this._xScaleLineWidth,w,r.y+r.height,w,r.y):this.drawLine(a,u,this._xScaleLineWidth,w,r.y+r.height,w,r.y))}var y=f+this._min/k*j;this._publishedDatas.size()>0&&this._columnCount>0&&this.drawContent(a,r,h,y),this.drawLine(a,this._xAxisLineColor,this._xAxisLineWidth,r.x,r.y+r.height,r.x+r.width,r.y+r.height)}}),Ib.charts.PieChart=function(a){this._sum=0,this._map={},Ib.charts.PieChart.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.charts.PieChart",Ib.charts.ChartBase,{__accessor:["type","selectOffset","startAngle","shadowColor","shadowOffset","lineRate","donutRate","valuePosition"],_type:Cd.PIECHART_TYPE,_lineRate:Cd.PIECHART_LINE_RATE,_donutRate:Cd.PIECHART_DONUT_RATE,_startAngle:Cd.PIECHART_START_ANGLE,_shadowColor:Cd.PIECHART_SHADOW_COLOR,_shadowOffset:Cd.PIECHART_SHADOW_OFFSET,_selectOffset:Cd.PIECHART_SELECT_OFFSET,_valuePosition:Cd.PIECHART_VALUE_POSITION,getSum:function(){return this._sum},validateContainer:function(){this._sum=0,this._map={},this._publishedDatas.forEach(function(a){var b=this.getValue(a);this._map[a.getId()]={
data:a,value:b,color:this.getUniqueColor(this.getColor(a),a)},this._sum+=b},this);var a=this._startAngle;this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];c.proportion=0===this._sum?0:c.value/this._sum,"line"!==this._type&&(c.startAngle=a,c.arc=c.proportion*Math.PI*2,a+=c.arc)},this)},validateDisplay:function(a,b,c){var d={x:this._xGap,y:this._yGap,width:b-2*this._xGap,height:c-2*this._yGap};if(this.drawBackground(a,d),Tb.grow(d,-4,-4),!(d.width<=0||d.height<=0)){var e=this._shadowOffset;if(e>0&&(a.shadowOffsetX=e,a.shadowOffsetY=e,a.shadowBlur=1.5*e,a.shadowColor=this._shadowColor),"oval"===this._type||"circle"===this._type){var f=d.x+d.width/2,g=d.y+d.height/2,h=d.width/2,i=d.height/2;"circle"===this._type&&(h=i=Math.min(h,i)),this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];if(0!==c.arc){var d=0,e=0;if(this.isSelected(b)){var j=c.startAngle+c.arc/2;d=Math.cos(j)*this._selectOffset,e=Math.sin(j)*this._selectOffset*i/h}a.fillStyle=c.color,a.beginPath(),a.moveTo(f+d,g-e),Xb.drawArc(a,f+d,g-e,c.startAngle,c.arc,h,i,!0),a.closePath(),a.fill();var k=this._getValueTextInfo(b,c.value);if(k){var j=c.startAngle+c.arc/2;k.x=f+d+Math.cos(j)*h*this._valuePosition,k.y=g-e-Math.sin(j)*i*this._valuePosition}}},this)}else if("donut"===this._type||"ovalDonut"===this._type){var f=d.x+d.width/2,g=d.y+d.height/2,h=d.width/2,i=d.height/2;"donut"===this._type&&(h=i=Math.min(h,i)),this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];if(0!==c.arc){var d=0,e=0;if(this.isSelected(b)){var j=c.startAngle+c.arc/2;d=Math.cos(j)*this._selectOffset,e=Math.sin(j)*this._selectOffset*i/h}var k=f+Math.cos(c.startAngle)*h*this._donutRate,l=g-Math.sin(c.startAngle)*i*this._donutRate,m=f+Math.cos(c.startAngle+c.arc)*h*this._donutRate,n=g-Math.sin(c.startAngle+c.arc)*i*this._donutRate;a.fillStyle=c.color,a.beginPath(),a.moveTo(k+d,l-e),Xb.drawArc(a,f+d,g-e,c.startAngle,c.arc,h,i,!0),a.lineTo(m+d,n-e),Xb.drawArc(a,f+d,g-e,c.startAngle+c.arc,-c.arc,h*this._donutRate,i*this._donutRate,!0),a.closePath(),a.fill();var o=this._getValueTextInfo(b,c.value);if(o){var j=c.startAngle+c.arc/2,p=this._donutRate+(1-this._donutRate)*this._valuePosition;o.x=f+d+Math.cos(j)*h*p,o.y=g-e-Math.sin(j)*i*p}}},this)}else if("line"===this._type){var j=d.height*this._lineRate;d.y=d.y+d.height/2-j/2,d.height=j;var k=d.x;this._publishedDatas.forEach(function(b){var c=this._map[b.getId()],e=d.width*c.proportion;if(0!==e){a.beginPath(),a.fillStyle=c.color;var f=this.isSelected(b)?-this._selectOffset:0;a.rect(k,d.y+f,e,d.height),a.closePath(),a.fill();var g=this._getValueTextInfo(b,c.value);g&&(g.x=k+e/2,g.y=d.y+d.height+f-d.height*this._valuePosition),k+=e}},this)}this._shadowOffset>0&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0),this.drawValueTexts(a)}}}),Ib.charts.BarChart=function(a){Ib.charts.BarChart.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.charts.BarChart",Ib.charts.ScaleChart,{__accessor:["type"],_upperLimit:Cd.BARCHART_UPPER_LIMIT,_lowerLimit:Cd.BARCHART_LOWER_LIMIT,_type:Cd.BARCHART_TYPE,_xAxisText:null,_xAxisTextColor:Cd.BARCHART_XAXIS_TEXT_COLOR,_xAxisTextFont:Cd.BARCHART_XAXIS_TEXT_FONT,_xAxisLineColor:Cd.BARCHART_XAXIS_LINE_COLOR,_xAxisLineWidth:Cd.BARCHART_XAXIS_LINE_WIDTH,_yAxisText:null,_yAxisTextColor:Cd.BARCHART_YAXIS_TEXT_COLOR,_yAxisTextFont:Cd.BARCHART_YAXIS_TEXT_FONT,_yAxisLineColor:Cd.BARCHART_YAXIS_LINE_COLOR,_yAxisLineWidth:Cd.BARCHART_YAXIS_LINE_WIDTH,_xScaleTexts:null,_xScaleTextFont:Cd.BARCHART_XSCALE_TEXT_FONT,_xScaleTextColor:Cd.BARCHART_XSCALE_TEXT_COLOR,_xScaleTextOrientation:Cd.BARCHART_XSCALE_TEXT_ORIENTATION,_yScaleTextVisible:Cd.BARCHART_YSCALE_TEXT_VISIBLE,_yScaleTextColor:Cd.BARCHART_YSCALE_TEXT_COLOR,_yScaleTextFont:Cd.BARCHART_YSCALE_TEXT_FONT,_yScaleLineColor:Cd.BARCHART_YSCALE_LINE_COLOR,_yScaleLineWidth:Cd.BARCHART_YSCALE_LINE_WIDTH,_yScaleValueGap:Cd.BARCHART_YSCALE_VALUE_GAP,_yScalePixelGap:Cd.BARCHART_YSCALE_PIXEL_GAP,_yScaleMinTextVisible:Cd.BARCHART_YSCALE_MIN_TEXT_VISIBLE,validateContainer:function(){var a=this._type+"ValidateContainer";this[a]&&(this._reset(),this[a]())},defaultValidateContainer:function(){this._columnCount=this._publishedDatas.size(),this._publishedDatas.forEach(function(a){var b=this.getValue(a);null==this._upperLimit&&b>this._max&&(this._max=b),null==this._lowerLimit&&b<this._min&&(this._min=b),this._map[a.getId()]={data:a,value:b,color:this.getUniqueColor(this.getColor(a),a)}},this),this._initRange(),this._publishedDatas.forEach(function(a){var b=this._map[a.getId()];b.proportion=0==this._range?0:b.value/this._range},this)},layerValidateContainer:function(){this._commonValidateContainer()},groupValidateContainer:function(){this._commonValidateContainer()},stackValidateContainer:function(){if(this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a));b.size()>this._columnCount&&(this._columnCount=b.size());var c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a)};this._map[a.getId()]=c},this),null==this._upperLimit||null==this._lowerLimit)for(var a=0;a<this._columnCount;a++){var b=0,c=0;this._publishedDatas.forEach(function(d){var e=this._map[d.getId()];if(e.values.size()>a){var f=e.values.get(a);null!=f&&(f>=0?b+=f:c+=f)}},this),null==this._upperLimit&&b>this._max&&(this._max=b),null==this._lowerLimit&&c<this._min&&(this._min=c)}this._initRange(),this._initValuesProportion()},percentValidateContainer:function(){this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a));b.size()>this._columnCount&&(this._columnCount=b.size());var c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a)};this._map[a.getId()]=c},this);for(var a=new md,b=0;b<this._columnCount;b++){var c=0;this._publishedDatas.forEach(function(a){var d=this._map[a.getId()];if(d.values.size()>b){var e=d.values.get(b);null!=e&&(c+=e)}},this),a.add(c)}for(var b=0;b<this._columnCount;b++)this._publishedDatas.forEach(function(c){var d=this._map[c.getId()],e=a.get(b);if(0!==e&&d.values.size()>b){var f=d.values.get(b);if(null!=f)return void d.proportions.add(f/e)}d.proportions.add(null)},this);this._min=0,this._max=1,this._range=1},drawRect:function(a,b,c,d,e,f,g){a.fillStyle=b,c&&this._selectInfos.add({x:d,y:e,w:f,h:g,color:this.getUniqueColor(Xb.darker(b))}),a.beginPath(),a.rect(d,e,f,g),a.closePath(),a.fill()},drawContent:function(a,b,c,d){this._selectInfos=new md,this._toolTipInfos=this.isToolTipEnabled()?new md:null,"default"===this._type?this.drawDefaultContent(a,b,c,d):"group"===this._type?this.drawGroupContent(a,b,c,d):"percent"===this._type?this.drawPercentContent(a,b,c,d):"stack"===this._type?this.drawStackContent(a,b,c,d):"layer"===this._type&&this.drawLayerContent(a,b,c,d),this.drawValueTexts(a),this._selectInfos.forEach(function(b){a.lineWidth=2,a.strokeStyle=b.color,a.beginPath(),a.rect(b.x,b.y,b.w,b.h),a.closePath(),a.stroke()},this),delete this._selectInfos},drawDefaultContent:function(a,b,c,d){for(var e=this._publishedDatas.size(),f=this._columnWidth,g=0;e>g;g++){var h=this._publishedDatas.get(g),i=this._map[h.getId()],j=b.x+f*(.5+1.5*g),k=Math.abs(c*i.proportion),l=i.proportion>0?d-k:d;this.drawRect(a,i.color,this.isSelected(h),j,l,f,k),this.addToolTipInfo(j,l,f,k,i.value,h);var m=this._getValueTextInfo(h,i.value);if(m){var n=this.getTextSize(m.font,m.text);m.x=j+f/2,m.y=l-n.height/2+1}}},drawPercentContent:function(a,b,c,d){this.drawStackContent(a,b,c,d)},drawStackContent:function(a,b,c,d){for(var e=this._columnCount,f=this._columnWidth,g=0;e>g;g++){var h=d,i=b.x+f*(.5+1.5*g);this._publishedDatas.forEach(function(b){var d=this._map[b.getId()];if(g<d.proportions.size()){var e=d.proportions.get(g);if(null!=e){var j=c*e;h-=j,this.drawRect(a,d.color,this.isSelected(b),i,h,f,j),this.addToolTipInfo(i,h,f,j,d.values.get(g),b);var k=this._getValueTextInfo(b,d.values.get(g));k&&(k.x=i+f/2,k.y=h+j/2)}}},this)}},drawLayerContent:function(a,b,c,d){for(var e=this._publishedDatas.size(),f=this._columnCount,g=this._columnWidth,h=3*g/8/e,i=0;f>i;i++){var j=b.x+g*(.5+1.5*i),k=0;this._publishedDatas.forEach(function(b){var f=this._map[b.getId()];if(i<f.proportions.size()){var l=f.proportions.get(i);if(null!=l){var m=c*l,n=d-m,o=j+g/2-g/8-h*(e-k),p=2*(g/8+h*(e-k));this.drawRect(a,f.color,this.isSelected(b),o,n,p,m),this.addToolTipInfo(o,n,p,m,f.values.get(i),b);var q=this._getValueTextInfo(b,f.values.get(i));if(q){var r=this.getTextSize(q.font,q.text);q.x=o+p/2,q.y=n-r.height/2+1}}}k++},this)}},drawGroupContent:function(a,b,c,d){for(var e=this._publishedDatas.size(),f=this._columnCount,g=this._columnWidth,h=g/e,i=0;f>i;i++){var j=b.x+g*(.5+1.5*i),k=0;this._publishedDatas.forEach(function(b){var e=this._map[b.getId()];if(i<e.proportions.size()){var f=e.proportions.get(i);if(null!=f){var g=c*f,l=d-g;this.drawRect(a,e.color,this.isSelected(b),j+h*k,l,h,g),this.addToolTipInfo(j+h*k,l,h,g,e.values.get(i),b);var m=this._getValueTextInfo(b,e.values.get(i));if(m){var n=this.getTextSize(m.font,m.text);m.x=j+h*k+h/2,m.y=l-n.height/2+1}}}k++},this)}}}),Ib.charts.LineChart=function(a){Ib.charts.LineChart.superClass.constructor.apply(this,arguments),this._selectTolerance=2},Jb.ext("twaver.charts.LineChart",Ib.charts.ScaleChart,{__accessor:["xScaleLineColor","xScaleLineWidth","interruptable"],_interruptable:Cd.LINECHART_INTERRUPTABLE,_upperLimit:Cd.LINECHART_UPPER_LIMIT,_lowerLimit:Cd.LINECHART_LOWER_LIMIT,_xAxisText:null,_xAxisTextColor:Cd.LINECHART_XAXIS_TEXT_COLOR,_xAxisTextFont:Cd.LINECHART_XAXIS_TEXT_FONT,_xAxisLineColor:Cd.LINECHART_XAXIS_LINE_COLOR,_xAxisLineWidth:Cd.LINECHART_XAXIS_LINE_WIDTH,_yAxisText:null,_yAxisTextColor:Cd.LINECHART_YAXIS_TEXT_COLOR,_yAxisTextFont:Cd.LINECHART_YAXIS_TEXT_FONT,_yAxisLineColor:Cd.LINECHART_YAXIS_LINE_COLOR,_yAxisLineWidth:Cd.LINECHART_YAXIS_LINE_WIDTH,_xScaleTexts:null,_xScaleTextFont:Cd.LINECHART_XSCALE_TEXT_FONT,_xScaleTextColor:Cd.LINECHART_XSCALE_TEXT_COLOR,_xScaleTextOrientation:Cd.LINECHART_XSCALE_TEXT_ORIENTATION,_xScaleLineColor:Cd.LINECHART_XSCALE_LINE_COLOR,_xScaleLineWidth:Cd.LINECHART_XSCALE_LINE_WIDTH,_valueSpanCount:Cd.LINECHART_VALUESPANCOUNT,_yScaleTextVisible:Cd.LINECHART_YSCALE_TEXT_VISIBLE,_yScaleTextColor:Cd.LINECHART_YSCALE_TEXT_COLOR,_yScaleTextFont:Cd.LINECHART_YSCALE_TEXT_FONT,_yScaleLineColor:Cd.LINECHART_YSCALE_LINE_COLOR,_yScaleLineWidth:Cd.LINECHART_YSCALE_LINE_WIDTH,_yScaleValueGap:Cd.LINECHART_YSCALE_VALUE_GAP,_yScalePixelGap:Cd.LINECHART_YSCALE_PIXEL_GAP,_yScaleMinTextVisible:Cd.LINECHART_YSCALE_MIN_TEXT_VISIBLE,getLineWidth:function(a){return a.getStyle?a.getStyle("chart.line.width"):Ib.Styles.getStyle("chart.line.width")},getMarkerShape:function(a){return a.getStyle?a.getStyle("chart.marker.shape"):Ib.Styles.getStyle("chart.marker.shape")},getMarkerSize:function(a){return a.getStyle?a.getStyle("chart.marker.size"):Ib.Styles.getStyle("chart.marker.size")},_initInfo:function(a,b){b.markerShape=this.getMarkerShape(a),b.markerSize=this.getMarkerSize(a),b.lineWidth=this.getLineWidth(a),this.isSelected(a)&&(b.lineWidth+=2)},validateContainer:function(){this._reset(),this._commonValidateContainer()},getPointIndexAt:function(){var a=this._getPoint.apply(this,arguments),b=this.tryGetDataAt(a);if(!b)return-1;for(var c,d=this._map[b.getId()],e=d.points,f=d.markerSize,g=0,h=e.size();h>g;g++)if(c=e.get(g),c&&Tb.getDistance(a,c)<=f)return g;return-1},drawContent:function(a,b,c,d){this._toolTipInfos=this.isToolTipEnabled()?new md:null,this._publishedDatas.forEach(function(e){var f=this._map[e.getId()],g=f.markerSize>0?new md:null;a.strokeStyle=f.color,a.lineWidth=f.lineWidth,a.beginPath();var h=f.proportions,i=null,j=h.size(),k=new md;f.points=k;for(var l=0;j>l;l++){var m=h.get(l);if(null!=m){var n={x:b.x+this._columnWidth*(1+1.5*l),y:d-c*m};k.add(n),null==i?a.moveTo(n.x,n.y):a.lineTo(n.x,n.y);var o=f.values.get(l),p=this._getValueTextInfo(e,o);if(p){var q=this.getTextSize(p.font,p.text);p.x=n.x,p.y=n.y-q.height/2+2}g&&g.add({point:n,value:o,data:e,index:l}),i=n}else this._interruptable&&(i=null,k.add(null))}if(a.stroke(),g){var r=f.markerSize/2;g.forEach(function(b){a.fillStyle=f.color;var c=b.point.x-r,d=b.point.y-r,e=f.markerSize,g=f.markerSize;Xb.drawVector(a,f.markerShape,null,c,d,e,g),a.fill(),this.addToolTipInfo(c,d,e,g,b.value,b.data,b.index)},this)}},this),this.drawValueTexts(a)}}),Ib.charts.BubbleChart=function(a){Ib.charts.BubbleChart.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.charts.BubbleChart",Ib.charts.ScaleChart,{__accessor:["xAxisUpperLimit","xAxisLowerLimit","xScaleLineColor","xScaleLineWidth","selectShadowColor","selectShadowOffset"],_upperLimit:Cd.BUBBLECHART_UPPER_LIMIT,_lowerLimit:Cd.BUBBLECHART_LOWER_LIMIT,_xAxisUpperLimit:Cd.BUBBLECHART_XAXIS_UPPER_LIMIT,_xAxisLowerLimit:Cd.BUBBLECHART_XAXIS_LOWER_LIMIT,_xAxisText:null,_xAxisTextColor:Cd.BUBBLECHART_XAXIS_TEXT_COLOR,_xAxisTextFont:Cd.BUBBLECHART_XAXIS_TEXT_FONT,_xAxisLineColor:Cd.BUBBLECHART_XAXIS_LINE_COLOR,_xAxisLineWidth:Cd.BUBBLECHART_XAXIS_LINE_WIDTH,_yAxisText:null,_yAxisTextColor:Cd.BUBBLECHART_YAXIS_TEXT_COLOR,_yAxisTextFont:Cd.BUBBLECHART_YAXIS_TEXT_FONT,_yAxisLineColor:Cd.BUBBLECHART_YAXIS_LINE_COLOR,_yAxisLineWidth:Cd.BUBBLECHART_YAXIS_LINE_WIDTH,_xScaleTexts:null,_xScaleTextFont:Cd.BUBBLECHART_XSCALE_TEXT_FONT,_xScaleTextColor:Cd.BUBBLECHART_XSCALE_TEXT_COLOR,_xScaleTextOrientation:Cd.BUBBLECHART_XSCALE_TEXT_ORIENTATION,_xScaleLineColor:Cd.BUBBLECHART_XSCALE_LINE_COLOR,_xScaleLineWidth:Cd.BUBBLECHART_XSCALE_LINE_WIDTH,_yScaleTextVisible:Cd.BUBBLECHART_YSCALE_TEXT_VISIBLE,_yScaleTextColor:Cd.BUBBLECHART_YSCALE_TEXT_COLOR,_yScaleTextFont:Cd.BUBBLECHART_YSCALE_TEXT_FONT,_yScaleLineColor:Cd.BUBBLECHART_YSCALE_LINE_COLOR,_yScaleLineWidth:Cd.BUBBLECHART_YSCALE_LINE_WIDTH,_yScaleValueGap:Cd.BUBBLECHART_YSCALE_VALUE_GAP,_yScalePixelGap:Cd.BUBBLECHART_YSCALE_PIXEL_GAP,_yScaleMinTextVisible:Cd.BUBBLECHART_YSCALE_MIN_TEXT_VISIBLE,_selectShadowColor:Cd.BUBBLECHART_SELECT_SHADOW_COLOR,_selectShadowOffset:Cd.BUBBLECHART_SELECT_SHADOW_OFFSET,_resetX:function(){this._xMax=0,this._xMin=0,null!=this._xAxisUpperLimit&&(this._xMax=this._xAxisUpperLimit),null!=this._xAxisLowerLimit&&(this._xMin=this._xAxisLowerLimit)},getXMin:function(){return this._xMin},getXMax:function(){return this._xMax},getXRange:function(){return this._xRange},getShape:function(a){return a.getStyle?a.getStyle("chart.bubble.shape"):Ib.Styles.getStyle("chart.bubble.shape")},getSize:function(a,b){return b},getNames:function(a){return a.getStyle?a.getStyle("chart.names"):Ib.Styles.getStyle("chart.names")},getXAxisValues:function(a){return a.getStyle?a.getStyle("chart.xaxis.values"):Ib.Styles.getStyle("chart.xaxis.values")},getYAxisValues:function(a){return a.getStyle?a.getStyle("chart.yaxis.values"):Ib.Styles.getStyle("chart.yaxis.values")},_initXRange:function(){null==this._xAxisLowerLimit&&(this._xMin>=this._xMax&&(this._xMin=this._xMax-.1*Math.abs(this._xMax)),this._xMin=this._xMin-.1*(this._xMax-this._xMin)),this._xRange=this._xMax-this._xMin},_initXYValuesProportion:function(){this._publishedDatas.forEach(function(a){var b=this._map[a.getId()];b.xAxisValues.forEach(function(a){b.xAxisProportions.add(null==a?null:0==this._xRange?0:a/this._xRange)},this),b.yAxisValues.forEach(function(a){b.yAxisProportions.add(null==a?null:0==this._range?0:a/this._range)},this)},this)},validateContainer:function(){this._reset(),this._resetX(),this._columnCount=null==this._xScaleTexts?0:this._xScaleTexts.size(),this._publishedDatas.forEach(function(a){var b=new md(this.getYAxisValues(a)),c=new md(this.getXAxisValues(a)),d=new md(this.getValues(a));d.size()>this._columnCount&&(this._columnCount=d.size());var e={data:a,values:d,yAxisValues:b,xAxisValues:c,yAxisProportions:new md,xAxisProportions:new md,color:this.getUniqueColor(this.getColor(a),a),anchorShape:this.getShape(a)};this._map[a.getId()]=e,(null==this._upperLimit||null==this._lowerLimit)&&b.forEach(function(a){null!=a&&(null==this._upperLimit&&a>this._max&&(this._max=a),null==this._lowerLimit&&a<this._min&&(this._min=a))},this),(null==this._upperLimit||null==this._lowerLimit)&&c.forEach(function(a){null!=a&&(null==this._xAxisUpperLimit&&a>this._xMax&&(this._xMax=a),null==this._xAxisLowerLimit&&a<this._xMin&&(this._xMin=a))},this)},this),this._initRange(),this._initXRange(),this._initXYValuesProportion()},drawContent:function(a,b,c,d){this._toolTipInfos=this.isToolTipEnabled()?new md:null,this._publishedDatas.forEach(function(e){var f=this._map[e.getId()],g=f.yAxisProportions,h=f.xAxisProportions,i=f.values,j=f.yAxisProportions.size(),k=this._selectShadowOffset;this.isSelected(e)&&k>0?(a.shadowOffsetX=k,a.shadowOffsetY=k,a.shadowBlur=2*k,a.shadowColor=this._selectShadowColor):(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.shadowColor=f.color),a.fillStyle=f.color;for(var l=0;j>l;l++){var m=g.get(l),n=h.get(l);if(null!=m){var o={x:b.x+b.width*n,y:d-c*m},p=i.get(l),q=this.getSize(e,p),k=q/2,r=o.x-k,s=o.y-k,t=q,u=q;Xb.drawVector(a,f.anchorShape,null,r,s,t,u),a.fill(),this.addToolTipInfo(r,s,t,u,p,e,l);var v=this._getValueTextInfo(e,p);if(v){var q=this.getTextSize(v.font,v.text);v.x=o.x,v.y=o.y}}}},this),this.drawValueTexts(a)}}),Ib.charts.DialChart=function(a){Ib.charts.DialChart.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.charts.DialChart",Ib.charts.ChartBase,{__accessor:["upperLimit","lowerLimit","startAngle","endAngle","innerRadius","colorRangeFillColor","outlineWidth","outlineColor","majorScaleCount","majorScaleLineWidth","majorScaleLineLength","majorScaleLineColor","minorScaleCount","minorScaleLineWidth","minorScaleLineLength","minorScaleLineColor","scaleTextVisible","scaleUpperLimitTextVisible","scaleLowerLimitTextVisible","scaleTextFont","scaleTextColor","pivotRadius","pivotFillColor","pivotOutlineWidth","pivotOutlineColor","pivotGradient","pivotGradientColor","valuePosition","colorRangeList","innerDarkerRadius","outerBrighterRadius","selectShadowColor","selectShadowOffset"],__bool:["scaleInside","pivotFill"],_upperLimit:Cd.DIALCHART_UPPER_LIMIT,_lowerLimit:Cd.DIALCHART_LOWER_LIMIT,_startAngle:Cd.DIALCHART_START_ANGLE,_endAngle:Cd.DIALCHART_END_ANGLE,_innerRadius:Cd.DIALCHART_INNER_RADIUS,_colorRangeFillColor:Cd.DIALCHART_COLOR_RANGE_FILL_COLOR,_outlineWidth:Cd.DIALCHART_OUTLINE_WIDTH,_outlineColor:Cd.DIALCHART_OUTLINE_COLOR,_scaleInside:Cd.DIALCHART_SCALE_INSIDE,_majorScaleCount:Cd.DIALCHART_MAJOR_SCALE_COUNT,_majorScaleLineWidth:Cd.DIALCHART_MAJOR_SCALE_LINE_WIDTH,_majorScaleLineLength:Cd.DIALCHART_MAJOR_SCALE_LINE_LENGTH,_majorScaleLineColor:Cd.DIALCHART_MAJOR_SCALE_LINE_COLOR,_minorScaleCount:Cd.DIALCHART_MINOR_SCALE_COUNT,_minorScaleLineWidth:Cd.DIALCHART_MINOR_SCALE_LINE_WIDTH,_minorScaleLineLength:Cd.DIALCHART_MINOR_SCALE_LINE_LENGTH,_minorScaleLineColor:Cd.DIALCHART_MINOR_SCALE_LINE_COLOR,_scaleTextVisible:Cd.DIALCHART_SCALE_TEXT_VISIBLE,_scaleUpperLimitTextVisible:Cd.DIALCHART_SCALE_UPPER_LIMIT_TEXT_VISIBLE,_scaleLowerLimitTextVisible:Cd.DIALCHART_SCALE_LOWER_LIMIT_TEXT_VISIBLE,_scaleTextFont:Cd.DIALCHART_SCALE_TEXT_FONT,_scaleTextColor:Cd.DIALCHART_SCALE_TEXT_COLOR,_pivotRadius:Cd.DIALCHART_PIVOT_RADIUS,_pivotFill:Cd.DIALCHART_PIVOT_FILL,_pivotFillColor:Cd.DIALCHART_PIVOT_FILL_COLOR,_pivotOutlineWidth:Cd.DIALCHART_PIVOT_OUTLINE_WIDTH,_pivotOutlineColor:Cd.DIALCHART_PIVOT_OUTLINE_COLOR,_pivotGradient:Cd.DIALCHART_PIVOT_GRADIENT,_pivotGradientColor:Cd.DIALCHART_PIVOT_GRADIENT_COLOR,_valuePosition:Cd.DIALCHART_VALUE_POSITION,_innerDarkerRadius:Cd.DIALCHART_INNER_DARKER_RADIUS,_outerBrighterRadius:Cd.DIALCHART_OUTER_BRIGHTER_RADIUS,_selectShadowColor:Cd.DIALCHART_SELECT_SHADOW_COLOR,_selectShadowOffset:Cd.DIALCHART_SELECT_SHADOW_OFFSET,formatScaleText:function(a){return a.toFixed(2)},validateContainer:function(){this._map={},this._valueRange=this._upperLimit-this._lowerLimit;var a=this._startAngle;0!=a&&(a=(a%360+360)%360,0==a&&(a=360)),this._positiveStartAngle=a;var b=this._endAngle;0!=b&&(b=(b%360+360)%360,0==b&&(b=360)),this._positiveEndAngle=b,this._whole=360==Math.abs(a-b),this._startAngleByRadian=a*Math.PI/180,this._endAngleByRadian=b*Math.PI/180,this._clockwise=this._startAngleByRadian>this._endAngleByRadian,this._angleRange=Math.abs(this._startAngleByRadian-this._endAngleByRadian),this._publishedDatas.forEach(function(a){var b=this.getValue(a);this._map[a.getId()]={data:a,value:b,color:this.getUniqueColor(this.getColor(a),a),angle:this._startAngleByRadian+(this._clockwise?-1:1)*b/this._valueRange*this._angleRange}},this)},validateDisplay:function(a,b,c){var d={x:this._xGap,y:this._yGap,width:b-2*this._xGap,height:c-2*this._yGap};if(this.drawBackground(a,d),this._startAngleByRadian!=this._endAngleByRadian){var e,f,g=this._lowerLimit,h=this._majorScaleCount>1?this._valueRange/(this._majorScaleCount-1):0,i=0,j=0,k=null,l=null;if(this._scaleTextVisible)for(k=new md,e=0;e<this._majorScaleCount;e++)0==e&&!this._scaleLowerLimitTextVisible||e==this._majorScaleCount-1&&!this._scaleUpperLimitTextVisible?(f=null,k.add({text:"",size:{width:0,height:0}})):(l=this.formatScaleText(g),f=this.getTextSize(this._scaleTextFont,l),k.add({text:l,size:f})),this._scaleInside||null==f||(f.width>i&&(i=f.width),f.height>j&&(j=f.height)),g+=h;if(this._angleRange<=Math.PI&&(i=Math.max(i,this._pivotRadius),j=Math.max(j,this._pivotRadius)),Tb.grow(d,-i,-j),this._calcluateCenterAndRadius(d),a.lineWidth=0,null==this._colorRangeList||0==this._colorRangeList.size())this._drawArcGroup(a,this._startAngleByRadian,this._endAngleByRadian,this.getUniqueColor(this._colorRangeFillColor)),this._drawArcOutLine(a,this._startAngleByRadian,this._endAngleByRadian,!0,!0);else{var m=this._angleRange/this._colorRangeList.size(),n=this._startAngleByRadian;for(e=0;e<this._colorRangeList.size();e++){var o=this.getUniqueColor(this._colorRangeList.get(e)),p=n+(this._clockwise?-1:1)*m;this._drawArcGroup(a,n,p,o),this._drawArcOutLine(a,n,n+(this._clockwise?-1:1)*m,0==e,e==this._colorRangeList.size()-1),n+=(this._clockwise?-1:1)*m}}var q,r,s,t,u,v,w,x,y=this._startAngleByRadian,z=this._majorScaleCount>1?this._angleRange/(this._majorScaleCount-1):0;for(v=this._scaleInside?this._innerRadiusByPixel:this._outerRadius,w=v+this._majorScaleLineLength*(this._scaleInside?1:-1),x=v+this._minorScaleLineLength*(this._scaleInside?1:-1),e=0;e<this._majorScaleCount;e++){if(r=this._center.x+Math.cos(y)*v,s=this._center.y+Math.sin(-y)*v,t=this._center.x+Math.cos(y)*w,u=this._center.y+Math.sin(-y)*w,a.lineWidth=this._majorScaleLineWidth,a.strokeStyle=this.getUniqueColor(this._majorScaleLineColor),a.beginPath(),a.moveTo(r,s),a.lineTo(t,u),a.closePath(),a.stroke(),this._scaleTextVisible)if(0==e&&!this._scaleLowerLimitTextVisible||e==this._majorScaleCount-1&&!this._scaleUpperLimitTextVisible);else{var A=k.get(e);if(A){var B=this.getScaleTextPosition(y/Math.PI*180,r,s,A.size.width,A.size.height);A.x=B.x,A.y=B.y}}if(this._whole||!this._whole&&e<this._majorScaleCount-1){var C=y,D=this._minorScaleCount>0?z/(this._minorScaleCount+1):0;for(q=0;q<this._minorScaleCount;q++)C+=(this._clockwise?-1:1)*D,r=this._center.x+Math.cos(C)*v,s=this._center.y+Math.sin(-C)*v,t=this._center.x+Math.cos(C)*x,u=this._center.y+Math.sin(-C)*x,a.lineWidth=this._minorScaleLineWidth,a.strokeStyle=this.getUniqueColor(this._minorScaleLineColor),a.beginPath(),a.moveTo(r,s),a.lineTo(t,u),a.closePath(),a.stroke()}y+=(this._clockwise?-1:1)*z}this._pivotFill&&Xb.fill(a,this.getUniqueColor(this._pivotFillColor),this._pivotGradient,this._pivotGradientColor,this._center.x-this._pivotRadius,this._center.y-this._pivotRadius,2*this._pivotRadius,2*this._pivotRadius),a.lineWidth=this._pivotOutlineWidth,a.strokeStyle=this.getUniqueColor(this._pivotOutlineColor),a.beginPath(),a.arc(this._center.x,this._center.y,this._pivotRadius,0,2*Math.PI,!0),a.closePath(),this._pivotFill&&a.fill(),k&&k.forEach(function(b){b&&Xb.drawText(a,b.text,b,this._scaleTextFont,this._scaleTextColor)},this),this._publishedDatas.forEach(function(b){var c=this._map[b.getId()],d=this._getDataStyle("dialchart.rear.extension",b),e=this._getDataStyle("dialchart.base.width",b),f=this._getDataStyle("dialchart.top.width",b),g=this._getDataStyle("dialchart.radius",b);g>=-1&&1>=g&&(g*=this._innerRadiusByPixel),a.fillStyle=c.color,a.lineWidth=0;var h=Tb.createMatrix(-c.angle,this._center.x,this._center.y),i=h.transform(this._center.x+g,this._center.y+f/2),j=h.transform(this._center.x+g,this._center.y-f/2),k=h.transform(this._center.x-d,this._center.y-e/2),l=h.transform(this._center.x-d,this._center.y+e/2),m=this._selectShadowOffset;this.isSelected(b)&&m>0?(a.shadowOffsetX=m,a.shadowOffsetY=m,a.shadowBlur=2*m,a.shadowColor=this._selectShadowColor):(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.shadowColor=c.color),a.beginPath(),a.moveTo(i.x,i.y),a.lineTo(j.x,j.y),a.lineTo(k.x,k.y),a.lineTo(l.x,l.y),a.lineTo(i.x,i.y),a.closePath(),a.fill();var n=this._getValueTextInfo(b,c.value);if(n){var o=h.transform(this._center.x+g*this._valuePosition,this._center.y);n.x=o.x,n.y=o.y}},this),this.drawValueTexts(a)}},_getDataStyle:function(a,b){return b.getStyle?b.getStyle(a):b.getClient(a)},_calcluateCenterAndRadius:function(a){{var b=this._clockwise?this._positiveEndAngle:this._positiveStartAngle,c=this._clockwise?this._positiveStartAngle:this._positiveEndAngle;Math.abs(this._positiveEndAngle-this._positiveStartAngle)}b>=0&&90>b?c>=0&&90>=c?(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width-this._outerRadius)/2,y:a.y+(a.height+this._outerRadius)/2}):c>90&&180>=c?(this._outerRadius=Math.min(a.width/2,a.height),this._center={x:a.x+a.width/2,y:a.y+(a.height+this._outerRadius)/2}):(this._center={x:a.x+a.width/2,y:a.y+a.height/2},this._outerRadius=Math.min(a.width,a.height)/2):b>=90&&180>b?c>=90&&180>=c?(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width+this._outerRadius)/2,y:a.y+(a.height+this._outerRadius)/2}):c>180&&270>=c?(this._outerRadius=Math.min(a.width,a.height/2),this._center={x:a.x+(a.width+this._outerRadius)/2,y:a.y+a.height/2}):(this._center={x:a.x+a.width/2,y:a.y+a.height/2},this._outerRadius=Math.min(a.width,a.height)/2):b>=180&&270>b?c>=180&&270>=c?(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width+this._outerRadius)/2,y:a.y+(a.height-this._outerRadius)/2}):(this._outerRadius=Math.min(a.width/2,a.height),this._center={x:a.x+a.width/2,y:a.y+(a.height-this._outerRadius)/2}):(this._outerRadius=Math.min(a.width,a.height),this._center={x:a.x+(a.width-this._outerRadius)/2,y:a.y+(a.height-this._outerRadius)/2}),this._innerRadiusByPixel=this._innerRadius>1?this._innerRadius:this._outerRadius*this._innerRadius,this._innerDarkerRadiusByPixel=this._innerDarkerRadius>1?this._innerDarkerRadius:this._outerRadius*this._innerDarkerRadius,this._outerBrighterRadiusByPixel=this._outerBrighterRadius>1?this._outerBrighterRadius:this._outerRadius*this._outerBrighterRadius},_drawArcOutLine:function(a,b,c,d,e){if(!(this._outlineWidth<=0)){var f=Math.abs(b-c),g=this._center.x+Math.cos(b)*this._innerRadiusByPixel,h=this._center.y+Math.sin(-b)*this._innerRadiusByPixel,i=this._center.x+Math.cos(b)*this._outerRadius,j=this._center.y+Math.sin(-b)*this._outerRadius,k=this._center.x+Math.cos(c)*this._innerRadiusByPixel,l=this._center.y+Math.sin(-c)*this._innerRadiusByPixel,m=this._center.x+Math.cos(c)*this._outerRadius,n=this._center.y+Math.sin(-c)*this._outerRadius;this._clockwise?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.beginPath(),a.moveTo(this._center.x,this._center.y),Xb.drawArc(a,this._center.x,this._center.y,c,f,this._outerRadius,this._outerRadius,!1),a.stroke(),!this._whole&&d?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(g,h),a.stroke(),a.beginPath(),a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.moveTo(this._center.x,this._center.y),Xb.drawArc(a,this._center.x,this._center.y,b,-f,this._innerRadiusByPixel,this._innerRadiusByPixel,!1),a.stroke(),!this._whole&&e?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(m,n),a.stroke()):(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.beginPath(),a.moveTo(this._center.x,this._center.y),Xb.drawArc(a,this._center.x,this._center.y,b,f,this._outerRadius,this._outerRadius,!1),a.stroke(),!this._whole&&e?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(k,l),a.stroke(),a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor),a.beginPath(),a.moveTo(this._center.x,this._center.y),Xb.drawArc(a,this._center.x,this._center.y,c,-f,this._innerRadiusByPixel,this._innerRadiusByPixel,!1),a.stroke(),!this._whole&&d?(a.lineWidth=this._outlineWidth,a.strokeStyle=this.getUniqueColor(this._outlineColor)):a.lineWidth=0,a.lineTo(i,j),a.stroke())}},_drawArcGroup:function(a,b,c,d){0!=this._outerBrighterRadiusByPixel&&this._drawArc(a,b,c,this._outerRadius-this._outerBrighterRadiusByPixel,this._outerRadius,Xb.brighter(d)),this._drawArc(a,b,c,this._innerRadiusByPixel+this._innerDarkerRadiusByPixel,this._outerRadius-this._outerBrighterRadiusByPixel,d),0!=this._innerDarkerRadiusByPixel&&this._drawArc(a,b,c,this._innerRadiusByPixel,this._innerRadiusByPixel+this._innerDarkerRadiusByPixel,Xb.darker(d,20))},_drawArc:function(a,b,c,d,e,f){var g=Math.abs(b-c);a.lineWidth=0,a.fillStyle=f;{var h=this._center.x+Math.cos(b)*d,i=this._center.y+Math.sin(-b)*d,j=(this._center.x+Math.cos(b)*e,this._center.y+Math.sin(-b)*e,this._center.x+Math.cos(c)*d),k=this._center.y+Math.sin(-c)*d;this._center.x+Math.cos(c)*e,this._center.y+Math.sin(-c)*e}a.beginPath(),this._clockwise?(a.moveTo(j,k),Xb.drawArc(a,this._center.x,this._center.y,c,g,e,e,!0),a.lineTo(h,i),Xb.drawArc(a,this._center.x,this._center.y,b,-g,d,d,!0),a.closePath()):(a.moveTo(h,i),Xb.drawArc(a,this._center.x,this._center.y,b,g,e,e,!0),a.lineTo(j,k),Xb.drawArc(a,this._center.x,this._center.y,c,-g,d,d,!0),a.closePath()),a.fill()},getScaleTextPosition:function(a,b,c,d,e){a=(a%360+360)%360;var f={x:b,y:c};return 0==a&&(f=this._scaleInside?{x:b-d/2,y:c}:{x:b+d/2,y:c}),180==a&&(f=this._scaleInside?{x:b+d/2,y:c}:{x:b-d/2,y:c}),90==a&&(f=this._scaleInside?{x:b,y:c+e/2}:{x:b,y:c-e/2}),270==a&&(f=this._scaleInside?{x:b,y:c-e/2}:{x:b,y:c+e/2}),a>270&&360>a&&(f=this._scaleInside?{x:b-d/2,y:c-e/2}:{x:b+d/2,y:c+e/2}),a>180&&270>a&&(f=this._scaleInside?{x:b+d/2,y:c-e/2}:{x:b-d/2,y:c+e/2}),a>90&&180>a&&(f=this._scaleInside?{x:b+d/2,y:c+e/2}:{x:b-d/2,y:c-e/2}),a>0&&90>a&&(f=this._scaleInside?{x:b-d/2,y:c+e/2}:{x:b+d/2,y:c-e/2}),f}}),Ib.charts.RadarChart=function(a){Ib.charts.RadarChart.superClass.constructor.apply(this,arguments),this._selectTolerance=2},Jb.ext("twaver.charts.RadarChart",Ib.charts.ChartBase,{__accessor:["axisTextVisible","axisTextFont","axisTextColor","scaleTextVisible","scaleTextFont","scaleTextColor","axisVisible","axisLineColor","axisLineWidth","axisStartAngle","ringVisible","ringType","ringLineColor","ringLineWidth","scaleCount","scaleMaxValue","scaleMinValue","anchorVisible","areaFillAlpha","areaSelectFillAlpha","axisList"],__bool:["areaFill"],_axisTextVisible:Cd.RADARCHART_AXIS_TEXT_VISIBLE,_axisTextFont:Cd.RADARCHART_AXIS_TEXT_FONT,_axisTextColor:Cd.RADARCHART_AXIS_TEXT_COLOR,_scaleTextVisible:Cd.RADARCHART_SCALE_TEXT_VISIBLE,_scaleTextFont:Cd.RADARCHART_SCALE_TEXT_FONT,_scaleTextColor:Cd.RADARCHART_SCALE_TEXT_COLOR,_axisVisible:Cd.RADARCHART_AXIS_VISIBLE,_axisLineColor:Cd.RADARCHART_AXIS_LINE_COLOR,_axisLineWidth:Cd.RADARCHART_AXIS_LINE_WIDTH,_axisStartAngle:Cd.RADARCHART_AXIS_START_ANGLE,_ringVisible:Cd.RADARCHART_RING_VISIBLE,_ringType:Cd.RADARCHART_RING_TYPE,_ringLineColor:Cd.RADARCHART_RING_LINE_COLOR,_ringLineWidth:Cd.RADARCHART_RING_LINE_WIDTH,_scaleCount:Cd.RADARCHART_SCALE_COUNT,_scaleMaxValue:Cd.RADARCHART_SCALE_MAXVALUE,_scaleMinValue:Cd.RADARCHART_SCALE_MINVALUE,_anchorVisible:Cd.RADARCHART_ANCHOR_VISIBLE,_areaFill:Cd.RADARCHART_AREA_FILL,_areaFillAlpha:Cd.RADARCHART_AREA_FILL_ALPHA,_areaSelectFillAlpha:Cd.RADARCHART_AREA_SELECT_FILL_ALPHA,
getAxisCount:function(){return this._axisCount},formatScaleText:function(a,b){return a.toFixed(2)},getAnchorSize:function(a){return a.getStyle?a.getStyle("chart.marker.size"):Ib.Styles.getStyle("chart.marker.size")},getAnchorShape:function(a){return a.getStyle?a.getStyle("chart.marker.shape"):Ib.Styles.getStyle("chart.marker.shape")},getLineWidth:function(a){return a.getStyle?a.getStyle("chart.line.width"):Ib.Styles.getStyle("chart.line.width")},getValues:function(a){return a.getStyle?a.getStyle("chart.values"):null},tryGetDataAt:function(a,b){if((null==b||0>b)&&(b=this._selectTolerance),a.target&&(a=Wb.getLogicalPoint(this._canvas,arguments[0],1)),!a)return null;if(!this._areaFill){var c=a.x-b,d=a.y-b,e=2*b+1,f=2*b+1;try{for(var g=this._canvas.getContext("2d").getImageData(c,d,e,f).data,h=0,i=g.length;i>h;h+=4)if(255===g[h+3]){var j="rgb("+g[h]+","+g[h+1]+","+g[h+2]+")",k=this._uniqueColors[j];if(k)return k}}catch(l){}return null}if(!this._center)return null;a={x:a.x-this._xTranslate,y:a.y-this._yTranslate};for(var h=this._publishedDatas.size()-1;h>=0;h--){var k=this._publishedDatas.get(h),m=this._map[k.getId()],n=Tb.isPointInPolygon(m.points,a);if(n)return k}return null},getDataAt:function(){var a,b;if(2===arguments.length)a=arguments[0],b=arguments[1];else if(arguments[0].target){var c=Wb.getLogicalPoint(this._canvas,arguments[0],1);if(!c)return;a=c.x,b=c.y}else a=arguments[0].x,b=arguments[0].y;if(0>a||0>b||a>this._canvasWidth||b>this._canvasHeight)return null;if(!this._areaFill){try{var d=this._canvas.getContext("2d").getImageData(a,b,1,1).data;if(255===d[3]){var e="rgb("+d[0]+","+d[1]+","+d[2]+")",f=this._uniqueColors[e];if(f)return f}}catch(g){}return null}for(var h=this._publishedDatas.size()-1;h>=0;h--){var f=this._publishedDatas.get(h),i=this._map[f.getId()],j=Tb.isPointInPolygon(i.points,{x:a-this._xTranslate,y:b-this._yTranslate});if(j)return f}return null},validateContainer:function(){if(this._map={},this._axisTexts=new md,this._axisMaxValues=new md,this._axisMinValues=new md,this._axisRangeValues=new md,this._axisCount=null==this._axisList?0:this._axisList.size(),0!=this._axisCount){this._averageAngleByRadian=2*Math.PI/this._axisCount,this._averageAngle=360/this._axisCount,this._axisList.forEach(function(a){if("string"==typeof a)this._axisTexts.add(a),this._axisMaxValues.add(this._scaleMaxValue),this._axisMinValues.add(this._scaleMinValue),this._axisRangeValues.add(this._scaleMaxValue-this._scaleMinValue);else{this._axisTexts.add(a.text);var b=isNaN(a.max)?this._scaleMaxValue:a.max,c=isNaN(a.min)?this._scaleMinValue:a.min;this._axisMaxValues.add(b),this._axisMinValues.add(c),this._axisRangeValues.add(b-c)}},this),this._publishedDatas.forEach(function(a){var b=new md(this.getValues(a)),c={data:a,values:b,proportions:new md,color:this.getUniqueColor(this.getColor(a),a),anchorShape:this.getAnchorShape(a),anchorSize:this.getAnchorSize(a),lineWidth:this.getLineWidth(a),points:new md};this.isSelected(a)&&(c.lineWidth+=2),this._map[a.getId()]=c},this);for(var a=0;a<this._axisCount;a++)this._publishedDatas.forEach(function(b){var c=this._map[b.getId()],d=0;if(c.values.size()>a){var e=c.values.get(a),f=this._axisMinValues.get(a),g=this._axisRangeValues.get(a);g>0&&(d=(e-f)/g)}c.proportions.add(d)},this)}},validateDisplay:function(a,b,c){var d={x:this._xGap,y:this._yGap,width:b-2*this._xGap,height:c-2*this._yGap};if(this.drawBackground(a,d),!(d.width<=0||d.height<=0||this._axisCount<3)){var e=0,f=0,g=0,h=null,i=null,j=null,k=null;if(this._axisTextVisible)for(k=new md,g=0;g<this._axisCount;g++)j=this._axisTexts.get(g),h=this.getTextSize(this._axisTextFont,j),k.add({text:j,size:h}),h.width>e&&(e=h.width),h.height>f&&(f=h.height);var l=d.width/2-e>d.height/2-f?d.height/2-2*f:d.width/2-e,m={x:d.x+d.width/2,y:d.y+d.height/2};this._center={x:m.x+this._xTranslate,y:m.y+this._yTranslate};var n=null;this._scaleTextVisible&&(n=new md);var o=this._axisStartAngle/180*Math.PI;for(g=0;g<this._axisCount;g++){var p=180*o/Math.PI,q=m.x+Math.cos(o)*l,r=m.y+Math.sin(-o)*l,s=null;n&&(s=new md,n.add(s)),this._ringVisible&&this._ringLineWidth>0&&(a.lineWidth=this._ringLineWidth,a.strokeStyle=this._ringLineColor);for(var t=1;t<=this._scaleCount;t++){var u=t/this._scaleCount,v=l*u,w=m.x+Math.cos(o)*v,x=m.y+Math.sin(-o)*v;if(this._ringVisible&&this._ringLineWidth>0){var y=m.x+Math.cos(o+this._averageAngleByRadian)*v,z=m.y+Math.sin(-o-this._averageAngleByRadian)*v;"line"==this._ringType?this.drawLine(a,this._ringLineColor,this._ringLineWidth,w,x,y,z):"arc"==this._ringType&&(a.beginPath(),a.moveTo(m.x,m.y),Xb.drawArc(a,m.x,m.y,o,this._averageAngleByRadian,v,v,!0),a.closePath(),a.stroke())}s&&(j=this.formatScaleText(this._axisMinValues.get(g)+this._axisRangeValues.get(g)*u,g),h=this.getTextSize(this._scaleTextFont,j),i=this.getScaleTextPosition(p,w,x,h.width,h.height),s.add({text:j,x:i.x,y:i.y}))}if(this._axisVisible&&this.drawLine(a,this._axisLineColor,this._axisLineWidth,m.x,m.y,q,r),k){var A=k.get(g);i=this.getAxisTextPosition(p,q,r,A.size.width,A.size.height),A.x=i.x,A.y=i.y}o+=this._averageAngleByRadian}this._publishedDatas.forEach(function(b){var c=this._map[b.getId()];c.points.clear();var d=c.anchorSize>0?new md:null,e=c.proportions;if(a.lineWidth=0,a.globalAlpha=this.isSelected(b)?this._areaSelectFillAlpha:this._areaFillAlpha,this._areaFill&&(a.fillStyle=c.color),this._drawItem(a,e,m,l,d,c),this._areaFill&&a.fill(),a.lineWidth=c.lineWidth,a.strokeStyle=c.color,a.globalAlpha=1,this._drawItem(a,e,m,l),a.lineWidth=0,null!=d&&d.size()>0){var f=c.anchorSize/2;d.forEach(function(b){a.fillStyle=c.color,Xb.drawVector(a,c.anchorShape,null,b.x-f,b.y-f,c.anchorSize,c.anchorSize),a.fill()})}},this),n&&n.forEach(function(b){b.forEach(function(b){Xb.drawText(a,b.text,b,this._scaleTextFont,this._scaleTextColor)},this)},this),k&&k.forEach(function(b){Xb.drawText(a,b.text,b,this._axisTextFont,this._axisTextColor)},this)}},_drawItem:function(a,b,c,d,e,f){var g=this._axisStartAngle/180*Math.PI,h=null;a.beginPath();for(var i=0;i<this._axisCount;i++){var j=b.get(i),k={x:c.x+Math.cos(g)*d*j,y:c.y+Math.sin(-g)*d*j};null==h?a.moveTo(k.x,k.y):a.lineTo(k.x,k.y),null!=e&&this._anchorVisible&&e.add(k),f&&f.points.add(k),0==i&&(h=k),g+=this._averageAngleByRadian}null!=h&&a.lineTo(h.x,h.y),a.closePath(),a.stroke()},getAxisTextPosition:function(a,b,c,d,e){a=(a%360+360)%360;var f={x:b,y:c};return 0==a&&(f={x:b+d/2,y:c}),180==a&&(f={x:b-d/2,y:c}),90==a&&(f={x:b,y:c-e/2}),270==a&&(f={x:b,y:c+e/2}),a>270&&360>a&&(f={x:b+d/2,y:c+e/2}),a>180&&270>a&&(f={x:b-d/2,y:c+e/2}),a>90&&180>a&&(f={x:b-d/2,y:c-e/2}),a>0&&90>a&&(f={x:b+d/2,y:c-e/2}),f},getScaleTextPosition:function(a,b,c,d,e){a=(a%360+360)%360;var f={x:b,y:c};return 0==a&&(f={x:b,y:c+e/2}),180==a&&(f={x:b-d/2,y:c+e/2}),90==a&&(f={x:b+d/2,y:c}),270==a&&(f={x:b+d/2,y:c}),a>270&&360>a&&(f={x:b+d/2,y:c-e/2}),a>180&&270>a&&(f={x:b-d/2,y:c-e/2}),a>90&&180>a&&(f={x:b-d/2,y:c+e/2}),a>0&&90>a&&(f={x:b+d/2,y:c+e/2}),f}}),Ib.charts.LegendPane=function(a){Ib.charts.LegendPane.superClass.constructor.apply(this,arguments),this._divPool=new Ib.Pool("div"),this._iconPool=new Ib.Pool("div"),this._textPool=new Ib.Pool("span"),this._pools.add(this._divPool),this._pools.add(this._iconPool),this._pools.add(this._textPool),this._chart=a,this._chart.addViewListener(this.handleViewChange,this),this._view=Wb.createView("hidden"),this._view.style.verticalAlign="middle",this._legendDiv=Wb.createDiv(),this._legendDiv.style.whiteSpace="nowrap",this._legendDiv.style.verticalAlign="middle",this._legendDiv.style.position="",this._view.appendChild(this._legendDiv),this._hiddenMap={};var b=this;this._chart._internalVisibleFunction=function(a){return!b.isHidden(a)};var c;c=Qb.isTouchable&&!Qb.isMSToucheable?Ib.charts.LegendPaneTouchInteraction:Ib.charts.LegendPaneInteraction,c&&new c(this)},Jb.ext("twaver.charts.LegendPane",Ib.controls.ControlBase,{__accessor:["iconWidth","iconHeight","iconRadius","rowHeight","orientation","hiddenColor","selectBackgroundColor","selectForegroundColor"],_iconWidth:Cd.LEGENDPANE_ICON_WIDTH,_iconHeight:Cd.LEGENDPANE_ICON_HEIGHT,_iconRadius:Cd.LEGENDPANE_ICON_RADIUS,_rowHeight:Cd.LEGENDPANE_ROW_HEIGHT,_orientation:Cd.LEGENDPANE_ORIENTATION,_hiddenColor:Cd.LEGENDPANE_HIDDEN_COLOR,_selectBackgroundColor:Cd.LEGENDPANE_SELECT_BACKGROUND_COLOR,_selectForegroundColor:Cd.LEGENDPANE_SELECT_FOREGROUND_COLOR,onPropertyChanged:function(a){this.invalidate()},getChart:function(){return this._chart},isHidden:function(a){return null!=this._hiddenMap[a.getId()]},handleViewChange:function(a){"validateEnd"===a.kind&&(this._invalidate=!0,this.validate())},validate:function(){if(this._invalidate){this._invalidate=!1,Wb.release(this._legendDiv),Jb.keys(this._hiddenMap).forEach(function(a){this._chart.getServa().containsById(a)||delete this._hiddenMap[a]},this);for(var a=new md(this._chart.getUnfilteredDatas()),b=0;b<a.size();b++){var c=a.get(b);this._chart.isVisible(c)||this.isHidden(c)||(a.removeAt(b),b--)}var d=a.size(),e=this._view.style,f="horizontal"===this._orientation;for(f?(e.textAlign="center",e.height=this._rowHeight+"px"):(e.textAlign="",e.height=this._rowHeight*d+"px"),e.lineHeight=this._rowHeight-2+"px",b=0;d>b;b++){var c=a.get(b),g=this._divPool.get();g._data=c,g.style.cursor="pointer",g.style.height=this._rowHeight+"px",g.style.display=f?"inline-block":"block",this._legendDiv.appendChild(g),this.renderLegend(g,c),this.onLegendRendered(g,c)}this._pools.forEach(function(a){a.clear()})}},renderLegend:function(a,b){var c=!this.isHidden(b),d=this._chart.isSelected(b),e=this._iconPool.get(),f=e.style;f.display="inline-block",f.verticalAlign="middle",f.marginLeft="4px",f.width=this.getIconWidth()+"px",f.height=this.getIconHeight()+"px",f.backgroundColor=c?this._chart.getColor(b):this.getHiddenColor(),a.appendChild(e);var g=this._textPool.get();f=g.style,f.paddingLeft="2px",f.paddingRight="4px",f.display="inline-block",f.verticalAlign="middle",f.color=c?d?this._selectForegroundColor:"":this.getHiddenColor(),g.innerHTML=this._chart.getName(b),a.appendChild(g),a.style.backgroundColor=c&&d?this._selectBackgroundColor:""},onLegendRendered:function(a,b){}}),Ib.charts.ChartPane=function(a,b,c,d){Ib.charts.ChartPane.superClass.constructor.apply(this,arguments),this.invalidate(),this._chart=a,this._legendPane=new Ib.charts.LegendPane(a),this._titleDiv=Wb.createDiv(),this._titleDiv.style.verticalAlign="middle",this._titleDiv.style.whiteSpace="nowrap",this._view=Wb.createView("hidden"),this._view.appendChild(this._titleDiv),this._view.appendChild(this._legendPane.getView()),this._view.appendChild(this._chart.getView());var e=this;this._legendPane.addPropertyChangeListener(function(a){("rowHeight"===a.property||"orientation"===a.porperty)&&e.invalidate()}),arguments.length>1&&this.setTitle(b),arguments.length>2&&this.setLegendOrientation(c),arguments.length>3&&this.setLegendWidth(d)},Jb.ext("twaver.charts.ChartPane",Ib.controls.ControlBase,{__accessor:["title","titleHorizontalAlign","titleHeight","legendWidth"],_title:null,_titleHeight:Cd.CHARTPANE_TITLE_HEIGHT,_titleHorizontalAlign:Cd.CHARTPANE_TITLE_HORIZONTAL_ALIGN,_legendOrientation:Cd.CHARTPANE_LEGEND_ORIENTATION,_legendWidth:Cd.CHARTPANE_LEGEND_WIDTH,getLegendOrientation:function(){return this._legendOrientation},setLegendOrientation:function(a){if(this._legendOrientation!==a){var b=this._legendOrientation;this._legendOrientation=a,this.firePropertyChange("orientation",b,a),this._adjustLegendOrientation()}},_adjustLegendOrientation:function(){this._legendPane.setOrientation("left"===this._legendOrientation||"right"===this._legendOrientation?"vertical":"horizontal")},onPropertyChanged:function(a){this.invalidate()},getTitleDiv:function(){return this._titleDiv},getChart:function(){return this._chart},getLegendPane:function(){return this._legendPane},validateImpl:function(){this._adjustLegendOrientation();var a,b=this._view.offsetWidth,c=this._view.offsetHeight,d=this._legendPane.getRowHeight();this._title&&""!==this._title?(a=this._titleHeight,this._titleDiv.innerHTML=this._title):(a=0,this._titleDiv.innerHTML=""),this._titleDiv.innerHTML=this._title?this._title:"",this._titleDiv.style.textAlign=this._titleHorizontalAlign,this._titleDiv.style.lineHeight=this._titleHeight-2+"px";var e=this._titleDiv.style;e.left="0px",e.top="0px",e.width=b+"px",e.height=a+"px";var f,g;"bottom"===this._legendOrientation?(f={x:0,y:a,width:b,height:Math.max(c-a-d,0)},g={x:0,y:Math.max(c-d,0),width:b,height:d}):"right"===this._legendOrientation?(f={x:0,y:a,width:Math.max(b-this._legendWidth,0),height:Math.max(c-a,0)},g={x:Math.max(b-this._legendWidth,0),y:a,width:this._legendWidth,height:Math.max(c-a,0)}):"top"===this._legendOrientation?(f={x:0,y:a+d,width:b,height:Math.max(c-a-d,0)},g={x:0,y:a,width:b,height:d}):"left"===this._legendOrientation&&(f={x:this._legendWidth,y:a,width:Math.max(b-this._legendWidth,0),height:Math.max(c-a,0)},g={x:0,y:a,width:this._legendWidth,height:Math.max(c-a,0)}),f&&this._chart.adjustBounds(f),g&&this._legendPane.adjustBounds(g)}}),Ib.charts.ChartInteraction=function(a){this.chart=a,this.canvas=a._canvas;var b=this;this.canvas.addEventListener("mousedown",function(a){0===a.button&&b.handleMouseDown(a),a.preventDefault()},!1);var c=Qb.isFirefox?"DOMMouseScroll":"mousewheel";this.canvas.addEventListener(c,function(a){b.handleMouseWheel(a)},!1)},Jb.ext("twaver.charts.ChartInteraction",Object,{handleMouseDown:function(a){this.chart.isFocusOnClick()&&Ib.Util.setFocus(this.canvas),this.lastPoint=this.chart.getLogicalPoint(a);var b=this.chart.tryGetDataAt(a);2===a.detail&&null==b?this.chart.isDoubleClickToReset()&&(this.chart.zoomReset(!1),this.chart.setXTranslate(0),this.chart.setYTranslate(0)):(this._startLogical=this.lastPoint,this._startClient=Wb.getClientPoint(a),Wb.handle_mousedown(this,a))},handleMouseMove:function(a){if(this.lastPoint){var b={x:this._startLogical.x+a.clientX-this._startClient.x,y:this._startLogical.y+a.clientY-this._startClient.y};!this.startPan&&Tb.getDistance(this.lastPoint,b)>3&&(this.startPan=!0,this.lastPoint=b),this.startPan&&(this.chart.isXTranslateEnabled()&&this.chart.setXTranslate(this.chart.getXTranslate()+b.x-this.lastPoint.x),this.chart.isYTranslateEnabled()&&this.chart.setYTranslate(this.chart.getYTranslate()+b.y-this.lastPoint.y),this.lastPoint=b)}},handleMouseUp:function(a){if(!this.startPan&&1===a.detail){var b=this.chart.tryGetDataAt(a),c=this.chart.getSelectionContainer();b?Jb.isCtrlDown(a)?c.contains(b)?c.removeSelection(b):c.appendSelection(b):c.contains(b)||c.setSelection(b):Jb.isCtrlDown(a)||c.clearSelection()}delete this.lastPoint,delete this.startPan,delete this._startClient,delete this._startLogical},handleMouseWheel:function(a){Wb.preventDefault(a);var b=Qb.isFirefox?-a.detail:a.wheelDelta;b>0?(this.chart.isXZoomEnabled()&&this.chart.setXZoom(1.1*this.chart.getXZoom(),!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(1.1*this.chart.getYZoom(),!1)):0>b&&(this.chart.isXZoomEnabled()&&this.chart.setXZoom(this.chart.getXZoom()/1.1,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(this.chart.getYZoom()/1.1,!1))}}),Ib.charts.ChartTouchInteraction=function(a){this.chart=a,this.canvas=a._canvas,Wb.addEventListener("touchstart","handleTouchstart",this.canvas,this)},Jb.ext("twaver.charts.ChartTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),this.chart.isFocusOnClick()&&Ib.Util.setFocus(this.canvas),this.endPoint=this.chart.getLogicalPoint(a),zc.isMultiTouch(a)&&(this.distance=zc.getDistance(a),this.xZoom=this.chart.getXZoom(),this.yZoom=this.chart.getYZoom()),Wb.addEventListener("touchmove","handleTouchmove",this.canvas,this),Wb.addEventListener("touchend","handleTouchend",this.canvas,this)},handleTouchmove:function(a){if(Wb.preventDefault(a),this.endPoint){var b=this.chart.getLogicalPoint(a);if(!this.moved&&Tb.getDistance(this.endPoint,b)>10&&(this.moved=!0,this.lastPoint=b),this.moved)if(zc.isSingleTouch(a))this.endPoint&&(this.chart.isXTranslateEnabled()&&this.chart.setXTranslate(this.chart.getXTranslate()+b.x-this.endPoint.x),this.chart.isYTranslateEnabled()&&this.chart.setYTranslate(this.chart.getYTranslate()+b.y-this.endPoint.y),this.endPoint=b);else if(this.distance){var c=zc.getDistance(a)/this.distance,d=this.xZoom*c,e=this.yZoom*c;this.chart.isXZoomEnabled()&&this.chart.setXZoom(d,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(e,!1)}}},handleTouchend:function(a){if(Wb.preventDefault(a),!this.moved){this.endPoint=this.chart.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date);var c=this.chart.tryGetDataAt(a);if(b&&null==c)this.chart.isDoubleClickToReset()&&(this.chart.zoomReset(!1),this.chart.setXTranslate(0),this.chart.setYTranslate(0));else{var d=this.chart.getSelectionContainer();c?d.contains(c)||d.setSelection(c):d.clearSelection()}}delete this.endPoint,delete this.distance,delete this.xZoom,delete this.yZoom,delete this.moved,Wb.removeEventListener("touchmove",this.canvas,this),Wb.removeEventListener("touchend",this.canvas,this)}}),Ib.charts.ChartMSTouchInteraction=function(a){this.chart=a,this.canvas=a._canvas,this._pointerMap={},this._pointerIdArray=[];var b=this;this.canvas.addEventListener("MSPointerDown",function(a){b.handleTouchstart(a)},!1),this.canvas.addEventListener("MSPointerMove",function(a){b.handleTouchmove(a)},!1),this.canvas.addEventListener("MSPointerUp",function(a){b.handleTouchend(a)},!1),this.canvas.addEventListener("MSPointerCancel",function(a){b.handleTouchend(a)},!1);var c=Qb.isFirefox?"DOMMouseScroll":"mousewheel";this.canvas.addEventListener(c,function(a){b.handleMouseWheel(a)},!1)},Jb.ext("twaver.charts.ChartMSTouchInteraction",Object,{handleTouchstart:function(a){this.chart.isFocusOnClick()&&Ib.Util.setFocus(this.canvas);var b=this.chart.getLogicalPoint(a);a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&b&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a);var c=this.chart.tryGetDataAt(a);if(1==this._pointerIdArray.length&&b){var d=this._startTouchPoint&&this._startTouchTime&&(new Date).getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,b)<=10;d&&null==c?this.chart.isDoubleClickToReset()&&(this.chart.zoomReset(!1),this.chart.setXTranslate(0),this.chart.setYTranslate(0),this._startTouchPoint=null,this._startTouchTime=null,this._startClientPoint=null):(this._startTouchPoint=b,this._startTouchTime=new Date,this._startClientPoint={x:a.clientX,y:a.clientY},Wb.handle_mousedown(this,a))}else 2==this._pointerIdArray.length&&(this.xZoom=this.chart.getXZoom(),this.yZoom=this.chart.getYZoom(),this._distance=this._getDistance())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=3)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance,c=this.xZoom*b,d=this.yZoom*b;this.chart.isXZoomEnabled()&&this.chart.setXZoom(c,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(d,!1)}},handleTouchend:function(a){var b=this.chart.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b&&!this.moved){var c=this.chart.tryGetDataAt(a),d=this._startTouchPoint&&this._startTouchTime&&(new Date).getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,b)<=10,e=this.chart.getSelectionContainer();c&&d?Jb.isCtrlDown(a)?e.contains(c)?e.removeSelection(c):e.appendSelection(c):e.contains(c)||e.setSelection(c):Jb.isCtrlDown(a)||e.clearSelection()}this.moved=!1,this._pointerMap={},this._pointerIdArray=[]},handleMouseWheel:function(a){Wb.preventDefault(a);var b=Qb.isFirefox?-a.detail:a.wheelDelta;b>0?(this.chart.isXZoomEnabled()&&this.chart.setXZoom(1.1*this.chart.getXZoom(),!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(1.1*this.chart.getYZoom(),!1)):0>b&&(this.chart.isXZoomEnabled()&&this.chart.setXZoom(this.chart.getXZoom()/1.1,!1),this.chart.isYZoomEnabled()&&this.chart.setYZoom(this.chart.getYZoom()/1.1,!1))},handle_mousemove:function(a){if(1==this._pointerIdArray.length&&this._startTouchPoint&&this._startClientPoint){var b={x:this._startTouchPoint.x+(a.clientX-this._startClientPoint.x)/this.chart.getXZoom(),y:this._startTouchPoint.y+(a.clientY-this._startClientPoint.y)/this.chart.getYZoom()};Tb.getDistance(this._startTouchPoint,b)>3&&(this.moved=!0,this.chart.isXTranslateEnabled()&&this.chart.setXTranslate(this.chart.getXTranslate()+b.x-this._startTouchPoint.x),this.chart.isYTranslateEnabled()&&this.chart.setYTranslate(this.chart.getYTranslate()+b.y-this._startTouchPoint.y),this._startClientPoint.x=a.clientX,this._startClientPoint.y=a.clientY)}},handle_mouseup:function(a){this.handleTouchend(a)},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Ib.charts.LegendPaneInteraction=function(a){this.legendPane=a;var b=this;this.legendPane._legendDiv.addEventListener("mousedown",function(a){b.handleMouseDown(a)},!1)},Jb.ext("twaver.charts.LegendPaneInteraction",Object,{handleMouseDown:function(a){if(0===a.button){var b=a.target._data;b||(b=a.target.parentNode._data),b&&(this.legendPane._hiddenMap[b.getId()]?delete this.legendPane._hiddenMap[b.getId()]:this.legendPane._hiddenMap[b.getId()]=b,this.legendPane._chart.invalidateContainer())}}}),Ib.charts.LegendPaneTouchInteraction=function(a){this.legendPane=a,Wb.addEventListener("touchstart","handleTouchstart",this.legendPane._legendDiv,this)},Jb.ext("twaver.charts.LegendPaneTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a);var b=a.target._data;b||(b=a.target.parentNode._data),b&&(this.legendPane._hiddenMap[b.getId()]?delete this.legendPane._hiddenMap[b.getId()]:this.legendPane._hiddenMap[b.getId()]=b,this.legendPane._chart.invalidateContainer())}}),Ib.gl3dview.Gl3dview=function(a){Ib.gl3dview.Gl3dview.superClass.constructor.apply(this,arguments),this._elementUIMap={},this._layerMap={},this._layerList=new md,this._view=Wb.createView("auto"),this._rootDiv=Wb.createDiv(),this._topDiv=Wb.createDiv(),this._attachmentDiv=Wb.createDiv(),this._layersDiv=Wb.createDiv(),this._bottomDiv=Wb.createDiv(),this._rootDiv.appendChild(this._bottomDiv),this._rootDiv.appendChild(this._layersDiv),this._rootDiv.appendChild(this._attachmentDiv),this._rootDiv.appendChild(this._topDiv),this._view.appendChild(this._rootDiv),this.setElementBox(a?a:new Ib.ElementBox),Qb.isMSToucheable?this.setMSTouchInteractions():Qb.isTouchable?this.setTouchInteractions():this.setDefaultInteractions(!1);var b=this;this._flowLink=function(){if(!(b.isMovingElement()||b.isSelectingElement()||b.isEditingElement()||b._box._layoutMovingElements)){b._flowLinkQuickFinder||(b._flowLinkQuickFinder=new Ib.QuickFinder(b._box,"link.flow","style"));var a=b._flowLinkQuickFinder.find(!0);a.forEach(function(a){a._styleMap["link.flow.offset"]=b.getLinkFlowOffset(a);var c=b.getElementUI(a);c.drawBody()})}},this.setToolTipEnabled(Cd.NETWORK_TOOLTIP_ENABLED),this._view.addEventListener("scroll",function(a){oc.twm(b)}),this.addPropertyChangeListener(function(a){"zoom"===a.property&&oc.twm(b)})},Jb.ext("twaver.gl3dview.Gl3dview",Ib.controls.View,{__accessor:["selectMode","makeVisibleOnSelected","movableFunction","editPointSize","editPointFillColor","editPointOutlineWidth","editPointOutlineColor","editLineColor","editLineWidth","resizePointSize","resizePointFillColor","resizePointOutlineWidth","resizePointOutlineColor","resizeLineColor","resizeLineWidth","rotatePointSize","rotatePointFillColor","rotatePointOffset","rotatePointOutlineWidth","rotatePointOutlineColor","rotateScaleFillColor","rotateScaleFontColor","rotateScaleWidth","rotateScaleHeight","selectOutlineColor","selectOutlineWidth","selectFillColor","lazyMoveOutlineColor","lazyMoveOutlineWidth","lazyMoveFillColor","rectSelectFilter","selectionTolerance"],__bool:["doubleClickToUpSubGl3dview","doubleClickToSubGl3dview","doubleClickToEmptySubGl3dview","doubleClickToLinkBundle","doubleClickToGroupExpand","subGl3dviewAnimate","lazyMoveAnimate","resizeAnimate","noAgentLinkVisible","keyboardRemoveEnabled","keyboardSelectEnabled","sendToTopOnSelected","lazyMoveFill","editingElement","rotatingElement","movingElement","selectingElement","rectSelectEnabled","limitElementInPositiveLocation","showRotateScale","transparentSelectionEnable"],_viewRect:{x:0,y:0,width:0,height:0},_currentSubGl3dview:null,_selectMode:Cd.NETWORK_SELECT_MODE,_noAgentLinkVisible:Cd.NETWORK_NO_AGENT_LINK_VISIBLE,_makeVisibleOnSelected:Cd.NETWORK_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Cd.NETWORK_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Cd.NETWORK_KEYBOARD_SELECT_ENABLED,_rectSelectEnabled:Cd.NETWORK_RECT_SELECT_ENABLED,_rectSelectFilter:null,_subGl3dviewAnimate:Cd.NETWORK_SUBNETWORK_ANIMATE,_transparentSelectable:Cd.NETWORK_TRANSPARENT_SELECTABLE,_removeElementUIOnInvisible:Cd.NETWORK_REMOVE_ELEMENTUI_ON_INVISIBLE,_elementUIFunction:Cd.ELEMENTUI_FUNCTION,_doubleClickToUpSubGl3dview:Cd.NETWORK_DOUBLECLICK_TO_UPSUBNETWORK,_doubleClickToSubGl3dview:Cd.NETWORK_DOUBLECLICK_TO_SUBNETWORK,_doubleClickToEmptySubGl3dview:Cd.NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK,_doubleClickToLinkBundle:Cd.NETWORK_DOUBLECLICK_TO_LINKBUNDLE,_doubleClickToGroupExpand:Cd.NETWORK_DOUBLECLICK_TO_GROUPEXPAND,_sendToTopOnSelected:Cd.NETWORK_SENDTOTOP_ON_SELECTED,_selectOutlineColor:Cd.NETWORK_SELECT_OUTLINE_COLOR,_selectOutlineWidth:Cd.NETWORK_SELECT_OUTLINE_WIDTH,_selectFillColor:Cd.NETWORK_SELECT_FILL_COLOR,_lazyMoveOutlineColor:Cd.NETWORK_LAZYMOVE_OUTLINE_COLOR,_lazyMoveOutlineWidth:Cd.NETWORK_LAZYMOVE_OUTLINE_WIDTH,_lazyMoveFillColor:Cd.NETWORK_LAZYMOVE_FILL_COLOR,_lazyMoveFill:Cd.NETWORK_LAZYMOVE_FILL,_lazyMoveAnimate:Cd.NETWORK_LAZYMOVE_ANIMATE,_editPointSize:Cd.NETWORK_EDIT_POINT_SIZE,_editPointFillColor:Cd.NETWORK_EDIT_POINT_FILL_COLOR,_editPointOutlineColor:Cd.NETWORK_EDIT_POINT_OUTLINE_COLOR,_editPointOutlineWidth:Cd.NETWORK_EDIT_POINT_OUTLINE_WIDTH,_editLineColor:Cd.NETWORK_EDIT_LINE_COLOR,_editLineWidth:Cd.NETWORK_EDIT_LINE_WIDTH,_resizePointSize:Cd.NETWORK_RESIZE_POINT_SIZE,_resizePointFillColor:Cd.NETWORK_RESIZE_POINT_FILL_COLOR,_resizePointOutlineColor:Cd.NETWORK_RESIZE_POINT_OUTLINE_COLOR,_resizePointOutlineWidth:Cd.NETWORK_RESIZE_POINT_OUTLINE_WIDTH,_resizeLineColor:Cd.NETWORK_RESIZE_LINE_COLOR,_resizeLineWidth:Cd.NETWORK_RESIZE_LINE_WIDTH,_resizeAnimate:Cd.NETWORK_RESIZE_ANIMATE,_rotatePointSize:Cd.NETWORK_ROTATE_POINT_SIZE,_rotatePointFillColor:Cd.NETWORK_ROTATE_POINT_FILL_COLOR,_rotatePointOffset:Cd.NETWORK_ROTATE_POINT_OFFSET,_rotatePointOutlineWidth:Cd.NETWORK_ROTATE_POINT_OUTLINE_WIDTH,_rotatePointOutlineColor:Cd.NETWORK_ROTATE_POINT_OUTLINE_COLOR,_rotateScaleWidth:Cd.NETWORK_ROTATE_SCALE_WIDTH,_rotateScaleHeight:Cd.NETWORK_ROTATE_SCALE_HEIGHT,_rotateScaleFillColor:Cd.NETWORK_ROTATE_SCALE_FILL_COLOR,_rotateScaleFontColor:Cd.NETWORK_ROTATE_SCALE_FONT_COLOR,_limitElementInPositiveLocation:Cd.NETWORK_LIMIT_ELEMENT_INPOSITIVE_LOCATION,_linkFlowInterval:Cd.NETWORK_LINK_FLOW_INTERVAL,_selectionTolerance:Cd.NETWORK_SELECTION_TOLERANCE,_invalidate:!1,_invalidateElementVisibility:!1,_invalidateElementIndex:!1,_isEditingElement:!1,_isRotatingElement:!1,_isMovingElement:!1,_isSelectingElement:!1,_hasEditInteraction:!1,_showRotateScale:!0,_autoAdjustBounds:!1,_transparentSelectionEnable:Ib.Defaults.NETWORK_TRANSPARENT_SELECTION_ENABLE,setAutoAdjustBounds:function(b){b===!0?Wb.addEventListener("resize","handleResize",a,this):Wb.removeEventListener("resize",a,this),this._autoAdjustBounds=b},isAutoAdjustBounds:function(){return this._autoAdjustBounds},handleResize:function(a){this.adjustBounds({x:0,y:0,width:Ob.documentElement.clientWidth,height:Ob.documentElement.clientHeight})},getLabel:function(a){return a.getStyle("gl3dview.label")||a.getName()},isToolTipEnabled:function(){return this._toolTipEnabled?!0:!1},setToolTipEnabled:function(a){if(this._toolTipEnabled=a,a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){var c=b.getElementAt(a);if(b._preElement!==c)if(b._preElement=c,c){var d=b.getToolTip(c);Bc.showToolTip({x:a.pageX,y:a.pageY},d);var e=Bc.getToolTipDiv();if(e.children.length>0){var f=b._view.getBoundingClientRect(),g=e.getBoundingClientRect();g.width+g.left>f.width+f.left&&(e.style.left=f.width+f.left-g.width+(Ob.documentElement.scrollLeft||Ob.body.scrollLeft)+"px"),g.height+g.top>f.height+f.top&&(e.style.top=f.height+f.top-g.height+(Ob.documentElement.scrollTop||Ob.body.scrollTop)+"px")}}else Bc.hideToolTip()},this._view.addEventListener("mousemove",this._toolTipListener,!0),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Bc.hideToolTip(),this._view.removeEventListener("mousemove",this._toolTipListener,!0),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},isLinkFlowEnabled:function(){return this._linkFlowEnabled?!0:!1},setLinkFlowEnabled:function(a){a?(this._linkFlowEnabled||(this._linkFlowEnabled=!0,this.firePropertyChange("linkFlowEnabled",!1,!0)),clearInterval(this._linkFlowTimerId),this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval)):(this._linkFlowEnabled&&(this._linkFlowEnabled=!1,this.firePropertyChange("linkFlowEnabled",!0,!1)),clearInterval(this._linkFlowTimerId),delete this._linkFlowTimerId)},getLinkFlowInterval:function(){return this._linkFlowInterval},setLinkFlowInterval:function(a){var b=this._linkFlowInterval;this._linkFlowInterval=a,this.firePropertyChange("linkFlowInterval",b,a),clearInterval(this._linkFlowTimerId),this.isLinkFlowEnabled()&&(this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval))},getTopDiv:function(){return this._topDiv},getAttachmentDiv:function(){return this._attachmentDiv},getLayersDiv:function(){return this._layersDiv},getBottomDiv:function(){return this._bottomDiv},validateImpl:function(){if(oc.twm(this),this.__lics__){var a=0,b=null,c=null,d=null,e=this._invalidateElementVisibility;if(this._invalidateElementVisibility&&(this._invalidateElementVisibility=!1,this._removeElementUIOnInvisible&&(this._invalidateElementIndex=!0),this.forEachElementUI(function(e){e.validate();var f=e.getElement();if(e.setVisible(this.isVisible(f)),this._removeElementUIOnInvisible){if(b=this.getLayerDivByElement(f),e.isVisible()){if(e.getView().parentNode!==b)for(b.appendChild(e.getView()),c=e.getAttachments(),a=0;a<c.size();a++)d=c.get(a),d.isShowInAttachmentDiv()&&this._attachmentDiv.appendChild(d.getView())}else if(e.getView().parentNode===b)for(b.removeChild(e.getView()),c=e.getAttachments(),a=0;a<c.size();a++)d=c.get(a),d.isShowInAttachmentDiv()&&this._attachmentDiv.removeChild(d.getView())}else if(!e.getView().parentNode)for(b=this.getLayerDivByElement(f),b.appendChild(e.getView()),c=e.getAttachments(),a=0;a<c.size();a++)d=c.get(a),d.isShowInAttachmentDiv()&&this._attachmentDiv.appendChild(d.getView())},null,this)),this._invalidateElementIndex){this._invalidateElementIndex=!1;var f,g=this;this._box.getLayerBox().forEachByDepthFirst(function(a){var b,c=g._layerMap[a.getId()];g._box.forEachByLayer(function(a){var d=g._elementUIMap[a.getId()];if(d&&d.getView().parentNode===c){b=Wb.insertAfter(d.getView(),b);for(var e=d.getAttachments(),h=0;h<e.size();h++){var i=e.get(h);i.getView().parentNode===g._attachmentDiv&&(f=Wb.insertAfter(i.getView(),f))}}},a)})}if(e&&!this._invalidateElementVisibility){var h;for(var i in this._elementUIMap){var j=this._elementUIMap[i];j.isVisible()&&(h=Tb.unionRect(h,j.getViewRect()))}if(h=h?{x:0,y:0,width:h.x+h.width,height:h.y+h.height}:{x:0,y:0,width:0,height:0},h.x!==this._viewRect.x||h.y!==this._viewRect.y||h.width!==this._viewRect.width||h.height!==this._viewRect.height){
var k=this._viewRect;this._viewRect=h,this._rootDiv.style.left="0px",this._rootDiv.style.top="0px",this._rootDiv.style.width=h.width+"px",this._rootDiv.style.height=h.height+"px",this.firePropertyChange("viewRect",k,h)}}}},setInteractions:function(a){var b=this._interactions;b&&b.forEach(function(a){a.tearDown()}),this._interactions=a,a&&a.forEach(function(a){a.setUp()}),this.invalidateSelectedElementUIs(!0),this.firePropertyChange("interactions",b,a)},getInteractions:function(){return this._interactions},upSubGl3dview:function(a,b){this._currentSubGl3dview&&this.setCurrentSubGl3dview(vc.getSubGl3dview(this._currentSubGl3dview),a,b)},sendToTop:function(a){if(this.isVisible(a)){for(var b=a;this.isVisible(b.getParent())&&(b=b.getParent()););b!==a&&this._box.adjustElementIndex(b),this._box.adjustElementIndex(a)}},invalidateElementIndex:function(){this._invalidateElementIndex||(this._invalidateElementIndex=!0,this.invalidate())},invalidateElementVisibility:function(){this._invalidateElementVisibility||(this._invalidateElementVisibility=!0,this.invalidate())},updateLayers:function(){Wb.clear(this._layersDiv),Wb.clear(this._attachmentDiv),this._layerMap={},this._layerList.clear();var a=this;this._box.getLayerBox().forEachByDepthFirst(function(b){var c=Wb.createDiv();Wb.setVisible(c,b.isVisible()),a._layerMap[b.getId()]=c,a._layersDiv.appendChild(c),a._layerList.add(b)}),this._box.forEach(this.createElementUI,this)},getCurrentSubGl3dview:function(){return this._currentSubGl3dview},setCurrentSubGl3dview:function(a,b,c){var d=Ib.animate.AnimateManager;if(d.endAnimate(),b){if(this._currentSubGl3dview===a)return;if(a&&!this._box.contains(a))throw a+" is not contained in this gl3dview's elementBox";d.start(new Ib.animate.AnimateSubGl3dview(this,a,c))}else this._setCurrentSubGl3dview(a),c&&c()},_setCurrentSubGl3dview:function(a){if(this._currentSubGl3dview!==a){if(a&&!this._box.contains(a))throw a+" is not contained in this gl3dview's elementBox";var b=this._currentSubGl3dview;this._currentSubGl3dview=a,this.firePropertyChange("currentSubGl3dview",b,a),this.invalidateElementVisibility()}},isVisible:function(a){if(!this._box.contains(a))return!1;if(!a.isVisible())return!1;if(this._visibleFunction&&!this._visibleFunction(a))return!1;if(!this._box.getLayerBox().getLayerByElement(a).isVisible())return!1;if(vc.getSubGl3dview(a)!==this._currentSubGl3dview)return!1;if(a instanceof Ib.Link){if(!this.isNoAgentLinkVisible()){if(!a.getFromAgent()||!a.getToAgent())return!1;if(!this.isVisible(a.getFromAgent())||!this.isVisible(a.getToAgent()))return!1}if(a.getBundleIndex()>0&&a.getBundleCount()>1&&!a.getStyle("link.bundle.expanded"))return!1}else for(var b=a.getParent();b&&!b.ISubGl3dview;){if(b instanceof Ld&&(!b.isExpanded()||!this.isVisible(b)))return!1;b=b.getParent()}return a.IDummy?!1:!0},isMovable:function(a){return this._box.contains(a)?a instanceof Ib.Link?!1:this._movableFunction&&!this._movableFunction(a)?!1:this._box.getLayerBox().getLayerByElement(a).isMovable():!1},isEditable:function(a){return this._box.contains(a)?this._editableFunction&&!this._editableFunction(a)?!1:this._box.getLayerBox().getLayerByElement(a).isEditable():!1},isRotatable:function(a){return this._rotatableFunction&&!this._rotatableFunction(a)?!1:!0},getVisibleFunction:function(){return this._visibleFunction},setVisibleFunction:function(a){var b=this._visibleFunction;this._visibleFunction=a,this.firePropertyChange("visibleFunction",b,a),this.invalidateElementVisibility()},getEditableFunction:function(){return this._editableFunction},setEditableFunction:function(a){var b=this._editableFunction;this._editableFunction=a,this.firePropertyChange("editableFunction",b,a),this.invalidateSelectedElementUIs(!0)},getRotatableFunction:function(){return this._rotatableFunction},setRotatableFunction:function(a){var b=this._rotatableFunction;this._rotatableFunction=a,this.firePropertyChange("rotatableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isLinkable:function(a){return null==this._linkableFunction||this._linkableFunction(a)},getLinkableFunction:function(){return this._linkableFunction},setLinkableFunction:function(a){var b=this._linkableFunction;this._linkableFunction=a,this.firePropertyChange("linkableFunction",b,a),this.invalidateSelectedElementUIs(!0)},onShareSelectionContainerChanged:function(){this.invalidateElementUIs()},getElementBox:function(){return this._box},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeServaChangeListener(this.handleElementBoxChange,this),b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removePropertyChangeListener(this.handleElementBoxPropertyChange,this),b.removeIndexChangeListener(this.handleIndexChange,this),b.getLayerBox().removeServaChangeListener(this.handleLayerBoxChange,this),b.getLayerBox().removeDataPropertyChangeListener(this.handleLayerPropertyChange,this),b.getLayerBox().removeHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._selectionContainer||b.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addServaChangeListener(this.handleElementBoxChange,this),this._box.addDataPropertyChangeListener(this.handleElementPropertyChange,this),this._box.addPropertyChangeListener(this.handleElementBoxPropertyChange,this),this._box.addIndexChangeListener(this.handleIndexChange,this),this._box.getLayerBox().addServaChangeListener(this.handleLayerBoxChange,this),this._box.getLayerBox().addDataPropertyChangeListener(this.handleLayerPropertyChange,this),this._box.getLayerBox().addHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._flowLinkQuickFinder&&(this._flowLinkQuickFinder.dispose(),this._flowLinkQuickFinder=new Ib.QuickFinder(this._box,"link.flow","style")),this._selectionContainer?this._selectionContainer._setServa(a):this._box.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this._elementUIMap={},this.updateLayers(),this.invalidateElementVisibility(),this.firePropertyChange("elementBox",b,this._box)}},invalidateElementUI:function(a,b){var c=this.getElementUI(a);c&&c.invalidate(b)},invalidateElementUIs:function(a){for(var b in this._elementUIMap){var c=this._elementUIMap[b];c.invalidate(a)}},invalidateSelectedElementUIs:function(a){this.getSelectionContainer().getSelection().forEach(function(b){this.invalidateElementUI(b,a)},this)},getElementUI:function(a){return a?this._elementUIMap[a.getId()]:null},getLayerDivByElement:function(a){var b=this._box.getLayerBox().getLayerByElement(a);return b?this._layerMap[b.getId()]:null},createElementUI:function(a){var b=this._elementUIMap[a.getId()];if(b||(b=this._elementUIFunction(this,a),b&&(this._elementUIMap[a.getId()]=b)),b){var c=this.getLayerDivByElement(a);b.getView().parentNode!==c&&(c.appendChild(b.getView()),b.getAttachments().forEach(function(a){a.isShowInAttachmentDiv()&&a.getView().parentNode!==this._attachmentDiv&&this._attachmentDiv.appendChild(a.getView())},this)),this.invalidateElementIndex()}},invalidateBundleLink:function(a){if(a instanceof Ib.Link&&a._bundleLinks){var b=this._elementUIMap;a._bundleLinks.forEachSiblingLink(function(c){if(c!==a){var d=b[c._id];d&&d.invalidate(!1)}},this)}},handleLayerBoxChange:function(a){this.updateLayers(),this.invalidateElementVisibility()},handleLayerPropertyChange:function(a){var b=a.source;if("visible"===a.property){var c=this._layerMap[b.getId()];Wb.setVisible(c,b.isVisible())}else"editable"===a.property&&this.invalidateSelectedElementUIs(!0);this.invalidateElementVisibility()},handleLayerHierarchyChange:function(a){var b;this._layerList.clear(),this._box.getLayerBox().forEachByDepthFirst(function(a){var c=this._layerMap[a.getId()];b=Wb.insertAfter(c,b),this._layerList.add(a)},null,this),this.invalidateElementVisibility()},handleSelectionChange:function(a){a.datas.forEach(function(b){var c=this.getElementUI(b);c&&c.handleSelectionChange(a)},this),this.invalidateElementVisibility();var b=this.getSelectionContainer().getLastData();b&&("append"===a.kind||"set"===a.kind)&&(this.isMakeVisibleOnSelected()&&this.makeVisible(b),this.isSendToTopOnSelected()&&this.sendToTop(b))},makeVisible:function(a){var b=this.getElementUI(a);if(b){var c=vc.getSubGl3dview(a);if(c!==this._currentSubGl3dview){var d=this;return void this.setCurrentSubGl3dview(c,this.isSubGl3dviewAnimate(),function(){Jb.callLater(d.makeVisible,d,[a])})}for(var e=a;(e=e.getParent())&&e!==c;)e instanceof Ld&&e.setExpanded(!0);var f=b.getUnionBodyBounds();if(f){var g={x:this._view.scrollLeft/this._zoom,y:this._view.scrollTop/this._zoom,width:this._view.clientWidth/this._zoom,height:this._view.clientHeight/this._zoom};Tb.intersects(g,f)||this.isVisible(a)&&Jb.callLater(this.centerByLogicalPoint,this,[f.x+f.width/2,f.y+f.height/2])}}},handleElementBoxChange:function(a){var b=a.data;if("add"===a.kind)this.createElementUI(b),this.invalidateBundleLink(b);else if("remove"===a.kind){var c=this.getElementUI(b);if(c){var d=this._box.getLayerBox().getLayerByElement(b),e=this._layerMap[d.getId()];c.getView().parentNode===e&&e.removeChild(c.getView()),c.dispose(),delete this._elementUIMap[b.getId()]}b===this._currentSubGl3dview&&null!=this._currentSubGl3dview&&this._setCurrentSubGl3dview(null)}else"clear"===a.kind&&(this.forEachElementUI(function(a){a.dispose()}),this._elementUIMap={},this.updateLayers(),null!=this._currentSubGl3dview&&this._setCurrentSubGl3dview(null));this.invalidateElementVisibility()},handleElementPropertyChange:function(a){var b=a.source,c=this.getElementUI(b);if(c&&(c.handlePropertyChange(a),"layerId"===a.property)){var d=this._box.getLayerBox().getLayerByElement(b),e=this._layerMap[d.getId()];c.getView().parentNode!==e&&(e.appendChild(c.getView()),this.invalidateElementIndex())}this.invalidateBundleLink(b),this.invalidateElementVisibility()},handleElementBoxPropertyChange:function(a){this.invalidateElementVisibility()},handleIndexChange:function(a){this.invalidateElementIndex()},getElementUIFunction:function(){return this._elementUIFunction},setElementUIFunction:function(a){if(!a)throw"ElementUIFunction can not be null";if(this._elementUIFunction!==a){var b=this._elementUIFunction;this._elementUIFunction=a,this.firePropertyChange("elementUIFunction",b,a),this._box.isEmpty()||this.updateLayers()}},getIconsNames:function(a){return a.getStyle("icons.names")},getIconsColors:function(a){return a.getStyle("icons.colors")},getLinkHandlerLabel:function(a){return a.isBundleAgent()?"+("+a.getBundleCount()+")":null},getSelectColor:function(a){return a.getStyle("select.color")},getShadowColor:function(a){var b=a.getStyle("shadow.color");return!b&&this.isSelected(a)&&"shadow"===a.getStyle("select.style")?a.getStyle("select.color"):b},getAlarmLabel:function(a){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b){var c=a.getAlarmState().getNewAlarmCount(b)+b.nickName;return a.getAlarmState().hasLessSevereNewAlarms()&&(c+="+"),c}return null},isRemoveElementUIOnInvisible:function(){return this._removeElementUIOnInvisible},setRemoveElementUIOnInvisible:function(a){var b=this._removeElementUIOnInvisible;this._removeElementUIOnInvisible=a,this.firePropertyChange("removeElementUIOnInvisible",b,a),this.invalidateElementVisibility()},setDefaultInteractions:function(a,b){var c=[new Ib.gl3dview.interaction.SelectInteraction(this),new Ib.gl3dview.interaction.MoveInteraction(this,a),new Ib.gl3dview.interaction.DefaultInteraction(this)];b&&c.push(new Ib.gl3dview.interaction.MoveLinkInteraction(this,a)),this.setInteractions(c)},setPanInteractions:function(){this.setInteractions([new Ib.gl3dview.interaction.PanInteraction(this),new Ib.gl3dview.interaction.DefaultInteraction(this)])},setEditInteractions:function(a,b){var c=[new Ib.gl3dview.interaction.SelectInteraction(this),new Ib.gl3dview.interaction.EditInteraction(this,a),new Ib.gl3dview.interaction.MoveInteraction(this,a),new Ib.gl3dview.interaction.DefaultInteraction(this)];b&&c.push(new Ib.gl3dview.interaction.MoveLinkInteraction(this,a)),this.setInteractions(c)},setCreateElementInteractions:function(a){this.setInteractions([new Ib.gl3dview.interaction.CreateElementInteraction(this,a),new Ib.gl3dview.interaction.DefaultInteraction(this)])},setCreateLinkInteractions:function(a){this.setInteractions([new Ib.gl3dview.interaction.CreateLinkInteraction(this,a),new Ib.gl3dview.interaction.DefaultInteraction(this)])},setCreateShapeLinkInteractions:function(a){this.setInteractions([new Ib.gl3dview.interaction.CreateShapeLinkInteraction(this,a),new Ib.gl3dview.interaction.DefaultInteraction(this)])},setCreateShapeNodeInteractions:function(a){this.setInteractions([new Ib.gl3dview.interaction.CreateShapeNodeInteraction(this,a),new Ib.gl3dview.interaction.DefaultInteraction(this)])},setTouchInteractions:function(){this.setInteractions([new Ib.gl3dview.interaction.TouchInteraction(this)])},setMSTouchInteractions:function(){this.setInteractions([new Ib.gl3dview.interaction.MSTouchInteraction(this)])},setMagnifyInteractions:function(){this.setInteractions([new Ib.gl3dview.interaction.SelectInteraction(this),new Ib.gl3dview.interaction.MoveInteraction(this),new Ib.gl3dview.interaction.DefaultInteraction(this),new Ib.gl3dview.interaction.MagnifyInteraction(this)])},hasEditInteraction:function(){return this._hasEditInteraction},setHasEditInteraction:function(a){var b=this._hasEditInteraction;this._hasEditInteraction=a,this.firePropertyChange("hasEditInteraction",b,a)},moveSelectedElements:function(a,b,c,d){if(0!==a||0!==b){var e=this.getMovableSelectedElementsRect();null!=e&&(this._limitElementInPositiveLocation&&(e.x+a<0&&(a=-e.x),e.y+b<0&&(b=-e.y)),Ib.Util.moveElements(this.getMovableSelectedElements(),a,b,c,d,this))}},getMovableSelectedElements:function(){return this.getSelectionContainer().toSelection(function(a){return this.isMovable(a)},this)},hasMovableSelectedElements:function(){for(var a=this.getSelectionContainer().getSelection(),b=0;b<a.size();b++){var c=a.get(b);if(this.isMovable(c))return!0}return!1},getMovableSelectedElementsRect:function(){var a=this.getMovableSelectedElements();if(0===a.size())return null;for(var b=null,c=0,d=a.size();d>c;c++){var e=a.get(c);if(e instanceof Jd){var f=this.getElementUI(e);f&&(b=Tb.unionRect(b,f.getViewRect()))}}return b},getLayerByElement:function(a){return this._box.getLayerBox().getLayerByElement(a)},getPosition:function(a,b,c,d,e){var f,g=b instanceof Ib.gl3dview.ElementUI?b:this.getElementUI(b);if(g)if("from"===a||"to"===a){if(g.getFromPosition&&(f="from"===a?g.getFromPosition(d,e):g.getToPosition(d,e)))return{x:f.x-c.width/2,y:f.y-c.height/2}}else f="hotspot"===a?g.getHotSpot():Vb.get(a,g.getBodyRect(),c);if(!f&&b.getRect&&(f=Vb.get(a,b.getRect(),c)),f)return{x:f.x+d,y:f.y+e};throw"position '"+a+"' object '"+b+"'"},getViewRect:function(){return this._viewRect?Jb.clone(this._viewRect):{x:0,y:0,width:0,height:0}},forEachElementUI:function(a,b,c){b?this._box.forEachReverse(function(d){if(this.getLayerByElement(d)===b){var e=this.getElementUI(d);e&&(c?a.call(c,e):a(e))}},this):this._layerList.forEachReverse(function(b){this.forEachElementUI(a,b,c)},this)},findFirstElement:function(a,b){for(var c=this._layerList.size()-1,d=this._box.size()-1,e=c;e>=0;e--)for(var f=this._layerList.get(e),g=d;g>=0;g--){var h=this._box.getDataAt(g);if(this.getLayerByElement(h)===f)if(b){if(a.call(b,h)===!0)return h}else if(a(h)===!0)return h}return null},getElementAt:function(a,b){if(1===arguments.length&&(b=!0),!this.isValidEvent(a))return null;a=this._getPoint(a),a||console.log("null");var c=a.x,d=a.y,e=this._selectionTolerance;if(e&&e>0){var f={x:c,y:d,width:0,height:0};Tb.grow(f,e,e)}return this.findFirstElement(function(a){if(b&&!this.isSelectable(a))return!1;var e=this.getElementUI(a);return e?f?!!e.intersectsTest(f):!!e.hitTest(c,d):!1},this)},_getPoint:function(a){return a?a.target?this.getLogicalPoint(a):a:null},getElementsAtRect:function(a,c,d,e){var f=new md;return e=e===b?!0:e,this.forEachElementUI(function(b){b.isVisible()&&(!d||d(b._element))&&(e&&this.isSelectable(b._element)||!e)&&(c?b.intersectsTest(a)&&f.add(b._element):Tb.contains(a,b.getViewRect())&&f.add(b._element))},null,this),f},hitTest:function(a){var b=this.getElementAt(a);if(!b)return null;var c=this.getElementUI(b);return c?(a=this._getPoint(a),c.hitTest(a.x,a.y)):null},addElementByInteraction:function(a){a.getParent()||a.setParent(this._currentSubGl3dview),this._box.add(a),this.getSelectionContainer().setSelection(a),this.fireInteractionEvent({kind:"createElement",element:a})},getLinkFlowStepping:function(a){var b=parseInt(a.getStyle("link.flow.stepping"));return b||(b=Cd.NETWORK_LINK_FLOW_STEPPING),b},getLinkFlowOffset:function(a){var b=a.getStyle("link.flow.offset");return isNaN(b)&&(b=0),b+this.getLinkFlowStepping(a)},toCanvas:function(a,b,c){c||(c=Wb.createCanvas()),c.setAttribute("width",a),c.setAttribute("height",b),c._viewRect?(c._viewRect.width=a,c._viewRect.height=b):c._viewRect={x:0,y:0,width:a,height:b};var d=c.getContext("2d");if(d.clearRect(0,0,a,b),0===this._view.clientWidth||0===this._view.clientHeight)return c;var e=a/this._view.scrollWidth*this._zoom,f=b/this._view.scrollHeight*this._zoom;return d.scale(e,f),Wb.forEach(this._view,function(a){if(("CANVAS"===a.tagName||"IMG"===a.tagName)&&!a._isIgnored){var b=a._viewRect;if(b)try{d.drawImage(a,b.x,b.y,b.width,b.height)}catch(a){}}}),c},toCanvasByRegion:function(a,b,c){c||(c=Wb.createCanvas());var d=a.width*b,e=a.height*b;c.setAttribute("width",d),c.setAttribute("height",e);var f=c.getContext("2d");return f.clearRect(0,0,d,e),0===this._view.clientWidth||0===this._view.clientHeight?c:(f.save(),f.scale(b,b),Wb.forEach(this._view,function(b){if(("CANVAS"===b.tagName||"IMG"===b.tagName)&&!b._isIgnored){var c=b._viewRect;if(c&&Tb.intersects(c,a))try{f.drawImage(b,c.x-a.x,c.y-a.y,c.width,c.height)}catch(b){}}}),f.restore(),c)},getGroupChildrenRects:function(a){var b=new md;return a.getChildren().forEach(function(a){if(a instanceof Jd){var c=this.getElementUI(a);if(c){var d=c.getViewRect();d&&b.add(d)}}},this),b},getLinkPathFunction:function(){return this._linkPathFunction},setLinkPathFunction:function(a){var b=this._linkPathFunction;this._linkPathFunction=a,this.firePropertyChange("linkPathFunction",b,a),this.invalidateElementUIs()},onClickElement:function(a,b){},onClickBackground:function(a){},onDoubleClickElement:function(a,b){},onDoubleClickBackground:function(a){},onLongClickElement:function(a,b){},onLongClickBackground:function(a){},onMouseMove:function(a,b){},onMouseEnter:function(a,b){},onMouseLeave:function(a,b){}}),Ib.gl3dview.Overview=function(a){Ib.gl3dview.Overview.superClass.constructor.apply(this,arguments),this._view=Wb.createView(),this._rootDiv=Wb.createDiv(),this._imageCanvas=Wb.createCanvas(),this._imageDiv=Wb.createDiv(),this._maskCanvas=Wb.createCanvas(),this._selectDiv=Wb.createDiv(),this._isGl3dviewDirty=!1,this._isMaskDirty=!1,Wb.setVisible(this._selectDiv,!1),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._imageDiv),this._rootDiv.appendChild(this._maskCanvas),this._rootDiv.appendChild(this._selectDiv),this._imageDiv.appendChild(this._imageCanvas),this.setGl3dview(a);var b;b=Qb.isMSToucheable?Ib.gl3dview.OverviewMSTouchInteraction:Qb.isTouchable?Ib.gl3dview.OverviewTouchInteraction:Ib.gl3dview.OverviewInteraction,b&&new b(this)},Jb.ext("twaver.gl3dview.Overview",Ib.controls.ControlBase,{__accessor:["fillColor","outlineColor","outlineWidth","selectColor","selectWidth","padding","maxPackingWidth","maxPackingHeight"],__bool:["animate"],_fillColor:Cd.OVERVIEW_FILL_COLOR,_outlineColor:Cd.OVERVIEW_OUTLINE_COLOR,_outlineWidth:Cd.OVERVIEW_OUTLINE_WIDTH,_selectColor:Cd.OVERVIEW_SELECT_COLOR,_selectWidth:Cd.OVERVIEW_SELECT_WIDTH,_padding:Cd.OVERVIEW_PADDING,_animate:Cd.OVERVIEW_ANIMATE,_maxPackingWidth:Cd.OVERVIEW_MAX_PACKING_WIDTH,_maxPackingHeight:Cd.OVERVIEW_MAX_PACKING_HEIGHT,getGl3dview:function(){return this._gl3dview},onPropertyChanged:function(a){this._invalidateMask()},setGl3dview:function(a){a!==this._gl3dview&&(this._gl3dview&&(this._gl3dview.removePropertyChangeListener(this._handleGl3dviewPropertyChange,this),this._gl3dview.removeViewListener(this._handleGl3dviewViewChange,this),Wb.removeEventListener("scroll","_handleScrollChange",this._gl3dview.getView(),this)),this._gl3dview=a,this._gl3dview&&(this._gl3dview.addPropertyChangeListener(this._handleGl3dviewPropertyChange,this),this._gl3dview.addViewListener(this._handleGl3dviewViewChange,this),Wb.addEventListener("scroll","_handleScrollChange",this._gl3dview.getView(),this)),this.invalidate())},_handleGl3dviewPropertyChange:function(a){("zoom"===a.property||"currentSubGl3dview"===a.property||"elementBox"===a.property||"dataBox"===a.property)&&this.invalidate()},_handleGl3dviewViewChange:function(a){"validateEnd"===a.kind&&this.invalidate()},_handleScrollChange:function(){this._invalidateMask()},invalidate:function(a){this._isGl3dviewDirty&&this._isMaskDirty||(this._isGl3dviewDirty||(this._isGl3dviewDirty=!0),this._isMaskDirty||(this._isMaskDirty=!0),Jb.callLater(this.validate,this,null,a))},_invalidateMask:function(){this._isMaskDirty||(this._isMaskDirty=!0,Jb.callLater(this.validate,this,[],100))},validate:function(){if((this._isMaskDirty||this._isGl3dviewDirty)&&this._gl3dview&&(this._maxPackingWidth>0&&this._maxPackingHeight>0||this._view.clientWidth>0&&this._view.clientHeight>0)&&0!==this._gl3dview._view.clientWidth&&0!==this._gl3dview._view.clientHeight){var a,b=this._maxPackingWidth>0&&this._maxPackingHeight>0;a=b?{x:0,y:0,width:this._maxPackingWidth,height:this._maxPackingHeight}:{x:0,y:0,width:this._view.clientWidth,height:this._view.clientHeight},Tb.grow(a,-this._padding,-this._padding);var c=Math.min(a.width/this._gl3dview._view.scrollWidth,a.height/this._gl3dview._view.scrollHeight);b&&(Wb.setDiv(this._view,{x:0,y:0,width:this._imageDiv._viewRect.width,height:this._imageDiv._viewRect.height},null,0,null),a.width=this._imageDiv._viewRect.width,a.height=this._imageDiv._viewRect.height);var d=this._gl3dview._view.scrollWidth*c,e=this._gl3dview._view.scrollHeight*c,f=a.x+(a.width-d)/2,g=a.y+(a.height-e)/2;if(this._isGl3dviewDirty){var h={x:f,y:g,width:d,height:e};this._gl3dview.toCanvas(h.width,h.height,this._imageCanvas),Wb.setDiv(this._imageDiv,h,null,0,null),this._gl3dview.getElementBox&&(this._imageDiv.style.backgroundColor=(this._gl3dview.getCurrentSubGl3dview()||this._gl3dview.getElementBox()).getStyle("background.color")||""),this._isGl3dviewDirty=!1}if(this._isMaskDirty){var i={x:this._gl3dview._view.scrollLeft*c,y:this._gl3dview._view.scrollTop*c,width:d*this._gl3dview._view.clientWidth/this._gl3dview._view.scrollWidth,height:e*this._gl3dview._view.clientHeight/this._gl3dview._view.scrollHeight},j=Wb.setCanvas(this._maskCanvas,f,g,d,e);j.lineWidth=0,j.fillStyle=this._fillColor,j.beginPath(),Xb.drawVector(j,"rectangle",null,f,g,d,e),j.fill(),j.clearRect(f+i.x,g+i.y,i.width,i.height);var k=this._outlineWidth<0?0:this._outlineWidth;j.lineWidth=k,j.strokeStyle=this._outlineColor,j.beginPath(),Xb.drawVector(j,"rectangle",null,f+i.x+k,g+i.y+k,i.width-2*k,i.height-2*k),k>=0&&j.stroke(),this._isMaskDirty=!1}}else this._isGl3dviewDirty=!1,this._isMaskDirty=!1},getLogicalPoint:function(a){return Wb.getLogicalPoint(this._view,a,1,this._rootDiv)},centerGl3dview:function(a,b){var c=this._imageDiv._viewRect;Tb.containsPoint(c,a)&&(this._gl3dview.centerByLogicalPoint((a.x-c.x)/c.width*this._gl3dview._view.scrollWidth/this._gl3dview.getZoom(),(a.y-c.y)/c.height*this._gl3dview._view.scrollHeight/this._gl3dview.getZoom(),b),this._invalidateMask())}}),Ib.gl3dview.OverviewTouchInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.gl3dview.OverviewTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),this.clear(),this.endPoint=this.overview.getLogicalPoint(a),zc.isMultiTouch(a)&&(this.distance=zc.getDistance(a),this.zoom=this.gl3dview.getZoom()),Wb.addEventListener("touchmove","handleTouchmove",this.view,this),Wb.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(Wb.preventDefault(a),this.moved||(this.moved=!0),this.endPoint=this.overview.getLogicalPoint(a),zc.isSingleTouch(a))this.overview.centerGl3dview(this.endPoint,!1);else if(this.distance){var b=zc.getDistance(a)/this.distance;this.gl3dview.setZoom(this.zoom*b,!1)}},handleTouchend:function(a){if(!this.moved){this.endPoint=this.overview.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date),b?Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]):this.overview.centerGl3dview(this.endPoint,this.overview._animate)}this.clear()},clear:function(){this.endPoint&&(this.endPoint=null,Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this)),this.moved=!1}}),Ib.gl3dview.OverviewInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,Wb.addEventListener("mousedown","handleMousedown",this.view,this)},Jb.ext("twaver.gl3dview.OverviewInteraction",Object,{handleMousedown:function(a){0===a.button&&(this.clear(),this.endPoint=this.overview.getLogicalPoint(a),Jb.isCtrlDown(a)&&(this.startPoint=this.endPoint,Wb.setVisible(this.overview._selectDiv,!0)),Wb.addEventListener("mousemove","handleMousemove",this.view,this),Wb.addEventListener("mouseup","handleMouseup",this.view,this))},handleMouseup:function(a){if(this.endPoint=this.overview.getLogicalPoint(a),"detail"in a&&2===a.detail)Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]);else if(Wb.isVisible(this.overview._selectDiv)&&this.startPoint){var b=this.overview._imageDiv._viewRect,c=this.overview._selectDiv._viewRect.x,d=this.overview._selectDiv._viewRect.y,e=b.width/this.overview._selectDiv._viewRect.width,f=b.height/this.overview._selectDiv._viewRect.height,g=Math.min(e,f),h=this.gl3dview._view.scrollWidth/this.gl3dview.getZoom()*((c-b.x+this.overview._selectDiv._viewRect.width/2)/b.width),i=this.gl3dview._view.scrollHeight/this.gl3dview.getZoom()*((d-b.y+this.overview._selectDiv._viewRect.height/2)/b.height);this.gl3dview.setZoom(g*Math.min(this.gl3dview._view.clientWidth/this.gl3dview._view.scrollWidth,this.gl3dview._view.clientHeight/this.gl3dview._view.scrollHeight)*this.gl3dview.getZoom(),!1),Jb.callLater(this.gl3dview.centerByLogicalPoint,this.gl3dview,[h,i,this.overview._animate]),Wb.setVisible(this.overview._selectDiv,!1),Wb.setDiv(this.overview._selectDiv,{x:0,y:0,width:0,height:0},null,0,null),this.startPoint=null}else this.overview.centerGl3dview(this.endPoint,this.overview._animate);this.clear()},handleMousemove:function(a){var b=this.overview.getLogicalPoint(a);if(this.endPoint=b,Wb.isVisible(this.overview._selectDiv)&&this.startPoint){var c=b.x>this.startPoint.x?this.startPoint.x:b.x,d=b.x>this.startPoint.x?this.startPoint.y:b.y;b.x>this.startPoint.x&&b.y<this.startPoint.y&&(d=b.y),b.x<this.startPoint.x&&b.y>this.startPoint.y&&(d=this.startPoint.y);var e=this.overview._imageDiv._viewRect;c<e.x&&(c=e.x),c>e.x+e.width&&(c=e.x+e.width),d<e.y&&(d=e.y),d>e.y+e.height&&(d=e.y+e.height);var f=Math.abs(b.x-this.startPoint.x),g=Math.abs(b.y-this.startPoint.y);c+f>e.x+e.width&&(f=e.x+e.width-c),d+g>e.y+e.height&&(g=e.y+e.height-d),Wb.setDiv(this.overview._selectDiv,{x:c,y:d,width:f,height:g},null,this.overview._selectWidth,this.overview._selectColor)}else this.overview.centerGl3dview(b,!1)},clear:function(){this.endPoint&&(this.endPoint=null,Wb.removeEventListener("mousemove",this.view,this),Wb.removeEventListener("mouseup",this.view,this))}}),Ib.gl3dview.OverviewMSTouchInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,this._pointerMap={},this._pointerIdArray=[];var b=this;this.view.addEventListener("MSPointerDown",function(a){b.handleTouchstart(a)},!1),this.view.addEventListener("MSPointerMove",function(a){b.handleTouchmove(a)},!1),this.view.addEventListener("MSPointerUp",function(a){b.handleTouchend(a)},!1),this.view.addEventListener("MSPointerCancel",function(a){b.handleTouchend(a)},!1)},Jb.ext("twaver.gl3dview.OverviewMSTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&this.overview.getLogicalPoint(a)&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length?(this._startTouchPoint=this.overview.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.gl3dview.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.gl3dview.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&this._startTouchPoint){var c=this.overview.getLogicalPoint(a);if(null==c)return;this._startTouchPoint=c,this.overview.centerGl3dview(this._startTouchPoint,!1)}},handleTouchend:function(a){var b=this.overview.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b){var c=this._endTouchPoint&&this._endTouchTime&&(new Date).getTime()-this._endTouchTime.getTime()<=500&&Tb.getDistance(this._endTouchPoint,b)<=10;c?(this._endTouchPoint=null,this._endTouchTime=null):(this._endTouchPoint=b,this._endTouchTime=new Date),c?Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]):this.overview.centerGl3dview(this._endTouchPoint,this.overview._animate)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Ib.gl3dview.ElementUI=function(a,b){this._view=Wb.createDiv(),this._bodyView=Wb.createDiv(),this._view.appendChild(this._bodyView),this._gl3dview=a,this._element=b,this._attachments=new md,this._bodyBounds=new md,this.invalidate(!0)},Jb.ext("twaver.gl3dview.ElementUI",Object,{_invalidateFlag:!1,_invalidateAttachmentsFlag:!1,getElement:function(){return this._element},getGl3dview:function(){return this._gl3dview},getAttachments:function(){return this._attachments},getStyle:function(a){return this._element.getStyle(a)},getFont:function(a){var b=this._element.getStyle(a);return b?b:Cd.FONT},getDyeColor:function(a){return this._innerColor?this._innerColor:this.getStyle(a)},getInnerColor:function(){return this._innerColor},getOuterColor:function(){return this._outerColor},getShadowColor:function(){return this._shadowColor},getLabelAttachment:function(){return this._labelAttachment},getAlarmAttachment:function(){return this._alarmAttachment},getIconsAttachment:function(){return this._iconsAttachment},getEditAttachment:function(){return this._editAttachment},getHotSpot:function(){return this._hotSpot?Jb.clone(this._hotSpot):{x:0,y:0}},setHotSpot:function(a){this._hotSpot=a},getUnionBodyBounds:function(){return Jb.clone(this._unionBodyBounds)},getBodyRect:function(){return this._bodyRect||(this._bodyRect=this.createBodyRect()),Jb.clone(this._bodyRect)},invalidate:function(a){a===b&&(a=!0),a&&(this._invalidateAttachmentsFlag=!0),this._invalidateFlag||(this._bodyRect=null,this._invalidateFlag=!0,this._gl3dview.invalidateElementVisibility())},updateMeasure:function(){},validate:function(){if(this._invalidateFlag){this._invalidateAttachmentsFlag&&(this._invalidateAttachmentsFlag=!1,this.checkAttachments()),this._invalidateFlag=!1,this._bodyBounds.clear(),
Wb.clear(this._bodyView),this._innerColor=this._gl3dview.getInnerColor(this._element),this._outerColor=this._gl3dview.getOuterColor(this._element),this._shadowColor=this._gl3dview.getShadowColor(this._element),this._shadowXOffset=this._element.getStyle("shadow.xoffset"),this._shadowYOffset=this._element.getStyle("shadow.yoffset"),this._shadowBlur=this._element.getStyle("shadow.blur"),this.updateMeasure();var a=this._element.getStyle("whole.alpha");this._view.style.opacity=a,this._attachments.forEach(function(b){b.updateMeasure();var c=b.getAlpha();b._view.style.opacity=b.isShowInAttachmentDiv()?c*a:c});var b;this._bodyBounds.forEach(function(a){b=Tb.unionRect(b,a)}),this._unionBodyBounds=Jb.clone(b),this._attachments.forEach(function(a){b=Tb.unionRect(b,a.getViewRect())}),this._viewRect=b}},cleanUp:function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c],e=this[d];e&&!e.parentNode&&(this[d]=null)}},setVisible:function(a){this.isVisible()!==a&&(Wb.setVisible(this._view,a),this._attachments.forEach(function(b){b.isShowInAttachmentDiv()&&Wb.setVisible(b._view,a)}),this.invalidate(!0))},isVisible:function(){return Wb.isVisible(this._view)},checkAttachments:function(){this.checkLabelAttachment(),this.checkAlarmAttachment(),this.checkIconsAttachment(),this.checkEditAttachment()},checkLabelAttachment:function(){var a=this._gl3dview.getLabel(this._element);null!=a&&""!==a?this._labelAttachment||(this._labelAttachment=new Ib.gl3dview.LabelAttachment(this,Cd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._gl3dview.getAlarmLabel(this._element);null!=a&&""!==a?this._alarmAttachment||(this._alarmAttachment=new Ib.gl3dview.AlarmAttachment(this,Cd.SHOW_ALARM_IN_ATTACHMENT_DIV),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},checkIconsAttachment:function(){var a=this._gl3dview.getIconsNames(this._element);a&&a.length>0?this._iconsAttachment||(this._iconsAttachment=new Ib.gl3dview.IconsAttachment(this),this.addAttachment(this._iconsAttachment)):this._iconsAttachment&&(this.removeAttachment(this._iconsAttachment),this._iconsAttachment=null)},checkEditAttachment:function(){this.isEditable()&&this._gl3dview.hasEditInteraction()&&this._gl3dview.isSelected(this._element)&&this._gl3dview.isEditable(this._element)?this._editAttachment||(this._editAttachment=new Ib.gl3dview.EditAttachment(this),this.addAttachment(this._editAttachment)):this._editAttachment&&(this.removeAttachment(this._editAttachment),this._editAttachment=null)},isEditable:function(){return!0},handlePropertyChange:function(a){this.invalidate(!0)},handleSelectionChange:function(a){this.invalidate(!0)},dispose:function(){this._attachments.forEach(function(a){a.getView().parentNode&&a.getView().parentNode.removeChild(a.getView()),a.dispose()}),this._attachments.clear()},addAttachment:function(a){this._attachments.add(a),a.isShowInAttachmentDiv()?this._gl3dview.getAttachmentDiv().appendChild(a.getView()):this._view.appendChild(a.getView()),this.invalidate(!1)},removeAttachment:function(a){this._attachments.remove(a),a.getView().parentNode&&a.getView().parentNode.removeChild(a.getView()),a.dispose(),this.invalidate(!1)},addBodyBounds:function(a){a&&this._bodyBounds.add(a)},addComponent:function(a){this._bodyView.appendChild(a)},getBodyView:function(){return this._bodyView},getView:function(){return this._view},getViewRect:function(){return Jb.clone(this._viewRect)},setShadow:function(a,b,c){var d=a.isShadowable()&&this._shadowColor&&!this._editAttachment;d&&(this._shadowXOffset>0?c.width+=this._shadowXOffset:(c.x+=this._shadowXOffset,c.width+=-this._shadowXOffset),this._shadowYOffset>0?c.height+=this._shadowYOffset:(c.y+=this._shadowYOffset,c.height+=-this._shadowYOffset),Tb.grow(c,this._shadowBlur,this._shadowBlur));var e=Wb.setCanvas(b,c);return d&&(e.shadowOffsetX=this._shadowXOffset,e.shadowOffsetY=this._shadowYOffset,e.shadowBlur=this._shadowBlur,e.shadowColor=this._shadowColor),e},isShadowable:function(){return this._shadowColor&&this._gl3dview.isSelected(this._element)&&"shadow"===this._element.getStyle("select.style")?!0:!1},hit:function(a,b){return!1},hitCanvas:function(a,b,c){for(var d=c.length,e=0;d>e;e++){var f=c[e],g=this[f];if(Xb.hit(g,a,b,this._gl3dview.getSelectionTolerance()))return!0}return!1},hitComponent:function(a,b,c){for(var d=c.length,e=0;d>e;e++){var f=c[e],g=this[f];if(g&&Tb.containsPoint(g._viewRect,a,b))return!0}return!1},hitTest:function(a,b){if(!this.isVisible()||!Tb.containsPoint(this._viewRect,a,b))return null;var c,d,e=this._attachments.size();for(c=e-1;c>=0;c--)if(d=this._attachments.get(c),d.isShowInAttachmentDiv()&&d.hit(a,b))return d;for(c=e-1;c>=0;c--)if(d=this._attachments.get(c),!d.isShowInAttachmentDiv()&&d.hit(a,b))return d;return Tb.containsPoint(this._unionBodyBounds,a,b)&&this.hit(a,b)?this:null},intersects:function(a){return!1},intersectsComponent:function(a,b){for(var c=b.length,d=0;c>d;d++){var e=b[d],f=this[e];if(f&&Tb.intersects(f._viewRect,a))return!0}return!1},intersectsCanvas:function(a,b){for(var c=b.length,d=0;c>d;d++){var e=b[d],f=this[e];if(Xb.intersects(f,a))return!0}return!1},intersectsTest:function(a){if(!this.isVisible()||!Tb.intersects(this._viewRect,a))return null;var b,c,d=this._attachments.size();for(b=d-1;b>=0;b--)if(c=this._attachments.get(b),c.isShowInAttachmentDiv()&&c.intersects(a))return c;for(b=d-1;b>=0;b--)if(c=this._attachments.get(b),!c.isShowInAttachmentDiv()&&c.intersects(a))return c;return Tb.intersects(this._unionBodyBounds,a)&&this.intersects(a)?this:null}}),Ib.gl3dview.Attachment=function(a,b){this._view=Wb.createDiv(),this._ui=a,this._element=this._ui.getElement(),this._gl3dview=a.getGl3dview(),this._isShowInAttachmentDiv=b===!0,this._isShowInAttachmentDiv&&Wb.setVisible(this._view,a.isVisible())},Jb.ext("twaver.gl3dview.Attachment",Object,{getElement:function(){return this._element},getElementUI:function(){return this._ui},getGl3dview:function(){return this._gl3dview},getStyle:function(a){return this._ui.getStyle(a)},getFont:function(a){return this._ui.getFont(a)},isShowInAttachmentDiv:function(){return this._isShowInAttachmentDiv},getView:function(){return this._view},getViewRect:function(){return Jb.clone(this._viewRect)},getAlpha:function(){return 1},updateMeasure:function(){},dispose:function(){},hit:function(a,b){return Tb.containsPoint(this._viewRect,a,b)},intersects:function(a){return Tb.intersects(this._viewRect,a)}}),Ib.gl3dview.BasicAttachment=function(a,b){Ib.gl3dview.BasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0},this._attachmentCanvas=Wb.createCanvas(),this._view.insertBefore(this._attachmentCanvas,this._view.firstChild)},Jb.ext("twaver.gl3dview.BasicAttachment",Ib.gl3dview.Attachment,{calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=this.getCornerRadius(),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset(),i=this._roundRect;i.width=a+2*c,i.height=b;var j;if(d>0){var k=this.getDirection();j=this._gl3dview.getPosition(f,this._ui,null,g,h);var l;if("aboveleft"===k)i.y=j.y-d-i.height,i.x=j.x-(i.width-c),l=Math.max(j.x-e,i.x+c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:l,y:j.y-d}];else if("aboveright"===k)i.y=j.y-d-i.height,i.x=j.x-c,l=Math.min(j.x+e,i.x+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:l,y:j.y-d}];else if("belowleft"===k)i.y=j.y+d,i.x=j.x-(i.width-c),l=Math.max(j.x-e,i.x+c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:l,y:j.y+d}];else if("belowright"===k)i.y=j.y+d,i.x=j.x-c,l=Math.min(j.x+e,i.x+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:l,y:j.y+d}];else if("leftabove"===k)i.y=j.y+c-i.height,i.x=j.x-d-i.width,l=Math.max(j.y-e,i.y+c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:l}];else if("leftbelow"===k)i.y=j.y-c,i.x=j.x-d-i.width,l=Math.min(j.y+e,i.y+i.height-c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:l}];else if("rightabove"===k)i.y=j.y+c-i.height,i.x=j.x+d,l=Math.max(j.y-e,i.y+c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:l}];else if("rightbelow"===k)i.y=j.y-c,i.x=j.x+d,l=Math.min(j.y+e,i.y+i.height-c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:l}];else if("above"===k)i.y=j.y-d-i.height,i.x=j.x-i.width/2,l=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-l,y:j.y-d},{x:j.x+l,y:j.y-d}];else if("below"===k)i.y=j.y+d,i.x=j.x-i.width/2,l=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-l,y:j.y+d},{x:j.x+l,y:j.y+d}];else if("left"===k)i.y=j.y-i.height/2,i.x=j.x-d-i.width,l=Math.min(b/2,e/2),this._pointers=[j,{x:j.x-d,y:j.y+l},{x:j.x-d,y:j.y-l}];else{if("right"!==k)throw"Can not resolve '"+k+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,l=Math.min(b/2,e/2),this._pointers=[j,{x:j.x+d,y:j.y+l},{x:j.x+d,y:j.y-l}]}}else j=this._gl3dview.getPosition(f,this._ui,{width:i.width,height:i.height},g,h),i.x=j.x,i.y=j.y,this._pointers=null;this._contentRect.x=i.x+(i.width-a)/2,this._contentRect.y=i.y+(i.height-b)/2,this._contentRect.width=a,this._contentRect.height=b;var m=this.getPadding();0!=m&&Tb.grow(i,m,m),m=this.getPaddingLeft(),0!=m&&(i.x-=m,i.width+=m),m=this.getPaddingRight(),0!=m&&(i.width+=m),m=this.getPaddingTop(),0!=m&&(i.y-=m,i.height+=m),m=this.getPaddingBottom(),0!=m&&(i.height+=m),i.width<0&&(i.width=i.width,i.x-=i.width),i.height<0&&(i.height=-i.height,i.y-=i.height)},updateMeasure:function(){Ib.gl3dview.BasicAttachment.superClass.updateMeasure.call(this),this.calculateMeasure();var a=this.isFill(),b=this.getOutlineWidth();this._viewRect=Tb.getRect(this._pointers),this._viewRect=Tb.unionRect(this._viewRect,this._roundRect),b>0&&Tb.grow(this._viewRect,b/2,b/2);var c=this._ui.setShadow(this,this._attachmentCanvas,this._viewRect);if((b>0||a)&&(c.beginPath(),Xb.drawRoundRect(c,this._roundRect.x,this._roundRect.y,this._roundRect.width,this._roundRect.height,this.getCornerRadius()),this._pointers&&(c.moveTo(this._pointers[0].x,this._pointers[0].y),c.lineTo(this._pointers[1].x,this._pointers[1].y),c.lineTo(this._pointers[2].x,this._pointers[2].y)),c.closePath(),b>0&&(c.lineWidth=b,c.strokeStyle=this.getOutlineColor(),c.lineCap=this.getCap(),c.lineJoin=this.getJoin(),c.stroke()),a)){var d=this.getFillColor(),e=this.getGradient();e?Xb.fill(c,d,e,this.getGradientColor(),this._viewRect):c.fillStyle=d,c.fill()}return c},getRoundRect:function(){return Jb.clone(this._roundRect)},getContentRect:function(){return Jb.clone(this._contentRect)},getContent:function(){return this._content},setContent:function(a){this._content!==a&&(this._content&&this._view.removeChild(this._content),this._content=a,a&&this._view.appendChild(a))},getContentWidth:function(){return Cd.ATTACHMENT_CONTENT_WIDTH},getContentHeight:function(){return Cd.ATTACHMENT_CONTENT_HEIGHT},getCornerRadius:function(){return Cd.ATTACHMENT_CORNER_RADIUS},getPointerLength:function(){return Cd.ATTACHMENT_POINTER_LENGTH},getPointerWidth:function(){return Cd.ATTACHMENT_POINTER_WIDTH},getPosition:function(){return Cd.ATTACHMENT_POSITION},getXOffset:function(){return Cd.ATTACHMENT_XOFFSET},getYOffset:function(){return Cd.ATTACHMENT_YOFFSET},getPadding:function(){return Cd.ATTACHMENT_PADDING},getPaddingLeft:function(){return Cd.ATTACHMENT_PADDING_LEFT},getPaddingRight:function(){return Cd.ATTACHMENT_PADDING_RIGHT},getPaddingTop:function(){return Cd.ATTACHMENT_PADDING_TOP},getPaddingBottom:function(){return Cd.ATTACHMENT_PADDING_BOTTOM},getDirection:function(){return Cd.ATTACHMENT_DIRECTION},isFill:function(){return Cd.ATTACHMENT_FILL},getFillColor:function(){return Cd.ATTACHMENT_FILL_COLOR},getGradient:function(){return Cd.ATTACHMENT_GRADIENT},getGradientColor:function(){return Cd.ATTACHMENT_GRADIENT_COLOR},getOutlineWidth:function(){return Cd.ATTACHMENT_OUTLINE_WIDTH},getOutlineColor:function(){return Cd.ATTACHMENT_OUTLINE_COLOR},getCap:function(){return Cd.ATTACHMENT_CAP},getJoin:function(){return Cd.ATTACHMENT_JOIN},isShadowable:function(){return Cd.ATTACHMENT_SHADOWABLE},hit:function(a,b){return Tb.containsPoint(this._viewRect,a,b)?Tb.containsPoint(this._contentRect,a,b)?!0:Xb.hit(this._attachmentCanvas,a,b):!1},intersects:function(a){return Tb.intersects(this._viewRect,a)?Tb.intersects(this._contentRect,a)?!0:Xb.intersects(this._attachmentCanvas,a):!1}}),Ib.gl3dview.LabelAttachment=function(a,b){Ib.gl3dview.LabelAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.LabelAttachment",Ib.gl3dview.BasicAttachment,{updateMeasure:function(){var a=this.getFont("label.font"),b=this.getLabel();this._textSize=Xb.getTextSize(a,b);var c=Ib.gl3dview.LabelAttachment.superClass.updateMeasure.call(this),d=this._element.getStyle("label.align");Xb.drawText(c,b,this._contentRect,a,this.getStyle("label.color"),d)},getLabel:function(){return this._gl3dview.getLabel(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label.corner.radius")},getPointerLength:function(){return this.getStyle("label.pointer.length")},getPointerWidth:function(){return this.getStyle("label.pointer.width")},getPosition:function(){return this.getStyle("label.position")},getXOffset:function(){return this.getStyle("label.xoffset")},getYOffset:function(){return this.getStyle("label.yoffset")},getPadding:function(){return this.getStyle("label.padding")},getPaddingLeft:function(){return this.getStyle("label.padding.left")},getPaddingRight:function(){return this.getStyle("label.padding.right")},getPaddingTop:function(){return this.getStyle("label.padding.top")},getPaddingBottom:function(){return this.getStyle("label.padding.bottom")},getDirection:function(){return this.getStyle("label.direction")},isFill:function(){return this.getStyle("label.fill")},getFillColor:function(){return this.getStyle("label.fill.color")},getGradient:function(){return this.getStyle("label.gradient")},getGradientColor:function(){return this.getStyle("label.gradient.color")},getOutlineWidth:function(){return this.getStyle("label.outline.width")},getOutlineColor:function(){return this.getStyle("label.outline.color")},getCap:function(){return this.getStyle("label.cap")},getJoin:function(){return this.getStyle("label.join")},getAlpha:function(){return this.getStyle("label.alpha")},isShadowable:function(){return this.getStyle("label.shadowable")}}),Ib.gl3dview.AlarmAttachment=function(a,b){Ib.gl3dview.AlarmAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.AlarmAttachment",Ib.gl3dview.BasicAttachment,{updateMeasure:function(){var a=this.getFont("alarm.font"),b=this._gl3dview.getAlarmLabel(this._element);this._textSize=Xb.getTextSize(a,b),this._fillColor=this._gl3dview.getAlarmFillColor(this._element);var c=Ib.gl3dview.AlarmAttachment.superClass.updateMeasure.call(this);Xb.drawText(c,b,this._contentRect,a,this.getStyle("alarm.color"))},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("alarm.corner.radius")},getPointerLength:function(){return this.getStyle("alarm.pointer.length")},getPointerWidth:function(){return this.getStyle("alarm.pointer.width")},getPosition:function(){return this.getStyle("alarm.position")},getXOffset:function(){return this.getStyle("alarm.xoffset")},getYOffset:function(){return this.getStyle("alarm.yoffset")},getPadding:function(){return this.getStyle("alarm.padding")},getPaddingLeft:function(){return this.getStyle("alarm.padding.left")},getPaddingRight:function(){return this.getStyle("alarm.padding.right")},getPaddingTop:function(){return this.getStyle("alarm.padding.top")},getPaddingBottom:function(){return this.getStyle("alarm.padding.bottom")},getDirection:function(){return this.getStyle("alarm.direction")},isFill:function(){return null!=this._fillColor},getFillColor:function(){return this._fillColor},getGradient:function(){return this.getStyle("alarm.gradient")},getGradientColor:function(){return this.getStyle("alarm.gradient.color")},getOutlineWidth:function(){return this.getStyle("alarm.outline.width")},getOutlineColor:function(){return this.getStyle("alarm.outline.color")},getCap:function(){return this.getStyle("alarm.cap")},getJoin:function(){return this.getStyle("alarm.join")},getAlpha:function(){return this.getStyle("alarm.alpha")},isShadowable:function(){return this.getStyle("alarm.shadowable")}}),Ib.gl3dview.LinkHandlerAttachment=function(a,b){Ib.gl3dview.LinkHandlerAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.LinkHandlerAttachment",Ib.gl3dview.BasicAttachment,{updateMeasure:function(){var a=this.getFont("link.handler.font"),b=this._gl3dview.getLinkHandlerLabel(this._element);this._textSize=Xb.getTextSize(a,b);var c=Ib.gl3dview.LabelAttachment.superClass.updateMeasure.call(this);Xb.drawText(c,b,this._contentRect,a,this.getStyle("link.handler.color"))},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("link.handler.corner.radius")},getPointerLength:function(){return this.getStyle("link.handler.pointer.length")},getPointerWidth:function(){return this.getStyle("link.handler.pointer.width")},getPosition:function(){return this.getStyle("link.handler.position")},getXOffset:function(){return this.getStyle("link.handler.xoffset")},getYOffset:function(){return this.getStyle("link.handler.yoffset")},getPadding:function(){return this.getStyle("link.handler.padding")},getPaddingLeft:function(){return this.getStyle("link.handler.padding.left")},getPaddingRight:function(){return this.getStyle("link.handler.padding.right")},getPaddingTop:function(){return this.getStyle("link.handler.padding.top")},getPaddingBottom:function(){return this.getStyle("link.handler.padding.bottom")},getDirection:function(){return this.getStyle("link.handler.direction")},isFill:function(){return this.getStyle("link.handler.fill")},getFillColor:function(){return this.getStyle("link.handler.fill.color")},getGradient:function(){return this.getStyle("link.handler.gradient")},getGradientColor:function(){return this.getStyle("link.handler.gradient.color")},getOutlineWidth:function(){return this.getStyle("link.handler.outline.width")},getOutlineColor:function(){return this.getStyle("link.handler.outline.color")},getCap:function(){return this.getStyle("link.handler.cap")},getJoin:function(){return this.getStyle("link.handler.join")},getAlpha:function(){return this.getStyle("link.handler.alpha")},isShadowable:function(){return this.getStyle("link.handler.shadowable")}}),Ib.gl3dview.EditAttachment=function(a,b){Ib.gl3dview.EditAttachment.superClass.constructor.call(this,a,b),this._attachmentDiv=Wb.createDiv(),this._view.appendChild(this._attachmentDiv)},Jb.ext("twaver.gl3dview.EditAttachment",Ib.gl3dview.Attachment,{updateMeasure:function(){Ib.gl3dview.EditAttachment.superClass.updateMeasure.call(this),this._viewRect=null,this._element instanceof Jd&&this._addResizingPoint(this._element),!(this._gl3dview.isRotatable(this._element)&&this._element instanceof Jd)||this._element instanceof Ib.ShapeNode||this._element instanceof Ib.Grid||this._element instanceof Ib.Group||this._addRotatePoint(this._element),this._element instanceof Ib.ShapeNode&&(this._addResizingPoint(this._element),this._addShapeNodePoint(this._element)),this._ui instanceof Ib.gl3dview.ShapeLinkUI&&this._addShapeLinkPoints(this._ui),this._ui instanceof Ib.gl3dview.LinkUI&&this._addLinkControlPoint(this._ui)},_addRotatePoint:function(a){var b=this._gl3dview.getRotatePointSize();if(!(0>=b)){var c=a.getOriginalRect();if(!this._rotateDiv){var d=Wb.createDiv();this._attachmentDiv.appendChild(d),this._rotateDiv=d}var e,f=this._gl3dview.getRotatePointOutlineWidth(),g=this._gl3dview.getRotatePointOutlineColor(),h=this._gl3dview.getRotatePointFillColor(),b=this._gl3dview.getRotatePointSize(),i=2*b,j={x:c.x+c.width/2-b,y:c.y-this._gl3dview.getRotatePointOffset()-i,width:i,height:i};e=0==a.angle?j:this._getRotateRect(j,a.getAngle(),{x:c.x+c.width/2,y:c.y+c.height/2});var k=Tb.unionRect(a.getRect(),e);this._viewRect=Tb.unionRect(k,this._viewRect),Wb.setDiv(this._rotateDiv,j,h,f,g),this._rotateDiv._viewRect=e,Wb.setBorderRaidus(this._rotateDiv,i+"px"),this._rotateAttachments(this._rotateDiv,i/2,f)}},_addResizingPoint:function(a){var b=this._gl3dview.getResizePointSize();if(!(0>=b)){var c=a.getOriginalRect(),d=new md([{x:c.x,y:c.y},{x:c.x+c.width/2,y:c.y},{x:c.x+c.width,y:c.y},{x:c.x,y:c.y+c.height/2},{x:c.x+c.width,y:c.y+c.height/2},{x:c.x,y:c.y+c.height},{x:c.x+c.width/2,y:c.y+c.height},{x:c.x+c.width,y:c.y+c.height}]);if(!this._resizeDivs){this._resizeDivs=new Array;for(var e=0;8>e;e++){var f=Wb.createDiv();this._attachmentDiv.appendChild(f),this._resizeDivs[e]=f}}if(this._resizeDivs){this._resizeRects=new Array;for(var e=0;8>e;e++){var g,h=d.get(e),i={x:h.x-b,y:h.y-b,width:2*b,height:2*b};g=0==a.getAngle()?i:this._getRotateRect(i,a.getAngle(),{x:c.x+c.width/2,y:c.y+c.height/2}),this._resizeRects[e]=g}}var j=this._gl3dview.getResizePointOutlineWidth(),k=this._gl3dview.getResizePointOutlineColor(),l=this._gl3dview.getResizePointFillColor();this._addPoints(a.getRect(),d,j,k,l,!0)}},_addPoints:function(a,b,c,d,e,f){var g=f?this._gl3dview.getResizePointSize():this._gl3dview.getEditPointSize();if(!(0>=g)){var h=g+c;Tb.grow(a,h,h),this._viewRect=Tb.unionRect(a,this._viewRect);var i,j,k,l,m=2*g,n=new md;for(i=0,j=b.size();j>i;i++)k=b.get(i),l={x:k.x-g,y:k.y-g,width:m,height:m},n.add(l);var o;if(f)o=this._resizeDivs;else{if(this._controlDivs||(this._controlDivs=new Array),this._controlDivs.length<j)for(i=this._controlDivs.length;j>i;i++){var p=Wb.createDiv();this._attachmentDiv.appendChild(p),this._controlDivs[i]=p}else if(this._controlDivs.length>j){for(i=j;i<this._controlDivs.length;i++)this._attachmentDiv.removeChild(this._controlDivs[i]);this._controlDivs.splice(j)}o=this._controlDivs}for(i=0,j=n.size();j>i;i++)l=n.get(i),Wb.setDiv(o[i],l,e,c,d),Wb.setBorderRaidus(o[i],(f?"0":m)+"px"),this._rotateAttachments(o[i],m/2,c,b.get(i))}},_rotateAttachments:function(a,b,c,d){if(this._element instanceof Jd){var e=this._element.getAngle();if(0==e)return;{var f=this._element.getOriginalRect(),g=a.style.left.split("px")[0],h=a.style.top.split("px")[0];f.x+f.width/2,f.y+f.height/2}d||(d={x:parseFloat(g)+b+c,y:parseFloat(h)+b+c});var i=Tb.createMatrix(e*Math.PI/180,f.x+f.width/2,f.y+f.height/2),j=i.transform(d);a.style.webkitTransform="rotate("+e+"deg)",a.style.mozTransform="rotate("+e+"deg)",a.style.OTransform="rotate("+e+"deg)",a.style.msTransform="rotate("+e+"deg)",a.style.transform="rotate("+e+"deg)",a.style.left=j.x-b-c+"px",a.style.top=j.y-b-c+"px"}},_addShapeLinkPoints:function(a){this._addEditPoints(a._element.getPoints())},_addShapeNodePoint:function(a){this._addEditPoints(a.getPoints())},_addLinkControlPoint:function(a){if(xc.isOrthogonalLink(a._element)){var b=a.getControlPoint();if(b){var c=new md;c.add(b),this._addEditPoints(c)}}},_addEditPoints:function(a){var b=Tb.getRect(a);if(b){var c=this._gl3dview.getEditPointOutlineWidth(),d=this._gl3dview.getEditPointOutlineColor(),e=this._gl3dview.getEditPointFillColor();this._addPoints(b,a,c,d,e,!1)}},hit:function(a,b){if(!Tb.containsPoint(this._viewRect,a,b))return!1;var c;if(this._resizeDivs)for(c=this._resizeDivs.length-1;c>=0;c--)if(Tb.containsPoint(this._resizeRects[c],a,b))return!0;if(this._rotateDiv&&Tb.containsPoint(this._rotateDiv._viewRect,a,b))return!0;if(this._controlDivs)for(c=this._controlDivs.length-1;c>=0;c--)if(Tb.containsPoint(this._controlDivs[c]._viewRect,a,b))return!0;return!1},intersects:function(a){if(!Tb.intersects(this._viewRect,a))return!1;var b;if(this._resizeDivs)for(b=this._resizeDivs.length-1;b>=0;b--)if(Tb.intersects(this._resizeRects[b],a))return!0;if(this._rotateDiv&&Tb.containsPoint(this._rotateDiv._viewRect,a))return!0;if(this._controlDivs)for(b=this._controlDivs.length-1;b>=0;b--)if(Tb.intersects(this._controlDivs[b]._viewRect,a))return!0;return Tb.intersects(this._viewRect,a)?!1:!1},_getRotateRect:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x,c.y),e={x:a.x+a.width/2,y:a.y+a.height/2},f=d.transform(e),g=new Ib.List([{x:f.x-a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y+a.height/2},{x:f.x-a.width/2,y:f.y+a.height/2}]);return Tb.getRect(g)}}),Ib.gl3dview.IconsAttachment=function(a,b){Ib.gl3dview.IconsAttachment.superClass.constructor.call(this,a,b),this._iconsCanvas=null},Jb.ext("twaver.gl3dview.IconsAttachment",Ib.gl3dview.Attachment,{isShadowable:function(){return Cd.ATTACHMENT_SHADOWABLE},updateMeasure:function(){Ib.gl3dview.IconsAttachment.superClass.updateMeasure.call(this);var a=this._gl3dview.getIconsNames(this._element);if(a&&0!=a.length){var b=this._gl3dview.getIconsColors(this._element),c=this._element.getStyle("icons.orientation"),d=this._element.getStyle("icons.position"),e=this._element.getStyle("icons.xoffset");e=e instanceof Array?e[0]:e;var f=this._element.getStyle("icons.yoffset");f=f instanceof Array?f[0]:f;var g=this._element.getStyle("icons.xgap");g=g instanceof Array?g[0]:g;var h=this._element.getStyle("icons.ygap");h=h instanceof Array?h[0]:h;var i=this._getIconsSize(a,c,g,h);if(i){var j=this._gl3dview.getPosition(d,this._ui,i,e,f);this._viewRect={x:j.x,y:j.y,width:i.width,height:i.height},"top"===c?j.y+=i.height:"left"===c&&(j.x+=i.width),this._iconsCanvas||(this._iconsCanvas=Wb.createCanvas(),this._view.appendChild(this._iconsCanvas));var k=this._ui.setShadow(this,this._iconsCanvas,Jb.clone(this._viewRect)),l=j.x,m=j.y,n=0;for(var o in a){var p=null,q=null;b&&b.length>n&&(q=b[n++]);var r=Jb.getImageAsset(a[o]);if(null!=r){if("right"===c)p={x:l,y:m,width:r.getWidth(),height:r.getHeight()},l+=p.width+g;else if("left"===c)p={x:l-r.getWidth(),y:m,width:r.getWidth(),height:r.getHeight()},l-=p.width+g;else if("top"===c)p={x:l,y:m-r.getHeight(),width:r.getWidth(),height:r.getHeight()},m-=p.height+h;else{if("bottom"!==c)throw"Can not resolve '"+c+"' orientation";p={x:l,y:m,width:r.getWidth(),height:r.getHeight()},m+=p.height+h}Nc(k,r.getImage(q,p.width,p.height),q,p,this._element,this._gl3dview)}}}}},_getIconsSize:function(a,b,c,d){var e=0,f=0,g=null,h=null,i=null;for(var j in a)if(h=Jb.getImageAsset(a[j])){if("right"===b)g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},e+=g.width+c;else if("left"===b)g={x:e-h.getWidth(),y:f,width:h.getWidth(),height:h.getHeight()},e-=g.width+c;else if("top"===b)g={x:e,y:f-h.getHeight(),width:h.getWidth(),height:h.getHeight()},f-=g.height+d;else{if("bottom"!==b)throw"Can not resolve '"+b+"' orientation";g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},f+=g.height+d}i=null==i?Jb.clone(g):Tb.unionRect(i,g)}return i?{width:Math.abs(i.width),height:Math.abs(i.height)}:null}}),Ib.gl3dview.HTMLBasicAttachment=function(a,b){function c(a,b,c,d,e,f,g){c||(c=this._origin.x),d||(d=this._origin.y),e||(e=this._location.x),f||(f=this._location.y),a=a-c-e,b=b-d-f;var h=Ib.Util.transformPoint({x:c+e,y:d+f},g?this._radian:-this._radian,a,b).point;return h}Ib.gl3dview.HTMLBasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0},this._triangleDiv=Ib.Util.createDiv(),this._roundDiv=Ib.Util.createDiv(),this._contentDiv=Ib.Util.createDiv(),Ib.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Ib.Util.setCSSStyle(this._contentDiv,"white-space","nowrap");var d=this;this.hit=function(a,b){if(this._radian&&this._origin){var e=c.call(d,a,b);a=e.x,b=e.y}return Ib.Util.containsPoint(this._roundRect,a,b)||Ib.Util.containsPoint(this._pointerRect,a,b)},this.intersects=function(a){var b={x:a.x,y:a.y},e={x:a.x+a.width,y:a.y},f={x:a.x,y:a.y+a.height},g={x:a.x+a.width,y:a.y+a.height};if(this._radian&&this._origin){if(a.width*a.height>50)return!1;b=c.call(d,b.x,b.y),e=c.call(d,e.x,e.y),f=c.call(d,f.x,f.y),g=c.call(d,g.x,g.y)}return a=Ib.Util.getRect([b,e,f,g]),Ib.Util.intersects(this._roundRect,a)||Ib.Util.intersects(this._pointerRect,a)},this.getContentWidth=function(){return this._contentDiv.scrollWidth||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},this.getContentHeight=function(){return this._contentDiv.scrollHeight||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},this._view.appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Ib.Util.ext("twaver.gl3dview.HTMLBasicAttachment",Ib.gl3dview.BasicAttachment,{calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=Math.min(this.getCornerRadius(),b/2),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset();this._contentRect.width=a,this._contentRect.height=b,this._contentRect.x=c;var i=this._roundRect;i.width=a+2*c,i.height=b;var j;if(d>0){var k=this.getDirection();j=this._gl3dview.getPosition(f,this._ui,null,g,h);if("aboveleft"===k){i.y=j.y-d-i.height,i.x=j.x-(i.width-c),this._pointers=[j,{x:j.x,y:j.y-d},{x:j.x-Math.min(e,a),y:j.y-d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle=n+" "+n+" transparent transparent",this._triangleDivLocation=this._pointers[2]}else if("aboveright"===k){i.y=j.y-d-i.height,i.x=j.x-c,this._pointers=[j,{x:j.x,y:j.y-d},{x:j.x+Math.min(e,a),y:j.y-d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle=n+" transparent transparent "+n,this._triangleDivLocation=this._pointers[1]}else if("belowleft"===k){i.y=j.y+d,i.x=j.x-(i.width-c),this._pointers=[j,{x:j.x,y:j.y+d},{x:j.x-Math.min(e,a),y:j.y+d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle=" transparent "+n+" "+n+" transparent",this._triangleDivLocation={x:this._pointers[2].x,y:j.y}}else if("belowright"===k){i.y=j.y+d,i.x=j.x-c,this._pointers=[j,{x:j.x,y:j.y+d},{x:j.x+Math.min(e,a),y:j.y+d}];var l=d/2,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle="transparent transparent "+n+" "+n,this._triangleDivLocation=this._pointers[0]}else if("above"===k){i.y=j.y-d-i.height,i.x=j.x-i.width/2,this._pointers=[j,{x:j.x-Math.min(e,a)/2,y:j.y-d},{x:j.x+Math.min(e,a)/2,y:j.y-d}];var l=d,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px 0px "+m+"px",this._triangleBorderColorStyle=n+" transparent transparent transparent",this._triangleDivLocation=this._pointers[1]}else if("below"===k){i.y=j.y+d,i.x=j.x-i.width/2,this._pointers=[j,{x:j.x-Math.min(e,a)/2,y:j.y+d},{x:j.x+Math.min(e,a)/2,y:j.y+d}];var l=d,m=Math.min(e,a)/2,n=this.getFillColor();this._triangleBorderWidthStyle="0px "+m+"px "+l+"px "+m+"px",this._triangleBorderColorStyle="transparent transparent "+n+" transparent ",this._triangleDivLocation={x:this._pointers[1].x,y:j.y}}else if("left"===k){i.y=j.y-i.height/2,i.x=j.x-i.width-d,this._pointers=[j,{x:j.x-d,y:j.y-Math.min(e,b)/2},{x:j.x-d,y:j.y+Math.min(e,b)/2}];var l=Math.min(e,b)/2,m=d,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px 0px "+l+"px "+m+"px",this._triangleBorderColorStyle="transparent transparent  transparent "+n,this._triangleDivLocation=this._pointers[1]}else{if("right"!==k)throw"Can not resolve '"+k+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,this._pointers=[j,{x:j.x+d,y:j.y-Math.min(e,b)/2},{x:j.x+d,y:j.y+Math.min(e,b)/2}];var l=Math.min(e,b)/2,m=d,n=this.getFillColor();this._triangleBorderWidthStyle=l+"px "+m+"px "+l+"px 0px",this._triangleBorderColorStyle="transparent "+n+" transparent  transparent ",this._triangleDivLocation={x:j.x,
y:this._pointers[1].y}}}else j=this._gl3dview.getPosition(f,this._ui,{width:i.width,height:i.height},g,h),i.x=j.x,i.y=j.y,this._pointers=null;this._location=j},updateMeasure:function(){if(this.calculateMeasure(),this._ui.isShadowable()&&this.isShadowable()?Ib.Util.setCSSStyle(this._roundDiv,"text-shadow",this._ui._shadowXOffset+"px "+this._ui._shadowYOffset+"px "+this._ui._shadowBlur+"px "+this._ui._shadowColor):Ib.Util.removeCSSStyle(this._roundDiv,"text-shadow"),this._pointerRect=Ib.Util.getRect(this._pointers),this._viewRect=Ib.Util.unionRect(this._pointerRect,this._roundRect),Ib.Util.setCSSStyle(this._contentDiv,"left",this._contentRect.x+"px"),Ib.Util.setCSSStyle(this._contentDiv,"top",this._contentRect.y+"px"),Ib.Util.setCSSStyle(this._roundDiv,"left",this._roundRect.x+"px"),Ib.Util.setCSSStyle(this._roundDiv,"top",this._roundRect.y+"px"),Ib.Util.setCSSStyle(this._roundDiv,"width",this._roundRect.width+"px"),Ib.Util.setCSSStyle(this._roundDiv,"height",this._roundRect.height+"px"),Ib.Util.setCSSStyle(this._roundDiv,"background",this.isFill()?this.getFillColor():null),Ib.Util.setCSSStyle(this._roundDiv,"-webkit-border-radius",this.getCornerRadius()+"px"),Ib.Util.setCSSStyle(this._roundDiv,"-moz-border-radius",this.getCornerRadius()+"px"),Ib.Util.setCSSStyle(this._roundDiv,"border-radius",this.getCornerRadius()+"px"),this._pointers?(Ib.Util.setCSSStyle(this._triangleDiv,"left",this._triangleDivLocation.x+"px"),Ib.Util.setCSSStyle(this._triangleDiv,"top",this._triangleDivLocation.y+"px"),Ib.Util.setCSSStyle(this._triangleDiv,"border-width",this._triangleBorderWidthStyle),Ib.Util.setCSSStyle(this._triangleDiv,"border-color",this._triangleBorderColorStyle),this._view.appendChild(this._triangleDiv)):this._triangleDiv.parentNode==this._view&&this._view.removeChild(this._triangleDiv),this._element.getStyle("label.rotatable")&&this.label){var a=this._ui.getFromPoint(),b=this._ui.getToPoint(),c=this._ui.getLinkPoints();c.size()%2==0&&(a=c.get(c.size()/2-1),b=c.get(c.size()/2)),this._radian=a.x>b.x?Ib.Util.getRadiansBetweenLines(b,a):Ib.Util.getRadiansBetweenLines(a,b),this._origin={x:this._contentRect.width/2,y:0};var d="rotate("+Ib.Util.toDegrees(this._radian)+"deg)",e=this._origin.x+"px "+this._origin.y+"px";Ib.Util.isChrome||Ib.Util.isSafari?(Ib.Util.setCSSStyle(this._roundDiv,"-webkit-transform",d),Ib.Util.setCSSStyle(this._roundDiv,"-webkit-transform-origin",e)):Ib.Util.isIE?(Ib.Util.setCSSStyle(this._roundDiv,"-ms-transform",d),Ib.Util.setCSSStyle(this._roundDiv,"-ms-transform-origin",e)):(Ib.Util.setCSSStyle(this._roundDiv,"transform",d),Ib.Util.setCSSStyle(this._roundDiv,"transform-origin",e))}else Ib.Util.removeCSSStyle(this._roundDiv,"-webkit-transform"),Ib.Util.removeCSSStyle(this._roundDiv,"-webkit-transform-origin"),Ib.Util.removeCSSStyle(this._roundDiv,"-ms-transform"),Ib.Util.removeCSSStyle(this._roundDiv,"-ms-transform-origin"),Ib.Util.removeCSSStyle(this._roundDiv,"transform"),Ib.Util.removeCSSStyle(this._roundDiv,"transform-origin"),delete this._origin,delete this._radian}}),Ib.gl3dview.HTMLLabelAttachment=function(a,b){Ib.gl3dview.HTMLBasicAttachment.call(this,a,b),this.label=!0},Ib.Util.ext("twaver.gl3dview.HTMLLabelAttachment",Ib.gl3dview.LabelAttachment,{updateMeasure:function(){var a=this.getFont("label.font"),b=this.getLabel();this._contentDiv.innerHTML=b,Ib.Util.setCSSStyle(this._contentDiv,"font",a),Ib.gl3dview.HTMLBasicAttachment.prototype.updateMeasure.call(this),Ib.Util.removeCSSStyle(this._contentDiv,"font")},calculateMeasure:Ib.gl3dview.HTMLBasicAttachment.prototype.calculateMeasure}),Ib.gl3dview.HTMLAlarmAttachment=function(a,b){Ib.gl3dview.HTMLBasicAttachment.call(this,a,b),this.alarm=!0},Ib.Util.ext("twaver.gl3dview.HTMLAlarmAttachment",Ib.gl3dview.AlarmAttachment,{updateMeasure:function(){var a=this.getFont("alarm.font");this._contentDiv.innerHTML=this._gl3dview.getAlarmLabel(this._element),Ib.Util.setCSSStyle(this._contentDiv,"font",a),this._fillColor=this._gl3dview.getAlarmFillColor(this._element),Ib.gl3dview.HTMLBasicAttachment.prototype.updateMeasure.call(this),Ib.Util.removeCSSStyle(this._contentDiv,"font")},calculateMeasure:Ib.gl3dview.HTMLBasicAttachment.prototype.calculateMeasure}),Ib.gl3dview.NodeUI=function(a,b){Ib.gl3dview.NodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.NodeUI",Ib.gl3dview.ElementUI,{createBodyRect:function(){return this._element.getRect()},invalidate:function(a){Ib.gl3dview.NodeUI.superClass.invalidate.call(this,a);var b=this._element.getAgentLinks();b&&b.forEach(function(a){this._gl3dview.invalidateElementUI(a,!1)},this)},updateMeasure:function(){Ib.gl3dview.NodeUI.superClass.updateMeasure.call(this);var a=this.getStyle("vector.shape"),b=this.getBodyRect();this._hotSpot=Tb.getHotSpot(b.x,b.y,b.width,b.height,a),this.drawBody(),this._outerColor&&this.drawOuterBorder(),!this._editAttachment&&"border"===this.getStyle("select.style")&&this._gl3dview.isSelected(this._element)&&this.drawSelectBorder(),this.cleanUp(["_selectCanvas","_nodeCanvas","_nodeImage","_nodeComponent","_vectorCanvas","_outerCanvas"]);var c=this._element.getParent();c instanceof Ld&&this._gl3dview.invalidateElementUI(c,!1)},drawBody:function(){var a=this.getStyle("body.type");"default"===a?this.drawDefaultBody():"vector"===a?this.drawVectorBody():"default.vector"===a?(this.drawVectorBody(),this.drawDefaultBody()):"vector.default"===a?(this.drawDefaultBody(),this.drawVectorBody()):this.addBodyBounds({x:this._element.getX(),y:this._element.getY(),width:0,height:0})},drawOuterBorder:function(){var a=this._element,b=a.getStyle("outer.width");if(b>0){var c=this.getBodyRect();Tb.addPadding(c,a,"outer.padding",1),this._outerCanvas||(this._outerCanvas=Wb.createCanvas());var d=Jb.clone(c);Tb.grow(d,b/2,b/2);var e=Wb.setCanvas(this._outerCanvas,d);e.lineWidth=b,e.lineCap=a.getStyle("outer.cap"),e.lineJoin=a.getStyle("outer.join"),e.strokeStyle=this._outerColor,Xb.drawVector(e,a.getStyle("outer.shape"),null,c),e.stroke(),this.addComponent(this._outerCanvas),this.addBodyBounds(d)}},drawSelectBorder:function(){var a=this._element,b=a.getStyle("select.width");if(b>0){var c=this.getBodyRect();Tb.addPadding(c,a,"select.padding",1),this._selectCanvas||(this._selectCanvas=Wb.createCanvas());var d=Jb.clone(c);Tb.grow(d,b/2,b/2);var e=Wb.setCanvas(this._selectCanvas,d);e.lineWidth=b,e.lineCap=a.getStyle("select.cap"),e.lineJoin=a.getStyle("select.join"),e.strokeStyle=a.getStyle("select.color"),Xb.drawVector(e,a.getStyle("select.shape"),null,c),e.stroke(),this.addComponent(this._selectCanvas),this.addBodyBounds(d)}},drawDefaultBody:function(){var a=this._element,b=Jb.getImageAsset(a.getImage()),c=this.getBodyRect();if(!b)return this.addBodyBounds(c),void(this._currentImageAsset=null);if(Tb.addPadding(c,this._element,"image.padding",1),b.getImage()){this._nodeCanvas||(this._nodeCanvas=Wb.createCanvas());var d=Jb.clone(c),e=this.setShadow(this,this._nodeCanvas,d);0!=a.getAngle()&&(c=a.getOriginalRect(),Ib.Util.rotateCanvas(e,c,a.getAngle())),Nc(e,a.getImage(),this.getInnerColor(),c,a,this._gl3dview),c=d,this.addComponent(this._nodeCanvas)}else if(b.getSrc())this._nodeImage||(this._nodeImage=Wb.createImg()),Wb.setImg(this._nodeImage,b.getSrc(),c),this.addComponent(this._nodeImage);else{if(!b.getFunction())throw"ImageAsset '"+a.getImage()+" ' is empty";this._nodeComponent=this._currentImageAsset!==b?b.getFunction()(this,c):b.getFunction()(this,c,this._nodeComponent),this.addComponent(this._nodeComponent),this._nodeComponent._viewRect=Jb.clone(c)}this.addBodyBounds(c),this._currentImageAsset=b},hit:function(a,b){if(this._gl3dview._transparentSelectionEnable){var c=this.getBodyRect();if(Jb.math.containsPoint(c,a,b))return!0}return this.hitCanvas(a,b,["_nodeCanvas","_outerCanvas","_vectorCanvas"])?!0:this.hitComponent(a,b,["_nodeImage","_nodeComponent"])},intersects:function(a){if(this._gl3dview._transparentSelectionEnable){var b=this.getBodyRect();if(Jb.math.intersects(b,a))return!0}return this.intersectsCanvas(a,["_nodeCanvas","_outerCanvas","_vectorCanvas"])?!0:this.intersectsComponent(a,["_nodeImage","_nodeComponent"])},drawVectorBody:function(){this._vectorCanvas||(this._vectorCanvas=Wb.createCanvas());var a=Xb.drawPath(this,this._vectorCanvas,"vector",!0,this._element.getStyle("vector.outline.pattern")),b=this.getStyle("vector.deep"),c=this._vectorCanvas.getContext("2d"),d=this.getBodyRect(),e=this.getStyle("vector.fill.color");if(0!==b&&e){var f=this._element.getAngle();0!=f&&(d=this._element.getOriginalRect(),Ib.Util.rotateCanvas(c,d,-f),Ib.Util.rotateCanvas(c,d,f)),"rectangle"===this.getStyle("vector.shape")&&Xb.draw3DRect(c,e,b,d)}this.addBodyBounds(a),this.addComponent(this._vectorCanvas)}}),Ib.gl3dview.LinkUI=function(a,b){Ib.gl3dview.LinkUI.superClass.constructor.call(this,a,b),this._linkCanvas=Wb.createCanvas()},Jb.ext("twaver.gl3dview.LinkUI",Ib.gl3dview.ElementUI,{isEditable:function(){return xc.isOrthogonalLink(this._element)&&this.getControlPoint()?!0:!1},createBodyRect:function(){var a=this.getHotSpot();return a?{x:a.x-1,y:a.y-1,width:2,height:2}:null},hit:function(a,b){return this.hitCanvas(a,b,["_linkCanvas"])},intersects:function(a){return this.intersectsCanvas(a,["_linkCanvas"])},checkAttachments:function(){Ib.gl3dview.LinkUI.superClass.checkAttachments.call(this),this.checkLinkHandlerAttachment()},checkLinkHandlerAttachment:function(){var a=this._gl3dview.getLinkHandlerLabel(this._element);null!=a&&""!==a?this._linkHandlerAttachment||(this._linkHandlerAttachment=new Ib.gl3dview.LinkHandlerAttachment(this),this.addAttachment(this._linkHandlerAttachment)):this._linkHandlerAttachment&&(this.removeAttachment(this._linkHandlerAttachment),this._linkHandlerAttachment=null)},getLinkHandlerAttachment:function(){return this._linkHandlerAttachment},getLinkPoints:function(){return this._linkPoints||(this._linkPoints=this.createLinkPoints(),this._lineLength=Tb.calculateLineLength(this._linkPoints)),this._linkPoints},invalidate:function(a){this._linkPoints=null,this._fromPoint=null,this._toPoint=null,Ib.gl3dview.LinkUI.superClass.invalidate.call(this,a)},getFromPosition:function(a,b){var c=this.getFromPoint();return c?{x:c.x+a,y:c.y+b}:null},getToPosition:function(a,b){var c=this.getToPoint();return c?{x:c.x+a,y:c.y+b}:null},getFromPoint:function(){return this._fromPoint||(this._fromPoint=xc.createFromPoint(this)),this._fromPoint},getToPoint:function(){return this._toPoint||(this._toPoint=xc.createToPoint(this)),this._toPoint},updateMeasure:function(){Ib.gl3dview.LinkUI.superClass.updateMeasure.call(this),this.drawBody()},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=this.getStyle("link.type"),d=new md;if(xc.isOrthogonalOrFlexionalLink(this._element))d=xc.orthogonalAndFlexional(this,c);else if(this._element.isLooped()){var e=this._gl3dview.getElementUI(this._element.getFromAgent());null!=e&&(this._hotSpot=xc.fillLoopedPoints(this,e.getBodyRect(),d))}else{if("arc"!==c&&"triangle"!==c&&"parallel"!==c)throw"Can not resolve link type '"+c+"'";this._hotSpot=xc.fillBundlePoints(this,c,a,b,d)}if(this._gl3dview._linkPathFunction){var f=this._gl3dview._linkPathFunction(this,d);f&&(d=f)}return d},drawLinePoints:function(a,b,c,d,e){if(a.lineWidth=c,a.strokeStyle=d,this._element.getStyle("link.flow")===!0&&e&&e.length>1){var f=new uc(a,e[0],e[1]),g=this._element.getStyle("link.flow.offset");this._element.getStyle("link.flow.converse")?g<e[0]?f.overflow=e[0]-g:g>=e[0]&&g<=e[0]+e[1]?(f.overflow=e[1]-(g-e[0]),f.overflow&&(f.isLine=!1)):(g-=e[0]+e[1],f.overflow=e[0]-g):g<=e[1]?(f.overflow=g,g&&(f.isLine=!1)):g>e[1]&&g<=e[0]+e[1]?f.overflow=g-e[1]:(g-=e[0]+e[1],g&&(f.isLine=!1),f.overflow=g),this._element._styleMap["link.flow.offset"]=g,a.beginPath(),Xb._drawLine(b,a),a.stroke(),a.shadowColor="transparent",a.beginPath();var h=this._element.getStyle("link.flow.color");h=h?h:Cd.NETWORK_LINK_FLOW_COLOR,a.strokeStyle=h,Xb._drawLine(b,f),a.stroke(),a.shadowColor=this._shadowColor}else a.beginPath(),Xb.drawLinePoints(a,b,e),a.stroke()},drawBody:function(){var a=this.getLinkPoints();if(a&&!(a.size()<2)){var b=this._element,c=Tb.getLineRect(a),d=b.getStyle("link.width"),e=d;if(this._outerColor){var f=b.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===b.getStyle("select.style")&&this._gl3dview.isSelected(this._element);if(g){var h=b.getStyle("select.width");e+=2*h}Tb.grow(c,e/2,e/2),b.getStyle("arrow.from")&&(c=Tb.unionRect(c,nd.getArrowRect(a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset")))),b.getStyle("arrow.to")&&(c=Tb.unionRect(c,nd.getArrowRect(a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"))));var i=this.setShadow(this,this._linkCanvas,c);i.lineCap=b.getStyle("link.cap"),i.lineJoin=b.getStyle("link.join");var j=b.getStyle("link.pattern");g&&this.drawLinePoints(i,a,e,b.getStyle("select.color"),j),this._outerColor&&this.drawLinePoints(i,a,d+2*f,this._outerColor,j),this.drawLinePoints(i,a,d,this._innerColor||b.getStyle("link.color"),j),this.addBodyBounds(c),this.addComponent(this._linkCanvas),nd.drawLinkArrow(this,i,a)}},getControlPoint:function(){return xc.getControlPoint(this._element,this)},setControlPoint:function(a){if(a){var b=this.getStyle("link.type");if(xc.hasControlPoint(b)){var c=xc.getLinkSourceBounds(this),d=xc.getLinkTargetBounds(this);xc.setParamsByControlPoint(a,c,d,b,this._element)}}},getLineLength:function(){return this._lineLength}}),Ib.gl3dview.HTMLLinkUI=function(a,b){Ib.gl3dview.HTMLLinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.HTMLLinkUI",Ib.gl3dview.LinkUI,{checkAttachments:function(){Ib.gl3dview.LinkUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Ib.gl3dview.HTMLLinkUI.superClass.checkLabelAttachment.call(this);var b=this._gl3dview.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Ib.gl3dview.HTMLLabelAttachment(this),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Ib.gl3dview.HTMLLinkUI.superClass.checkAlarmAttachment.call(this);var b=this._gl3dview.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Ib.gl3dview.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}}),Ib.gl3dview.GroupUI=function(a,b){Ib.gl3dview.GroupUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.GroupUI",Ib.gl3dview.NodeUI,{isEditable:function(){return!this._element.isExpanded()},drawBody:function(){this.getBodyRect();this._shapeRect?this.drawExpandedGroup():Ib.gl3dview.GroupUI.superClass.drawBody.call(this)},drawExpandedGroup:function(){this._nodeCanvas||(this._nodeCanvas=Wb.createCanvas());var a=Xb.drawPath(this,this._nodeCanvas,"group",!1,this._element.getStyle("vector.outline.pattern")),b=this.getStyle("group.deep"),c=this.getStyle("group.fill.color");0!==b&&c&&"rectangle"===this.getStyle("group.shape")&&Xb.draw3DRect(this._nodeCanvas.getContext("2d"),c,b,this._bodyRect),this.addBodyBounds(a),this.addComponent(this._nodeCanvas)},getChildrenRects:function(){return this._gl3dview.getGroupChildrenRects(this._element)},createBodyRect:function(){this._shapeRect=null;var a=this._element;if(a.isExpanded()){var b=this.getChildrenRects();if(!b.isEmpty()){var c=a.getStyle("group.shape"),d=Ub[c];if(!d)throw"Can not resolve group shape '"+c+"'";this._shapeRect=d(b)}}return this._shapeRect?(Tb.addPadding(this._shapeRect,a,"group.padding",1),this._shapeRect):Ib.gl3dview.GroupUI.superClass.createBodyRect.call(this)}}),Ib.gl3dview.GridUI=function(a,b){Ib.gl3dview.GridUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.GridUI",Ib.gl3dview.NodeUI,{drawDefaultBody:function(){this._element.getImage()?Ib.gl3dview.GridUI.superClass.drawDefaultBody.call(this):this.drawGridBody()},drawGridBody:function(){var a=this.getStyle("grid.fill"),b=this.getStyle("grid.deep"),c=this.getStyle("grid.cell.deep");if(a||0!==b||0!==c){var d=this.getBodyRect(),e=this.getDyeColor("grid.fill.color");this._nodeCanvas||(this._nodeCanvas=Wb.createCanvas());var f=Jb.clone(d),g=this.setShadow(this,this._nodeCanvas,f);if(g.rect(d.x,d.y,d.width,d.height),this.addComponent(this._nodeCanvas),a&&(g.fillStyle=e,g.fill()),0!=b&&Xb.draw3DRect(g,e,b,d.x,d.y,d.width,d.height),0!=c)for(var h=this.getStyle("grid.row.count"),i=this.getStyle("grid.column.count"),j=0;h>j;j++)for(var k=0;i>k;k++){var l=this._element.getCellRect(j,k);null!=l&&Xb.draw3DRect(g,e,c,l.x,l.y,l.width,l.height)}this.addBodyBounds(f)}}}),Ib.gl3dview.ShapeNodeUI=function(a,b){Ib.gl3dview.ShapeNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.ShapeNodeUI",Ib.gl3dview.NodeUI,{drawDefaultBody:function(){if(this._element._points.size()<2)return void this.addBodyBounds({x:this._element.getX(),y:this._element.getY(),width:0,height:0});this._nodeCanvas||(this._nodeCanvas=Wb.createCanvas());var a=Xb.drawPath(this,this._nodeCanvas,"vector",!0,this._element.getStyle("vector.outline.pattern"),this._element._points,this._element._segments,this._element.getStyle("shapenode.closed"));this.addBodyBounds(a),this.addComponent(this._nodeCanvas),nd.drawLinkArrow(this,this._nodeCanvas.getContext("2d"),Tb.getPointObject(this._element._points,this._element._segments))},drawSelectBorder:function(){var a=this._element,b=a.getStyle("select.width");if(b>0){var c=this.getBodyRect();Tb.addPadding(c,a,"select.padding",1);var d=a.getStyle("vector.outline.width");d>0&&Tb.grow(c,d/2,d/2),this._selectCanvas||(this._selectCanvas=Wb.createCanvas());var e=Jb.clone(c);Tb.grow(e,b/2,b/2);var f=Wb.setCanvas(this._selectCanvas,e);f.lineWidth=b,f.lineCap=a.getStyle("select.cap"),f.lineJoin=a.getStyle("select.join"),f.strokeStyle=a.getStyle("select.color"),Xb.drawVector(f,a.getStyle("select.shape"),null,c),f.stroke(),this.addComponent(this._selectCanvas),this.addBodyBounds(e)}}}),Ib.gl3dview.ShapeLinkUI=function(a,b){Ib.gl3dview.ShapeLinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.ShapeLinkUI",Ib.gl3dview.LinkUI,{isEditable:function(){return!0},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=new md,d=this.getStyle("shapelink.type");c.add(a),null!=this._element._points&&c.addAll(this._element._points),c.add(b);var e=c.size(),f=Math.floor(e/2);if(e%2===0){var g=c.get(f),h=c.get(f-1);this._hotSpot={x:(g.x+h.x)/2,y:(g.y+h.y)/2}}else this._hotSpot=Jb.clone(c.get(f));var i,j,k;if("lineto"===d);else if("quadto"===d){for(i=new md(c.get(0)),j=1,e=c.size();e>j;j++)i.add(e-1>j?new md([c.get(j++),c.get(j)]):c.get(j));c=i}else if("cubicto"===d){for(i=new md(c.get(0)),j=1,e=c.size();e>j;j++)i.add(e-2>j?new md([c.get(j++),c.get(j++),c.get(j)]):e-1>j?new md([c.get(j++),c.get(j)]):c.get(j));c=i}else{if("orthogonalto"!==d)throw"Can not resolve shapelink type '"+d+"'";for(k=c.get(0),i=new md(k),j=1,e=c.size();e>j;j++)if(e-1>j){var l=Jb.clone(c.get(j)),m=l.x,n=l.y,o=m-k.x,p=n-k.y;Math.abs(o)>Math.abs(p)?(l.x=m,l.y=k.y):(l.x=k.x,l.y=n),k=l,i.add(k)}else i.add(c.get(j));c=i}return c}}),Ib.gl3dview.RotatableNodeUI=function(a,b){Ib.gl3dview.RotatableNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.gl3dview.RotatableNodeUI",Ib.gl3dview.NodeUI,{isEditable:function(){return!1},drawDefaultBody:function(){var a=this._element,b=Jb.getImageAsset(a.getImage()),c=this.getBodyRect();if(!b)return this.addBodyBounds(c),void(this._currentImageAsset=null);if(Tb.addPadding(c,this._element,"image.padding",1),b.getImage()){this._nodeCanvas||(this._nodeCanvas=Wb.createCanvas());var d=Jb.clone(c),e=this.setShadow(this,this._nodeCanvas,d),f=this._element._getOrignalWidth(),g=this._element._getOrignalHeight(),h=this._element._getRotateRect();e.save(),e.translate(c.x-h.x+f/2,c.y-h.y+g/2),e.rotate(this._element._angle*Math.PI/180);var c={x:-f/2,y:-g/2,width:f,height:g};Nc(e,b.getImage(this._innerColor,c.width,c.height),this._innerColor,c,a,this._gl3dview),e.restore(),this.addComponent(this._nodeCanvas)}else if(b.getSrc());else if(!b.getFunction())throw"ImageAsset '"+a.getImage()+" ' is empty";this.addBodyBounds(c),this._currentImageAsset=b}}),Ib.gl3dview.HTMLNodeUI=function(a,b){Ib.gl3dview.HTMLNodeUI.superClass.constructor.call(this,a,b)},Ib.Util.ext("twaver.gl3dview.HTMLNodeUI",Ib.gl3dview.NodeUI,{checkAttachments:function(){Ib.gl3dview.NodeUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Ib.gl3dview.HTMLNodeUI.superClass.checkLabelAttachment.call(this);var b=this._gl3dview.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Ib.gl3dview.HTMLLabelAttachment(this,Cd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Ib.gl3dview.HTMLNodeUI.superClass.checkAlarmAttachment.call(this);var b=this._gl3dview.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Ib.gl3dview.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}}),Ib.gl3dview.interaction.BaseInteraction=function(a){this.gl3dview=a},Jb.ext("twaver.gl3dview.interaction.BaseInteraction",Object,{setUp:function(){},tearDown:function(){},addListener:function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];Wb.addEventListener(b,"handle_"+b,this.gl3dview.getView(),this)}},removeListener:function(){for(var a=0;a<arguments.length;a++)Wb.removeEventListener(arguments[a],this.gl3dview.getView(),this)},_handle_mousedown:function(a){0===a.button&&(this._startLogical=this.gl3dview.getLogicalPoint(a),this._startClient=Wb.getClientPoint(a),this._startLogical&&Wb.handle_mousedown(this,a))},_handle_mousemove:function(a){this._endLogical={x:this._startLogical.x+(a.clientX-this._startClient.x)/this.gl3dview.getZoom(),y:this._startLogical.y+(a.clientY-this._startClient.y)/this.gl3dview.getZoom()}},_handle_mouseup:function(a){delete this._startClient,delete this._startLogical,delete this._endLogical}}),Ib.gl3dview.interaction.SelectInteraction=function(a){Ib.gl3dview.interaction.SelectInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.SelectInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown"),this.end()},handle_mousedown:function(a){if(this._button=a.button,this.gl3dview.isValidEvent(a)&&!this.gl3dview.isMovingElement()&&!this.gl3dview.isEditingElement()&&!a.shiftKey){var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getSelectionContainer();b?Jb.isCtrlDown(a)?c.contains(b)?c.removeSelection(b):c.appendSelection(b):c.contains(b)||c.setSelection(b):(Jb.isCtrlDown(a)||c.clearSelection(),this.end(a),this.gl3dview.getLogicalPoint(a)&&this.gl3dview.isRectSelectEnabled()&&this._handle_mousedown(a))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(0!==this._button||this.gl3dview.isMovingElement()||this.gl3dview.isEditingElement())return void this.end(a);this._handle_mousemove(a),this.mark?this.gl3dview.fireInteractionEvent({kind:"selectBetween",event:a}):(this.mark=Wb.createDiv(),this.gl3dview.getTopDiv().appendChild(this.mark),this.gl3dview.setSelectingElement(!0),this.gl3dview.fireInteractionEvent({kind:"selectStart",event:a}));var b=Tb.getRect([this._startLogical,this._endLogical]);Wb.setDiv(this.mark,b,this.getIntersectMode()?this.gl3dview.getSelectFillColor():null,this.gl3dview.getSelectOutlineWidth(),this.gl3dview.getSelectOutlineColor())},end:function(a){if(this._startLogical){if(this.mark){if(this._endLogical&&this._startLogical.x!==this._endLogical.x&&this._startLogical.y!==this._endLogical.y){var b=this.gl3dview.getElementsAtRect(this.mark._viewRect,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(b&&b.size()>0){var c=this.gl3dview.getSelectionContainer(),d=c.toSelection();b.forEach(function(a){c.contains(a)?d.remove(a):d.add(a)},this),c.setSelection(d)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:a})}var e=this;setTimeout(function(){e.mark&&(e.gl3dview.getTopDiv().removeChild(e.mark),e.mark=null)},0),this.gl3dview.setSelectingElement(!1)}this._handle_mouseup(a)}},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this._startLogical.x>this._endLogical.x&&this._startLogical.y>this._endLogical.y}}),Ib.gl3dview.interaction.MoveInteraction=function(a,b){this.lazyMode=b,this.xoffset=0,this.yoffset=0,Ib.gl3dview.interaction.MoveInteraction.superClass.constructor.call(this,a),this.currentKeyEvent=null},Jb.ext("twaver.gl3dview.interaction.MoveInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","keydown")},tearDown:function(){this.removeListener("mousedown","keydown"),this.end()},handle_keydown:function(a){this.currentKeyEvent=a,this.addListener("keyup")},handle_keyup:function(a){this.currentKeyEvent=null,this.removeListener("keyup")},isParenting:function(){return this._startLogical&&null!=this.currentKeyEvent&&80===this.currentKeyEvent.keyCode},parentProcess:function(a,b){var c=null;null!=this.parent&&(c=this.gl3dview.getElementUI(this.parent).getViewRect(),this.parent=null);var d=this;if(a=this.gl3dview.getLogicalPoint(a),!b&&this.isParenting()){var e={};e.x=a.x-1,e.y=a.y-1,e.width=2,e.height=2;var f=this.gl3dview.getElementsAtRect(e,!0);if(f&&f.size()>0)for(var g=f.size(),h=0;g>h;h++){var i=f.get(h);if(!d.gl3dview.getElementBox().getSelectionContainer().contains(i)){d.parent=i;break}}}null!=this.parent&&(c=this.gl3dview.getElementUI(this.parent).getViewRect()),null==c||b?this.parentMark&&(this.gl3dview.getTopDiv().removeChild(this.parentMark),this.parentMark=null):(this.parentMark||(this.parentMark=Jb.html.createDiv(),this.gl3dview.getTopDiv().appendChild(this.parentMark)),Jb.html.setDiv(this.parentMark,c,this.gl3dview.isLazyMoveFill()?this.gl3dview.getLazyMoveFillColor():null,this.gl3dview.getLazyMoveOutlineWidth(),this.gl3dview.getLazyMoveOutlineColor()))},handle_mousedown:function(a){if(0===a.button&&!this.gl3dview.isSelectingElement()&&!this.gl3dview.isEditingElement()){var b=this.gl3dview.getElementAt(a);this.gl3dview.isMovable(b)&&(this.end(a),this._handle_mousedown(a))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(this.gl3dview.isSelectingElement()||this.gl3dview.isEditingElement()||!this.gl3dview.hasMovableSelectedElements()||!this._startLogical)return void this.end(a);if(this._handle_mousemove(a),this.xoffset=this._endLogical.x-this._startLogical.x,this.yoffset=this._endLogical.y-this._startLogical.y,this.lazyMode){if(this.mark)this.gl3dview.fireInteractionEvent({kind:"lazyMoveBetween",event:a});else{this.mark=Wb.createDiv();var b;this.gl3dview.getMovableSelectedElements().forEach(function(a){var c=this.getElementUI(a);c&&(b=Tb.unionRect(b,c.getViewRect()))},this.gl3dview),this.gl3dview.getTopDiv().appendChild(this.mark),this.gl3dview.setMovingElement(!0),Wb.setDiv(this.mark,b,this.gl3dview.isLazyMoveFill()?this.gl3dview.getLazyMoveFillColor():null,this.gl3dview.getLazyMoveOutlineWidth(),this.gl3dview.getLazyMoveOutlineColor()),this.gl3dview.fireInteractionEvent({kind:"lazyMoveStart",event:a})}this.mark.style.left=this.xoffset+this.mark._viewRect.x+"px",this.mark.style.top=this.yoffset+this.mark._viewRect.y+"px"}else this.gl3dview.moveSelectedElements(this.xoffset,this.yoffset),this._startLogical=this._endLogical,this._startClient=Wb.getClientPoint(a),this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}));this.parentProcess(a,!1)},end:function(a){if(this._startLogical){if(this.lazyMode){if(this.mark){var b=this,c=function(){b.gl3dview.fireInteractionEvent({kind:"lazyMoveEnd",event:a}),b.mark&&(b.gl3dview.getTopDiv().removeChild(b.mark),b.mark=null,b.gl3dview.setMovingElement(!1))};this.gl3dview.moveSelectedElements(this.xoffset,this.yoffset,this.gl3dview.isLazyMoveAnimate(),c)}}else this.gl3dview.isMovingElement()&&(this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a}));if(this.isParenting()){null==this.parent&&(this.parent=this.gl3dview.getCurrentSubGl3dview());var b=this;this.gl3dview.getMovableSelectedElements().forEach(function(a){a.setParent(b.parent)},this.gl3dview)}this.parentProcess(a,!0),this._handle_mouseup(a)}}}),Ib.gl3dview.interaction.DefaultInteraction=function(a){Ib.gl3dview.interaction.DefaultInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.DefaultInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove","keydown")},tearDown:function(){this.removeListener("mousedown","mousemove","keydown")},handle_mousedown:function(a){if(this.gl3dview.isValidEvent(a)){this.gl3dview.isFocusOnClick()&&Ib.Util.setFocus(this.gl3dview.getView());var b=this.gl3dview.getElementAt(a);2===a.detail?this.handleDoubleClicked(a,b):this.handleClicked(a,b)}},handleClicked:function(a,b){Cc.handleClicked(this.gl3dview,a,b)},handleDoubleClicked:function(a,b){Cc.handleDoubleClicked(this.gl3dview,a,b)},handle_keydown:function(a){Cc.handleKeyDown(this.gl3dview,a)},handle_mousemove:function(a){var b=this.gl3dview.getElementAt(a),c=this._preElement,d=Dc(c),e=Dc(b);c!==b&&(c&&(d&&d.onMouseLeave&&d.onMouseLeave(c,this.gl3dview),this.gl3dview.onMouseLeave(c,a)),b&&(e&&e.onMouseEnter&&e.onMouseEnter(b,this.gl3dview),this.gl3dview.onMouseEnter(b,a))),b&&e&&e.onMouseMove&&e.onMouseMove(b,this.gl3dview),this.gl3dview.onMouseMove(b,a),this._preElement=b}}),Ib.gl3dview.interaction.PanInteraction=function(a){Ib.gl3dview.interaction.PanInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.PanInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown"),this._oldCursor=this.gl3dview.getView().style.cursor},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){this._startLogical=this.gl3dview.getLogicalPoint(a),this._startLogical&&(this._handle_mousedown(a),this.gl3dview.getView().style.cursor="pointer")},handle_mouseup:function(a){this._clear()},handle_mousemove:function(a){if(this._startLogical){this._handle_mousemove(a);{var b=this._startLogical.x-this._endLogical.x,c=this._startLogical.y-this._endLogical.y;this.gl3dview.panByOffset(b,c)}this._startLogical=this._endLogical,this._startClient=Wb.getClientPoint(a)}},_clear:function(a){this._startLogical&&(this._handle_mouseup(a),this.gl3dview.getView().style.cursor=this._oldCursor)}}),Ib.gl3dview.interaction.EditInteraction=function(a,b){this.lazyMode=b,this.pointIndex=-1,this.editPointSize=a.getEditPointSize(),this.resizePointSize=a.getResizePointSize(),this.rotatePointSize=a.getRotatePointSize(),Ib.gl3dview.interaction.EditInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.EditInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.oldCursor=this.gl3dview.getView().style.cursor,this.gl3dview.setHasEditInteraction(!0)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.gl3dview.getView().style.cursor=this.oldCursor,this.gl3dview.setHasEditInteraction(!1),this.clear()},clear:function(){this.gl3dview.setEditingElement(!1),this.gl3dview.setRotatingElement(!1),
this.isStart=!1,this.isStartRotate=!1,this.node=null,this.shapeNode=null,this.shapeLink=null,this.linkUI=null,this.resizingRect=null,this.resizeDirection=null,this.pointIndex=-1,this._removeCursor(),this.oldCursor=null,this.mouseMoved=!1,this.horizontal=!1,this.vertical=!1,this.mark&&(this.gl3dview.getTopDiv().removeChild(this.mark),this.mark=null),this.rotateScale&&this.gl3dview.getTopDiv().contains(this.rotateScale)&&(this.gl3dview.getTopDiv().removeChild(this.rotateScale),this.rotateScale=null)},_removeCursor:function(){this.cursorID&&(this.gl3dview.getView().style.cursor=this.oldCursor||"default",this.cursorID=null),this.resizeDirection=null,this.isCrossCursor=!1},_setCrossCursor:function(){this.isCrossCursor||(this._removeCursor(),this._setCursor("crosshair"),this.isCrossCursor=!0)},_setCursor:function(a){this.cursorID=a,this.gl3dview.getView().style.cursor!==this.cursorID&&(this.gl3dview.getView().style.cursor=this.cursorID)},handle_mousedown:function(a){if(0===a.button)if(!Jb.isAltDown(a)||this.gl3dview.isEditingElement())!this.gl3dview.isEditingElement()||this.isStart||this.isStartRotate||(this.node&&this.resizeDirection?(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:a,element:this.node,resizeDirection:this.resizeDirection})):this.shapeNode&&this.pointIndex>=0?Jb.isAltDown(a)?(this.shapeNode.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0?Jb.isAltDown(a)?(this.shapeLink.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.linkUI._element})):this.node&&(this.isStartRotate=!0,this._handle_mousedown(a)));else{var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getLogicalPoint(a);if(b instanceof Ib.ShapeNode){var d=this.getPointIndex(b.getPoints(),c,!0);d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeNode=b,b.addPoint(c,d),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}if(b instanceof Ib.ShapeLink){var e=new Ib.List(b.getPoints()),f=this.gl3dview.getElementUI(b);e.add(f.getFromPoint(),0),e.add(f.getToPoint());var d=this.getPointIndex(e,c)-1;d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeLink=b,b.addPoint(c,d),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}}},handle_mouseup:function(a){if(this.isStart){var b=Jb.clone(this._endLogical);if(this.resizingRect)if(this.lazyMode)if(this.gl3dview.isResizeAnimate()){var c=this,d=new Ib.animate.AnimateBounds(this.node,this.resizingRect,function(){c.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:c.node,resizeDirection:c.resizeDirection})});Ib.animate.AnimateManager.start(d)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"liveResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else if(this.shapeNode&&this.pointIndex>=0&&b){var e=this.shapeNode.getPoints().get(this.pointIndex);this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.shapeNode.setPoint(this.pointIndex,b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeNode,pointIndex:this.pointIndex})}else if(this.shapeLink&&this.pointIndex>=0&&b){var e=this.shapeLink.getPoints().get(this.pointIndex);this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.shapeLink.setPoint(this.pointIndex,b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeLink,pointIndex:this.pointIndex})}else this.linkUI&&b&&(this.linkUI.setControlPoint(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.linkUI._element}))}this._handle_mouseup(a),this.clear()},handle_mousemove:function(a){if(this.isStartRotate&&this.node)return this._handleRotateElement(a,this.node),void(this.gl3dview.isShowRotateScale()&&this.showRotateScale());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0)return void this._handleMovingShapeNodePoint(a);if(this.shapeLink&&this.pointIndex>=0)return void this._handleMovingShapeLinkPoint(a);if(this.node&&this.resizeDirection)return void this._handleResizing(a);if(this.linkUI)return void this._handleMovingLinkControlPoint(a)}else if(this.gl3dview.isValidEvent(a)){if(this.gl3dview.isSelectingElement()||this.gl3dview.isMovingElement()||0===this.gl3dview.getSelectionContainer().size())return void this.clear();var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getElementUI(b);if(!c||!c.getEditAttachment())return void this.clear();var d=this.gl3dview.getLogicalPoint(a);if(b instanceof Jd){if(this.node=b,this._isEditingShapeNode(d)||this._isResizingNode(d))return void this.gl3dview.setEditingElement(!0);if(this._isRotatingElement(d))return this.gl3dview.setRotatingElement(!0),void this.gl3dview.setEditingElement(!0)}else if(b instanceof Ib.ShapeLink){if(this.shapeLink=b,this._isEditingShapeLink(d))return void this.gl3dview.setEditingElement(!0)}else if(c instanceof Ib.gl3dview.LinkUI&&xc.isOrthogonalLink(c._element)){this.linkUI=c;var e=this.linkUI.getControlPoint();return void(e&&this._contains(d,e,this.editPointSize)&&(this._setCrossCursor(),this.gl3dview.setEditingElement(!0)))}this.clear()}},_isRotatingElement:function(a){var b=this.gl3dview.getRotatePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle();return this._isRotating(a,"crosshair",c,d)},_isRotating:function(a,b,c,d){var e=this.gl3dview.getRotatePointSize(),f={x:c.x+c.width/2,y:c.y-this.gl3dview.getRotatePointOffset()-e},g=this._rotatePoint(f,d,c),h={x:g.x-e,y:g.y-e,width:2*e,height:2*e};return Tb.containsPoint(h,a)?(this._removeCursor(),this._setCursor(b),!0):!1},_handleRotateElement:function(a,b){this._handle_mousemove(a);var c=this._calculateAngle(this.gl3dview.getLogicalPoint(a),b);b.setAngle(c)},_calculateAngle:function(a,b){var c=b.getCenterLocation();return Math.round(180*Math.atan2(c.x-a.x,a.y-c.y)/Math.PI+180)},_handleMovingShapeNodePoint:function(a){if(this._handle_mousemove(a),!this.mouseMoved&&Jb.isCtrlDown(a)){var b=this._endLogical.x-this._startLogical.x,c=this._endLogical.y-this._startLogical.y;this.horizontal=Math.abs(b)>=Math.abs(c),this.vertical=!this.horizontal,this.mouseMoved=!0}var d=this.shapeNode.getPoints().get(this.pointIndex),e=Jb.clone(this._endLogical);this.horizontal&&(e.y=d.y),this.vertical&&(e.x=d.x),this.shapeNode.setPoint(this.pointIndex,e),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeNode,pointIndex:this.pointIndex})},_handleMovingShapeLinkPoint:function(a){if(this._handle_mousemove(a),!this.mouseMoved&&Jb.isCtrlDown(a)){var b=this._endLogical.x-this._startLogical.x,c=this._endLogical.y-this._startLogical.y;this.horizontal=Math.abs(b)>=Math.abs(c),this.vertical=!this.horizontal,this.mouseMoved=!0}var d=this.shapeLink.getPoints().get(this.pointIndex),e=Jb.clone(this._endLogical);this.horizontal&&(e.y=d.y),this.vertical&&(e.x=d.x),this.shapeLink.setPoint(this.pointIndex,e),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeLink,pointIndex:this.pointIndex})},_handleMovingLinkControlPoint:function(a){this._handle_mousemove(a),this.linkUI.setControlPoint(Jb.clone(this._endLogical)),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.linkUI._element})},_handleResizing:function(a){this._handle_mousemove(a);var b=this.node.getAngle(),c=this.node.getLocation(),d=this.node.getWidth()/2,e=this.node.getHeight()/2,f={x:c.x+d,y:c.y+e},g={x:-d,y:-e},h={x:-d,y:e},i={x:d,y:e},j={x:d,y:-e},k={x:0,y:-e},l={x:d,y:0},m={x:0,y:e},n={x:-d,y:0};if("northwest"===this.resizeDirection&&(this._transformPoint(i,f,b),g.x=this._endLogical.x,g.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),"north"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),k.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}if("northeast"===this.resizeDirection&&(this._transformPoint(h,f,b),j.x=this._endLogical.x,j.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"west"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),n.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("east"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),l.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("southwest"===this.resizeDirection&&(this._transformPoint(j,f,b),h.x=this._endLogical.x,h.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"south"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),m.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}"southeast"===this.resizeDirection&&(this._transformPoint(g,f,b),i.x=this._endLogical.x,i.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),this.lazyMode?(this.mark||(this.mark=Wb.createDiv(),this.mark.style.webkitTransform="rotate("+b+"deg)",this.mark.style.mozTransform="rotate("+b+"deg)",this.mark.style.OTransform="rotate("+b+"deg)",this.mark.style.msTransform="rotate("+b+"deg)",this.mark.style.transform="rotate("+b+"deg)",this.gl3dview.getTopDiv().appendChild(this.mark)),Wb.setDiv(this.mark,this.resizingRect,null,this.gl3dview.getResizeLineWidth(),this.gl3dview.getResizeLineColor()),this.gl3dview.fireInteractionEvent({kind:"lazyResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection})):(this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.gl3dview.fireInteractionEvent({kind:"liveResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection}))},_isEditingShapeNode:function(a){if(this.node instanceof Ib.ShapeNode){this.shapeNode=this.node;for(var b=this.shapeNode.getPoints(),c=0,d=b.size();d>c;c++){var e=b.get(c);if(this._contains(a,e,this.editPointSize))return this._setCrossCursor(),this.pointIndex=c,!0}}return this.pointIndex=-1,!1},_isEditingShapeLink:function(a){for(var b=this.shapeLink.getPoints(),c=0,d=b.size();d>c;c++){var e=b.get(c);if(this._contains(a,e,this.editPointSize))return this._setCrossCursor(),this.pointIndex=c,!0}return this.pointIndex=-1,!1},_isResizingNode:function(a){var b=this.gl3dview.getResizePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle(),e={x:c.x,y:c.y},f=this._rotatePoint(e,d,c);return this._isResizing(a,f.x,f.y,"northwest","nwse-resize")?!0:(e={x:c.x+c.width/2,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"north","ns-resize")?!0:(e={x:c.x+c.width,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"northeast","nesw-resize")?!0:(e={x:c.x,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"west","ew-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"east","ew-resize")?!0:(e={x:c.x,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southwest","nesw-resize")?!0:(e={x:c.x+c.width/2,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"south","ns-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southeast","nwse-resize")?!0:!1)))))))},_rotatePoint:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_isResizing:function(a,b,c,d,e){return this._contains(a,{x:b,y:c},this.resizePointSize)?(this.resizeDirection!==d&&(this._removeCursor(),e=this._changeCursorWithAngle(d,this.node.getAngle()),this._setCursor(e),this.resizeDirection=d),!0):!1},_getRect:function(a,b,c,d){var e=c>a?a:c,f=d>b?b:d,g=Math.abs(a-c),h=Math.abs(b-d);return{x:e,y:f,width:g,height:h}},_contains:function(a,b,c){var d={x:b.x-c,y:b.y-c,width:2*c,height:2*c};return Tb.containsPoint(d,a)},getPointIndex:function(a,b,c){if(a.size()<2)return 0;for(var d,e=a.get(0),f=1;f<a.size();f++){if(d=a.get(f),this.isPointOnLine(b,e,d,6))return f;e=d}return e=a.get(0),c&&this.isPointOnLine(b,e,d,6)?a.size():0},showRotateScale:function(){this.rotateScale||(this.rotateScale=Jb.html.createCanvas());var a,b,c,d,e,f=(new Ib.List,this.gl3dview.getRotateScaleWidth()),g=this.gl3dview.getRotateScaleHeight(),h=this.gl3dview.getRotatePointSize(),i=this.node.getAngle(),j=this.node.getOriginalRect(),k={x:j.x+j.width/2,y:j.y-this.gl3dview.getRotatePointOffset()-h},l=this._rotatePoint(k,i,j),m="13px Arial",n=i+"°";this.node.getAngle()>=0&&this.node.getAngle()<=180?(b={x:l.x+h,y:l.y},c={x:b.x+f,y:b.y},d={x:c.x,y:c.y-g},e={x:b.x,y:d.y}):this.node.getAngle()>180&&this.node.getAngle()<=360&&(b={x:l.x-h,y:l.y},c={x:b.x-f,y:b.y},d={x:c.x,y:c.y-g},e={x:b.x,y:d.y});var o=new Ib.List([b,c,d,e]),a=Jb.math.getRect(o),p=Jb.html.setCanvas(this.rotateScale,a);p.fillStyle=this.gl3dview.getRotateScaleFillColor(),p.fillRect(a.x,a.y,a.width,a.height),p.fillStyle=this.gl3dview.getRotateScaleFontColor(),p.textBaseline="middle",p.textAlign="center",p.font=m,p.fillText(n,a.x+a.width/2,a.y+a.height/2),this.gl3dview.getTopDiv().appendChild(this.rotateScale)},isPointOnLine:function(a,b,c,d){0>d&&(d=0);var e=this.getDistanceFromPointToLine(a,b,c);return d>=e&&a.x>=Math.min(b.x,c.x)-d&&a.x<=Math.max(b.x,c.x)+d&&a.y>=Math.min(b.y,c.y)-d&&a.y<=Math.max(b.y,c.y)+d},getDistanceFromPointToLine:function(a,b,c){if(b.x===c.x)return Math.abs(a.x-b.x);var d=(c.y-b.y)/(c.x-b.x),e=(c.x*b.y-b.x*c.y)/(c.x-b.x);return Math.abs(d*a.x-a.y+e)/Math.sqrt(d*d+1)},_transformPoint:function(a,b,c){var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x,g=a.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_reversPoint:function(a,b,c){c*=-1;var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x-b.x,g=a.y-b.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_changeCursorWithAngle:function(a,b){var c,d=["auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];switch(a){case"northwest":c=1;break;case"north":c=2;break;case"northeast":c=3;break;case"east":c=4;break;case"southeast":c=5;break;case"south":c=6;break;case"southwest":c=7;break;case"west":c=8;break;default:c=0}return(b>=360||-360>=b)&&(b%=360),b>22.5&&67.5>=b&&(c+=1),-22.5>b&&b>=-67.5&&(c-=1),b>67.5&&112.5>=b&&(c+=2),-67.5>b&&b>=-112.5&&(c-=2),b>112.5&&157.5>=b&&(c+=3),-112.5>b&&b>=-157.5&&(c-=3),b>157.5&&202.5>=b&&(c+=4),-157.5>b&&b>=-202.5&&(c-=4),b>202.5&&247.5>=b&&(c+=5),-202.5>b&&b>=-247.5&&(c-=5),b>247.5&&292.5>=b&&(c+=6),-247.5>b&&b>=-292.5&&(c-=6),b>292.5&&337.5>=b&&(c+=7),-292.5>b&&b>=-337.5&&(c-=7),c>8&&(c-=8),0>=c&&(c+=8),d[c]}}),Ib.gl3dview.interaction.CreateElementInteraction=function(a,b){b||(b=Jd),this.elementFunction=Ib.Util.isTypeOf(b,Jd)?function(a){var c=new b;return c instanceof Jd&&c.setCenterLocation(a),c}:b,Ib.gl3dview.interaction.CreateElementInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.CreateElementInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){var b=this.gl3dview.getLogicalPoint(a);if(b){var c=this.elementFunction(b);c&&this.gl3dview.addElementByInteraction(c)}}}),Ib.gl3dview.interaction.CreateLinkInteraction=function(a,b){b||(b=Ib.Link),this.linkFunction=Ib.Util.isTypeOf(b,Ib.Link)?function(a,c){var d=new b;return d instanceof Ib.Link&&(d.setFromNode(a),d.setToNode(c)),d}:b,Ib.gl3dview.interaction.CreateLinkInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.CreateLinkInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove")},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear()},clear:function(){var a=this;setTimeout(function(){a._fromRectangle&&(a.gl3dview.getTopDiv().removeChild(a._fromRectangle),a._fromRectangle=null),a._currentRectangle&&(a.gl3dview.getTopDiv().removeChild(a._currentRectangle),a._currentRectangle=null),a._line&&(a.gl3dview.getTopDiv().removeChild(a._line),a._line=null)}),this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null},createLink:function(){return this.linkFunction(this.fromNode,this.toNode)},handle_mousedown:function(a){if(this.gl3dview.isValidEvent(a))if(this.fromNode){if(this.toNode=this.currentNode,this.toNode){var b=this.createLink();b&&this.gl3dview.addElementByInteraction(b)}this.clear()}else this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.updateMark()},handle_mousemove:function(a){var b=this.gl3dview.getLogicalPoint(a);if(b){if(this.gl3dview.isMovingElement()||this.gl3dview.isEditingElement())return void this.clear();var c=null;this.fromNode?(this.currentNode=this.getToNode(a),this.currentPoint=b,this.updateMark()):(c=this.getFromNode(a),this.currentNode!==c&&(this.currentNode=c,this.updateMark()))}},getFromNode:function(a){return this.getNode(a)},getToNode:function(a){return this.getNode(a)},getNode:function(a){var b=this.gl3dview.getElementAt(a);return b instanceof Jd&&this.gl3dview.isLinkable(b)?b:null},updateMark:function(){var a;this.fromNode&&!this._fromRectangle&&this._currentRectangle&&(this._fromRectangle=this._currentRectangle,this._currentRectangle=null),!this.fromNode&&this._fromRectangle&&(this.gl3dview.getTopDiv().removeChild(this._fromRectangle),this._fromRectangle=null),this.currentNode&&!this._currentRectangle&&(a=this.gl3dview.getElementUI(this.currentNode),this._currentRectangle=Wb.createDiv(),this.gl3dview.getTopDiv().appendChild(this._currentRectangle),Wb.setDiv(this._currentRectangle,a._viewRect,null,this.gl3dview.getEditLineWidth(),this.gl3dview.getEditLineColor())),!this.currentNode&&this._currentRectangle&&(this.gl3dview.getTopDiv().removeChild(this._currentRectangle),this._currentRectangle=null),this.updateLine()},updateLine:function(){if(this.currentPoint){var a=this.fromNode.getCenterLocation(),b=a.x,c=a.y,d=this.currentPoint.x,e=this.currentPoint.y;this._line||(this._line=Wb.createCanvas(),this.gl3dview.getTopDiv().appendChild(this._line));var f=Wb.setCanvas(this._line,Math.min(b,d),Math.min(c,e),Math.abs(b-d),Math.abs(c-e));f.lineWidth=this.gl3dview.getEditLineWidth(),f.strokeStyle=this.gl3dview.getEditLineColor(),f.beginPath(),f.moveTo(b,c),f.lineTo(d,e),f.stroke()}else this._line&&(this.gl3dview.getTopDiv().removeChild(this._line),this._line=null)}}),Ib.gl3dview.interaction.CreateShapeNodeInteraction=function(a,b){b||(b=Ib.ShapeNode),this.shapeNodeFunction=Ib.Util.isTypeOf(b,Ib.ShapeNode)?function(a){var c=new b;return c instanceof Ib.ShapeNode&&a&&c.setPoints(a),c}:b,Ib.gl3dview.interaction.CreateShapeNodeInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.CreateShapeNodeInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove")},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear()},clear:function(){this.gl3dview.setEditingElement(!1),this.points=null,this.currentPoint=null,this.lastPoint=null,this.horizontal=!1,this.vertical=!1,this.mark&&(this.gl3dview.getTopDiv().removeChild(this.mark),this.mark=null)},handle_mousedown:function(a){if(0===a.button){var b=this.gl3dview.getLogicalPoint(a);if(b)if(2===a.detail){if(this.points){var c=this.shapeNodeFunction(this.points);this.gl3dview.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.gl3dview.setEditingElement(!1)},0)}}else{if(this.gl3dview.isEditingElement()||this.gl3dview.setEditingElement(!0),this.points||(this.points=new md),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return}this._handle_mousedown(a),this.points.size()>0&&Jb.isCtrlDown(a)&&(this.horizontal&&(b.y=e.y),this.vertical&&(b.x=e.x),this.horizontal=!1,this.vertical=!1),this.lastPoint=b,this.points.add(b),this.updateMark()}}},handle_mousemove:function(a){if(this.points){if(this.currentPoint=this.gl3dview.getLogicalPoint(a),Jb.isCtrlDown(a)){var b=this.currentPoint.x-this.lastPoint.x,c=this.currentPoint.y-this.lastPoint.y;this.horizontal=Math.abs(b)>=Math.abs(c),this.vertical=!this.horizontal}else this.horizontal=!1,this.vertical=!1;this.horizontal&&(this.currentPoint.y=this.lastPoint.y),this.vertical&&(this.currentPoint.x=this.lastPoint.x),this.updateMark()}},updateMark:function(a){if(this.points&&this.points.size()>0&&this.currentPoint){this.mark||(this.mark=Wb.createCanvas(),this.gl3dview.getTopDiv().appendChild(this.mark));var b=new md(this.points);b.add(this.currentPoint);var c=Tb.getRect(b),d=this.gl3dview.getEditLineWidth();Jb.math.grow(c,d,d);var e=Wb.setCanvas(this.mark,c);e.lineWidth=d,e.strokeStyle=this.gl3dview.getEditLineColor(),e.beginPath(),Xb.drawLinePoints(e,b),e.stroke()}}}),Ib.gl3dview.interaction.CreateShapeLinkInteraction=function(a,b){Ib.gl3dview.interaction.CreateShapeLinkInteraction.superClass.constructor.call(this,a),b||(b=Ib.ShapeLink),this.linkFunction=Ib.Util.isTypeOf(b,Ib.ShapeLink)?function(a,c,d){var e=new b;return e instanceof Ib.ShapeLink&&(e.setFromNode(a),e.setToNode(c),d&&e.setPoints(d)),e}:b},Jb.ext("twaver.gl3dview.interaction.CreateShapeLinkInteraction",Ib.gl3dview.interaction.CreateLinkInteraction,{clear:function(){this.gl3dview.setEditingElement(!1),this.points=null,this.polyline&&(this.gl3dview.getTopDiv().removeChild(this.polyline),this.polyline=null),Ib.gl3dview.interaction.CreateShapeLinkInteraction.superClass.clear.call(this)},createLink:function(){return this.linkFunction(this.fromNode,this.toNode,this.points)},handle_mousedown:function(a){if(0===a.button){var b=this.gl3dview.getLogicalPoint(a);if(b)if(this.fromNode)if(this.toNode=this.currentNode,this.toNode){var c=this.createLink();c&&this.gl3dview.addElementByInteraction(c),this.clear()}else{if(this.points||(this.points=new md),this.points.size()>0){var d=this.points.get(this.points.size()-1);if(d.x===b.x&&d.y===b.y)return}this.points.add(b),this.updateMark()}else this.fromNode=this.currentNode,this.fromNode&&(this.polyline||(this.polyline=Wb.createCanvas(),this.gl3dview.getTopDiv().appendChild(this.polyline))),this.points=null,this.currentNode=null,this.currentPoint=null,this.updateMark()}},updateLine:function(){if(this.currentPoint&&this.polyline){var a=new md(this.points);a.add(this.fromNode.getCenterLocation(),0),a.add(this.currentPoint);var b=Tb.getRect(a),c=Wb.setCanvas(this.polyline,b);c.lineWidth=this.gl3dview.getEditLineWidth(),c.strokeStyle=this.gl3dview.getEditLineColor(),c.beginPath(),Xb.drawLinePoints(c,a),c.stroke()}}}),Ib.gl3dview.interaction.CreateOrthogonalLinkInteraction=function(a,b,c,d,e,f){Ib.gl3dview.interaction.CreateOrthogonalLinkInteraction.superClass.constructor.call(this,a,b),this.linkType=c||"orthogonal",this.isByControlPoint=d,this.splitPercent=e,this.isSplitByPercent=f,this.link=new Ib.Link,this.link.setStyle("link.type",this.linkType),this.link.setStyle("link.split.by.percent",this.isSplitByPercent),xc.isFlexionalTypeLink(this.linkType)||xc.isExtendTypeLink(this.linkType)?(this.splitPercent<0&&(this.splitPercent=Ib.Styles.getStyle("link.extend")),this.link.setStyle("link.extend",this.splitPercent)):xc.isSplitTypeLink(this.linkType)&&(this.splitPercent<0&&(this.splitPercent=Ib.Styles.getStyle(this.isSplitByPercent?"link.split.percent":"link.split.value")),this.isSplitByPercent?this.link.setStyle("link.split.percent",this.splitPercent):this.link.setStyle("link.split.value",this.splitPercent))},Jb.ext("twaver.gl3dview.interaction.CreateOrthogonalLinkInteraction",Ib.gl3dview.interaction.CreateLinkInteraction,{clear:function(){this.path&&(this.gl3dview.getTopDiv().removeChild(this.path),this.path=null),Ib.gl3dview.interaction.CreateOrthogonalLinkInteraction.superClass.clear.call(this)},createLink:function(){var a=Ib.gl3dview.interaction.CreateOrthogonalLinkInteraction.superClass.createLink.call(this);if(a.setStyle("link.type",this.linkType),a.setStyle("link.split.by.percent",this.isSplitByPercent),this.isByControlPoint){var b=xc.getControlPoint(a);if(b)return a.SetStyle("link.control.point",b),a}else xc.isFlexionalTypeLink(this.linkType)||xc.isExtendTypeLink(this.linkType)?(this.splitPercent<0&&(this.splitPercent=Ib.Styles.getStyle("link.extend")),a.setStyle("link.extend",this.splitPercent)):xc.isSplitTypeLink(this.linkType)&&(this.splitPercent<0&&(this.splitPercent=Ib.Styles.getStyle(this.isSplitByPercent?"link.split.percent":"link.split.value")),this.isSplitByPercent?a.setStyle("link.split.percent",this.splitPercent):a.setStyle("link.split.value",this.splitPercent));return a},updateLine:function(){if(this.currentPoint){if(!this.fromNode||this.currentNode===this.fromNode)return;var a,b=this.gl3dview.getElementUI(this.fromNode);if(!b)return;if(a=b.getBodyRect(),null==a)return;var c;if(this.currentNode&&this.currentNode!==this.fromNode){var d=this.gl3dview.getElementUI(this.currentNode);if(!d)return;c=d.getBodyRect()}else c={x:this.currentPoint.x,y:this.currentPoint.y,width:1,height:1};if(!c)return;var e=xc.calculateOrthogonalAndFlexionalLinkPoints(this.linkType,a,c,this.link);if(xc.drawCorner(e,this.link),e.size()<2)return;this.line||(this.line=Wb.createCanvas(),this.gl3dview.getTopDiv().appendChild(this.line));var f=Wb.setCanvas(this.line,Tb.getLineRect(e));f.lineWidth=this.gl3dview.getEditLineWidth(),f.strokeStyle=this.gl3dview.getEditLineColor(),f.beginPath(),Xb.drawLinePoints(f,e),f.stroke()}else this.line&&(this.gl3dview.getTopDiv().removeChild(this.line),this.line=null)}}),Ib.gl3dview.interaction.MagnifyInteraction=function(a,b,c,d,e){Ib.gl3dview.interaction.MagnifyInteraction.superClass.constructor.call(this,a),this.zoom=b||2,this.xRadius=c||100,this.yRadius=d||100,this.shape=e||"circle",this.borderColor="black",this.borderWidth=1,this.backgroundColor="white",this.markCanvas=Wb.createCanvas(),this.markCanvas._isIgnored=!0},Jb.ext("twaver.gl3dview.interaction.MagnifyInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){this.addListener("mousemove")},tearDown:function(){this.removeListener("mousemove"),this._clear()},handle_mousemove:function(a){var b=this.gl3dview.getLogicalPoint(a);b&&(this.lastPoint||this.gl3dview.getView().appendChild(this.markCanvas),this.lastPoint=b,this.updateMark())},updateMark:function(){var a,b=this.gl3dview._zoom,c=this.zoom*b,d=this.lastPoint.x*b-this.xRadius,e=this.lastPoint.y*b-this.yRadius,f=2*this.xRadius,g=2*this.yRadius,h={x:this.lastPoint.x-this.xRadius/c,y:this.lastPoint.y-this.yRadius/c,width:f/c,height:g/c},i=this.borderWidth,j=Wb.createCanvas();j.width=f,j.height=g,this.gl3dview.toCanvasByRegion(h,c,j),Wb.setCanvas(this.markCanvas,d,e,f,g),a=this.markCanvas.getContext("2d"),a.save(),a.beginPath(),Xb.drawVector(a,this.shape,null,d,e,f,g),a.clip(),a.fillStyle=this.backgroundColor,a.beginPath(),a.rect(d,e,f,g),a.fill(),a.drawImage(j,d,e),a.restore(),a.beginPath(),a.lineWidth=i,Xb.drawVector(a,this.shape,null,d+i/2,e+i/2,f-i,g-i),a.strokeStyle=this.borderColor,a.stroke()},_clear:function(a){this.lastPoint&&(this.gl3dview.getView().removeChild(this.markCanvas),this.lastPoint=null)},getZoom:function(){return this.zoom},setZoom:function(a){this.zoom=a,this.updateMark()},getShape:function(){return this.shape},setShape:function(a){this.shape=a,this.updateMark()},getXRadius:function(){return this.xRadius},setXRadius:function(a){this.xRadius=a,this.updateMark()},getYRadius:function(){return this.yRadius},setYRadius:function(a){this.yRadius=a,this.updateMark()},getBorderColor:function(){return this.borderColor},setBorderColor:function(a){this.borderColor=a,this.updateMark()},getBorderWidth:function(){return this.borderWidth},setBorderWidth:function(a){this.borderWidth=a,this.updateMark()},getBackgroundColor:function(){return this.backgroundColor},setBackgroundColor:function(a){this.backgroundColor=a,this.updateMark()}}),Ib.gl3dview.interaction.TouchInteraction=function(a){Ib.gl3dview.interaction.TouchInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.gl3dview.interaction.TouchInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){var a=this.gl3dview.getView();Wb.addEventListener("touchstart","handleTouchstart",a,this),Wb.addEventListener("touchmove","handleTouchmove",a,this),Wb.addEventListener("touchend","handleTouchend",a,this),Wb.addEventListener("touchcancel","handleTouchend",a,this)},tearDown:function(){var a=this.gl3dview.getView();Wb.removeEventListener("touchstart",a,this),Wb.removeEventListener("touchmove",a,this),Wb.removeEventListener("touchend",a,this),Wb.removeEventListener("touchcancel",a,this)},handleTouchstart:function(a){if(Wb.preventDefault(a),a.touches&&1==a.touches.length){var b=this.gl3dview.getLogicalPoint(a),c=this.gl3dview.getElementAt(b);this._startTouchTime=new Date,this._startTouchPoint=b;var d=this;c?(this._haveElementUnderTouch=!0,this._startTouchElement=c):(this._haveElementUnderTouch=!1,this._startTouchElement=null),this.timer=setTimeout(function(){Cc.handleLongClicked(d.gl3dview,a,c)},1e3)}else a.touches&&2==a.touches.length&&(this._distance=zc.getDistance(a),this._zoom=this.gl3dview.getZoom(),this._startTouchPoint={x:a.touches[0].clientX,y:a.touches[0].clientY});this._touchCount=a.touches.length},handleTouchmove:function(a){if(Wb.preventDefault(a),2==this._touchCount&&a.touches&&2==a.touches.length)if(this.timer&&clearTimeout(this.timer),Math.abs(this._distance-zc.getDistance(a))>=Cd.TOUCH_ZOOM_THRESHOLD||this._zoomFlag){this._zoomFlag=!0;var b=zc.getDistance(a)/this._distance;this.gl3dview.setTouchZoom(this._zoom*b,!1)}else{var c=a.touches[0],d=this._startTouchPoint.x-c.clientX,e=this._startTouchPoint.y-c.clientY,f=this.gl3dview.panByOffset(d,e);this._startTouchPoint.x-=d-f.x,
this._startTouchPoint.y-=e-f.y}else if(1==this._touchCount&&a.touches&&1==a.touches.length)if(this._haveElementUnderTouch||!this.gl3dview.isRectSelectEnabled()){var g=this.gl3dview.getLogicalPoint(a),h=this.gl3dview.getElementAt(g);if(this.gl3dview.isMovingElement()||null!=this._startTouchElement&&this._startTouchElement==h&&this.gl3dview.getMovableSelectedElements().contains(h)){var d=g.x-this._startTouchPoint.x,e=g.y-this._startTouchPoint.y;(Math.abs(d)>=Cd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Cd.TOUCH_MOVE_THRESHOLD)&&(this._startTouchPoint=g,this.gl3dview.moveSelectedElements(d,e),this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}),this.timer&&clearTimeout(this.timer)))}else{var d=g.x-this._startTouchPoint.x,e=g.y-this._startTouchPoint.y;(Math.abs(d)>=Cd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Cd.TOUCH_MOVE_THRESHOLD)&&this.timer&&clearTimeout(this.timer)}}else{this._moveTouchPoint=this.gl3dview.getLogicalPoint(a);var d=this._moveTouchPoint.x-this._startTouchPoint.x,e=this._moveTouchPoint.y-this._startTouchPoint.y;if(Math.abs(d)>=Cd.TOUCH_RECT_SELECT_THRESHOLD&&Math.abs(e)>=Cd.TOUCH_RECT_SELECT_THRESHOLD){this.mark?this.gl3dview.fireInteractionEvent({kind:"selectBetween",event:a}):(this.mark=Wb.createDiv(),this.gl3dview.getTopDiv().appendChild(this.mark),this.gl3dview.setSelectingElement(!0),this.gl3dview.fireInteractionEvent({kind:"selectStart",event:a}),this.timer&&clearTimeout(this.timer));var i=Tb.getRect([this._startTouchPoint,this._moveTouchPoint]);Wb.setDiv(this.mark,i,this.getIntersectMode()?this.gl3dview.getSelectFillColor():null,this.gl3dview.getSelectOutlineWidth(),this.gl3dview.getSelectOutlineColor())}}},handleTouchend:function(a){if(Wb.preventDefault(a),this.gl3dview.isMovingElement())this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a});else if(this.gl3dview.isSelectingElement()){var b=this.gl3dview.getElementsAtRect(this.mark._viewRect,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(b&&b.size()>0){var c=this.gl3dview.getSelectionContainer(),d=c.toSelection();b.forEach(function(a){c.contains(a)?d.remove(a):d.add(a)},this),c.setSelection(d)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:a}),this.gl3dview.getTopDiv().removeChild(this.mark),this.mark=null,this.gl3dview.setSelectingElement(!1),this.timer&&clearTimeout(this.timer)}else if(this._startTouchPoint){this._zoomFlag=!1;var e=new Date,f=this.gl3dview.getLogicalPoint(a),g=this.gl3dview.getElementAt(this._startTouchPoint);this._startTouchPoint&&f&&e.getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,f)<=20&&(g?this.gl3dview.getSelectionContainer().contains(g)||this.gl3dview.getSelectionContainer().setSelection(g):this.gl3dview.getSelectionContainer().clearSelection(),Cc.handleClicked(this.gl3dview,a,g),this.timer&&clearTimeout(this.timer),this._endTouchTime&&e.getTime()-this._endTouchTime.getTime()<=500&&Tb.getDistance(this._endTouchPoint,f)<=20?(delete this._endTouchTime,delete this._endTouchPoint,Cc.handleDoubleClicked(this.gl3dview,a,g),this.timer&&clearTimeout(this.timer)):(this._endTouchTime=e,this._endTouchPoint=f))}},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y}}),Ib.gl3dview.interaction.MSTouchInteraction=function(a){Ib.gl3dview.interaction.MSTouchInteraction.superClass.constructor.call(this,a),this._pointerMap={},this._pointerIdArray=[]},Jb.ext("twaver.gl3dview.interaction.MSTouchInteraction",Ib.gl3dview.interaction.BaseInteraction,{setUp:function(){var a=this.gl3dview.getView();Wb.addEventListener("MSPointerDown","handleTouchstart",a,this),Wb.addEventListener("MSPointerMove","handleTouchmove",a,this),Wb.addEventListener("MSPointerUp","handleTouchend",a,this),Wb.addEventListener("MSPointerCancel","handleTouchend",a,this)},tearDown:function(){var a=this.gl3dview.getView();Wb.removeEventListener("MSPointerDown",a,this),Wb.removeEventListener("MSPointerMove",a,this),Wb.removeEventListener("MSPointerUp",a,this),Wb.removeEventListener("MSPointerCancel",a,this)},handleTouchstart:function(a){if(this.gl3dview.isFocusOnClick()&&Ib.Util.setFocus(this.gl3dview._view),!this.gl3dview.isSelectingElement()||a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.gl3dview.getLogicalPoint(a),c=new Date;if(a.isPrimary&&this._pointerIdArray.length>0&&this.handle_mouseup(a),this._pointerMap[a.pointerId]||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length){var d=this.gl3dview.getElementAt(b);this._startTouchElement=d,this._startClientPoint={x:a.clientX,y:a.clientY},Cc.handleClicked(this.gl3dview,a,d),this._startTouchTime&&this._startTouchPoint&&c.getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,b)<=20?(Cc.handleDoubleClicked(this.gl3dview,a,d),this._doubleClick=!0):(Wb.handle_mousedown(this,a),this._startTouchPoint=b,this._startTouchTime=c);var e=this.gl3dview.getSelectionContainer();d?Jb.isCtrlDown(a)?e.contains(d)?e.removeSelection(d):e.appendSelection(d):e.contains(d)||e.setSelection(d):Jb.isCtrlDown(a)||e.clearSelection()}else 2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.gl3dview.getZoom())}},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance;this.gl3dview.setZoom(this._zoom*b,!1)}},handleTouchend:function(a){if(this.gl3dview.isMovingElement()&&(this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a})),this.gl3dview.isSelectingElement()){var b=this.gl3dview.getElementsAtRect(this.mark._viewRect,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(b&&b.size()>0){var c=this.gl3dview.getSelectionContainer(),d=c.toSelection();b.forEach(function(a){c.contains(a)?d.remove(a):d.add(a)},this),c.setSelection(d)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:a}),this.gl3dview.getTopDiv().removeChild(this.mark),this.mark=null,this.gl3dview.setSelectingElement(!1)}this._doubleClick&&(delete this._doubleClick,delete this._startTouchPoint,delete this._startTouchTime);for(var e=-1,f=0;f<this._pointerIdArray.length;f++)if(this._pointerIdArray[f]==a.pointerId){e=f;break}e>=0&&this._pointerIdArray.splice(e,1),delete this._pointerMap[a.pointerId]},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y},handle_mousemove:function(a){if(this._startTouchPoint&&1==this._pointerIdArray.length){if(this._moveTouchPoint={x:this._startTouchPoint.x+(a.clientX-this._startClientPoint.x)/this.gl3dview.getZoom(),y:this._startTouchPoint.y+(a.clientY-this._startClientPoint.y)/this.gl3dview.getZoom()},Tb.getDistance(this._startTouchPoint,this._moveTouchPoint)<3)return;if(null==this._startTouchElement&&this.gl3dview.isRectSelectEnabled()){this.mark?this.gl3dview.fireInteractionEvent({kind:"selectBetween",event:a}):(this.mark=Wb.createDiv(),this.gl3dview.getTopDiv().appendChild(this.mark),this.gl3dview.setSelectingElement(!0),this.gl3dview.fireInteractionEvent({kind:"selectStart",event:a}));var b=Tb.getRect([this._startTouchPoint,this._moveTouchPoint]);Wb.setDiv(this.mark,b,this.getIntersectMode()?this.gl3dview.getSelectFillColor():null,this.gl3dview.getSelectOutlineWidth(),this.gl3dview.getSelectOutlineColor())}else{var c=this.gl3dview.getElementAt(this._moveTouchPoint),d=this._moveTouchPoint.x-this._startTouchPoint.x,e=this._moveTouchPoint.y-this._startTouchPoint.y;if(null!=this._startTouchElement||this.gl3dview.isRectSelectEnabled())(this.gl3dview.isMovingElement()||null!=this._startTouchElement&&c==this._startTouchElement&&this.gl3dview.getMovableSelectedElements().contains(c))&&(this.gl3dview.moveSelectedElements(d,e),this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a})));else{this.gl3dview.panByOffset(-d,-e)}this._startClientPoint.x=a.clientX,this._startClientPoint.y=a.clientY}}},handle_mouseup:function(a){this.handleTouchend(a),this._pointerIdArray=[],this._pointerMap={}}});var Md={_hitCanvas:null,getHitCanvas:function(a,b){null==this._hitCanvas&&(this._hitCanvas=Wb.createCanvas()),0==arguments.length&&(a=2,b=2),this._hitCanvas.setAttribute("width",""+a-1),this._hitCanvas.setAttribute("height",""+b-1),this._hitCanvas.setAttribute("width",""+a),this._hitCanvas.setAttribute("height",""+b);var c=this.getCtx(this._hitCanvas);return c.clearRect(0,0,a,b),this._hitCanvas},disposeHitCanvas:function(){this._hitCanvas=null},getCtx:function(a){return a.getContext("2d")},render:function(a,c,d){c!=b&&(a.fillStyle=c,a.fill()),d!=b&&(a.strokeStyle=d,a.stroke())},text:function(a,b,c,d,e,f){a.textAlign="center",a.textBaseline="middle",null!=e&&(a.fillStyle=e,a.fillText(b,c,d)),f&&(a.strokeStyle=f,a.strokeText(b,c,d))},circle:function(a,b,c,d,e,f){a.arc(b,c,d,0,2*Math.PI,!0),a.closePath(),this.render(a,e,f)},rect:function(a,b,c,d,e,f,g){a.rect(b,c,d,e),a.closePath(),this.render(a,f,g)},OUT_LEFT:1,OUT_TOP:2,OUT_RIGHT:4,OUT_BOTTOM:8,outcode:function(a,b,c,d,e,f){var g=0;return 0>=e?g|=this.OUT_LEFT|this.OUT_RIGHT:c>a?g|=this.OUT_LEFT:a>c+e&&(g|=this.OUT_RIGHT),0>=f?g|=this.OUT_TOP|this.OUT_BOTTOM:d>b?g|=this.OUT_TOP:b>d+f&&(g|=this.OUT_BOTTOM),g},intersectsLine:function(a,b,c,d,e,f,g,h){var i,j;if(0==(j=this.outcode(c,d,e,f,g,h)))return!0;for(;0!=(i=this.outcode(a,b,e,f,g,h));){if(0!=(i&j))return!1;if(0!=(i&(this.OUT_LEFT|this.OUT_RIGHT))){var k=e;0!=(i&this.OUT_RIGHT)&&(k+=g),b+=(k-a)*(d-b)/(c-a),a=k}else{var l=f;0!=(i&this.OUT_BOTTOM)&&(l+=h),a+=(l-b)*(c-a)/(d-b),b=l}}return!0}};Ib.canvas={},Ib.canvas.interaction={},Ib.canvas.Gl3dview=function(a){Ib.canvas.Gl3dview.superClass.constructor.apply(this,arguments),this._rootCanvas=Wb.createCanvas(),this._topCanvas=Wb.createCanvas(),this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0},this._zoom=1,this._elementUIMap={},this._visibleMap={},this.viewRect={x:0,y:0,width:0,height:0},this.hScrollBarVisible=!1,this.vScrollBarVisible=!1,this.markerList=new Ib.List,this._topAttachmentList=new Ib.List,this.setElementBox(a?a:new Ib.ElementBox),Mb||(this._view=Wb.createView("hidden"),this._view.appendChild(this._rootCanvas),this._view.appendChild(this._topCanvas),Qb.isMSToucheable?this.setMSTouchInteractions():Qb.isTouchable?this.setTouchInteractions():this.setDefaultInteractions(!1),this.setToolTipEnabled(Ib.Defaults.NETWORK_TOOLTIP_ENABLED));var b=this;this._flowLink=function(){if(!(b.isMovingElement()||b.isSelectingElement()||b.isEditingElement()||b._box._layoutMovingElements)){b._flowLinkQuickFinder||(b._flowLinkQuickFinder=new Ib.QuickFinder(b._box,"link.flow","style"));var a=b._flowLinkQuickFinder.find(!0);a.forEach(function(a){a._styleMap["link.flow.offset"]=b.getLinkFlowOffset(a);var c=b.getElementUI(a);c.invalidate(!1)})}}},Jb.ext("twaver.canvas.Gl3dview",Ib.controls.View,{__accessor:["selectMode","makeVisibleOnSelected","movableFunction","editPointSize","editPointFillColor","scrollBarWidth","editPointOutlineWidth","editPointOutlineColor","editLineColor","editLineWidth","resizePointSize","resizePointFillColor","resizePointOutlineWidth","resizePointOutlineColor","resizeLineColor","resizeLineWidth","rotatePointSize","rotatePointFillColor","rotatePointOffset","rotatePointOutlineWidth","rotatePointOutlineColor","rotateScaleFillColor","rotateScaleFontColor","rotateScaleWidth","rotateScaleHeight","selectOutlineColor","selectOutlineWidth","selectFillColor","lazyMoveOutlineColor","lazyMoveOutlineWidth","lazyMoveFillColor","rectSelectFilter","paddingRight","paddingBottom","selectionTolerance"],__bool:["doubleClickToUpSubGl3dview","doubleClickToSubGl3dview","doubleClickToEmptySubGl3dview","doubleClickToLinkBundle","doubleClickToGroupExpand","scrollBarVisible","limitViewInCanvas","autoValidateCanvasSize","subGl3dviewAnimate","lazyMoveAnimate","resizeAnimate","noAgentLinkVisible","keyboardRemoveEnabled","keyboardSelectEnabled","sendToTopOnSelected","lazyMoveFill","editingElement","rotatingElement","movingElement","selectingElement","rectSelectEnabled","limitElementInPositiveLocation","showRotateScale","transparentSelectionEnable","debug"],_currentSubGl3dview:null,_subGl3dviewAnimate:Ib.Defaults.NETWORK_SUBNETWORK_ANIMATE,_scrollBarWidth:10,_scrollBarVisible:!0,_limitViewInCanvas:!0,_autoValidateCanvasSize:!0,_makeVisibleOnSelected:Ib.Defaults.NETWORK_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Ib.Defaults.NETWORK_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Ib.Defaults.NETWORK_KEYBOARD_SELECT_ENABLED,_rectSelectEnabled:Cd.NETWORK_RECT_SELECT_ENABLED,_rectSelectFilter:null,_elementUIFunction:Ib.Defaults.CANVASUI_FUNCTION,_doubleClickToUpSubGl3dview:Ib.Defaults.NETWORK_DOUBLECLICK_TO_UPSUBNETWORK,_doubleClickToSubGl3dview:Ib.Defaults.NETWORK_DOUBLECLICK_TO_SUBNETWORK,_doubleClickToEmptySubGl3dview:Ib.Defaults.NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK,_doubleClickToLinkBundle:Ib.Defaults.NETWORK_DOUBLECLICK_TO_LINKBUNDLE,_doubleClickToGroupExpand:Ib.Defaults.NETWORK_DOUBLECLICK_TO_GROUPEXPAND,_selectOutlineColor:Ib.Defaults.NETWORK_SELECT_OUTLINE_COLOR,_selectOutlineWidth:Ib.Defaults.NETWORK_SELECT_OUTLINE_WIDTH,_selectFillColor:Ib.Defaults.NETWORK_SELECT_FILL_COLOR,_sendToTopOnSelected:Ib.Defaults.NETWORK_SENDTOTOP_ON_SELECTED,_lazyMoveOutlineColor:Ib.Defaults.NETWORK_LAZYMOVE_OUTLINE_COLOR,_lazyMoveOutlineWidth:Ib.Defaults.NETWORK_LAZYMOVE_OUTLINE_WIDTH,_lazyMoveFillColor:Ib.Defaults.NETWORK_LAZYMOVE_FILL_COLOR,_lazyMoveFill:Ib.Defaults.NETWORK_LAZYMOVE_FILL,_lazyMoveAnimate:Ib.Defaults.NETWORK_LAZYMOVE_ANIMATE,_resizePointSize:Ib.Defaults.NETWORK_RESIZE_POINT_SIZE,_resizePointFillColor:Ib.Defaults.NETWORK_RESIZE_POINT_FILL_COLOR,_resizePointOutlineColor:Ib.Defaults.NETWORK_RESIZE_POINT_OUTLINE_COLOR,_resizePointOutlineWidth:Ib.Defaults.NETWORK_RESIZE_POINT_OUTLINE_WIDTH,_resizeLineColor:Ib.Defaults.NETWORK_RESIZE_LINE_COLOR,_resizeLineWidth:Ib.Defaults.NETWORK_RESIZE_LINE_WIDTH,_resizeAnimate:Ib.Defaults.NETWORK_RESIZE_ANIMATE,_editPointSize:Ib.Defaults.NETWORK_EDIT_POINT_SIZE,_editPointFillColor:Ib.Defaults.NETWORK_EDIT_POINT_FILL_COLOR,_editPointOutlineColor:Ib.Defaults.NETWORK_EDIT_POINT_OUTLINE_COLOR,_editPointOutlineWidth:Ib.Defaults.NETWORK_EDIT_POINT_OUTLINE_WIDTH,_editLineColor:Ib.Defaults.NETWORK_EDIT_LINE_COLOR,_editLineWidth:Ib.Defaults.NETWORK_EDIT_LINE_WIDTH,_rotatePointSize:Ib.Defaults.NETWORK_ROTATE_POINT_SIZE,_rotatePointFillColor:Ib.Defaults.NETWORK_ROTATE_POINT_FILL_COLOR,_rotatePointOffset:Ib.Defaults.NETWORK_ROTATE_POINT_OFFSET,_rotatePointOutlineWidth:Ib.Defaults.NETWORK_ROTATE_POINT_OUTLINE_WIDTH,_rotatePointOutlineColor:Ib.Defaults.NETWORK_ROTATE_POINT_OUTLINE_COLOR,_rotateScaleWidth:Cd.NETWORK_ROTATE_SCALE_WIDTH,_rotateScaleHeight:Cd.NETWORK_ROTATE_SCALE_HEIGHT,_rotateScaleFillColor:Cd.NETWORK_ROTATE_SCALE_FILL_COLOR,_rotateScaleFontColor:Cd.NETWORK_ROTATE_SCALE_FONT_COLOR,_limitElementInPositiveLocation:Cd.NETWORK_LIMIT_ELEMENT_INPOSITIVE_LOCATION,_linkFlowInterval:Cd.NETWORK_LINK_FLOW_INTERVAL,_selectionTolerance:Cd.NETWORK_SELECTION_TOLERANCE,_invalidateElementVisibility:!1,_invalidateViewRectFlag:!1,_repaintTopFlag:!1,_invalidateCanvasSizeFlag:!1,_isEditingElement:!1,_isRotatingElement:!1,_isMovingElement:!1,_isSelectingElement:!1,_hasEditInteraction:!1,_showRotateScale:!0,_paddingRight:0,_paddingBottom:0,_transparentSelectionEnable:Ib.Defaults.NETWORK_TRANSPARENT_SELECTION_ENABLE,_debug:!1,_autoAdjustBounds:!1,adjustBounds:function(a){if(Mb)this._rootCanvas=new Lb(a.width,a.height),this._topCanvas=new Lb(a.width,a.height),this.setViewRect(a.x,a.y,a.width,a.height);else{var b=!1,c=this._view.style;if(c.left==a.x+"px"&&c.top==a.y+"px"&&c.width==a.width+"px"&&c.height==a.height+"px"&&(b=!0),Ib.canvas.Gl3dview.superClass.adjustBounds.apply(this,arguments),1==b)return;var d=this._view.offsetWidth,e=this._view.offsetHeight;this._rootCanvas.setAttribute("width",d),this._rootCanvas.setAttribute("height",e),this._topCanvas.setAttribute("width",d),this._topCanvas.setAttribute("height",e),this.setViewRect(this.viewRect.x,this.viewRect.y,d,e)}"undefined"==typeof Ib.gis&&(Ib.Util.makeHighRes(this._rootCanvas),Ib.Util.makeHighRes(this._topCanvas)),this.invalidateElementVisibility()},setAutoAdjustBounds:function(b){b===!0?Wb.addEventListener("resize","handleResize",a,this):Wb.removeEventListener("resize",a,this),this._autoAdjustBounds=b},isAutoAdjustBounds:function(){return this._autoAdjustBounds},handleResize:function(a){this.adjustBounds({x:0,y:0,width:Ob.documentElement.clientWidth,height:Ob.documentElement.clientHeight})},getLabel:function(a){return a.getStyle("gl3dview.label")||a.getName()},getBackgroundImage:function(){return this._backgroundImage},setBackgroundImage:function(a){if(this._backgroundImage!=a){var b=this._backgroundImage;this._backgroundImage=a;var c=this._backgroundImage;if(c&&!c._viewRect)if(c.width>0)c._viewRect={x:0,y:0,width:c.width,height:c.height},this.validateCanvasSize(),this.firePropertyChange("backgroundImage",b,c);else{var d=this;c.onload=function(){c._viewRect={x:0,y:0,width:c.width,height:c.height},d.validateCanvasSize(),d.firePropertyChange("backgroundImage",b,c),c.onload=null}}else this.firePropertyChange("backgroundImage",b,c),this.validateCanvasSize()}},getRootCanvas:function(){return this._rootCanvas},getTopCanvas:function(){return this._topCanvas},validateImpl:function(){if(!Mb&&oc.twm(this),1==this._invalidateElementVisibility){this._invalidateElementVisibility=!1;var a,b,c,d=this.getElementBox().getDatas()._as,e=d.length,f={},g=this._visibleFunction,h=1===this._box._layerBox.size()?this._box._layerBox._defaultLayer:null;for(a=0;e>a;a++)b=d[a],f[b._id]=this.isVisible(b,g,h);if(this._visibleMap)for(a=0;e>a;a++)b=d[a],f[b._id]!==this._visibleMap[b._id]&&(c=this._elementUIMap[b._id],c&&c.invalidate());for(a=0;e>a;a++)b=d[a],c=this._elementUIMap[b._id],c&&c.validate();this._visibleMap=f,this.paintRoot()}this.validateCanvasSize(),1==this._repaintTopFlag&&(this._repaintTopFlag=!1,this.paintTopCanvas())},isLinkFlowEnabled:function(){return this._linkFlowEnabled?!0:!1},setLinkFlowEnabled:function(a){a?(this._linkFlowEnabled||(this._linkFlowEnabled=!0,this.firePropertyChange("linkFlowEnabled",!1,!0)),clearInterval(this._linkFlowTimerId),this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval)):(this._linkFlowEnabled&&(this._linkFlowEnabled=!1,this.firePropertyChange("linkFlowEnabled",!0,!1)),clearInterval(this._linkFlowTimerId),delete this._linkFlowTimerId)},getLinkFlowInterval:function(){return this._linkFlowInterval},setLinkFlowInterval:function(a){var b=this._linkFlowInterval;this._linkFlowInterval=a,this.firePropertyChange("linkFlowInterval",b,a),clearInterval(this._linkFlowTimerId),this.isLinkFlowEnabled()&&(this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval))},getElementBox:function(){return this._box},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeServaChangeListener(this.handleElementBoxChange,this),b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removePropertyChangeListener(this.handleElementBoxPropertyChange,this),b.removeIndexChangeListener(this.handleIndexChange,this),b.getLayerBox().removeServaChangeListener(this.handleLayerBoxChange,this),b.getLayerBox().removeDataPropertyChangeListener(this.handleLayerPropertyChange,this),b.getLayerBox().removeHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._selectionContainer||b.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addServaChangeListener(this.handleElementBoxChange,this),this._box.addDataPropertyChangeListener(this.handleElementPropertyChange,this),this._box.addPropertyChangeListener(this.handleElementBoxPropertyChange,this),this._box.addIndexChangeListener(this.handleIndexChange,this),this._box.getLayerBox().addServaChangeListener(this.handleLayerBoxChange,this),this._box.getLayerBox().addDataPropertyChangeListener(this.handleLayerPropertyChange,this),this._box.getLayerBox().addHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._flowLinkQuickFinder&&(this._flowLinkQuickFinder.dispose(),this._flowLinkQuickFinder=new Ib.QuickFinder(this._box,"link.flow","style")),this._selectionContainer?this._selectionContainer._setServa(a):this._box.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.firePropertyChange("elementBox",b,this._box)}},handleElementBoxChange:function(a){var b=a.data;if("add"===a.kind)this.createElementUI(b),this.invalidateBundleLink(b);else if("remove"===a.kind){var c=this.getElementUI(b);c&&(c.dispose(),delete this._elementUIMap[b.getId()]),b===this._currentSubGl3dview&&null!=this._currentSubGl3dview&&this._setCurrentSubGl3dview(null)}else"clear"===a.kind&&(this._elementUIMap={},null!=this._currentSubGl3dview&&this._setCurrentSubGl3dview(null));this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementPropertyChange:function(a){var b=a.source,c=this.getElementUI(b);c&&c.handlePropertyChange(a),this.invalidateBundleLink(b),this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementBoxPropertyChange:function(){this.invalidateElementVisibility()},handleIndexChange:function(a){this.invalidateElementVisibility()},handleLayerBoxChange:function(){this.invalidateElementVisibility()},handleLayerPropertyChange:function(a){"editable"===a.property&&this.invalidateSelectedElementUIs(!0),this.invalidateElementVisibility()},handleLayerHierarchyChange:function(){this.invalidateElementVisibility()},handleSelectionChange:function(a){a.datas.forEach(function(b){var c=this.getElementUI(b);c&&c.handleSelectionChange(a)},this);var b=this.getSelectionContainer().getLastData();b&&("append"===a.kind||"set"===a.kind)&&(this.isMakeVisibleOnSelected()&&this.makeVisible(b),this.isSendToTopOnSelected()&&this.sendToTop(b)),this.invalidateElementVisibility()},sendToTop:function(a){if(this._box.contains(a)){for(var b=a;b._parent&&this.isVisible(b._parent)&&(b=b._parent););b!==a&&this._box.adjustElementIndex(b),this._box.adjustElementIndex(a)}},getViewRect:function(){return this.viewRect?Jb.clone(this.viewRect):{x:0,y:0,width:0,height:0}},getCanvasSize:function(){return{width:this.realWidth,height:this.realHeight}},setViewOffSet:function(a,b){var c=this.viewRect.x,d=this.viewRect.y,e=this.viewRect.width,f=this.viewRect.height;this.setViewRect(c+a,d+b,e,f)},setViewRect:function(a,b,c,d){1==this.isLimitViewInCanvas()&&(0>a&&(a=0),c>this.realWidth?a=0:a+c>this.realWidth&&(a=this.realWidth-c),0>b&&(b=0),d>this.realHeight?b=0:b+d>this.realHeight&&(b=this.realHeight-d));var e=this.viewRect;(null==this.viewRect||a!=this.viewRect.x||b!=this.viewRect.y||c!=this.viewRect.width||d!=this.viewRect.height)&&(this.viewRect={x:a,y:b,width:c,height:d},this.firePropertyChange("viewRect",e,this.viewRect),this.invalidateElementVisibility())},isHScrollBarVisible:function(){return this.hScrollBarVisible},setHScrollBarVisible:function(a){this.hScrollBarVisible=a},isVScrollBarVisible:function(){return this.vScrollBarVisible},setVScrollBarVisible:function(a){this.vScrollBarVisible=a},dispose:function(){for(var a in this._elementUIMap){var b=this._elementUIMap[a];b.curInterval&&clearTimeout(b.curInterval)}},invalidateElementVisibility:function(){this._invalidateElementVisibility||(this._invalidateElementVisibility=!0,this.invalidate())},repaintTopCanvas:function(){this._repaintTopFlag||(this._repaintTopFlag=!0,this.invalidate())},invalidateCanvasSize:function(a){this._invalidateCanvasSizeFlag||(this._invalidateCanvasSizeFlag=!0,this.invalidate())},validateCanvasSize:function(){0!=this._invalidateCanvasSizeFlag&&(this._invalidateCanvasSizeFlag=!1,this._validateCanvasSize())},_validateCanvasSize:function(){if(!this.isMovingElement()){if(0==this.isAutoValidateCanvasSize())return this.realWidth=0,this.realHeight=0,void(this._unionBounds={x:0,y:0,width:0,height:0});var a=this.getElementBox().getDatas(),b=a.size();if(b>0){for(var c={x:0,y:0,width:0,height:0},d=0;b>d;d++){var e=a.get(d);if(this._visibleMap[e._id]){var f=this._elementUIMap[e._id];f&&(c=Tb.unionRect(c,f._viewRect))}}var g=this.getBackgroundImage();if(g&&(c=Tb.unionRect(c,g._viewRect)),c.x<0&&(c.width+=c.x,c.x=0),c.y<0&&(c.height+=c.y,c.y=0),this.realWidth==(c.x+c.width)*this.getZoom()&&this.realHeight==(c.y+c.height)*this.getZoom())return;var h=this.getZoom();this.realWidth=(c.x+c.width)*h+this._paddingRight,this.realHeight=(c.y+c.height)*h+this._paddingBottom,this._unionBounds={x:c.x*h,y:c.y*h,width:c.width*h+this._paddingRight,height:c.height*h+this._paddingRight}}else this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0};this.setViewRect(this.viewRect.x,this.viewRect.y,this.viewRect.width,this.viewRect.height),this.firePropertyChange("canvasSizeChange",null,this.viewRect)}},getElementUI:function(a){return null==a?null:this._elementUIMap[a._id]},createElementUI:function(a){var b=this._elementUIMap[a.getId()];b||(b=this._elementUIFunction(this,a),b&&(this._elementUIMap[a.getId()]=b))},getElementUIFunction:function(){return this._elementUIFunction},setElementUIFunction:function(a){if(!a)throw"ElementUIFunction can not be null";if(this._elementUIFunction!==a){var b=this._elementUIFunction;this._elementUIFunction=a,this.firePropertyChange("elementUIFunction",b,a),this._box.isEmpty()||(this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize())}},invalidateElementUI:function(a,b){var c=this.getElementUI(a);c&&c.invalidate(b)},invalidateElementUIs:function(a){for(var b in this._elementUIMap){var c=this._elementUIMap[b];c.invalidate(a)}},invalidateSelectedElementUIs:function(a){this.getSelectionContainer().getSelection().forEach(function(b){this.invalidateElementUI(b,a)},this)},invalidateBundleLink:function(a){if(a instanceof Ib.Link&&a._bundleLinks){var b=this._elementUIMap;a._bundleLinks.forEachSiblingLink(function(c){if(c!==a){var d=b[c._id];d&&d.invalidate(!1)}},this)}},paintRoot:function(){var a=this._rootCanvas.getContext("2d");if(a.clearRect(0,0,this._rootCanvas.width,this._rootCanvas.height),this.visibleList=new Ib.List,this._topAttachmentList=new Ib.List,null!=this.getElementBox()){ld.draw(a,this);var c=this.getElementBox().getDatas()._as,d=c.length;a.save(),a.scale(this.getZoom(),this.getZoom()),a.translate(-this.viewRect.x/this.getZoom(),-this.viewRect.y/this.getZoom()),this.paintBottom(a);var e={x:this.viewRect.x/this.getZoom(),y:this.viewRect.y/this.getZoom(),width:this.viewRect.width/this.getZoom(),height:this.viewRect.height/this.getZoom()},f=this.getBackgroundImage(),g=this.getBackgroundImageRect();if(f instanceof Pb&&(g?a.drawImage(f,g.x,g.y,g.width,g.height):a.drawImage(f,0,0,f.width,f.height),f._viewRect={x:0,y:0,width:f.width,height:f.height}),"string"==typeof f){var h=Jb.getImageAsset(f),i={x:0,y:0,width:h.getWidth(),height:h.getHeight()};Nc(a,f,null,i,null,this)}var j,k,l,m,n=this._box._layerBox;if(1===n.size())for(j=0;d>j;j++)k=c[j],this._visibleMap[k._id]&&(l=this._elementUIMap[k._id],null!=l&&this._isInView(l,e)?(l.paint(a),l.setAttachmentVisible&&l.setAttachmentVisible(!0),this.visibleList.add(k)):l.setAttachmentVisible&&l.setAttachmentVisible(!1));else n.forEachByDepthFirst(function(b){for(j=0;d>j;j++)k=c[j],n.getLayerByElement(k)===b&&this._visibleMap[k._id]&&(l=this._elementUIMap[k._id],null!=l&&this._isInView(l,e)?(l.paint(a),l.setAttachmentVisible&&l.setAttachmentVisible(!0),this.visibleList.add(k)):l.setAttachmentVisible&&l.setAttachmentVisible(!1))},null,this);for(d=this._topAttachmentList.size(),j=0;d>j;j++)m=this._topAttachmentList.get(j),m.getElementUI().paintAttachment(a,m);if(this._xyz){var d,o=this._xyz,p=o.markText,q=o.type,r=(o.expired,o.innerHTML),s=0,t=0,u=this.viewRect;a.translate(this.viewRect.x/this.getZoom(),this.viewRect.y/this.getZoom()),a.scale(1/this.getZoom(),1/this.getZoom());{this.getZoom()}p!=b&&null!=p&&""!=p||"2"==q?(a.font="15px Arial sans-serif",d=Jb.g.getTextSize(a.font,r),a.fillStyle="red",s=u.width-d.width,t=u.height-20):(a.font="10px Arial sans-serif",d=Jb.g.getTextSize(a.font,r),s=u.width/2-d.width/2,t=u.height/2),a.fillText(r,s,t)}a.restore()}},paintBottom:function(a){},_isInView:function(a,b){return Tb.intersects(b,a._viewRect)},paintTopCanvas:function(){var a=this._topCanvas.getContext("2d");a.clearRect(0,0,this._topCanvas.width,this._topCanvas.height),this.paintMarker(a)},paintMarker:function(a){for(var b=this.markerList.size(),c=0;b>c;c++){var d=this.markerList.get(c);d.paint(a)}},getLayerByElement:function(a){return this._box.getLayerBox().getLayerByElement(a)},getLogicalPoint:function(a){var b;if(Qb.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var c=this._view.getBoundingClientRect(),d=a.changedTouches[0],e=Qb.isAndroid?0:zc.scrollLeft(),f=Qb.isAndroid?0:zc.scrollTop();return b={x:(d.clientX+this.viewRect.x-c.left-e)/this._zoom,y:(d.clientY+this.viewRect.y-c.top-f)/this._zoom}}return b=Qb.isFirefox?{x:(a.layerX+this.viewRect.x)/this.getZoom(),y:(a.layerY+this.viewRect.y)/this.getZoom()}:{x:(a.offsetX+this.viewRect.x)/this.getZoom(),y:(a.offsetY+this.viewRect.y)/this.getZoom()}},getElementAt:function(a,b){if(null==this.visibleList)return null;1===arguments.length&&(b=!0);var c,d;if(a.target?c=this.getLogicalPoint(a):a.event?a.event.target&&(c=this.getLogicalPoint(a.event)):c=a,null!=this._topAttachmentList)for(var e=this._topAttachmentList.size(),f=e-1;f>=0;f--){var g=this._topAttachmentList.get(f);if(d=g.getElement(),(!b||this.isSelectable(d))&&g.hit(c.x,c.y))return d}if(null!=this.visibleList)for(var h=this.visibleList.size(),i=h-1;i>=0;i--){var j=this.visibleList.get(i),k=this.getElementUI(j);if((!b||this.isSelectable(j))&&k&&k.hit(c.x,c.y))return j}return null},hitTest:function(a){var b=this.getElementAt(a);if(!b)return null;var c=this.getElementUI(b);if(!c)return null;var d;return d=a.target?this.getLogicalPoint(a):a,c.hitTest(d.x,d.y)},getElementsAtRect:function(a,c,d,e){var f=new Ib.List;if(null==this.visibleList)return f;e=e===b?!0:e;for(var g=this.visibleList.size(),h=g-1;h>=0;h--){var i=this.visibleList.get(h),j=this.getElementUI(i);j&&(!d||d(j._element))&&(e&&this.isSelectable(j._element)||!e)&&(c?j.intersects(a)&&f.add(i):Tb.contains(a,j.getViewRect())&&f.add(i))}return f},getPosition:function(a,b,c,d,e){var f,g=b instanceof Ib.canvas.ElementUI?b:this.getElementUI(b);if(g)if("from"===a||"to"===a){if(g.getFromPosition&&(f="from"===a?g.getFromPosition(d,e):g.getToPosition(d,e)))return c?{x:f.x-c.width/2,y:f.y-c.height/2}:f}else f="hotspot"===a?g.getHotSpot():Vb.get(a,g.getBodyRect(),c);if(!f&&b.getRect&&(f=Vb.get(a,b.getRect(),c)),f)return{x:f.x+d,y:f.y+e};throw"position '"+a+"' object '"+b+"'"},isValidEvent:function(a){if(!a)return!1;var b,c;if(a.currentTarget===this._view){if(Qb.isFirefox?(b=a.layerX,c=a.layerY):(b=a.offsetX,c=a.offsetY),1==this.isHScrollBarVisible()&&c>=this.viewRect.height-this.getScrollBarWidth())return!1;if(1==this.isVScrollBarVisible()&&b>=this.viewRect.width-this.getScrollBarWidth())return!1;

}return!0},addMarker:function(a){this.markerList.add(a),this.repaintTopCanvas()},removeMarker:function(a){this.markerList.remove(a),this.repaintTopCanvas()},clearMarker:function(){this.markerList.clear(),this.repaintTopCanvas()},isMovable:function(a){return this._box.contains(a)?a instanceof Ib.Link?!1:this._movableFunction&&!this._movableFunction(a)?!1:this.getLayerByElement(a).isMovable():!1},hasMovableSelectedElements:function(){for(var a=this.getSelectionContainer().getSelection(),b=0;b<a.size();b++){var c=a.get(b);if(this.isMovable(c))return!0}return!1},getMovableSelectedElements:function(){return this.getSelectionContainer().toSelection(function(a){return this.isMovable(a)},this)},moveSelectedElements:function(a,b,c,d){if(0!==a||0!==b){var e=this.getMovableSelectedElementsRect();null!=e&&(this._limitElementInPositiveLocation&&(e.x+a<0&&(a=-e.x),e.y+b<0&&(b=-e.y)),Ib.Util.moveElements(this.getMovableSelectedElements(),a,b,c,d,this))}},getMovableSelectedElementsRect:function(){var a=this.getMovableSelectedElements();if(0===a.size())return null;for(var b=null,c=0,d=a.size();d>c;c++){var e=a.get(c);if(e instanceof Jd){var f=this.getElementUI(e);f&&(b=Tb.unionRect(b,f.getViewRect()))}}return b},isVisible:function(a,b,c){if(!this._box.contains(a))return!1;if(!a.isVisible())return!1;if(3!==arguments.length&&(b=this._visibleFunction),b&&!b(a))return!1;if(!(c||this._box._layerBox.getLayerByElement(a))._visible)return!1;if(vc.getSubGl3dview(a)!==this._currentSubGl3dview)return!1;if(a instanceof Ib.Link){if(!this._noAgentLinkVisible){if(!a._fromAgent||!a._toAgent)return!1;if(!this.isVisible(a._fromAgent,b,c)||!this.isVisible(a._toAgent,b,c))return!1}if(a.getBundleIndex()>0&&a.getBundleCount()>1&&!a.getStyle("link.bundle.expanded"))return!1}else for(var d=a._parent;d&&!d.ISubGl3dview;){if(d instanceof Ib.Group&&(!d.isExpanded()||!this.isVisible(d,b,c)))return!1;d=d._parent}return a.IDummy?!1:!0},getVisibleFunction:function(){return this._visibleFunction},setVisibleFunction:function(a){var b=this._visibleFunction;this._visibleFunction=a,this.firePropertyChange("visibleFunction",b,a),this.invalidateElementVisibility()},isEditable:function(a){return this._box.contains(a)?this._editableFunction&&!this._editableFunction(a)?!1:this.getLayerByElement(a).isEditable():!1},getEditableFunction:function(){return this._editableFunction},setEditableFunction:function(a){var b=this._editableFunction;this._editableFunction=a,this.firePropertyChange("editableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isRotatable:function(a){return this._rotatableFunction&&!this._rotatableFunction(a)?!1:!0},getRotatableFunction:function(){return this._rotatableFunction},setRotatableFunction:function(a){var b=this._rotatableFunction;this._rotatableFunction=a,this.firePropertyChange("rotatableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isLinkable:function(a){return null==this._linkableFunction||this._linkableFunction(a)},getLinkableFunction:function(){return this._linkableFunction},setLinkableFunction:function(a){var b=this._linkableFunction;this._linkableFunction=a,this.firePropertyChange("linkableFunction",b,a),this.invalidateSelectedElementUIs(!0)},onShareSelectionContainerChanged:function(){this.invalidateElementUIs()},getShadowColor:function(a){var b=a.getStyle("shadow.color");return!b&&this.isSelected(a)&&"shadow"===a.getStyle("select.style")?a.getStyle("select.color"):b},getSelectColor:function(a){return a.getStyle("select.color")},getAlarmLabel:function(a){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b){var c=a.getAlarmState().getNewAlarmCount(b)+b.nickName;return a.getAlarmState().hasLessSevereNewAlarms()&&(c+="+"),c}return null},getLinkHandlerLabel:function(a){return a.isBundleAgent()?"+("+a.getBundleCount()+")":null},setInteractions:function(a){var b=this._interactions;b&&b.forEach(function(a){a.tearDown()}),this._interactions=a,a&&a.forEach(function(a){a.setUp()}),this.invalidateSelectedElementUIs(!0),this.firePropertyChange("interactions",b,a)},getInteractions:function(){return this._interactions},setDefaultInteractions:function(a){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.SelectInteraction(this),new Ib.canvas.interaction.MoveInteraction(this,a),new Ib.canvas.interaction.ScrollInteraction(this)])},setTouchInteractions:function(){this.setInteractions([new Ib.canvas.interaction.TouchInteraction(this)])},setMSTouchInteractions:function(){this.setInteractions([new Ib.canvas.interaction.ScrollInteraction(this),new Ib.canvas.interaction.MSTouchInteraction(this)])},setEditInteractions:function(a){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.SelectInteraction(this),new Ib.canvas.interaction.EditInteraction(this,a),new Ib.canvas.interaction.MoveInteraction(this,a),new Ib.canvas.interaction.ScrollInteraction(this)])},setCreateElementInteractions:function(a){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.CreateElementInteraction(this,a)])},setCreateLinkInteractions:function(a){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.CreateLinkInteraction(this,a),new Ib.canvas.interaction.ScrollInteraction(this)])},setCreateShapeLinkInteractions:function(a){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.CreateShapeLinkInteraction(this,a),new Ib.canvas.interaction.ScrollInteraction(this)])},setCreateShapeNodeInteractions:function(a){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.CreateShapeNodeInteraction(this,a),new Ib.canvas.interaction.ScrollInteraction(this)])},setPanInteractions:function(){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.PanInteraction(this),new Ib.canvas.interaction.ScrollInteraction(this)])},setMagnifyInteractions:function(){this.setInteractions([new Ib.canvas.interaction.DefaultInteraction(this),new Ib.canvas.interaction.SelectInteraction(this),new Ib.canvas.interaction.MoveInteraction(this),new Ib.canvas.interaction.ScrollInteraction(this),new Ib.canvas.interaction.MagnifyInteraction(this)])},hasEditInteraction:function(){return this._hasEditInteraction},setHasEditInteraction:function(a){var b=this._hasEditInteraction;this._hasEditInteraction=a,this.firePropertyChange("hasEditInteraction",b,a)},addElementByInteraction:function(a){a.getParent()||a.setParent(this._currentSubGl3dview),this._box.add(a),this.getSelectionContainer().setSelection(a),this.fireInteractionEvent({kind:"createElement",element:a})},getToolTip:function(a){if(a){var b=a.getToolTip();return b?b:a.getName()}return null},isToolTipEnabled:function(){return this._toolTipEnabled?!0:!1},setToolTipEnabled:function(a){if(this._toolTipEnabled=a,a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){if(b.isMovingElement())return void Bc.hideToolTip();var c=b.getElementAt(a);if(b._preElement!==c)if(b._preElement=c,c){var d=b.getToolTip(c);Bc.showToolTip({x:a.pageX,y:a.pageY},d);var e=Bc.getToolTipDiv(),e=Bc.getToolTipDiv();if(e.children.length>0){var f=b._view.getBoundingClientRect(),g=e.getBoundingClientRect();g.width+g.left>f.width+f.left&&(e.style.left=f.width+f.left-g.width+(Ob.documentElement.scrollLeft||Ob.body.scrollLeft)+"px"),g.height+g.top>f.height+f.top&&(e.style.top=f.height+f.top-g.height+(Ob.documentElement.scrollTop||Ob.body.scrollTop)+"px")}}else Bc.hideToolTip()},this._view.addEventListener("mousemove",this._toolTipListener,!1),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Bc.hideToolTip(),this._view.removeEventListener("mousemove",this._toolTipListener,!1),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},setZoom:function(a){a=this.checkZoom(a);var b=this._zoom;if(this._zoom!=a){var c={x:(this.viewRect.x+this.viewRect.width/2)/this.getZoom()*a,y:(this.viewRect.y+this.viewRect.height/2)/this.getZoom()*a};this._zoom=a,this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.validateCanvasSize(),this.setViewRect(c.x-this.viewRect.width/2,c.y-this.viewRect.height/2,this.viewRect.width,this.viewRect.height),this.firePropertyChange("zoom",b,this._zoom)}},getZoom:function(){return this._zoom},setTouchZoom:function(a){this.setZoom(a,!1)},zoomOverview:function(a){if(!(this.realWidth<=0||this.realHeight<=0)){var b=this.realWidth/this.getZoom(),c=this.realHeight/this.getZoom(),d=this.viewRect.width/b,e=this.viewRect.height/c,f=Math.min(d,e);this.setZoom(f)}},zoomReset:function(){this.setZoom(1)},zoomIn:function(){this.setZoom(1.2*this.getZoom())},zoomOut:function(){this.setZoom(this.getZoom()/1.2)},upSubGl3dview:function(a,b){this._currentSubGl3dview&&this.setCurrentSubGl3dview(vc.getSubGl3dview(this._currentSubGl3dview),a,b)},getCurrentSubGl3dview:function(){return this._currentSubGl3dview},setCurrentSubGl3dview:function(a,b,c){if(Ib.animate.AnimateManager.endAnimate(),b){if(this._currentSubGl3dview===a)return;if(a&&!this._box.contains(a))throw a+" is not contained in this gl3dview's elementBox";var d=new Ib.animate.AnimateSubGl3dview(this,a,c);Ib.animate.AnimateManager.start(d)}else this._setCurrentSubGl3dview(a),c&&c()},_setCurrentSubGl3dview:function(a){if(this._currentSubGl3dview!==a){if(a&&!this._box.contains(a))throw a+" is not contained in this gl3dview's elementBox";var b=this._currentSubGl3dview;this._currentSubGl3dview=a,this.firePropertyChange("currentSubGl3dview",b,a),this.invalidateElementVisibility(),this.invalidateCanvasSize()}},makeVisible:function(a){var b=this.getElementUI(a);if(b){var c=vc.getSubGl3dview(a);if(c!==this._currentSubGl3dview){var d=this;return void this.setCurrentSubGl3dview(c,this.isSubGl3dviewAnimate(),function(){Jb.callLater(d.makeVisible,d,[a])})}for(var e=a;(e=e.getParent())&&e!==c;)e instanceof Ib.Group&&e.setExpanded(!0);var f=b.getViewRect();if(f){var g={x:f.x*this.getZoom(),y:f.y*this.getZoom(),width:f.width*this.getZoom(),height:f.height*this.getZoom()};Tb.intersects(this.viewRect,g)||this.isVisible(a)&&Jb.callLater(this.centerByLogicalPoint,this,[g.x+g.width/2,g.y+g.height/2])}}},centerByLogicalPoint:function(a,b,c){var d=a-this.viewRect.width/2,e=b-this.viewRect.height/2;this.setViewRect(d,e,this.viewRect.width,this.viewRect.height)},panByOffset:function(a,b){this.setViewOffSet(a,b)},getIconsNames:function(a){return a.getStyle("icons.names")},getIconsColors:function(a){return a.getStyle("icons.colors")},getLinkFlowStepping:function(a){var b=parseInt(a.getStyle("link.flow.stepping"));return b||(b=Cd.NETWORK_LINK_FLOW_STEPPING),b},getLinkFlowOffset:function(a){var b=a.getStyle("link.flow.offset");return isNaN(b)&&(b=0),b+this.getLinkFlowStepping(a)},toCanvas:function(a,b,c){c||(c=Wb.createCanvas()),c.setAttribute("width",a),c.setAttribute("height",b),c._viewRect?(c._viewRect.width=a,c._viewRect.height=b):c._viewRect={x:0,y:0,width:a,height:b};var d=c.getContext("2d");if(d.clearRect(0,0,a,b),ld.draw(d,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;var e=a/this.realWidth*this._zoom,f=b/this.realHeight*this._zoom;d.scale(e,f);var g=this.getBackgroundImage();if(g&&g._viewRect){var h=g._viewRect;try{d.drawImage(g,h.x,h.y,h.width,h.height)}catch(i){}}var j=this.getElementBox().getDatas()._as,k=j.length;this._topAttachmentList=new Ib.List;var l,m,n,o,p,q,r=this.getElementBox().getLayerBox(),s=r.getRoots(),t=s.size();if(1===t)for(n=0;k>n;n++)o=j[n],this._visibleMap[o._id]&&(p=this._elementUIMap[o._id],null!=p&&p.paint(d));else for(l=0;t>l;l++)for(m=s.get(l),n=0;k>n;n++)o=j[n],r.getLayerByElement(o)===m&&this._visibleMap[o._id]&&(p=this._elementUIMap[o._id],null!=p&&p.paint(d));for(k=this._topAttachmentList.size(),n=0;k>n;n++)q=this._topAttachmentList.get(n),q.getElementUI().paintAttachment(d,q);return c},toCanvasByRegion:function(a,b,c){c||(c=Wb.createCanvas());var d=a.width*b,e=a.height*b;c.setAttribute("width",d),c.setAttribute("height",e),c._viewRect?(c._viewRect.width=d,c._viewRect.height=e):c._viewRect={x:0,y:0,width:d,height:e};var f=c.getContext("2d");if(f.clearRect(0,0,d,e),ld.draw(f,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;f.save(),f.scale(b,b),f.beginPath(),f.translate(-a.x,-a.y);var g=this.getElementBox().getDatas()._as,h=g.length;this._topAttachmentList=new Ib.List;var i=this.getBackgroundImage();if(i&&i._viewRect&&Tb.intersects(a,i._viewRect)){var a=Tb.intersection(a,i._viewRect),j=i._viewRect;try{f.drawImage(i,j.x,j.y,j.width,j.height)}catch(k){}}var l,m,n,o,p,q,r=this.getElementBox().getLayerBox(),s=r.getRoots(),t=s.size();if(1===t)for(n=0;h>n;n++)o=g[n],this._visibleMap[o._id]&&(p=this._elementUIMap[o._id],null!=p&&Tb.intersects(a,p._viewRect)&&p.paint(f));else for(l=0;t>l;l++)for(m=s.get(l),n=0;h>n;n++)o=g[n],r.getLayerByElement(o)===m&&this._visibleMap[o._id]&&(p=this._elementUIMap[o._id],null!=p&&Tb.intersects(a,p._viewRect)&&p.paint(f));for(h=this._topAttachmentList.size(),n=0;h>n;n++)q=this._topAttachmentList.get(n),q.getElementUI().paintAttachment(f,q);return f.restore(),c},getGroupChildrenRects:function(a){var b=new md;return a.getChildren().forEach(function(a){if(a instanceof Jd){var c=this.getElementUI(a);if(c){var d=c.getViewRect();d&&b.add(d)}}},this),b},getBackgroundImageRect:function(){return null},getLinkPathFunction:function(){return this._linkPathFunction},setLinkPathFunction:function(a){var b=this._linkPathFunction;this._linkPathFunction=a,this.firePropertyChange("linkPathFunction",b,a),this.invalidateElementUIs()},onClickElement:function(a,b){},onClickBackground:function(a){},onDoubleClickElement:function(a,b){},onDoubleClickBackground:function(a){},onLongClickElement:function(a,b){},onLongClickBackground:function(a){},onMouseMove:function(a,b){},onMouseEnter:function(a,b){},onMouseLeave:function(a,b){}}),Ib.canvas.Overview=function(a){Ib.canvas.Overview.superClass.constructor.apply(this,a),this._view=Wb.createView(),this._rootDiv=Wb.createDiv(),this._imageCanvas=Wb.createCanvas(),this._imageDiv=Wb.createDiv(),this._maskCanvas=Wb.createCanvas(),this._selectDiv=Wb.createDiv(),this._isGl3dviewDirty=!1,this._isMaskDirty=!1,Wb.setVisible(this._selectDiv,!1),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._imageDiv),this._rootDiv.appendChild(this._maskCanvas),this._rootDiv.appendChild(this._selectDiv),this._imageDiv.appendChild(this._imageCanvas),this.setGl3dview(a);var b;b=Qb.isMSToucheable?Ib.canvas.OverviewMSTouchInteraction:Qb.isTouchable?Ib.canvas.OverviewTouchInteraction:Ib.canvas.OverviewInteraction,b&&new b(this)},Jb.ext("twaver.canvas.Overview",Ib.controls.ControlBase,{__accessor:["fillColor","outlineColor","outlineWidth","selectColor","selectWidth","padding","maxPackingWidth","maxPackingHeight"],__bool:["animate"],_fillColor:Cd.OVERVIEW_FILL_COLOR,_outlineColor:Cd.OVERVIEW_OUTLINE_COLOR,_outlineWidth:Cd.OVERVIEW_OUTLINE_WIDTH,_selectColor:Cd.OVERVIEW_SELECT_COLOR,_selectWidth:Cd.OVERVIEW_SELECT_WIDTH,_padding:Cd.OVERVIEW_PADDING,_animate:Cd.OVERVIEW_ANIMATE,_maxPackingWidth:Cd.OVERVIEW_MAX_PACKING_WIDTH,_maxPackingHeight:Cd.OVERVIEW_MAX_PACKING_HEIGHT,getGl3dview:function(){return this._gl3dview},onPropertyChanged:function(a){this._invalidateMask()},setGl3dview:function(a){a!==this._gl3dview&&(this._gl3dview&&(this._gl3dview.removePropertyChangeListener(this._handleGl3dviewPropertyChange,this),this._gl3dview.removeViewListener(this._handleGl3dviewViewChange,this),Wb.removeEventListener("scroll","_handleScrollChange",this._gl3dview.getView(),this)),this._gl3dview=a,this._gl3dview&&(this._gl3dview.addPropertyChangeListener(this._handleGl3dviewPropertyChange,this),this._gl3dview.addViewListener(this._handleGl3dviewViewChange,this),Wb.addEventListener("scroll","_handleScrollChange",this._gl3dview.getView(),this)),this.invalidate())},_handleGl3dviewPropertyChange:function(a){("zoom"===a.property||"currentSubGl3dview"===a.property||"elementBox"===a.property||"dataBox"===a.property||"canvasSizeChange"===a.property)&&this.invalidate()},_handleGl3dviewViewChange:function(a){"validateEnd"===a.kind&&this.invalidate()},_handleScrollChange:function(){this._invalidateMask()},invalidate:function(a){this._isGl3dviewDirty&&this._isMaskDirty||(this._isGl3dviewDirty||(this._isGl3dviewDirty=!0),this._isMaskDirty||(this._isMaskDirty=!0),Jb.callLater(this.validate,this,null,a))},_invalidateMask:function(){this._isMaskDirty||(this._isMaskDirty=!0,Jb.callLater(this.validate,this,[],100))},validate:function(){if((this._isMaskDirty||this._isGl3dviewDirty)&&this._gl3dview&&(this._maxPackingWidth>0&&this._maxPackingHeight>0||this._view.clientWidth>0&&this._view.clientHeight>0)&&0!==this._gl3dview.getViewRect().width&&0!==this._gl3dview.getViewRect().height&&!this._gl3dview._invalidate){var a,b=this._maxPackingWidth>0&&this._maxPackingHeight>0;a=b?{x:0,y:0,width:this._maxPackingWidth,height:this._maxPackingHeight}:{x:0,y:0,width:this._view.clientWidth,height:this._view.clientHeight},Tb.grow(a,-this._padding,-this._padding);var c=Math.min(a.width/this._gl3dview.getCanvasSize().width,a.height/this._gl3dview.getCanvasSize().height);b&&(Wb.setDiv(this._view,{x:0,y:0,width:this._imageDiv._viewRect.width,height:this._imageDiv._viewRect.height},null,0,null),a.width=this._imageDiv._viewRect.width,a.height=this._imageDiv._viewRect.height);var d=this._gl3dview.getCanvasSize().width*c,e=this._gl3dview.getCanvasSize().height*c,f=a.x+(a.width-d)/2,g=a.y+(a.height-e)/2;if(this._isGl3dviewDirty){var h={x:f,y:g,width:d,height:e};this._gl3dview.toCanvas(h.width,h.height,this._imageCanvas),Wb.setDiv(this._imageDiv,h,null,0,null),this._gl3dview.getElementBox&&(this._imageDiv.style.backgroundColor=(this._gl3dview.getCurrentSubGl3dview()||this._gl3dview.getElementBox()).getStyle("background.color")||""),this._isGl3dviewDirty=!1}if(this._isMaskDirty){var i={x:this._gl3dview.getViewRect().x*c,y:this._gl3dview.getViewRect().y*c,width:d*this._gl3dview._view.clientWidth/this._gl3dview.getCanvasSize().width,height:e*this._gl3dview._view.clientHeight/this._gl3dview.getCanvasSize().height};i.x=i.x<0?0:i.x,i.y=i.y<0?0:i.y;var j=Wb.setCanvas(this._maskCanvas,f,g,d,e);j.lineWidth=0,j.fillStyle=this._fillColor,j.beginPath(),Xb.drawVector(j,"rectangle",null,f,g,d,e),j.fill(),j.clearRect(f+i.x,g+i.y,i.width,i.height);var k=this._outlineWidth<0?0:this._outlineWidth;j.lineWidth=k,j.strokeStyle=this._outlineColor;var l=i.width-2*k,m=i.height-2*k;l=Math.min(l,d-2-i.x-this._outlineWidth),m=Math.min(m,e-2-i.y-this._outlineWidth),j.beginPath(),Xb.drawVector(j,"rectangle",null,f+i.x+k,g+i.y+k,l,m),k>=0&&j.stroke(),this._isMaskDirty=!1}}else this._isGl3dviewDirty=!1,this._isMaskDirty=!1},getLogicalPoint:function(a){return Wb.getLogicalPoint(this._view,a,1,this._rootDiv)},centerGl3dview:function(a,b){var c=this._imageDiv._viewRect;Tb.containsPoint(c,a)&&(this._gl3dview.centerByLogicalPoint((a.x-c.x)/c.width*this._gl3dview.getCanvasSize().width,(a.y-c.y)/c.height*this._gl3dview.getCanvasSize().height,b),this._invalidateMask())}}),Ib.canvas.OverviewTouchInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.canvas.OverviewTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),this.clear(),this.endPoint=this.overview.getLogicalPoint(a),zc.isMultiTouch(a)&&(this.distance=zc.getDistance(a),this.zoom=this.gl3dview.getZoom()),Wb.addEventListener("touchmove","handleTouchmove",this.view,this),Wb.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(this.moved||(this.moved=!0),this.endPoint=this.overview.getLogicalPoint(a),zc.isSingleTouch(a))this.overview.centerGl3dview(this.endPoint,!1);else if(this.distance){var b=zc.getDistance(a)/this.distance;this.gl3dview.setZoom(this.zoom*b,!1)}},handleTouchend:function(a){if(!this.moved){this.endPoint=this.overview.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date),b?Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]):this.overview.centerGl3dview(this.endPoint,this.overview._animate)}this.clear()},clear:function(){this.endPoint&&(this.endPoint=null,Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this)),this.moved=!1}}),Ib.canvas.OverviewMSTouchInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,this._pointerMap={},this._pointerIdArray=[];var b=this;this.view.addEventListener("MSPointerDown",function(a){b.handleTouchstart(a)},!1),this.view.addEventListener("MSPointerMove",function(a){b.handleTouchmove(a)},!1),this.view.addEventListener("MSPointerUp",function(a){b.handleTouchend(a)},!1),this.view.addEventListener("MSPointerCancel",function(a){b.handleTouchend(a)},!1)},Jb.ext("twaver.canvas.OverviewMSTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&this.overview.getLogicalPoint(a)&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length?(this._startTouchPoint=this.overview.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.gl3dview.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.gl3dview.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&this._startTouchPoint){var c=this.overview.getLogicalPoint(a);if(null==c)return;this._startTouchPoint=c,this.overview.centerGl3dview(this._startTouchPoint,!1)}},handleTouchend:function(a){var b=this.overview.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b){var c=this._endTouchPoint&&this._endTouchTime&&(new Date).getTime()-this._endTouchTime.getTime()<=500&&Tb.getDistance(this._endTouchPoint,b)<=10;c?(this._endTouchPoint=null,this._endTouchTime=null):(this._endTouchPoint=b,this._endTouchTime=new Date),c?Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]):this.overview.centerGl3dview(this._endTouchPoint,this.overview._animate)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Ib.canvas.OverviewInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,Wb.addEventListener("mousedown","handleMousedown",this.view,this)},Jb.ext("twaver.canvas.OverviewInteraction",Object,{handleMousedown:function(a){0===a.button&&(this.clear(),this.endPoint=this.overview.getLogicalPoint(a),Jb.isCtrlDown(a)&&(this.startPoint=this.endPoint,Wb.setVisible(this.overview._selectDiv,!0)),Wb.addEventListener("mousemove","handleMousemove",this.view,this),Wb.addEventListener("mouseup","handleMouseup",this.view,this))},handleMouseup:function(a){if(this.endPoint=this.overview.getLogicalPoint(a),"detail"in a&&2===a.detail)Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]);else if(Wb.isVisible(this.overview._selectDiv)&&this.startPoint){var b=this.overview._imageDiv._viewRect,c=this.overview._selectDiv._viewRect.x,d=this.overview._selectDiv._viewRect.y,e=b.width/this.overview._selectDiv._viewRect.width,f=b.height/this.overview._selectDiv._viewRect.height,g=Math.min(e,f);this.gl3dview.setZoom(g*Math.min(this.gl3dview.getViewRect().width/this.gl3dview.getCanvasSize().width,this.gl3dview.getViewRect().height/this.gl3dview.getCanvasSize().height)*this.gl3dview.getZoom(),!1);var h=this.gl3dview.getCanvasSize().width*((c-b.x+this.overview._selectDiv._viewRect.width/2)/b.width),i=this.gl3dview.getCanvasSize().height*((d-b.y+this.overview._selectDiv._viewRect.height/2)/b.height);Jb.callLater(this.gl3dview.centerByLogicalPoint,this.gl3dview,[h,i,this.overview._animate]),Wb.setVisible(this.overview._selectDiv,!1),Wb.setDiv(this.overview._selectDiv,{x:0,y:0,width:0,height:0},null,0,null),this.startPoint=null}else this.overview.centerGl3dview(this.endPoint,this.overview._animate);this.clear()},handleMousemove:function(a){var b=this.overview.getLogicalPoint(a);if(this.endPoint=b,Wb.isVisible(this.overview._selectDiv)&&this.startPoint){var c=b.x>this.startPoint.x?this.startPoint.x:b.x,d=b.x>this.startPoint.x?this.startPoint.y:b.y;b.x>this.startPoint.x&&b.y<this.startPoint.y&&(d=b.y),b.x<this.startPoint.x&&b.y>this.startPoint.y&&(d=this.startPoint.y);var e=this.overview._imageDiv._viewRect;c<e.x&&(c=e.x),c>e.x+e.width&&(c=e.x+e.width),d<e.y&&(d=e.y),d>e.y+e.height&&(d=e.y+e.height);var f=Math.abs(b.x-this.startPoint.x),g=Math.abs(b.y-this.startPoint.y);c+f>e.x+e.width&&(f=e.x+e.width-c),d+g>e.y+e.height&&(g=e.y+e.height-d),Wb.setDiv(this.overview._selectDiv,{x:c,y:d,width:f,height:g},null,this.overview._selectWidth,this.overview._selectColor)}else this.overview.centerGl3dview(b,!1)},clear:function(){this.endPoint&&(this.endPoint=null,Wb.removeEventListener("mousemove",this.view,this),Wb.removeEventListener("mouseup",this.view,this))}}),Ib.canvas.ElementUI=function(a,b){this._gl3dview=a,this._element=b,this._attachments=new Ib.List,this._bodyBounds=new Ib.List,this._hitTest=!1,this._hitTest=!1,this._intersectTest=!1,this.invalidate(!0)},Jb.ext("twaver.canvas.ElementUI",Object,{getElement:function(){return this._element},getGl3dview:function(){return this._gl3dview},handlePropertyChange:function(a){this.invalidate(!0)},handleSelectionChange:function(a){this.invalidate(!0)},invalidate:function(a){a===b&&(a=!0),a&&(this._invalidateAttachmentsFlag=!0),this._invalidateFlag||(this._hotSpot=null,this._bodyRect=null,this._invalidateFlag=!0,this._gl3dview.invalidateElementVisibility())},updateStyle:function(){this._innerColor=this._gl3dview.getInnerColor(this._element),this._outerColor=this._gl3dview.getOuterColor(this._element),this._shadowColor=this._gl3dview.getShadowColor(this._element),this._shadowXOffset=this._element.getStyle("shadow.xoffset"),this._shadowYOffset=this._element.getStyle("shadow.yoffset"),this._shadowBlur=this._element.getStyle("shadow.blur"),this._wholeAlpha=this._element.getStyle("whole.alpha")},validate:function(){if(0!=this._invalidateFlag){this._bodyBounds.clear(),this._invalidateAttachmentsFlag&&(this._invalidateAttachmentsFlag=!1,this.checkAttachments()),this._invalidateFlag=!1,this.updateStyle(),this.validateImpl(),this._attachments.forEach(function(a){a.validate()});var a;this._bodyBounds.forEach(function(b){a=Tb.unionRect(a,b)}),this._unionBodyBounds=Jb.clone(a),this._attachments.forEach(function(b){a=Tb.unionRect(a,b.getViewRect())}),this._viewRect=a}},validateImpl:function(){},setShadow:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;return b.shadowOffsetX===this._shadowXOffset&&b.shadowOffsetY===this._shadowYOffset&&b.shadowBlur===this._shadowBlur?b:(c&&(b.shadowOffsetX=this._shadowXOffset,b.shadowOffsetY=this._shadowYOffset,b.shadowBlur=this._shadowBlur,b.shadowColor=this._shadowColor),b)},clearShadow:function(a){(0!=a.shadowOffsetX||0!=a.shadowOffsetY||0!=a.shadowBlur)&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0)},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;return c&&(this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset),Tb.grow(b,this._shadowBlur,this._shadowBlur)),b},isShadowable:function(){return this._shadowColor&&this._gl3dview.isSelected(this._element)&&"shadow"===this._element.getStyle("select.style")?!0:!1},addAttachment:function(a){this._attachments.add(a)},removeAttachment:function(a){this._attachments.remove(a)},getAttachments:function(){return this._attachments},checkAttachments:function(){this.checkLabelAttachment(),this.checkAlarmAttachment(),this.checkIconsAttachment(),this.checkEditAttachment()},checkLabelAttachment:function(){var a=this._gl3dview.getLabel(this._element);null!=a&&""!==a?this._labelAttachment||(this._labelAttachment=new Ib.canvas.LabelAttachment(this,Cd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._gl3dview.getAlarmLabel(this._element);null!=a&&""!==a?this._alarmAttachment||(this._alarmAttachment=new Ib.canvas.AlarmAttachment(this,Cd.SHOW_ALARM_IN_ATTACHMENT_DIV),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},checkIconsAttachment:function(){var a=this._gl3dview.getIconsNames(this._element);a&&a.length>0?this._iconsAttachment||(this._iconsAttachment=new Ib.canvas.IconsAttachment(this),this.addAttachment(this._iconsAttachment)):this._iconsAttachment&&(this.removeAttachment(this._iconsAttachment),this._iconsAttachment=null)},checkEditAttachment:function(){this._gl3dview.hasEditInteraction()&&this._gl3dview.isSelected(this._element)&&this._gl3dview.isEditable(this._element)&&this.isEditable()?this._editAttachment||(this._editAttachment=new Ib.canvas.EditAttachment(this),this.addAttachment(this._editAttachment)):this._editAttachment&&(this.removeAttachment(this._editAttachment),this._editAttachment=null)},getLabelAttachment:function(){return this._labelAttachment},getAlarmAttachment:function(){return this._alarmAttachment},getIconsAttachment:function(){return this._iconsAttachment},getEditAttachment:function(){return this._editAttachment},isEditable:function(){return!0},getInnerColor:function(){return this._innerColor},getOuterColor:function(){return this._outerColor},getShadowColor:function(){return this._shadowColor},getDyeColor:function(a){return this._innerColor?this._innerColor:this.getStyle(a)},getStyle:function(a){return this._element.getStyle(a)},getFont:function(a){var b=this._element.getStyle(a);return b?b:Ib.Defaults.FONT},paint:function(a){a.save(),a.globalAlpha=this._wholeAlpha,a.beginPath(),this.paintBody(a),this.clearShadow(a),a.closePath(),a.beginPath(),this.paintAttachments(a),a.closePath(),a.restore()},paintBody:function(a){},paintAttachments:function(a){a.beginPath();for(var b=this._attachments.size(),c=0;b>c;c++){var d=this._attachments.get(c);1==this._hitTest&&0==d.isShowOnTop()&&this.paintAttachment(a,d),1==this._intersectTest&&this.paintAttachment(a,d),0==this._hitTest&&0==this._intersectTest&&(d.isShowOnTop()?this._gl3dview._topAttachmentList.add(d):this.paintAttachment(a,d))}},paintAttachment:function(a,b){a.beginPath(),b.paint(a),this.clearShadow(a)},getViewRect:function(){return Jb.clone(this._viewRect)},getUnionBodyBounds:function(){return Jb.clone(this._unionBodyBounds)},addBodyBounds:function(a){a&&this._bodyBounds.add(a)},getBodyRect:function(){return this._bodyRect||(this._bodyRect=this.createBodyRect()),Jb.clone(this._bodyRect)},getHotSpot:function(){return this._hotSpot?Jb.clone(this._hotSpot):{x:0,y:0}},setHotSpot:function(a){this._hotSpot=a},hit:function(a,b){return!1},intersects:function(a){return Tb.contains(a,this.getViewRect())?!0:!1},hitCanvasRectAtBody:function(a){var b=Md.getHitCanvas(a.width,a.height),c=Md.getCtx(b);if(c.save(),c.translate(-a.x,-a.y),this._element.getImage){var d=Jb.getImageAsset(this._element.getImage());if(d&&d.getImage()instanceof Fd)return 1;

}this.paintBody(c);try{for(var e=c.getImageData(0,0,a.width,a.height),f=e.data,g=0;g<e.width;g++)for(var h=0;h<e.height;h++){var i=4*(h*e.width+g),j=f[i+3];if(0!==j)return c.restore(),1}}catch(k){if(Md.disposeHitCanvas(),Tb.contains(this.getUnionBodyBounds(),a))return 0}return c.restore(),-1},hitCanvasRectAtAttachments:function(a){var b=Md.getHitCanvas(a.width,a.height),c=Md.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paintAttachments(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),1}}catch(j){Md.disposeHitCanvas()}return c.restore(),-1},hitCanvasRect:function(a){this._intersectTest=!0,1==this._hitTest&&(this._intersectTest=!1);var b=Tb.intersection(a,this._viewRect),c=this.hitCanvasRectAtBody(b);if(1==c)return this._intersectTest=!1,!0;var d=this.hitCanvasRectAtAttachments(b);return 1==d?(this._intersectTest=!1,!0):(this._intersectTest=!1,0==c)},hitCanvasPoint:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();if(d&&d>0&&Tb.grow(c,d,d),!Tb.intersects(this._viewRect,c))return!1;this._hitTest=!0;var e=this.hitCanvasRect(c);return this._hitTest=!1,e},hitTest:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();if(d&&d>0&&Tb.grow(c,d,d),!Tb.intersects(this._viewRect,c))return null;var e=Tb.intersection(c,this._viewRect),f=this.hitCanvasRectAtBody(e);if(1==f)return this;for(var g=this._attachments.size(),h=0;g>h;h++){var i=this._attachments.get(h);if(i.hit(a,b))return i}return 0==f?this:null},dispose:function(){this._attachments.forEach(function(a){a.dispose()}),this._attachments.clear()}}),Ib.canvas.NodeUI=function(a,b){Ib.canvas.NodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.NodeUI",Ib.canvas.ElementUI,{invalidate:function(a){Ib.canvas.NodeUI.superClass.invalidate.call(this,a),this.curInterval&&clearInterval(this.curInterval);var b=this._element.getAgentLinks();b&&b.forEach(function(a){this._gl3dview.invalidateElementUI(a,!1)},this);var c=this._element.getParent();c instanceof Ib.Group&&this._gl3dview.invalidateElementUI(c,!1)},createBodyRect:function(){return this._element.getRect()},validateImpl:function(){Ib.canvas.NodeUI.superClass.validateImpl.call(this);var a=this.getStyle("vector.shape"),b=this.getBodyRect();this._hotSpot=Tb.getHotSpot(b.x,b.y,b.width,b.height,a),this.validateBodyBounds()},validate:function(){0!=this._invalidateFlag&&Ib.canvas.NodeUI.superClass.validate.call(this)},validateBodyBounds:function(){var a=this.getStyle("body.type");"default"===a?this.addBodyBounds(this.getDefaultBodyRect()):"vector"===a?this.addBodyBounds(this.getVectorBody()):"default.vector"===a?(this.addBodyBounds(this.getVectorBody()),this.addBodyBounds(this.getDefaultBodyRect())):"vector.default"===a&&(this.addBodyBounds(this.getDefaultBodyRect()),this.addBodyBounds(this.getVectorBody())),this._outerColor&&this.addBodyBounds(this.getOuterBorderRect()),!this._editAttachment&&"border"===this.getStyle("select.style")&&this._gl3dview.isSelected(this._element)&&this.addBodyBounds(this.getSelectBorderRect())},getDefaultBodyRect:function(){var a=this._element,b=Jb.getImageAsset(a.getImage()),c=this.getBodyRect();if(!b)return c;Tb.addPadding(c,this._element,"image.padding",1),this._defaultRect=c;var d=Jb.clone(c);return this.appendShadowBound(this,d),c=d},getVectorBody:function(){var a=this.getPathRect("vector");return a},getOuterBorderRect:function(){return this._getBorderRect("outer")},getSelectBorderRect:function(){return this._getBorderRect("select")},_getBorderRect:function(a){var b=this._element,c=b.getStyle(a+".width");if(c>0){var d=this.getBodyRect();Tb.addPadding(d,b,a+".padding",1);var e=Jb.clone(d);return Tb.grow(e,c/2,c/2),e}return null},getPathRect:function(a,b){var c=this._element,d=this.getBodyRect();b&&Tb.addPadding(d,c,a+".padding",1);var e=Jb.clone(d),f=c.getStyle(a+".outline.width");return f>0&&Tb.grow(e,f/2,f/2),this.appendShadowBound(this,e),e},paintBody:function(a){this.curInterval&&clearInterval(this.curInterval);var b=this.getStyle("body.type");"default"===b?this.drawDefaultBody(a):"vector"===b?this.drawVectorBody(a):"default.vector"===b?(this.drawVectorBody(a),this.drawDefaultBody(a)):"vector.default"===b&&(this.drawDefaultBody(a),this.drawVectorBody(a)),this._outerColor&&this.drawOuterBorder(a),"border"===this.getStyle("select.style")&&this._gl3dview.isSelected(this._element)&&this.drawSelectBorder(a)},drawOuterBorder:function(a){var b=this._element,c=b.getStyle("outer.width");if(c>0){var d=this.getBodyRect();Tb.addPadding(d,b,"outer.padding",1),a.lineWidth=c,a.lineCap=b.getStyle("outer.cap"),a.lineJoin=b.getStyle("outer.join"),a.strokeStyle=this._outerColor,Xb.drawVector(a,b.getStyle("outer.shape"),null,d),a.stroke()}},drawDefaultBody:function(a){var b=this._element,c=Jb.getImageAsset(b.getImage()),d=this._defaultRect;if(c&&c.getImage()){0!=b.getAngle()&&(a.save(),d=b.getOriginalRect(),Ib.Util.rotateCanvas(a,d,b.getAngle())),this.setShadow(this,a);if(c.getImage()instanceof Fd){var e,f=c.getImage().frames,g=c.getImage().size,h=0;e=Hd(f,g,0),a.drawImage(e,d.x,d.y,d.width,d.height),this.curInterval=setInterval(function(){h=(h+f.length)%f.length,e=Hd(f,g,h),a.drawImage(e,d.x,d.y,d.width,d.height),h++},100)}else Nc(a,b.getImage(),this.getInnerColor(),d,b,this._gl3dview);0!=b.getAngle()&&a.restore()}},drawSelectBorder:function(a){var b=this._element,c=b.getStyle("select.width");if(c>0){var d=this.getBodyRect();Tb.addPadding(d,b,"select.padding",1);var e=Jb.clone(d);Tb.grow(e,c/2,c/2),a.lineWidth=c,a.lineCap=b.getStyle("select.cap"),a.lineJoin=b.getStyle("select.join"),a.strokeStyle=b.getStyle("select.color"),Xb.drawVector(a,b.getStyle("select.shape"),null,d),a.stroke()}},drawVectorBody:function(a){this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("vector.deep"),c=this.getStyle("vector.fill.color"),d=this.getBodyRect();if(0!==b&&c){var e=this._element.getAngle();0!=e&&(a.save(),d=this._element.getOriginalRect(),Ib.Util.rotateCanvas(a,d,e)),"rectangle"===this.getStyle("vector.shape")&&Xb.draw3DRect(a,c,b,d),0!=e&&a.restore()}},drawPath:function(a,b,c,d,e,f,g){var h=this._element,i=this.getBodyRect();c&&Tb.addPadding(i,h,b+".padding",1);var j=h.getStyle(b+".outline.width");this.setShadow(this,a),0!=h.getAngle()&&(h instanceof Ld||(i=h.getOriginalRect()),a.save(),Ib.Util.rotateCanvas(a,i,h.getAngle()));var k,l=h.getStyle(b+".fill");if(l){k=this._innerColor&&!vc.hasDefault(this._element)?this._innerColor:h.getStyle(b+".fill.color");var m=h.getStyle(b+".gradient");m?Xb.fill(a,k,m,h.getStyle(b+".gradient.color"),i):a.fillStyle=k}var n=h.getStyle(b+".shape"),o=h.getStyle("group.shape.roundrect.radius");if(l){if(a.beginPath(),e)Xb.drawLinePoints(a,e,null,f,g);else if("roundrect"===n&&"group"===b){var p={};p.topLeft=o,p.topRight=o,p.bottomLeft=o,p.bottomRight=o,Xb.drawVector(a,n,null,i,p)}else Xb.drawVector(a,n,null,i);a.fill()}if(j>0){if(a.lineWidth=j,a.lineCap=h.getStyle(b+".cap"),a.lineJoin=h.getStyle(b+".join"),a.strokeStyle=h.getStyle(b+".outline.color"),a.beginPath(),e)Xb.drawLinePoints(a,e,d,f,g);else if("roundrect"===n&&"group"===b){var p={};p.topLeft=o,p.topRight=o,p.bottomLeft=o,p.bottomRight=o,Xb.drawVector(a,n,d,i,p)}else Xb.drawVector(a,n,d,i);a.stroke()}0!=h.getAngle()&&a.restore()},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();if(d&&d>0&&Tb.grow(c,d,d),this._gl3dview._transparentSelectionEnable){var e=this.getBodyRect();if(Jb.math.intersects(e,c))return!0}return Tb.intersects(this.getViewRect(),c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Ib.canvas.NodeUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(this._gl3dview._transparentSelectionEnable){var c=this.getBodyRect();if(Jb.math.intersects(c,a))return!0}return Tb.intersects(a,this.getViewRect())?this.hitCanvasRect(a):!1}}),Ib.canvas.LinkUI=function(a,b){Ib.canvas.LinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.LinkUI",Ib.canvas.ElementUI,{isEditable:function(){return xc.isOrthogonalLink(this._element)&&this.getControlPoint()?!0:!1},invalidate:function(a){this._linkPoints=null,this._fromPoint=null,this._toPoint=null,this._angle=null,Ib.canvas.LinkUI.superClass.invalidate.call(this,a)},validateImpl:function(){this.validateBodyBounds(),Ib.canvas.LinkUI.superClass.validateImpl.call(this)},validateBodyBounds:function(){var a=this.getLinkPoints();if(a&&!(a.size()<2)){var b=this._element,c=Tb.getLineRect(a),d=b.getStyle("link.width"),e=d;if(this._outerColor){var f=b.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===b.getStyle("select.style")&&this._gl3dview.isSelected(this._element);if(g){var h=b.getStyle("select.width");e+=2*h}Tb.grow(c,e/2,e/2),b.getStyle("arrow.from")&&(this._gl3dview._debug&&(this._arrowFromRect=nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset"))),c=Tb.unionRect(c,nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset")))),b.getStyle("arrow.to")&&(this._gl3dview._debug&&(this._arrowToRect=nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"))),c=Tb.unionRect(c,nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset")))),this.appendShadowBound(this,c),this.addBodyBounds(c)}},createBodyRect:function(){var a=this.getHotSpot();return a?{x:a.x-1,y:a.y-1,width:2,height:2}:null},paintBody:function(a){var b=this._linkPoints;if(b&&!(b.size()<2)){var c=this._element,d=c.getStyle("link.width"),e=d;if(this._outerColor){var f=c.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===c.getStyle("select.style")&&this._gl3dview.isSelected(this._element);if(g){var h=c.getStyle("select.width");e+=2*h}this.setShadow(this,a),a.lineCap=c.getStyle("link.cap"),a.lineJoin=c.getStyle("link.join");var i=c.getStyle("link.pattern");g&&this.drawLinePoints(a,b,e,c.getStyle("select.color"),i),this._outerColor&&this.drawLinePoints(a,b,d+2*f,this._outerColor,i),this.drawLinePoints(a,b,d,this._innerColor||c.getStyle("link.color"),i),nd.drawLinkArrow(this,a,b)}},drawLinePoints:function(a,b,c,d,e){if(a.lineWidth=c,a.strokeStyle=d,this._element.getStyle("link.flow")===!0&&e&&e.length>1){var f=new uc(a,e[0],e[1]),g=this._element.getStyle("link.flow.offset"),h=Math.floor(g/(e[0]+e[1]));h>2&&(g-=(e[0]+e[1])*h),this._element.getStyle("link.flow.converse")?g<e[0]?f.overflow=e[0]-g:g>=e[0]&&g<=e[0]+e[1]?(f.overflow=e[1]-(g-e[0]),f.overflow&&(f.isLine=!1)):(g-=e[0]+e[1],f.overflow=e[0]-g):g<=e[1]?(f.overflow=g,g&&(f.isLine=!1)):g>e[1]&&g<=e[0]+e[1]?f.overflow=g-e[1]:(g-=e[0]+e[1],g&&(f.isLine=!1),f.overflow=g),this._element._styleMap["link.flow.offset"]=g,a.beginPath(),Xb._drawLine(b,a),a.stroke(),a.shadowColor="transparent",a.beginPath();var i=this._element.getStyle("link.flow.color");i=i?i:Cd.NETWORK_LINK_FLOW_COLOR,a.strokeStyle=i,Xb._drawLine(b,f),a.stroke(),a.shadowColor=this._shadowColor}else a.beginPath(),Xb.drawLinePoints(a,b,e),a.stroke()},getLinkPoints:function(){return this._linkPoints||(this._linkPoints=this.createLinkPoints(),this._lineLength=Tb.calculateLineLength(this._linkPoints)),this._linkPoints},getFromPosition:function(a,b){var c=this.getFromPoint();return c?{x:c.x+a,y:c.y+b}:null},getToPosition:function(a,b){var c=this.getToPoint();return c?{x:c.x+a,y:c.y+b}:null},getFromPoint:function(){return this._fromPoint||(this._fromPoint=xc.createFromPoint(this)),this._fromPoint},getToPoint:function(){return this._toPoint||(this._toPoint=xc.createToPoint(this)),this._toPoint},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=this.getStyle("link.type"),d=new Ib.List;if(xc.isOrthogonalOrFlexionalLink(this._element))d=xc.orthogonalAndFlexional(this,c);else if(this._element.isLooped()){var e=this._gl3dview.getElementUI(this._element.getFromAgent());null!=e&&(this._hotSpot=xc.fillLoopedPoints(this,e.getBodyRect(),d))}else{if("arc"!==c&&"triangle"!==c&&"parallel"!==c)throw"Can not resolve link type '"+c+"'";this._hotSpot=xc.fillBundlePoints(this,c,a,b,d)}if(this._gl3dview._linkPathFunction){var f=this._gl3dview._linkPathFunction(this,d);f&&(d=f)}return d},checkAttachments:function(){Ib.canvas.LinkUI.superClass.checkAttachments.call(this),this.checkLinkHandlerAttachment()},checkLinkHandlerAttachment:function(){var a=this._gl3dview.getLinkHandlerLabel(this._element);null!=a&&""!==a?this._linkHandlerAttachment||(this._linkHandlerAttachment=new Ib.canvas.LinkHandlerAttachment(this),this.addAttachment(this._linkHandlerAttachment)):this._linkHandlerAttachment&&(this.removeAttachment(this._linkHandlerAttachment),this._linkHandlerAttachment=null)},getLinkHandlerAttachment:function(){return this._linkHandlerAttachment},getControlPoint:function(){return xc.getControlPoint(this._element,this)},setControlPoint:function(a){if(a){var b=this.getStyle("link.type");if(xc.hasControlPoint(b)){var c=xc.getLinkSourceBounds(this),d=xc.getLinkTargetBounds(this);xc.setParamsByControlPoint(a,c,d,b,this._element)}}},getLineLength:function(){return this._lineLength},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();return d&&d>0&&Tb.grow(c,d,d),Tb.intersects(this.getViewRect(),c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Ib.canvas.LinkUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(0==Tb.intersects(a,this.getViewRect()))return!1;var c=this.getLinkPoints(),d=c.size();if(2==d)for(var e=0;d>e;e+=2){var f=c.get(e);if(d>e+1){var g=c.get(e+1);if(Md.intersectsLine(f.x,f.y,g.x,g.y,a.x,a.y,a.width,a.height))return!0}}return this.hitCanvasRect(a)},getAngle:function(){return!this._angle&&this._fromPoint&&this._toPoint&&(this._angle=Tb.getAngle(this._fromPoint,this._toPoint)),this._angle||0}}),Ib.canvas.GroupUI=function(a,b){Ib.canvas.GroupUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.GroupUI",Ib.canvas.NodeUI,{isEditable:function(){return!this._element.isExpanded()},paintBody:function(a){this._shapeRect?this.drawExpandedGroup(a):Ib.canvas.GroupUI.superClass.paintBody.apply(this,arguments)},validateBodyBounds:function(){this.getBodyRect(),this._shapeRect?this.addBodyBounds(this.getPathRect("group",!1)):Ib.canvas.GroupUI.superClass.validateBodyBounds.call(this)},drawExpandedGroup:function(a){this.drawPath(a,"group",!1,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("group.deep"),c=this.getStyle("group.fill.color");0!==b&&c&&"rectangle"===this.getStyle("group.shape")&&Xb.draw3DRect(a,c,b,this._bodyRect)},getChildrenRects:function(){return this._gl3dview.getGroupChildrenRects(this._element)},createBodyRect:function(){this._shapeRect=null;var a=this._element,b=this._gl3dview;if(a.isExpanded()){a.getChildren().forEach(function(a){var c=b.getElementUI(a);c&&c.validate()});var c=this.getChildrenRects();if(!c.isEmpty()){var d=a.getStyle("group.shape"),e=Ub[d];if(!e)throw"Can not resolve group shape '"+d+"'";this._shapeRect=e(c)}}return this._shapeRect?(Tb.addPadding(this._shapeRect,a,"group.padding",1),this._shapeRect):Ib.canvas.GroupUI.superClass.createBodyRect.call(this)}}),Ib.canvas.ShapeNodeUI=function(a,b){Ib.canvas.ShapeNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.ShapeNodeUI",Ib.canvas.NodeUI,{getDefaultBodyRect:function(){return this._element._points.size()<2?null:this.getPathRect("vector",!0)},drawDefaultBody:function(a){this._element._points.size()<2||(this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"),this._element._points,this._element._segments,this._element.getStyle("shapenode.closed")),nd.drawLinkArrow(this,a,Tb.getPointObject(this._element._points,this._element._segments)))},drawSelectBorder:function(a){var b=this._element,c=b.getStyle("select.width");if(c>0){var d=this.getBodyRect();Tb.addPadding(d,b,"select.padding",1),Tb.grow(d,c/2,c/2);var e=b.getStyle("vector.outline.width");e>0&&Tb.grow(d,e/2,e/2),a.lineWidth=c,a.lineCap=b.getStyle("select.cap"),a.lineJoin=b.getStyle("select.join"),a.strokeStyle=b.getStyle("select.color"),Xb.drawVector(a,b.getStyle("select.shape"),null,d),a.stroke()}}}),Ib.canvas.ShapeLinkUI=function(a,b){Ib.canvas.ShapeLinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.ShapeLinkUI",Ib.canvas.LinkUI,{isEditable:function(){return!0},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=new Ib.List,d=this.getStyle("shapelink.type");c.add(a),null!=this._element._points&&c.addAll(this._element._points),c.add(b);var e,f,g,h,i,j,k,l=Tb.calculateLineLength(c)/2,m=c.size(),n=0,o=0;for(e=0;m>e;e++)if(h=c.get(e),0!=e){if(g=h,g instanceof md&&(g=g._as),g instanceof Array?(i=Tb.calculateCurveLength(f,g,1),f=g[g.length-1]):(k=h.y-f.y,j=h.x-f.x,i=Math.sqrt(j*j+k*k),f=g),o+=i,l>=n&&o>=l){var p=l-n,q=c.get(e-1);q instanceof md&&(q=q._as,q instanceof Array&&(q=q[q.length-1]));var r=c.get(e),s=Tb.getPathInfo(r,q,p,0,-1).point;this._hotSpot=Jb.clone(s)}n=o}else f=h;var t,u,v;if("lineto"===d);else if("quadto"===d){for(t=new Ib.List(c.get(0)),u=1,pointCount=c.size();u<pointCount;u++)t.add(u<pointCount-1?new Ib.List([c.get(u++),c.get(u)]):c.get(u));c=t}else if("cubicto"===d){for(t=new Ib.List(c.get(0)),u=1,pointCount=c.size();u<pointCount;u++)t.add(u<pointCount-2?new Ib.List([c.get(u++),c.get(u++),c.get(u)]):u<pointCount-1?new Ib.List([c.get(u++),c.get(u)]):c.get(u));c=t}else{if("orthogonalto"!==d)throw"Can not resolve shapelink type '"+d+"'";for(v=c.get(0),t=new Ib.List(v),u=1,pointCount=c.size();u<pointCount;u++)if(u<pointCount-1){var h=Jb.clone(c.get(u)),w=h.x,x=h.y,j=w-v.x,k=x-v.y;Math.abs(j)>Math.abs(k)?(h.x=w,h.y=v.y):(h.x=v.x,h.y=x),v=h,t.add(v)}else t.add(c.get(u));c=t}return c}}),Ib.canvas.GridUI=function(a,b){Ib.canvas.GridUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.GridUI",Ib.canvas.NodeUI,{drawDefaultBody:function(a){this._element.getImage()?Ib.canvas.GridUI.superClass.drawDefaultBody.apply(this,arguments):this.drawGridBody(a)},validateBodyBounds:function(){if(this._element.getImage())Ib.canvas.GridUI.superClass.validateBodyBounds.call(this);else{var a=this.getBodyRect(),b=Jb.clone(a);this.appendShadowBound(this,b),this.addBodyBounds(b)}},drawGridBody:function(a){var b=this.getStyle("grid.fill"),c=this.getStyle("grid.deep"),d=this.getStyle("grid.cell.deep");if(b||0!==c||0!==d){a.beginPath();var e=this._element.getRect(),f=this.getDyeColor("grid.fill.color");if(this.setShadow(this,a),b&&(a.fillStyle=f,a.rect(e.x,e.y,e.width,e.height),a.fill()),a.closePath(),this.clearShadow(a),a.beginPath(),0!=c&&Xb.draw3DRect(a,f,c,e.x,e.y,e.width,e.height),a.closePath(),0!=d)for(var g=this.getStyle("grid.row.count"),h=this.getStyle("grid.column.count"),i=0;g>i;i++)for(var j=0;h>j;j++){var k=this._element.getCellRect(i,j);null!=k&&(a.beginPath(),Xb.draw3DRect(a,f,d,k.x,k.y,k.width,k.height),a.closePath())}}}}),Ib.canvas.RotatableNodeUI=function(a,b){Ib.canvas.RotatableNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.RotatableNodeUI",Ib.canvas.NodeUI,{isEditable:function(){return!1},getDefaultBodyRect:function(){var a=this._element,b=Jb.getImageAsset(a.getImage()),c=this.getBodyRect();return b?(Tb.addPadding(c,this._element,"image.padding",1),c):c},drawDefaultBody:function(a){var b=this._element,c=Jb.getImageAsset(b.getImage()),d=this.getBodyRect();if(Tb.addPadding(d,this._element,"image.padding",1),c.getImage()){var e=this._element._getOrignalWidth(),f=this._element._getOrignalHeight(),g=this._element._getRotateRect();a.save(),a.translate(d.x-g.x+e/2,d.y-g.y+f/2),a.rotate(this._element._angle*Math.PI/180);var d={x:-e/2,y:-f/2,width:e,height:f};Nc(a,c.getImage(this._innerColor,d.width,d.height),this._innerColor,d,b,this._gl3dview),a.restore()}else if(c.getSrc());else if(!c.getFunction())throw"ImageAsset '"+b.getImage()+" ' is empty"}}),Ib.canvas.HTMLNodeUI=function(a,b){Ib.canvas.HTMLNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.HTMLNodeUI",Ib.canvas.NodeUI,{checkAttachments:function(){Ib.canvas.NodeUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Ib.canvas.HTMLNodeUI.superClass.checkLabelAttachment.call(this);var b=this._gl3dview.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Ib.canvas.HTMLLabelAttachment(this,Cd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Ib.canvas.HTMLNodeUI.superClass.checkAlarmAttachment.call(this);var b=this._gl3dview.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Ib.canvas.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},setAttachmentVisible:function(a){a?(this._labelAttachment&&this._labelAttachment.setVisibility("visible"),this._alarmAttachment&&this._alarmAttachment.setVisibility("visible")):(this._labelAttachment&&this._labelAttachment.setVisibility("hidden"),this._alarmAttachment&&this._alarmAttachment.setVisibility("hidden"))}}),Ib.canvas.HTMLLinkUI=function(a,b){Ib.canvas.HTMLLinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.HTMLLinkUI",Ib.canvas.LinkUI,{checkAttachments:function(){Ib.canvas.LinkUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Ib.canvas.HTMLLinkUI.superClass.checkLabelAttachment.call(this);var b=this._gl3dview.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Ib.canvas.HTMLLabelAttachment(this),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Ib.canvas.HTMLLinkUI.superClass.checkAlarmAttachment.call(this);var b=this._gl3dview.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Ib.canvas.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}}),Ib.canvas.Attachment=function(a,b){this._ui=a,this._element=this._ui.getElement(),this._gl3dview=a.getGl3dview(),this._showOnTop=b},Jb.ext("twaver.canvas.Attachment",Object,{getElement:function(){return this._element},getElementUI:function(){return this._ui},getGl3dview:function(){return this._gl3dview},isShowOnTop:function(){return this._showOnTop===!0},setShowOnTop:function(a){this._showOnTop=a},getStyle:function(a){return this._ui.getStyle(a)},getFont:function(a){return this._ui.getFont(a)},getViewRect:function(){return Jb.clone(this._viewRect)},getAlpha:function(){return 1},validate:function(){},paint:function(a){},hit:function(a,b){return Tb.containsPoint(this._viewRect,a,b)?this.hitCanvasRect({x:a-1,y:b-1,width:2,height:2}):!1},hitCanvasRect:function(a){var b=Md.getHitCanvas(a.width,a.height),c=Md.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paint(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),!0}}catch(j){Md.disposeHitCanvas()}return c.restore(),!1}}),Ib.canvas.BasicAttachment=function(a,b){Ib.canvas.BasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0}},Jb.ext("twaver.canvas.BasicAttachment",Ib.canvas.Attachment,{paint:function(a){Ib.canvas.BasicAttachment.superClass.paint.apply(this,arguments);var b=this.isFill(),c=this.getOutlineWidth();if(this.getElementUI().setShadow(this,a),(c>0||b)&&(Xb.drawRoundRect(a,this._roundRect.x,this._roundRect.y,this._roundRect.width,this._roundRect.height,this.getCornerRadius()),this._pointers&&(a.moveTo(this._pointers[0].x,this._pointers[0].y),a.lineTo(this._pointers[1].x,this._pointers[1].y),a.lineTo(this._pointers[2].x,this._pointers[2].y)),a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b)){var d=this.getFillColor(),e=this.getGradient();e?Xb.fill(a,d,e,this.getGradientColor(),this._viewRect):a.fillStyle=d,a.fill()}},validate:function(){Ib.canvas.BasicAttachment.superClass.validate.call(this),this.calculateMeasure();var a=this.getOutlineWidth();this._viewRect=Tb.getRect(this._pointers),this._viewRect=Tb.unionRect(this._viewRect,this._roundRect),a>0&&Tb.grow(this._viewRect,a/2,a/2),this._viewRect=this._ui.appendShadowBound(this,this._viewRect)},calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=this.getCornerRadius(),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset(),i=this._roundRect;i.width=a+2*c,i.height=b;var j;if(d>0){var k=this.getDirection();if(this._ui._element instanceof Ib.Link){var l,m=this._ui.getLinkPoints();l=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(g)>0&&Math.abs(g)<1?"from"===f?g*=l:"to"===f?g=l*(1-g):(g/=2,g+=.5,g*=l):"from"===f?g=g:"to"===f?g=l-g:g+=l/2;{var n,o=Tb.calculatePointInfoAlongLine(m,!0,g,h),p=o.point;o.angle}n="from"===f?this._ui.getFromPoint():"to"===f?this._ui.getToPoint():this._ui._hotSpot,g=p.x-n.x,h=p.y-n.y}j=this._gl3dview.getPosition(f,this._ui,null,g,h);var q;if("aboveleft"===k)i.y=j.y-d-i.height,i.x=j.x-(i.width-c),q=Math.max(j.x-e,i.x+c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("aboveright"===k)i.y=j.y-d-i.height,i.x=j.x-c,q=Math.min(j.x+e,i.x+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("belowleft"===k)i.y=j.y+d,i.x=j.x-(i.width-c),q=Math.max(j.x-e,i.x+c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("belowright"===k)i.y=j.y+d,i.x=j.x-c,q=Math.min(j.x+e,i.x+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("leftabove"===k)i.y=j.y+c-i.height,i.x=j.x-d-i.width,q=Math.max(j.y-e,i.y+c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("leftbelow"===k)i.y=j.y-c,i.x=j.x-d-i.width,q=Math.min(j.y+e,i.y+i.height-c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("rightabove"===k)i.y=j.y+c-i.height,i.x=j.x+d,q=Math.max(j.y-e,i.y+c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("rightbelow"===k)i.y=j.y-c,i.x=j.x+d,q=Math.min(j.y+e,i.y+i.height-c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("above"===k)i.y=j.y-d-i.height,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y-d},{x:j.x+q,y:j.y-d}];else if("below"===k)i.y=j.y+d,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y+d},{x:j.x+q,y:j.y+d}];else if("left"===k)i.y=j.y-i.height/2,i.x=j.x-d-i.width,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x-d,y:j.y+q},{x:j.x-d,y:j.y-q}];else{if("right"!==k)throw"Can not resolve '"+k+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x+d,y:j.y+q},{x:j.x+d,y:j.y-q}]}}else j=this._gl3dview.getPosition(f,this._ui,{width:i.width,height:i.height},g,h),i.x=j.x,i.y=j.y,this._pointers=null;this._contentRect.x=i.x+(i.width-a)/2,this._contentRect.y=i.y+(i.height-b)/2,this._contentRect.width=a,this._contentRect.height=b;var r=this.getPadding();0!=r&&Tb.grow(i,r,r),r=this.getPaddingLeft(),0!=r&&(i.x-=r,i.width+=r),r=this.getPaddingRight(),0!=r&&(i.width+=r),r=this.getPaddingTop(),0!=r&&(i.y-=r,i.height+=r),r=this.getPaddingBottom(),0!=r&&(i.height+=r),i.width<0&&(i.width=i.width,i.x-=i.width),i.height<0&&(i.height=-i.height,i.y-=i.height)},getContentWidth:function(){return Ib.Defaults.ATTACHMENT_CONTENT_WIDTH},getContentHeight:function(){return Ib.Defaults.ATTACHMENT_CONTENT_HEIGHT},getCornerRadius:function(){return Ib.Defaults.ATTACHMENT_CORNER_RADIUS},getPointerLength:function(){return Ib.Defaults.ATTACHMENT_POINTER_LENGTH},getPointerWidth:function(){return Ib.Defaults.ATTACHMENT_POINTER_WIDTH},getPosition:function(){return Ib.Defaults.ATTACHMENT_POSITION},getXOffset:function(){return Ib.Defaults.ATTACHMENT_XOFFSET},getYOffset:function(){return Ib.Defaults.ATTACHMENT_YOFFSET},getPadding:function(){return Ib.Defaults.ATTACHMENT_PADDING},getPaddingLeft:function(){return Ib.Defaults.ATTACHMENT_PADDING_LEFT},getPaddingRight:function(){return Ib.Defaults.ATTACHMENT_PADDING_RIGHT},getPaddingTop:function(){return Ib.Defaults.ATTACHMENT_PADDING_TOP},getPaddingBottom:function(){return Ib.Defaults.ATTACHMENT_PADDING_BOTTOM},getDirection:function(){return Ib.Defaults.ATTACHMENT_DIRECTION},isFill:function(){return Ib.Defaults.ATTACHMENT_FILL},getFillColor:function(){return Ib.Defaults.ATTACHMENT_FILL_COLOR},getGradient:function(){return Ib.Defaults.ATTACHMENT_GRADIENT},getGradientColor:function(){return Ib.Defaults.ATTACHMENT_GRADIENT_COLOR},getOutlineWidth:function(){return Ib.Defaults.ATTACHMENT_OUTLINE_WIDTH},getOutlineColor:function(){return Ib.Defaults.ATTACHMENT_OUTLINE_COLOR},getCap:function(){return Ib.Defaults.ATTACHMENT_CAP},getJoin:function(){return Ib.Defaults.ATTACHMENT_JOIN},isShadowable:function(){return Ib.Defaults.ATTACHMENT_SHADOWABLE},getRoundRect:function(){return Jb.clone(this._roundRect)},getContentRect:function(){return Jb.clone(this._contentRect)}}),Ib.canvas.LabelAttachment=function(a,b){Ib.canvas.LabelAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.LabelAttachment",Ib.canvas.BasicAttachment,{paint:function(a){var b=this._element instanceof Ib.Link&&this._element.getStyle("link.label.rotatable");if(b){a.save();var c=this._viewRect.x+this._viewRect.width/2,d=this._viewRect.y+this._viewRect.height/2;a.translate(c,d),a.rotate(this._gl3dview.getElementUI(this._element).getAngle()),a.translate(-c,-d)}Ib.canvas.LabelAttachment.superClass.paint.apply(this,arguments);var e=this._element.getStyle("label.align");Xb.drawText(a,this.text,this._contentRect,this.font,this.getStyle("label.color"),e),b&&a.restore()},validate:function(){this.font=this.getFont("label.font"),this.text=this.getLabel(),this._textSize=Xb.getTextSize(this.font,this.text),Ib.canvas.LabelAttachment.superClass.validate.call(this)},getLabel:function(){return this._gl3dview.getLabel(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label.corner.radius")},getPointerLength:function(){return this.getStyle("label.pointer.length")},getPointerWidth:function(){return this.getStyle("label.pointer.width")},getPosition:function(){return this.getStyle("label.position")},getXOffset:function(){return this.getStyle("label.xoffset")},getYOffset:function(){return this.getStyle("label.yoffset")},getPadding:function(){return this.getStyle("label.padding")},getPaddingLeft:function(){return this.getStyle("label.padding.left")},getPaddingRight:function(){return this.getStyle("label.padding.right")},getPaddingTop:function(){return this.getStyle("label.padding.top")},getPaddingBottom:function(){return this.getStyle("label.padding.bottom")},getDirection:function(){return this.getStyle("label.direction")},isFill:function(){return this.getStyle("label.fill")},getFillColor:function(){
return this.getStyle("label.fill.color")},getGradient:function(){return this.getStyle("label.gradient")},getGradientColor:function(){return this.getStyle("label.gradient.color")},getOutlineWidth:function(){return this.getStyle("label.outline.width")},getOutlineColor:function(){return this.getStyle("label.outline.color")},getCap:function(){return this.getStyle("label.cap")},getJoin:function(){return this.getStyle("label.join")},getAlpha:function(){return this.getStyle("label.alpha")},isShadowable:function(){return this.getStyle("label.shadowable")}}),Ib.canvas.AlarmAttachment=function(a,b){Ib.canvas.AlarmAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.AlarmAttachment",Ib.canvas.BasicAttachment,{paint:function(a){Ib.canvas.AlarmAttachment.superClass.paint.apply(this,arguments),Xb.drawText(a,this.text,this._contentRect,this.font,this.getStyle("alarm.color"))},validate:function(){this.font=this.getFont("alarm.font"),this.text=this._gl3dview.getAlarmLabel(this._element),this._textSize=Xb.getTextSize(this.font,this.text),this._fillColor=this._gl3dview.getAlarmFillColor(this._element),Ib.canvas.LabelAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("alarm.corner.radius")},getPointerLength:function(){return this.getStyle("alarm.pointer.length")},getPointerWidth:function(){return this.getStyle("alarm.pointer.width")},getPosition:function(){return this.getStyle("alarm.position")},getXOffset:function(){return this.getStyle("alarm.xoffset")},getYOffset:function(){return this.getStyle("alarm.yoffset")},getPadding:function(){return this.getStyle("alarm.padding")},getPaddingLeft:function(){return this.getStyle("alarm.padding.left")},getPaddingRight:function(){return this.getStyle("alarm.padding.right")},getPaddingTop:function(){return this.getStyle("alarm.padding.top")},getPaddingBottom:function(){return this.getStyle("alarm.padding.bottom")},getDirection:function(){return this.getStyle("alarm.direction")},isFill:function(){return null!=this._fillColor},getFillColor:function(){return this._fillColor},getGradient:function(){return this.getStyle("alarm.gradient")},getGradientColor:function(){return this.getStyle("alarm.gradient.color")},getOutlineWidth:function(){return this.getStyle("alarm.outline.width")},getOutlineColor:function(){return this.getStyle("alarm.outline.color")},getCap:function(){return this.getStyle("alarm.cap")},getJoin:function(){return this.getStyle("alarm.join")},getAlpha:function(){return this.getStyle("alarm.alpha")},isShadowable:function(){return this.getStyle("alarm.shadowable")}}),Ib.canvas.LinkHandlerAttachment=function(a,b){Ib.canvas.LinkHandlerAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.LinkHandlerAttachment",Ib.canvas.BasicAttachment,{paint:function(a){Ib.canvas.LinkHandlerAttachment.superClass.paint.apply(this,arguments),Xb.drawText(a,this.linkHandlerLabel,this._contentRect,this.linkHandlerFont,this.getStyle("link.handler.color"))},validate:function(){this.linkHandlerFont=this.getFont("link.handler.font"),this.linkHandlerLabel=this._gl3dview.getLinkHandlerLabel(this._element),this._textSize=Xb.getTextSize(this.linkHandlerFont,this.linkHandlerLabel),Ib.canvas.LinkHandlerAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("link.handler.corner.radius")},getPointerLength:function(){return this.getStyle("link.handler.pointer.length")},getPointerWidth:function(){return this.getStyle("link.handler.pointer.width")},getPosition:function(){return this.getStyle("link.handler.position")},getXOffset:function(){return this.getStyle("link.handler.xoffset")},getYOffset:function(){return this.getStyle("link.handler.yoffset")},getPadding:function(){return this.getStyle("link.handler.padding")},getPaddingLeft:function(){return this.getStyle("link.handler.padding.left")},getPaddingRight:function(){return this.getStyle("link.handler.padding.right")},getPaddingTop:function(){return this.getStyle("link.handler.padding.top")},getPaddingBottom:function(){return this.getStyle("link.handler.padding.bottom")},getDirection:function(){return this.getStyle("link.handler.direction")},isFill:function(){return this.getStyle("link.handler.fill")},getFillColor:function(){return this.getStyle("link.handler.fill.color")},getGradient:function(){return this.getStyle("link.handler.gradient")},getGradientColor:function(){return this.getStyle("link.handler.gradient.color")},getOutlineWidth:function(){return this.getStyle("link.handler.outline.width")},getOutlineColor:function(){return this.getStyle("link.handler.outline.color")},getCap:function(){return this.getStyle("link.handler.cap")},getJoin:function(){return this.getStyle("link.handler.join")},getAlpha:function(){return this.getStyle("link.handler.alpha")},isShadowable:function(){return this.getStyle("link.handler.shadowable")}}),Ib.canvas.IconsAttachment=function(a,b){Ib.canvas.IconsAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.IconsAttachment",Ib.canvas.Attachment,{isShadowable:function(){return Ib.Defaults.ATTACHMENT_SHADOWABLE},validate:function(){if(Ib.canvas.IconsAttachment.superClass.validate.call(this),this.iconsNames=this._gl3dview.getIconsNames(this._element),this.iconsNames&&0!=this.iconsNames.length){var a=this._makeGroup(this.iconsNames),b=this._makeGroup(this._gl3dview.getIconsColors(this._element));len=a.length,this.iconsOrientation=this._makeArray(this._element.getStyle("icons.orientation"),len,"right"),this.iconsPosition=this._makeArray(this._element.getStyle("icons.position"),len,"topleft.bottomright"),this.iconsXoffset=this._makeArray(this._element.getStyle("icons.xoffset"),len,0),this.iconsYoffset=this._makeArray(this._element.getStyle("icons.yoffset"),len,0),this.iconsXgap=this._makeArray(this._element.getStyle("icons.xgap"),len,1),this.iconsYgap=this._makeArray(this._element.getStyle("icons.ygap"),len,1),this.locations=[],this.iconsSizes=[];var c,d;for(i=0;i<len;i++){var e=a[i],f=this.iconsOrientation[i]||"right",g=this.iconsPosition[i]||"topleft.bottomright",h=this.iconsXgap[i]||1,j=this.iconsYgap[i]||1,k=this.iconsXoffset[i]||0,l=this.iconsYoffset[i]||0;d=null,c=this._getIconsSize(e,f,h,j),c&&(d=this._gl3dview.getPosition(g,this._ui,c,k,l),"top"===f?d.y+=c.height:"left"===f&&(d.x+=c.width)),this.locations.push(d),this.iconsSizes.push(c)}var m=null;for(i=0;i<this.locations.length;i++)d=this.locations[i],c=this.iconsSizes[i],null!=d&&(m=null==m?{x:d.x,y:d.y,width:c.width,height:c.height}:Tb.unionRect(m,{x:d.x,y:d.y,width:c.width,height:c.height}));this._viewRect=m||{x:this._element.getLocation().x,y:this._element.getLocation().y,width:0,height:0},this.iconsGroups=a,this.colorGroups=b}},_makeGroup:function(a){if(!Array.isArray(a))return[[a]];var b,c,d,e=[],f=!1,g=a.length;for(b=0;g>b;b++)c=a[b],Array.isArray(c)?(f=!0,e.push(c)):(d=[c],e.push(d));return f||(e.length=0,e.push(a)),e},_makeArray:function(a,b,c){if(Array.isArray(a))return a;for(var d=[],e=0;b>e;e++)d.push(a||c);return d},paint:function(a){if(Ib.canvas.IconsAttachment.superClass.paint.apply(this,arguments),this.iconsNames&&0!=this.iconsNames.length&&this.locations){var b,c,d,e,f,g,h,i,j,k;for(b=0;b<this.iconsGroups.length;b++)if(c=this.locations[b]){f=c.x,g=c.y,e=this.iconsGroups[b],h=this.colorGroups[b],i=this.iconsOrientation[b],j=this.iconsXgap[b]||1,k=this.iconsYgap[b]||1,d=0;for(var l in e){var m=null,n=null;h&&h.length>d&&(n=h[d++]);var o=Jb.getImageAsset(e[l]);if(null!=o){if("right"===i)m={x:f,y:g,width:o.getWidth(),height:o.getHeight()},f+=m.width+j;else if("left"===i)m={x:f-o.getWidth(),y:g,width:o.getWidth(),height:o.getHeight()},f-=m.width+j;else if("top"===i)m={x:f,y:g-o.getHeight(),width:o.getWidth(),height:o.getHeight()},g-=m.height+k;else{if("bottom"!==i)throw"Can not resolve '"+i+"' orientation";m={x:f,y:g,width:o.getWidth(),height:o.getHeight()},g+=m.height+k}Nc(a,o.getImage(n,m.width,m.height),n,m,this._element,this._gl3dview)}}}}},_getIconsSize:function(a,b,c,d){var e=0,f=0,g=null,h=null,i=null;for(var j in a)if(h=Jb.getImageAsset(a[j])){if("right"===b)g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},e+=g.width+c;else if("left"===b)g={x:e-h.getWidth(),y:f,width:h.getWidth(),height:h.getHeight()},e-=g.width+c;else if("top"===b)g={x:e,y:f-h.getHeight(),width:h.getWidth(),height:h.getHeight()},f-=g.height+d;else{if("bottom"!==b)throw"Can not resolve '"+b+"' orientation";g={x:e,y:f,width:h.getWidth(),height:h.getHeight()},f+=g.height+d}i=null==i?Jb.clone(g):Tb.unionRect(i,g)}return i?{width:Math.abs(i.width),height:Math.abs(i.height)}:null}}),Ib.canvas.EditAttachment=function(a,b){Ib.canvas.EditAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.canvas.EditAttachment",Ib.canvas.Attachment,{paint:function(a){Ib.canvas.EditAttachment.superClass.paint.apply(this,arguments),this._viewRect=null,this.paintResizingPoints(a),this.paintEditPoints(a),this.paintRotatePoints(a)},paintResizingPoints:function(a){var b=this.resizingPoints.size();if(!(0>=b)){var c=2*this.resizePointSize,d=2*this.resizePointSize,e=this._gl3dview.getResizePointFillColor(),f=this._gl3dview.getResizePointOutlineWidth(),g=this._gl3dview.getResizePointOutlineColor(),h=this._element.getAngle(),i=this._element.getOriginalRect();a.lineWidth=f;for(var j=0;b>j;j++){var k=this.resizingPoints.get(j),l={x:k.x-this.resizePointSize,y:k.y-this.resizePointSize,width:2*this.resizePointSize,height:2*this.resizePointSize},m=this._getRotateRect(l,h,{x:i.x+i.width/2,y:i.y+i.height/2});a.save(),Ib.Util.rotateCanvas(a,m,h),Md.rect(a,m.x,m.y,c,d),a.restore()}a.fillStyle=e,a.strokeStyle=g,a.fill(),a.stroke()}},paintEditPoints:function(a){var b=this.editPoints.size();if(!(0>=b)){var c=this._gl3dview.getEditPointOutlineColor(),d=this._gl3dview.getEditPointFillColor(),e=this._gl3dview.getEditPointOutlineWidth();a.beginPath(),a.lineWidth=e;for(var f=0;b>f;f++){var g=this.editPoints.get(f);a.beginPath(),Md.circle(a,g.x,g.y,this.editPointSize,d,c),a.closePath()}}},paintRotatePoints:function(a){var b=this.rotatePoints.size();if(!(0>=b)){var c=this._gl3dview.getRotatePointOutlineColor(),d=this._gl3dview.getRotatePointFillColor(),e=this._gl3dview.getRotatePointOutlineWidth();a.beginPath(),a.lineWidth=e;for(var f=0;b>f;f++){var g=this.rotatePoints.get(f);a.beginPath(),Md.circle(a,g.x,g.y,this.rotatePointSize,d,c),a.closePath()}}},validate:function(){Ib.canvas.EditAttachment.superClass.validate.call(this),this.editPointSize=this._gl3dview.getEditPointSize(),this.resizePointSize=this._gl3dview.getResizePointSize(),this.rotatePointSize=this._gl3dview.getRotatePointSize(),this.resizingPoints=new Ib.List,this.editPoints=new Ib.List,this.rotatePoints=new Ib.List,this._element instanceof Ib.Node&&this._addResizingPoint(this._element),!(this._gl3dview.isRotatable(this._element)&&this._element instanceof Jd)||this._element instanceof Ib.ShapeNode||this._element instanceof Ib.Grid||this._element instanceof Ib.Group||this._addRotatePoint(this._element),this._element instanceof Ib.ShapeNode&&(this._addResizingPoint(this._element),this._addShapeNodePoint(this._element)),this._ui instanceof Ib.canvas.ShapeLinkUI&&this._addShapeLinkPoints(this._element),this._ui instanceof Ib.canvas.LinkUI&&this._addLinkControlPoint(this._ui)},_addResizingPoint:function(a){var b=a.getOriginalRect();if(b){var c=this._gl3dview.getResizePointSize();if(!(0>=c)){var d=new md([{x:b.x,y:b.y},{x:b.x+b.width/2,y:b.y},{x:b.x+b.width,y:b.y},{x:b.x,y:b.y+b.height/2},{x:b.x+b.width,y:b.y+b.height/2},{x:b.x,y:b.y+b.height},{x:b.x+b.width/2,y:b.y+b.height},{x:b.x+b.width,y:b.y+b.height}]),e=this._gl3dview.getResizePointOutlineWidth(),f=this._gl3dview.getResizePointOutlineColor(),g=this._gl3dview.getResizePointFillColor();this._addPoints(a.getRect(),d,e,f,g,!0)}}},_addRotatePoint:function(a){var b=a.getOriginalRect();if(b){var c=this._gl3dview.getRotatePointSize();if(!(0>=c)){var d=2*c,e=new Ib.List([{x:b.x+b.width/2,y:b.y-this._gl3dview.getRotatePointOffset()-d/2}]),f=a.getAngle();0!=f&&(e=this._rotatePointList(e,f,a.getOriginalRect()));var g=e.get(0),h={x:g.x-d/2,y:g.y-d/2,width:d,height:d},i=this._gl3dview.getRotatePointOutlineWidth(),j=this.rotatePointSize+i;Tb.grow(b,j,j);var k=Tb.unionRect(a.getRect(),h);this._viewRect=Tb.unionRect(k,this._viewRect),this.rotatePoints=e}}},_addShapeNodePoint:function(a){this._addEditPoints(a.getPoints())},_addShapeLinkPoints:function(a){this._addEditPoints(a.getPoints())},_addLinkControlPoint:function(a){if(xc.isOrthogonalLink(a._element)){var b=a.getControlPoint();if(b){var c=new Ib.List;c.add(b),this._addEditPoints(c)}}},_addEditPoints:function(a){var b=Tb.getRect(a);if(b){var c=this._gl3dview.getEditPointSize();if(!(0>=c)){var d=this._gl3dview.getEditPointOutlineWidth();this._addPoints(b,a,d,!1)}}},_addPoints:function(a,b,c,d,e,f){var g=f?this._gl3dview.getResizePointSize():this._gl3dview.getEditPointSize();if(!(0>g)){var h=g+c;Tb.grow(a,h,h),this._viewRect=Tb.unionRect(a,this._viewRect),1==f?this.resizingPoints=b:this.editPoints=b}},_rotatePoint:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_rotatePointList:function(a,b,c){var d=this,e=new Ib.List;return a.forEach(function(a){e.add(d._rotatePoint(a,b,c))}),e},_getRotateRect:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x,c.y),e={x:a.x+a.width/2,y:a.y+a.height/2},f=d.transform(e),g=new Ib.List([{x:f.x-a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y+a.height/2},{x:f.x-a.width/2,y:f.y+a.height/2}]);return Tb.getRect(g)}}),Ib.canvas.HTMLLabelAttachment=function(a,b){Ib.canvas.HTMLLabelAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Ib.Util.createDiv(),this._roundDiv=Ib.Util.createDiv(),this._contentDiv=Ib.Util.createDiv(),Ib.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Ib.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Ib.Util.setCSSStyle(this._contentDiv,"white-space","nowrap"),Ib.Util.setCSSStyle(this._contentDiv,"pointer-events","none");this._gl3dview.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Jb.ext("twaver.canvas.HTMLLabelAttachment",Ib.canvas.LabelAttachment,{validate:function(){var a=(this.getFont("label.font"),this.getLabel());this._contentDiv.innerHTML=a,this._contentDiv.style.visibility="hidden",Ib.canvas.HTMLLabelAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setShadow(this,a),c>0||b){if(Xb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._pointers;a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Xb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("label.font"),this.getLabel(),this._gl3dview.getViewRect().x),i=this._gl3dview.getViewRect().y,j=this._gl3dview.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._gl3dview._debug&&Xb.strokeRect(a,this._contentRect,"#AAAAAA")},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._gl3dview.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Ib.canvas.HTMLAlarmAttachment=function(a,b){Ib.canvas.HTMLAlarmAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Ib.Util.createDiv(),this._roundDiv=Ib.Util.createDiv(),this._contentDiv=Ib.Util.createDiv(),Ib.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Ib.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Ib.Util.setCSSStyle(this._contentDiv,"white-space","nowrap"),Ib.Util.setCSSStyle(this._contentDiv,"pointer-events","none");this._gl3dview.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Jb.ext("twaver.canvas.HTMLAlarmAttachment",Ib.canvas.AlarmAttachment,{validate:function(){var a=(this.getFont("alarm.font"),this._gl3dview.getAlarmLabel(this._element));this._contentDiv.innerHTML=a,this._contentDiv.style.visibility="hidden",Ib.canvas.HTMLAlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setShadow(this,a),c>0||b){if(Xb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._pointers;a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Xb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("alarm.font"),this._gl3dview.getAlarmLabel(this._element),this._gl3dview.getViewRect().x),i=this._gl3dview.getViewRect().y,j=this._gl3dview.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._gl3dview._debug&&Xb.strokeRect(a,this._contentRect,"#AAAAAB"),Ib.canvas.AlarmAttachment.superClass.paint.apply(this,arguments)},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._gl3dview.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Ib.canvas.interaction.BaseInteraction=function(a){this.gl3dview=a},Jb.ext("twaver.canvas.interaction.BaseInteraction",Object,{setUp:function(){},tearDown:function(){},repaint:function(){this.gl3dview.repaintTopCanvas()},convertPointFromView:function(a){var b=a.x*this.gl3dview.getZoom()-this.gl3dview.getViewRect().x,c=a.y*this.gl3dview.getZoom()-this.gl3dview.getViewRect().y;return{x:b,y:c}},convertFromUIToMarkerRect:function(a,b,c){var d=this.gl3dview.getZoom();return{x:a.x*d-this.gl3dview.getViewRect().x+b*d,y:a.y*d-this.gl3dview.getViewRect().y+c*d,width:a.width*d,height:a.height*d}},getMarkerPoint:function(a){var b;if(Qb.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var c=a.changedTouches[0];return b={x:c.clientX,y:c.clientY}}return b=Qb.isFirefox?{x:a.layerX,y:a.layerY}:{x:a.offsetX,y:a.offsetY}},paint:function(a){},addListener:function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];Wb.addEventListener(b,"handle_"+b,this.gl3dview.getView(),this)}},removeListener:function(){for(var a=0;a<arguments.length;a++)Wb.removeEventListener(arguments[a],this.gl3dview.getView(),this)},_handle_mousedown:function(a){0===a.button&&(this._startLogical=this.gl3dview.getLogicalPoint(a),this._startClient=Wb.getClientPoint(a),this._startLogical&&Wb.handle_mousedown(this,a))},_handle_mousemove:function(a){this._endLogical={x:this._startLogical.x+(a.clientX-this._startClient.x)/this.gl3dview.getZoom(),y:this._startLogical.y+(a.clientY-this._startClient.y)/this.gl3dview.getZoom()}},_handle_mouseup:function(a){delete this._startClient,delete this._startLogical,delete this._endLogical}}),Ib.canvas.interaction.SelectInteraction=function(a){Ib.canvas.interaction.SelectInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.SelectInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup"),this.end(),this.gl3dview.removeMarker(this)},paint:function(a){if(null!=this.startPoint&&null!=this.endPoint){var b=this.convertPointFromView(this.startPoint),c=this.convertPointFromView(this.endPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Tb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.gl3dview.getSelectOutlineWidth(),j=this.getIntersectMode()?this.gl3dview.getSelectFillColor():null;a.strokeStyle=this.gl3dview.getSelectOutlineColor(),a.lineWidth=i,Md.rect(a,h.x,h.y,h.width,h.height,j,this.gl3dview.getSelectOutlineColor()),a.closePath()}}},handle_mousedown:function(a){if(this.gl3dview.isValidEvent(a)&&!this.gl3dview.isMovingElement()&&!this.gl3dview.isEditingElement()&&!a.shiftKey){var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getSelectionContainer();b?Jb.isCtrlDown(a)?c.contains(b)?c.removeSelection(b):c.appendSelection(b):c.contains(b)||c.setSelection(b):(Jb.isCtrlDown(a)||c.clearSelection(),this.end(a),this.startPoint=this.gl3dview.getLogicalPoint(a),this.startPoint&&this.gl3dview.isRectSelectEnabled()&&this.addListener("mousemove"))}},handle_mouseup:function(a){this.end(a)},handle_mousemove:function(a){if(this.gl3dview.isMovingElement()||this.gl3dview.isEditingElement())return void this.end(a);var b=this.gl3dview.getLogicalPoint(a);b&&(this.gl3dview.setSelectingElement(!0),this.gl3dview.fireInteractionEvent(null==this.endPoint?{kind:"selectStart",event:a}:{kind:"selectBetween",event:a}),this.endPoint=b,this.repaint())},end:function(a){if(this.startPoint){if(this.endPoint&&this.startPoint.x!==this.endPoint.x&&this.startPoint.y!==this.endPoint.y){var b=Tb.getRect([this.startPoint,this.endPoint]),c=this.gl3dview.getElementsAtRect(b,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(c&&c.size()>0){var d=this.gl3dview.getSelectionContainer(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a)},this),d.setSelection(e)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:a})}this.gl3dview.setSelectingElement(!1),this.removeListener("mousemove"),this.startPoint=null,this.endPoint=null,this.repaint()}},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this.startPoint.x>this.endPoint.x&&this.startPoint.y>this.endPoint.y}}),Ib.canvas.interaction.MoveInteraction=function(a,b){this.lazyMode=b,Ib.canvas.interaction.MoveInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.MoveInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup","keydown","mouseout"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup","keydown","mouseout"),this.end(),this.gl3dview.removeMarker(this)},handle_keydown:function(a){this.currentKeyEvent=a,this.addListener("keyup")},handle_keyup:function(a){this.currentKeyEvent=null,this.removeListener("keyup")},isParenting:function(){return this.pressPoint&&null!=this.currentKeyEvent&&80===this.currentKeyEvent.keyCode},parentProcess:function(a,b){var c=null;this.parent=null;var d=this;if(!b&&this.isParenting()){var e={},f=this.gl3dview.getLogicalPoint(a);e.x=f.x-1,e.y=f.y-1,e.width=2,e.height=2;var g=this.gl3dview.getElementsAtRect(e,!0);if(g&&g.size()>0)for(var h=g.size(),i=0;h>i;i++){var j=g.get(i);if(!d.gl3dview.getElementBox().getSelectionContainer().contains(j)){d.parent=j;break}}}else this.parent=null;null!=this.parent&&(c=this.gl3dview.getElementUI(this.parent).getViewRect()),this.parentRect=null==c||b?null:c},paint:function(a){if(this.lazyMode){if(null==this.pressPoint||null==this.dragPoint)return;a.beginPath();var b=this.dragPoint.x-this.pressPoint.x,c=this.dragPoint.y-this.pressPoint.y,d=this.gl3dview.getMovableSelectedElements(),e=d.size(),f=this.gl3dview.isLazyMoveFill()?this.gl3dview.getLazyMoveFillColor():null,g=this.gl3dview.getLazyMoveOutlineWidth(),h=this.gl3dview.getLazyMoveOutlineColor();a.strokeStyle=h,a.lineWidth=g,a.fillStyle=f;for(var i=0;e>i;i++){var j=d.get(i),k=this.gl3dview.getElementUI(j);if(k){var l=this.convertFromUIToMarkerRect(k.getViewRect(),b,c);Md.rect(a,l.x,l.y,l.width,l.height)}}a.fill(),a.stroke()}if(this.parentRect){a.beginPath();var f=this.gl3dview.isLazyMoveFill()?this.gl3dview.getLazyMoveFillColor():null,g=this.gl3dview.getLazyMoveOutlineWidth(),h=this.gl3dview.getLazyMoveOutlineColor();a.strokeStyle=h,a.lineWidth=g,a.fillStyle=f;var l=this.parentRect;Md.rect(a,l.x,l.y,l.width,l.height),a.fill(),a.stroke()}},handle_mousedown:function(a){if(0===a.button&&this.gl3dview.isValidEvent(a)&&!this.gl3dview.isSelectingElement()&&!this.gl3dview.isEditingElement()){var b=this.gl3dview.getElementAt(a);this.gl3dview.isMovable(b)&&(this.end(a),this.lastPoint=this.gl3dview.getLogicalPoint(a),this.lazyMode&&(this.pressPoint=this.lastPoint),this.lastPoint&&this.addListener("mousemove"))}},handle_mouseup:function(a){this.end(a)},handle_mouseout:function(a){this.end(a)},handle_mousemove:function(a){if(this.gl3dview.isSelectingElement()||this.gl3dview.isEditingElement()||!this.gl3dview.hasMovableSelectedElements())return void this.end(a);var b=this.gl3dview.getLogicalPoint(a);b&&this.lastPoint&&(this.xoffset=b.x-this.lastPoint.x,this.yoffset=b.y-this.lastPoint.y,Math.abs(this.xoffset)<1&&Math.abs(this.yoffset)<1||(this.lazyMode?null==this.dragPoint?(this.gl3dview.fireInteractionEvent({kind:"lazyMoveStart",event:a}),this.gl3dview.setMovingElement(!0)):this.gl3dview.fireInteractionEvent({kind:"lazyMoveBetween",event:a}):(this.gl3dview.moveSelectedElements(this.xoffset,this.yoffset),this.lastPoint=b,this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}))),this.parentProcess(a,!1),this.lazyMode&&(this.dragPoint=b),(this.lazyMode||this.isParenting())&&this.repaint()))},end:function(a){if(this.lazyMode){if(null!=this.dragPoint&&null!=this.pressPoint){var b=this,c=function(){b.gl3dview.fireInteractionEvent({kind:"lazyMoveEnd",event:a}),b.gl3dview.setMovingElement(!1)},d=this.dragPoint.x-this.pressPoint.x,e=this.dragPoint.y-this.pressPoint.y;this.gl3dview.moveSelectedElements(d,e,this.gl3dview.isLazyMoveAnimate(),c)}}else this.gl3dview.isMovingElement()&&(this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a}));if(this.isParenting()){null==this.parent&&(this.parent=this.gl3dview.getCurrentSubGl3dview());var b=this;this.gl3dview.getMovableSelectedElements().forEach(function(a){a.setParent(b.parent)},this.gl3dview)}this.parentProcess(a,!0),this.isParenting()&&this.repaint(),this.gl3dview.invalidateCanvasSize(),this.removeListener("mousemove"),this.lastPoint=null,this.dragPoint=null,this.pressPoint=null}}),Ib.canvas.interaction.ScrollInteraction=function(a){Ib.canvas.interaction.ScrollInteraction.superClass.constructor.call(this,a),this.hThumbRect=null,this.vThumbRect=null,this.scrollBarVisible=!1},Jb.ext("twaver.canvas.interaction.ScrollInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseover","mouseout"),Qb.isFirefox?Wb.addEventListener("DOMMouseScroll","handleMouseWheel",this.gl3dview.getView(),this):Wb.addEventListener("mousewheel","handleMouseWheel",this.gl3dview.getView(),this),Wb.addEventListener("mouseup","handleMouseUp",a,this),Wb.addEventListener("mousemove","handleMouseMove",a,this),this.gl3dview.addPropertyChangeListener(this.handleViewRectChange,this),this.validateScrollBar(),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseover","mouseout"),Qb.isFirefox?Wb.removeEventListener("DOMMouseScroll",this.gl3dview.getView(),this):Wb.removeEventListener("mousewheel",this.gl3dview.getView(),this),Wb.removeEventListener("mouseup",a,this),Wb.removeEventListener("mousemove",a,this),this.gl3dview.removePropertyChangeListener(this.handleViewRectChange,this),this.gl3dview.removeMarker(this)},handleViewRectChange:function(a){("viewRect"==a.property||"canvasSizeChange"==a.property)&&this.validateScrollBar()},getScrollBarWidth:function(){return this.gl3dview.getScrollBarWidth()},getScrollBarColor:function(){return"#cccccc"},validateScrollBar:function(){if(this.hThumbRect=null,this.vThumbRect=null,0==this.gl3dview.isScrollBarVisible())return void this.repaint();var a=this.gl3dview.getViewRect().height,b=this.gl3dview.getViewRect().width,c=this.gl3dview.getViewRect().x,d=this.gl3dview.getViewRect().y,e=this.gl3dview.getCanvasSize(),f=e.width,g=e.height;if(f>b&&(0>c||c+b>f))return void this.repaint();if(g>a&&(0>d||d+a>g))return void this.repaint();var h=0,i=g>a,j=f>b,k=this.getScrollBarWidth();if(g>a){h=j?a*(a-k)/g:a*a/g;var l=d/(g-a)*(a-h-k);this.vThumbRect={x:b-k,y:l,width:k,height:h}}var m=0;if(f>b){m=i?b*(b-k)/f:b*b/f;var n=c/(f-b)*(b-m-k);this.hThumbRect={x:n,y:a-k,width:m,height:k}}this.gl3dview.setHScrollBarVisible(null!=this.hThumbRect),this.gl3dview.setVScrollBarVisible(null!=this.vThumbRect),this.repaint()},scrollXOffset:function(a){var b=this.gl3dview.getViewRect().height,c=this.gl3dview.getViewRect().width,d=this.gl3dview.getViewRect().x,e=this.gl3dview.getViewRect().y,f=30;a&&(f=-30),this.gl3dview.setViewRect(d+f,e,c,b)},scrollYOffset:function(a){var b=this.gl3dview.getViewRect().height,c=this.gl3dview.getViewRect().width,d=this.gl3dview.getViewRect().x,e=this.gl3dview.getViewRect().y,f=30;a&&(f=-30),this.gl3dview.setViewRect(d,e+f,c,b)},handle_mousedown:function(a){if(1!=this.gl3dview.isValidEvent(a)){var b=this.getMarkerPoint(a);this.hBarDownPoint=null,this.vBarDownPoint=null,null!=this.vThumbRect&&Tb.containsPoint(this.vThumbRect,b.x,b.y)&&(this.vBarDownPoint={x:a.screenX,y:a.screenY},this.vBarDownOffset=this.vBarDownPoint.y-this.vThumbRect.y),null!=this.hThumbRect&&Tb.containsPoint(this.hThumbRect,b.x,b.y)&&(this.hBarDownPoint={x:a.screenX,y:a.screenY},this.hBarDownOffset=this.hBarDownPoint.x-this.hThumbRect.x)}},handle_mouseover:function(a){1!=this.scrollBarVisible&&(this.scrollBarVisible=!0,this.repaint())},handle_mouseout:function(a){0!=this.scrollBarVisible&&(this.scrollBarVisible=!1,this.repaint())},handleMouseUp:function(a){this.vBarDownPoint=null,this.hBarDownPoint=null,this.repaint()},handleMouseMove:function(a){var b={x:a.screenX,y:a.screenY},c=this.gl3dview.getCanvasSize(),d=this.gl3dview.getViewRect().height,e=this.gl3dview.getViewRect().width,f=this.getScrollBarWidth();if(null!=this.hBarDownPoint){var g=b.x-this.hBarDownPoint.x;return this.hBarDownPoint=b,void this.gl3dview.setViewOffSet(g*c.width/(e-f),0)}if(null!=this.vBarDownPoint){var h=b.y-this.vBarDownPoint.y;return this.vBarDownPoint=b,void this.gl3dview.setViewOffSet(0,h*c.height/(d-f))}},handleMouseWheel:function(a){var b=!1;a.wheelDelta!==a.wheelDeltaX?(a.wheelDelta?a.wheelDelta>0&&(b=!0):a.detail<0&&(b=!0),this.scrollYOffset(b)):(a.wheelDelta?a.wheelDelta>0&&(b=!0):a.detail<0&&(b=!0),this.scrollYOffset(b))},paintRoundRect:function(a,b,c,d,e,f,g,h){a.beginPath(),a.globalAlpha=c,a.fillStyle=b,Xb.drawRoundRect(a,d,e,f,g,h),a.fill()},paint:function(a){if(0!=this.gl3dview.isScrollBarVisible()&&(0!=this.scrollBarVisible||null!=this.hBarDownPoint||null!=this.vBarDownPoint)){var b=this.getScrollBarWidth(),c=this.gl3dview.getViewRect().height,d=this.gl3dview.getViewRect().width;

a.save();var e,f=this.getScrollBarColor();null!=this.hThumbRect&&(e=a.createLinearGradient(this.hThumbRect.x,this.hThumbRect.y,this.hThumbRect.x,this.hThumbRect.y+this.hThumbRect.height),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,0,c-b,d-b,b,b/2),this.paintRoundRect(a,e,.9,this.hThumbRect.x,this.hThumbRect.y+1,this.hThumbRect.width,this.hThumbRect.height-2,b/2)),null!=this.vThumbRect&&(e=a.createLinearGradient(this.vThumbRect.x,this.vThumbRect.y,this.vThumbRect.x+this.vThumbRect.width,this.vThumbRect.y),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,d-b,0,b,c-b,b/2),this.paintRoundRect(a,e,.9,this.vThumbRect.x+1,this.vThumbRect.y,this.vThumbRect.width-2,this.vThumbRect.height,b/2)),a.restore()}}}),Ib.canvas.interaction.DefaultInteraction=function(a){Ib.canvas.interaction.DefaultInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.DefaultInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove","keydown")},tearDown:function(){this.removeListener("mousedown","mousemove","keydown")},handle_mousedown:function(a){if(this.gl3dview.isValidEvent(a)){this.gl3dview.isFocusOnClick()&&Ib.Util.setFocus(this.gl3dview.getView());var b=this.gl3dview.getElementAt(a);2===a.detail?this.handleDoubleClicked(a,b):this.handleClicked(a,b)}},handleClicked:function(a,b){Cc.handleClicked(this.gl3dview,a,b)},handleDoubleClicked:function(a,b){Cc.handleDoubleClicked(this.gl3dview,a,b)},handle_keydown:function(a){Cc.handleKeyDown(this.gl3dview,a)},handle_mousemove:function(a){var b=this.gl3dview.getElementAt(a),c=this._preElement,d=Dc(c),e=Dc(b);c!==b&&(c&&(d&&d.onMouseLeave&&d.onMouseLeave(c,this.gl3dview),this.gl3dview.onMouseLeave(c,a)),b&&(e&&e.onMouseEnter&&e.onMouseEnter(b,this.gl3dview),this.gl3dview.onMouseEnter(b,a))),b&&e&&e.onMouseMove&&e.onMouseMove(b,this.gl3dview),this.gl3dview.onMouseMove(b,a),this._preElement=b}}),Ib.canvas.interaction.PanInteraction=function(a){Ib.canvas.interaction.PanInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.PanInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup"),this._oldCursor=this.gl3dview.getView().style.cursor},tearDown:function(){this.removeListener("mousedown","mouseup")},handle_mousedown:function(a){this.gl3dview.isValidEvent(a)&&(this.lastPoint=this.getMarkerPoint(a),this.lastPoint&&(this.addListener("mousemove"),this.gl3dview.getView().style.cursor="pointer"))},handle_mouseup:function(a){this._clear()},handle_mousemove:function(a){if(this.lastPoint){var b=this.getMarkerPoint(a);if(b){var c=b.x-this.lastPoint.x,d=b.y-this.lastPoint.y;this.gl3dview.panByOffset(-c,-d),this.lastPoint=b}}},_clear:function(a){this.lastPoint&&(this.lastPoint=null,this.gl3dview.getView().style.cursor=this._oldCursor,this.removeListener("mousemove"))}}),Ib.canvas.interaction.CreateElementInteraction=function(a,b){b||(b=Ib.Node),this.elementFunction=Ib.Util.isTypeOf(b,Ib.Node)?function(a){var c=new b;return c instanceof Ib.Node&&c.setCenterLocation(a),c}:b,Ib.canvas.interaction.CreateElementInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.CreateElementInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){var b=this.gl3dview.getLogicalPoint(a);if(b){var c=this.elementFunction(b);c&&this.gl3dview.addElementByInteraction(c)}}}),Ib.canvas.interaction.EditInteraction=function(a,b){this.lazyMode=b,this.pointIndex=-1,this.editPointSize=a.getEditPointSize(),this.resizePointSize=a.getResizePointSize(),this.rotatePointSize=a.getRotatePointSize(),Ib.canvas.interaction.EditInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.EditInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup","mousemove"),this.oldCursor=this.gl3dview.getView().style.cursor,this.gl3dview.setHasEditInteraction(!0),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup","mousemove"),this.gl3dview.getView().style.cursor=this.oldCursor,this.gl3dview.setHasEditInteraction(!1),this.clear(),this.gl3dview.removeMarker(this)},paint:function(a){if(1==this.lazyMode&&null!=this.resizingRect){a.lineWidth=this.gl3dview.getResizeLineWidth();var b=this.convertFromUIToMarkerRect(this.resizingRect,0,0);a.save(),Ib.Util.rotateCanvas(a,b,this.node.getAngle()),a.beginPath(),Md.rect(a,b.x,b.y,b.width,b.height,null,this.gl3dview.getResizeLineColor()),a.restore()}this.isStartRotate&&this.showRotateScale(a)},clear:function(){this.gl3dview.setEditingElement(!1),this.gl3dview.setRotatingElement(!1),this.isStart=!1,this.isStartRotate=!1,this.node=null,this.shapeNode=null,this.shapeLink=null,this.linkUI=null,this.resizingRect=null,this.resizeDirection=null,this.pointIndex=-1,this._removeCursor(),this.oldCursor=null,this.gl3dview.repaintTopCanvas()},_removeCursor:function(){this.cursorID&&(this.gl3dview.getView().style.cursor=this.oldCursor||"default",this.cursorID=null),this.resizeDirection=null,this.isCrossCursor=!1},_setCrossCursor:function(){this.isCrossCursor||(this._removeCursor(),this._setCursor("crosshair"),this.isCrossCursor=!0)},_setCursor:function(a){this.cursorID=a,this.gl3dview.getView().style.cursor!==this.cursorID&&(this.gl3dview.getView().style.cursor=this.cursorID)},handle_mousedown:function(a){if(0===a.button)if(!Jb.isAltDown(a)||this.gl3dview.isEditingElement())!this.gl3dview.isEditingElement()||this.isStart||this.isStartRotate||(this.node&&this.resizeDirection?(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:a,element:this.node,resizeDirection:this.resizeDirection})):this.shapeNode&&this.pointIndex>=0?Jb.isAltDown(a)?(this.shapeNode.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0?Jb.isAltDown(a)?(this.shapeLink.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.linkUI._element})):this.node&&(this.isStartRotate=!0,this._handle_mousedown(a)));else{var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getLogicalPoint(a);if(b instanceof Ib.ShapeNode){var d=this.getPointIndex(b.getPoints(),c,!0);d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeNode=b,b.addPoint(c,d),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}if(b instanceof Ib.ShapeLink){var e=new Ib.List(b.getPoints()),f=this.gl3dview.getElementUI(b);e.add(f.getFromPoint(),0),e.add(f.getToPoint());var d=this.getPointIndex(e,c)-1;d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeLink=b,b.addPoint(c,d),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}}},handle_mouseup:function(a){if(this.isStart){var b=this.gl3dview.getLogicalPoint(a);if(this.resizingRect)if(this.lazyMode)if(this.gl3dview.isResizeAnimate()){var c=this,d=new Ib.animate.AnimateBounds(this.node,this.resizingRect,function(){c.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:c.node,resizeDirection:c.resizeDirection})});Ib.animate.AnimateManager.start(d)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"liveResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.shapeNode&&this.pointIndex>=0&&b?(this.shapeNode.setPoint(this.pointIndex,b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0&&b?(this.shapeLink.setPoint(this.pointIndex,b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI&&b&&(this.linkUI.setControlPoint(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.linkUI._element}))}this._handle_mouseup(a),this.clear()},handle_mousemove:function(a){if(this.gl3dview.isValidEvent(a)){if(this.isStartRotate&&this.node)return this._handleRotateElement(a,this.node),void(this.gl3dview.isShowRotateScale()&&this.repaint());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0)return void this._handleMovingShapeNodePoint(a);if(this.shapeLink&&this.pointIndex>=0)return void this._handleMovingShapeLinkPoint(a);if(this.node&&this.resizeDirection)return void this._handleResizing(a);if(this.linkUI)return void this._handleMovingLinkControlPoint(a)}if(this.gl3dview.isSelectingElement()||this.gl3dview.isMovingElement()||0===this.gl3dview.getSelectionContainer().size())return void this.clear();var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getElementUI(b);if(!c||!c.getEditAttachment())return void this.clear();var d=this.gl3dview.getLogicalPoint(a);if(b instanceof Ib.Node){if(this.node=b,this._isEditingShapeNode(d)||this._isResizingNode(d))return void this.gl3dview.setEditingElement(!0);if(this._isRotatingElement(d))return this.gl3dview.setRotatingElement(!0),void this.gl3dview.setEditingElement(!0)}else if(b instanceof Ib.ShapeLink){if(this.shapeLink=b,this._isEditingShapeLink(d))return void this.gl3dview.setEditingElement(!0)}else if(c instanceof Ib.canvas.LinkUI&&xc.isOrthogonalLink(c._element)){this.linkUI=c;var e=this.linkUI.getControlPoint();return void(e&&this._contains(d,e,this.editPointSize)&&(this._setCrossCursor(),this.gl3dview.setEditingElement(!0)))}this.clear()}},_isRotatingElement:function(a){var b=this.gl3dview.getRotatePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle();return this._isRotating(a,"crosshair",c,d)},_isRotating:function(a,b,c,d){var e=this.gl3dview.getRotatePointSize(),f={x:c.x+c.width/2,y:c.y-this.gl3dview.getRotatePointOffset()-e},g=this._rotatePoint(f,d,c),h={x:g.x-e,y:g.y-e,width:2*e,height:2*e};return Tb.containsPoint(h,a)?(this._removeCursor(),this._setCursor(b),!0):!1},_handleRotateElement:function(a,b){this._handle_mousemove(a);var c=this._calculateAngle(this.gl3dview.getLogicalPoint(a),b);b.setAngle(c)},_calculateAngle:function(a,b){var c=b.getCenterLocation();return Math.round(180*Math.atan2(c.x-a.x,a.y-c.y)/Math.PI+180)},_handleMovingShapeNodePoint:function(a){var b=this.gl3dview.getLogicalPoint(a);this.shapeNode.setPoint(this.pointIndex,b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeNode,pointIndex:this.pointIndex})},_handleMovingShapeLinkPoint:function(a){var b=this.gl3dview.getLogicalPoint(a);this.shapeLink.setPoint(this.pointIndex,b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeLink,pointIndex:this.pointIndex})},_handleMovingLinkControlPoint:function(a){this.linkUI.setControlPoint(this.gl3dview.getLogicalPoint(a)),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.linkUI._element})},_handleResizing:function(a){this._handle_mousemove(a);var b=this.node.getAngle(),c=this.node.getLocation(),d=this.node.getWidth()/2,e=this.node.getHeight()/2,f={x:c.x+d,y:c.y+e},g={x:-d,y:-e},h={x:-d,y:e},i={x:d,y:e},j={x:d,y:-e},k={x:0,y:-e},l={x:d,y:0},m={x:0,y:e},n={x:-d,y:0};if("northwest"===this.resizeDirection&&(this._transformPoint(i,f,b),g.x=this._endLogical.x,g.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),"north"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),k.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}if("northeast"===this.resizeDirection&&(this._transformPoint(h,f,b),j.x=this._endLogical.x,j.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"west"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),n.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("east"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),l.x=o.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("southwest"===this.resizeDirection&&(this._transformPoint(j,f,b),h.x=this._endLogical.x,h.y=this._endLogical.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"south"===this.resizeDirection){var o={x:this._endLogical.x,y:this._endLogical.y};this._reversPoint(o,f,b),m.y=o.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}"southeast"===this.resizeDirection&&(this._transformPoint(g,f,b),i.x=this._endLogical.x,i.y=this._endLogical.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),this.lazyMode?(this.repaint(),this.gl3dview.fireInteractionEvent({kind:"lazyResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection})):(this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"liveResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection}))},_isEditingShapeNode:function(a){if(this.node instanceof Ib.ShapeNode){this.shapeNode=this.node;for(var b=this.shapeNode.getPoints(),c=0,d=b.size();d>c;c++){var e=b.get(c);if(this._contains(a,e,this.editPointSize))return this._setCrossCursor(),this.pointIndex=c,!0}}return this.pointIndex=-1,!1},_isEditingShapeLink:function(a){for(var b=this.shapeLink.getPoints(),c=0,d=b.size();d>c;c++){var e=b.get(c);if(this._contains(a,e,this.editPointSize))return this._setCrossCursor(),this.pointIndex=c,!0}return this.pointIndex=-1,!1},_isResizingNode:function(a){var b=this.gl3dview.getResizePointSize();if(0>=b)return!1;var c=this.node.getOriginalRect(),d=this.node.getAngle(),e={x:c.x,y:c.y},f=this._rotatePoint(e,d,c);return this._isResizing(a,f.x,f.y,"northwest","nwse-resize")?!0:(e={x:c.x+c.width/2,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"north","ns-resize")?!0:(e={x:c.x+c.width,y:c.y},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"northeast","nesw-resize")?!0:(e={x:c.x,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"west","ew-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height/2},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"east","ew-resize")?!0:(e={x:c.x,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southwest","nesw-resize")?!0:(e={x:c.x+c.width/2,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"south","ns-resize")?!0:(e={x:c.x+c.width,y:c.y+c.height},f=this._rotatePoint(e,d,c),this._isResizing(a,f.x,f.y,"southeast","nwse-resize")?!0:!1)))))))},_rotatePoint:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_isResizing:function(a,b,c,d,e){return this._contains(a,{x:b,y:c},this.resizePointSize)?(this.resizeDirection!==d&&(this._removeCursor(),e=this._changeCursorWithAngle(d,this.node.getAngle()),this._setCursor(e),this.resizeDirection=d),!0):!1},_getRect:function(a,b,c,d){var e=c>a?a:c,f=d>b?b:d,g=Math.abs(a-c),h=Math.abs(b-d);return{x:e,y:f,width:g,height:h}},_contains:function(a,b,c){var d={x:b.x-c,y:b.y-c,width:2*c,height:2*c};return Tb.containsPoint(d,a)},getPointIndex:function(a,b,c){if(a.size()<2)return 0;for(var d,e=a.get(0),f=1;f<a.size();f++){if(d=a.get(f),this.isPointOnLine(b,e,d,6))return f;e=d}return e=a.get(0),c&&this.isPointOnLine(b,e,d,6)?a.size():0},showRotateScale:function(a){var b,c,d,e,f,g=(new Ib.List,this.gl3dview.getRotateScaleWidth()),h=this.gl3dview.getRotateScaleHeight(),i=this.gl3dview.getRotatePointSize(),j=this.node.getAngle(),k=this.node.getOriginalRect(),l={x:k.x+k.width/2,y:k.y-this.gl3dview.getRotatePointOffset()-i},m=this._rotatePoint(l,j,k),n="13px Arial",o=j+"°";this.node.getAngle()>=0&&this.node.getAngle()<=180?(c={x:m.x+i,y:m.y},d={x:c.x+g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y}):this.node.getAngle()>180&&this.node.getAngle()<=360&&(c={x:m.x-i,y:m.y},d={x:c.x-g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y});var p=new Ib.List([c,d,e,f]),b=Jb.math.getRect(p);a.fillStyle=this.gl3dview.getRotateScaleFillColor(),a.fillRect(b.x,b.y,b.width,b.height),a.fillStyle=this.gl3dview.getRotateScaleFontColor(),a.textBaseline="middle",a.textAlign="center",a.font=n,a.fillText(o,b.x+b.width/2,b.y+b.height/2)},isPointOnLine:function(a,b,c,d){0>d&&(d=0);var e=this.getDistanceFromPointToLine(a,b,c);return d>=e&&a.x>=Math.min(b.x,c.x)-d&&a.x<=Math.max(b.x,c.x)+d&&a.y>=Math.min(b.y,c.y)-d&&a.y<=Math.max(b.y,c.y)+d},getDistanceFromPointToLine:function(a,b,c){if(b.x===c.x)return Math.abs(a.x-b.x);var d=(c.y-b.y)/(c.x-b.x),e=(c.x*b.y-b.x*c.y)/(c.x-b.x);return Math.abs(d*a.x-a.y+e)/Math.sqrt(d*d+1)},_transformPoint:function(a,b,c){var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x,g=a.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_reversPoint:function(a,b,c){c*=-1;var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x-b.x,g=a.y-b.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_changeCursorWithAngle:function(a,b){var c,d=["auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];switch(a){case"northwest":c=1;break;case"north":c=2;break;case"northeast":c=3;break;case"east":c=4;break;case"southeast":c=5;break;case"south":c=6;break;case"southwest":c=7;break;case"west":c=8;break;default:c=0}return(b>=360||-360>=b)&&(b%=360),b>22.5&&67.5>=b&&(c+=1),-22.5>b&&b>=-67.5&&(c-=1),b>67.5&&112.5>=b&&(c+=2),-67.5>b&&b>=-112.5&&(c-=2),b>112.5&&157.5>=b&&(c+=3),-112.5>b&&b>=-157.5&&(c-=3),b>157.5&&202.5>=b&&(c+=4),-157.5>b&&b>=-202.5&&(c-=4),b>202.5&&247.5>=b&&(c+=5),-202.5>b&&b>=-247.5&&(c-=5),b>247.5&&292.5>=b&&(c+=6),-247.5>b&&b>=-292.5&&(c-=6),b>292.5&&337.5>=b&&(c+=7),-292.5>b&&b>=-337.5&&(c-=7),c>8&&(c-=8),0>=c&&(c+=8),d[c]}}),Ib.canvas.interaction.CreateLinkInteraction=function(a,b){b||(b=Ib.Link),this.linkFunction=Ib.Util.isTypeOf(b,Ib.Link)?function(a,c){var d=new b;return d instanceof Ib.Link&&(d.setFromNode(a),d.setToNode(c)),d}:b,Ib.canvas.interaction.CreateLinkInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.CreateLinkInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.gl3dview.removeMarker(this)},paint:function(a){a.beginPath();var b,c;a.lineWidth=this.gl3dview.getEditLineWidth();var d=this.gl3dview.getEditLineColor();this.currentNode&&this.currentNode!==this.fromNode&&(b=this.gl3dview.getElementUI(this.currentNode).getViewRect(),c=this.convertFromUIToMarkerRect(b,0,0),Md.rect(a,c.x,c.y,c.width,c.height,null,d)),this.fromNode&&(b=this.gl3dview.getElementUI(this.fromNode).getViewRect(),c=this.convertFromUIToMarkerRect(b,0,0),Md.rect(a,c.x,c.y,c.width,c.height,null,d)),this.currentPoint&&this.paintLine(a),a.closePath()},paintLine:function(a){var b=this.gl3dview.getEditLineColor(),c=this.convertPointFromView(this.fromNode.getCenterLocation()),d=c.x,e=c.y,f=this.currentPoint.x,g=this.currentPoint.y;a.strokeStyle=b,a.beginPath(),a.moveTo(d,e),a.lineTo(f,g),a.stroke()},clear:function(){this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null},createLink:function(){return this.linkFunction(this.fromNode,this.toNode)},handle_mousedown:function(a){if(this.gl3dview.isValidEvent(a))if(this.fromNode){if(this.toNode=this.currentNode,this.toNode){var b=this.createLink();b&&this.gl3dview.addElementByInteraction(b)}this.clear()}else this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.repaint()},handle_mousemove:function(a){var b=this.getMarkerPoint(a);if(b){if(this.gl3dview.isMovingElement()||this.gl3dview.isEditingElement())return void this.clear();var c=null;this.fromNode?(this.currentNode=this.getToNode(a),this.currentPoint=b,this.repaint()):(c=this.getFromNode(a),this.currentNode!==c&&(this.currentNode=c,this.repaint()))}},getFromNode:function(a){return this.getNode(a)},getToNode:function(a){return this.getNode(a)},getNode:function(a){var b=this.gl3dview.getElementAt(a);return b instanceof Jd&&this.gl3dview.isLinkable(b)?b:null}}),Ib.canvas.interaction.CreateShapeLinkInteraction=function(a,b){Ib.canvas.interaction.CreateShapeLinkInteraction.superClass.constructor.call(this,a),b||(b=Ib.ShapeLink),this.linkFunction=Ib.Util.isTypeOf(b,Ib.ShapeLink)?function(a,c,d){var e=new b;return e instanceof Ib.ShapeLink&&(e.setFromNode(a),e.setToNode(c),d&&e.setPoints(d)),e}:b},Jb.ext("twaver.canvas.interaction.CreateShapeLinkInteraction",Ib.canvas.interaction.CreateLinkInteraction,{clear:function(){this.points=null,Ib.canvas.interaction.CreateShapeLinkInteraction.superClass.clear.call(this)},createLink:function(){return this.linkFunction(this.fromNode,this.toNode,this.points)},handle_mousedown:function(a){if(0===a.button){var b=this.gl3dview.getLogicalPoint(a);if(b){if(this.fromNode)if(this.toNode=this.currentNode,this.toNode){var c=this.createLink();c&&this.gl3dview.addElementByInteraction(c),this.clear()}else{if(this.points||(this.points=new Ib.List),this.points.size()>0){var d=this.points.get(this.points.size()-1);if(d.x===b.x&&d.y===b.y)return}this.points.add(b)}else this.fromNode=this.currentNode,this.points=null,this.currentNode=null,this.currentPoint=null;this.repaint()}}},paintLine:function(a){if(this.currentPoint){var b,c=new Ib.List;if(b=this.convertPointFromView(this.fromNode.getCenterLocation()),c.add(b,0),this.points&&this.points.size()>0)for(var d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.currentPoint,c.add(b),a.lineWidth=this.gl3dview.getEditLineWidth(),a.strokeStyle=this.gl3dview.getEditLineColor(),a.beginPath(),Xb.drawLinePoints(a,c),a.stroke()}}}),Ib.canvas.interaction.CreateShapeNodeInteraction=function(a,b){b||(b=Ib.ShapeNode),this.shapeNodeFunction=Ib.Util.isTypeOf(b,Ib.ShapeNode)?function(a){var c=new b;return c instanceof Ib.ShapeNode&&a&&c.setPoints(a),c}:b,Ib.canvas.interaction.CreateShapeNodeInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.CreateShapeNodeInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.gl3dview.removeMarker(this),this.gl3dview.setEditingElement(!1)},clear:function(){this.points=null,this.currentPoint=null},paint:function(a){if(this.points&&this.points.size()>0&&this.currentPoint){for(var b,c=new Ib.List,d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.convertPointFromView(this.currentPoint),c.add(b),a.lineWidth=this.gl3dview.getEditLineWidth(),a.strokeStyle=this.gl3dview.getEditLineColor(),a.beginPath(),Xb.drawLinePoints(a,c),a.stroke()}},handle_mousedown:function(a){if(0===a.button){var b=this.gl3dview.getLogicalPoint(a);if(b){if(2===a.detail){if(this.points){var c=this.shapeNodeFunction(this.points);this.gl3dview.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.gl3dview.setEditingElement(!1)},0)}}else{if(this.gl3dview.isEditingElement()||this.gl3dview.setEditingElement(!0),this.points||(this.points=new Ib.List),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return}this.points.add(b)}this.repaint()}}},handle_mousemove:function(a){this.points&&(this.currentPoint=this.gl3dview.getLogicalPoint(a),this.repaint())}}),Ib.canvas.interaction.MagnifyInteraction=function(a,b,c,d,e){Ib.canvas.interaction.MagnifyInteraction.superClass.constructor.call(this,a),this.zoom=b||2,this.xRadius=c||100,this.yRadius=d||100,this.shape=e||"circle",this.borderColor="black",this.borderWidth=1,this.backgroundColor="white",this.markCanvas=Wb.createCanvas()},Jb.ext("twaver.canvas.interaction.MagnifyInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){this.addListener("mousemove"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousemove"),this.gl3dview.removeMarker(this)},paint:function(a){if(this.point){var b=this.gl3dview._zoom,c=this.zoom*b,d=this.point.x*b-this.gl3dview.viewRect.x-this.xRadius,e=this.point.y*b-this.gl3dview.viewRect.y-this.yRadius,f=2*this.xRadius,g=2*this.yRadius,h={x:this.point.x-this.xRadius/c,y:this.point.y-this.yRadius/c,width:f/c,height:g/c},i=this.borderWidth,j=Wb.createCanvas();j.width=f,j.height=g,this.gl3dview.toCanvasByRegion(h,c,j),a.save(),a.beginPath(),Xb.drawVector(a,this.shape,null,d,e,f,g),a.clip(),a.fillStyle=this.backgroundColor,a.beginPath(),a.rect(d,e,f,g),a.fill(),a.drawImage(j,d,e),a.restore(),a.beginPath(),a.lineWidth=i,Xb.drawVector(a,this.shape,null,d+i/2,e+i/2,f-i,g-i),a.strokeStyle=this.borderColor,a.stroke()}},handle_mousemove:function(a){this.point=this.gl3dview.getLogicalPoint(a),this.point&&this.repaint()},getZoom:function(){return this.zoom},setZoom:function(a){this.zoom=a,this.gl3dview.repaintTopCanvas()},getShape:function(){return this.shape},setShape:function(a){this.shape=a,this.gl3dview.repaintTopCanvas()},getXRadius:function(){return this.xRadius},setXRadius:function(a){this.xRadius=a,this.gl3dview.repaintTopCanvas()},getYRadius:function(){return this.yRadius},setYRadius:function(a){this.yRadius=a,this.gl3dview.repaintTopCanvas()},getBorderColor:function(){return this.borderColor},setBorderColor:function(a){this.borderColor=a,this.gl3dview.repaintTopCanvas()},getBorderWidth:function(){return this.borderWidth},setBorderWidth:function(a){this.borderWidth=a,this.gl3dview.repaintTopCanvas()},getBackgroundColor:function(){return this.backgroundColor},setBackgroundColor:function(a){this.backgroundColor=a,this.gl3dview.repaintTopCanvas()}}),Ib.canvas.interaction.TouchInteraction=function(a){Ib.canvas.interaction.TouchInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.canvas.interaction.TouchInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){var a=this.gl3dview.getView();Wb.addEventListener("touchstart","handleTouchstart",a,this),Wb.addEventListener("touchmove","handleTouchmove",a,this),Wb.addEventListener("touchend","handleTouchend",a,this),Wb.addEventListener("touchcancel","handleTouchend",a,this),this.gl3dview.addMarker(this)},tearDown:function(){var a=this.gl3dview.getView();Wb.removeEventListener("touchstart",this.gl3dview.getView(),this),Wb.removeEventListener("touchmove",a,this),Wb.removeEventListener("touchend",a,this),Wb.removeEventListener("touchcancel",a,this),this.gl3dview.removeMarker(this)},handleTouchstart:function(a){if(Wb.preventDefault(a),a.touches&&1==a.touches.length){var b=this.gl3dview.getLogicalPoint(a),c=this.gl3dview.getElementAt(b);this._startTouchTime=new Date,this._startTouchPoint=b,this._startTouchClient=this.getMarkerPoint(a),c?(this._haveElementUnderTouch=!0,this._startTouchElement=c):(this._haveElementUnderTouch=!1,this._startTouchElement=null),this.timer=setTimeout(function(){Cc.handleLongClicked(self.gl3dview,a,c)},1e3)}else a.touches&&2==a.touches.length&&(this._distance=zc.getDistance(a),this._zoom=this.gl3dview.getZoom());this._touchCount=a.touches.length},handleTouchmove:function(a){if(Wb.preventDefault(a),2==this._touchCount&&a.touches&&2==a.touches.length)if(this.timer&&clearTimeout(this.timer),Math.abs(this._distance-zc.getDistance(a))>=Cd.TOUCH_ZOOM_THRESHOLD||this._zoomFlag){this._zoomFlag=!0;var b=zc.getDistance(a)/this._distance;this.gl3dview.setTouchZoom(this._zoom*b,!1)}else{var c=this.getMarkerPoint(a),d=this._startTouchClient.x-c.x,e=this._startTouchClient.y-c.y;this.gl3dview.panByOffset(d,e),this._startTouchClient=c}else if(1==this._touchCount&&a.touches&&1==a.touches.length)if(this._haveElementUnderTouch||!this.gl3dview.isRectSelectEnabled()){var f=this.gl3dview.getLogicalPoint(a),g=this.gl3dview.getElementAt(f);if(this.gl3dview.isMovingElement()||null!=this._startTouchElement&&this._startTouchElement==g&&this.gl3dview.getMovableSelectedElements().contains(g)){var d=f.x-this._startTouchPoint.x,e=f.y-this._startTouchPoint.y;(Math.abs(d)>=Cd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Cd.TOUCH_MOVE_THRESHOLD)&&(this._startTouchPoint=f,this.gl3dview.moveSelectedElements(d,e),this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}),this.timer&&clearTimeout(this.timer)))}else{var d=f.x-this._startTouchPoint.x,e=f.y-this._startTouchPoint.y;(Math.abs(d)>=Cd.TOUCH_MOVE_THRESHOLD||Math.abs(e)>=Cd.TOUCH_MOVE_THRESHOLD)&&this.timer&&clearTimeout(this.timer);var c=this.getMarkerPoint(a),d=this._startTouchClient.x-c.x,e=this._startTouchClient.y-c.y;this.gl3dview.panByOffset(d,e),this._startTouchClient=c}}else{var h=this.gl3dview.getLogicalPoint(a);if(!h)return;var d=h.x-this._startTouchPoint.x,e=h.y-this._startTouchPoint.y;Math.abs(d)>=Cd.TOUCH_RECT_SELECT_THRESHOLD&&Math.abs(e)>=Cd.TOUCH_RECT_SELECT_THRESHOLD&&(this.gl3dview.setSelectingElement(!0),this._moveTouchPoint?this.gl3dview.fireInteractionEvent({kind:"selectBetween",event:a}):(this.gl3dview.fireInteractionEvent({kind:"selectStart",event:a}),this.timer&&clearTimeout(this.timer)),this._moveTouchPoint=h,this.repaint())}},handleTouchend:function(a){if(Wb.preventDefault(a),this.gl3dview.isMovingElement())this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a});else if(this.gl3dview.isSelectingElement()){var b=Tb.getRect([this._startTouchPoint,this._moveTouchPoint]),c=this.gl3dview.getElementsAtRect(b,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(c&&c.size()>0){var d=this.gl3dview.getSelectionContainer(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a);

},this),d.setSelection(e)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:a}),this._moveTouchPoint=null,this.gl3dview.setSelectingElement(!1),this.repaint()}else if(this._startTouchPoint){this._zoomFlag=!1;var f=new Date,g=this.gl3dview.getLogicalPoint(a),h=this.gl3dview.getElementAt(this._startTouchPoint);g&&f.getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,g)<=20&&(h?this.gl3dview.getSelectionContainer().contains(h)||this.gl3dview.getSelectionContainer().setSelection(h):this.gl3dview.getSelectionContainer().clearSelection(),Cc.handleClicked(this.gl3dview,a,h),this.timer&&clearTimeout(this.timer),this._endTouchTime&&f.getTime()-this._endTouchTime.getTime()<=500&&Tb.getDistance(this._endTouchPoint,g)<=20?(delete this._endTouchTime,delete this._endTouchPoint,Cc.handleDoubleClicked(this.gl3dview,a,h)):(this._endTouchTime=f,this._endTouchPoint=g))}},paint:function(a){if(this._startTouchPoint&&this._moveTouchPoint){var b=this.convertPointFromView(this._startTouchPoint),c=this.convertPointFromView(this._moveTouchPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Tb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.gl3dview.getSelectOutlineWidth(),j=this.getIntersectMode()?this.gl3dview.getSelectFillColor():null;a.strokeStyle=this.gl3dview.getSelectOutlineColor(),a.lineWidth=i,Md.rect(a,h.x,h.y,h.width,h.height,j,this.gl3dview.getSelectOutlineColor()),a.closePath()}}},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y}}),Ib.canvas.interaction.MSTouchInteraction=function(a){Ib.canvas.interaction.MSTouchInteraction.superClass.constructor.call(this,a),this._pointerMap={},this._pointerIdArray=[]},Jb.ext("twaver.canvas.interaction.MSTouchInteraction",Ib.canvas.interaction.BaseInteraction,{setUp:function(){var a=this.gl3dview.getView();Wb.addEventListener("MSPointerDown","handleTouchstart",a,this),Wb.addEventListener("MSPointerMove","handleTouchmove",a,this),Wb.addEventListener("MSPointerUp","handleTouchend",a,this),Wb.addEventListener("MSPointerCancel","handleTouchend",a,this),this.gl3dview.addMarker(this)},tearDown:function(){var a=this.gl3dview.getView();Wb.removeEventListener("MSPointerDown",a,this),Wb.removeEventListener("MSPointerMove",a,this),Wb.removeEventListener("MSPointerUp",a,this),Wb.removeEventListener("MSPointerCancel",a,this),this.gl3dview.removeMarker(this)},handleTouchstart:function(a){if(this.gl3dview.isFocusOnClick()&&Ib.Util.setFocus(this.gl3dview._view),!this.gl3dview.isSelectingElement()||a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.gl3dview.getLogicalPoint(a),c=new Date;if(a.isPrimary&&this._pointerIdArray.length>0&&this.handle_mouseup(a),this._pointerMap[a.pointerId]||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length){var d=this.gl3dview.getElementAt(b);this._startTouchElement=d,this._startClientPoint={x:a.clientX,y:a.clientY},Cc.handleClicked(this.gl3dview,a,d),this._startTouchTime&&this._startTouchPoint&&c.getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,b)<=20?(Cc.handleDoubleClicked(this.gl3dview,a,d),this._doubleClick=!0):(Wb.handle_mousedown(this,a),this._startTouchPoint=b,this._startTouchTime=c);var e=this.gl3dview.getSelectionContainer();d?Jb.isCtrlDown(a)?e.contains(d)?e.removeSelection(d):e.appendSelection(d):e.contains(d)||e.setSelection(d):Jb.isCtrlDown(a)||e.clearSelection()}else 2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.gl3dview.getZoom())}},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance;this.gl3dview.setZoom(this._zoom*b,!1)}},handleTouchend:function(a){if(this.gl3dview.isMovingElement()&&(this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a})),this.gl3dview.isSelectingElement()){var b=Tb.getRect([this._startTouchPoint,this._moveTouchPoint]),c=this.gl3dview.getElementsAtRect(b,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(c&&c.size()>0){var d=this.gl3dview.getSelectionContainer(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a)},this),d.setSelection(e)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:a}),this._moveTouchPoint=null,this.gl3dview.setSelectingElement(!1),this.repaint()}this._doubleClick&&(delete this._doubleClick,delete this._startTouchPoint,delete this._startTouchTime);for(var f=-1,g=0;g<this._pointerIdArray.length;g++)if(this._pointerIdArray[g]==a.pointerId){f=g;break}f>=0&&this._pointerIdArray.splice(f,1),delete this._pointerMap[a.pointerId],this._startTouchPoint=null,this._moveTouchPoint=null},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y},handle_mousemove:function(a){var b={x:a.clientX,y:a.clientY};if(!(Tb.getDistance(this._startClientPoint,b)<3)&&this._startTouchPoint&&1==this._pointerIdArray.length)if(this._moveTouchPoint={x:this._startTouchPoint.x+(b.x-this._startClientPoint.x)/this.gl3dview.getZoom(),y:this._startTouchPoint.y+(b.y-this._startClientPoint.y)/this.gl3dview.getZoom()},null==this._startTouchElement&&this.gl3dview.isRectSelectEnabled()){var c=this.gl3dview.getLogicalPoint(a);if(!c)return;this.gl3dview.setSelectingElement(!0),this.gl3dview.fireInteractionEvent(this._moveTouchPoint?{kind:"selectBetween",event:a}:{kind:"selectStart",event:a}),this.repaint()}else{var d=this.gl3dview.getElementAt(this._moveTouchPoint);if(null!=this._startTouchElement||this.gl3dview.isRectSelectEnabled()){if(this.gl3dview.isMovingElement()||null!=this._startTouchElement&&d==this._startTouchElement&&this.gl3dview.getMovableSelectedElements().contains(d)){var e=this._moveTouchPoint.x-this._startTouchPoint.x,f=this._moveTouchPoint.y-this._startTouchPoint.y;this.gl3dview.moveSelectedElements(e,f),this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}))}}else{var e=this._startClientPoint.x-b.x,f=this._startClientPoint.y-b.y;this.gl3dview.panByOffset(e,f)}this._startClientPoint=b}},handle_mouseup:function(a){this.handleTouchend(a),this._pointerIdArray=[],this._pointerMap={}},paint:function(a){if(this._startTouchPoint&&this._moveTouchPoint&&!this._startTouchElement&&this.gl3dview.isRectSelectEnabled()){var b=this.convertPointFromView(this._startTouchPoint),c=this.convertPointFromView(this._moveTouchPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Tb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.gl3dview.getSelectOutlineWidth(),j=this.getIntersectMode()?this.gl3dview.getSelectFillColor():null;a.strokeStyle=this.gl3dview.getSelectOutlineColor(),a.lineWidth=i,Md.rect(a,h.x,h.y,h.width,h.height,j,this.gl3dview.getSelectOutlineColor()),a.closePath()}}}});var Nd=function(a,b){Jb.registerImage(a,b),Od[a]=1},Od={};Nd("node_image",{w:32,h:24,origin:{x:0,y:0},v:[{shape:"path",data:"M32,23.5c0,0.276-0.224,0.5-0.5,0.5h-31C0.224,24,0,23.776,0,23.5v-2C0,21.224,0.224,21,0.5,21h31  c0.276,0,0.5,0.224,0.5,0.5V23.5z",gradient:{id:"SVGID_1_",type:"linear",x1:"15.9995",y1:"21",x2:"15.9995",y2:"24",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M15,22.3c0-0.165-0.134-0.3-0.3-0.3H3.3C3.134,22,3,22.135,3,22.3V24h12V22.3z",gradient:{id:"SVGID_2_",type:"linear",x1:"9",y1:"22",x2:"9",y2:"25",stop:[{offset:"0",color:"#69B4A5"},{offset:"0.1",color:"#61AD9C"}]}},{shape:"path",data:"M31,20H1V1c0-0.553,0.448-1,1-1h28c0.553,0,1,0.447,1,1V20z",gradient:{id:"SVGID_3_",type:"linear",x1:"15.9995",y1:"-0.1221",x2:"15.9995",y2:"19.9471",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:1,w:28,h:18,fill:"#FFFFFF"},{shape:"rect",x:3,y:2,w:26,h:16,gradient:{id:"SVGID_4_",type:"linear",x1:"15.9995",y1:"2.0654",x2:"15.9995",y2:"17.3835",stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#0089C1"}]}},{shape:"path",data:"9.649,17.034 6.815,17.034 9.935,2.966 12.768,2.966 z",fill:"#FFFFFF"},{shape:"path",data:"12.065,17.034 10.815,17.034 13.935,2.966 15.185,2.966 z",fill:"#FFFFFF"},{shape:"path",data:"14.065,17.034 13.315,17.034 16.435,2.966 17.185,2.966 z",fill:"#FFFFFF"}]}),Nd("group_image",{w:32,h:24,origin:{x:0,y:0},v:[{shape:"path",data:"M32,16.5c0,0.276-0.224,0.5-0.5,0.5h-24C7.224,17,7,16.776,7,16.5v-1C7,15.224,7.224,15,7.5,15h24   c0.276,0,0.5,0.224,0.5,0.5V16.5z",gradient:{id:"SVGID_1_",type:"linear",x1:"19.5",y1:"15",x2:"19.5",y2:"17",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M19,16.5c0-0.277-0.224-0.5-0.5-0.5h-8c-0.276,0-0.5,0.223-0.5,0.5V17h9V16.5z",gradient:{id:"SVGID_2_",type:"linear",x1:"14.4995",y1:"15.9209",x2:"14.4995",y2:"17.0459",stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M31,14H8V1c0-0.553,0.448-1,1-1h21c0.553,0,1,0.447,1,1V14z",gradient:{id:"SVGID_3_",type:"linear",x1:"19.5",y1:"0",x2:"19.5",y2:"14.0005",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:9,y:1,w:21,h:12,fill:"#FFFFFF"},{shape:"rect",x:10,y:2,w:19,h:10,gradient:{id:"SVGID_4_",type:"linear",x1:"19.5",y1:"1.9619",x2:"19.5",y2:"11.9744",stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M25,23.5c0,0.276-0.224,0.5-0.5,0.5h-24C0.224,24,0,23.776,0,23.5v-1C0,22.224,0.224,22,0.5,22h24   c0.276,0,0.5,0.224,0.5,0.5V23.5z",gradient:{id:"SVGID_5_",type:"linear",x1:"12.4995",y1:"22",x2:"12.4995",y2:"24",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M12,23.5c0-0.277-0.224-0.5-0.5-0.5h-8C3.224,23,3,23.223,3,23.5V24h9V23.5z",gradient:{id:"SVGID_6_",type:"linear",x1:"7.5",y1:"22.9209",x2:"7.5",y2:"24.0459",stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M24,21H1V8c0-0.553,0.448-1,1-1h21c0.553,0,1,0.447,1,1V21z",gradient:{id:"SVGID_7_",type:"linear",x1:"12.4995",y1:"7",x2:"12.4995",y2:"21.0005",stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:8,w:21,h:12,fill:"#FFFFFF"},{shape:"rect",x:3,y:9,w:19,h:10,gradient:{id:"SVGID_8_",type:"linear",x1:"12.4995",y1:"8.9619",x2:"12.4995",y2:"18.9749",stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#0089C1"}]}}]}),Nd("subgl3dview_image",{w:32,h:24,origin:{x:0,y:0},v:[{shape:"path",data:"M32,14.499c0,0.276-0.224,0.5-0.5,0.5h-20c-0.276,0-0.5-0.224-0.5-0.5v-1c0-0.276,0.224-0.5,0.5-0.5  h20c0.276,0,0.5,0.224,0.5,0.5V14.499z",gradient:{id:"SVGID_1_",type:"linear",x1:21.5,y1:12.999,x2:21.5,y2:14.9995,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M22,14.499c0-0.277-0.224-0.5-0.5-0.5h-7c-0.276,0-0.5,0.223-0.5,0.5v0.5h8V14.499z",gradient:{id:"SVGID_2_",type:"linear",x1:18,y1:13.9199,x2:18,y2:15.0449,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M31,11.499c0,0.276-0.224,0.5-0.5,0.5h-18c-0.276,0-0.5-0.224-0.5-0.5v-11c0-0.276,0.224-0.5,0.5-0.5  h18c0.276,0,0.5,0.224,0.5,0.5V11.499z",gradient:{id:"SVGID_3_",type:"linear",x1:21.5,y1:-.9502,x2:21.5,y2:12.5498,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:13,y:.999,w:17,h:10,fill:"#FFFFFF"},{shape:"rect",x:14,y:1.999,w:15,h:8,gradient:{id:"SVGID_4_",type:"linear",x1:21.5,y1:1.9312,x2:21.5,y2:9.6537,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M21,23.5c0,0.276-0.224,0.5-0.5,0.5h-20C0.224,24,0,23.776,0,23.5v-1C0,22.224,0.224,22,0.5,22h20  c0.276,0,0.5,0.224,0.5,0.5V23.5z",gradient:{id:"SVGID_5_",type:"linear",x1:10.4995,y1:22,x2:10.4995,y2:24,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:22,y:20.5,w:3,h:1.999,gradient:{id:"SVGID_6_",type:"linear",x1:-464.9424,y1:-722.2754,x2:-462.9424,y2:-722.2754,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"rect",x:28,y:16,w:2,h:3,gradient:{id:"SVGID_7_",type:"linear",x1:29,y1:16,x2:29,y2:19,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M11,23.5c0-0.277-0.224-0.5-0.5-0.5h-7C3.224,23,3,23.223,3,23.5V24h8V23.5z",gradient:{id:"SVGID_8_",type:"linear",x1:7,y1:22.9209,x2:7,y2:24.0459,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M20,20.5c0,0.276-0.224,0.5-0.5,0.5h-18C1.224,21,1,20.776,1,20.5v-11C1,9.224,1.224,9,1.5,9h18  C19.776,9,20,9.224,20,9.5V20.5z",gradient:{id:"SVGID_9_",type:"linear",x1:10.4995,y1:8.0508,x2:10.4995,y2:21.5513,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:10,w:17,h:10,fill:"#FFFFFF"},{shape:"rect",x:3,y:11,w:15,h:8,gradient:{id:"SVGID_10_",type:"linear",x1:10.4995,y1:10.9321,x2:10.4995,y2:18.6551,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#0089C1"}]}},{shape:"path",data:"M32,22.7c0,0.165-0.135,0.3-0.301,0.3h-5.4C26.134,23,26,22.865,26,22.7v-2.4  c0-0.165,0.134-0.3,0.299-0.3h5.4C31.865,20,32,20.135,32,20.3V22.7z",gradient:{id:"SVGID_11_",type:"linear",x1:29,y1:20,x2:29,y2:23,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}}]}),Nd("bus_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"rect",x:4,y:6,w:1,h:1,fill:"#232424"},{shape:"path",data:"M7,4c0,0.552-0.448,1-1,1H3C2.448,5,2,4.552,2,4V3c0-0.552,0.448-1,1-1h3c0.552,0,1,0.448,1,1V4z",gradient:{id:"SVGID_1_",type:"linear",x1:4.5,y1:2,x2:4.5,y2:5,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:3,y:3,w:3,h:1,fill:"#232424"},{shape:"rect",x:3,y:3,w:3,h:1,fill:"#FFFFFF"},{shape:"path",data:"M6,5.5C6,5.776,5.776,6,5.5,6h-2C3.224,6,3,5.776,3,5.5l0,0C3,5.224,3.224,5,3.5,5h2  C5.776,5,6,5.224,6,5.5L6,5.5z",gradient:{id:"SVGID_2_",type:"linear",x1:4.5,y1:6,x2:4.5,y2:5,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:12,y:6,w:1,h:1,fill:"#232424"},{shape:"path",data:"M15,4c0,0.552-0.447,1-1,1h-3c-0.553,0-1-0.448-1-1V3c0-0.552,0.447-1,1-1h3c0.553,0,1,0.448,1,1V4z",gradient:{id:"SVGID_3_",type:"linear",x1:12.5,y1:2,x2:12.5,y2:5,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:11,y:3,w:3,h:1,fill:"#232424"},{shape:"rect",x:11,y:3,w:3,h:1,fill:"#FFFFFF"},{shape:"path",data:"M14,5.5C14,5.776,13.777,6,13.5,6h-2C11.225,6,11,5.776,11,5.5l0,0C11,5.224,11.225,5,11.5,5h2  C13.777,5,14,5.224,14,5.5L14,5.5z",gradient:{id:"SVGID_4_",type:"linear",x1:12.5,y1:6,x2:12.5,y2:5,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:8,y:10,w:1,h:1,fill:"#232424"},{shape:"path",data:"M6,13c0-0.553,0.448-1,1-1h3c0.553,0,1,0.447,1,1v1c0,0.553-0.447,1-1,1H7c-0.552,0-1-0.447-1-1V13z",gradient:{id:"SVGID_5_",type:"linear",x1:-1428.3853,y1:-571.5747,x2:-1428.3853,y2:-568.5747,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:7,y:13,w:3,h:1,fill:"#232424"},{shape:"rect",x:7,y:13,w:3,h:1,fill:"#FFFFFF"},{shape:"path",data:"M7,11.5C7,11.223,7.224,11,7.5,11h2c0.277,0,0.5,0.223,0.5,0.5l0,0c0,0.275-0.223,0.5-0.5,0.5h-2  C7.224,12,7,11.775,7,11.5L7,11.5z",gradient:{id:"SVGID_6_",type:"linear",x1:-1428.3862,y1:-567.5737,x2:-1428.3862,y2:-568.5737,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M15,7.5C15,7.776,14.777,8,14.5,8h-12C2.224,8,2,7.776,2,7.5l0,0C2,7.224,2.224,7,2.5,7h12  C14.777,7,15,7.224,15,7.5L15,7.5z",gradient:{id:"SVGID_7_",type:"linear",x1:8.4995,y1:6.1152,x2:8.4995,y2:7.5558,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M15,9.5c0,0.275-0.223,0.5-0.5,0.5h-12C2.224,10,2,9.775,2,9.5l0,0C2,9.223,2.224,9,2.5,9h12  C14.777,9,15,9.223,15,9.5L15,9.5z",gradient:{id:"SVGID_8_",type:"linear",x1:8.4995,y1:8.1147,x2:8.4995,y2:9.556,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}}]}),Nd("data_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,12c0,0.553-0.447,1-1,1H7c-0.552,0-1-0.447-1-1V8c0-0.552,0.448-1,1-1h7c0.553,0,1,0.448,1,1V12   z",gradient:{id:"SVGID_1_",type:"linear",x1:10.5,y1:6.959,x2:10.5,y2:12.2259,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:7,y:8,w:7,h:4,fill:"#FFFFFF"},{shape:"rect",x:8,y:9,w:5,h:2,gradient:{id:"SVGID_2_",type:"linear",x1:10.5,y1:8.6997,x2:10.5,y2:11.0333,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M15,14.5c0,0.275-0.225,0.5-0.5,0.5h-8C6.224,15,6,14.775,6,14.5l0,0C6,14.223,6.224,14,6.5,14h8   C14.775,14,15,14.223,15,14.5L15,14.5z",gradient:{id:"SVGID_3_",type:"linear",x1:10.5,y1:13.125,x2:10.5,y2:14.5518,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:8,y:14,w:1,h:1,gradient:{id:"SVGID_4_",type:"linear",x1:8.4995,y1:14.0049,x2:8.4995,y2:14.9471,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M12,4H6c0,0-0.152-0.275-0.5-1C5.021,2,5.021,2,4,2C3.057,2,2,2,2,2C1.448,2,1,2.448,1,3v8  c0,0.553,0.448,1,1,1h3v-1H2V3h2.387l1.024,1.998L12,5v1h1V5C13,4.448,12.553,4,12,4z",gradient:{id:"SVGID_5_",type:"linear",x1:6.9995,y1:2.0527,x2:6.9995,y2:11.4757,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M12,5L5.411,4.998L4.387,3H2v8h3v-0.645V7.254V7c0-0.552,0.448-1,1-1h0.324h3.032H12V5z",gradient:{id:"SVGID_6_",type:"linear",x1:6.9995,y1:2.9902,x2:6.9995,y2:11.0032,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}}]}),Nd("grid_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,14c0,0.553-0.447,1-1,1H3c-0.552,0-1-0.447-1-1V3c0-0.552,0.448-1,1-1h11c0.553,0,1,0.448,1,1V14  z",gradient:{id:"SVGID_1_",type:"linear",x1:8.4995,y1:2.1255,x2:8.4995,y2:14.909,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:3,y:3,w:11,h:11,fill:"#FFFFFF"},{shape:"rect",x:3,y:5,w:11,h:1,gradient:{id:"SVGID_2_",type:"linear",x1:8.4995,y1:3.209,x2:8.4995,y2:13.8043,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:3,y:8,w:11,h:1,gradient:{id:"SVGID_3_",type:"linear",x1:8.4995,y1:3.209,x2:8.4995,y2:13.8043,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:3,y:11,w:11,h:1,gradient:{id:"SVGID_4_",type:"linear",x1:8.4995,y1:3.2095,x2:8.4995,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:11,y:3,w:1,h:11,gradient:{id:"SVGID_5_",type:"linear",x1:11.5,y1:3.209,x2:11.5,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:8,y:3,w:1,h:11,gradient:{id:"SVGID_6_",type:"linear",x1:8.4995,y1:3.209,x2:8.4995,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"rect",x:5,y:3,w:1,h:11,gradient:{id:"SVGID_7_",type:"linear",x1:5.5,y1:3.209,x2:5.5,y2:13.8048,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}}]}),Nd("databox_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M14.5,6h-12H2v0.5v7C2,13.776,2.224,14,2.5,14h12c0.276,0,0.5-0.224,0.5-0.5v-7V6H14.5z",gradient:{id:"SVGID_1_",type:"linear",x1:8.4995,y1:6.0625,x2:8.4995,y2:14.063,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M14.776,5.553l-1.553-3.105C13.101,2.201,12.775,2,12.5,2h-8C4.225,2,3.899,2.201,3.776,2.447  L2.224,5.553L2,6h0.5h12H15L14.776,5.553z",gradient:{id:"SVGID_2_",type:"linear",x1:8.5005,y1:3.104,x2:8.5005,y2:-5.6467,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"12,2 9.5,2 7.5,2 5,2 3,6 7.5,6 9.5,6 14,6 z",gradient:{id:"SVGID_3_",type:"linear",x1:8.5005,y1:9.2295,x2:8.5005,y2:5.4586,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M11.5,9c0,0.276-0.224,0.5-0.5,0.5H6C5.724,9.5,5.5,9.276,5.5,9l0,0c0-0.276,0.224-0.5,0.5-0.5h5  C11.276,8.5,11.5,8.724,11.5,9L11.5,9z",fill:"#FFFFFF"}]}),Nd("group_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,8.5C15,8.776,14.776,9,14.5,9h-10C4.224,9,4,8.776,4,8.5v-7C4,1.224,4.224,1,4.5,1h10    C14.776,1,15,1.224,15,1.5V8.5z",gradient:{id:"SVGID_1_",type:"linear",x1:9.5,y1:.9512,x2:9.5,y2:8.9787,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:5,y:2,w:9,h:6,fill:"#FFFFFF"},{shape:"rect",x:6,y:3,w:7,h:4,gradient:{id:"SVGID_2_",type:"linear",x1:9.5,y1:3.02,x2:9.5,y2:6.9606,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M16,10.5c0,0.276-0.224,0.5-0.5,0.5h-12C3.224,11,3,10.776,3,10.5l0,0C3,10.224,3.224,10,3.5,10h12    C15.776,10,16,10.224,16,10.5L16,10.5z",gradient:{id:"SVGID_3_",type:"linear",x1:9.5,y1:9.9941,x2:9.5,y2:10.9976,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:6,y:10.001,w:2,h:.999,gradient:{id:"SVGID_4_",type:"linear",x1:7,y1:10.0059,x2:7,y2:10.9472,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M12,12.5c0,0.276-0.224,0.5-0.5,0.5h-10C1.224,13,1,12.776,1,12.5v-7C1,5.224,1.224,5,1.5,5h10    C11.776,5,12,5.224,12,5.5V12.5z",gradient:{id:"SVGID_5_",type:"linear",x1:6.4995,y1:4.9512,x2:6.4995,y2:12.9792,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:6,w:9,h:6,fill:"#FFFFFF"},{shape:"rect",x:3,y:7,w:7,h:4,gradient:{id:"SVGID_6_",type:"linear",x1:6.4995,y1:7.02,x2:6.4995,y2:10.9611,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M13,14.5c0,0.276-0.224,0.5-0.5,0.5h-12C0.224,15,0,14.776,0,14.5l0,0C0,14.224,0.224,14,0.5,14h12    C12.776,14,13,14.224,13,14.5L13,14.5z",gradient:{id:"SVGID_7_",type:"linear",x1:6.4995,y1:13.9941,x2:6.4995,y2:14.9976,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:3,y:14.001,w:2,h:.999,gradient:{id:"SVGID_8_",type:"linear",x1:4,y1:14.0059,x2:4,y2:14.9472,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}}]}),Nd("link_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"line",p1:{x:2.5,y:2.5},p2:{x:13.5,y:13.5},lineColor:"url(#SVGID_1_)",lineWidth:1},{shape:"ellipse",cx:13,cy:13,rx:2,ry:2,gradient:{id:"SVGID_2_",type:"linear",x1:11.5371,y1:11.5371,x2:14.2155,y2:14.2155,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:13,cy:13,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:3,cy:3,rx:2,ry:2,gradient:{id:"SVGID_3_",type:"linear",x1:1.4956,y1:1.4956,x2:4.1473,y2:4.1473,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:3,cy:3,rx:1,ry:1,fill:"#FFFFFF"}]}),Nd("linksubgl3dview_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,7.661c0-1.202-0.642-2.247-1.596-2.835C12.848,3.188,11.314,2,9.486,2  c-1.587,0-2.95,0.902-3.649,2.211C4.573,4.22,3.548,5.194,3.438,6.432C3.389,6.429,3.342,6.417,3.292,6.417  C2.026,6.417,1,7.443,1,8.708C1,9.975,2.026,11,3.292,11h8.371l0,0C13.506,11,15,9.506,15,7.661z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:1.959,x2:7.9995,y2:11.0921,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M3.292,10C2.58,10,2,9.42,2,8.708c0-0.712,0.58-1.292,1.292-1.292C3.286,7.422,3.332,7.427,3.379,7.43  l0.969,0.058L4.435,6.52C4.5,5.779,5.106,5.216,5.844,5.211l0.595-0.004l0.28-0.524C7.273,3.645,8.334,3,9.486,3  c1.342,0,2.535,0.863,2.971,2.147l0.116,0.341l0.307,0.189C13.581,6.11,14,6.851,14,7.661C14,8.951,12.951,10,11.661,10H3.292z",fill:"#FFFFFF"},{shape:"path",data:"M3.292,10h8.37c1.11,0,2.04-0.781,2.276-1.821c-0.131-0.615-0.5-1.158-1.058-1.501l-0.307-0.189  l-0.116-0.341C12.021,4.863,10.828,4,9.486,4C8.334,4,7.273,4.645,6.719,5.682l-0.28,0.524L5.844,6.211  C5.106,6.216,4.5,6.779,4.435,7.52L4.349,8.487L3.379,8.43C3.332,8.427,3.286,8.422,3.292,8.417c-0.535,0-0.994,0.328-1.19,0.792  C2.297,9.672,2.757,10,3.292,10z",gradient:{id:"SVGID_2_",type:"linear",x1:8.019,y1:4.084,x2:8.019,y2:9.8062,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"line",p1:{x:8.01,y:8.01},p2:{x:13.186,y:13.186},lineColor:"url(#SVGID_3_)",lineWidth:1},{shape:"ellipse",cx:8,cy:8,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:6.7881,y1:6.7881,x2:9.9924,y2:9.9924,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:8,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:13,cy:13,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:11.5791,y1:11.5791,x2:14.3132,y2:14.3132,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:13,cy:13,rx:1,ry:1,fill:"#FFFFFF"}]}),Nd("node_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,11.5c0,0.276-0.224,0.5-0.5,0.5h-13C1.224,12,1,11.776,1,11.5v-9C1,2.224,1.224,2,1.5,2h13  C14.776,2,15,2.224,15,2.5V11.5z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:1.939,x2:7.9995,y2:11.9739,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:3,w:12,h:8,fill:"#FFFFFF"},{shape:"rect",x:3,y:4,w:10,h:6,gradient:{id:"SVGID_2_",type:"linear",x1:7.9995,y1:4.0513,x2:7.9995,y2:9.865,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M16,14.5c0,0.276-0.224,0.5-0.5,0.5h-15C0.224,15,0,14.776,0,14.5v-1C0,13.224,0.224,13,0.5,13h15  c0.276,0,0.5,0.224,0.5,0.5V14.5z",gradient:{id:"SVGID_3_",type:"linear",x1:7.9995,y1:13.0508,x2:7.9995,y2:14.9258,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M9,14.5C9,14.224,8.776,14,8.5,14h-5C3.224,14,3,14.224,3,14.5V15h6V14.5z",gradient:{id:"SVGID_4_",type:"linear",x1:5.9995,y1:14.0508,x2:5.9995,y2:15.9258,stop:[{offset:"0",color:"#69B4A5"},{offset:"0.1",color:"#61AD9C"},{offset:"0.4637",color:"#449981"},{offset:"0.7764",color:"#2C8E73"},{offset:"1",color:"#218A6E"}]}}]}),Nd("shapelink_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"line",p1:{x:7.5,y:2.5},p2:{x:2.5,y:7.5},lineColor:"url(#SVGID_1_)",lineWidth:1},{shape:"line",p1:{x:2.5,y:7.5},p2:{x:8.5,y:13.5},lineColor:"url(#SVGID_2_)",lineWidth:1},{shape:"line",p1:{x:9,y:13.186},p2:{x:13.5,y:6.5},lineColor:"url(#SVGID_3_)",lineWidth:1},{shape:"ellipse",cx:7,cy:3,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:5.5864,y1:1.5864,x2:8.4149,y2:4.4149,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:7,cy:3,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:2,cy:8,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:.5864,y1:6.5864,x2:3.4142,y2:9.4142,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:2,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:8,cy:13,rx:2,ry:2,gradient:{id:"SVGID_6_",type:"linear",x1:6.5869,y1:11.5869,x2:9.4147,y2:14.4147,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:8,cy:13,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:13,cy:7,rx:2,ry:2,gradient:{id:"SVGID_7_",type:"linear",x1:11.5859,y1:5.5859,x2:14.4144,y2:8.4144,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:13,cy:7,rx:1,ry:1,fill:"#FFFFFF"}]}),Nd("shapenode_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M14.5,3h-9l-4,4v7h13L9,8.5L14.5,3z M12.086,13H2.5V7.414L5.914,4h6.172l-4.5,4.5L12.086,13z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:3.209,x2:7.9995,y2:13.6621,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:6,cy:3,rx:2,ry:2,gradient:{id:"SVGID_2_",type:"linear",x1:4.5859,y1:1.5859,x2:7.4151,y2:4.4151,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:6,cy:3,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:13,cy:3,rx:2,ry:2,gradient:{id:"SVGID_3_",type:"linear",x1:11.5869,y1:1.5864,x2:14.4153,y2:4.4149,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:13,cy:3,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:9,cy:8,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:7.5864,y1:6.5864,x2:10.4149,y2:9.4149,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:9,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:2,cy:7,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:.5859,y1:5.5859,x2:3.4144,y2:8.4144,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:2,cy:7,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:12.825,cy:13,rx:2,ry:2,gradient:{id:"SVGID_6_",type:"linear",x1:11.4111,y1:11.5869,x2:14.2396,y2:14.4153,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"ellipse",cx:12.825,cy:13,rx:1,ry:1,fill:"#FFFFFF"}]}),Nd("shapesubgl3dview_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"path",data:"M15,6.661c0-1.202-0.642-2.247-1.596-2.835C12.848,2.188,11.314,1,9.486,1  c-1.587,0-2.95,0.902-3.649,2.211C4.573,3.22,3.548,4.194,3.438,5.432C3.389,5.429,3.342,5.417,3.292,5.417  C2.026,5.417,1,6.443,1,7.708S2.026,10,3.292,10h8.371l0,0C13.506,10,15,8.505,15,6.661z",gradient:{id:"SVGID_1_",type:"linear",x1:7.9995,y1:1.3755,x2:7.9995,y2:9.733,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"M3.292,9C2.58,9,2,8.42,2,7.708s0.58-1.292,1.292-1.292C3.286,6.422,3.332,6.427,3.379,6.43l0.969,0.058  L4.435,5.52C4.5,4.779,5.106,4.216,5.844,4.211l0.595-0.004l0.28-0.524C7.273,2.645,8.334,2,9.486,2  c1.342,0,2.535,0.863,2.971,2.147l0.116,0.341l0.307,0.189C13.581,5.11,14,5.851,14,6.661C14,7.951,12.951,9,11.661,9H3.292z",fill:"#FFFFFF"},{shape:"path",data:"M3.272,9h8.37c1.11,0,2.039-0.689,2.275-1.729c-0.131-0.615-0.499-1.249-1.057-1.593l-0.307-0.189  l-0.116-0.341C12.002,3.863,10.809,3,9.468,3C8.314,3,7.254,3.645,6.7,4.682L6.42,5.207L5.825,5.211  C5.087,5.216,4.481,5.779,4.416,6.52L4.33,7.487L3.36,7.43C3.313,7.427,3.267,7.422,3.272,7.417c-0.535,0-0.994,0.327-1.19,0.792  C2.278,8.672,2.738,9,3.272,9z",gradient:{id:"SVGID_2_",type:"linear",x1:7.9995,y1:3.459,x2:7.9995,y2:8.4597,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M11.516,7.102h-8l2.469,6h8.5L11.516,7.102z M5.024,8.123h5.905l1.938,3.979H6.662L5.024,8.123z",gradient:{id:"SVGID_3_",type:"linear",x1:7.4443,y1:7.1724,x2:10.1111,y2:12.8383,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"path",data:"5,8.112 10.904,8.112 12.842,12.092 6.638,12.092 z",fill:"#FFFFFF"},{shape:"ellipse",cx:5,cy:8,rx:2,ry:2,gradient:{id:"SVGID_4_",type:"linear",x1:3,y1:8,x2:7,y2:8,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:5,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:12,cy:8,rx:2,ry:2,gradient:{id:"SVGID_5_",type:"linear",x1:10,y1:8,x2:14,y2:8,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:12,cy:8,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:7,cy:12,rx:2,ry:2,gradient:{id:"SVGID_6_",type:"linear",x1:5,y1:12,x2:9,y2:12,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:7,cy:12,rx:1,ry:1,fill:"#FFFFFF"},{shape:"ellipse",cx:14,cy:12,rx:2,ry:2,gradient:{id:"SVGID_7_",type:"linear",x1:12,y1:12,x2:16,y2:12,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"ellipse",cx:14,cy:12,rx:1,ry:1,fill:"#FFFFFF"}]}),Nd("subgl3dview_icon",{w:16,h:16,origin:{x:0,y:0},v:[{shape:"rect",x:10,y:14.001,w:2,h:1,gradient:{id:"SVGID_1_",type:"linear",x1:11,y1:14.0059,x2:11,y2:14.9481,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"rect",x:14,y:10.001,w:1,h:2,gradient:{id:"SVGID_2_",type:"linear",x1:14.5,y1:10.0117,x2:14.5,y2:11.8962,stop:[{offset:"0",color:"#58AC9A"},{
offset:"1",color:"#248576"}]}},{shape:"path",data:"M16,6.001c0,0.552-0.447,1-1,1H8c-0.552,0-1-0.448-1-1v-4c0-0.552,0.448-1,1-1h7   c0.553,0,1,0.448,1,1V6.001z",gradient:{id:"SVGID_3_",type:"linear",x1:11.5,y1:.96,x2:11.5,y2:6.2265,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:8,y:2.001,w:7,h:4,fill:"#FFFFFF"},{shape:"rect",x:9,y:3.001,w:5,h:2,gradient:{id:"SVGID_4_",type:"linear",x1:11.5,y1:2.7007,x2:11.5,y2:5.0337,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M16,8.501c0,0.276-0.225,0.5-0.5,0.5h-8c-0.276,0-0.5-0.224-0.5-0.5l0,0c0-0.276,0.224-0.5,0.5-0.5   h8C15.775,8.001,16,8.225,16,8.501L16,8.501z",gradient:{id:"SVGID_5_",type:"linear",x1:11.5,y1:7.126,x2:11.5,y2:8.5535,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:9,y:8.001,w:1,h:.999,gradient:{id:"SVGID_6_",type:"linear",x1:9.5,y1:8.0063,x2:9.5,y2:8.9477,stop:[{offset:"0",color:"#58AC9A"},{offset:"1",color:"#248576"}]}},{shape:"path",data:"M9,12c0,0.553-0.447,1-1,1H1c-0.552,0-1-0.447-1-1V8c0-0.552,0.448-1,1-1h7c0.553,0,1,0.448,1,1V12z   ",gradient:{id:"SVGID_7_",type:"linear",x1:4.4995,y1:6.959,x2:4.4995,y2:12.2259,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:1,y:8,w:7,h:4,fill:"#FFFFFF"},{shape:"rect",x:2,y:9,w:5,h:2,gradient:{id:"SVGID_8_",type:"linear",x1:4.5,y1:8.6997,x2:4.5,y2:11.0333,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M9,14.5C9,14.776,8.775,15,8.5,15h-8C0.224,15,0,14.776,0,14.5l0,0C0,14.224,0.224,14,0.5,14h8   C8.775,14,9,14.224,9,14.5L9,14.5z",gradient:{id:"SVGID_9_",type:"linear",x1:4.4995,y1:13.125,x2:4.4995,y2:14.5518,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}},{shape:"rect",x:2,y:14,w:1,h:1,gradient:{id:"SVGID_10_",type:"linear",x1:2.5,y1:14.0049,x2:2.5,y2:14.9471,stop:[{offset:"0",color:"#61B7D9"},{offset:"1",color:"#005EAD"}]}},{shape:"path",data:"M16,14.501c0,0.276-0.224,0.5-0.5,0.5h-2c-0.276,0-0.5-0.224-0.5-0.5v-1c0-0.276,0.224-0.5,0.5-0.5  h2c0.276,0,0.5,0.224,0.5,0.5V14.501z",gradient:{id:"SVGID_11_",type:"linear",x1:14.5,y1:13.0117,x2:14.5,y2:14.8962,stop:[{offset:"0",color:"#666767"},{offset:"1",color:"#232424"}]}}]});var Md={_hitCanvas:null,getHitCanvas:function(a,b){null==this._hitCanvas&&(this._hitCanvas=Wb.createCanvas()),0==arguments.length&&(a=2,b=2),this._hitCanvas.setAttribute("width",""+a-1),this._hitCanvas.setAttribute("height",""+b-1),this._hitCanvas.setAttribute("width",""+a),this._hitCanvas.setAttribute("height",""+b);var c=this.getCtx(this._hitCanvas);return c.clearRect(0,0,a,b),this._hitCanvas},disposeHitCanvas:function(){this._hitCanvas=null},getCtx:function(a){return a.getContext("2d")},render:function(a,c,d){c!=b&&(a.fillStyle=c,a.fill()),d!=b&&(a.strokeStyle=d,a.stroke())},text:function(a,b,c,d,e,f){a.textAlign="center",a.textBaseline="middle",null!=e&&(a.fillStyle=e,a.fillText(b,c,d)),f&&(a.strokeStyle=f,a.strokeText(b,c,d))},circle:function(a,b,c,d,e,f){a.arc(b,c,d,0,2*Math.PI,!0),a.closePath(),this.render(a,e,f)},rect:function(a,b,c,d,e,f,g){a.rect(b,c,d,e),a.closePath(),this.render(a,f,g)},OUT_LEFT:1,OUT_TOP:2,OUT_RIGHT:4,OUT_BOTTOM:8,outcode:function(a,b,c,d,e,f){var g=0;return 0>=e?g|=this.OUT_LEFT|this.OUT_RIGHT:c>a?g|=this.OUT_LEFT:a>c+e&&(g|=this.OUT_RIGHT),0>=f?g|=this.OUT_TOP|this.OUT_BOTTOM:d>b?g|=this.OUT_TOP:b>d+f&&(g|=this.OUT_BOTTOM),g},intersectsLine:function(a,b,c,d,e,f,g,h){var i,j;if(0==(j=this.outcode(c,d,e,f,g,h)))return!0;for(;0!=(i=this.outcode(a,b,e,f,g,h));){if(0!=(i&j))return!1;if(0!=(i&(this.OUT_LEFT|this.OUT_RIGHT))){var k=e;0!=(i&this.OUT_RIGHT)&&(k+=g),b+=(k-a)*(d-b)/(c-a),a=k}else{var l=f;0!=(i&this.OUT_BOTTOM)&&(l+=h),a+=(l-b)*(c-a)/(d-b),b=l}}return!0}};Ib.vector={},Ib.vector.interaction={},Ib.vector.Gl3dview=function(a){Ib.vector.Gl3dview.superClass.constructor.apply(this,arguments),this.zoomManager=new Ib.vector.PhysicalZoomManager(this),this._view=Wb.createView("hidden"),this._rootCanvas=Wb.createCanvas(),this._topCanvas=Wb.createCanvas(),this._view.appendChild(this._rootCanvas),this._view.appendChild(this._topCanvas),this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0},this._zoom=1,this._elementUIMap={},this._zoomMap={},this._viewRectMap={},this.viewRect={x:0,y:0,width:0,height:0},this.hScrollBarVisible=!1,this.vScrollBarVisible=!1,this.markerList=new Ib.List,this._topAttachmentList=new Ib.List,this.setElementBox(a?a:new Ib.ElementBox),Qb.isMSToucheable?this.setMSTouchInteractions():Qb.isTouchable?this.setTouchInteractions():this.setDefaultInteractions(!1);var b=this;this._flowLink=function(){if(!(b.isMovingElement()||b.isSelectingElement()||b.isEditingElement()||b._box._layoutMovingElements)){b._flowLinkQuickFinder||(b._flowLinkQuickFinder=new Ib.QuickFinder(b._box,"link.flow","style"));var a=b._flowLinkQuickFinder.find(!0);a.forEach(function(a){a._styleMap["link.flow.offset"]=b.getLinkFlowOffset(a),b.invalidateElementUI(a)})}},this.setToolTipEnabled(Ib.Defaults.NETWORK_TOOLTIP_ENABLED),this._paintAll=!0,this._dirtyRects=new md,this._invalidateMap={},this._invalidateAll=!0,b._count=0,b._invalidate=!0,function c(a){requestAnimationFrame(c),b._invalidate&&(b._count++,b._now=a,b.validate())}(0)},Jb.ext("twaver.vector.Gl3dview",Ib.controls.View,{__accessor:["selectMode","makeVisibleOnSelected","movableFunction","editPointSize","editPointFillColor","scrollBarWidth","editPointOutlineWidth","editPointOutlineColor","editLineColor","editLineWidth","resizePointSize","resizePointFillColor","resizePointOutlineWidth","resizePointOutlineColor","resizeLineColor","resizeLineWidth","rotatePointSize","rotatePointFillColor","rotatePointOffset","rotatePointOutlineWidth","rotatePointOutlineColor","rotateScaleFillColor","rotateScaleFontColor","rotateScaleWidth","rotateScaleHeight","selectOutlineColor","selectOutlineWidth","selectFillColor","lazyMoveOutlineColor","lazyMoveOutlineWidth","lazyMoveFillColor","rectSelectFilter","selectionTolerance"],__bool:["doubleClickToUpSubGl3dview","doubleClickToSubGl3dview","doubleClickToEmptySubGl3dview","doubleClickToLinkBundle","doubleClickToGroupExpand","scrollBarVisible","limitViewInCanvas","autoValidateCanvasSize","subGl3dviewAnimate","lazyMoveAnimate","resizeAnimate","noAgentLinkVisible","keyboardRemoveEnabled","keyboardSelectEnabled","sendToTopOnSelected","lazyMoveFill","editingElement","rotatingElement","movingElement","selectingElement","rectSelectEnabled","limitElementInPositiveLocation","showRotateScale","transparentSelectionEnable","edgeDetect","dragToPan","wheelToZoom","asyncZoomAndViewRect","debug","zoomDivVisible"],_currentSubGl3dview:null,_subGl3dviewAnimate:Ib.Defaults.NETWORK_SUBNETWORK_ANIMATE,_scrollBarWidth:10,_scrollBarVisible:!0,_limitViewInCanvas:!1,_autoValidateCanvasSize:!0,_makeVisibleOnSelected:Ib.Defaults.NETWORK_MAKE_VISIBLE_ON_SELECTED,_keyboardRemoveEnabled:Ib.Defaults.NETWORK_KEYBOARD_REMOVE_ENABLED,_keyboardSelectEnabled:Ib.Defaults.NETWORK_KEYBOARD_SELECT_ENABLED,_rectSelectEnabled:Cd.NETWORK_RECT_SELECT_ENABLED,_rectSelectFilter:null,_elementUIFunction:Ib.Defaults.VECTORUI_FUNCTION,_doubleClickToUpSubGl3dview:Ib.Defaults.NETWORK_DOUBLECLICK_TO_UPSUBNETWORK,_doubleClickToSubGl3dview:Ib.Defaults.NETWORK_DOUBLECLICK_TO_SUBNETWORK,_doubleClickToEmptySubGl3dview:Ib.Defaults.NETWORK_DOUBLECLICK_TO_EMPTYSUBNETWORK,_doubleClickToLinkBundle:Ib.Defaults.NETWORK_DOUBLECLICK_TO_LINKBUNDLE,_doubleClickToGroupExpand:Ib.Defaults.NETWORK_DOUBLECLICK_TO_GROUPEXPAND,_selectOutlineColor:Ib.Defaults.NETWORK_SELECT_OUTLINE_COLOR,_selectOutlineWidth:Ib.Defaults.NETWORK_SELECT_OUTLINE_WIDTH,_selectFillColor:Ib.Defaults.NETWORK_SELECT_FILL_COLOR,_sendToTopOnSelected:Ib.Defaults.NETWORK_SENDTOTOP_ON_SELECTED,_lazyMoveOutlineColor:Ib.Defaults.NETWORK_LAZYMOVE_OUTLINE_COLOR,_lazyMoveOutlineWidth:Ib.Defaults.NETWORK_LAZYMOVE_OUTLINE_WIDTH,_lazyMoveFillColor:Ib.Defaults.NETWORK_LAZYMOVE_FILL_COLOR,_lazyMoveFill:Ib.Defaults.NETWORK_LAZYMOVE_FILL,_lazyMoveAnimate:Ib.Defaults.NETWORK_LAZYMOVE_ANIMATE,_resizePointSize:Ib.Defaults.NETWORK_RESIZE_POINT_SIZE,_resizePointFillColor:Ib.Defaults.NETWORK_RESIZE_POINT_FILL_COLOR,_resizePointOutlineColor:Ib.Defaults.NETWORK_RESIZE_POINT_OUTLINE_COLOR,_resizePointOutlineWidth:Ib.Defaults.NETWORK_RESIZE_POINT_OUTLINE_WIDTH,_resizeLineColor:Ib.Defaults.NETWORK_RESIZE_LINE_COLOR,_resizeLineWidth:Ib.Defaults.NETWORK_RESIZE_LINE_WIDTH,_resizeAnimate:Ib.Defaults.NETWORK_RESIZE_ANIMATE,_rotatePointSize:Ib.Defaults.NETWORK_ROTATE_POINT_SIZE,_rotatePointFillColor:Ib.Defaults.NETWORK_ROTATE_POINT_FILL_COLOR,_rotatePointOffset:Ib.Defaults.NETWORK_ROTATE_POINT_OFFSET,_rotatePointOutlineWidth:Ib.Defaults.NETWORK_ROTATE_POINT_OUTLINE_WIDTH,_rotatePointOutlineColor:Ib.Defaults.NETWORK_ROTATE_POINT_OUTLINE_COLOR,_rotateScaleWidth:Cd.NETWORK_ROTATE_SCALE_WIDTH,_rotateScaleHeight:Cd.NETWORK_ROTATE_SCALE_HEIGHT,_rotateScaleFillColor:Cd.NETWORK_ROTATE_SCALE_FILL_COLOR,_rotateScaleFontColor:Cd.NETWORK_ROTATE_SCALE_FONT_COLOR,_editPointSize:Ib.Defaults.NETWORK_EDIT_POINT_SIZE,_editPointFillColor:Ib.Defaults.NETWORK_EDIT_POINT_FILL_COLOR,_editPointOutlineColor:Ib.Defaults.NETWORK_EDIT_POINT_OUTLINE_COLOR,_editPointOutlineWidth:Ib.Defaults.NETWORK_EDIT_POINT_OUTLINE_WIDTH,_editLineColor:Ib.Defaults.NETWORK_EDIT_LINE_COLOR,_editLineWidth:Ib.Defaults.NETWORK_EDIT_LINE_WIDTH,_limitElementInPositiveLocation:!1,_linkFlowInterval:Cd.NETWORK_LINK_FLOW_INTERVAL,_selectionTolerance:Cd.NETWORK_SELECTION_TOLERANCE,_invalidateViewRectFlag:!1,_repaintTopFlag:!1,_invalidateCanvasSizeFlag:!1,_isEditingElement:!1,_isRotatingElement:!1,_isMovingElement:!1,_isSelectingElement:!1,_hasEditInteraction:!1,_showRotateScale:!0,_transparentSelectionEnable:Ib.Defaults.NETWORK_TRANSPARENT_SELECTION_ENABLE,_edgeDetect:!1,_dragToPan:!0,_wheelToZoom:!0,_asyncZoomAndViewRect:!1,_debug:!1,_zoomDivVisible:!0,_autoAdjustBounds:!1,adjustBounds:function(a){var b=!1,c=this._view.style;if(c.left==a.x+"px"&&c.top==a.y+"px"&&c.width==a.width+"px"&&c.height==a.height+"px"&&(b=!0),Ib.vector.Gl3dview.superClass.adjustBounds.apply(this,arguments),1!=b){var d=this._view.offsetWidth,e=this._view.offsetHeight;this._rootCanvas.setAttribute("width",d),this._rootCanvas.setAttribute("height",e),this._topCanvas.setAttribute("width",d),this._topCanvas.setAttribute("height",e),this.setViewRect(this.viewRect.x,this.viewRect.y,d,e),"undefined"==typeof Ib.gis&&(Ib.Util.makeHighRes(this._rootCanvas),Ib.Util.makeHighRes(this._topCanvas)),this.invalidateElementVisibility()}},setAutoAdjustBounds:function(b){b===!0?Wb.addEventListener("resize","handleResize",a,this):Wb.removeEventListener("resize",a,this),this._autoAdjustBounds=b},isAutoAdjustBounds:function(){return this._autoAdjustBounds},handleResize:function(a){this.adjustBounds({x:0,y:0,width:Ob.documentElement.clientWidth,height:Ob.documentElement.clientHeight})},getLabel:function(a){return a.getStyle("gl3dview.label")||a.getName()},getLabel2:function(a){return a.getStyle("gl3dview.label")||a.getName2()},setZoomManager:function(a){var b=this.zoomManager;b!=a&&(this.zoomManager=a,this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.validateCanvasSize(),this.invalidateElementUIs(),this.firePropertyChange("zoomManager",b,a))},getZoomManager:function(){return this.zoomManager},getRootCanvas:function(){return this._rootCanvas},getTopCanvas:function(){return this._topCanvas},validateImpl:function(){oc.twm(this);var a,b,c,d,e=this.getElementBox().getDatas()._as,f=e.length,g={},h=this._visibleFunction,i=1===this._box._layerBox.size()?this._box._layerBox._defaultLayer:null;for(a=0;f>a;a++)c=e[a],g[c._id]=this.isVisible(c,h,i);var j=this.getGraphicsZoom(),k=null,l={x:this.viewRect.x/j,y:this.viewRect.y/j,width:this.viewRect.width/j,height:this.viewRect.height/j};if(this._invalidateAll){if(this._visibleMap)for(a=0;f>a;a++)c=e[a],g[c._id]!==this._visibleMap[c._id]&&(d=this._elementUIMap[c._id],d&&d.invalidate());for(a=0;f>a;a++)c=e[a],d=this._elementUIMap[c._id],d&&d.validate();this._paintAll=!0}else if(this._paintAll){for(b in this._invalidateMap)d=this._elementUIMap[b],d&&d.invalidate();for(b in this._invalidateMap)d=this._elementUIMap[b],d&&d.validate()}else{for(b in this._invalidateMap)d=this._elementUIMap[b],d&&(this._dirtyRects.add(d.getZoomViewRect(!1)),d.invalidate());for(b in this._invalidateMap)d=this._elementUIMap[b],d&&(d.validate(),this._dirtyRects.add(d.getZoomViewRect(!0)))}this._paintAll?k=l:(this._dirtyRects.forEach(function(a){k=null==k?Jb.cloneRect(a):Tb.unionRect(k,a)}),k?(Tb.grow(k,2,2),k=Tb.intersection(k,l)):k=l),this._visibleMap=g,k&&this.paintRoot(k),this.validateCanvasSize(),1==this._repaintTopFlag&&(this._repaintTopFlag=!1,this.paintTopCanvas())},isLinkFlowEnabled:function(){return this._linkFlowEnabled?!0:!1},setLinkFlowEnabled:function(a){a?(this._linkFlowEnabled||(this._linkFlowEnabled=!0,this.firePropertyChange("linkFlowEnabled",!1,!0)),clearInterval(this._linkFlowTimerId),this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval)):(this._linkFlowEnabled&&(this._linkFlowEnabled=!1,this.firePropertyChange("linkFlowEnabled",!0,!1)),clearInterval(this._linkFlowTimerId),delete this._linkFlowTimerId)},getLinkFlowInterval:function(){return this._linkFlowInterval},setLinkFlowInterval:function(a){var b=this._linkFlowInterval;this._linkFlowInterval=a,this.firePropertyChange("linkFlowInterval",b,a),clearInterval(this._linkFlowTimerId),this.isLinkFlowEnabled()&&(this._linkFlowTimerId=setInterval(this._flowLink,this._linkFlowInterval))},getElementBox:function(){return this._box},setElementBox:function(a){if(!a)throw"ElementBox can not be null";if(this._box!==a){var b=this._box;b&&(b.removeServaChangeListener(this.handleElementBoxChange,this),b.removeDataPropertyChangeListener(this.handleElementPropertyChange,this),b.removePropertyChangeListener(this.handleElementBoxPropertyChange,this),b.removeIndexChangeListener(this.handleIndexChange,this),b.getLayerBox().removeServaChangeListener(this.handleLayerBoxChange,this),b.getLayerBox().removeDataPropertyChangeListener(this.handleLayerPropertyChange,this),b.getLayerBox().removeHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._selectionContainer||b.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this)),this._box=a,this._box.addServaChangeListener(this.handleElementBoxChange,this),this._box.addDataPropertyChangeListener(this.handleElementPropertyChange,this),this._box.addPropertyChangeListener(this.handleElementBoxPropertyChange,this),this._box.addIndexChangeListener(this.handleIndexChange,this),this._box.getLayerBox().addServaChangeListener(this.handleLayerBoxChange,this),this._box.getLayerBox().addDataPropertyChangeListener(this.handleLayerPropertyChange,this),this._box.getLayerBox().addHierarchyChangeListener(this.handleLayerHierarchyChange,this),this._flowLinkQuickFinder&&(this._flowLinkQuickFinder.dispose(),this._flowLinkQuickFinder=new Ib.QuickFinder(this._box,"link.flow","style")),this._selectionContainer?this._selectionContainer._setServa(a):this._box.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.firePropertyChange("elementBox",b,this._box)}},handleElementBoxChange:function(a){var b=a.data;if("add"===a.kind)this.createElementUI(b),this.invalidateBundleLink(b);else if("remove"===a.kind){var c=this.getElementUI(b);c&&(this._dirtyRects.add(c.getZoomViewRect()),c.dispose(),delete this._elementUIMap[b.getId()]),b===this._currentSubGl3dview&&null!=this._currentSubGl3dview&&this._setCurrentSubGl3dview(null),delete this._invalidateMap[b._id]}else"clear"===a.kind&&(this._elementUIMap={},null!=this._currentSubGl3dview&&this._setCurrentSubGl3dview(null),this._paintAll=!0);this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementPropertyChange:function(a){var b=a.source,c=this.getElementUI(b);c&&(this.invalidateElementUI(b),c.handlePropertyChange(a)),this.invalidateBundleLink(b),this.invalidateElementVisibility(),this.invalidateCanvasSize()},handleElementBoxPropertyChange:function(){this.invalidateElementVisibility()},handleIndexChange:function(a){this.invalidateElementVisibility()},handleLayerBoxChange:function(){this.invalidateElementVisibility()},handleLayerPropertyChange:function(a){"editable"===a.property&&this.invalidateSelectedElementUIs(!0),this.invalidateElementVisibility()},handleLayerHierarchyChange:function(){this.invalidateElementVisibility()},handleSelectionChange:function(a){var b=this.getSelectionContainer().getLastData();b&&("append"===a.kind||"set"===a.kind)&&(this.isMakeVisibleOnSelected()&&this.makeVisible(b),this.isSendToTopOnSelected()&&this.sendToTop(b)),a.datas.forEach(function(b){var c=this.getElementUI(b);c&&c.handleSelectionChange(a),this.invalidateElementUI(b)},this),this.invalidateElementVisibility()},sendToTop:function(a){if(this._box.contains(a)){for(var b=a;b._parent&&this.isVisible(b._parent)&&(b=b._parent););b!==a&&this._box.adjustElementIndex(b),this._box.adjustElementIndex(a)}},getViewRect:function(){return this.viewRect?Jb.cloneRect(this.viewRect):{x:0,y:0,width:0,height:0}},getCanvasSize:function(){return{width:this.realWidth,height:this.realHeight}},setViewOffSet:function(a,b){var c=this.viewRect.x,d=this.viewRect.y,e=this.viewRect.width,f=this.viewRect.height;this.setViewRect(c+a,d+b,e,f)},setViewRect:function(a,b,c,d){1==this.isLimitViewInCanvas()&&(0>a&&(a=0),c>this.realWidth?a=0:a+c>this.realWidth&&(a=this.realWidth-c),0>b&&(b=0),d>this.realHeight?b=0:b+d>this.realHeight&&(b=this.realHeight-d));var e=this.viewRect;(null==this.viewRect||a!=this.viewRect.x||b!=this.viewRect.y||c!=this.viewRect.width||d!=this.viewRect.height)&&(this.viewRect={x:a,y:b,width:c,height:d},this.firePropertyChange("viewRect",e,this.viewRect),this.invalidateElementVisibility(),this._paintAll=!0)},isHScrollBarVisible:function(){return this.hScrollBarVisible},setHScrollBarVisible:function(a){this.hScrollBarVisible=a},isVScrollBarVisible:function(){return this.vScrollBarVisible},setVScrollBarVisible:function(a){this.vScrollBarVisible=a},setZoomVisibilityThresholds:function(a){var b=this._visibilityThresholds;this._zoomVisibilityThresholds=a,this.firePropertyChange("zoomVisibilityThresholds",b,a),this.invalidateElementVisibility()},getZoomVisibilityThresholds:function(){return this._zoomVisibilityThresholds||{}},invalidateElementVisibility:function(){this.invalidate()},repaintTopCanvas:function(){this._repaintTopFlag||(this._repaintTopFlag=!0,this.invalidate())},invalidateCanvasSize:function(a){this._invalidateCanvasSizeFlag||(this._invalidateCanvasSizeFlag=!0,this.invalidate())},validateCanvasSize:function(){0!=this._invalidateCanvasSizeFlag&&(this._invalidateCanvasSizeFlag=!1,this._validateCanvasSize())},_validateCanvasSize:function(){if(0==this.isAutoValidateCanvasSize())return this.realWidth=0,this.realHeight=0,void(this._unionBounds={x:0,y:0,width:0,height:0});var a,b=this.getElementBox().getDatas(),c=b.size();if(c>0){for(var d=0;c>d;d++){var e=b.get(d);if(this._visibleMap[e._id]){var f=this._elementUIMap[e._id];f&&(a=a?Tb.unionRect(a,f.getZoomViewRect(!0)):Jb.cloneRect(f.getZoomViewRect(!0)))}}null==a&&(a={x:0,y:0,width:0,height:0});var g=this.getGraphicsZoom();if(this.realWidth==(a.x+a.width)*g&&this.realHeight==(a.y+a.height)*g)return;this.realWidth=(a.x+a.width)*g,this.realHeight=(a.y+a.height)*g,this._unionBounds={x:a.x*g,y:a.y*g,width:a.width*g,height:a.height*g}}else this.realWidth=0,this.realHeight=0,this._unionBounds={x:0,y:0,width:0,height:0};this.setViewRect(this.viewRect.x,this.viewRect.y,this.viewRect.width,this.viewRect.height),this.firePropertyChange("canvasSizeChange",null,this.viewRect)},getElementUI:function(a){return null==a?null:this._elementUIMap[a._id]},getUnionBounds:function(){return this._unionBounds},getZoomBodyRect:function(a){var b=this.getElementUI(a);return b?b.getZoomBodyRect():null},getShapeNodeZoomPoints:function(a,b){if(a._points){var c=this.getElementUI(a);if(c)return c._getZoomPoints()}return null},createElementUI:function(a){var b=this._elementUIMap[a.getId()];if(!b){if(b=this._elementUIFunction(this,a),!b){var c=a.getClassName(),d=c.substr(c.indexOf(".")+1)+"UI",e=Ib.vector[d];e&&(b=new e(this,a))}b&&(this._elementUIMap[a.getId()]=b)}return this._invalidateMap&&(this._invalidateMap[a._id]=a),b},getElementUIFunction:function(){return this._elementUIFunction},setElementUIFunction:function(a){if(!a)throw"ElementUIFunction can not be null";if(this._elementUIFunction!==a){var b=this._elementUIFunction;this._elementUIFunction=a,this.firePropertyChange("elementUIFunction",b,a),this._box.isEmpty()||(this._elementUIMap={},this._box.forEach(this.createElementUI,this),this.invalidateElementVisibility(),this.invalidateCanvasSize())}},invalidateElementUI:function(a,b){if(!this._invalidateAll){this._invalidateMap[a._id]=a;{this.getElementUI(a)}if(a instanceof Jd){var c=a.getAgentLinks();null!=c&&c.forEach(this.invalidateElementUI,this);var d=a.getParent();d instanceof Ib.Group&&this.invalidateElementUI(d)}this.invalidateElementVisibility()}},invalidateElementUIs:function(a){this._invalidateAll=!0,this._invalidateMap={},this._visibleMap={},this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.invalidate()},invalidateSelectedElementUIs:function(a){this.getSelectionContainer().getSelection().forEach(function(b){this.invalidateElementUI(b,a)},this)},invalidateBundleLink:function(a){if(a instanceof Ib.Link&&a._bundleLinks){var b=this._elementUIMap;a._bundleLinks.forEachSiblingLink(function(c){if(c!==a){var d=b[c._id];d&&d.invalidate(!1)}},this)}},paintRoot:function(a){var c=this._rootCanvas.getContext("2d");c.save();var d=this.getGraphicsZoom();Qb.isIE&&c.clearRect(a.x*d-this.viewRect.x,a.y*d-this.viewRect.y,a.width*d,a.height*d),c.beginPath(),c.rect(a.x*d-this.viewRect.x,a.y*d-this.viewRect.y,a.width*d,a.height*d),c.clip(),Qb.isIE||c.clearRect(a.x*d-this.viewRect.x,a.y*d-this.viewRect.y,a.width*d,a.height*d),this.visibleList=new Ib.List,this._topAttachmentList=new Ib.List,ld.draw(c,this);var e=this.getElementBox().getDatas()._as,f=e.length,g=this.zoomManager;g._zoomGraphicsBegin(c),this.paintBottom(c,a);var h,i,j,k,l=this._box._layerBox,d=this.getGraphicsZoom(),m={x:this.viewRect.x/d,y:this.viewRect.y/d,width:this.viewRect.width/d,height:this.viewRect.height/d};if(1===l.size())for(h=0;f>h;h++)i=e[h],this._visibleMap[i._id]?(j=this._elementUIMap[i._id],null!=j&&this._isInView(j,a)&&(j.paint(c),j.setAttachmentVisible&&j.setAttachmentVisible(!0)),this._debug&&Xb.strokeRect(c,a,"#CC3B76"),null!=j&&Tb.intersects(m,j.getZoomViewRect())?j.setAttachmentVisible&&j.setAttachmentVisible(!0):j.setAttachmentVisible&&j.setAttachmentVisible(!1),this.visibleList.add(i)):(j=this._elementUIMap[i._id],j&&j.setAttachmentVisible&&j.setAttachmentVisible(!1));else l.forEachByDepthFirst(function(b){for(h=0;f>h;h++)i=e[h],l.getLayerByElement(i)===b&&this._visibleMap[i._id]?(j=this._elementUIMap[i._id],null!=j&&this._isInView(j,a)&&(j.paint(c),j.setAttachmentVisible&&j.setAttachmentVisible(!0)),null!=j&&Tb.intersects(m,j.getZoomViewRect())?j.setAttachmentVisible&&j.setAttachmentVisible(!0):j.setAttachmentVisible&&j.setAttachmentVisible(!1),this.visibleList.add(i)):(j=this._elementUIMap[i._id],j&&j.setAttachmentVisible&&j.setAttachmentVisible(!1))},null,this);for(f=this._topAttachmentList.size(),h=0;f>h;h++)k=this._topAttachmentList.get(h),k.getElementUI().paintAttachment(c,k);if(this.paintTop(c,a),this._xyz!==b){var f,n=this._xyz,o=n.markText,p=n.type,q=(n.expired,n.innerHTML),r=0,s=0,t=this.viewRect;c.translate(this.viewRect.x/this.getZoom(),this.viewRect.y/this.getZoom()),c.scale(1/this.getZoom(),1/this.getZoom());var d=this.getZoom();o!=b&&null!=o&&""!=o||"2"==p?(c.font="15px Arial sans-serif",f=Jb.g.getTextSize(c.font,q),c.fillStyle="red",r=t.width-f.width,s=t.height-20):(c.font="10px Arial sans-serif",f=Jb.g.getTextSize(c.font,q),r=t.width/2-f.width/2,s=t.height/2),c.fillText(q,r,s)}c.restore(),this._invalidateMap={},this._invalidateAll=!1,this._paintAll=!1,this._dirtyRects=new md},paintBottom:function(a,b){},paintTop:function(a,b){},_isInView:function(a,b){return Tb.intersects(b,a.getZoomViewRect())},paintTopCanvas:function(){var a=this._topCanvas.getContext("2d");a.clearRect(0,0,this._topCanvas.width,this._topCanvas.height),this.paintMarker(a)},paintMarker:function(a){for(var b=this.markerList.size(),c=0;b>c;c++){var d=this.markerList.get(c);d.paint(a)}},getLayerByElement:function(a){return this._box.getLayerBox().getLayerByElement(a)},getLogicalPoint2:function(a){return this.zoomManager._getLogicalPoint(a)},getLogicalPoint:function(a){return this.zoomManager._getLogicalPoint(a,!0)},getElementAt:function(a){if(null==this.visibleList)return null;var b;if(a.target?b=this.getLogicalPoint2(a):a.event?a.event.target&&(b=this.getLogicalPoint2(a.event)):b=a,null!=this._topAttachmentList)for(var c=this._topAttachmentList.size(),d=c-1;d>=0;d--){var e=this._topAttachmentList.get(d);if(e.hit(b.x,b.y))return e.getElement()}if(null!=this.visibleList)for(var f=this.visibleList.size(),g=f-1;g>=0;g--){var h=this.visibleList.get(g),i=this.getElementUI(h);if(i&&i.hit(b.x,b.y))return h}return null},hitTest:function(a){var b=this.getElementAt(a);if(!b)return null;var c=this.getElementUI(b);if(!c)return null;var d;return d=a.target?this.getLogicalPoint2(a):a.event?this.getLogicalPoint2(a.event):a,c.hitTest(d.x,d.y)},getElementsAtRect:function(a,c,d,e){var f=new Ib.List;if(null==this.visibleList)return f;e=e===b?!0:e;for(var g=this.visibleList.size(),h=g-1;h>=0;h--){var i=this.visibleList.get(h),j=this.getElementUI(i);j&&(!d||d(j._element))&&(e&&this.isSelectable(j._element)||!e)&&(c?j.intersects(a)&&f.add(i):Tb.contains(a,j.getZoomViewRect(lc))&&f.add(i))}return f},getPosition:function(a,b,c,d,e,f){var g,h=b instanceof Ib.vector.ElementUI?b:this.getElementUI(b);if(h)if("from"===a||"to"===a){if(h.getFromPosition&&(g="from"===a?h.getFromPosition(d,e):h.getToPosition(d,e)))return c?{x:g.x-c.width/2,y:g.y-c.height/2}:g}else g="hotspot"===a?f?h.getZoomHotSpot(this.zoomManager):h.getHotSpot():Vb.get(a,f?h.getZoomBodyRect():h.getBodyRect(),c);if(!g&&b.getRect&&(g=Vb.get(a,b.getRect(),c)),g)return{x:g.x+d,y:g.y+e};throw"position '"+a+"' object '"+b+"'"},isValidEvent:function(a){if(!a)return!1;var b,c;if(a.currentTarget===this._view){if(Qb.isFirefox?(b=a.layerX,c=a.layerY):(b=a.offsetX,c=a.offsetY),1==this.isHScrollBarVisible()&&c>=this.viewRect.height-this.getScrollBarWidth())return!1;if(1==this.isVScrollBarVisible()&&b>=this.viewRect.width-this.getScrollBarWidth())return!1}return!0},addMarker:function(a){this.markerList.add(a),this.repaintTopCanvas()},removeMarker:function(a){this.markerList.remove(a),this.repaintTopCanvas()},clearMarker:function(){this.markerList.clear(),this.repaintTopCanvas()},isMovable:function(a){return this._box.contains(a)?a instanceof Ib.Link?!1:this._movableFunction&&!this._movableFunction(a)?!1:this.getLayerByElement(a).isMovable():!1},hasMovableSelectedElements:function(){for(var a=this.getSelectionContainer().getSelection(),b=0;b<a.size();b++){var c=a.get(b);if(this.isMovable(c))return!0}return!1},getMovableSelectedElements:function(){return this.getSelectionContainer().toSelection(function(a){return this.isMovable(a)},this)},moveSelectedElements:function(a,b,c,d){if(0!==a||0!==b){var e=this.getMovableSelectedElementsRect();null!=e&&(this._limitElementInPositiveLocation&&(e.x+a<0&&(a=-e.x),e.y+b<0&&(b=-e.y)),Ib.Util.moveElements(this.getMovableSelectedElements(),a,b,c,d,this))}},getMovableSelectedElementsRect:function(){var a=this.getMovableSelectedElements();if(0===a.size())return null;for(var b=null,c=0,d=a.size();d>c;c++){var e=a.get(c);if(e instanceof Jd){var f=this.getElementUI(e);f&&(b=Tb.unionRect(b,f.getViewRect()))}}return b},isVisible:function(a,b,c){if(!this._box.contains(a))return!1;if(!a.isVisible())return!1;if(3!==arguments.length&&(b=this._visibleFunction),b&&!b(a))return!1;if(!(c||this._box._layerBox.getLayerByElement(a))._visible)return!1;if(vc.getSubGl3dview(a)!==this._currentSubGl3dview)return!1;if(!this.zoomManager.isElementVisible(a))return!1;if(a instanceof Ib.Link){if(!this._noAgentLinkVisible){if(!a._fromAgent||!a._toAgent)return!1;if(!this.isVisible(a._fromAgent,b,c)||!this.isVisible(a._toAgent,b,c))return!1}if(a.getBundleIndex()>0&&a.getBundleCount()>1&&!a.getStyle("link.bundle.expanded"))return!1}else for(var d=a._parent;d&&!d.ISubGl3dview;){if(d instanceof Ib.Group&&(!d.isExpanded()||!this.isVisible(d,b,c)))return!1;d=d._parent}return a.IDummy?!1:!0},getVisibleFunction:function(){return this._visibleFunction},setVisibleFunction:function(a){var b=this._visibleFunction;this._visibleFunction=a,this.firePropertyChange("visibleFunction",b,a),this.invalidateElementVisibility()},isEditable:function(a){return this._box.contains(a)?this._editableFunction&&!this._editableFunction(a)?!1:this.getLayerByElement(a).isEditable():!1},getEditableFunction:function(){return this._editableFunction},setEditableFunction:function(a){var b=this._editableFunction;this._editableFunction=a,this.firePropertyChange("editableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isRotatable:function(a){return this._rotatableFunction&&!this._rotatableFunction(a)?!1:!0},getRotatableFunction:function(){return this._rotatableFunction},setRotatableFunction:function(a){var b=this._rotatableFunction;this._rotatableFunction=a,this.firePropertyChange("rotatableFunction",b,a),this.invalidateSelectedElementUIs(!0)},isLinkable:function(a,b){return null==this._linkableFunction||this._linkableFunction(a,b)},getLinkableFunction:function(){return this._linkableFunction},setLinkableFunction:function(a){var b=this._linkableFunction;this._linkableFunction=a,this.firePropertyChange("linkableFunction",b,a),this.invalidateSelectedElementUIs(!0)},onShareSelectionContainerChanged:function(){this.invalidateElementUIs()},getShadowColor:function(a){var b=a.getStyle("shadow.color");return!b&&this.isSelected(a)&&"shadow"===a.getStyle("select.style")?a.getStyle("select.color"):b},getSelectColor:function(a){return a.getStyle("select.color")},getAlarmLabel:function(a){var b=a.getAlarmState().getHighestNewAlarmSeverity();if(b){var c=a.getAlarmState().getNewAlarmCount(b)+b.nickName;return a.getAlarmState().hasLessSevereNewAlarms()&&(c+="+"),c}return null},getLinkHandlerLabel:function(a){return a.isBundleAgent()?"+("+a.getBundleCount()+")":null},setInteractions:function(a){var b=this._interactions;b&&b.forEach(function(a){a.tearDown()}),this._interactions=a,a&&a.forEach(function(a){a.setUp()}),this.invalidateSelectedElementUIs(!0),this.firePropertyChange("interactions",b,a)},getInteractions:function(){return this._interactions},setDefaultInteractions:function(a){this.setInteractions([new Ib.vector.interaction.DefaultInteraction(this,a)])},setTouchInteractions:function(){this.setInteractions([new Ib.vector.interaction.TouchInteraction(this)])},setMSTouchInteractions:function(){this.setInteractions([new Ib.vector.interaction.MSTouchInteraction(this)])},setEditInteractions:function(a){this.setInteractions([new Ib.vector.interaction.EditInteraction(this,a),new Ib.vector.interaction.DefaultInteraction(this)])},setCreateElementInteractions:function(a){this.setInteractions([new Ib.vector.interaction.CreateElementInteraction(this,a),new Ib.vector.interaction.DefaultInteraction(this)])},setCreateLinkInteractions:function(a){this.setInteractions([new Ib.vector.interaction.CreateLinkInteraction(this,a),new Ib.vector.interaction.DefaultInteraction(this)])},setCreateShapeLinkInteractions:function(a){this.setInteractions([new Ib.vector.interaction.CreateShapeLinkInteraction(this,a),new Ib.vector.interaction.DefaultInteraction(this)])},setCreateShapeNodeInteractions:function(a){this.setInteractions([new Ib.vector.interaction.CreateShapeNodeInteraction(this,a),new Ib.vector.interaction.DefaultInteraction(this)])},setMagnifyInteractions:function(){
this.setInteractions([new Ib.vector.interaction.DefaultInteraction(this),new Ib.vector.interaction.MagnifyInteraction(this)])},hasEditInteraction:function(){return this._hasEditInteraction},setHasEditInteraction:function(a){var b=this._hasEditInteraction;this._hasEditInteraction=a,this.firePropertyChange("hasEditInteraction",b,a)},addElementByInteraction:function(a){a.getParent()||a.setParent(this._currentSubGl3dview),this._box.add(a),this.getSelectionContainer().setSelection(a),this.fireInteractionEvent({kind:"createElement",element:a})},getToolTip:function(a){if(a){var b=a.getToolTip();return b?b:a.getName()}return null},isToolTipEnabled:function(){return this._toolTipEnabled?!0:!1},setToolTipEnabled:function(a){if(this._toolTipEnabled=a,a){if(!this._toolTipListener){var b=this;this._toolTipListener=function(a){if(b.isMovingElement())return void Bc.hideToolTip();var c=b.getElementAt(a);if(b._preElement!==c)if(b._preElement=c,c){var d=b.getToolTip(c);Bc.showToolTip({x:a.pageX,y:a.pageY},d);var e=Bc.getToolTipDiv();if(e.children.length>0){var f=b._view.getBoundingClientRect(),g=e.getBoundingClientRect();g.width+g.left>f.width+f.left&&(e.style.left=f.width+f.left-g.width+(Ob.documentElement.scrollLeft||Ob.body.scrollLeft)+"px"),g.height+g.top>f.height+f.top&&(e.style.top=f.height+f.top-g.height+(Ob.documentElement.scrollTop||Ob.body.scrollTop)+"px")}}else Bc.hideToolTip()},this._view.addEventListener("mousemove",this._toolTipListener,!1),this.firePropertyChange("toolTipEnabled",!1,!0)}}else this._toolTipListener&&(Bc.hideToolTip(),this._view.removeEventListener("mousemove",this._toolTipListener,!1),delete this._toolTipListener,this.firePropertyChange("toolTipEnabled",!0,!1))},setZoom:function(a,b){if(a=this.checkZoom(a),this.isAsyncZoomAndViewRect())var c=this._zoomMap[this._currentSubGl3dview].zoom;else var c=this._zoom;if(a!=c){var d=this.getViewRect();b||(b={x:d.width/2,y:d.height/2});var e=this.viewRect,f=b.x-(b.x+e.x)*a/c,g=b.y-(b.y+e.y)*a/c;this.isAsyncZoomAndViewRect()?this._zoomMap[this._currentSubGl3dview].zoom=a:this._zoom=a,this._paintAll=!0,this.invalidateElementVisibility(),this.invalidateCanvasSize(),this.zoomManager._invalidateZoom(),this.setViewRect(-f,-g,this.viewRect.width,this.viewRect.height),this._asyncZoomAndViewRect?this.firePropertyChange("zoom",c,this._zoomMap[this._currentSubGl3dview].zoom):this.firePropertyChange("zoom",c,this._zoom)}},getZoom:function(){if(this.isAsyncZoomAndViewRect()){var a=this._zoomMap[this._currentSubGl3dview];return a||(this._zoomMap[this._currentSubGl3dview]={zoom:1}),this._zoomMap[this._currentSubGl3dview].zoom}return this._zoom},getSizeZoom:function(a){return this.zoomManager.getSizeZoom(a)},getLocationZoom:function(){return this.zoomManager.getLocationZoom()},getGraphicsZoom:function(){return this.zoomManager.getGraphicsZoom()},zoomOverview:function(a){if(!(this._unionBounds.width<=0||this._unionBounds.width<=0)){var b=this.getZoom(),c=this._unionBounds,d=c.width/b,e=c.height/b,f=this.viewRect.width/d,g=this.viewRect.height/e,h=Math.min(f,g);this.setZoom(h);var i=this.getZoom();if(this.setViewRect(this._unionBounds.x*i/b,this._unionBounds.y*i/b,this.viewRect.width,this.viewRect.height),1!=this.getLocationZoom()){var j=null==arguments[1]?5:arguments[1];if(j>0){j--;var k=this;setTimeout(function(){k.zoomOverview(a,j)},25)}}}},zoomReset:function(a){this.setZoom(1,a)},zoomIn:function(a){this.setZoom(1.2*this.getZoom(),a)},zoomOut:function(a){this.setZoom(this.getZoom()/1.2,a)},upSubGl3dview:function(a,b){this._currentSubGl3dview&&this.setCurrentSubGl3dview(vc.getSubGl3dview(this._currentSubGl3dview),a,b)},getCurrentSubGl3dview:function(){return this._currentSubGl3dview},setCurrentSubGl3dview:function(a,b,c){if(Ib.animate.AnimateManager.endAnimate(),b){if(this._currentSubGl3dview===a)return;if(a&&!this._box.contains(a))throw a+" is not contained in this gl3dview's elementBox";var d=new Ib.animate.AnimateSubGl3dview(this,a,c);Ib.animate.AnimateManager.start(d)}else this._setCurrentSubGl3dview(a),c&&c()},_setCurrentSubGl3dview:function(a){if(this._currentSubGl3dview!==a){if(a&&!this._box.contains(a))throw a+" is not contained in this gl3dview's elementBox";if(this.isAsyncZoomAndViewRect()){var b=this._viewRectMap[this._currentSubGl3dview];this._viewRectMap[this._currentSubGl3dview]=b?this.viewRect:this.viewRect?this.viewRect:{x:0,y:0,width:this.viewRect.width,height:this.viewRect.height}}var c=this._currentSubGl3dview;if(this._currentSubGl3dview=a,this.firePropertyChange("currentSubGl3dview",c,a),this.isAsyncZoomAndViewRect()){this._viewRectMap[this._currentSubGl3dview]||(this._viewRectMap[this._currentSubGl3dview]={x:0,y:0,width:this.viewRect.width,height:this.viewRect.height});var b=this._viewRectMap[this._currentSubGl3dview];this.setViewRect(b.x,b.y,b.width,b.height),this.invalidateElementUIs()}this.invalidateElementVisibility(),this.invalidateCanvasSize(),this._paintAll=!0}},makeVisible:function(a){var b=this.getElementUI(a);if(b){var c=vc.getSubGl3dview(a);if(c!==this._currentSubGl3dview){var d=this;return void this.setCurrentSubGl3dview(c,this.isSubGl3dviewAnimate(),function(){Jb.callLater(d.makeVisible,d,[a])})}for(var e=a;(e=e.getParent())&&e!==c;)e instanceof Ib.Group&&e.setExpanded(!0);var f=b.getViewRect();if(f){var g,h=b.getZoomViewRect(this.zoomManager);g=f.x==h.x&&f.y==h.y&&f.width==h.width&&f.height==h.height?{x:f.x*this.getGraphicsZoom(),y:f.y*this.getGraphicsZoom(),width:f.width*this.getGraphicsZoom(),height:f.height*this.getGraphicsZoom()}:h,Tb.intersects(this.viewRect,g)||this.isVisible(a)&&Jb.callLater(this.centerByLogicalPoint,this,[g.x+g.width/2,g.y+g.height/2])}}},centerByLogicalPoint:function(a,b,c){var d=a-this.viewRect.width/2,e=b-this.viewRect.height/2;this.setViewRect(d,e,this.viewRect.width,this.viewRect.height)},panByOffset:function(a,b){this.setViewOffSet(a,b)},getIconsNames:function(a){return a.getStyle("icons.names")},getIconsColors:function(a){return a.getStyle("icons.colors")},getLinkFlowStepping:function(a){var b=parseInt(a.getStyle("link.flow.stepping"));return b||(b=Cd.NETWORK_LINK_FLOW_STEPPING),b},getLinkFlowOffset:function(a){var b=a.getStyle("link.flow.offset");return isNaN(b)&&(b=0),b+this.getLinkFlowStepping(a)},toCanvas:function(a,b,c,d,e,f){c||(c=Wb.createCanvas()),c.setAttribute("width",a),c.setAttribute("height",b),c._viewRect?(c._viewRect.width=a,c._viewRect.height=b):c._viewRect={x:0,y:0,width:a,height:b};var g=c.getContext("2d");if(g.translate(-e,-f),g.clearRect(0,0,a,b),ld.draw(g,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;a/this.realWidth*this.getGraphicsZoom(),b/this.realHeight*this.getGraphicsZoom();g.scale(d,d);var h=this.getElementBox().getDatas()._as,i=h.length;this._topAttachmentList=new Ib.List;var j,k,l,m,n,o,p=this.getElementBox().getLayerBox(),q=p.getRoots(),r=q.size();if(1===r)for(l=0;i>l;l++)m=h[l],this._visibleMap[m._id]&&(n=this._elementUIMap[m._id],null!=n&&n.paint(g));else for(j=0;r>j;j++)for(k=q.get(j),l=0;i>l;l++)m=h[l],p.getLayerByElement(m)===k&&this._visibleMap[m._id]&&(n=this._elementUIMap[m._id],null!=n&&n.paint(g));for(i=this._topAttachmentList.size(),l=0;i>l;l++)o=this._topAttachmentList.get(l),o.getElementUI().paintAttachment(g,o);return c},toCanvasByRegion:function(a,b,c){c||(c=Wb.createCanvas());var d=a.width*b,e=a.height*b;c.setAttribute("width",d),c.setAttribute("height",e),c._viewRect?(c._viewRect.width=d,c._viewRect.height=e):c._viewRect={x:0,y:0,width:d,height:e};var f=c.getContext("2d");if(f.clearRect(0,0,d,e),ld.draw(f,this),0===this._view.clientWidth||0===this._view.clientHeight)return c;f.save(),f.scale(b,b),f.beginPath(),f.translate(-a.x,-a.y);var g=this.getElementBox().getDatas()._as,h=g.length;this._topAttachmentList=new Ib.List;var i,j,k,l,m,n,o=this.getElementBox().getLayerBox(),p=o.getRoots(),q=p.size();if(1===q)for(k=0;h>k;k++)l=g[k],this._visibleMap[l._id]&&(m=this._elementUIMap[l._id],null!=m&&Tb.intersects(a,m.getZoomViewRect())&&m.paint(f));else for(i=0;q>i;i++)for(j=p.get(i),k=0;h>k;k++)l=g[k],o.getLayerByElement(l)===j&&this._visibleMap[l._id]&&(m=this._elementUIMap[l._id],null!=m&&Tb.intersects(a,m.getZoomViewRect())&&m.paint(f));for(h=this._topAttachmentList.size(),k=0;h>k;k++)n=this._topAttachmentList.get(k),n.getElementUI().paintAttachment(f,n);return f.restore(),c},getGroupChildrenRects:function(a){return this.zoomManager._getGroupChildrenRects(a)},convertPointFromView:function(a){return this.zoomManager._convertPointFromView(a)},getOffset:function(a,b){return this.zoomManager._getOffset(a,b)},panToCenter:function(){this.setViewRect((this.realWidth-this.viewRect.width)/2,(this.realHeight-this.viewRect.height)/2,this.viewRect.width,this.viewRect.height)},getLinkPathFunction:function(){return this._linkPathFunction},setLinkPathFunction:function(a){var b=this._linkPathFunction;this._linkPathFunction=a,this.firePropertyChange("linkPathFunction",b,a),this.invalidateElementUIs()},invalidate:function(){this._invalidate||(this._invalidate=!0,this.fireViewEvent({kind:"invalidate"}))},validate:function(){this._invalidate&&(Mb||0!==this._view.offsetWidth||0!==this._view.offsetHeight)&&(this._invalidate=!1,this._isValidating=!0,this.fireViewEvent({kind:"validateStart"}),this.validateImpl(),this.fireViewEvent({kind:"validateEnd"}),this._isValidating=!1)},onClickElement:function(a,b){},onClickBackground:function(a){},onDoubleClickElement:function(a,b){},onDoubleClickBackground:function(a){},onLongClickElement:function(a,b){},onLongClickBackground:function(a){},onMouseMove:function(a,b){},onMouseEnter:function(a,b){},onMouseLeave:function(a,b){}}),Ib.vector.Overview=function(a){Ib.vector.Overview.superClass.constructor.apply(this,a),this._view=Wb.createView(),this._rootDiv=Wb.createDiv(),this._imageCanvas=Wb.createCanvas(),this._imageDiv=Wb.createDiv(),this._maskCanvas=Wb.createCanvas(),this._selectDiv=Wb.createDiv(),this._isGl3dviewDirty=!1,this._isMaskDirty=!1,Wb.setVisible(this._selectDiv,!1),this._view.appendChild(this._rootDiv),this._rootDiv.appendChild(this._imageDiv),this._rootDiv.appendChild(this._maskCanvas),this._rootDiv.appendChild(this._selectDiv),this._imageDiv.appendChild(this._imageCanvas),this._exportImageCanvas=Wb.createCanvas(),this._imageCtx=this._imageCanvas.getContext("2d"),this.setGl3dview(a);var b;b=Qb.isMSToucheable?Ib.vector.OverviewMSTouchInteraction:Qb.isTouchable?Ib.vector.OverviewTouchInteraction:Ib.vector.OverviewInteraction,b&&new b(this)},Jb.ext("twaver.vector.Overview",Ib.controls.ControlBase,{__accessor:["fillColor","outlineColor","outlineWidth","selectColor","selectWidth","padding","maxPackingWidth","maxPackingHeight"],__bool:["animate"],_fillColor:Cd.OVERVIEW_FILL_COLOR,_outlineColor:Cd.OVERVIEW_OUTLINE_COLOR,_outlineWidth:Cd.OVERVIEW_OUTLINE_WIDTH,_selectColor:Cd.OVERVIEW_SELECT_COLOR,_selectWidth:Cd.OVERVIEW_SELECT_WIDTH,_padding:Cd.OVERVIEW_PADDING,_animate:Cd.OVERVIEW_ANIMATE,_maxPackingWidth:Cd.OVERVIEW_MAX_PACKING_WIDTH,_maxPackingHeight:Cd.OVERVIEW_MAX_PACKING_HEIGHT,getGl3dview:function(){return this._gl3dview},onPropertyChanged:function(a){this._invalidateMask()},setGl3dview:function(a){a!==this._gl3dview&&(this._gl3dview&&(this._gl3dview.removePropertyChangeListener(this._handleGl3dviewPropertyChange,this),this._gl3dview.removeViewListener(this._handleGl3dviewViewChange,this),Wb.removeEventListener("scroll","_handleScrollChange",this._gl3dview.getView(),this)),this._gl3dview=a,this._gl3dview&&(this._gl3dview.addPropertyChangeListener(this._handleGl3dviewPropertyChange,this),this._gl3dview.addViewListener(this._handleGl3dviewViewChange,this),Wb.addEventListener("scroll","_handleScrollChange",this._gl3dview.getView(),this)),this.invalidate())},_handleGl3dviewPropertyChange:function(a){("zoom"===a.property||"currentSubGl3dview"===a.property||"elementBox"===a.property||"dataBox"===a.property||"canvasSizeChange"===a.property)&&this.invalidate()},_handleGl3dviewViewChange:function(a){"validateEnd"===a.kind&&this.invalidate()},_handleScrollChange:function(){this._invalidateMask()},invalidate:function(a){this._isGl3dviewDirty&&this._isMaskDirty||(this._isGl3dviewDirty||(this._isGl3dviewDirty=!0),this._isMaskDirty||(this._isMaskDirty=!0),Jb.callLater(this.validate,this,null,a))},_invalidateMask:function(){this._isMaskDirty||(this._isMaskDirty=!0,Jb.callLater(this.validate,this,[],100))},validate:function(){if((this._isMaskDirty||this._isGl3dviewDirty)&&this._gl3dview&&(this._maxPackingWidth>0&&this._maxPackingHeight>0||this._view.clientWidth>0&&this._view.clientHeight>0)&&0!==this._gl3dview.getViewRect().width&&0!==this._gl3dview.getViewRect().height&&!this._gl3dview._invalidate){var a,b=this._maxPackingWidth>0&&this._maxPackingHeight>0;a=b?{x:0,y:0,width:this._maxPackingWidth,height:this._maxPackingHeight}:{x:0,y:0,width:this._view.clientWidth,height:this._view.clientHeight},Tb.grow(a,-this._padding,-this._padding),b&&(Wb.setDiv(this._view,{x:0,y:0,width:this._imageDiv._viewRect.width,height:this._imageDiv._viewRect.height},null,0,null),a.width=this._imageDiv._viewRect.width,a.height=this._imageDiv._viewRect.height);var c=this._gl3dview.getGraphicsZoom(),d=this._gl3dview._unionBounds;d=Tb.unionRect(d,{x:this._gl3dview.getViewRect().x,y:this._gl3dview.getViewRect().y,width:d.x,height:d.y}),d={x:d.x/c,y:d.y/c,width:d.width/c,height:d.height/c};var e={x:this._gl3dview.viewRect.x/c,y:this._gl3dview.viewRect.y/c,width:this._gl3dview.viewRect.width/c,height:this._gl3dview.viewRect.height/c},f=Tb.unionRect(d,e),g=Math.min(a.width/f.width,a.height/f.height),h=f.width*g,i=f.height*g,j=f.width*g,k=f.height*g,l=a.x+(a.width-j)/2,m=a.y+(a.height-k)/2;if(this._isGl3dviewDirty){var n={x:l,y:m,width:j,height:k};this._gl3dview.toCanvas(h,i,this._exportImageCanvas,g,f.x*g,f.y*g),this._imageCanvas.setAttribute("width",j),this._imageCanvas.setAttribute("height",k),this._imageCtx.drawImage(this._exportImageCanvas,(d.x-f.x)*g*c,(d.y-f.y)*g*c,h,i),Wb.setDiv(this._imageDiv,n,null,0,null),this._gl3dview.getElementBox&&(this._imageDiv.style.backgroundColor=(this._gl3dview.getCurrentSubGl3dview()||this._gl3dview.getElementBox()).getStyle("background.color")||""),this._isGl3dviewDirty=!1}if(this._isMaskDirty){var o={x:(e.x-f.x)*g,y:(e.y-f.y)*g,width:e.width*g,height:e.height*g},p=Wb.setCanvas(this._maskCanvas,l,m,j,k);p.lineWidth=0,p.fillStyle=this._fillColor,Xb.drawVector(p,"rectangle",null,l,m,j,k),p.closePath(),p.fill(),p.stroke(),p.clearRect(l+o.x,m+o.y,o.width,o.height),p.lineWidth=this._outlineWidth,p.strokeStyle=this._outlineColor;var q=o.width-2*this._outlineWidth,r=o.height-2*this._outlineWidth;q=Math.min(q,j-2-o.x-this._outlineWidth),r=Math.min(r,k-2-o.y-this._outlineWidth),Xb.drawVector(p,"rectangle",null,l+o.x+this._outlineWidth,m+o.y+this._outlineWidth,q,r),p.closePath(),p.stroke(),this._isMaskDirty=!1}}else this._isGl3dviewDirty=!1,this._isMaskDirty=!1},getLogicalPoint:function(a){return Wb.getLogicalPoint(this._view,a,1,this._rootDiv)},centerGl3dview:function(a,b){var c=this._imageDiv._viewRect;Tb.containsPoint(c,a)&&(this._gl3dview.centerByLogicalPoint((a.x-c.x)/c.width*this._gl3dview.getCanvasSize().width,(a.y-c.y)/c.height*this._gl3dview.getCanvasSize().height,b),this._invalidateMask())}}),Ib.vector.OverviewTouchInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,Wb.addEventListener("touchstart","handleTouchstart",this.view,this)},Jb.ext("twaver.vector.OverviewTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),this.clear(),this.endPoint=this.overview.getLogicalPoint(a),zc.isMultiTouch(a)&&(this.distance=zc.getDistance(a),this.zoom=this.gl3dview.getZoom()),Wb.addEventListener("touchmove","handleTouchmove",this.view,this),Wb.addEventListener("touchend","handleTouchend",this.view,this)},handleTouchmove:function(a){if(this.moved||(this.moved=!0),this.endPoint=this.overview.getLogicalPoint(a),zc.isSingleTouch(a))this.overview.centerGl3dview(this.endPoint,!1);else if(this.distance){var b=zc.getDistance(a)/this.distance;this.gl3dview.setZoom(this.zoom*b,!1)}},handleTouchend:function(a){if(!this.moved){this.endPoint=this.overview.getLogicalPoint(a);var b=this.lastPoint&&this.lastTouchStartTime&&(new Date).getTime()-this.lastTouchStartTime.getTime()<=300&&Math.abs(this.endPoint.x-this.lastPoint.x)<=10&&Math.abs(this.endPoint.y-this.lastPoint.y)<=10;b?(this.lastPoint=null,this.lastTouchStartTime=null):(this.lastPoint=this.endPoint,this.lastTouchStartTime=new Date),b?Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]):this.overview.centerGl3dview(this.endPoint,this.overview._animate)}this.clear()},clear:function(){this.endPoint&&(this.endPoint=null,Wb.removeEventListener("touchmove",this.view,this),Wb.removeEventListener("touchend",this.view,this)),this.moved=!1}}),Ib.vector.OverviewMSTouchInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,this._pointerMap={},this._pointerIdArray=[];var b=this;this.view.addEventListener("MSPointerDown",function(a){b.handleTouchstart(a)},!1),this.view.addEventListener("MSPointerMove",function(a){b.handleTouchmove(a)},!1),this.view.addEventListener("MSPointerUp",function(a){b.handleTouchend(a)},!1),this.view.addEventListener("MSPointerCancel",function(a){b.handleTouchend(a)},!1)},Jb.ext("twaver.vector.OverviewMSTouchInteraction",Object,{handleTouchstart:function(a){Wb.preventDefault(a),a.isPrimary&&this._pointerIdArray.length>0&&(this._pointerMap={},this._pointerIdArray=[]),!this._pointerMap[a.pointerId]&&this.overview.getLogicalPoint(a)&&(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length?(this._startTouchPoint=this.overview.getLogicalPoint(a),this._startTouchTime=new Date):2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.gl3dview.getZoom())},handleTouchmove:function(a){if(0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10))if(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length){var b=this._getDistance()/this._distance;this.gl3dview.setZoom(this._zoom*b,!1)}else if(1==this._pointerIdArray.length&&this._startTouchPoint){var c=this.overview.getLogicalPoint(a);if(null==c)return;this._startTouchPoint=c,this.overview.centerGl3dview(this._startTouchPoint,!1)}},handleTouchend:function(a){var b=this.overview.getLogicalPoint(a);if(1==this._pointerIdArray.length&&b){var c=this._endTouchPoint&&this._endTouchTime&&(new Date).getTime()-this._endTouchTime.getTime()<=500&&Tb.getDistance(this._endTouchPoint,b)<=10;c?(this._endTouchPoint=null,this._endTouchTime=null):(this._endTouchPoint=b,this._endTouchTime=new Date),c?Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.overview._animate]):this.overview.centerGl3dview(this._endTouchPoint,this.overview._animate)}this._pointerMap={},this._pointerIdArray=[]},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})}}),Ib.vector.OverviewInteraction=function(a){this.overview=a,this.gl3dview=a.getGl3dview(),this.view=a._view,Wb.addEventListener("mousedown","handleMousedown",this.view,this)},Jb.ext("twaver.vector.OverviewInteraction",Object,{handleMousedown:function(a){this.clear(),this.endPoint=this.overview.getLogicalPoint(a),Jb.isCtrlDown(a)&&(this.startPoint=this.endPoint,Wb.setVisible(this.overview._selectDiv,!0)),Wb.addEventListener("mousemove","handleMousemove",this.view,this),Wb.addEventListener("mouseup","handleMouseup",this.view,this)},handleMouseup:function(a){if(this.endPoint=this.overview.getLogicalPoint(a),"detail"in a&&2===a.detail)Jb.callLater(this.gl3dview.zoomReset,this.gl3dview,[this.endPoint,this.overview._animate]);else if(Wb.isVisible(this.overview._selectDiv)&&this.startPoint){var b=this.overview._imageDiv._viewRect,c=this.overview._selectDiv._viewRect.x,d=this.overview._selectDiv._viewRect.y,e=b.width/this.overview._selectDiv._viewRect.width,f=b.height/this.overview._selectDiv._viewRect.height,g=Math.min(e,f);this.gl3dview.setZoom(g*Math.min(this.gl3dview.getViewRect().width/this.gl3dview.getCanvasSize().width,this.gl3dview.getViewRect().height/this.gl3dview.getCanvasSize().height)*this.gl3dview.getZoom(),!1);var h=this.gl3dview.getCanvasSize().width*((c-b.x+this.overview._selectDiv._viewRect.width/2)/b.width),i=this.gl3dview.getCanvasSize().height*((d-b.y+this.overview._selectDiv._viewRect.height/2)/b.height);Jb.callLater(this.gl3dview.centerByLogicalPoint,this.gl3dview,[h,i,this.overview._animate]),Wb.setVisible(this.overview._selectDiv,!1),Wb.setDiv(this.overview._selectDiv,{x:0,y:0,width:0,height:0},null,0,null),this.startPoint=null}else this.overview.centerGl3dview(this.endPoint,this.overview._animate);this.clear()},handleMousemove:function(a){var b=this.overview.getLogicalPoint(a);if(this.endPoint=b,Wb.isVisible(this.overview._selectDiv)&&this.startPoint){var c=b.x>this.startPoint.x?this.startPoint.x:b.x,d=b.x>this.startPoint.x?this.startPoint.y:b.y;b.x>this.startPoint.x&&b.y<this.startPoint.y&&(d=b.y),b.x<this.startPoint.x&&b.y>this.startPoint.y&&(d=this.startPoint.y);var e=this.overview._imageDiv._viewRect;c<e.x&&(c=e.x),c>e.x+e.width&&(c=e.x+e.width),d<e.y&&(d=e.y),d>e.y+e.height&&(d=e.y+e.height);var f=Math.abs(b.x-this.startPoint.x),g=Math.abs(b.y-this.startPoint.y);c+f>e.x+e.width&&(f=e.x+e.width-c),d+g>e.y+e.height&&(g=e.y+e.height-d),Wb.setDiv(this.overview._selectDiv,{x:c,y:d,width:f,height:g},null,this.overview._selectWidth,this.overview._selectColor)}else this.overview.centerGl3dview(b,!1)},clear:function(){this.endPoint&&(this.endPoint=null,Wb.removeEventListener("mousemove",this.view,this),Wb.removeEventListener("mouseup",this.view,this))}}),Ib.vector.ElementUI=function(a,b){this._gl3dview=a,this._element=b,this._attachments=new Ib.List,this._bodyBounds=new Ib.List,this._hitTest=!1,this._hitTest=!1,this._intersectTest=!1,this.invalidate(!0)},Jb.ext("twaver.vector.ElementUI",Object,{getElement:function(){return this._element},getGl3dview:function(){return this._gl3dview},handlePropertyChange:function(a){},handleSelectionChange:function(a){},invalidate:function(a){a===b&&(a=!0),a&&(this._invalidateAttachmentsFlag=!0),this._invalidateFlag||(this._hotSpot=null,this._bodyRect=null,this._invalidateFlag=!0,this.invalidateZoom(),this.setAttachmentVisible&&this.setAttachmentVisible(!1))},invalidateZoom:function(){this._zoomBodyRect=null,this._zoomViewRect=null,this._zoomHotSpot=null},updateStyle:function(){this._innerColor=this._gl3dview.getInnerColor(this._element),this._outerColor=this._gl3dview.getOuterColor(this._element),this._shadowColor=this._gl3dview.getShadowColor(this._element),this._shadowXOffset=this._element.getStyle("shadow.xoffset"),this._shadowYOffset=this._element.getStyle("shadow.yoffset"),this._shadowBlur=this._element.getStyle("shadow.blur"),this._wholeAlpha=this._element.getStyle("whole.alpha")},validate:function(){var a=this;if(0!=this._invalidateFlag){this._bodyBounds.clear(),this._invalidateAttachmentsFlag&&(this._invalidateAttachmentsFlag=!1,this.checkAttachments()),this._invalidateFlag=!1,this.updateStyle(),this.validateImpl(),this._attachments.forEach(function(a){a.validate()});var b;this._bodyBounds.forEach(function(a){b=Tb.unionRect(b,a)}),null==b&&(b=Jb.cloneRect(this._element.getLocation()),b.width=0,b.height=0),this._unionBodyBounds={x:b.x,y:b.y,width:b.width,height:b.height},this._attachments.forEach(function(c){b=c instanceof Ib.vector.EditAttachment?c.getElementUI()instanceof Ib.vector.LinkUI?Tb.unionRect(b,c._viewRect):Tb.unionRect(b,a._gl3dview.zoomManager._reverseElementZoomRect(a,c._viewRect)):c.getElementUI()instanceof Ib.vector.LinkUI?Tb.unionRect(b,a._gl3dview.zoomManager._getAttachmentZoomOutLineRect(c,c._viewRect)):c.getElementUI()instanceof Ib.vector.GroupUI&&c.getElementUI()._shapeRect?c instanceof Ib.vector.IconsAttachment?Tb.unionRect(b,c._viewRect):Tb.unionRect(b,a._gl3dview.zoomManager._getAttachmentZoomOutLineRect(c,c._viewRect)):Tb.unionRect(b,c._viewRect)}),this._viewRect=b}},validateImpl:function(){},setShadow:function(a,b){var c=this._gl3dview.zoomManager,d=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(b.shadowOffsetX===this._shadowXOffset&&b.shadowOffsetY===this._shadowYOffset&&b.shadowBlur===this._shadowBlur)return b;if(d){var e=c.getGraphicsZoom(),f=c.getSizeZoom();e*=f,e>1&&(e=1),b.shadowOffsetX=this._shadowXOffset*e,b.shadowOffsetY=this._shadowYOffset*e,b.shadowBlur=this._shadowBlur*e,b.shadowColor=this._shadowColor}return b},clearShadow:function(a){(0!=a.shadowOffsetX||0!=a.shadowOffsetY||0!=a.shadowBlur)&&(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0)},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(c){var d=this._gl3dview.zoomManager,e=d.getGraphicsZoom(),f=d.getSizeZoom();e*=f,e>1&&(e=1),this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset);var g=this._shadowBlur;g=Math.ceil(g/e),Tb.grow(b,g+1,g+1)}return b},isShadowable:function(){return this._shadowColor&&this._gl3dview.isSelected(this._element)&&"shadow"===this._element.getStyle("select.style")?!0:!1},addAttachment:function(a){this._attachments.add(a),this.invalidate(!1)},removeAttachment:function(a){this._attachments.remove(a),this.invalidate(!1)},getAttachments:function(){return this._attachments},checkAttachments:function(){this.checkLabelAttachment(),this.checkLabel2Attachment(),this.checkAlarmAttachment(),this.checkIconsAttachment(),this.checkEditAttachment()},checkLabelAttachment:function(){var a=this._gl3dview.getLabel(this._element);null!=a&&""!==a?this._labelAttachment||(this._labelAttachment=new Ib.vector.LabelAttachment(this,Cd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkLabel2Attachment:function(){var a=this._gl3dview.getLabel2(this._element);null!=a&&""!==a?this._label2Attachment||(this._label2Attachment=new Ib.vector.Label2Attachment(this,Cd.SHOW_LABEL2_IN_ATTACHMENT_DIV),this.addAttachment(this._label2Attachment)):this._label2Attachment&&(this.removeAttachment(this._label2Attachment),this._label2Attachment=null)},checkAlarmAttachment:function(){var a=this._gl3dview.getAlarmLabel(this._element);null!=a&&""!==a?this._alarmAttachment||(this._alarmAttachment=new Ib.vector.AlarmAttachment(this,Cd.SHOW_ALARM_IN_ATTACHMENT_DIV),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},checkIconsAttachment:function(){var a=this._gl3dview.getIconsNames(this._element);a&&a.length>0?this._iconsAttachment||(this._iconsAttachment=new Ib.vector.IconsAttachment(this),this.addAttachment(this._iconsAttachment)):this._iconsAttachment&&(this.removeAttachment(this._iconsAttachment),this._iconsAttachment=null)},checkEditAttachment:function(){this._gl3dview.hasEditInteraction()&&this._gl3dview.isSelected(this._element)&&this._gl3dview.isEditable(this._element)&&this.isEditable()?this._editAttachment||(this._editAttachment=new Ib.vector.EditAttachment(this,Cd.SHOW_EDIT_IN_ATTACHMENT_DIV),this.addAttachment(this._editAttachment)):this._editAttachment&&(this.removeAttachment(this._editAttachment),this._editAttachment=null)},getLabelAttachment:function(){return this._labelAttachment},getAlarmAttachment:function(){return this._alarmAttachment},getIconsAttachment:function(){return this._iconsAttachment},getEditAttachment:function(){return this._editAttachment},isEditable:function(){return!0},getInnerColor:function(){return this._innerColor},getOuterColor:function(){return this._outerColor},getShadowColor:function(){return this._shadowColor},getDyeColor:function(a){return this._innerColor?this._innerColor:this.getStyle(a)},getStyle:function(a){return this._element.getStyle(a)},getFont:function(a){var b=this._element.getStyle(a);return b?b:Ib.Defaults.FONT},paint:function(a){a.save(),a.globalAlpha=this._wholeAlpha,a.beginPath(),this.paintBody(a),this.clearShadow(a),a.closePath(),a.beginPath(),this.paintAttachments(a),a.closePath(),a.restore(),this._gl3dview._debug&&Xb.strokeRect(a,this.getZoomViewRect(),"#820F8D")},paintBody:function(a){},getZoomBodyRect:function(a){return this._gl3dview.zoomManager._getElementZoomRect(this,this.getBodyRect())},getZoomHotSpot:function(){return this._zoomHotSpot||(this._zoomHotSpot=this._gl3dview.zoomManager._getZoomHotSpot(this,this._hotSpot)),Jb.clone(this._zoomHotSpot)},getZoomPointers:function(a,b){return this._gl3dview.zoomManager._getZoomPointers(a,this,b)},_getZoomViewRect:function(a,b,c){var d=this._gl3dview.zoomManager;if(b){var e=Jb.cloneRect(d._getAttachmentZoomRect(b,a));return e}var f=d.getLocationZoom(),g=d.getSizeZoom(this),h=this._bodyRect?this._bodyRect:this.getBodyRect();a=a||{x:h.x,y:h.y,width:0,height:0};var i=h.x+h.width/2,j=h.y+h.height/2;return{x:i*f+(a.x-i)*g,y:j*f+(a.y-j)*g,width:a.width*g,height:a.height*g}},getZoomViewRect:function(a){{var b=this._gl3dview.zoomManager,c=b.getLocationZoom();b.getGraphicsZoom()}if(1==c)return Jb.cloneRect(this._viewRect);if(!this._zoomViewRect||a){var d,e=this._getZoomViewRect(Jb.cloneRect(this._unionBodyBounds),!1);d=Tb.unionRect(d,e);this._attachments.forEach(function(a){d=a instanceof Ib.vector.EditAttachment?Tb.unionRect(d,a._viewRect):Tb.unionRect(d,a.getZoomViewRect())}),this._zoomViewRect=d}return Jb.cloneRect(this._zoomViewRect)},paintAttachments:function(a){a.beginPath();for(var b=this._attachments.size(),c=0;b>c;c++){var d=this._attachments.get(c);1==this._hitTest&&0==d.isShowOnTop()&&this.paintAttachment(a,d),1==this._intersectTest&&this.paintAttachment(a,d),0==this._hitTest&&0==this._intersectTest&&(d.isShowOnTop()?this._gl3dview._topAttachmentList.add(d):this.paintAttachment(a,d))}},paintAttachment:function(a,b){var c=this._gl3dview.zoomManager;c.isAttachmentVisible(this._element)&&(b!=this._labelAttachment&&b!=this._label2Attachment||c.isLabelVisible(this._element))&&(b!=this._alarmAttachment||c.isAlarmBalloonVisible(this._element))&&(a.beginPath(),b.paint(a),this.clearShadow(a))},getViewRect:function(){return Jb.cloneRect(this._viewRect)},getUnionBodyBounds:function(){return Jb.cloneRect(this._unionBodyBounds)},addBodyBounds:function(a){a&&this._bodyBounds.add(a)},getBodyRect:function(a){return a==b&&(a=!0),this._bodyRect||(this._bodyRect=this.createBodyRect()),a?Jb.cloneRect(this._bodyRect):this._bodyRect},getHotSpot:function(){return this._hotSpot?Jb.clone(this._hotSpot):{x:0,y:0}},setHotSpot:function(a){this._hotSpot=a},hit:function(a,b){return!1},intersects:function(a){return Tb.contains(a,this.getZoomViewRect())?!0:!1},hitCanvasRectAtBody:function(a){var b=Md.getHitCanvas(a.width,a.height),c=Md.getCtx(b);if(c.save(),c.translate(-a.x,-a.y),this._element.getImage){var d=Jb.getImageAsset(this._element.getImage());if(d&&d.getImage()instanceof Fd)return 1}this.paintBody(c);try{for(var e=c.getImageData(0,0,a.width,a.height),f=e.data,g=0;g<e.width;g++)for(var h=0;h<e.height;h++){var i=4*(h*e.width+g),j=f[i+3];if(0!==j)return c.restore(),1}}catch(k){if(Md.disposeHitCanvas(),Tb.contains(this.getUnionBodyBounds(),a))return 0}return c.restore(),-1},hitCanvasRectAtAttachments:function(a){var b=Md.getHitCanvas(a.width,a.height),c=Md.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paintAttachments(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),1}}catch(j){Md.disposeHitCanvas()}return c.restore(),-1},hitCanvasRect:function(a){this._intersectTest=!0,1==this._hitTest&&(this._intersectTest=!1);var b=Tb.intersection(a,this.getZoomViewRect()),c=this.hitCanvasRectAtBody(b);if(1==c)return this._intersectTest=!1,!0;var d=this.hitCanvasRectAtAttachments(b);
return 1==d?(this._intersectTest=!1,!0):(this._intersectTest=!1,0==c)},hitCanvasPoint:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();if(d&&d>0&&Tb.grow(c,d,d),!Tb.intersects(this.getZoomViewRect(),c))return!1;this._hitTest=!0;var e=this.hitCanvasRect(c);return this._hitTest=!1,e},hitTest:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();if(d&&d>0&&Tb.grow(c,d,d),!Tb.intersects(this.getZoomViewRect(),c))return null;var e=Tb.intersection(c,this.getZoomViewRect()),f=this.hitCanvasRectAtBody(e);if(1==f)return this;for(var g=this._attachments.size(),h=0;g>h;h++){var i=this._attachments.get(h);if(i.hit(a,b))return i}return 0==f?this:null},dispose:function(){this._attachments.forEach(function(a){a.dispose()}),this._attachments.clear()}}),Ib.vector.NodeUI=function(a,b){Ib.vector.NodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.NodeUI",Ib.vector.ElementUI,{invalidate:function(a){this.curInterval&&clearInterval(this.curInterval),Ib.vector.NodeUI.superClass.invalidate.call(this,a)},createBodyRect:function(){return this._element.getRect()},validateImpl:function(){Ib.vector.NodeUI.superClass.validateImpl.call(this);var a=this.getStyle("vector.shape"),b=this.getBodyRect();this._hotSpot=Tb.getHotSpot(b.x,b.y,b.width,b.height,a),this.validateBodyBounds()},validate:function(){0!=this._invalidateFlag&&Ib.vector.NodeUI.superClass.validate.call(this)},validateBodyBounds:function(){var a=this.getStyle("body.type");"default"===a?this.addBodyBounds(this.getDefaultBodyRect()):"vector"===a?this.addBodyBounds(this.getVectorBody()):"default.vector"===a?(this.addBodyBounds(this.getVectorBody()),this.addBodyBounds(this.getDefaultBodyRect())):"vector.default"===a&&(this.addBodyBounds(this.getDefaultBodyRect()),this.addBodyBounds(this.getVectorBody())),this._outerColor&&this.addBodyBounds(this.getOuterBorderRect()),!this._editAttachment&&"border"===this.getStyle("select.style")&&this._gl3dview.isSelected(this._element)&&this.addBodyBounds(this.getSelectBorderRect())},getDefaultBodyRect:function(){var a=this._element,b=this.getBodyRect();if(!a.getImage()||"string"==typeof a.getImage()&&!Jb.getImageAsset(a.getImage()))return b;Tb.addPadding(b,this._element,"image.padding",1);var c=Jb.cloneRect(b);return this.appendShadowBound(this,c),b=c},getVectorBody:function(){var a=this.getPathRect("vector");return a},getOuterBorderRect:function(){return this._getBorderRect("outer")},getSelectBorderRect:function(){return this._getBorderRect("select")},_getBorderRect:function(a){var b=this._element,c=b.getStyle(a+".width");if(c>0){var d=this.getBodyRect();Tb.addPadding(d,b,a+".padding",1);var e=Jb.cloneRect(d);return Tb.grow(e,2*c,2*c),e}return null},getPathRect:function(a,b){{var c=this._element,d=this.getBodyRect();this._gl3dview.zoomManager.getSizeZoom()}b&&Tb.addPadding(d,c,a+".padding",1);var e=Jb.cloneRect(d),f=c.getStyle(a+".outline.width");if(f>0)if(this._getZoomPoints){for(var g=this._element._points,h=g.size(),i=0,j=0;h>j;j++){if(0==j)var k=g.get(j),l=g.get(h-1),m=g.get(j+1);else if(j==h-1)var k=g.get(j),l=g.get(j-1),m=g.get(0);else var k=g.get(j),l=g.get(j-1),m=g.get(j+1);var n=Tb.getCenterPoint(l,m),o=Tb.getAngle(n,k),p=Math.abs(5*(f+1)*Math.sin(o));i=p>i?p:i,p=Math.abs(5*(f+1)*Math.cos(o)),i=p>i?p:i}Tb.grow(e,i,i)}else Tb.grow(e,f/2,f/2);return this.appendShadowBound(this,e),e},getZoomPathRect:function(a,b){{var c=this._element,d=this.getZoomBodyRect();this._gl3dview.zoomManager.getSizeZoom()}b&&Tb.addPadding(d,c,a+".padding",1);var e=Jb.cloneRect(d),f=c.getStyle(a+".outline.width");if(f>0)if(this._getZoomPoints){for(var g=this._getZoomPoints(),h=g.size(),i=0,j=0;h>j;j++){if(0==j)var k=g.get(j),l=g.get(h-1),m=g.get(j+1);else if(j==h-1)var k=g.get(j),l=g.get(j-1),m=g.get(0);else var k=g.get(j),l=g.get(j-1),m=g.get(j+1);var n=Tb.getCenterPoint(l,m),o=Tb.getAngle(n,k),p=Math.abs(5*(f+1)*Math.sin(o));i=p>i?p:i,p=Math.abs(5*(f+1)*Math.cos(o)),i=p>i?p:i}Tb.grow(e,i,i)}else Tb.grow(e,f/2,f/2);return this.appendShadowBound(this,e),e},paintBody:function(a){this.curInterval&&clearInterval(this.curInterval);var b=this.getStyle("body.type");"default"===b?this.drawDefaultBody(a):"vector"===b?this.drawVectorBody(a):"default.vector"===b?(this.drawVectorBody(a),this.drawDefaultBody(a)):"vector.default"===b&&(this.drawDefaultBody(a),this.drawVectorBody(a)),this._outerColor&&this.drawOuterBorder(a),"border"===this.getStyle("select.style")&&this._gl3dview.isSelected(this._element)&&this.drawSelectBorder(a)},drawOuterBorder:function(a){var b=this._element,c=b.getStyle("outer.width");if(c>0){var d=this.getZoomBodyRect();Tb.addPadding(d,b,"outer.padding",1),a.lineWidth=c,a.lineCap=b.getStyle("outer.cap"),a.lineJoin=b.getStyle("outer.join"),a.strokeStyle=this._outerColor,Xb.drawVector(a,b.getStyle("outer.shape"),null,d),a.stroke()}},drawDefaultBody:function(a){var b,c=this._element;if(c.getImage()&&("string"!=typeof c.getImage()||(b=Jb.getImageAsset(c.getImage())))){var d=this.getZoomBodyRect();Tb.addPadding(d,this._element,"image.padding",1),0!=c.getAngle()&&(a.save(),d=c.getOriginalRect(),d=this._gl3dview.zoomManager._getElementZoomRect(this,d),Ib.Util.rotateCanvas(a,d,c.getAngle())),this.setShadow(this,a);if(b&&b.getImage()instanceof Fd){var e,f=b.getImage().frames,g=b.getImage().size,h=0;e=Hd(f,g,0),a.drawImage(e,d.x,d.y,d.width,d.height),this.curInterval=setInterval(function(){h=(h+f.length)%f.length,e=Hd(f,g,h),a.drawImage(e,d.x,d.y,d.width,d.height),h++},100)}else Nc(a,c.getImage(),this.getInnerColor(),d,c,this._gl3dview);0!=c.getAngle()&&a.restore()}},drawSelectBorder:function(a){var b=this._element,c=b.getStyle("select.width");if(c>0){var d=this.getZoomBodyRect();Tb.addPadding(d,b,"select.padding",1);var e=Jb.cloneRect(d);Tb.grow(e,c/2,c/2),a.lineWidth=c,a.lineCap=b.getStyle("select.cap"),a.lineJoin=b.getStyle("select.join"),a.strokeStyle=b.getStyle("select.color"),Xb.drawVector(a,b.getStyle("select.shape"),null,d),a.stroke()}},drawVectorBody:function(a){this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("vector.deep"),c=this.getStyle("vector.fill.color");if(0!==b&&c&&"rectangle"===this.getStyle("vector.shape")){var d=this.getZoomBodyRect(),e=this._element.getAngle();if(0!=e){a.save();var f=this._element.getOriginalRect();f=this._gl3dview.zoomManager._getElementZoomRect(this,f),Ib.Util.rotateCanvas(a,f,e)}Xb.draw3DRect(a,c,b,d),0!=e&&a.restore()}},drawPath:function(a,b,c,d,e,f,g){var h=this._gl3dview.zoomManager,i=this._element,j=null;j="group"==b?this._shapeRect:this.getZoomBodyRect(),c&&Tb.addPadding(j,i,b+".padding",1);var k=i.getStyle(b+".outline.width");this.setShadow(this,a),0!=i.getAngle()&&(i instanceof Ld||(j=i.getOriginalRect(),j=h._getElementZoomRect(this,j)),a.save(),Ib.Util.rotateCanvas(a,j,i.getAngle()));var l,m=i.getStyle(b+".fill");if(m){l=this._innerColor&&!vc.hasDefault(this._element)?this._innerColor:i.getStyle(b+".fill.color");var n=i.getStyle(b+".gradient");n?Xb.fill(a,l,n,i.getStyle(b+".gradient.color"),j):a.fillStyle=l}var o=i.getStyle(b+".shape"),p=i.getStyle("group.shape.roundrect.radius");if(m){if(a.beginPath(),e)Xb.drawLinePoints(a,e,null,f,g);else if("roundrect"===o&&"group"===b){var q={};q.topLeft=p,q.topRight=p,q.bottomLeft=p,q.bottomRight=p,Xb.drawVector(a,o,null,j,q)}else Xb.drawVector(a,o,null,j);a.fill()}if(k>0){if(a.lineWidth=k,a.lineCap=i.getStyle(b+".cap"),a.lineJoin=i.getStyle(b+".join"),a.strokeStyle=i.getStyle(b+".outline.color"),a.beginPath(),e)Xb.drawLinePoints(a,e,d,f,g);else if("roundrect"===o&&"group"===b){var q={};q.topLeft=p,q.topRight=p,q.bottomLeft=p,q.bottomRight=p,Xb.drawVector(a,o,d,j,q)}else Xb.drawVector(a,o,d,j);a.stroke()}0!=i.getAngle()&&a.restore()},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();if(d&&d>0&&Tb.grow(c,d,d),this._gl3dview._transparentSelectionEnable){var e=this.getBodyRect();if(Jb.math.intersects(e,c))return!0}return Tb.intersects(this.getZoomViewRect(),c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Ib.vector.NodeUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(this._gl3dview._transparentSelectionEnable){var c=this.getBodyRect();if(Jb.math.intersects(c,a))return!0}return Tb.intersects(a,this.getZoomViewRect())?this.hitCanvasRect(a):!1}}),Ib.vector.LinkUI=function(a,b){Ib.vector.LinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.LinkUI",Ib.vector.ElementUI,{isEditable:function(){return xc.isOrthogonalLink(this._element)&&this.getControlPoint()?!0:!1},invalidate:function(a){this._linkPoints=null,this._fromPoint=null,this._toPoint=null,this._angle=null,Ib.vector.LinkUI.superClass.invalidate.call(this,a)},invalidateZoom:function(){this._fromPoint=null,this._toPoint=null,this._linkPoints=null,Ib.vector.LinkUI.superClass.invalidateZoom.call(this)},validateImpl:function(){this.validateBodyBounds(),Ib.vector.LinkUI.superClass.validateImpl.call(this)},validateBodyBounds:function(){var a=this.getLinkPoints();if(a&&!(a.size()<2)){var b=this._element,c=Tb.getLineRect(a),d=b.getStyle("link.width"),e=d;if(this._outerColor){var f=b.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===b.getStyle("select.style")&&this._gl3dview.isSelected(this._element);if(g){var h=b.getStyle("select.width");e+=2*h}Tb.grow(c,e/2,e/2),b.getStyle("arrow.from")&&(this._gl3dview._edgeDetect?(this._gl3dview._debug&&(this._arrowFromRect=nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),0,0,this._gl3dview.zoomManager)),c=Tb.unionRect(c,nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),0,0,this._gl3dview.zoomManager))):(this._gl3dview._debug&&(this._arrowFromRect=nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset"),this._gl3dview.zoomManager)),c=Tb.unionRect(c,nd.getArrowRect(this,a,!0,b.getStyle("arrow.from.shape"),b.getStyle("arrow.from.width"),b.getStyle("arrow.from.height"),b.getStyle("arrow.from.xoffset"),b.getStyle("arrow.from.yoffset"),this._gl3dview.zoomManager)))),b.getStyle("arrow.to")&&(this._gl3dview._edgeDetect?(this._gl3dview._debug&&(this._arrowToRect=nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),0,0,this._gl3dview.zoomManager)),c=Tb.unionRect(c,nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),0,0,this._gl3dview.zoomManager))):(this._gl3dview._debug&&(this._arrowToRect=nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"),this._gl3dview.zoomManager)),c=Tb.unionRect(c,nd.getArrowRect(this,a,!1,b.getStyle("arrow.to.shape"),b.getStyle("arrow.to.width"),b.getStyle("arrow.to.height"),b.getStyle("arrow.to.xoffset"),b.getStyle("arrow.to.yoffset"),this._gl3dview.zoomManager)))),this.appendShadowBound(this,c),this.addBodyBounds(c),this._growLinkJoinBounds(c,e)}},_growLinkJoinBounds:function(a,b){},createBodyRect:function(){var a=this.getHotSpot();return a?{x:a.x-1,y:a.y-1,width:2,height:2}:null},paintBody:function(a){var b=this.getLinkPoints();if(b&&!(b.size()<2)){var c=this._element,d=c.getStyle("link.width"),e=d;if(this._outerColor){var f=c.getStyle("outer.width");e+=2*f}var g=!this._editAttachment&&"border"===c.getStyle("select.style")&&this._gl3dview.isSelected(this._element);if(g){var h=c.getStyle("select.width");e+=2*h}this.setShadow(this,a),a.lineCap=c.getStyle("link.cap"),a.lineJoin=c.getStyle("link.join");var i=c.getStyle("link.pattern");g&&this.drawLinePoints(a,b,e,c.getStyle("select.color"),i),this._outerColor&&this.drawLinePoints(a,b,d+2*f,this._outerColor,i),this.drawLinePoints(a,b,d,this._innerColor||c.getStyle("link.color"),i),nd.drawLinkArrow(this,a,b,this._gl3dview.zoomManager)}},drawLinePoints:function(a,b,c,d,e){if(a.lineWidth=c,a.strokeStyle=d,this._element.getStyle("link.flow")===!0&&e&&e.length>1){var f=new uc(a,e[0],e[1]),g=this._element.getStyle("link.flow.offset"),h=Math.floor(g/(e[0]+e[1]));h>2&&(g-=(e[0]+e[1])*h),this._element.getStyle("link.flow.converse")?g<e[0]?f.overflow=e[0]-g:g>=e[0]&&g<=e[0]+e[1]?(f.overflow=e[1]-(g-e[0]),f.overflow&&(f.isLine=!1)):(g-=e[0]+e[1],f.overflow=e[0]-g):g<=e[1]?(f.overflow=g,g&&(f.isLine=!1)):g>e[1]&&g<=e[0]+e[1]?f.overflow=g-e[1]:(g-=e[0]+e[1],g&&(f.isLine=!1),f.overflow=g),this._element._styleMap["link.flow.offset"]=g,a.beginPath(),Xb._drawLine(b,a),a.stroke(),a.shadowColor="transparent",a.beginPath();var i=this._element.getStyle("link.flow.color");i=i?i:Cd.NETWORK_LINK_FLOW_COLOR,a.strokeStyle=i,Xb._drawLine(b,f),a.stroke(),a.shadowColor=this._shadowColor}else a.beginPath(),Xb.drawLinePoints(a,b,e),a.stroke()},getLinkPoints:function(){return this._linkPoints||(this._linkPoints=this.createLinkPoints(),this._lineLength=Tb.calculateLineLength(this._linkPoints)),this._linkPoints},getFromPosition:function(a,b){var c=this.getFromPoint();return c?{x:c.x+a,y:c.y+b}:null},getToPosition:function(a,b){var c=this.getToPoint();return c?{x:c.x+a,y:c.y+b}:null},getFromPoint:function(){return this._fromPoint||(this._fromPoint=xc.createFromPoint(this,this._gl3dview.zoomManager)),this._fromPoint},getToPoint:function(){return this._toPoint||(this._toPoint=xc.createToPoint(this,this._gl3dview.zoomManager)),this._toPoint},getZoomBodyRect:function(){return this.getBodyRect()},getZoomViewRect:function(){return this._viewRect},createLinkPoints:function(){var a=this._gl3dview.zoomManager,b=this.getStyle("link.type"),c=new Ib.List;if(xc.isOrthogonalOrFlexionalLink(this._element))c=xc.orthogonalAndFlexional(this,b,a);else if(this._element.isLooped()){var d=this._gl3dview.getElementUI(this._element.getFromAgent());null!=d&&(this._hotSpot=xc.fillLoopedPoints(this,d.getZoomBodyRect(),c))}else{if("arc"!==b&&"triangle"!==b&&"parallel"!==b)throw"Can not resolve link type '"+b+"'";var e=this.getFromPoint(),f=this.getToPoint();this._hotSpot=xc.fillBundlePoints(this,b,e,f,c,a)}if(this._gl3dview._linkPathFunction){var g=this._gl3dview._linkPathFunction(this,c);g&&(c=g)}return c},checkAttachments:function(){Ib.vector.LinkUI.superClass.checkAttachments.call(this),this.checkLinkHandlerAttachment()},checkLinkHandlerAttachment:function(){var a=this._gl3dview.getLinkHandlerLabel(this._element);null!=a&&""!==a?this._linkHandlerAttachment||(this._linkHandlerAttachment=new Ib.vector.LinkHandlerAttachment(this),this.addAttachment(this._linkHandlerAttachment)):this._linkHandlerAttachment&&(this.removeAttachment(this._linkHandlerAttachment),this._linkHandlerAttachment=null)},getLinkHandlerAttachment:function(){return this._linkHandlerAttachment},getControlPoint:function(){return xc.getControlPoint(this._element,this,this._gl3dview.zoomManager)},setControlPoint:function(a){if(a){var b=this.getStyle("link.type");if(xc.hasControlPoint(b)){var c=xc.getLinkSourceBounds(this,this._gl3dview.zoomManager),d=xc.getLinkTargetBounds(this,this._gl3dview.zoomManager);xc.setParamsByControlPoint(a,c,d,b,this._element)}}},getLineLength:function(){return this._lineLength},hit:function(a,b){var c={x:a,y:b,width:0,height:0},d=this._gl3dview.getSelectionTolerance();return d&&d>0&&Tb.grow(c,d,d),Tb.intersects(this._viewRect,c)?this.hitCanvasPoint(a,b):!1},intersects:function(a){var b=Ib.vector.NodeUI.superClass.intersects.apply(this,arguments);if(1==b)return!0;if(0==Tb.intersects(a,this._viewRect))return!1;var c=this.getLinkPoints(),d=c.size();if(2==d)for(var e=0;d>e;e+=2){var f=c.get(e);if(d>e+1){var g=c.get(e+1);if(Md.intersectsLine(f.x,f.y,g.x,g.y,a.x,a.y,a.width,a.height))return!0}}return this.hitCanvasRect(a)},getAngle:function(){return!this._angle&&this._fromPoint&&this._toPoint&&(this._angle=Tb.getAngle(this._fromPoint,this._toPoint)),this._angle||0},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(c){this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset);var d=this._shadowBlur;Tb.grow(b,d+1,d+1)}return b}}),Ib.vector.GroupUI=function(a,b){Ib.vector.GroupUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.GroupUI",Ib.vector.NodeUI,{isEditable:function(){return!this._element.isExpanded()},paintBody:function(a){this._shapeRect?this.drawExpandedGroup(a):Ib.vector.GroupUI.superClass.paintBody.apply(this,arguments)},validateBodyBounds:function(){if(this.getBodyRect(),this._shapeRect){var a=this.getPathRect("group",!1),b=this.getStyle("group.deep");Tb.grow(a,b+1,b+1),this.addBodyBounds(a)}else Ib.vector.GroupUI.superClass.validateBodyBounds.call(this)},getZoomBodyRect:function(){return this._element.isExpanded()?this.getBodyRect():Ib.vector.GroupUI.superClass.getZoomBodyRect.call(this)},getZoomViewRect:function(){return this._element.isExpanded()?this.getViewRect():Ib.vector.GroupUI.superClass.getZoomViewRect.call(this)},drawExpandedGroup:function(a){this.drawPath(a,"group",!1,this._element.getStyle("vector.outline.pattern"));var b=this.getStyle("group.deep"),c=this.getStyle("group.fill.color");0!==b&&c&&"rectangle"===this.getStyle("group.shape")&&Xb.draw3DRect(a,c,b,this._shapeRect)},getChildrenRects:function(){return this._gl3dview.getGroupChildrenRects(this._element)},createBodyRect:function(){this._shapeRect=null;var a=this._element,b=this._gl3dview;if(a.isExpanded()){a.getChildren().forEach(function(a){var c=b.getElementUI(a);c&&c.validate()});var c=this.getChildrenRects();if(!c.isEmpty()){var d=a.getStyle("group.shape"),e=Ub[d];if(!e)throw"Can not resolve group shape '"+d+"'";this._shapeRect=e(c)}}return this._shapeRect?(Tb.addPadding(this._shapeRect,a,"group.padding",1),this._shapeRect):Ib.vector.GroupUI.superClass.createBodyRect.call(this)},appendShadowBound:function(a,b){var c=a.isShadowable()&&this._shadowColor&&!this._editAttachment;if(c){this._shadowXOffset>0?b.width+=this._shadowXOffset:(b.x+=this._shadowXOffset,b.width+=-this._shadowXOffset),this._shadowYOffset>0?b.height+=this._shadowYOffset:(b.y+=this._shadowYOffset,b.height+=-this._shadowYOffset);var d=this._shadowBlur;Tb.grow(b,d+1,d+1)}return b}}),Ib.vector.ShapeNodeUI=function(a,b){Ib.vector.ShapeNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.ShapeNodeUI",Ib.vector.NodeUI,{getDefaultBodyRect:function(){return this._element._points.size()<2?null:this._reverseZoomPathRect()},drawDefaultBody:function(a){this._element._points.size()<2||(this.drawPath(a,"vector",!0,this._element.getStyle("vector.outline.pattern"),this._getZoomPoints(),this._element._segments,this._element.getStyle("shapenode.closed")),nd.drawLinkArrow(this,a,Tb.getPointObject(this._element._points,this._element._segments)))},invalidateZoom:function(){this._zoomPoints=null,Ib.vector.LinkUI.superClass.invalidateZoom.call(this)},_getZoomPoints:function(){return this._zoomPoints=this._gl3dview.zoomManager._getShapeNodeZoomPoints(this,this._element._points),this._zoomPoints},_reverseZoomPathRect:function(){return this._gl3dview.zoomManager._reverseElementZoomRect(this,this.getZoomPathRect("vector",!0))}}),Ib.vector.ShapeLinkUI=function(a,b){Ib.vector.ShapeLinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.ShapeLinkUI",Ib.vector.LinkUI,{isEditable:function(){return!0},createLinkPoints:function(){var a=this.getFromPoint(),b=this.getToPoint(),c=new Ib.List,d=this.getStyle("shapelink.type");c.add(a),null!=this._element._points&&c.addAll(this._gl3dview.zoomManager._getShapeLinkZoomPoints(this._element._points)),c.add(b);var e,f,g,h,i,j,k,l=Tb.calculateLineLength(c)/2,m=c.size(),n=0,o=0;for(e=0;m>e;e++)if(h=c.get(e),0!=e){if(g=h,g instanceof md&&(g=g._as),g instanceof Array?(i=Tb.calculateCurveLength(f,g,1),f=g[g.length-1]):(k=h.y-f.y,j=h.x-f.x,i=Math.sqrt(j*j+k*k),f=g),o+=i,l>=n&&o>=l){var p=l-n,q=c.get(e-1);q instanceof md&&(q=q._as,q instanceof Array&&(q=q[q.length-1]));var r=c.get(e),s=Tb.getPathInfo(r,q,p,0,-1).point;this._hotSpot=Jb.clone(s)}n=o}else f=h;var t,u,v;if("lineto"===d);else if("quadto"===d){for(t=new Ib.List(c.get(0)),u=1,pointCount=c.size();u<pointCount;u++)t.add(u<pointCount-1?new Ib.List([c.get(u++),c.get(u)]):c.get(u));c=t}else if("cubicto"===d){for(t=new Ib.List(c.get(0)),u=1,pointCount=c.size();u<pointCount;u++)t.add(u<pointCount-2?new Ib.List([c.get(u++),c.get(u++),c.get(u)]):u<pointCount-1?new Ib.List([c.get(u++),c.get(u)]):c.get(u));c=t}else{if("orthogonalto"!==d)throw"Can not resolve shapelink type '"+d+"'";for(v=c.get(0),t=new Ib.List(v),u=1,pointCount=c.size();u<pointCount;u++)if(u<pointCount-1){var h=Jb.clone(c.get(u)),w=h.x,x=h.y,j=w-v.x,k=x-v.y;Math.abs(j)>Math.abs(k)?(h.x=w,h.y=v.y):(h.x=v.x,h.y=x),v=h,t.add(v)}else t.add(c.get(u));c=t}return c},_growLinkJoinBounds:function(a,b){Tb.grow(a,3*b,3*b)}}),Ib.vector.GridUI=function(a,b){Ib.vector.GridUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.GridUI",Ib.vector.NodeUI,{drawDefaultBody:function(a){this._element.getImage()?Ib.vector.GridUI.superClass.drawDefaultBody.apply(this,arguments):this.drawGridBody(a)},validateBodyBounds:function(){if(this._element.getImage())Ib.vector.GridUI.superClass.validateBodyBounds.call(this);else{var a=this.getBodyRect(),b=Jb.clone(a),c=this._element.getStyle("outer.width");Tb.grow(b,c,c),this.appendShadowBound(this,b),this.addBodyBounds(b)}},_getZoomCellRect:function(a,b){var c=this._element.getCellRect(a,b),d=this._element.getRect(),e=d.x+d.width/2,f=d.y+d.height/2,g=this.getZoomBodyRect(),h=g.width/d.width,i=g.x+g.width/2,j=0==e?1:i/e;return{x:e*j+(c.x-e)*h,y:f*j+(c.y-f)*h,width:c.width*h,height:c.height*h}},drawGridBody:function(a){var b=this.getStyle("grid.fill"),c=this.getStyle("grid.deep"),d=this.getStyle("grid.cell.deep");if(b||0!==c||0!==d){a.beginPath();var e=this.getZoomBodyRect(),f=this.getDyeColor("grid.fill.color");if(this.setShadow(this,a),b&&(a.fillStyle=f,a.rect(e.x,e.y,e.width,e.height),a.fill()),a.closePath(),this.clearShadow(a),a.beginPath(),0!=c&&Xb.draw3DRect(a,f,c,e.x,e.y,e.width,e.height),a.closePath(),0!=d)for(var g=this.getStyle("grid.row.count"),h=this.getStyle("grid.column.count"),i=0;g>i;i++)for(var j=0;h>j;j++){var k=this._getZoomCellRect(i,j);null!=k&&(a.beginPath(),Xb.draw3DRect(a,f,d,k.x,k.y,k.width,k.height),a.closePath())}}}}),Ib.vector.RotatableNodeUI=function(a,b){Ib.vector.RotatableNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.RotatableNodeUI",Ib.vector.NodeUI,{isEditable:function(){return!1},getDefaultBodyRect:function(){var a=this._element,b=Jb.getImageAsset(a.getImage()),c=this.getBodyRect();return b?(Tb.addPadding(c,this._element,"image.padding",1),c):c},drawDefaultBody:function(a){var b=this._element,c=Jb.getImageAsset(b.getImage());if(c){var d=this.getBodyRect();if(Tb.addPadding(d,this._element,"image.padding",1),c.getImage()){var e=this._element._getOrignalWidth(),f=this._element._getOrignalHeight(),g=this._element._getRotateRect();a.save(),a.translate(d.x-g.x+e/2,d.y-g.y+f/2),a.rotate(this._element._angle*Math.PI/180),a.drawImage(c.getImage(this._innerColor),-e/2,-f/2,e,f),a.restore()}else if(c.getSrc());else if(!c.getFunction())throw"ImageAsset '"+b.getImage()+" ' is empty"}}}),Ib.vector.HTMLNodeUI=function(a,b){Ib.vector.HTMLNodeUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.HTMLNodeUI",Ib.vector.NodeUI,{checkAttachments:function(){Ib.vector.NodeUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Ib.vector.HTMLNodeUI.superClass.checkLabelAttachment.call(this);var b=this._gl3dview.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Ib.vector.HTMLLabelAttachment(this,Cd.SHOW_LABEL_IN_ATTACHMENT_DIV),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Ib.vector.HTMLNodeUI.superClass.checkAlarmAttachment.call(this);var b=this._gl3dview.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Ib.vector.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)},setAttachmentVisible:function(a){a?(this._labelAttachment&&this._labelAttachment.setVisibility("visible"),this._alarmAttachment&&this._alarmAttachment.setVisibility("visible")):(this._labelAttachment&&this._labelAttachment.setVisibility("hidden"),this._alarmAttachment&&this._alarmAttachment.setVisibility("hidden"))}}),Ib.vector.HTMLLinkUI=function(a,b){Ib.vector.HTMLLinkUI.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.HTMLLinkUI",Ib.vector.LinkUI,{checkAttachments:function(){Ib.vector.LinkUI.prototype.checkAttachments.call(this)},checkLabelAttachment:function(){var a=this._element.getStyle("attachment.label.style");if(a&&"none"===a)return void Ib.vector.HTMLLinkUI.superClass.checkLabelAttachment.call(this);var b=this._gl3dview.getLabel(this._element);null!=b&&""!==b?this._labelAttachment||(this._labelAttachment=new Ib.vector.HTMLLabelAttachment(this),this.addAttachment(this._labelAttachment)):this._labelAttachment&&(this.removeAttachment(this._labelAttachment),this._labelAttachment=null)},checkAlarmAttachment:function(){var a=this._element.getStyle("attachment.alarm.style");if(a&&"none"===a)return void Ib.vector.HTMLLinkUI.superClass.checkAlarmAttachment.call(this);var b=this._gl3dview.getAlarmLabel(this._element);null!=b&&""!==b?this._alarmAttachment||(this._alarmAttachment=new Ib.vector.HTMLAlarmAttachment(this,!1),this.addAttachment(this._alarmAttachment)):this._alarmAttachment&&(this.removeAttachment(this._alarmAttachment),this._alarmAttachment=null)}}),Ib.vector.Attachment=function(a,b){this._ui=a,this._element=this._ui.getElement(),this._gl3dview=a.getGl3dview(),this._showOnTop=b},Jb.ext("twaver.vector.Attachment",Object,{getElement:function(){return this._element},getElementUI:function(){return this._ui},getGl3dview:function(){return this._gl3dview},isShowOnTop:function(){return this._showOnTop===!0},setShowOnTop:function(a){this._showOnTop=a},getStyle:function(a){return this._ui.getStyle(a)},getFont:function(a){return this._ui.getFont(a)},getViewRect:function(){return Jb.clone(this._viewRect)},getAlpha:function(){return 1},validate:function(){},paint:function(a){},getZoomViewRect:function(){var a=this._gl3dview.zoomManager._getAttachmentZoomOutLineRect(this,this._viewRect);return a},hit:function(a,b){return Tb.containsPoint(this.getZoomViewRect(),a,b)?this.hitCanvasRect({x:a-1,y:b-1,width:2,height:2}):!1},hitCanvasRect:function(a){var b=Md.getHitCanvas(a.width,a.height),c=Md.getCtx(b);c.save(),c.translate(-a.x,-a.y),this.paint(c);try{for(var d=c.getImageData(0,0,a.width,a.height),e=d.data,f=0;f<d.width;f++)for(var g=0;g<d.height;g++){var h=4*(g*d.width+f),i=e[h+3];if(0!==i)return c.restore(),!0}}catch(j){Md.disposeHitCanvas()}return c.restore(),!1},dispose:function(){}}),Ib.vector.BasicAttachment=function(a,b){Ib.vector.BasicAttachment.superClass.constructor.call(this,a,b),this._roundRect={x:0,y:0,width:0,height:0},this._contentRect={x:0,y:0,width:0,height:0}},Jb.ext("twaver.vector.BasicAttachment",Ib.vector.Attachment,{paint:function(a){Ib.vector.BasicAttachment.superClass.paint.apply(this,arguments);var b=this.isFill(),c=this.getOutlineWidth(),d=this._gl3dview.zoomManager._getAttachmentZoomOutLineRect(this,this._roundRect);if(this.getElementUI().setShadow(this,a),c>0||b){if(Xb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._gl3dview._debug&&Xb.strokeRect(a,d,"#C71585"),this._pointers){var e=this._ui.getZoomPointers(this,this._pointers);a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Xb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}},validate:function(){Ib.vector.BasicAttachment.superClass.validate.call(this),this.calculateMeasure();var a=this.getOutlineWidth();(null==a||0>=a)&&(a=1),this._viewRect=Tb.getRect(this._pointers),this._viewRect=Tb.unionRect(this._viewRect,this._roundRect),a>0&&Tb.grow(this._viewRect,2*a,2*a),this._viewRect=this._ui.appendShadowBound(this,this._viewRect);var b=this._element instanceof Ib.Link&&this._element.getStyle("link.label.rotatable");if(b){var c=this._viewRect.x+this._viewRect.width/2,d=this._viewRect.y+this._viewRect.height/2,e=Math.sqrt(this._viewRect.height*this._viewRect.height+this._viewRect.width*this._viewRect.width);this._viewRect={x:c-e,y:d-e,width:2*e,height:2*e}}},calculateMeasure:function(){var a=this.getContentWidth(),b=this.getContentHeight(),c=this.getCornerRadius(),d=this.getPointerLength(),e=this.getPointerWidth(),f=this.getPosition(),g=this.getXOffset(),h=this.getYOffset(),i=this._roundRect;i.width=a+c,i.height=b;var j;if(d>0){var k=this.getDirection();if(this._ui._element instanceof Ib.Link){var l,m=this._ui.getLinkPoints();l=this._ui.getLineLength?this._ui.getLineLength():this._ui._element.getLineLength(),Math.abs(g)>0&&Math.abs(g)<1?"from"===f?g*=l:"to"===f?g=l*(1-g):(g/=2,g+=.5,g*=l):"from"===f?g=g:"to"===f?g=l-g:g+=l/2;{var n,o=Tb.calculatePointInfoAlongLine(m,!0,g,h),p=o.point;o.angle}n="from"===f?this._ui.getFromPoint():"to"===f?this._ui.getToPoint():this._ui._hotSpot,g=p.x-n.x,h=p.y-n.y}j=this._gl3dview.getPosition(f,this._ui,null,g,h,!1);var q;if("aboveleft"===k)i.y=j.y-d-i.height,i.x=j.x-(i.width-c),q=Math.max(j.x-e,j.x-(i.width-c)+c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("aboveright"===k)i.y=j.y-d-i.height,i.x=j.x-c,q=Math.min(j.x+e,j.x-c+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y-d},{x:q,y:j.y-d}];else if("belowleft"===k)i.y=j.y+d,i.x=j.x-(i.width-c),q=Math.max(j.x-e,j.x-(i.width-c)+c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("belowright"===k)i.y=j.y+d,i.x=j.x-c,q=Math.min(j.x+e,j.x-c+i.width-c/2),this._pointers=[j,{x:j.x,y:j.y+d},{x:q,y:j.y+d}];else if("leftabove"===k)i.y=j.y+c-i.height,i.x=j.x-d-i.width,q=Math.max(j.y-e,j.y+c-i.height+c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("leftbelow"===k)i.y=j.y-c,i.x=j.x-d-i.width,q=Math.min(j.y+e,j.y-c+i.height-c/2),this._pointers=[j,{x:j.x-d,y:j.y},{x:j.x-d,y:q}];else if("rightabove"===k)i.y=j.y+c-i.height,i.x=j.x+d,q=Math.max(j.y-e,j.y+c-i.height+c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("rightbelow"===k)i.y=j.y-c,i.x=j.x+d,q=Math.min(j.y+e,j.y-c+i.height-c/2),this._pointers=[j,{x:j.x+d,y:j.y},{x:j.x+d,y:q}];else if("above"===k)i.y=j.y-d-i.height,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y-d},{x:j.x+q,y:j.y-d}];else if("below"===k)i.y=j.y+d,i.x=j.x-i.width/2,q=Math.min(a/2,e/2),this._pointers=[j,{x:j.x-q,y:j.y+d},{x:j.x+q,y:j.y+d}];else if("left"===k)i.y=j.y-i.height/2,i.x=j.x-d-i.width,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x-d,y:j.y+q},{x:j.x-d,y:j.y-q}];else{if("right"!==k)throw"Can not resolve '"+k+"' attachment direction";i.y=j.y-i.height/2,i.x=j.x+d,q=Math.min(b/2,e/2),this._pointers=[j,{x:j.x+d,y:j.y+q},{x:j.x+d,y:j.y-q}]}}else{if(j=this._gl3dview.getPosition(f,this._ui,{width:i.width,height:i.height},g,h,!1),this._ui instanceof Ib.vector.LinkUI&&0!=g){var r=new md,s=this._gl3dview.getPosition(f,this._ui,{width:0,height:0},0,0,!1),q=this._ui.getToPoint();s.x==q.x&&s.y==q.y&&(q=this._ui.getFromPoint(),g*=-1),r.add(s),r.add(q);var o=Tb.calculatePointInfoAlongLine(r,!0,g,h);j=o.point,j.x-=i.width/2,j.y-=i.height/2}i.x=j.x,i.y=j.y,this._pointers=null}this._contentRect.x=i.x+(i.width-a)/2,
this._contentRect.y=i.y+(i.height-b)/2,this._contentRect.width=a,this._contentRect.height=b;var t=this.getPadding();0!=t&&Tb.grow(i,t,t),t=this.getPaddingLeft(),0!=t&&(i.x-=t,i.width+=t),t=this.getPaddingRight(),0!=t&&(i.width+=t),t=this.getPaddingTop(),0!=t&&(i.y-=t,i.height+=t),t=this.getPaddingBottom(),0!=t&&(i.height+=t),i.width<0&&(i.width=i.width,i.x-=i.width),i.height<0&&(i.height=-i.height,i.y-=i.height)},getContentWidth:function(){return Ib.Defaults.ATTACHMENT_CONTENT_WIDTH},getContentHeight:function(){return Ib.Defaults.ATTACHMENT_CONTENT_HEIGHT},getCornerRadius:function(){return Ib.Defaults.ATTACHMENT_CORNER_RADIUS},getPointerLength:function(){return Ib.Defaults.ATTACHMENT_POINTER_LENGTH},getPointerWidth:function(){return Ib.Defaults.ATTACHMENT_POINTER_WIDTH},getPosition:function(){return Ib.Defaults.ATTACHMENT_POSITION},getXOffset:function(){return Ib.Defaults.ATTACHMENT_XOFFSET},getYOffset:function(){return Ib.Defaults.ATTACHMENT_YOFFSET},getPadding:function(){return Ib.Defaults.ATTACHMENT_PADDING},getPaddingLeft:function(){return Ib.Defaults.ATTACHMENT_PADDING_LEFT},getPaddingRight:function(){return Ib.Defaults.ATTACHMENT_PADDING_RIGHT},getPaddingTop:function(){return Ib.Defaults.ATTACHMENT_PADDING_TOP},getPaddingBottom:function(){return Ib.Defaults.ATTACHMENT_PADDING_BOTTOM},getDirection:function(){return Ib.Defaults.ATTACHMENT_DIRECTION},isFill:function(){return Ib.Defaults.ATTACHMENT_FILL},getFillColor:function(){return Ib.Defaults.ATTACHMENT_FILL_COLOR},getGradient:function(){return Ib.Defaults.ATTACHMENT_GRADIENT},getGradientColor:function(){return Ib.Defaults.ATTACHMENT_GRADIENT_COLOR},getOutlineWidth:function(){return Ib.Defaults.ATTACHMENT_OUTLINE_WIDTH},getOutlineColor:function(){return Ib.Defaults.ATTACHMENT_OUTLINE_COLOR},getCap:function(){return Ib.Defaults.ATTACHMENT_CAP},getJoin:function(){return Ib.Defaults.ATTACHMENT_JOIN},isShadowable:function(){return Ib.Defaults.ATTACHMENT_SHADOWABLE},getRoundRect:function(){return Jb.clone(this._roundRect)},getContentRect:function(){return Jb.clone(this._contentRect)}}),Ib.vector.LabelAttachment=function(a,b){Ib.vector.LabelAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.LabelAttachment",Ib.vector.BasicAttachment,{paint:function(a){var b=this._element instanceof Ib.Link&&this._element.getStyle("link.label.rotatable");if(b){a.save();var c=this.getZoomViewRect(),d=c.x+c.width/2,e=c.y+c.height/2;a.translate(d,e),a.rotate(this._gl3dview.getElementUI(this._element).getAngle()),a.translate(-d,-e)}Ib.vector.LabelAttachment.superClass.paint.apply(this,arguments);var f=this._gl3dview.zoomManager,g=f._getAttachmentZoomRect(this,this._contentRect),h=this._element.getStyle("label.align");if(f._drawText(this,a,this.text,g,this.font,this.getStyle("label.color"),h),b&&a.restore(),this._gl3dview._debug){var i=f.getAttachmentSizeZoom(this),j=g;j.width*=i,j.height*=i,Xb.strokeRect(a,j,"#AAABBB")}},validate:function(){this.font=this.getFont("label.font"),this.text=this.getLabel(),this._textSize=Xb.getTextSize(this.font,this.text),Ib.vector.LabelAttachment.superClass.validate.call(this)},getLabel:function(){return this._gl3dview.getLabel(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label.corner.radius")},getPointerLength:function(){return this.getStyle("label.pointer.length")},getPointerWidth:function(){return this.getStyle("label.pointer.width")},getPosition:function(){return this.getStyle("label.position")},getXOffset:function(){return this.getStyle("label.xoffset")},getYOffset:function(){return this.getStyle("label.yoffset")},getPadding:function(){return this.getStyle("label.padding")},getPaddingLeft:function(){return this.getStyle("label.padding.left")},getPaddingRight:function(){return this.getStyle("label.padding.right")},getPaddingTop:function(){return this.getStyle("label.padding.top")},getPaddingBottom:function(){return this.getStyle("label.padding.bottom")},getDirection:function(){return this.getStyle("label.direction")},isFill:function(){return this.getStyle("label.fill")},getFillColor:function(){return this.getStyle("label.fill.color")},getGradient:function(){return this.getStyle("label.gradient")},getGradientColor:function(){return this.getStyle("label.gradient.color")},getOutlineWidth:function(){return this.getStyle("label.outline.width")},getOutlineColor:function(){return this.getStyle("label.outline.color")},getCap:function(){return this.getStyle("label.cap")},getJoin:function(){return this.getStyle("label.join")},getAlpha:function(){return this.getStyle("label.alpha")},isShadowable:function(){return this.getStyle("label.shadowable")}}),Ib.vector.Label2Attachment=function(a,b){Ib.vector.Label2Attachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.Label2Attachment",Ib.vector.BasicAttachment,{paint:function(a){var b=this._element instanceof Ib.Link&&this._element.getStyle("link.label.rotatable");if(b){a.save();var c=this.getZoomViewRect(),d=c.x+c.width/2,e=c.y+c.height/2;a.translate(d,e),a.rotate(this._gl3dview.getElementUI(this._element).getAngle()),a.translate(-d,-e)}Ib.vector.Label2Attachment.superClass.paint.apply(this,arguments);var f=this._gl3dview.zoomManager,g=f._getAttachmentZoomRect(this,this._contentRect),h=this._element.getStyle("label.align");if(f._drawText(this,a,this.text,g,this.font,this.getStyle("label2.color"),h),b&&a.restore(),this._gl3dview._debug){var i=f.getAttachmentSizeZoom(this),j=g;j.width*=i,j.height*=i,Xb.strokeRect(a,j,"#AAABBB")}},validate:function(){this.font=this.getFont("label2.font"),this.text=this.getLabel(),this._textSize=Xb.getTextSize(this.font,this.text),Ib.vector.LabelAttachment.superClass.validate.call(this)},getLabel:function(){return this._gl3dview.getLabel2(this._element)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("label2.corner.radius")},getPointerLength:function(){return this.getStyle("label2.pointer.length")},getPointerWidth:function(){return this.getStyle("label2.pointer.width")},getPosition:function(){return this.getStyle("label2.position")},getXOffset:function(){return this.getStyle("label2.xoffset")},getYOffset:function(){return this.getStyle("label2.yoffset")},getPadding:function(){return this.getStyle("label2.padding")},getPaddingLeft:function(){return this.getStyle("label2.padding.left")},getPaddingRight:function(){return this.getStyle("label2.padding.right")},getPaddingTop:function(){return this.getStyle("label2.padding.top")},getPaddingBottom:function(){return this.getStyle("label2.padding.bottom")},getDirection:function(){return this.getStyle("label2.direction")},isFill:function(){return this.getStyle("label2.fill")},getFillColor:function(){return this.getStyle("label2.fill.color")},getGradient:function(){return this.getStyle("label2.gradient")},getGradientColor:function(){return this.getStyle("label2.gradient.color")},getOutlineWidth:function(){return this.getStyle("label2.outline.width")},getOutlineColor:function(){return this.getStyle("label2.outline.color")},getCap:function(){return this.getStyle("label2.cap")},getJoin:function(){return this.getStyle("label2.join")},getAlpha:function(){return this.getStyle("label2.alpha")},isShadowable:function(){return this.getStyle("label2.shadowable")}}),Ib.vector.AlarmAttachment=function(a,b){Ib.vector.AlarmAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.AlarmAttachment",Ib.vector.BasicAttachment,{paint:function(a){Ib.vector.AlarmAttachment.superClass.paint.apply(this,arguments);var b=this._gl3dview.zoomManager,c=b._getAttachmentZoomRect(this,this._contentRect);b._drawText(this,a,this.text,c,this.font,this.getStyle("alarm.color"))},validate:function(){this.font=this.getFont("alarm.font"),this.text=this._gl3dview.getAlarmLabel(this._element),this._textSize=Xb.getTextSize(this.font,this.text),this._fillColor=this._gl3dview.getAlarmFillColor(this._element),Ib.vector.AlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("alarm.corner.radius")},getPointerLength:function(){return this.getStyle("alarm.pointer.length")},getPointerWidth:function(){return this.getStyle("alarm.pointer.width")},getPosition:function(){return this.getStyle("alarm.position")},getXOffset:function(){return this.getStyle("alarm.xoffset")},getYOffset:function(){return this.getStyle("alarm.yoffset")},getPadding:function(){return this.getStyle("alarm.padding")},getPaddingLeft:function(){return this.getStyle("alarm.padding.left")},getPaddingRight:function(){return this.getStyle("alarm.padding.right")},getPaddingTop:function(){return this.getStyle("alarm.padding.top")},getPaddingBottom:function(){return this.getStyle("alarm.padding.bottom")},getDirection:function(){return this.getStyle("alarm.direction")},isFill:function(){return null!=this._fillColor},getFillColor:function(){return this._fillColor},getGradient:function(){return this.getStyle("alarm.gradient")},getGradientColor:function(){return this.getStyle("alarm.gradient.color")},getOutlineWidth:function(){return this.getStyle("alarm.outline.width")},getOutlineColor:function(){return this.getStyle("alarm.outline.color")},getCap:function(){return this.getStyle("alarm.cap")},getJoin:function(){return this.getStyle("alarm.join")},getAlpha:function(){return this.getStyle("alarm.alpha")},isShadowable:function(){return this.getStyle("alarm.shadowable")}}),Ib.vector.LinkHandlerAttachment=function(a,b){Ib.vector.LinkHandlerAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.LinkHandlerAttachment",Ib.vector.BasicAttachment,{paint:function(a){var b=this._gl3dview.zoomManager;Ib.vector.LinkHandlerAttachment.superClass.paint.apply(this,arguments);var c=b._getAttachmentZoomRect(this,this._contentRect);b._drawText(this,a,this.linkHandlerLabel,c,this.linkHandlerFont,this.getStyle("link.handler.color"))},validate:function(){this.linkHandlerFont=this.getFont("link.handler.font"),this.linkHandlerLabel=this._gl3dview.getLinkHandlerLabel(this._element),this._textSize=Xb.getTextSize(this.linkHandlerFont,this.linkHandlerLabel),Ib.vector.LinkHandlerAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._textSize?this._textSize.width:0},getContentHeight:function(){return this._textSize?this._textSize.height:0},getCornerRadius:function(){return this.getStyle("link.handler.corner.radius")},getPointerLength:function(){return this.getStyle("link.handler.pointer.length")},getPointerWidth:function(){return this.getStyle("link.handler.pointer.width")},getPosition:function(){return this.getStyle("link.handler.position")},getXOffset:function(){return this.getStyle("link.handler.xoffset")},getYOffset:function(){return this.getStyle("link.handler.yoffset")},getPadding:function(){return this.getStyle("link.handler.padding")},getPaddingLeft:function(){return this.getStyle("link.handler.padding.left")},getPaddingRight:function(){return this.getStyle("link.handler.padding.right")},getPaddingTop:function(){return this.getStyle("link.handler.padding.top")},getPaddingBottom:function(){return this.getStyle("link.handler.padding.bottom")},getDirection:function(){return this.getStyle("link.handler.direction")},isFill:function(){return this.getStyle("link.handler.fill")},getFillColor:function(){return this.getStyle("link.handler.fill.color")},getGradient:function(){return this.getStyle("link.handler.gradient")},getGradientColor:function(){return this.getStyle("link.handler.gradient.color")},getOutlineWidth:function(){return this.getStyle("link.handler.outline.width")},getOutlineColor:function(){return this.getStyle("link.handler.outline.color")},getCap:function(){return this.getStyle("link.handler.cap")},getJoin:function(){return this.getStyle("link.handler.join")},getAlpha:function(){return this.getStyle("link.handler.alpha")},isShadowable:function(){return this.getStyle("link.handler.shadowable")}}),Ib.vector.IconsAttachment=function(a,b){Ib.vector.IconsAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.IconsAttachment",Ib.vector.Attachment,{isShadowable:function(){return Ib.Defaults.ATTACHMENT_SHADOWABLE},validate:function(){if(Ib.vector.IconsAttachment.superClass.validate.call(this),this.iconsNames=this._gl3dview.getIconsNames(this._element),this.iconsNames&&0!=this.iconsNames.length){var a=this._makeGroup(this.iconsNames),b=this._makeGroup(this._gl3dview.getIconsColors(this._element)),c=this._gl3dview.zoomManager;len=a.length,this.iconsOrientation=this._makeArray(this._element.getStyle("icons.orientation"),len,"right"),this.iconsPosition=this._makeArray(this._element.getStyle("icons.position"),len,"topleft.bottomright"),this.iconsXoffset=this._makeArray(this._element.getStyle("icons.xoffset"),len,0),this.iconsYoffset=this._makeArray(this._element.getStyle("icons.yoffset"),len,0),this.iconsXgap=this._makeArray(this._element.getStyle("icons.xgap"),len,1),this.iconsYgap=this._makeArray(this._element.getStyle("icons.ygap"),len,1),this.locations=[],this.iconsSizes=[],this.iconsOrientations=[];var d,e,f;for(i=0;i<len;i++){var g=a[i],f=this.iconsOrientation[i]||"right",h=this.iconsPosition[i]||"topleft.bottomright",j=this.iconsXgap[i]||1,k=this.iconsYgap[i]||1,l=this.iconsXoffset[i]||0,m=this.iconsYoffset[i]||0;e=null,d=this._getIconsSize(g,f,j,k,c),d&&(e=this._gl3dview.getPosition(h,this._ui,d,l,m),this._iconLocation=e,"top"===f?e.y+=d.height:"left"===f&&(e.x+=d.width)),this.locations.push(e),this.iconsSizes.push(d),this.iconsOrientations.push(f)}var n=null;for(i=0;i<this.locations.length;i++)e=this.locations[i],d=this.iconsSizes[i],f=this.iconsOrientations[i],null!=e&&(n=null==n?"top"===f?{x:e.x,y:e.y-d.height,width:d.width,height:d.height}:"left"===f?{x:e.x-d.width,y:e.y,width:d.width,height:d.height}:{x:e.x,y:e.y,width:d.width,height:d.height}:"top"===f?Tb.unionRect(n,{x:e.x,y:e.y-d.height,width:d.width,height:d.height}):"left"===f?Tb.unionRect(n,{x:e.x-d.width,y:e.y,width:d.width,height:d.height}):Tb.unionRect(n,{x:e.x,y:e.y,width:d.width,height:d.height}));this._viewRect=c?n||this.getElementUI().getViewRect():n||{x:this._element.getLocation().x,y:this._element.getLocation().y,width:0,height:0},this.iconsGroups=a,this.colorGroups=b}},_makeGroup:function(a){if(!Array.isArray(a))return[[a]];var b,c,d,e=[],f=!1,g=a.length;for(b=0;g>b;b++)c=a[b],Array.isArray(c)?(f=!0,e.push(c)):(d=[c],e.push(d));return f||(e.length=0,e.push(a)),e},_makeArray:function(a,b,c){if(Array.isArray(a))return a;for(var d=[],e=0;b>e;e++)d.push(a||c);return d},paint:function(a){if(Ib.vector.IconsAttachment.superClass.paint.apply(this,arguments),this.iconsNames&&0!=this.iconsNames.length&&this.locations){var b,c,d,e,f,g,h,i,j,k,l=this._gl3dview.zoomManager;for(b=0;b<this.iconsGroups.length;b++)if(c=this.locations[b]){f=c.x,g=c.y,e=this.iconsGroups[b],h=this.colorGroups[b],i=this.iconsOrientation[b],j=this.iconsXgap[b]||1,k=this.iconsYgap[b]||1,d=0;for(var m in e){var n=null,o=null;h&&h.length>d&&(o=h[d++]);var p=Jb.getImageAsset(e[m]);if(null!=p){if(l&&this._ui instanceof Ib.vector.GroupUI&&this._ui._shapeRect){var q=l.getAttachmentSizeZoom(this),r=p.getWidth()*q,s=p.getHeight()*q;if("right"===i)n={x:f,y:g,width:r,height:s},f+=n.width+j;else if("left"===i)n={x:f-r,y:g,width:r,height:s},f-=n.width+j;else if("top"===i)n={x:f,y:g-s,width:r,height:s},g-=n.height+k;else{if("bottom"!==i)throw"Can not resolve '"+i+"' orientation";n={x:f,y:g,width:r,height:s},g+=n.height+k}}else{if("right"===i)n={x:f,y:g,width:p.getWidth(),height:p.getHeight()},f+=n.width+j;else if("left"===i)n={x:f-p.getWidth(),y:g,width:p.getWidth(),height:p.getHeight()},f-=n.width+j;else if("top"===i)n={x:f,y:g-p.getHeight(),width:p.getWidth(),height:p.getHeight()},g-=n.height+k;else{if("bottom"!==i)throw"Can not resolve '"+i+"' orientation";n={x:f,y:g,width:p.getWidth(),height:p.getHeight()},g+=n.height+k}n=l._getAttachmentZoomOutLineRect(this,n)}Nc(a,p.getImage(o,n.width,n.height),o,n,this._element,this._gl3dview)}}}}},_getIconsSize:function(a,b,c,d,e){var f=0,g=0,h=null,i=null,j=null;for(var k in a)if(i=Jb.getImageAsset(a[k])){if("right"===b)h={x:f,y:g,width:i.getWidth(),height:i.getHeight()},f+=h.width+c;else if("left"===b)h={x:f-i.getWidth(),y:g,width:i.getWidth(),height:i.getHeight()},f-=h.width+c;else if("top"===b)h={x:f,y:g-i.getHeight(),width:i.getWidth(),height:i.getHeight()},g-=h.height+d;else{if("bottom"!==b)throw"Can not resolve '"+b+"' orientation";h={x:f,y:g,width:i.getWidth(),height:i.getHeight()},g+=h.height+d}j=null==j?Jb.clone(h):Tb.unionRect(j,h)}return j?e&&this._ui instanceof Ib.vector.GroupUI&&this._ui._shapeRect?{width:Math.abs(j.width)*e.getAttachmentSizeZoom(this),height:Math.abs(j.height)*e.getAttachmentSizeZoom(this)}:{width:Math.abs(j.width),height:Math.abs(j.height)}:null}}),Ib.vector.EditAttachment=function(a,b){Ib.vector.EditAttachment.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.EditAttachment",Ib.vector.Attachment,{paint:function(a){Ib.vector.EditAttachment.superClass.paint.apply(this,arguments),this.paintResizingPoints(a),this.paintEditPoints(a),this.paintRotatePoints(a)},paintResizingPoints:function(a){var b=this.resizingPoints.size();if(!(0>=b)){var c=2*this.resizePointSize,d=2*this.resizePointSize,e=this._gl3dview.getResizePointFillColor(),f=this._gl3dview.getResizePointOutlineWidth(),g=this._gl3dview.getResizePointOutlineColor(),h=this._element.getAngle(),i=this._gl3dview.zoomManager,j=i._getElementZoomRect(this.getElementUI(),this._element.getOriginalRect());a.lineWidth=f;for(var k=this.resizingPoints,l=0;b>l;l++){var m=k.get(l),n={x:m.x-this.resizePointSize,y:m.y-this.resizePointSize,width:2*this.resizePointSize,height:2*this.resizePointSize},o=this._getRotateRect(n,h,{x:j.x+j.width/2,y:j.y+j.height/2});a.save(),Ib.Util.rotateCanvas(a,o,h),Md.rect(a,o.x,o.y,c,d),a.restore()}if(a.fillStyle=e,a.strokeStyle=g,a.fill(),a.stroke(),this._gl3dview._debug){var p=this.getViewRect("resize");Xb.strokeRect(a,p,"#CCDDCC");var p=i._getElementZoomRect(this.getElementUI(),this.getElementUI()._viewRect);Xb.strokeRect(a,p,"#FD7766")}}},paintEditPoints:function(a){var b=this.editPoints.size();if(!(0>=b)){var c=this._gl3dview.getEditPointOutlineColor(),d=this._gl3dview.getEditPointFillColor(),e=this._gl3dview.getEditPointOutlineWidth();a.beginPath(),a.lineWidth=e;for(var f=this.editPoints,g=0;b>g;g++){var h=f.get(g);a.beginPath(),Md.circle(a,h.x,h.y,this.editPointSize,d,c),a.closePath()}if(this._gl3dview._debug){var i=this.getViewRect("edit");Xb.strokeRect(a,i,"#AAABBC")}}},paintRotatePoints:function(a){var b=this.rotatePoints.size();if(!(0>=b)){var c=this._gl3dview.getRotatePointOutlineColor(),d=this._gl3dview.getRotatePointFillColor(),e=this._gl3dview.getRotatePointOutlineWidth();a.beginPath(),a.lineWidth=e;for(var f=this.rotatePoints,g=0;b>g;g++){var h=f.get(g);a.beginPath(),Md.circle(a,h.x,h.y,this.rotatePointSize,d,c),a.closePath(),a.beginPath()}if(this._gl3dview._debug){var i=this.getViewRect("rotate");Xb.strokeRect(a,i,"green")}}},getViewRect:function(a){if(a){if("resize"===a)return this._resizeRect;if("rotate"===a)return this._rotateRect;if("edit"===a)return this._editRect}return this._viewRect||{x:0,y:0,width:0,height:0}},validate:function(){Ib.vector.EditAttachment.superClass.validate.call(this),this.editPointSize=this._gl3dview.getEditPointSize(),this.resizePointSize=this._gl3dview.getResizePointSize(),this.rotatePointSize=this._gl3dview.getRotatePointSize(),this.resizingPoints=new Ib.List,this.editPoints=new Ib.List,this.rotatePoints=new Ib.List,this._element instanceof Ib.Node&&this._addResizingPoint(this._element),!(this._gl3dview.isRotatable(this._element)&&this._element instanceof Jd)||this._element instanceof Ib.ShapeNode||this._element instanceof Ib.Grid||this._element instanceof Ib.Group||this._addRotatePoint(this._element),this._element instanceof Ib.ShapeNode&&(this._addResizingPoint(this._element),this._addShapeNodePoint(this._element)),this._ui instanceof Ib.vector.ShapeLinkUI&&this._addShapeLinkPoints(this._element),this._ui instanceof Ib.vector.LinkUI&&this._addLinkControlPoint(this._ui);var a=this._gl3dview.getResizePointOutlineWidth(),b=this.getElementUI().getZoomBodyRect(),c=2*Math.sqrt(2);if(this._resizeOffset=(this.resizePointSize+a+1)*c,Tb.grow(b,this._resizeOffset,this._resizeOffset),this._resizeRect=b,a=this._gl3dview.getEditPointOutlineWidth(),this.editPoints.size()>0){var d=Tb.getRect(this.editPoints);Tb.grow(d,2*this.editPointSize+2*a),b=Tb.unionRect(b,d)}if(this._editRect=d,a=this._gl3dview.getRotatePointOutlineWidth(),this.rotatePoints.size()>0){var e=this.rotatePoints.get(0),f={x:e.x-this.rotatePointSize-a-1,y:e.y-this.rotatePointSize-a-1,width:2*this.rotatePointSize+2*a+2,height:2*this.rotatePointSize+2*a+2};b=Tb.unionRect(b,f),this._rotateRect=f}this._viewRect=b},_addResizingPoint:function(a){var b=this._gl3dview.zoomManager._getElementZoomRect(this.getElementUI(),a.getOriginalRect());if(b){var c=this._gl3dview.getResizePointSize();if(!(0>=c)){var d=new md([{x:b.x,y:b.y},{x:b.x+b.width/2,y:b.y},{x:b.x+b.width,y:b.y},{x:b.x,y:b.y+b.height/2},{x:b.x+b.width,y:b.y+b.height/2},{x:b.x,y:b.y+b.height},{x:b.x+b.width/2,y:b.y+b.height},{x:b.x+b.width,y:b.y+b.height}]),e=this._gl3dview.getResizePointOutlineWidth(),f=this._gl3dview.getResizePointOutlineColor(),g=this._gl3dview.getResizePointFillColor();this._addPoints(a.getRect(),d,e,f,g,!0)}}},_addRotatePoint:function(a){var b=this._gl3dview.zoomManager._getElementZoomRect(this.getElementUI(),a.getOriginalRect());if(b){var c=this._gl3dview.getRotatePointSize();if(!(0>=c)){var d=2*c,e=new Ib.List([{x:b.x+b.width/2,y:b.y-this._gl3dview.getRotatePointOffset()-d/2}]),f=a.getAngle();0!=f&&(e=this._rotatePointList(e,f,b));var g=e.get(0),h={x:g.x-d/2,y:g.y-d/2,width:d,height:d},i=this._gl3dview.getRotatePointOutlineWidth(),j=this.rotatePointSize+i;Tb.grow(b,j,j);{Tb.unionRect(a.getRect(),h)}this.rotatePoints=e}}},_addShapeNodePoint:function(a){var b=this._gl3dview.zoomManager._getShapeNodeZoomPoints(this.getElementUI(),a.getPoints());this._addEditPoints(b)},_addShapeLinkPoints:function(a){var b=this._gl3dview.zoomManager._getShapeLinkZoomPoints(a.getPoints());this._addEditPoints(b)},_addLinkControlPoint:function(a){if(xc.isOrthogonalLink(a._element)){var b=a.getControlPoint();if(b){var c=new Ib.List;c.add(b),this._addEditPoints(c)}}},_addEditPoints:function(a){var b=Tb.getRect(a);if(b){var c=this._gl3dview.getEditPointSize();if(!(0>=c)){var d=this._gl3dview.getEditPointOutlineWidth();this._addPoints(b,a,d,!1)}}},_addPoints:function(a,b,c,d,e,f){var g=f?this._gl3dview.getResizePointSize():this._gl3dview.getEditPointSize();if(!(0>g)){var h=g+c;Tb.grow(a,h,h),1==f?this.resizingPoints=b:this.editPoints=b}},_rotatePoint:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_rotatePointList:function(a,b,c){var d=this,e=new Ib.List;return a.forEach(function(a){e.add(d._rotatePoint(a,b,c))}),e},_getRotateRect:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x,c.y),e={x:a.x+a.width/2,y:a.y+a.height/2},f=d.transform(e),g=new Ib.List([{x:f.x-a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y-a.height/2},{x:f.x+a.width/2,y:f.y+a.height/2},{x:f.x-a.width/2,y:f.y+a.height/2}]);return Tb.getRect(g)}}),Ib.vector.HTMLLabelAttachment=function(a,b){Ib.vector.HTMLLabelAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Ib.Util.createDiv(),this._roundDiv=Ib.Util.createDiv(),this._contentDiv=Ib.Util.createDiv(),Ib.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Ib.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Ib.Util.setCSSStyle(this._contentDiv,"white-space","nowrap"),Ib.Util.setCSSStyle(this._contentDiv,"pointer-events","none");this._gl3dview.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Jb.ext("twaver.vector.HTMLLabelAttachment",Ib.vector.LabelAttachment,{validate:function(){var a=(this.getFont("label.font"),this.getLabel());this._contentDiv.innerHTML=a,this._contentDiv.style.visibility="hidden",Ib.vector.HTMLLabelAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setShadow(this,a),c>0||b){if(Xb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._ui.getZoomPointers(this,this._pointers);a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Xb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("label.font"),this.getLabel(),this._gl3dview.getViewRect().x),i=this._gl3dview.getViewRect().y,j=this._gl3dview.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._gl3dview._debug&&(Xb.strokeRect(a,this._contentRect,"blue"),Xb.strokeRect(a,this._roundRect,"red"),Xb.strokeRect(a,this._viewRect,"green"))},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._gl3dview.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Ib.vector.HTMLAlarmAttachment=function(a,b){Ib.vector.HTMLAlarmAttachment.superClass.constructor.call(this,a,b),this._triangleDiv=Ib.Util.createDiv(),this._roundDiv=Ib.Util.createDiv(),this._contentDiv=Ib.Util.createDiv(),Ib.Util.setCSSStyle(this._triangleDiv,"border-style","solid"),Ib.Util.setCSSStyle(this._triangleDiv,"pointer-events","none"),Ib.Util.setCSSStyle(this._contentDiv,"white-space","nowrap"),Ib.Util.setCSSStyle(this._contentDiv,"pointer-events","none");this._gl3dview.getView().appendChild(this._roundDiv),this._roundDiv.appendChild(this._contentDiv)},Jb.ext("twaver.vector.HTMLAlarmAttachment",Ib.vector.AlarmAttachment,{validate:function(){var a=(this.getFont("alarm.font"),this._gl3dview.getAlarmLabel(this._element));this._contentDiv.innerHTML=a,this._contentDiv.style.visibility="hidden",Ib.vector.HTMLAlarmAttachment.superClass.validate.call(this)},getContentWidth:function(){return this._contentDiv.scrollWidth||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"width"))},getContentHeight:function(){return this._contentDiv.scrollHeight||parseInt(Ib.Util.getCSSStyle(this._contentDiv.firstChild,"height"))},paint:function(a){var b=this.isFill(),c=this.getOutlineWidth(),d=this._contentRect;if(this.getElementUI().setShadow(this,a),c>0||b){if(Xb.drawRoundRect(a,d.x,d.y,d.width,d.height,this.getCornerRadius()),this._pointers){var e=this._ui.getZoomPointers(this,this._pointers);a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[2].x,e[2].y)}if(a.closePath(),c>0&&(a.lineWidth=c,a.strokeStyle=this.getOutlineColor(),a.lineCap=this.getCap(),a.lineJoin=this.getJoin(),a.stroke()),b){var f=this.getFillColor(),g=this.getGradient();g?Xb.fill(a,f,g,this.getGradientColor(),this._viewRect):a.fillStyle=f,a.fill()}}var h=(this.getFont("alarm.font"),this._gl3dview.getAlarmLabel(this._element),this._gl3dview.getViewRect().x),i=this._gl3dview.getViewRect().y,j=this._gl3dview.getZoom(),k={x:this._contentRect.x+this._contentRect.width/2,y:this._contentRect.y+this._contentRect.height/2},l=k.x*j-h-this._contentDiv.offsetWidth/2*j+"px",m=k.y*j-i-this._contentDiv.offsetHeight/2*j+"px";this._contentDiv.style.left=l,this._contentDiv.style.top=m,this._contentDiv.style.setProperty("-webkit-transform","scale("+j+")",null),this._contentDiv.style.setProperty("-webkit-transform-origin","0 0",null),this._gl3dview._debug&&Xb.strokeRect(a,this._contentRect,"#DDDDDD"),Ib.vector.AlarmAttachment.superClass.paint.apply(this,arguments)},setVisibility:function(a){this._contentDiv.style.visibility=a},dispose:function(){this._gl3dview.getView().removeChild(this._roundDiv)},getView:function(){return this._roundDiv}}),Ib.vector.BaseZoomManager=function(a){this.gl3dview=a,this.visibilityThresholds=a.visibilityThresholds},Jb.ext("twaver.vector.BaseZoomManager",Object,{getZoom:function(){return this.gl3dview.getZoom()},getGraphicsZoom:function(){return 1},getSizeZoom:function(a){return 1},getAttachmentSizeZoom:function(a){var b=a.getElementUI();return this.getSizeZoom(b)},getLocationZoom:function(){return 1},_getZoomVisibilityThresholds:function(){return this.gl3dview.getZoomVisibilityThresholds()},_convertPointFromView:function(a){var b=a.x*this.getGraphicsZoom()-this.gl3dview.getViewRect().x,c=a.y*this.getGraphicsZoom()-this.gl3dview.getViewRect().y;return{x:b,y:c}},_getElementViewRect:function(a,b){var c=this.getLocationZoom(),d=this.getSizeZoom(a);if(1==c&&1==d)return b;var e=this._getZoomPoint(a),f=e.x,g=e.y;return null==b&&console.log("View rect is null"),{x:f*c+(b.x-f)*d,y:g*c+(b.y-g)*d,width:b.width*d,height:b.height*d}},_invalidateZoom:function(){this.gl3dview.invalidateElementUIs()},_getGroupChildrenRects:function(a){var b=new md;return a.getChildren().forEach(function(a){if(a instanceof Jd){var c=this.gl3dview.getElementUI(a);if(c){var d=c.getZoomViewRect(this);d&&b.add(d)}}},this),b},_zoomGraphicsBegin:function(a){var b=this.gl3dview,c=this.getGraphicsZoom();a.scale(c,c),a.translate(Math.floor(-b.viewRect.x/c),Math.floor(-b.viewRect.y/c))},_getEditZoomPoints:function(a,b){var c=this.getLocationZoom(),d=this.getSizeZoom(a);if(1==c&&1==d||a instanceof Ib.vector.LinkUI&&!(a instanceof Ib.vector.ShapeLinkUI))return b;var e;e=a instanceof Ib.vector.ShapeLinkUI?Tb.getCenterPoint(Tb.getRect(b)):this._getZoomPoint(a);var f=e.x,g=e.y;if(b.forEach){var h,i=new md;return b.forEach(function(a){a instanceof md?(h=new md,a.forEach(function(a){h.add({x:f*c+(a.x-f)*d,y:g*c+(a.y-g)*d})}),i.add(h)):i.add({x:f*c+(a.x-f)*d,y:g*c+(a.y-g)*d})}),i}return b.x?{x:f*c+(b.x-f)*d,y:g*c+(b.y-g)*d}:void 0},_getShapeNodeZoomPoints:function(a,b,c){var d=this.getLocationZoom(),e=this.getSizeZoom(a);if(1==d&&1==e)return b;c&&(d=1/d,e=1/e);var f,g=Tb.getRect(b),h=g.x+g.width/2,i=g.y+g.height/2,j=new md;return b.forEach(function(a){a instanceof md?(f=new md,a.forEach(function(a){f.add({x:h*d+(a.x-h)*e,y:i*d+(a.y-i)*e})}),j.add(f)):j.add({x:h*d+(a.x-h)*e,y:i*d+(a.y-i)*e})}),j},_getShapeLinkZoomPoints:function(a,b){var c=this.getLocationZoom(),d=c;if(1==c&&1==d)return a;b&&(c=1/c,d=1/d);var e,f=Tb.getRect(a),g=f.x+f.width/2,h=f.y+f.height/2,i=new md;return a.forEach(function(a){a instanceof md?(e=new md,a.forEach(function(a){e.add({x:g*c+(a.x-g)*d,y:h*c+(a.y-h)*d})}),i.add(e)):i.add({x:g*c+(a.x-g)*d,y:h*c+(a.y-h)*d})}),i},_getLogicalPoint:function(a,b){var c,d=b?this.getZoom():this.getGraphicsZoom(),e=this.gl3dview;if(Qb.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var f=e._view.getBoundingClientRect(),g=a.changedTouches[0],h=Qb.isAndroid?0:zc.scrollLeft(),i=Qb.isAndroid?0:zc.scrollTop();return c={x:(g.clientX+e.viewRect.x-f.left-h)/d,y:(g.clientY+e.viewRect.y-f.top-i)/d}}return c=Qb.isFirefox?{x:(a.layerX+e.viewRect.x)/d,y:(a.layerY+e.viewRect.y)/d}:{x:(a.offsetX+e.viewRect.x)/d,y:(a.offsetY+e.viewRect.y)/d}},_getVisibleRect:function(a){return a},_getElementZoomRect:function(a,b){var c=this.getLocationZoom(),d=this.getSizeZoom(a);

if(1==c&&1==d)return Jb.cloneRect(b);var e=null!=a?this._getZoomPoint(a):{x:b.x+b.width/2,y:b.y+b.height/2},f=e.x,g=e.y;return{x:f*c+(b.x-f)*d,y:g*c+(b.y-g)*d,width:b.width*d,height:b.height*d}},_reverseElementZoomRect:function(a,b){var c=this.getLocationZoom(),d=this.getSizeZoom(a);if(1==c&&1==d)return Jb.cloneRect(b);var e=null!=a?this._getZoomPoint(a):{x:b.x+b.width/2,y:b.y+b.height/2},f=e.x,g=e.y;return{x:f+(b.x-f*c)/d,y:g+(b.y-g*c)/d,width:b.width/d,height:b.height/d}},_getZoomContentRect:function(a,c,d,e,f,g){var h=this.getSizeZoom(a.getElementUI()),i=this.getAttachmentSizeZoom(a),j=a.getElementUI();return g==b?j instanceof Ib.vector.GroupUI&&j._shapeRect?{x:e.x*f+1*(c.x-e.x)+(d.x-c.x)*i,y:e.y*f+1*(c.y-e.y)+(d.y-c.y)*i,width:d.width,height:d.height}:{x:e.x*f+(c.x-e.x)*h+(d.x-c.x)*i,y:e.y*f+(c.y-e.y)*h+(d.y-c.y)*i,width:d.width,height:d.height}:{x:e.x*f+(c.x-e.x)*h+(d.x-c.x)*i,y:e.y*f+(c.y-e.y)*h+(d.y-c.y)*i+g*(a.textHeight-4)*i,width:d.width,height:a.textHeight}},_getAttachmentZoomRect:function(a,c,d){var e=this.getLocationZoom(),f=a.getElementUI(),g=this.getSizeZoom(a.getElementUI()),h=this.getAttachmentSizeZoom(a),i=a._pointers;if(1==e&&1==h&&1==g)return d==b?c:{x:c.x,y:c.y+d*(a.textHeight-4),width:c.width,height:a.textHeight};var f=a.getElementUI(),j=this._getZoomPoint(f,a),k=(j.x,j.y,a.getPosition?a.getPosition():"center"),l=i?i[0]:Pd.get(k,c);return d==b?f instanceof Ib.vector.LinkUI||f instanceof Ib.vector.GroupUI&&f._shapeRect?this._getZoomContentRect(a,l,c,j,1):this._getZoomContentRect(a,l,c,j,e):this._getZoomContentRect(a,l,c,j,e,d)},_getZoomPoint:function(a,b){var c,d,e=a._element;if(e instanceof Ib.Follower&&e.getHost()&&e.getHost()instanceof Ib.Grid)return c=e.getHost(),d=c.getRect(),{x:d.x+d.width/2,y:d.y+d.height/2};if(d=a.getBodyRect(),a instanceof Ib.vector.LinkUI&&b&&b.getPosition){{b.getXOffset(),b.getYOffset()}if("from"===b.getPosition())return a._fromPoint;if("to"===b.getPosition())return a._toPoint}return{x:d.x+d.width/2,y:d.y+d.height/2}},_getZoomPointers:function(a,b,c){if(c){var d=this._getZoomPoint(b),e=this.getLocationZoom(),f=this.getSizeZoom(b),g=this.getAttachmentSizeZoom(a),h=c[0];return b instanceof Ib.vector.LinkUI?[{x:d.x+(h.x-d.x)*f,y:d.y+(h.y-d.y)*f},{x:d.x+(h.x-d.x)*f+(c[1].x-h.x)*g,y:d.y+(h.y-d.y)*f+(c[1].y-h.y)*g},{x:d.x+(h.x-d.x)*f+(c[2].x-h.x)*g,y:d.y+(h.y-d.y)*f+(c[2].y-h.y)*g}]:b instanceof Ib.vector.GroupUI&&b._shapeRect?[{x:d.x+1*(h.x-d.x),y:d.y+1*(h.y-d.y)},{x:d.x+1*(h.x-d.x)+(c[1].x-h.x)*g,y:d.y+1*(h.y-d.y)+(c[1].y-h.y)*g},{x:d.x+1*(h.x-d.x)+(c[2].x-h.x)*g,y:d.y+1*(h.y-d.y)+(c[2].y-h.y)*g}]:[{x:d.x*e+(h.x-d.x)*f,y:d.y*e+(h.y-d.y)*f},{x:d.x*e+(h.x-d.x)*f+(c[1].x-h.x)*g,y:d.y*e+(h.y-d.y)*f+(c[1].y-h.y)*g},{x:d.x*e+(h.x-d.x)*f+(c[2].x-h.x)*g,y:d.y*e+(h.y-d.y)*f+(c[2].y-h.y)*g}]}},_getZoomHotSpot:function(a,b){if(b){var c=this._getZoomPoint(a),d=this.getLocationZoom(),e=this.getSizeZoom(a);return{x:c.x*d+(b.x-c.x)*e,y:c.y*d+(b.y-c.y)*e}}return null},limitZoom:function(a){return a},_isVisible:function(a){var b,c=this._getZoomVisibilityThresholds(),d=c[a];if(null!=d){var e=c.zoomName;if(b="sizeZoom"==e?this.getSizeZoom():"locationZoom"==e?this.getLocationZoom():"graphicsZoom"==e?this.getGraphicsZoom():this.getZoom(),d>b)return!1}return!0},isElementVisible:function(a){var b=this.getZoom(),c=this._isVisible("element",b);return c&&a instanceof Ib.Link?this.isLinkVisible(a):c},isLinkVisible:function(a){var b=this.getZoom();return this._isVisible("link",b)},isLabelVisible:function(a){var b=this.getZoom();return this._isVisible("label",b)},isAttachmentVisible:function(a){var b=this.getZoom();return this._isVisible("attachment",b)},isAlarmBalloonVisible:function(a){var b=this.getZoom();return this._isVisible("alarmBallon",b)},_getAttachmentOutLineWidth:function(a){return a.getOutlineWidth()},_getAttachmentZoomOutLineRect:function(a,b){var c=this.getLocationZoom(),d=this.getAttachmentSizeZoom(a);if(1==c&&1==d)return b;var e=this._getAttachmentZoomRect(a,b,null),f=a.getElement();return this.isAttachmentVisible(f)?(a instanceof Ib.vector.LabelAttachment||a instanceof Ib.vector.Label2Attachment)&&!this.isLabelVisible(f)?{x:e.x,y:e.x,width:0,height:0}:a instanceof Ib.vector.AlarmAttachment&&!this.isAlarmBalloonVisible(f)?{x:e.x,y:e.x,width:0,height:0}:{x:e.x,y:e.y,width:e.width*d,height:e.height*d}:{x:e.x,y:e.x,width:0,height:0}},_drawText:function(a,b,c,d,e,f,g){var h=this.getLocationZoom(),i=this.getAttachmentSizeZoom(a);1!=h&&1!=i?(b.translate(d.x,d.y),b.scale(i,i),Xb.drawText(b,c,{x:0,y:0,width:d.width,height:d.height},e,f,g),b.scale(1/i,1/i),b.translate(-d.x,-d.y)):Xb.drawText(b,c,d,e,f,g)},_getOffset:function(a,b){var c=this.getLocationZoom();return{x:(a.x-b.x)/c,y:(a.y-b.y)/c}}});var Pd={"topleft.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"topleft.topright":function(a){return{x:a.x,y:a.y+a.height}},"top.top":function(a){return{x:a.x+a.width/2,y:a.y+a.height}},"topright.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"topright.topright":function(a){return{x:a.x,y:a.y+a.height}},topleft:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},top:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},topright:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"topleft.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"topleft.bottomright":function(a){return{x:a.x,y:a.y}},"top.bottom":function(a){return{x:a.x+a.width/2,y:a.y}},"topright.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"topright.bottomright":function(a){return{x:a.x,y:a.y}},"left.left":function(a){return{x:a.x+a.width,y:a.y+a.height/2}},left:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"left.right":function(a){return{x:a.x,y:a.y+a.height/2}},center:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"right.left":function(a){return{x:a.x+a.width,y:a.y+a.height/2}},right:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"right.right":function(a){return{x:a.x,y:a.y+a.height/2}},"bottomleft.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"bottomleft.topright":function(a){return{x:a.x,y:a.y+a.height}},"bottom.top":function(a){return{x:a.x+a.width/2,y:a.y+a.height}},"bottomright.topleft":function(a){return{x:a.x+a.width,y:a.y+a.height}},"bottomright.topright":function(a){return{x:a.x,y:a.y+a.height}},bottomleft:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},bottom:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},bottomright:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},"bottomleft.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"bottomleft.bottomright":function(a){return{x:a.x,y:a.y}},"bottom.bottom":function(a){return{x:a.x+a.width/2,y:a.y}},"bottomright.bottomleft":function(a){return{x:a.x+a.width,y:a.y}},"bottomright.bottomright":function(a){return{x:a.x,y:a.y}},from:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},to:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2}},get:function(a,b){if(!b)throw"rect can not be null";var c=Pd[a];if(c)return c(b);throw"Can not resolve '"+a+"' position"}};Ib.vector.PhysicalZoomManager=function(a){Ib.vector.PhysicalZoomManager.superClass.constructor.apply(this,arguments)},Jb.ext("twaver.vector.PhysicalZoomManager",Ib.vector.BaseZoomManager,{getGraphicsZoom:function(){return this.getZoom()},_invalidateZoom:function(){}}),Ib.vector.LogicalZoomManager=function(a,b){Ib.vector.LogicalZoomManager.superClass.constructor.apply(this,arguments),this.sizeChange=b},Jb.ext("twaver.vector.LogicalZoomManager",Ib.vector.BaseZoomManager,{getLocationZoom:function(){return this.getZoom()},getSizeZoom:function(a){return this.sizeChange?this.getZoom():1}}),Ib.vector.MixedZoomManager=function(a,b){Ib.vector.MixedZoomManager.superClass.constructor.call(this,a,b)},Jb.ext("twaver.vector.MixedZoomManager",Ib.vector.LogicalZoomManager,{}),function(){function a(a){d[a]=function(){return this.getZoom()>1?b[a].apply(this,arguments):c[a].apply(this,arguments)}}var b=Ib.vector.LogicalZoomManager.prototype,c=Ib.vector.PhysicalZoomManager.prototype,d=Ib.vector.MixedZoomManager.prototype;for(var e in c)"function"==typeof c[e]&&"constructor"!=e&&(b.hasOwnProperty(e)||c.hasOwnProperty(e))&&a(e);d._invalidateZoom=function(){this.gl3dview.invalidateElementUIs()}}(),Ib.vector.interaction.BaseInteraction=function(a){this.gl3dview=a},Jb.ext("twaver.vector.interaction.BaseInteraction",Object,{setUp:function(){},tearDown:function(){},repaint:function(){this.gl3dview.repaintTopCanvas()},getOffset:function(a,b){return this.gl3dview.getOffset(a,b)},convertPointFromView:function(a){return this.gl3dview.convertPointFromView(a)},convertFromUIToMarkerRect:function(a,b,c,d){var e=this.gl3dview.zoomManager,f=e.getLocationZoom(),g=e.getGraphicsZoom(),h=e.getSizeZoom(this.gl3dview.getElementUI(d));return{x:a.x*f*g-this.gl3dview.getViewRect().x+b*f*g,y:a.y*f*g-this.gl3dview.getViewRect().y+c*f*g,width:a.width*h*g,height:a.height*h*g}},getMarkerPoint:function(a){var b;if(Qb.isTouchable&&a.changedTouches&&a.changedTouches.length>0){var c=a.changedTouches[0];return b={x:c.clientX,y:c.clientY}}return b=Qb.isFirefox?{x:a.layerX,y:a.layerY}:{x:a.offsetX,y:a.offsetY}},paint:function(a){},addListener:function(){for(var a=0;a<arguments.length;a++){var b=arguments[a];Wb.addEventListener(b,"handle_"+b,this.gl3dview.getView(),this)}},removeListener:function(){for(var a=0;a<arguments.length;a++)Wb.removeEventListener(arguments[a],this.gl3dview.getView(),this)},_handle_mousedown:function(a){0===a.button&&(this._startLogical=this.gl3dview.getLogicalPoint2(a),this._startClient=Wb.getClientPoint(a),this._startLogical&&Wb.handle_mousedown(this,a))},_handle_mousemove:function(a){this._endLogical={x:this._startLogical.x+(a.clientX-this._startClient.x)/this.gl3dview.getGraphicsZoom(),y:this._startLogical.y+(a.clientY-this._startClient.y)/this.gl3dview.getGraphicsZoom()}},_handle_mouseup:function(a){delete this._startClient,delete this._startLogical,delete this._endLogical}}),Ib.vector.interaction.DefaultInteraction=function(a,b){Ib.vector.interaction.DefaultInteraction.superClass.constructor.call(this,a),this.lazyMode=b},Jb.ext("twaver.vector.interaction.DefaultInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseover","mouseout","keydown"),Qb.isFirefox?Wb.addEventListener("DOMMouseScroll","handleMouseWheel",this.gl3dview.getView(),this):Wb.addEventListener("mousewheel","handleMouseWheel",this.gl3dview.getView(),this),Wb.addEventListener("mouseup","handle_mouseup",a,this),Wb.addEventListener("dblclick","handleDoubleClicked",this.gl3dview.getView(),this),this._oldCursor=this.gl3dview.getView().style.cursor,this.gl3dview.addPropertyChangeListener(this.handleViewRectChange,this),this.validateScrollBar(),this.gl3dview.addMarker(this),this.gl3dview.getView().oncontextmenu=function(a){a.preventDefault()},this._createZoomDiv()},tearDown:function(){this.removeListener("mousedown","mousemove","mouseover","mouseout","mouseup","keydown"),Qb.isFirefox?Wb.removeEventListener("DOMMouseScroll",this.gl3dview.getView(),this):Wb.removeEventListener("mousewheel",this.gl3dview.getView(),this),Wb.removeEventListener("dblclick",this.gl3dview.getView(),this),this.gl3dview.removePropertyChangeListener(this.handleViewRectChange,this),this.end(),this.gl3dview.removeMarker(this),this._zoomDiv=null},_createZoomDiv:function(){if(null==this._zoomDiv){this._zoomDiv=Ob.createElement("div"),this._zoomLabel=Ob.createElement("span"),this._zoomLabel.style.display="block",this._zoomLabel.style.textAlign="center";var b=Ob.createElement("button");b.innerHTML="Reset to default",this._zoomDiv.appendChild(this._zoomLabel),this._zoomDiv.appendChild(b);var c=Cd,d=this._zoomDiv.style;d.position="absolute",d.color=c.TOOLTIP_COLOR,d.background=c.TOOLTIP_BACKGROUND,d.fontSize=c.TOOLTIP_FONT_SIZE,d.padding=c.TOOLTIP_PADDING,d.border=c.TOOLTIP_BORDER,d.borderRadius=c.TOOLTIP_BORDER_RADIUS,d.boxShadow=c.TOOLTIP_BOX_SHADOW,d.zIndex=c.TOOLTIP_ZINDEX,d.setProperty&&d.setProperty("-webkit-box-shadow",c.TOOLTIP_BOX_SHADOW,null);var e=this;b.onclick=function(a){e.gl3dview.setZoom(1),e._setZoomDivVisible(!1)};var f=this._zoomDiv,g=function(){return f.style.opacity=parseFloat(f.style.opacity)-.05,parseFloat(f.style.opacity)<=.05?(e._setZoomDivVisible(!1),void(f._clearTimeout=null)):void(f._clearTimeout=setTimeout(f._clearFunc,100))};f._clearFunc=g,f.onmouseover=function(b){b||(b=a.event);for(var c=b.relatedTarget?b.relatedTarget:b.fromElement;c&&c!=f;)c=c.parentNode;c!=f&&(f._clearTimeout&&(clearTimeout(f._clearTimeout),f._clearTimeout=null),f.style.opacity=1)},f.onmouseout=function(b){b||(b=a.event);for(var c=b.relatedTarget?b.relatedTarget:b.toElement;c&&c!=f;)c=c.parentNode;c!=f&&(f._clearTimeout=setTimeout(f._clearFunc,10))}}},_isZoomDivVisible:function(){return null!=this._zoomDiv&&null!=this._zoomDiv.parentNode},_getZoomDiv:function(){return this._zoomDiv||this._createZoomDiv(),this._zoomDiv},_setZoomDivVisible:function(a,b,c){var d=this._getZoomDiv();if(a){this._zoomLabel.innerHTML=c,d.style.opacity=1,this._isZoomDivVisible()||this.gl3dview.getView().appendChild(d),d.style.left=Cd.TOOLTIP_XOFFSET+"px",d.style.top=Cd.TOOLTIP_YOFFSET+"px";d._clearTimeout&&(clearTimeout(d._clearTimeout),d._clearTimeout=null),d._clearTimeout=setTimeout(d._clearFunc,250)}else d.parentNode&&d.parentNode.removeChild(d)},handleViewRectChange:function(a){("viewRect"==a.property||"canvasSizeChange"==a.property)&&this.validateScrollBar()},getScrollBarWidth:function(){return this.gl3dview.getScrollBarWidth()},getScrollBarColor:function(){return"#cccccc"},validateScrollBar:function(){if(this.hThumbRect=null,this.vThumbRect=null,0==this.gl3dview.isScrollBarVisible())return void this.repaint();var a=this.gl3dview.getViewRect().height,b=this.gl3dview.getViewRect().width,c=this.gl3dview.getViewRect().x,d=this.gl3dview.getViewRect().y,e=this.gl3dview.getCanvasSize(),f=this.gl3dview._unionBounds,g=f.x,h=f.y,i=f.width,j=f.height,k=e.width,l=e.height,m=b,n=a,o=!1,p=!1;(c>g||k>b+c)&&(p=!0),(d>h||l>d+a)&&(o=!0);var q,r,s,t=0,u=0,v=0,w=0,x=m,y=n,z=this.getScrollBarWidth();p&&(o&&(x-=z),w=z,u=n-z,c>g&&c+b>k?(q=c-g,q=q*x/(q+m),t=q,v=x-q):g>c&&k>c+b?(q=k-(c+b),q=x*q/(q+m),t=0,v=x-q):(r=c-g,s=k-(c+b),r=x*r/i,s=x*s/i,t=r,v=m-r-s),this.hThumbRect={x:t,y:u,width:v,height:w}),t=0,u=0,v=0,w=0,x=m,y=n,o&&(p&&(y-=z),v=z,t=m-z,d>h&&d+a>l?(q=d-h,q=y*q/(q+n),u=q,w=y-q):h>d&&l>d+a?(q=l-(d+a),q=y*q/(q+n),u=0,w=y-q):(r=d-h,s=l-(d+a),r=y*r/j,s=y*s/j,u=r,w=y-r-s),this.vThumbRect={x:t,y:u,width:v,height:w}),this.gl3dview.setHScrollBarVisible(null!=this.hThumbRect),this.gl3dview.setVScrollBarVisible(null!=this.vThumbRect),this.repaint()},scrollXOffset:function(a){var b=this.gl3dview.getViewRect().height,c=this.gl3dview.getViewRect().width,d=this.gl3dview.getViewRect().x,e=this.gl3dview.getViewRect().y,f=30;a&&(f=-30),this.gl3dview.setViewRect(d+f,e,c,b)},scrollYOffset:function(a){var b=this.gl3dview.getViewRect().height,c=this.gl3dview.getViewRect().width,d=this.gl3dview.getViewRect().x,e=this.gl3dview.getViewRect().y,f=30;a&&(f=-30),this.gl3dview.setViewRect(d,e+f,c,b)},handle_mouseover:function(a){1!=this.scrollBarVisible&&(this.scrollBarVisible=!0,this.repaint())},handle_mouseout:function(a){0!=this.scrollBarVisible&&(this.scrollBarVisible=!1,this.repaint(),this.end(a))},handle_keydown:function(a){this.currentKeyEvent=a,this.addListener("keyup"),Cc.handleKeyDown(this.gl3dview,a)},handle_keyup:function(a){this.currentKeyEvent=null,this.removeListener("keyup")},start:function(b){this.end(b,!0),this.lastPoint=this.gl3dview.getLogicalPoint2(b),this.startPoint=this.gl3dview.getLogicalPoint2(b),this.lastPanPoint=this.getMarkerPoint(b),this.lazyMode&&(this.pressPoint=this.lastPoint),Wb.addEventListener("mousemove","handle_mousemove",a,this)},end:function(b,c){if(this.vBarDownPoint=null,this.hBarDownPoint=null,c||(this.gl3dview.getView().style.cursor=this._oldCursor),this.isMoving){if(this.lazyMode){if(null!=this.dragPoint&&null!=this.pressPoint){var d=this,e=function(){d.gl3dview.fireInteractionEvent({kind:"lazyMoveEnd",event:b}),d.gl3dview.setMovingElement(!1)},f=this.getOffset(this.dragPoint,this.pressPoint),g=f.x,h=f.y;this.gl3dview.moveSelectedElements(g,h,this.gl3dview.isLazyMoveAnimate(),e)}}else this.gl3dview.isMovingElement()&&(this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:b}));if(this.isParenting()){null==this.parent&&(this.parent=this.gl3dview.getCurrentSubGl3dview());var d=this;this.gl3dview.getMovableSelectedElements().forEach(function(a){a.setParent(d.parent)},this.gl3dview)}this.parentProcess(b,!0),this.isParenting()&&this.repaint(),this.gl3dview.invalidateCanvasSize(),this.lastPoint=null,this.dragPoint=null,this.pressPoint=null,this.repaint()}if(this.isSelecting&&this.startPoint){if(this.endPoint&&this.startPoint.x!==this.endPoint.x&&this.startPoint.y!==this.endPoint.y){var i=Tb.getRect([this.startPoint,this.endPoint]),j=this.gl3dview.getElementsAtRect(i,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(j&&j.size()>0){var k=this.gl3dview.getSelectionContainer(),l=k.toSelection();j.forEach(function(a){k.contains(a)?l.remove(a):l.add(a)},this),k.setSelection(l)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:b})}this.gl3dview.setSelectingElement(!1),this.startPoint=null,this.endPoint=null,this.repaint()}this.isMouseDown=!1,Wb.removeEventListener("mousemove",a,this)},_isDragToSelect:function(a){return!this.gl3dview._dragToPan},handle_mousedown:function(a){var b=this.gl3dview;if(a.target==b.getView()||a.target==b._topCanvas||a.target==b._rootCanvas){if(this.isMoving=!1,this.isSelecting=!1,this.hBarDownPoint=null,this.vBarDownPoint=null,this._setZoomDivVisible(!1),!this.gl3dview.isValidEvent(a)){var c=this.getMarkerPoint(a);return this.start(a),null!=this.vThumbRect&&Tb.containsPoint(this.vThumbRect,c.x,c.y)&&(this.vBarDownPoint={x:a.screenX,y:a.screenY},this.vBarDownOffset=this.vBarDownPoint.y-this.vThumbRect.y),void(null!=this.hThumbRect&&Tb.containsPoint(this.hThumbRect,c.x,c.y)&&(this.hBarDownPoint={x:a.screenX,y:a.screenY},this.hBarDownOffset=this.hBarDownPoint.x-this.hThumbRect.x))}this.gl3dview.isFocusOnClick()&&Ib.Util.setFocus(this.gl3dview.getView());var d=this.gl3dview.getElementAt(a);if(this.gl3dview.isSelectingElement()||this.gl3dview.isEditingElement()||null==d||(this.gl3dview.isMovable(d)?this.isMoving=!0:this.gl3dview.getView().style.cursor="pointer",this.start(a)),!this.gl3dview.isSelectingElement()&&!this.gl3dview.isEditingElement()){var e=this.gl3dview.getSelectionContainer();null==d?(Jb.isCtrlDown(a)?this.isSelecting=!0:this._isDragToSelect(a)?(this.isSelecting=!0,e.clearSelection()):this.gl3dview.isRectSelectEnabled()&&(e.clearSelection(),this.gl3dview.getView().style.cursor="pointer"),this.start(a)):Jb.isCtrlDown(a)?e.contains(d)?e.removeSelection(d):e.appendSelection(d):e.contains(d)||e.setSelection(d)}this.handleClicked(a,d),this.isMouseDown=!0}},handle_mousemove:function(a){this._setZoomDivVisible(!1);var b=this.gl3dview.getLogicalPoint2(a);if(b){var c={x:a.screenX,y:a.screenY},d=this.gl3dview.getCanvasSize(),e=this.gl3dview.getViewRect().height,f=this.gl3dview.getViewRect().width,g=this.getScrollBarWidth();if(null!=this.hBarDownPoint){var h=c.x-this.hBarDownPoint.x;return this.hBarDownPoint=c,void this.gl3dview.setViewOffSet(h*d.width/(f-g),0)}if(null!=this.vBarDownPoint){var i=c.y-this.vBarDownPoint.y;return this.vBarDownPoint=c,void this.gl3dview.setViewOffSet(0,i*d.height/(e-g))}if(this.gl3dview.isSelectingElement()||this.gl3dview.isEditingElement()||!this.isMoving||!this.isMouseDown||Jb.isCtrlDown(a))if(this.isSelecting&&(Jb.isCtrlDown(a)||this._isDragToSelect()))this.gl3dview.setSelectingElement(!0),this.gl3dview.fireInteractionEvent(null==this.endPoint?{kind:"selectStart",event:a}:{kind:"selectBetween",event:a}),this.endPoint=b,this.repaint();else if(this.isMoving||this.isSelecting||!this.isMouseDown)this.end(a);else{if(!this.lastPanPoint||!this.gl3dview._dragToPan)return;var b=this.getMarkerPoint(a);if(!b)return;var j=b.x-this.lastPanPoint.x,k=b.y-this.lastPanPoint.y;this.gl3dview.panByOffset(-j,-k),this.lastPanPoint=b}else{var l=this.getOffset(b,this.lastPoint);if(this.xoffset=l.x,this.yoffset=l.y,Math.abs(this.xoffset)<1&&Math.abs(this.yoffset)<1)return;this.lazyMode?null==this.dragPoint?(this.gl3dview.fireInteractionEvent({kind:"lazyMoveStart",event:a}),this.gl3dview.setMovingElement(!0)):this.gl3dview.fireInteractionEvent({kind:"lazyMoveBetween",event:a}):(this.gl3dview.moveSelectedElements(this.xoffset,this.yoffset),this.lastPoint=b,this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}))),this.parentProcess(a,!1),this.lazyMode&&(this.dragPoint=b),(this.lazyMode||this.isParenting())&&this.repaint()}}},handleMouseWheel:function(a){if(Ob.activeElement===this.gl3dview.getView()){if(!this.gl3dview._wheelToZoom)return void this._handleMouseWheelScroll(a);Wb.preventDefault(a);var b={x:a.offsetX||a.layerX,y:a.offsetY||a.layerY},c=this.gl3dview.getZoom();a.wheelDelta&&a.wheelDelta>0||a.detail&&a.detail<0?this.gl3dview.setZoom(1.1*c,b):this.gl3dview.setZoom(c/1.1,b),this._setZoomDivVisible(this.gl3dview.isZoomDivVisible(),a,"Zoom : "+parseFloat(this.gl3dview.getZoom().toFixed(4)))}},_handleMouseWheelScroll:function(a){Wb.preventDefault(a);var b=!1,c=this._getVisibleScrollBar();null!=c&&(b=a.wheelDelta?a.wheelDelta>0:a.detail<0,"v"==c?this.scrollYOffset(b):this.scrollXOffset(b))},handle_mouseup:function(a){this.end(a)},isParenting:function(){return this.pressPoint&&null!=this.currentKeyEvent&&80===this.currentKeyEvent.keyCode},parentProcess:function(a,b){var c=null;this.parent=null;var d=this;if(!b&&this.isParenting()){var e={},f=this.gl3dview.getLogicalPoint2(a);e.x=f.x-1,e.y=f.y-1,e.width=2,e.height=2;var g=this.gl3dview.getElementsAtRect(e,!0);if(g&&g.size()>0)for(var h=g.size(),i=0;h>i;i++){var j=g.get(i);if(!d.gl3dview.getElementBox().getSelectionContainer().contains(j)){d.parent=j;break}}}else this.parent=null;null!=this.parent&&(c=this.gl3dview.getElementUI(this.parent).getViewRect()),this.parentRect=null==c||b?null:c},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this.startPoint.x>this.endPoint.x&&this.startPoint.y>this.endPoint.y},_getVisibleScrollBar:function(){return 0==this.gl3dview.isScrollBarVisible()?null:null!=this.vThumbRect?"v":null!=this.hThumbRect?"h":null},paintScroll:function(a){if(0!=this.gl3dview.isScrollBarVisible()&&(0!=this.scrollBarVisible||null!=this.hBarDownPoint||null!=this.vBarDownPoint)){var b=this.getScrollBarWidth(),c=this.gl3dview.getViewRect().height,d=this.gl3dview.getViewRect().width;a.save();var e,f=this.getScrollBarColor();null!=this.hThumbRect&&(e=a.createLinearGradient(this.hThumbRect.x,this.hThumbRect.y,this.hThumbRect.x,this.hThumbRect.y+this.hThumbRect.height),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,0,c-b,d-b,b,b/2),this.paintRoundRect(a,e,.9,this.hThumbRect.x,this.hThumbRect.y+1,this.hThumbRect.width,this.hThumbRect.height-2,b/2)),null!=this.vThumbRect&&(e=a.createLinearGradient(this.vThumbRect.x,this.vThumbRect.y,this.vThumbRect.x+this.vThumbRect.width,this.vThumbRect.y),e.addColorStop(0,f),e.addColorStop(1,"#666666"),this.paintRoundRect(a,this.getScrollBarColor(),.5,d-b,0,b,c-b,b/2),this.paintRoundRect(a,e,.9,this.vThumbRect.x+1,this.vThumbRect.y,this.vThumbRect.width-2,this.vThumbRect.height,b/2)),a.restore()}},paintRoundRect:function(a,b,c,d,e,f,g,h){a.beginPath(),a.globalAlpha=c,a.fillStyle=b,Xb.drawRoundRect(a,d,e,f,g,h),a.fill()},paint:function(a){if(this.paintScroll(a),this.gl3dview.isSelectingElement()){if(null==this.startPoint||null==this.endPoint)return;var b=this.convertPointFromView(this.startPoint),c=this.convertPointFromView(this.endPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Tb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.gl3dview.getSelectOutlineWidth(),j=this.getIntersectMode()?this.gl3dview.getSelectFillColor():null;a.strokeStyle=this.gl3dview.getSelectOutlineColor(),a.lineWidth=i,Md.rect(a,h.x,h.y,h.width,h.height,j,this.gl3dview.getSelectOutlineColor()),a.closePath()}}else{if(this.lazyMode){if(null==this.pressPoint||null==this.dragPoint)return;a.beginPath();var k=this.getOffset(this.dragPoint,this.pressPoint),l=k.x,m=k.y,n=this.gl3dview.getMovableSelectedElements(),o=n.size(),p=this.gl3dview.isLazyMoveFill()?this.gl3dview.getLazyMoveFillColor():null,i=this.gl3dview.getLazyMoveOutlineWidth(),q=this.gl3dview.getLazyMoveOutlineColor();a.strokeStyle=q,a.lineWidth=i,a.fillStyle=p;for(var r=0;o>r;r++){var s=n.get(r),t=this.gl3dview.getElementUI(s);if(t){var u=this.convertFromUIToMarkerRect(t.getViewRect(),l,m);Md.rect(a,u.x,u.y,u.width,u.height)}}a.fill(),a.stroke()}if(this.parentRect){a.beginPath();var p=this.gl3dview.isLazyMoveFill()?this.gl3dview.getLazyMoveFillColor():null,i=this.gl3dview.getLazyMoveOutlineWidth(),q=this.gl3dview.getLazyMoveOutlineColor();a.strokeStyle=q,a.lineWidth=i,a.fillStyle=p;var u=this.parentRect;Md.rect(a,u.x,u.y,u.width,u.height),a.fill(),a.stroke()}}},handleClicked:function(a,b){Cc.handleClicked(this.gl3dview,a,b)},handleDoubleClicked:function(a){var b=this.gl3dview.getElementAt(a);Cc.handleDoubleClicked(this.gl3dview,a,b)}}),Ib.vector.interaction.CreateElementInteraction=function(a,b){b||(b=Ib.Node),this.elementFunction=Ib.Util.isTypeOf(b,Ib.Node)?function(a){var c=new b;return c instanceof Ib.Node&&c.setCenterLocation(a),c}:b,Ib.vector.interaction.CreateElementInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.vector.interaction.CreateElementInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown")},tearDown:function(){this.removeListener("mousedown")},handle_mousedown:function(a){var b=this.gl3dview.getLogicalPoint2(a);if(b){var c=this.elementFunction(b);c&&this.gl3dview.addElementByInteraction(c)}}}),Ib.vector.interaction.EditInteraction=function(a,b){this.lazyMode=b,this.pointIndex=-1,this.editPointSize=a.getEditPointSize(),this.resizePointSize=a.getResizePointSize(),this.rotatePointSize=a.getRotatePointSize(),Ib.vector.interaction.EditInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.vector.interaction.EditInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mouseup","mousemove"),this.oldCursor=this.gl3dview.getView().style.cursor,this.gl3dview.setHasEditInteraction(!0),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mouseup","mousemove"),this.gl3dview.getView().style.cursor=this.oldCursor,this.gl3dview.setHasEditInteraction(!1),this.clear(),this.gl3dview.removeMarker(this)},paint:function(a){if(1==this.lazyMode&&null!=this.resizingRect){a.lineWidth=this.gl3dview.getResizeLineWidth();var b=this.convertFromUIToMarkerRect(this.resizingRect,0,0,this.node);a.save(),Ib.Util.rotateCanvas(a,b,this.node.getAngle()),a.beginPath(),Md.rect(a,b.x,b.y,b.width,b.height,null,this.gl3dview.getResizeLineColor()),a.restore()}this.isStartRotate&&this.showRotateScale(a)},clear:function(){this.gl3dview.setEditingElement(!1),this.gl3dview.setRotatingElement(!1),this.isStart=!1,this.isStartRotate=!1,this.node=null,this.shapeNode=null,this.shapeLink=null,this.linkUI=null,this.resizingRect=null,this.resizeDirection=null,this.pointIndex=-1,this._removeCursor(),this.oldCursor=null,this.gl3dview.repaintTopCanvas()},_removeCursor:function(){this.cursorID&&(this.gl3dview.getView().style.cursor=this.oldCursor||"default",this.cursorID=null),this.resizeDirection=null,this.isCrossCursor=!1},_setCrossCursor:function(){this.isCrossCursor||(this._removeCursor(),this._setCursor("crosshair"),this.isCrossCursor=!0)},_setCursor:function(a){this.cursorID=a,this.gl3dview.getView().style.cursor!==this.cursorID&&(this.gl3dview.getView().style.cursor=this.cursorID)},handle_mousedown:function(a){if(0===a.button)if(!Jb.isAltDown(a)||this.gl3dview.isEditingElement())!this.gl3dview.isEditingElement()||this.isStart||this.isStartRotate||(this.node&&this.resizeDirection?(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:a,element:this.node,resizeDirection:this.resizeDirection})):this.shapeNode&&this.pointIndex>=0?Jb.isAltDown(a)?(this.shapeNode.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0?Jb.isAltDown(a)?(this.shapeLink.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:a,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(a),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:this.linkUI._element})):this.node&&(this.isStartRotate=!0,this._handle_mousedown(a)));else{var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getLogicalPoint2(a);if(b instanceof Ib.ShapeNode){var d=this.getPointIndex(this.gl3dview.getShapeNodeZoomPoints(b),c,!0);d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeNode=b,b.addPoint(c,d),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}if(b instanceof Ib.ShapeLink){var e=new Ib.List(b.getPoints()),f=this.gl3dview.getElementUI(b);e.add(f.getFromPoint(),0),e.add(f.getToPoint());var d=this.getPointIndex(e,c)-1;d>0&&(this._handle_mousedown(a),this.pointIndex=d,this.shapeLink=b,b.addPoint(c,d),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:a,element:b,pointIndex:d}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:a,element:b,pointIndex:d}))}}},handle_mouseup:function(a){if(this.isStart){var b=this.gl3dview.getLogicalPoint2(a);if(this.resizingRect)if(this.lazyMode)if(this.gl3dview.isResizeAnimate()){var c=this,d=new Ib.animate.AnimateBounds(this.node,this.resizingRect,function(){c.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:c.node,resizeDirection:c.resizeDirection})});Ib.animate.AnimateManager.start(d)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"liveResizeEnd",event:a,element:this.node,resizeDirection:this.resizeDirection});else this.shapeNode&&this.pointIndex>=0&&b?(this._resetShapeNodePoints(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeNode,pointIndex:this.pointIndex})):this.shapeLink&&this.pointIndex>=0&&b?(this._resetShapeLinkPoints(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI&&b&&(this._setLinkControlPoint(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:a,element:this.linkUI._element}))}this._handle_mouseup(a),this.clear()},handle_mousemove:function(a){if(this.gl3dview.isValidEvent(a)){if(this.isStartRotate&&this.node)return this._handleRotateElement(a,this.node),void(this.gl3dview.isShowRotateScale()&&this.repaint());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0)return void this._handleMovingShapeNodePoint(a);if(this.shapeLink&&this.pointIndex>=0)return void this._handleMovingShapeLinkPoint(a);if(this.node&&this.resizeDirection)return void this._handleResizing(a);

if(this.linkUI)return void this._handleMovingLinkControlPoint(a)}if(this.gl3dview.isSelectingElement()||this.gl3dview.isMovingElement()||0===this.gl3dview.getSelectionContainer().size())return void this.clear();var b=this.gl3dview.getElementAt(a),c=this.gl3dview.getElementUI(b);if(!c||!c.getEditAttachment())return void this.clear();var d=this.gl3dview.getLogicalPoint2(a);if(b instanceof Ib.Node){if(this.node=b,this._isEditingShapeNode(d)||this._isResizingNode(d))return void this.gl3dview.setEditingElement(!0);if(this._isRotatingElement(d))return this.gl3dview.setRotatingElement(!0),void this.gl3dview.setEditingElement(!0)}else if(b instanceof Ib.ShapeLink){if(this.shapeLink=b,this._isEditingShapeLink(d))return void this.gl3dview.setEditingElement(!0)}else if(c instanceof Ib.vector.LinkUI&&xc.isOrthogonalLink(c._element)){this.linkUI=c;var e=this.linkUI.getControlPoint();return void(e&&this._contains(d,e,this.editPointSize)&&(this._setCrossCursor(),this.gl3dview.setEditingElement(!0)))}this.clear()}},_isRotatingElement:function(a){var b=this.gl3dview.getRotatePointSize();if(0>=b)return!1;var c=this.gl3dview.zoomManager,d=this.gl3dview.getElementUI(this.node),e=c.getSizeZoom(d),f=c._getElementZoomRect(d,this.node.getOriginalRect()),g=this.node.getAngle();return this._isRotating(a,"crosshair",f,g,e)},_isRotating:function(a,b,c,d,e){var f=this.gl3dview.getRotatePointSize(),g={x:c.x+c.width/2,y:c.y-this.gl3dview.getRotatePointOffset()-f},h=this._rotatePoint(g,d,c),i={x:h.x-f,y:h.y-f,width:2*f,height:2*f};return Tb.containsPoint(i,a)?(this._removeCursor(),this._setCursor(b),!0):!1},_handleRotateElement:function(a,b){this._handle_mousemove(a);var c=this._calculateAngle(this.gl3dview.getLogicalPoint2(a),b);b.setAngle(c)},_calculateAngle:function(a,b){var c=this.gl3dview.getZoomBodyRect(b),d=Tb.getCenterPoint(c);return Math.round(180*Math.atan2(d.x-a.x,a.y-d.y)/Math.PI+180)},_resetShapeNodePoints:function(a){var b=this.gl3dview.getShapeNodeZoomPoints(this.shapeNode);b.set(this.pointIndex,a);var c=this.gl3dview.getElementUI(this.shapeNode),d=this.gl3dview.zoomManager._getShapeNodeZoomPoints(c,b,!0);this.shapeNode.setPoints(d)},_handleMovingShapeNodePoint:function(a){var b=this.gl3dview.getLogicalPoint2(a);this._resetShapeNodePoints(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeNode,pointIndex:this.pointIndex})},_resetShapeLinkPoints:function(a){var b=this.gl3dview.zoomManager._getShapeLinkZoomPoints(this.shapeLink._points);b.set(this.pointIndex,a);var c=this.gl3dview.zoomManager._getShapeLinkZoomPoints(b,!0);this.shapeLink.setPoints(c)},_handleMovingShapeLinkPoint:function(a){var b=this.gl3dview.getLogicalPoint2(a);this._resetShapeLinkPoints(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.shapeLink,pointIndex:this.pointIndex})},_setLinkControlPoint:function(a){var b=this.linkUI.getControlPoint(),c=this.linkUI.getControlPoint(),d=(this.gl3dview.zoomManager,{x:a.x-c.x,y:a.y-c.y});b.x+=d.x,b.y+=d.y,this.linkUI.setControlPoint(b)},_handleMovingLinkControlPoint:function(a){var b=this.gl3dview.getLogicalPoint2(a);this._setLinkControlPoint(b),this.gl3dview.fireInteractionEvent({kind:"liveMovePointBetween",e:a,element:this.linkUI._element})},convertFromUIToMarkerRect:function(a,b,c,d){var e=this.gl3dview.zoomManager,f=e.getLocationZoom(),g=e.getGraphicsZoom(),h=this.gl3dview.getElementUI(d),i=e.getSizeZoom(h),j=a.x+a.width/2,k=a.y+a.height/2,l=j-a.x,m=k-a.y;return{x:j*f*g-this.gl3dview.getViewRect().x+b*f*g-l*i*g,y:k*f*g-this.gl3dview.getViewRect().y+c*f*g-m*i*g,width:a.width*i*g,height:a.height*i*g}},_getReverseZoomPoint:function(a,b,c){var d=this.gl3dview.zoomManager,e=d.getLocationZoom(),f=d.getSizeZoom(this.gl3dview.getElementUI(a));return b.x*=e,b.y*=e,{x:b.x/e+(c.x-b.x)/f,y:b.y/e+(c.y-b.y)/f}},_getReverseZoomRect:function(a,b){var c=this.gl3dview.zoomManager,d=c.getLocationZoom(),e=c.getSizeZoom(f);if(d==e)return a;var f=this.gl3dview.getElementUI(b),g=f.getBodyRect(),h=g.x+g.width/2,i=g.y+g.height/2,j={x:h*d+(a.x-h)*e,y:i*d+(a.y-i)*e,width:a.width*e,height:a.height*e};return h=j.x+j.width/2,i=j.y+j.height/2,{x:h/d+(j.x-h)*e,y:i/d+(j.y-i)*e,width:a.width,height:a.height}},_handleResizing:function(a){this._handle_mousemove(a);var b=this.node.getAngle(),c=this.node.getLocation(),d=this.node.getWidth()/2,e=this.node.getHeight()/2,f={x:c.x+d,y:c.y+e},g={x:-d,y:-e},h={x:-d,y:e},i={x:d,y:e},j={x:d,y:-e},k={x:0,y:-e},l={x:d,y:0},m={x:0,y:e},n={x:-d,y:0},o=this._getReverseZoomPoint(this.node,Jb.clone(f),this._endLogical);if("northwest"===this.resizeDirection&&(this._transformPoint(i,f,b),g.x=o.x,g.y=o.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),"north"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),k.y=p.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}if("northeast"===this.resizeDirection&&(this._transformPoint(h,f,b),j.x=o.x,j.y=o.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"west"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),n.x=p.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("east"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),l.x=p.x-f.x,this._transformPoint(l,f,b),this._transformPoint(n,f,b),f.x=(l.x+n.x)/2,f.y=(l.y+n.y)/2,this._reversPoint(l,f,b),this._reversPoint(n,f,b),this.resizingRect={x:f.x-(l.x-n.x)/2,y:f.y-this.node.getHeight()/2,width:l.x-n.x,height:this.node.getHeight()}}if("southwest"===this.resizeDirection&&(this._transformPoint(j,f,b),h.x=o.x,h.y=o.y,f.x=(h.x+j.x)/2,f.y=(h.y+j.y)/2,this._reversPoint(h,f,b),this._reversPoint(j,f,b),this.resizingRect={x:h.x,y:j.y,width:j.x-h.x,height:h.y-j.y}),"south"===this.resizeDirection){var p={x:o.x,y:o.y};this._reversPoint(p,f,b),m.y=p.y-f.y,this._transformPoint(k,f,b),this._transformPoint(m,f,b),f.x=(k.x+m.x)/2,f.y=(k.y+m.y)/2,this._reversPoint(k,f,b),this._reversPoint(m,f,b),this.resizingRect={x:f.x-this.node.getWidth()/2,y:f.y-(m.y-k.y)/2,width:this.node.getWidth(),height:m.y-k.y}}"southeast"===this.resizeDirection&&(this._transformPoint(g,f,b),i.x=o.x,i.y=o.y,f.x=(g.x+i.x)/2,f.y=(g.y+i.y)/2,this._reversPoint(g,f,b),this._reversPoint(i,f,b),this.resizingRect={x:g.x,y:g.y,width:i.x-g.x,height:i.y-g.y}),this.resizingRect=this._getReverseZoomRect(this.resizingRect,this.node),this.lazyMode?(this.repaint(),this.gl3dview.fireInteractionEvent({kind:"lazyResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection})):(this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"liveResizeBetween",event:a,element:this.node,resizeDirection:this.resizeDirection}))},_isEditingShapeNode:function(a){if(this.node instanceof Ib.ShapeNode){this.shapeNode=this.node;for(var b=this.gl3dview.getShapeNodeZoomPoints(this.node),c=0,d=b.size();d>c;c++){var e=b.get(c);if(this._contains(a,e,this.editPointSize))return this._setCrossCursor(),this.pointIndex=c,!0}}return this.pointIndex=-1,!1},_isEditingShapeLink:function(a){for(var b=this.gl3dview.zoomManager._getShapeLinkZoomPoints(this.shapeLink.getPoints()),c=0,d=b.size();d>c;c++){var e=b.get(c);if(this._contains(a,e,this.editPointSize))return this._setCrossCursor(),this.pointIndex=c,!0}return this.pointIndex=-1,!1},_isResizingNode:function(a){var b=this.gl3dview.getResizePointSize();if(0>=b)return!1;var c=this.gl3dview.zoomManager,d=this.gl3dview.getElementUI(this.node),e=c._getElementZoomRect(d,this.node.getOriginalRect()),f=this.node.getAngle(),g={x:e.x,y:e.y},h=this._rotatePoint(g,f,e);return this._isResizing(a,h.x,h.y,"northwest","nwse-resize")?!0:(g={x:e.x+e.width/2,y:e.y},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"north","ns-resize")?!0:(g={x:e.x+e.width,y:e.y},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"northeast","nesw-resize")?!0:(g={x:e.x,y:e.y+e.height/2},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"west","ew-resize")?!0:(g={x:e.x+e.width,y:e.y+e.height/2},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"east","ew-resize")?!0:(g={x:e.x,y:e.y+e.height},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"southwest","nesw-resize")?!0:(g={x:e.x+e.width/2,y:e.y+e.height},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"south","ns-resize")?!0:(g={x:e.x+e.width,y:e.y+e.height},h=this._rotatePoint(g,f,e),this._isResizing(a,h.x,h.y,"southeast","nwse-resize")?!0:!1)))))))},_rotatePoint:function(a,b,c){var d=Tb.createMatrix(b*Math.PI/180,c.x+c.width/2,c.y+c.height/2),e=d.transform(a);return e},_isResizing:function(a,b,c,d,e){return this._contains(a,{x:b,y:c},this.resizePointSize)?(this.resizeDirection!==d&&(this._removeCursor(),e=this._changeCursorWithAngle(d,this.node.getAngle()),this._setCursor(e),this.resizeDirection=d),!0):!1},_getRect:function(a,b,c,d){var e=c>a?a:c,f=d>b?b:d,g=Math.abs(a-c),h=Math.abs(b-d);return{x:e,y:f,width:g,height:h}},_contains:function(a,b,c){var d={x:b.x-c,y:b.y-c,width:2*c,height:2*c};return Tb.containsPoint(d,a)},getPointIndex:function(a,b,c){if(a.size()<2)return 0;for(var d,e=a.get(0),f=1;f<a.size();f++){if(d=a.get(f),this.isPointOnLine(b,e,d,6))return f;e=d}return e=a.get(0),c&&this.isPointOnLine(b,e,d,6)?a.size():0},showRotateScale:function(a){var b,c,d,e,f,g=(new Ib.List,this.gl3dview.getRotateScaleWidth()),h=this.gl3dview.getRotateScaleHeight(),i=this.gl3dview.getRotatePointSize(),j=this.node.getAngle(),k=this.gl3dview.zoomManager,l=this.gl3dview.getElementUI(this.node),m=k._getElementZoomRect(l,this.node.getOriginalRect()),n={x:m.x+m.width/2,y:m.y-this.gl3dview.getRotatePointOffset()-i},o=this._rotatePoint(n,j,m),p="13px Arial",q=j+"°",r=this.gl3dview.getViewRect();1===k.getLocationZoom()&&(a.translate(-r.x,-r.y),a.scale(this.gl3dview.getZoom(),this.gl3dview.getZoom())),this.node.getAngle()>=0&&this.node.getAngle()<=180?(c={x:o.x+i,y:o.y},d={x:c.x+g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y}):this.node.getAngle()>180&&this.node.getAngle()<=360&&(c={x:o.x-i,y:o.y},d={x:c.x-g,y:c.y},e={x:d.x,y:d.y-h},f={x:c.x,y:e.y});var s=new Ib.List([c,d,e,f]),b=Jb.math.getRect(s);1!==k.getLocationZoom()&&(b.x-=r.x,b.y-=r.y),a.fillStyle=this.gl3dview.getRotateScaleFillColor(),a.fillRect(b.x,b.y,b.width,b.height),a.fillStyle=this.gl3dview.getRotateScaleFontColor(),a.textBaseline="middle",a.textAlign="center",a.font=p,a.fillText(q,b.x+b.width/2,b.y+b.height/2),1===k.getLocationZoom()&&(a.scale(1/this.gl3dview.getZoom(),1/this.gl3dview.getZoom()),a.translate(r.x,r.y))},isPointOnLine:function(a,b,c,d){0>d&&(d=0);var e=this.getDistanceFromPointToLine(a,b,c);return d>=e&&a.x>=Math.min(b.x,c.x)-d&&a.x<=Math.max(b.x,c.x)+d&&a.y>=Math.min(b.y,c.y)-d&&a.y<=Math.max(b.y,c.y)+d},getDistanceFromPointToLine:function(a,b,c){if(b.x===c.x)return Math.abs(a.x-b.x);var d=(c.y-b.y)/(c.x-b.x),e=(c.x*b.y-b.x*c.y)/(c.x-b.x);return Math.abs(d*a.x-a.y+e)/Math.sqrt(d*d+1)},_transformPoint:function(a,b,c){var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x,g=a.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_reversPoint:function(a,b,c){c*=-1;var d=Math.cos(c*Math.PI/180),e=Math.sin(c*Math.PI/180),f=a.x-b.x,g=a.y-b.y,h=f*d-g*e,i=f*e+g*d;a.x=h+b.x,a.y=i+b.y},_changeCursorWithAngle:function(a,b){var c,d=["auto","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"];switch(a){case"northwest":c=1;break;case"north":c=2;break;case"northeast":c=3;break;case"east":c=4;break;case"southeast":c=5;break;case"south":c=6;break;case"southwest":c=7;break;case"west":c=8;break;default:c=0}return(b>=360||-360>=b)&&(b%=360),b>22.5&&67.5>=b&&(c+=1),-22.5>b&&b>=-67.5&&(c-=1),b>67.5&&112.5>=b&&(c+=2),-67.5>b&&b>=-112.5&&(c-=2),b>112.5&&157.5>=b&&(c+=3),-112.5>b&&b>=-157.5&&(c-=3),b>157.5&&202.5>=b&&(c+=4),-157.5>b&&b>=-202.5&&(c-=4),b>202.5&&247.5>=b&&(c+=5),-202.5>b&&b>=-247.5&&(c-=5),b>247.5&&292.5>=b&&(c+=6),-247.5>b&&b>=-292.5&&(c-=6),b>292.5&&337.5>=b&&(c+=7),-292.5>b&&b>=-337.5&&(c-=7),c>8&&(c-=8),0>=c&&(c+=8),d[c]}}),Ib.vector.interaction.CreateLinkInteraction=function(a,b){b||(b=Ib.Link),this.linkFunction=Ib.Util.isTypeOf(b,Ib.Link)?function(a,c){var d=new b;return d instanceof Ib.Link&&(d.setFromNode(a),d.setToNode(c)),d}:b,Ib.vector.interaction.CreateLinkInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.vector.interaction.CreateLinkInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.gl3dview.removeMarker(this)},paint:function(a){a.beginPath();var b,c;a.lineWidth=this.gl3dview.getEditLineWidth();var d=this.gl3dview.getEditLineColor();this.currentNode&&this.currentNode!==this.fromNode&&(b=this.gl3dview.getElementUI(this.currentNode).getZoomViewRect(!0),c=this.convertFromUIToMarkerRect(b,0,0),Md.rect(a,c.x,c.y,c.width,c.height,null,d)),this.fromNode&&(b=this.gl3dview.getElementUI(this.fromNode).getZoomViewRect(!0),c=this.convertFromUIToMarkerRect(b,0,0),Md.rect(a,c.x,c.y,c.width,c.height,null,d)),this.currentPoint&&this.paintLine(a),a.closePath()},convertFromUIToMarkerRect:function(a,b,c){var d=this.gl3dview.zoomManager,e=d.getGraphicsZoom();return{x:a.x*e-this.gl3dview.getViewRect().x+b*e,y:a.y*e-this.gl3dview.getViewRect().y+c*e,width:a.width*e,height:a.height*e}},getZoomNodeRectOrPoint:function(a,b){var c=this.gl3dview.getElementUI(a).getZoomBodyRect();return b?{x:c.x+c.width/2,y:c.y+c.height/2}:c},paintLine:function(a){var b=this.gl3dview.getEditLineColor(),c=this.gl3dview.getElementUI(this.fromNode).getZoomBodyRect(),d=this.convertPointFromView({x:c.x+c.width/2,y:c.y+c.height/2}),e=d.x,f=d.y,g=this.currentPoint.x,h=this.currentPoint.y;a.strokeStyle=b,a.beginPath(),a.moveTo(e,f),a.lineTo(g,h),a.stroke()},clear:function(){this.currentPoint=null,this.currentNode=null,this.fromNode=null,this.toNode=null},createLink:function(){return this.linkFunction(this.fromNode,this.toNode)},handle_mousedown:function(a){if(this.gl3dview.isValidEvent(a))if(this.fromNode){if(this.toNode=this.currentNode,this.toNode){var b=this.createLink();b&&this.gl3dview.addElementByInteraction(b)}this.clear()}else this.fromNode=this.currentNode,this.currentNode=null,this.currentPoint=null,this.repaint()},handle_mousemove:function(a){var b=this.getMarkerPoint(a);if(b){if(this.gl3dview.isMovingElement()||this.gl3dview.isEditingElement())return void this.clear();var c=null;this.fromNode?(this.currentNode=this.getToNode(a,this.fromNode),this.currentPoint=b,this.repaint()):(c=this.getFromNode(a),this.currentNode!==c&&(this.currentNode=c,this.repaint()))}},getFromNode:function(a){return this.getNode(a)},getToNode:function(a,b){return this.getNode(a,b)},getNode:function(a,b){var c=this.gl3dview.getElementAt(a);return c instanceof Jd&&this.gl3dview.isLinkable(c,b)?c:null}}),Ib.vector.interaction.CreateShapeLinkInteraction=function(a,b){Ib.vector.interaction.CreateShapeLinkInteraction.superClass.constructor.call(this,a),b||(b=Ib.ShapeLink),this.linkFunction=Ib.Util.isTypeOf(b,Ib.ShapeLink)?function(a,c,d){var e=new b;if(e instanceof Ib.ShapeLink&&(e.setFromNode(a),e.setToNode(c),d)){var f=this.gl3dview.zoomManager;e.setPoints(f._getShapeLinkZoomPoints(d,!0))}return e}:b},Jb.ext("twaver.vector.interaction.CreateShapeLinkInteraction",Ib.vector.interaction.CreateLinkInteraction,{clear:function(){this.points=null,Ib.vector.interaction.CreateShapeLinkInteraction.superClass.clear.call(this)},createLink:function(){return this.linkFunction(this.fromNode,this.toNode,this.points)},handle_mousedown:function(a){if(0===a.button){var b=this.gl3dview.getLogicalPoint2(a);if(b){if(this.fromNode)if(this.toNode=this.currentNode,this.toNode){var c=this.createLink();c&&this.gl3dview.addElementByInteraction(c),this.clear()}else{if(this.points||(this.points=new Ib.List),this.points.size()>0){var d=this.points.get(this.points.size()-1);if(d.x===b.x&&d.y===b.y)return}this.points.add(b)}else this.fromNode=this.currentNode,this.points=null,this.currentNode=null,this.currentPoint=null;this.repaint()}}},paintLine:function(a){if(this.currentPoint){var b,c=new Ib.List;if(b=this.convertPointFromView(this.getZoomNodeRectOrPoint(this.fromNode,!0)),c.add(b,0),this.points&&this.points.size()>0)for(var d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.currentPoint,c.add(b),a.lineWidth=this.gl3dview.getEditLineWidth(),a.strokeStyle=this.gl3dview.getEditLineColor(),a.beginPath(),Xb.drawLinePoints(a,c),a.stroke()}}}),Ib.vector.interaction.CreateShapeNodeInteraction=function(a,b){b||(b=Ib.ShapeNode),this.shapeNodeFunction=Ib.Util.isTypeOf(b,Ib.ShapeNode)?function(a){var c=new b;if(c instanceof Ib.ShapeNode){var d=this.gl3dview.zoomManager,e=this.gl3dview.createElementUI(c);if(a){var f=d._getShapeNodeZoomPoints(e,a,!0);e.invalidateZoom(),c.setPoints(f)}}return c}:b,Ib.vector.interaction.CreateShapeNodeInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.vector.interaction.CreateShapeNodeInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousedown","mousemove"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousedown","mousemove"),this.clear(),this.gl3dview.removeMarker(this),this.gl3dview.setEditingElement(!1)},clear:function(){this.points=null,this.currentPoint=null},paint:function(a){if(this.points&&this.points.size()>0&&this.currentPoint){for(var b,c=new Ib.List,d=this.points.size(),e=0;d>e;e++)b=this.convertPointFromView(this.points.get(e)),c.add(b);b=this.convertPointFromView(this.currentPoint),c.add(b),a.lineWidth=this.gl3dview.getEditLineWidth(),a.strokeStyle=this.gl3dview.getEditLineColor(),a.beginPath(),Xb.drawLinePoints(a,c),a.stroke()}},handle_mousedown:function(a){if(0===a.button){var b=this.gl3dview.getLogicalPoint2(a);if(b){if(2===a.detail){if(this.points){var c=this.shapeNodeFunction(this.points);this.gl3dview.addElementByInteraction(c),this.clear();var d=this;setTimeout(function(){d.gl3dview.setEditingElement(!1)},0)}}else{if(this.gl3dview.isEditingElement()||this.gl3dview.setEditingElement(!0),this.points||(this.points=new Ib.List),this.points.size()>0){var e=this.points.get(this.points.size()-1);if(e.x===b.x&&e.y===b.y)return}this.points.add(b)}this.repaint()}}},handle_mousemove:function(a){this.points&&(this.currentPoint=this.gl3dview.getLogicalPoint2(a),this.repaint())}}),Ib.vector.interaction.MagnifyInteraction=function(a,b,c,d){Ib.vector.interaction.MagnifyInteraction.superClass.constructor.call(this,a),this.scale=b||2,this.xRadius=c||100,this.yRadius=d||100,this.markCanvas=Wb.createCanvas()},Jb.ext("twaver.vector.interaction.MagnifyInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){this.addListener("mousemove"),this.addListener("mousewheel"),this.gl3dview.addMarker(this)},tearDown:function(){this.removeListener("mousemove"),this.removeListener("mousewheel"),this.gl3dview.removeMarker(this)},paint:function(a){if(this.point){var b=this.gl3dview.zoomManager,c=b.getLocationZoom(),d=b.getGraphicsZoom(),e=(b.getSizeZoom(),this.gl3dview.getZoom(),this.xRadius/this.scale/d),f=this.yRadius/this.scale/d;if("mousewheel"===this.mouseFlag){var g={x:this.zoomPoint.x-e,y:this.zoomPoint.y-f,width:2*e,height:2*f};this.gl3dview.toCanvasByRegion(g,this.scale*d,this.markCanvas,"white");var h={x:this.zoomPoint.x-this.xRadius-this.gl3dview.viewRect.x,y:this.zoomPoint.y-this.yRadius-this.gl3dview.viewRect.y,width:this.markCanvas.width,height:this.markCanvas.height}}else{var g={x:this.point.x*c-e,y:this.point.y*c-f,width:2*e,height:2*f};this.gl3dview.toCanvasByRegion(g,this.scale*d,this.markCanvas,"white");var h={x:this.point.x*c*d-this.xRadius-this.gl3dview.viewRect.x,y:this.point.y*c*d-this.yRadius-this.gl3dview.viewRect.y,width:this.markCanvas.width,height:this.markCanvas.height}}a.save(),a.beginPath(),a.arc(h.x+h.width/2,h.y+h.height/2,Math.min(g.width*d-1,g.height*d-1),0,2*Math.PI,!0),a.clip(),a.fillStyle="#ffffff",a.beginPath(),a.rect(h.x,h.y,h.width,h.height),a.fill(),a.drawImage(this.markCanvas,h.x,h.y),a.restore(),a.beginPath(),a.arc(h.x+h.width/2,h.y+h.height/2,Math.min(g.width*d-1,g.height*d-1),0,2*Math.PI,!0),a.strokeStyle="black",a.stroke(),this.mouseFlag=null}},handle_mousemove:function(a){this.point=this.gl3dview.getLogicalPoint(a),this.point&&(this.mouseFlag="mousemove",this.repaint())},handle_mousewheel:function(a){var b=this.gl3dview.zoomManager,c=b.getLocationZoom();1!==c&&(this.zoomPoint=this.gl3dview.getLogicalPoint2(a)),this.zoomPoint&&(this.mouseFlag="mousewheel",this.repaint())}}),Ib.vector.interaction.TouchInteraction=function(a){Ib.vector.interaction.TouchInteraction.superClass.constructor.call(this,a)},Jb.ext("twaver.vector.interaction.TouchInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){var a=this.gl3dview.getView();Wb.addEventListener("touchstart","handleTouchstart",a,this),Wb.addEventListener("touchmove","handleTouchmove",a,this),Wb.addEventListener("touchend","handleTouchend",a,this),Wb.addEventListener("touchcancel","handleTouchend",a,this)},tearDown:function(){var a=this.gl3dview.getView();Wb.removeEventListener("touchstart",a,this),Wb.removeEventListener("touchmove",a,this),Wb.removeEventListener("touchend",a,this),Wb.removeEventListener("touchcancel",a,this)},handleTouchstart:function(a){if(Wb.preventDefault(a),console.log("start",a.touches.length,a.changedTouches.length),1==a.touches.length){var b=this.gl3dview.getLogicalPoint2(a),c=this._element=this.gl3dview.getElementAt(b);this._startTouchTime=new Date,this._currentTouchPoint=b,this._startTouchClient=this._currentTouchClient=this.getMarkerPoint(a),c?this.gl3dview.getSelectionContainer().contains(c)||this.gl3dview.getSelectionContainer().setSelection(c):this.gl3dview.getSelectionContainer().clearSelection(),Cc.handleClicked(this.gl3dview,a,c),this._endTouchTime&&this._startTouchTime.getTime()-this._endTouchTime.getTime()<=500&&Tb.getDistance(this._endTouchClient,this._startTouchClient)<=20?(delete this._endTouchTime,delete this._endTouchClient,Cc.handleDoubleClicked(this.gl3dview,a,c)):(this._endTouchTime=this._startTouchTime,this._endTouchClient=this._startTouchClient)}else this._distance=zc.getDistance(a),this._zoom=this.gl3dview.getZoom()},handleTouchmove:function(a){if(Wb.preventDefault(a),a.touches.length>1){var b=zc.getDistance(a);if(Math.abs(b-this._distance)<20)return;var c=b/this._distance;this.gl3dview.setZoom(this._zoom*c,!1)}else if(null==this._zoom){var d=this.getMarkerPoint(a);if(Tb.getDistance(this._startTouchClient,d)<20)return;if(this._element){var e=this.gl3dview.getLogicalPoint2(a),f=e.x-this._currentTouchPoint.x,g=e.y-this._currentTouchPoint.y;this._currentTouchPoint=e,this.gl3dview.moveSelectedElements(f,g),this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}))}else{var f=this._currentTouchClient.x-d.x,g=this._currentTouchClient.y-d.y;this.gl3dview.panByOffset(f,g),this._currentTouchClient=d}}},handleTouchend:function(a){Wb.preventDefault(a),this.gl3dview.isMovingElement()&&(this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a})),0===a.touches.length&&(this._distance=null,this._zoom=null,this._element=null,this._startTouchTime=null,this._currentTouchPoint=null,this._startTouchClient=this._currentTouchClient=null)}}),Ib.vector.interaction.MSTouchInteraction=function(a){Ib.vector.interaction.MSTouchInteraction.superClass.constructor.call(this,a),this._pointerMap={},this._pointerIdArray=[]},Jb.ext("twaver.vector.interaction.MSTouchInteraction",Ib.vector.interaction.BaseInteraction,{setUp:function(){var a=this.gl3dview.getView();Wb.addEventListener("MSPointerDown","handleTouchstart",a,this),Wb.addEventListener("MSPointerMove","handleTouchmove",a,this),Wb.addEventListener("MSPointerUp","handleTouchend",a,this),Wb.addEventListener("MSPointerCancel","handleTouchend",a,this),this.gl3dview.addMarker(this)},tearDown:function(){var a=this.gl3dview.getView();Wb.removeEventListener("MSPointerDown",a,this),Wb.removeEventListener("MSPointerMove",a,this),Wb.removeEventListener("MSPointerUp",a,this),Wb.removeEventListener("MSPointerCancel",a,this),this.gl3dview.removeMarker(this)},handleTouchstart:function(a){if(this.gl3dview.isFocusOnClick()&&Ib.Util.setFocus(this.gl3dview._view),!this.gl3dview.isSelectingElement()||a.pointerType!=a.MSPOINTER_TYPE_MOUSE){var b=this.gl3dview.getLogicalPoint2(a),c=new Date;if(a.isPrimary&&this._pointerIdArray.length>0&&this.handle_mouseup(a),this._pointerMap[a.pointerId]||(this._pointerIdArray.push(a.pointerId),this._pointerMap[a.pointerId]=a),1==this._pointerIdArray.length){var d=this.gl3dview.getElementAt(b);this._startTouchElement=d,this._startClientPoint={x:a.clientX,y:a.clientY};var e=this.gl3dview.getSelectionContainer();d?Jb.isCtrlDown(a)?e.contains(d)?e.removeSelection(d):e.appendSelection(d):e.contains(d)||e.setSelection(d):Jb.isCtrlDown(a)||e.clearSelection(),Cc.handleClicked(this.gl3dview,a,d),this._startTouchTime&&this._startTouchPoint&&c.getTime()-this._startTouchTime.getTime()<=500&&Tb.getDistance(this._startTouchPoint,b)<=20?(Cc.handleDoubleClicked(this.gl3dview,a,d),this._doubleClick=!0):(Wb.handle_mousedown(this,a),this._startTouchPoint=b,this._startTouchTime=c)}else 2==this._pointerIdArray.length&&(this._distance=this._getDistance(),this._zoom=this.gl3dview.getZoom())}},handleTouchmove:function(a){if(null!=this._startTouchPoint&&0!=this._pointerIdArray.length&&this._pointerMap[a.pointerId]&&!(Tb.getDistance({x:this._pointerMap[a.pointerId].pageX,y:this._pointerMap[a.pointerId].pageY},{x:a.pageX,y:a.pageY})<=10)&&(this._pointerMap[a.pointerId]=a,2==this._pointerIdArray.length)){var b=this._getDistance()/this._distance;this.gl3dview.setZoom(this._zoom*b,!1)}},handleTouchend:function(a){if(this.gl3dview.isMovingElement()&&(this.gl3dview.setMovingElement(!1),this.gl3dview.fireInteractionEvent({kind:"liveMoveEnd",event:a})),this.gl3dview.isSelectingElement()){var b=Tb.getRect([this._startTouchPoint,this._moveTouchPoint]),c=this.gl3dview.getElementsAtRect(b,this.getIntersectMode(),this.gl3dview.getRectSelectFilter());if(c&&c.size()>0){var d=this.gl3dview.getSelectionContainer(),e=d.toSelection();c.forEach(function(a){d.contains(a)?e.remove(a):e.add(a)},this),d.setSelection(e)}this.gl3dview.fireInteractionEvent({kind:"selectEnd",event:a}),this._moveTouchPoint=null,this.gl3dview.setSelectingElement(!1),this.repaint()}this._doubleClick&&(delete this._doubleClick,delete this._startTouchPoint,delete this._startTouchTime);for(var f=-1,g=0;g<this._pointerIdArray.length;g++)if(this._pointerIdArray[g]==a.pointerId){f=g;break}f>=0&&this._pointerIdArray.splice(f,1),delete this._pointerMap[a.pointerId],this._moveTouchPoint=null},_getDistance:function(){return Tb.getDistance({x:this._pointerMap[this._pointerIdArray[0]].pageX,y:this._pointerMap[this._pointerIdArray[0]].pageY},{x:this._pointerMap[this._pointerIdArray[1]].pageX,y:this._pointerMap[this._pointerIdArray[1]].pageY})},getIntersectMode:function(){return"intersect"===this.gl3dview.getSelectMode()?!0:"contain"===this.gl3dview.getSelectMode()?!1:this._startTouchPoint.x>this._moveTouchPoint.x&&this._startTouchPoint.y>this._moveTouchPoint.y},handle_mousemove:function(a){var b={x:a.clientX,y:a.clientY};if(!(Tb.getDistance(this._startClientPoint,b)<3)&&this._startTouchPoint&&1==this._pointerIdArray.length)if(this._moveTouchPoint={x:this._startTouchPoint.x+(b.x-this._startClientPoint.x)/this.gl3dview.getZoom(),y:this._startTouchPoint.y+(b.y-this._startClientPoint.y)/this.gl3dview.getZoom()},null==this._startTouchElement&&this.gl3dview.isRectSelectEnabled()){var c=this.gl3dview.getLogicalPoint2(a);if(!c)return;this.gl3dview.setSelectingElement(!0),this.gl3dview.fireInteractionEvent(this._moveTouchPoint?{kind:"selectBetween",event:a}:{kind:"selectStart",event:a}),this.repaint()}else{var d=this.gl3dview.getElementAt(this._moveTouchPoint);if(null!=this._startTouchElement||this.gl3dview.isRectSelectEnabled()){if(this.gl3dview.isMovingElement()||null!=this._startTouchElement&&d==this._startTouchElement&&this.gl3dview.getMovableSelectedElements().contains(d)){var e=this._moveTouchPoint.x-this._startTouchPoint.x,f=this._moveTouchPoint.y-this._startTouchPoint.y;this.gl3dview.moveSelectedElements(e,f),this.gl3dview.isMovingElement()?this.gl3dview.fireInteractionEvent({kind:"liveMoveBetween",event:a}):(this.gl3dview.setMovingElement(!0),this.gl3dview.fireInteractionEvent({kind:"liveMoveStart",event:a}))}}else{var e=this._startClientPoint.x-b.x,f=this._startClientPoint.y-b.y;this.gl3dview.panByOffset(e,f)}this._startClientPoint=b}},handle_mouseup:function(a){this.handleTouchend(a),this._pointerIdArray=[],this._pointerMap={}},paint:function(a){if(this._startTouchPoint&&this._moveTouchPoint&&!this._startTouchElement&&this.gl3dview.isRectSelectEnabled()){var b=this.convertPointFromView(this._startTouchPoint),c=this.convertPointFromView(this._moveTouchPoint),d=b.x,e=b.y,f=c.x,g=c.y,h=Tb.getRect([{x:d,y:e},{x:f,y:g}]);if(null!=h){a.beginPath();var i=this.gl3dview.getSelectOutlineWidth(),j=this.getIntersectMode()?this.gl3dview.getSelectFillColor():null;a.strokeStyle=this.gl3dview.getSelectOutlineColor(),a.lineWidth=i,Md.rect(a,h.x,h.y,h.width,h.height,j,this.gl3dview.getSelectOutlineColor()),a.closePath()}}}}),Ib.XmlSerializer=function(a,b,c){this.dataBox=a,this.settings=b?b:new Ib.SerializationSettings,this.filterFunction=c,this.ref=0,this.refMap={},this.idMap={},this.xmlString=""},Jb.ext("twaver.XmlSerializer",Object,{serialize:function(){return this.xmlString="<twaver version='"+Ib.Util.getVersion()+"' platform='html5'>\n",this.serializeBody(),this.xmlString+="</twaver>\n",this.xmlString},serializeBody:function(){this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isServaSerializable&&(this.xmlString+="<dataBox class='"+this.dataBox.getClassName()+"'>\n",this.dataBox.serializeXml(this,this.dataBox.newInstance()),this.xmlString+="</dataBox>\n"),this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(a){this.refMap[a.getId()]=this.ref++,a.getChildren().forEach(this.initRefs,this)},isSerializable:function(a){return this.dataBox.contains(a)?this.filterFunction&&!this.filterFunction(a)?!1:!0:!1},serializeData:function(a){if(this.isSerializable(a)){var b=a.newInstance(),c=this.refMap[a.getId()];this.xmlString+="<data class='"+a.getClassName()+"' ref='"+c+"'",null!=this.settings.getPropertyType("id")&&(this.xmlString+=" id='"+a.getId()+"'"),this.xmlString+=">\n",a.serializeXml(this,b),this.xmlString+="</data>\n"}a.getChildren().forEach(this.serializeData,this)},serializePropertyXml:function(a,b,c){var d=this.settings.getPropertyType(b);if(d){var e=Jb.getValue(a,b,d),f=Jb.getValue(c,b,d);e!==f&&this.serializeValue("p",b,e,f,d)}},serializeStyleXml:function(a,b,c){var d=this.settings.getStyleType(b);if(d){var e=a.getStyle(b),f=c.getStyle(b);e!=f&&this.serializeValue("s",b,e,f,d)}},serializeClientXml:function(a,b,c){var d=this.settings.getClientType(b);if(null!=d){var e=a.getClient(b),f=c.getClient(b);e!=f&&this.serializeValue("c",b,e,f,d)}},serializeValue:function(a,b,c,d,e){if(null==c)this.xmlString+="	<"+a+" n='"+b+"' none=''/>\n";else if("cdata"===e)this.xmlString+="	<"+a+" n='"+b+"'><![CDATA["+c+"]]></"+a+">\n";else if("data"===e){var f=this.refMap[c.getId()];null!=f&&(this.xmlString+="	<"+a+" n='"+b+"' ref='"+f+"'/>\n")}else"point"===e?d&&c.x===d.x&&c.y===d.y||(this.xmlString+="	<"+a+" n='"+b+"' x='"+c.x+"' y='"+c.y+"'/>\n"):"list.point"===e?(this.xmlString+="	<"+a+" n='"+b+"'>\n",
c.forEach(function(a){this.xmlString+="		<p x='"+a.x+"' y='"+a.y+"'/>\n"},this),this.xmlString+="	</"+a+">\n"):"list.string"===e||"list.number"===e?(this.xmlString+="	<"+a+" n='"+b+"'>\n",c.forEach(function(a){this.xmlString+="		<s>"+a+"</s>\n"},this),this.xmlString+="	</"+a+">\n"):this.xmlString+="rectangle"===e?"	<"+a+" n='"+b+"' x='"+c.x+"' y='"+c.y+"' w='"+c.width+"' h='"+c.height+"'/>\n":"	<"+a+" n='"+b+"'>"+c+"</"+a+">\n"},deserialize:function(a,b){Jb.isDeserializing=!0,this.xmlString=a;var c=Jb.xml(a).documentElement;this.refMap={},this.idMap={};var d,e,f,g=new md,h=new md,i=c.getElementsByTagName("data"),j=i.length;for(f=0;j>f;f++){e=i[f];var k=e.getAttribute("class"),l=this.settings.getPropertyType("id");if(l&&e.hasAttribute("id")){var m=null;if("string"===l)m=e.getAttribute("id");else if("int"===l)m=parseInt(e.getAttribute("id"));else{if("number"!==l)throw"Unsupported id type '"+l+"'";m=parseFloat(e.getAttribute("id"))}if("remove"===e.getAttribute("action")){this.dataBox.removeById(m);continue}d=this.dataBox.getDataById(m),d||(d=Jb.newInstance(k,m))}else d=Jb.newInstance(k);if(e.hasAttribute("ref")){var n=e.getAttribute("ref");this.refMap[n]=d}g.add(d),h.add(e),this.idMap[d.getId()]=d}for(this.dataBox.forEach(function(a){this.idMap[a.getId()]=a},this),j=g.size(),f=0;j>f;f++)d=g.get(f),e=h.get(f),d.deserializeXml(this,e);for(f=0;j>f;f++)d=g.get(f),this.dataBox.containsById(d.getId())||(b&&!d.getParent()&&d.setParent(b),this.dataBox.add(d));this.settings.isServaSerializable&&1===c.getElementsByTagName("dataBox").length&&this.dataBox.deserializeXml(this,c.getElementsByTagName("dataBox")[0]),Jb.isDeserializing=!1},deserializePropertyXml:function(a,b,c){var d=this.settings.getPropertyType(c);d&&Jb.setValue(a,c,this.deserializeValue(b,d))},deserializeStyleXml:function(a,b,c){var d=this.settings.getStyleType(c);d&&a.setStyle(c,this.deserializeValue(b,d))},deserializeClientXml:function(a,b,c){var d=this.settings.getClientType(c);d&&a.setClient(c,this.deserializeValue(b,d))},deserializeValue:function(a,b){if(a.hasAttribute("@none"))return null;if("string"===b)return a.textContent;if("number"===b)return parseFloat(a.textContent);if("boolean"===b)return"true"===a.textContent;if("int"===b)return parseInt(a.textContent);if("point"===b)return{x:parseFloat(a.getAttribute("x")),y:parseFloat(a.getAttribute("y"))};if("data"===b){var c=a.getAttribute("ref"),d=this.refMap[c];return d?d:this.idMap[c]}var e,f,g,h;if("list.point"===b){var i=new md,j=a.getElementsByTagName("p");for(e=j.length,h=0;e>h;h++){var k=j[h];i.add({x:parseFloat(k.getAttribute("x")),y:parseFloat(k.getAttribute("y"))})}return i}if("list.string"===b){var l=new md;for(g=a.getElementsByTagName("s"),e=g.length,h=0;e>h;h++)l.add(g[h].textContent);return l}if("list.number"===b){for(f=new md,g=a.getElementsByTagName("s"),e=g.length,h=0;e>h;h++)f.add(parseFloat(g[h].textContent));return f}if("array.string"===b)return a.textContent.split(",");if("array.number"===b){for(f=a.textContent.split(","),e=f.length,h=0;e>h;h++)f[h]=parseFloat(f[h]);return f}return"rectangle"===b?{x:parseFloat(a.getAttribute("x")),y:parseFloat(a.getAttribute("y")),width:parseFloat(a.getAttribute("w")),height:parseFloat(a.getAttribute("h"))}:a.textContent}}),Jb.addMethod(Ib.Data,{serializeXml:function(a,b){if(a.settings.isClientSerializable&&this._clientMap)for(var c in this._clientMap)this.serializeClientXml(a,c,b);this.serializePropertyXml(a,"name",b),this.serializePropertyXml(a,"icon",b),this.serializePropertyXml(a,"toolTip",b),this.serializePropertyXml(a,"parent",b)},serializePropertyXml:function(a,b,c){a.serializePropertyXml(this,b,c)},serializeClientXml:function(a,b,c){a.serializeClientXml(this,b,c)},deserializeXml:function(a,b){var c,d,e,f,g=b.getElementsByTagName("p"),h=g.length;for(c=0;h>c;c++)d=g[c],d.hasAttribute("n")&&this.deserializePropertyXml(a,d,d.getAttribute("n"));if(a.settings.isClientSerializable)for(e=b.getElementsByTagName("c"),h=e.length,c=0;h>c;c++)f=e[c],f.hasAttribute("n")&&this.deserializeClientXml(a,f,f.getAttribute("n"))},deserializePropertyXml:function(a,b,c){a.deserializePropertyXml(this,b,c)},deserializeClientXml:function(a,b,c){a.deserializeClientXml(this,b,c)}}),Jb.addMethod(Ib.Element,{serializeXml:function(a,b){if(a.settings.isStyleSerializable&&this._styleMap)for(var c in this._styleMap)this.serializeStyleXml(a,c,b);Ib.Element.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"layerId",b),this._alarmState.getHighestNativeAlarmSeverity()&&"alarmstate"===a.settings.getPropertyType("alarmState")&&(a.xmlString+="	<p n='alarmState'>\n",Ib.AlarmSeverity.forEach(function(b){var c=this.getNewAlarmCount(b);c>0&&(a.xmlString+="		<n n='"+b.name+"' c='"+c+"'/>\n")},this._alarmState),Ib.AlarmSeverity.forEach(function(b){var c=this.getAcknowledgedAlarmCount(b);c>0&&(a.xmlString+="		<a n='"+b.name+"' c='"+c+"'/>\n")},this._alarmState),a.xmlString+="	</p>\n")},serializeStyleXml:function(a,b,c){a.serializeStyleXml(this,b,c)},deserializeXml:function(a,b){if(Ib.Element.superClass.deserializeXml.call(this,a,b),a.settings.isStyleSerializable){var c,d,e=b.getElementsByTagName("s"),f=e.length;for(c=0;f>c;c++)d=e[c],d.hasAttribute("n")&&this.deserializeStyleXml(a,d,d.getAttribute("n"))}},deserializeStyleXml:function(a,b,c){a.deserializeStyleXml(this,b,c)},deserializePropertyXml:function(a,b,c){if("alarmState"===c){if("alarmstate"===a.settings.getPropertyType("alarmState")){var d,e,f,g=b.getElementsByTagName("n");for(e=0;e<g.length;e++)f=g[e],d=Ib.AlarmSeverity.getByName(f.getAttribute("n")),this._alarmState.setNewAlarmCount(d,parseInt(f.getAttribute("c")));for(g=b.getElementsByTagName("a"),e=0;e<g.length;e++)f=g[e],d=Ib.AlarmSeverity.getByName(f.getAttribute("n")),this._alarmState.setAcknowledgedAlarmCount(d,parseInt(f.getAttribute("c")))}}else Ib.Element.superClass.deserializePropertyXml.call(this,a,b,c)}}),Jb.addMethod(Jd,{serializeXml:function(a,b){Jd.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"image",b),this.serializePropertyXml(a,"location",b),Jb.num(this._width)&&this._width>=0&&this.serializePropertyXml(a,"width",b),Jb.num(this._height)&&this._height>=0&&this.serializePropertyXml(a,"height",b)}}),Jb.addMethod(Ib.Link,{serializeXml:function(a,b){Ib.Link.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"fromNode",b),this.serializePropertyXml(a,"toNode",b)}}),Jb.addMethod(Ib.Follower,{serializeXml:function(a,b){Ib.Follower.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"host",b)}}),Jb.addMethod(Ld,{serializeXml:function(a,b){Ld.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"expanded",b)}}),Jb.addMethod(Ib.ShapeNode,{serializeXml:function(a,b){Ib.ShapeNode.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"points",b),this.serializePropertyXml(a,"segments",b)}}),Jb.addMethod(Ib.ShapeLink,{serializeXml:function(a,b){Ib.ShapeLink.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"points",b)}}),Jb.addMethod(Ib.RotatableNode,{serializeXml:function(a,b){Ib.RotatableNode.superClass.serializeXml.call(this,a,b),this.serializePropertyXml(a,"angle",b)}}),Jb.addMethod(Ib.Serva,{serializeXml:function(a,b){if(a.settings.isClientSerializable&&this._clientMap)for(var c in this._clientMap)this.serializeClientXml(a,c,b);this.serializePropertyXml(a,"name",b),this.serializePropertyXml(a,"icon",b),this.serializePropertyXml(a,"toolTip",b)},serializePropertyXml:function(a,b,c){a.serializePropertyXml(this,b,c)},serializeClientXml:function(a,b,c){a.serializeClientXml(this,b,c)},deserializeXml:function(a,b){var c,d,e,f,g=b.getElementsByTagName("p"),h=g.length;for(c=0;h>c;c++)d=g[c],d.hasAttribute("n")&&this.deserializePropertyXml(a,d,d.getAttribute("n"));if(a.settings.isClientSerializable)for(e=b.getElementsByTagName("c"),h=e.length,c=0;h>c;c++)f=e[c],f.hasAttribute("n")&&this.deserializeClientXml(a,f,f.getAttribute("n"))},deserializePropertyXml:function(a,b,c){a.deserializePropertyXml(this,b,c)},deserializeClientXml:function(a,b,c){a.deserializeClientXml(this,b,c)}}),Jb.addMethod(Ib.ElementBox,{serializeXml:function(a,b){if(a.settings.isLayerBoxSerializable&&(a.xmlString+="	<layerBox>\n",this._layerBox.forEachByDepthFirst(function(b){a.xmlString+=this._layerBox.getDefaultLayer()===b?"		<layer ":"		<layer id='"+b.getId()+"' ",b.getName()&&(a.xmlString+="name='"+b.getName()+"' "),a.xmlString+="visible='"+b.isVisible()+"' editable='"+b.isEditable()+"' movable='"+b.isMovable()+"'/>\n"},null,this),a.xmlString+="	</layerBox>\n"),a.settings.isStyleSerializable&&this._styleMap)for(var c in this._styleMap)this.serializeStyleXml(a,c,b);Ib.ElementBox.superClass.serializeXml.call(this,a,b)},serializeStyleXml:function(a,b,c){a.serializeStyleXml(this,b,c)},deserializeStyleXml:function(a,b,c){a.deserializeStyleXml(this,b,c)},deserializeXml:function(a,b){if(Ib.ElementBox.superClass.deserializeXml.call(this,a,b),a.settings.isLayerBoxSerializable&&1==b.getElementsByTagName("layerBox").length)for(var c=b.getElementsByTagName("layerBox")[0].getElementsByTagName("layer"),d=0;d<c.length;d++){var e,f=c[d];if(f.hasAttribute("id")){var g=a.settings.getPropertyType("layerId");if("string"===g)e=new Ib.Layer(f.getAttribute("id"));else if("int"===g)e=new Ib.Layer(parseInt(f.getAttribute("id")));else{if("number"!==g)throw"Unsupported layer id type '"+g+"'";e=new Ib.Layer(parseFloat(f.getAttribute("id")))}this._layerBox.getDataById(e.getId())?e=this._layerBox.getDataById(e.getId()):this._layerBox.add(e)}else e=this._layerBox.getDefaultLayer();f.hasAttribute("name")&&e.setName(f.getAttribute("name")),f.hasAttribute("visible")&&e.setVisible("true"===f.getAttribute("visible")),f.hasAttribute("editable")&&e.setEditable("true"===f.getAttribute("editable")),f.hasAttribute("movable")&&e.setMovable("true"===f.getAttribute("movable"))}if(a.settings.isStyleSerializable)for(var h=b.getElementsByTagName("s"),i=h.length,d=0;i>d;d++){var j=h[d];j.hasAttribute("n")&&this.deserializeStyleXml(a,j,j.getAttribute("n"))}}}),Ib.JsonSerializer=function(a,b,c){this.dataBox=a,this.settings=b?b:new Ib.SerializationSettings,this.filterFunction=c,this.ref=0,this.refMap={},this.idMap={},this.jsonObject={}},Jb.ext("twaver.JsonSerializer",Object,{serialize:function(){return this.jsonObject={version:Ib.Util.getVersion(),platform:"html5"},this.settings.isImageSerializable&&(this.jsonObject.images={}),this.serializeBody(),JSON.stringify(this.jsonObject)},serializeBody:function(){if(this.ref=0,this.dataBox.getRoots().forEach(this.initRefs,this),this.settings.isServaSerializable){var a={"class":this.dataBox.getClassName(),p:{},s:{},c:{}};this.jsonObject.dataBox=a,this.dataBox.serializeJson(this,this.dataBox.newInstance(),a),Jb.isEmptyObject(a.p)&&delete a.p,Jb.isEmptyObject(a.s)&&delete a.s,Jb.isEmptyObject(a.c)&&delete a.c}this.jsonObject.datas=[],this.dataBox.getRoots().forEach(this.serializeData,this)},initRefs:function(a){this.refMap[a.getId()]=this.ref++,a.getChildren().forEach(this.initRefs,this)},isSerializable:function(a){return this.dataBox.contains(a)?this.filterFunction&&!this.filterFunction(a)?!1:!0:!1},serializeData:function(a){if(this.isSerializable(a)){var b=a.newInstance(),c=this.refMap[a.getId()],d={"class":a.getClassName(),ref:c,p:{},s:{},c:{}};if(this.settings.getPropertyType("id")&&(this.jsonObject.id=a.getId()),this.jsonObject.datas.push(d),a.serializeJson(this,b,d),Jb.isEmptyObject(d.p)&&delete d.p,Jb.isEmptyObject(d.s)&&delete d.s,Jb.isEmptyObject(d.c)&&delete d.c,this.settings.isImageSerializable&&a.getImage){var e=a.getImage();if("string"==typeof e&&!Od[e]&&!this.jsonObject.images[e]){var f=Jb.getImageAsset(e),g=f&&f.getImage();g&&!cd(g)&&(this.jsonObject.images[e]=g)}}}a.getChildren().forEach(this.serializeData,this)},serializePropertyJson:function(a,b,c,d){var e=this.settings.getPropertyType(b);if(e){var f=Jb.getValue(a,b,e),g=Jb.getValue(c,b,e);f!==g&&this.serializeValue(b,f,g,e,d.p)}},serializeStyleJson:function(a,b,c,d){var e=this.settings.getStyleType(b);if(e){var f=a.getStyle(b),g=c.getStyle(b);f!=g&&this.serializeValue(b,f,g,e,d.s)}},serializeClientJson:function(a,b,c,d){var e=this.settings.getClientType(b);if(null!=e){var f=a.getClient(b),g=c.getClient(b);f!=g&&this.serializeValue(b,f,g,e,d.c)}},serializeValue:function(a,b,c,d,e){if(null==b)e[a]=null;else if(b instanceof md)e[a]=b._as;else if("data"===d){var f=this.refMap[b.getId()];null!=f&&(e[a]=f)}else e[a]=b},deserialize:function(a,b){Jb.isDeserializing=!0,this.jsonObject=JSON.parse(a);var c=this.jsonObject.images;this.settings.isImageSerializable&&c&&Object.keys(c).forEach(function(a){Jb.registerImage(a,c[a])}),this.refMap={},this.idMap={};for(var d,e=new md,f=new md,g=this.jsonObject.datas.length,h=0;g>h;h++){var i=this.jsonObject.datas[h],j=i["class"],k=this.settings.getPropertyType("id");if(k&&null!=i.id){if("remove"===i.action){this.dataBox.removeById(i.id);continue}d=this.dataBox.getDataById(i.id),d||(d=Jb.newInstance(j,i.id))}else d=Jb.newInstance(j);null!=i.ref&&(this.refMap[i.ref]=d),e.add(d),f.add(i),this.idMap[d.getId()]=d}for(this.dataBox.forEach(function(a){this.idMap[a.getId()]=a},this),g=e.size(),h=0;g>h;h++)d=e.get(h),d.deserializeJson(this,f.get(h));for(h=0;g>h;h++)d=e.get(h),this.dataBox.containsById(d.getId())||(b&&!d.getParent()&&d.setParent(b),this.dataBox.add(d));this.settings.isServaSerializable&&this.jsonObject.dataBox&&this.dataBox.deserializeJson(this,this.jsonObject.dataBox),Jb.isDeserializing=!1},deserializePropertyJson:function(a,b,c){var d=this.settings.getPropertyType(c);d&&Jb.setValue(a,c,this.deserializeValue(b,d))},deserializeStyleJson:function(a,b,c){var d=this.settings.getStyleType(c);d&&a.setStyle(c,this.deserializeValue(b,d))},deserializeClientJson:function(a,b,c){var d=this.settings.getClientType(c);d&&a.setClient(c,this.deserializeValue(b,d))},deserializeValue:function(a,b){if("data"===b){var c=this.refMap[a];return c?c:this.idMap[a]}return"array.number"===b?a:a instanceof Array?new md(a):a}}),Jb.addMethod(Ib.Data,{serializeJson:function(a,b,c){if(a.settings.isClientSerializable&&this._clientMap)for(var d in this._clientMap)this.serializeClientJson(a,d,b,c);this.serializePropertyJson(a,"name",b,c),this.serializePropertyJson(a,"icon",b,c),this.serializePropertyJson(a,"toolTip",b,c),this.serializePropertyJson(a,"parent",b,c)},serializePropertyJson:function(a,b,c,d){a.serializePropertyJson(this,b,c,d)},serializeClientJson:function(a,b,c,d){a.serializeClientJson(this,b,c,d)},deserializeJson:function(a,b){var c;for(c in b.p)this.deserializePropertyJson(a,b.p[c],c);if(a.settings.isClientSerializable)for(c in b.c)this.deserializeClientJson(a,b.c[c],c)},deserializePropertyJson:function(a,b,c){a.deserializePropertyJson(this,b,c)},deserializeClientJson:function(a,b,c){a.deserializeClientJson(this,b,c)}}),Jb.addMethod(Ib.Element,{serializeJson:function(a,b,c){if(a.settings.isStyleSerializable&&this._styleMap)for(var d in this._styleMap)this.serializeStyleJson(a,d,b,c);if(Ib.Element.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"layerId",b,c),this._alarmState.getHighestNativeAlarmSeverity()&&"alarmstate"===a.settings.getPropertyType("alarmState")){var e={n:{},a:{}};c.p.alarmState=e,Ib.AlarmSeverity.forEach(function(a){var b=this.getNewAlarmCount(a);b>0&&(e.n[a.name]=b)},this._alarmState),Ib.AlarmSeverity.forEach(function(a){var b=this.getAcknowledgedAlarmCount(a);b>0&&(e.a[a.name]=b)},this._alarmState),Jb.isEmptyObject(e.n)&&delete e.n,Jb.isEmptyObject(e.a)&&delete e.a,Jb.isEmptyObject(e)&&delete c.p.alarmState}},serializeStyleJson:function(a,b,c,d){a.serializeStyleJson(this,b,c,d)},deserializeJson:function(a,b){if(Ib.Element.superClass.deserializeJson.call(this,a,b),a.settings.isStyleSerializable)for(var c in b.s)this.deserializeStyleJson(a,b.s[c],c)},deserializeStyleJson:function(a,b,c){a.deserializeStyleJson(this,b,c)},deserializePropertyJson:function(a,b,c){if("alarmState"===c){if("alarmstate"===a.settings.getPropertyType("alarmState")){var d;for(d in b.n)this._alarmState.setNewAlarmCount(Ib.AlarmSeverity.getByName(d),b.n[d]);for(d in b.a)this._alarmState.setAcknowledgedAlarmCount(Ib.AlarmSeverity.getByName(d),b.a[d])}}else Ib.Element.superClass.deserializePropertyJson.call(this,a,b,c)}}),Jb.addMethod(Jd,{serializeJson:function(a,b,c){Jd.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"image",b,c),this.serializePropertyJson(a,"location",b,c),Jb.num(this._width)&&this._width>=0&&this.serializePropertyJson(a,"width",b,c),Jb.num(this._height)&&this._height>=0&&this.serializePropertyJson(a,"height",b,c)}}),Jb.addMethod(Ib.Link,{serializeJson:function(a,b,c){Ib.Link.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"fromNode",b,c),this.serializePropertyJson(a,"toNode",b,c)}}),Jb.addMethod(Ib.Follower,{serializeJson:function(a,b,c){Ib.Follower.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"host",b,c)}}),Jb.addMethod(Ld,{serializeJson:function(a,b,c){Ld.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"expanded",b,c)}}),Jb.addMethod(Ib.ShapeNode,{serializeJson:function(a,b,c){Ib.ShapeNode.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"points",b,c),this.serializePropertyJson(a,"segments",b,c)}}),Jb.addMethod(Ib.ShapeLink,{serializeJson:function(a,b,c){Ib.ShapeLink.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"points",b,c)}}),Jb.addMethod(Ib.RotatableNode,{serializeJson:function(a,b,c){Ib.RotatableNode.superClass.serializeJson.call(this,a,b,c),this.serializePropertyJson(a,"angle",b,c)}}),Jb.addMethod(Ib.Serva,{serializeJson:function(a,b,c){if(a.settings.isClientSerializable&&this._clientMap)for(var d in this._clientMap)this.serializeClientJson(a,d,b,c);this.serializePropertyJson(a,"name",b,c),this.serializePropertyJson(a,"icon",b,c),this.serializePropertyJson(a,"toolTip",b,c)},serializePropertyJson:function(a,b,c,d){a.serializePropertyJson(this,b,c,d)},serializeClientJson:function(a,b,c,d){a.serializeClientJson(this,b,c,d)},deserializeJson:function(a,b){var c;for(c in b.p)this.deserializePropertyJson(a,b.p[c],c);if(a.settings.isClientSerializable)for(c in b.c)this.deserializeClientJson(a,b.c[c],c)},deserializePropertyJson:function(a,b,c){a.deserializePropertyJson(this,b,c)},deserializeClientJson:function(a,b,c){a.deserializeClientJson(this,b,c)}}),Jb.addMethod(Ib.ElementBox,{serializeJson:function(a,b,c){if(a.settings.isLayerBoxSerializable&&(c.layers=[],this._layerBox.forEachByDepthFirst(function(a){var b={};c.layers.push(b),this._layerBox.getDefaultLayer()!==a&&(b.id=a.getId()),a.getName()&&(b.name=a.getName()),b.visible=a.isVisible(),b.editable=a.isEditable(),b.movable=a.isMovable()},null,this)),a.settings.isStyleSerializable&&this._styleMap)for(var d in this._styleMap)this.serializeStyleJson(a,d,b,c);Ib.ElementBox.superClass.serializeJson.call(this,a,b,c)},serializeStyleJson:function(a,b,c,d){a.serializeStyleJson(this,b,c,d)},deserializeStyleJson:function(a,b,c){a.deserializeStyleJson(this,b,c)},deserializeJson:function(a,b){if(Ib.ElementBox.superClass.deserializeJson.call(this,a,b),a.settings.isLayerBoxSerializable&&b.layers&&b.layers)for(var c=b.layers.length,d=0;c>d;d++){var e,f=b.layers[d];null!=f.id?(e=new Ib.Layer(f.id),this._layerBox.getDataById(e.getId())?e=this._layerBox.getDataById(e.getId()):this._layerBox.add(e)):e=this._layerBox.getDefaultLayer(),f.name&&e.setName(f.name),null!=f.visible&&e.setVisible(f.visible),null!=f.editable&&e.setEditable(f.editable),null!=f.movable&&e.setMovable(f.movable)}if(a.settings.isStyleSerializable)for(var g in b.s)this.deserializeStyleJson(a,b.s[g],g)}}),Ib.layout.SpringLayouter=function(a){this._gl3dview=a,this._damper=1,this._maxMotion=0,this._motionRatio=0,this._isAdjusting=!1,this._timer=null,this._snodeMap={},this._snodes=new md,this._slinks=new md,this._gl3dview.getElementBox().addServaChangeListener(this._handleServaChange,this),this._gl3dview.getElementBox().addDataPropertyChangeListener(this._handleDataPropertyChange,this),this._gl3dview.addPropertyChangeListener(this._handleGl3dviewPropertyChange,this)},Jb.ext("twaver.layout.SpringLayouter",Object,{_nodeRepulsionFactor:.6,_linkRepulsionFactor:.6,_limitBounds:null,_interval:50,_stepCount:10,_motionLimit:.01,start:function(){if(!this._timer){var b=this,c=function(){b.relax.call(b)};this._timer=a.setInterval(c,this._interval),this._damper=1}},stop:function(){this._timer&&(a.clearInterval(this._timer),this._timer=null)},relax:function(){if(!(this._damper<.1&&this._maxMotion<this._motionLimit)){this._rebuild();for(var a=this._snodes.size(),b=0;b<this._stepCount;b++){this._slinks.forEach(this._relaxLink,this);for(var c=0;a>c;c++)for(var d=0;a>d;d++){var e=this._snodes.get(c),f=this._snodes.get(d);e!=f&&this._relaxNodePair(e,f)}this._moveNodes()}this._isAdjusting=!0;for(var b=0;a>b;b++){var g=this._snodes.get(b);g.fix||g.element.setLocation(g.x,g.y)}this._isAdjusting=!1}},isRunning:function(){return!!this._timer},getGl3dview:function(){return this._gl3dview},isVisible:function(a){return this._gl3dview.isVisible(a)},isMovable:function(a){return this._gl3dview.isMovable(a)?this._gl3dview.getSelectionContainer().contains(a)?!1:a instanceof Ld?!1:!0:!1},getNodeRepulsionFactor:function(){return this._nodeRepulsionFactor},setNodeRepulsionFactor:function(a){.02>a&&(a=.02),this._nodeRepulsionFactor=a,this._damper=1},getLinkRepulsionFactor:function(){return this._linkRepulsionFactor},setLinkRepulsionFactor:function(a){.02>a&&(a=.02),this._linkRepulsionFactor=a,this._damper=1},getStepCount:function(){return this._stepCount},setStepCount:function(a){this._stepCount=a,this._damper=1},getInterval:function(){return this._interval},setInterval:function(b){if(this._interval!==b&&(this._interval=b,this._timer)){a.clearInterval(this._timer);var c=this,d=function(){c.relax.call(c)};this._timer=a.setInterval(d,this._interval)}},getLimitBounds:function(){return this._limitBounds},setLimitBounds:function(a){this._limitBounds=a,this._damper=1},_handleDataPropertyChange:function(a){this._isAdjusting||(this._damper=1)},_handleServaChange:function(a){this._damper=0===this._gl3dview.getElementBox().size()?0:1},_handleGl3dviewPropertyChange:function(a){if("elementBox"===a.property){var b=a.oldValue;null!=b&&(b.removeServaChangeListener(this._handleServaChange,this),b.removeDataPropertyChangeListener(this._handleDataPropertyChange,this)),this._gl3dview.getElementBox().addServaChangeListener(this._handleServaChange,this),this._gl3dview.getElementBox().addDataPropertyChangeListener(this._handleDataPropertyChange,this)}},_relaxLink:function(a){var b=a.toNode.x-a.fromNode.x,c=a.toNode.y-a.fromNode.y,d=Math.sqrt(b*b+c*c),e=.25*b,f=.25*c;e/=100*a.length;var g=a.length,h=100*g,i=f;f/=h,i/=100*a.length,a.toNode.dx=a.toNode.dx-e*d,a.toNode.dy=a.toNode.dy-f*d,a.fromNode.dx=a.fromNode.dx+e*d,a.fromNode.dy=a.fromNode.dy+f*d},_relaxNodePair:function(a,b){var c=0,d=0,e=a.x-b.x,f=a.y-b.y,g=e*e+f*f;0===g?(c=Math.random(),d=Math.random()):36e4>g&&(c=e/g,d=f/g);var h=a.repulsion*b.repulsion/100,i=.25*h;a.dx+=c*i,a.dy+=d*i,b.dx-=c*i,b.dy-=d*i},_moveNodes:function(){for(var a=this._maxMotion,b=0,c=0,d=this._snodes.size();d>c;c++){var e=this._snodes.get(c),f=e.dx,g=e.dy;f*=this._damper,g*=this._damper,e.dx=f/2,e.dy=g/2;var h=Math.sqrt(f*f+g*g);if(!e.fix)if(e.x=e.x+Math.max(-30,Math.min(30,f)),e.y=e.y+Math.max(-30,Math.min(30,g)),this._limitBounds){e.x<this._limitBounds.x&&(e.x=this._limitBounds.x,this._adjustLocation(1,0)),e.y<this._limitBounds.y&&(e.y=this._limitBounds.y,this._adjustLocation(0,1));var i,j=this._gl3dview.getElementUI(e.element);i=j?j._viewRect:e.element.getRect(),i&&(e.x+i.width>this._limitBounds.x+this._limitBounds.width&&(e.x=this._limitBounds.x+this._limitBounds.width-i.width,this._adjustLocation(-1,0)),e.y+i.height>this._limitBounds.y+this._limitBounds.height&&(e.y=this._limitBounds.y+this._limitBounds.height-i.height,this._adjustLocation(0,-1)))}else e.x<1&&this._adjustLocation(1,0),e.y<1&&this._adjustLocation(0,1);b=Math.max(h,b)}this._maxMotion=b,this._motionRatio=this._maxMotion>0?a/this._maxMotion-1:0,this._damp()},_damp:function(){this._motionRatio<=.001&&((this._maxMotion<.2||this._maxMotion>1&&this._damper<.9)&&this._damper>.01?this._damper-=.01:this._maxMotion<.4&&this._damper>.003?this._damper-=.003:this._damper>1e-4&&(this._damper-=1e-4)),this._maxMotion<this._motionLimit&&(this._damper=0)},_rebuild:function(){this._snodeMap={},this._snodes.clear(),this._slinks.clear(),this._gl3dview.getElementBox().forEach(function(a){this.isVisible(a)&&(a instanceof Ib.Link?this._addLink(a):a instanceof Jd&&this._addNode(a))},this)},_addNode:function(a){var b=this._snodeMap[a.getId()];return b?b:(b={},b.element=a,b.repulsion=this._getRepulsion(a),b.x=a.getX(),b.y=a.getY(),b.dx=0,b.dy=0,b.fix=!this.isMovable(a),this._snodeMap[a.getId()]=b,this._snodes.add(b),b)},_addLink:function(a){var b={};b.fromNode=this._addNode(a.getFromNode()),b.toNode=this._addNode(a.getToNode()),b.element=a;var c,d,e=this._gl3dview.getElementUI(a.getToNode()),f=this._gl3dview.getElementUI(a.getFromNode());e&&e._viewRect&&f&&f._viewRect?(c=e._viewRect.width+f._viewRect.width,d=e._viewRect.height+f._viewRect.height):(c=a.getToNode().getWidth()+a.getFromNode().getWidth(),d=a.getToNode().getHeight()+a.getFromNode().getHeight()),b.length=Math.floor(Math.sqrt(c*c+d*d)*this._linkRepulsionFactor),b.length<=0&&(b.length=100),this._slinks.add(b)},_getRepulsion:function(a){var b,c=this._gl3dview.getElementUI(a);if(c&&c._viewRect){var d=c._viewRect;b=Math.floor(Math.sqrt(d.width*d.width+d.height*d.height)*this._nodeRepulsionFactor)}else b=100;return 0>=b&&(b=100),b},_adjustLocation:function(a,b){for(var c=0,d=this._snodes.size();d>c;c++){var e,f=this._snodes.get(c),g=this._gl3dview.getElementUI(f.element);if(e=g?g._viewRect:f.element.getRect(),!e)return;a>0?(!this._limitBounds||f.x+e.width+a<this._limitBounds.x+this._limitBounds.width)&&(f.x+=a):(!this._limitBounds||f.x+a>this._limitBounds.x)&&(f.x+=a),b>0?(!this._limitBounds||f.y+e.height+b<this._limitBounds.y+this._limitBounds.height)&&(f.y+=b):(!this._limitBounds||f.y+b>this._limitBounds.y)&&(f.y+=b)}}}),Ib.layout.CloudLayouter=function(a){Ib.layout.CloudLayouter.superClass.constructor.apply(this,arguments),this._gl3dview=a,this._centerX=0,this._centerY=0,this._radius=1,this._rect=null,this._localPoint=null,this._lastWidth=-1e3,this._lastHeight=-1e3,this._nodes=new md,this._sa=0,this._ca=0,this._sb=0,this._cb=0,this._sc=0,this._cc=0,this._lasta=0,this._lastb=0,this._active=!1,this._horizontalElliptical=1,this._verticalElliptical=1,this._timer=null,this._centering=!1,this._centeringNode=null,this._freeze=!1,this._gl3dview.setInteractions("twaver.gl3dview.Gl3dview"===this._gl3dview.getClassName()?[new Ib.gl3dview.interaction.SelectInteraction(this._gl3dview)]:[new Ib.canvas.interaction.SelectInteraction(this._gl3dview)])},Jb.ext("twaver.layout.CloudLayouter",Ib.PropertyChangeDispatcher,{__accessor:["updateNodeFunction","mouseMoveFunction","mouseOverFunction","percentPadding","ceaseRate","ceaseLimit"],__bool:["elliptical","active","updateLayoutRectOnResized","reloadOnServaChanged"],_moveSpeed:2,_ceaseRate:.9,_ceaseLimit:.01,_percentPadding:.2,_elliptical:!0,_interval:50,_reloadOnServaChanged:!0,_updateLayoutRectOnResized:!0,getGl3dview:function(){return this._gl3dview},isLayoutable:function(a){return this._gl3dview.isVisible(a)&&this._gl3dview.isMovable(a)},start:function(b){if(0===arguments.length&&(b=!0),!this._timer){this._installListeners(),b&&this.updateLayoutRect(!0);var c=this,d=function(){c._update.call(c)};this._timer=a.setInterval(d,this._interval),this._update()}},stop:function(){this._timer&&(a.clearInterval(this._timer),this._timer=null)},isRunning:function(){return!!this._timer},getInterval:function(){return this._interval},setInterval:function(b){if(this._interval!==b){var c=this._interval;if(this._interval=b,this._timer){a.clearInterval(this._timer);var d=this,e=function(){d._update.call(d)};this._timer=a.setInterval(e,this._interval)}this.firePropertyChange("interval",c,b)}},getMoveSpeed:function(){return this._moveSpeed},setMoveSpeed:function(a){var b=this._moveSpeed;this._moveSpeed=a,this.firePropertyChange("moveSpeed",b,a)},getLayoutRect:function(){var a=this._gl3dview.getView().offsetWidth/this._gl3dview.getZoom(),b=this._gl3dview.getView().offsetHeight/this._gl3dview.getZoom(),c=a*this._percentPadding,d=b*this._percentPadding;return{x:c,y:d,width:a-2*c,height:b-2*d}},getCount:function(){return this._nodes.size()},updateLayoutRect:function(a){var b=this._radius;if(this._rect=this.getLayoutRect(),this._rect.width<=2&&(this._rect.width=2),this._rect.height<=2&&(this._rect.height=2),this._radius=Math.min(this._rect.width/2,this._rect.height/2),this.isElliptical()?(this._horizontalElliptical=this._rect.width/2/this._radius,this._verticalElliptical=this._rect.height/2/this._radius):(this._horizontalElliptical=1,this._verticalElliptical=1),this._centerX=this._rect.x+this._rect.width/2,this._centerY=this._rect.y+this._rect.height/2,a)this.reload();else{this._lasta=1,this._lastb=1;for(var c=this._nodes.size(),d=0;c>d;d++){var e=this._nodes.get(d);e.cx*=this._radius/b,e.cy*=this._radius/b,e.cz*=this._radius/b}this._freeze?this._updateNodes(0,0,0):this._update()}this._lastWidth=this._gl3dview.getView().offsetWidth,this._lastHeight=this._gl3dview.getView().offsetHeight},reload:function(){this._freeze=!1,this._centeringNode=null,this._localPoint=null,this._centering=!1,this._nodes=new md,this._box.forEach(function(a){if(a&&this.isLayoutable(a)){var b={};b.node=a,this._nodes.add(b)}},this),this._sineCosine(0,0,0),this._active=!1,this._lasta=1,this._lastb=1;for(var a=0,b=0,c=this._nodes.size(),d=0;c>d;d++){a=Math.acos(-1+(2*(d+1)-1)/c),b=Math.sqrt(c*Math.PI)*a;var e=this._nodes.get(d);e.cx=this._radius*Math.cos(b)*Math.sin(a),e.cy=this._radius*Math.sin(b)*Math.sin(a),e.cz=this._radius*Math.cos(a)}},_sineCosine:function(a,b,c){var d=Math.PI/180;this._sa=Math.sin(a*d),this._ca=Math.cos(a*d),this._sb=Math.sin(b*d),this._cb=Math.cos(b*d),this._sc=Math.sin(c*d),this._cc=Math.cos(c*d)},handleSelectionChange:function(a){this.centerNode(this._gl3dview.getSelectionContainer().getLastData())},handleServaChange:function(a){(this._reloadOnServaChanged||"clear"===a.kind)&&this.reload()},handleMouseMove:function(a){this._centering||this._updateLogicalPoint(a),this._active=this._mouseMoveFunction?this._mouseMoveFunction(a):!0},handleMouseOver:function(a){this._centering||this._updateLogicalPoint(a),this._active=this._mouseOverFunction?this._mouseOverFunction(a):!0},_updateLogicalPoint:function(a){this._localPoint=this._gl3dview.getLogicalPoint(a)},handleRollOut:function(a){this._active=!1},handleResize:function(a){if("validateEnd"===a.kind){if(!this._updateLayoutRectOnResized)return;if(Math.abs(this._gl3dview.getView().offsetWidth-this._lastWidth)<=2&&Math.abs(this._gl3dview.getView().offsetHeight-this._lastHeight)<=2)return;this.updateLayoutRect()}},handleGl3dviewPropertyChange:function(a){"elementBox"===a.property&&(this._box.removeServaChangeListener(this.handleServaChange,this),this._box=this._gl3dview.getElementBox(),this._box.addServaChangeListener(this.handleServaChange,this),this.reload()),"zoom"===a.property&&(this._localPoint=null,this.updateLayoutRect())},_adjustIndex:function(){this._nodes.sort(this._sortFunction);for(var a=this._nodes.size(),b=0;a>b;b++){var c=this._nodes.get(b).node,d=this._box.getDatas().indexOf(c);this._box.getDatas().removeAt(d),this._box.getDatas().add(c,b),this._box.fireIndexChange(c,d,b),this.updateNode(c,b,a,this._nodes.get(b).alpha)}},_sortFunction:function(a,b){return b.cz>a.cz?1:b.cz<a.cz?-1:0},updateNode:function(a,b,c,d){this._updateNodeFunction&&this._updateNodeFunction(a,b,c,d)},_update:function(){if(!this._freeze){var a,b;if(this._centering&&this._centeringNode){var c=this.isAtCenter(this._centeringNode.node,this._centeringNode.perspective,this._centeringNode.cx,this._centeringNode.cy,this._centeringNode.cz);if(c)return this._freeze=!0,
this._centering=!1,void(this._centeringNode=null)}if(!this._freeze&&(this._active||this._centering)&&this._localPoint?this.isElliptical()?(a=(this._centerY-this._localPoint.y)/(this._rect.height/2)*this._moveSpeed,b=(this._localPoint.x-this._centerX)/(this._rect.width/2)*this._moveSpeed):(a=(this._centerY-this._localPoint.y)/this._radius*this._moveSpeed,b=(this._localPoint.x-this._centerX)/this._radius*this._moveSpeed):(a=this._lasta*this._ceaseRate,b=this._lastb*this._ceaseRate),this._lasta=a,this._lastb=b,Math.abs(a)>this._ceaseLimit||Math.abs(b)>this._ceaseLimit){var d=0;this._sineCosine(a,b,d);for(var e=0,f=this._nodes.size();f>e;e++){var g=this._nodes.get(e),h=g.cx,i=g.cy*this._ca+g.cz*-this._sa,j=g.cy*this._sa+g.cz*this._ca,k=h*this._cb+j*this._sb,l=i,m=h*-this._sb+j*this._cb,n=k*this._cc+l*-this._sc,o=k*this._sc+l*this._cc,p=m;g.cx=n,g.cy=o,g.cz=p;var q=2*this._radius;q/=q+p,g.perspective=q,g.alpha=(this._radius-p)/(2*this._radius);var r=this._horizontalElliptical*n*q-2*this._horizontalElliptical+this._centerX,s=o*q*this._verticalElliptical+this._centerY;g.node.setCenterLocation(r,s)}this._adjustIndex()}}},centerNode:function(a){if(a&&this.isLayoutable(a)){if(this._centeringNode&&a===this._centeringNode.node&&this._freeze)return;for(var b=0,c=this._nodes.size();c>b;b++){var d=this._nodes.get(b);if(d&&a===d.node){this._centering=!0,this._freeze=!1,this._active=!0,this._centeringNode=d,this._localPoint=this.createControlPoint(this._centeringNode.node);break}}}else this._centering=!1,this._freeze=!1,this._active=!1,this._localPoint=null},createControlPoint:function(a){var b=a.getCenterLocation(),c=this.getLayoutRect(),d=c.x+c.width/2,e=c.y+c.height/2,f=Math.atan2(b.y-e,b.x-d),g=c.width+c.height;return{x:d+g*Math.cos(f),y:e+g*Math.sin(f)}},isAtCenter:function(a,b,c,d,e){if(this._moveSpeed<=0)return!0;var f=16/this._moveSpeed;return f>20?f=20:2>f&&(f=2),-e/Math.sqrt(c*c+d*d)>f},_updateNodes:function(a,b,c){this._sineCosine(a,b,c);for(var d=0,e=this._nodes.size();e>d;d++){var f=this._nodes.get(d),g=f.cx,h=f.cy*this._ca+f.cz*-this._sa,i=f.cy*this._sa+f.cz*this._ca,j=g*this._cb+i*this._sb,k=h,l=g*-this._sb+i*this._cb,m=j*this._cc+k*-this._sc,n=j*this._sc+k*this._cc,o=l;f.cx=m,f.cy=n,f.cz=o;var p=2*this._radius;p/=p+o,f.perspective=p;var q=this._horizontalElliptical*m*p-2*this._horizontalElliptical+this._centerX,r=n*p*this._verticalElliptical+this._centerY;f.node.setCenterLocation(q,r)}this._adjustIndex()},_installListeners:function(){this._box=this._gl3dview.getElementBox(),this._box.addServaChangeListener(this.handleServaChange,this),this._gl3dview.getSelectionContainer().addSelectionChangeListener(this.handleSelectionChange,this),this._gl3dview.addViewListener(this.handleResize,this),Wb.addEventListener("mouseout","handleRollOut",this._gl3dview.getView(),this),Wb.addEventListener("mousemove","handleMouseMove",this._gl3dview.getView(),this),Wb.addEventListener("mouseover","handleMouseOver",this._gl3dview.getView(),this),this._gl3dview.addPropertyChangeListener(this.handleGl3dviewPropertyChange,this)},_uninstallListeners:function(){this._box.removeServaChangeListener(this.handleServaChange,this),this._gl3dview.getSelectionContainer().removeSelectionChangeListener(this.handleSelectionChange,this),this._gl3dview.removeViewListener(this.handleResize,this),Wb.removeEventListener("mouseout",this._gl3dview.getView(),this),Wb.removeEventListener("mousemove",this._gl3dview.getView(),this),Wb.removeEventListener("mouseover",this._gl3dview.getView(),this),this._gl3dview.removePropertyChangeListener(this.handleGl3dviewPropertyChange,this)}}),Ib.layout.AutoLayouter=function(a){this._box=a},Jb.ext("twaver.layout.AutoLayouter",Object,{_expandGroup:!1,_repulsion:1,_type:null,_animate:!0,_explicitXOffset:Number.NaN,_explicitYOffset:Number.NaN,_xOffset:0,_yOffset:0,isExpandGroup:function(){return this._expandGroup},setExpandGroup:function(a){this._expandGroup=a},getRepulsion:function(){return this._repulsion},setRepulsion:function(a){this._repulsion=a},getType:function(){return this._type},isAnimate:function(){return this._animate},setAnimate:function(a){this._animate=a},getElementBox:function(){return this._box},getExplicitXOffset:function(){return this._explicitXOffset},setExplicitXOffset:function(a){this._explicitXOffset=a},getExplicitYOffset:function(){return this._explicitYOffset},setExplicitYOffset:function(a){this._explicitYOffset=a},getDimension:function(a){if(a instanceof Ld&&a.getChildrenSize()>0){for(var b=null,c=0,d=a.getChildrenSize();d>c;c++){var e=a.getChildAt(c);e instanceof Jd&&(b=b?Tb.unionRect(b,e.getRect()):e.getRect())}return b?{width:b.width,height:b.height}:null}return{width:a.getWidth(),height:a.getHeight()}},isVisible:function(a){return!0},isMovable:function(a){return!0},getGroupLayoutType:function(a){return this._type},getElements:function(){var a,b=this._box,c=b.getSelectionContainer().size()>1;c?a=b.getSelectionContainer().getSelection():(a=new md,b.forEachByBreadthFirst(a.add,null,a)),this._xOffset=-1,this._yOffset=-1;for(var d=new md,e=0,f=a.size();f>e;e++){var g=a.get(e);this.isVisible(g)&&(g instanceof Ib.Link?d.add(g):this.isMovable(g)&&g instanceof Jd&&(d.add(g),c&&((this._xOffset<0||g.getX()<this._xOffset)&&(this._xOffset=g.getX()),(this._yOffset<0||g.getY()<this._yOffset)&&(this._yOffset=g.getY()))))}return c||(this._xOffset=isNaN(this._explicitXOffset)?50/this._repulsion:this._explicitXOffset,this._yOffset=isNaN(this._explicitYOffset)?50/this._repulsion:this._explicitYOffset),d},getLayoutResult:function(a){var b={};return this.doLayoutImpl(a,null,b),b},doLayout:function(a,b){return this.doLayoutImpl(a,b)},doLayoutImpl:function(a,b,c){var d=this,e=b;b=function(){d._box._layoutMovingElements=!1,e&&e()},this._type=a;var f=null;if("round"===a?f=new bf:"symmetry"===a?f=new qf:"hierarchic"===a?f=new Af:("topbottom"===a||"bottomtop"===a||"rightleft"===a||"leftright"===a)&&(f=new Pe),null==f)return!1;d._box._layoutMovingElements=!0;var g={},h=this.getElements(),i=new rf(this,h,!0,null);h=i.process();var j=new lf(this,h,a,!0,null);try{f.i2(j)}catch(k){return i.resetGroup(),null!=b&&b(),!1}var l,m;for(l in j._a){m=j._a[l];var n=j.g4(m);g[l]={x:n.x+this._xOffset,y:n.y+this._yOffset}}var o;if("rightleft"===a||"leftright"===a||"bottomtop"===a){var p=rf.createMatrix(a),q=Number.MAX_VALUE,r=Number.MAX_VALUE;for(l in g){m=j._a[l],o=g[l];var s=p.transform(o);o.x=s.x,o.y=s.y;var t;"rightleft"===a||"leftright"===a?(t=s.x-j.g9(m)/2/this._repulsion,q>t&&(q=t),t=s.y-j.gj(m)/2/this._repulsion,r>t&&(r=t)):(t=s.x-j.gj(m)/2/this._repulsion,q>t&&(q=t),t=s.y-j.g9(m)/2/this._repulsion,r>t&&(r=t))}for(l in g)m=j._a[l],o=g[l],o.x=o.x-q+this._xOffset,o.y=o.y-r+this._yOffset}if(null==c&&this._animate){var u=new md,v=new md;for(l in g)u.add(j._a[l].node),v.add(g[l]);Ib.animate.AnimateManager.endAnimate(),Ib.animate.AnimateManager.start(new Ib.animate.AnimateCenterLocation(u,v,function(){i.resetGroup(),null!=b&&Jb.callLater(b)}))}else{for(l in g)m=j._a[l],o=g[l],null==c?m.node.setCenterLocation(o.x,o.y):c[m.node.getId()]=o;i.resetGroup(),null!=b&&Jb.callLater(b)}return!0}});var Qd=function(a,b){this.x=a,this.y=b};Jb.ext(Qd,Object,{equals:function(a){return this===a?!0:a instanceof Qd?a.x==this.x&&a.y==this.y:!1}});var Rd=function(a,b){this.width=a,this.height=b};Jb.ext(Rd,Object,{});var Sd=function(a,b){this.x=a,this.y=b};Jb.ext(Sd,Object,{});var Td=function(){2===arguments.length?(Td.superClass.constructor.call(this,arguments[1].width,arguments[1].height),this.x=arguments[0].x,this.y=arguments[0].y):(Td.superClass.constructor.call(this,arguments[2],arguments[3]),this.x=arguments[0],this.y=arguments[1])};Jb.ext(Td,Rd,{});var Ud=function(a,b){if(Ud.a2(a.x,b.x))this._a=1,this._b=0,this._c=-a.x;else{this._b=-1;var c=(b.y-a.y)/(b.x-a.x),d=a.y-a.x*c;this._a=c,this._c=d}};Jb.ext(Ud,Object,{a3:function(){return this._a},a4:function(){return this._b},a5:function(){return this._c}}),Ud.a6=function(a,b){if(Ud.a1(a.a3())&&Ud.a1(b.a3()))return null;if(Ud.a1(a.a4())&&Ud.a1(b.a4()))return null;if(Ud.a1(b.a4())){var c=a;a=b,b=c}var d,e,f=a.a3(),g=a.a4(),h=-a.a5();Ud.a1(a.a3())?(d=b.a4(),e=-b.a5()):(d=b.a4()-b.a3()/a.a3()*a.a4(),e=-b.a5()-b.a3()/a.a3()*-a.a5());var i=e/d,j=(h-i*g)/f;return new Qd(j,i)},Ud.a1=function(a){return Ud.a2(a,0)},Ud.a2=function(a,b){return Math.abs(a-b)<1e-5};var Vd=function(a){if(this._a=new oe,a)for(var b=0;b<a.size();b++)this._a.aa(a.get(b))};Jb.ext(Vd,Object,{c:function(){return this._a.ah()},d:function(){return this._a.ah()},a:function(){for(var a=new md,b=this.c();b.i1();b.i2())a.add(b.i6(),0);return new Vd(a)},b:function(){return this._a.ay()}});var Wd=function(a,b){this.x=a,this.y=b};Jb.ext(Wd,Object,{a:function(a,b){this.x=a,this.y=b}});var Xd=function(a,b){this.x=a||0,this.y=b||0};Jb.ext(Xd,Object,{b:function(){return new Xd(this.x,this.y)},a:function(a){this.z=a},c:function(){return this.x},d:function(){return this.y},f:function(a,b){this.x=a,this.y=b}});var Yd=function(a){this._c=new oe,a?(this.ac(a.a8().b()),this.ad(a.a9().b())):(this.ac(new Xd),this.ad(new Xd))};Jb.ext(Yd,Object,{a6:function(){return this.a5(this)},ac:function(a){a.a(this),this._a=a},ad:function(a){a.a(this),this._b=a},a8:function(){return this._a},a9:function(){return this._b},a1:function(a,b){return this.a4(a,b,this.aa())},a2:function(){return this._c.ay()},a7:function(a){return this._c.ak(a)},aa:function(){return 0===this._c.ay()?null:this._c.as()},a3:function(){this._c.af()},i2:function(a){var b=this.a7(a);return null!=b?new Qd(b.x,b.y):null},i1:function(){return this.a2()},i6:function(){var a=this.a8();return new Qd(a.c(),a.d())},i7:function(){var a=this.a9();return new Qd(a.c(),a.d())},i8:function(a){this.a8().f(a.x,a.y)},i9:function(a){this.a9().f(a.x,a.y)},i3:function(a,b,c){var d=this.a7(a);null!=d&&d.a(b,c)},i4:function(a,b){this.a1(a,b)},i5:function(){this.a3()}});var Zd=function(a){Zd.superClass.constructor.call(this,a)};Jb.ext(Zd,Yd,{a5:function(a){return new Zd(a)},a4:function(a,b,c){var d=new Wd(a,b);return this.ab(d,c),d},ab:function(a,b){this._c.an(a,this._c.al(b))}});var $d=function(){if(2===arguments.length){var a=arguments[0],b=arguments[1];this._s=!1,this._w=30,this._h=30,this._x=a-this._w/2,this._y=b-this._h/2}else{var c=arguments[0];this._s=c._s,this._w=c._w,this._h=c._h,this._x=c._x,this._y=c._y}};Jb.ext($d,Object,{m3:function(){return this.m2(this)},m4:function(){return this._x+this._w/2},m5:function(){return this._y+this._h/2},m6:function(a,b){this._x=a-this._w/2,this._y=b-this._h/2},i1:function(){return this._x},i2:function(){return this._y},i5:function(a,b){this._x=a,this._y=b},i3:function(){return this._w},i4:function(){return this._h},i6:function(a,b){var c=(this._w-a)/2,d=(this._h-b)/2;this._x+=c,this._y+=d,this._w=a,this._h=b},m1:function(a){var b,c,d,e;a.width<=0?(b=this._x,c=this._x+this._w,d=this._y,e=this._y+this._h):(b=Math.min(this._x,a.x),c=Math.max(this._x+this._w,a.x+a.width),d=Math.min(this._y,a.y),e=Math.max(this._y+this._h,a.y+a.height)),a.x=b,a.y=d,a.width=c-b,a.height=e-d}});var _d=function(a){a?_d.superClass.constructor.call(this,a):_d.superClass.constructor.call(this,0,0)};Jb.ext(_d,$d,{m2:function(a){return new _d(a)}});var ae={};ae.a2=function(a){var b=Le.a2(Ff.a(a.xa()));return ae.a4(a,b,ae.a3(a,b))},ae.a3=function(a,b){for(var c=a.x9();c.i1();c.i2())b.i7(c.i9(),-1);for(var d=0,e=new ue(a.xa()),f=a.x9();f.i1();f.i2()){var g=f.i9();-1===b.i2(g)&&ae.a(g,e,b,d++)}return d},ae.a6=function(a){for(var b=new pe,c=ae.a2(a),d=0;d<c.length-1;d++){var e=a.xo(c[d].x2(),c[d+1].x3());b.aa(e)}return b},ae.a4=function(a,b,c){for(var d=[],e=0;c>e;e++)d[e]=new He;for(var f=a.x9();f.i1();f.i2())d[b.i2(f.i9())].ae(f.i9());return d},ae.a=function(a,b,c,d){for(b.c(a),c.i7(a,d);!b.a();){a=b.b();for(var e=a.ag();null!=e;e=e.a8()){var f=e.a3();-1===c.i2(f)&&(c.i7(f,d),b.c(f))}for(var g=a.ae();null!=g;g=g.a7()){var h=g.a2();-1===c.i2(h)&&(c.i7(h,d),b.c(h))}}},ae.a1=function(a,b,c){var d=new je(b,c);return d.a8(a),d._i},ae.a5=function(a,b,c){for(var d=[],e=0;c>e;e++)d[e]=new pe;for(var f=a.xf();f.i1();f.i2())d[b.i2(f.i8())].aa(f.i8());return d},ae.a7=function(a){var b=new pe,c=Le.a3(Ff.b(a.xa())),d=Le.a4(Ff.a(a.xh())),e=ae.a1(a,d,c),f=ae.a5(a,d,e);if(f.length>1){for(var g=new He,h=0;h<f.length;h++){var i=f[h],j=null;if(1===i.ay()){var k=i.c2();1===k.a2().ad()?j=k.a2():1===k.a3().ad()&&(j=k.a3())}else{for(var l=i.c1();l.i1();l.i2()){var m=l.i8();if(c.i4(m.a2()))if(null==j)j=m.a2();else if(j!==m.a2()){j=null;break}if(c.i4(m.a3()))if(null!=j){if(j!==m.a3()){j=null;break}}else j=m.a3()}if(null!=j){var n=i.c2();j=n.a2()!==j?n.a2():n.a3()}}null!=j&&g.aa(j)}for(var o,p=g.x4();!g.ar();p=o)o=g.x4(),b.ac(a.xo(p,o))}return b};var be=function(){this._c=0,this._d=0,this._e=0,this._b=!0,this._f=!1};Jb.ext(be,Object,{a6:function(a){this._f=a},a7:function(a){this._b=a},a8:function(a){0!==a.x0()&&this.a9(a,a.x9().i9())},a9:function(a,b){if(this._xx=a.xk(),this._c=a.xl(),this._d=0,this._e=0,this.a0(b),this._b)for(var c=a.x9();c.i1();c.i2()){var d=c.i9();null==this._xx.i1(d)&&(this.a1(d),this.a0(d))}a.xi(this._xx),a.xj(this._c)},a0:function(a){var b=++this._d;this._xx.z1(a,be._B),this.a5(a,b);for(var c=this._f?a.ap():a.af();c.i1();c.i2()){var d=c.i8();if(!this._c.i4(d)){this._c.i7(d,!0);var e=d.a1(a);null==this._xx.i1(e)?(this.a3(d,e,!0),this.a0(e),this.a2(d,e)):this.a3(d,e,!1)}}this.a4(a,b,++this._e),this._xx.z1(a,be._C)},a5:function(a,b){},a4:function(a,b,c){},a3:function(a,b,c){},a2:function(a,b){},a1:function(a){}}),be._B={},be._C={};var ce=function(a){this._a=a};Jb.ext(ce,be,{a5:function(a,b){var c=this._a._ah.i2(a);this._a._ad[c].ae(a)}});var de=function(a){this._a=a};Jb.ext(de,be,{a2:function(a,b){var c=a.a1(b),d=this._a[c.al()],e=this._a[b.al()];e._a+1>d._a?(d._c=d._a,d._b=d._d,d._a=e._a+1,d._d=a):e._a+1>d._c&&(d._c=e._a+1,d._b=a)}});var ee=function(a){this._a=a};Jb.ext(ee,be,{a3:function(a,b,c){c&&a.a2()===b&&this._a.ac(a)}});var fe=function(){this._a=0,this._c=0};Jb.ext(fe,Object,{});var ge=function(){this._a=0};Jb.ext(ge,Object,{a1:function(a,b){this._a=0;for(var c=b.length-1;c>=0;c--)b[c]=-1;for(var d=a.x9();d.i1();d.i2()){var e=d.i9();if(0===e.ak()){this.a2(e,e.al(),b);break}}for(var f=a.x9();f.i1();f.i2()){var g=f.i9(),h=g.al();-1===b[h]&&this.a2(g,h,b)}},a2:function(a,b,c){c[b]=-2;for(var d=a.ag();null!=d;){var e=d.a3(),f=e.al();switch(c[f]){case-1:this.a2(e,f,c);case-2:default:d=d.a8()}}c[b]=this._a++}});var he={};he.a1=function(a){var b=new ie;return b.a8(a),b._n},he.a2=function(a){var b=a.x9(),c=null,d=0;for(b.i4();b.i1();b.i2())0===b.i9().ak()&&(c=b.i9(),d++);if(1===d)return c;for(d=0,b.i4();b.i1();b.i2())0===b.i9().ao()&&(c=b.i9(),d++);return 1===d?c:he.a8(a)},he.a8=function(a){var b=Ff.a(a.x0()),c=Le.a2(b);return he.a6(a,c)},he.a6=function(a,b){var c=a.xd(),d=Ff.d(1),e=Ff.a(a.x0(),-1),f=he.a4(a,c);he.a7(c,b,d,e,-1);for(var g=f.c1();g.i1();g.i2())a.x3(g.i8());return d[0]},he.a7=function(a,b,c,d,e){for(var f=0,g=a.ag();null!=g;g=g.a8()){var h=g.a3(),i=he.a7(h,b,c,d,e);i>e&&(e=i),f+=d[h.al()]}for(var j=f*(a._g.xa()-1-f),k=a.ag();null!=k;k=k.a8())for(var l=k.a3(),m=k.a8();null!=m;m=m.a8()){var n=m.a3();j+=d[l.al()]*d[n.al()]}return b.i7(a,j),d[a.al()]=f+1,j>e&&(e=j,c[0]=a),e},he.a4=function(a,b){var c=new pe,d=new ee(c);d.a6(!1),d.a9(a,b);for(var e=c.c1();e.i1();e.i2())a.x3(e.i8());return c},he.a3=function(a){return he.a4(a,he.a2(a))};var ie=function(){this._n=!0,this.a6(!1)};Jb.ext(ie,be,{a3:function(a,b,c){c||(this._n=!1)},a1:function(a){this._n=!1}});var je=function(a,b){this._i=0,this._m=b,this._j=a,this._l=!1};Jb.ext(je,be,{a8:function(a){this._h=Ff.a(a.x0()),this._k=Ff.a(a.x0()),this._g=new ue(a.xh()),je.superClass.a8.call(this,a)},a5:function(a,b){this._k[a.al()]=this._h[a.al()]=b},a3:function(a,b,c){if(this._g.c(a),!c){var d=a.a1(b);this._h[d.al()]=Math.min(this._h[d.al()],this._k[b.al()])}},a1:function(a){this._l=!1},a2:function(a,b){var c=a.a1(b);if(this._h[b.al()]>=this._k[c.al()]){for(;this._g.d()!==a;this._j.i5(this._g.b(),this._i));this._j.i5(this._g.b(),this._i),this._i++,this._g.a()?this._l?this._m.i5(c,!0):this._l=!0:this._m.i5(c,!0)}this._h[c.al()]=Math.min(this._h[c.al()],this._h[b.al()])}});var ke=function(a,b){this._h=!1,this._i=a,this._g=b};Jb.ext(ke,Object,{z1:function(a,b){a._c[this._i]=b},i1:function(a){return a._c[this._i]},i5:function(a,b){a._c[this._i]=b},i4:function(a){return a._c[this._i]},i7:function(a,b){a._c[this._i]=b},i2:function(a){var b=a._c[this._i];return null==b?0:b},i6:function(a,b){a._c[this._i]=b},i3:function(a){var b=a._c[this._i];return null==b?0:b},c:function(){return this._h},d:function(){this._h=!0}});var le=function(a,b){this._c=!1,this._d=a,this._b=b};Jb.ext(le,Object,{i8:function(a,b){a._c[this._d]=b},i1:function(a){return a._c[this._d]},i7:function(a,b){a._c[this._d]=b},i4:function(a){var b=a._c[this._d];return null==b?!1:b},i5:function(a,b){a._c[this._d]=b},i2:function(a){var b=a._c[this._d];return null==b?0:b},i6:function(a,b){a._c[this._d]=b},i3:function(a){var b=a._c[this._d];return null==b?0:b},a:function(){return this._c},b:function(){this._c=!0}});var me=function(a){this._bb=a,this.i4()};Jb.ext(me,Object,{i1:function(){return null!=this._aa},i2:function(){this._aa=this._aa._a},i3:function(){this._aa=this._aa._b},i4:function(){this._aa=this._bb._b},i5:function(){this._aa=this._bb._c},i7:function(){return this._bb.ay()},i6:function(){return this._aa._c}});var ne=function(a){ne.superClass.constructor.call(this,a)};Jb.ext(ne,me,{i8:function(){return this.i6()}});var oe=function(a){if(this._id=Jb.id(),this._a=0,a)for(a.i4();a.i1();a.i2())this.ae(a.i6())};Jb.ext(oe,Object,{ac:function(a){var b=this.ag(a);return null==this._b?this._b=this._c=b:(this._b._b=b,b._a=this._b,this._b=b),this._a++,b},ae:function(a){var b=this.ag(a);return null==this._c?this._b=this._c=b:(this._c._a=b,b._b=this._c,this._c=b),this._a++,b},z1:function(a){a._b=null,a._a=null,null==this._c?this._b=this._c=a:(this._c._a=a,a._b=this._c,this._c=a),this._a++},ad:function(a){a._b=null,a._a=null,null==this._b?this._b=this._c=a:(this._b._b=a,a._a=this._b,this._b=a),this._a++},aa:function(a){return this.ae(a),!0},ab:function(a){for(;a.i1();a.i2())this.ae(a.i6())},ao:function(a,b){if(b===this._b)return this.ac(a);if(null==b)return this.ae(a);var c=this.ag(a);return this.aq(c,b),c},aq:function(a,b){if(null==b)this.ad(a);else if(b===this._b)this.ad(a);else{if(null==this._c)a._b=null,a._a=null,this._b=this._c=a;else{var c=b._b;b._b=a,a._a=b,c._a=a,a._b=c}this._a++}},ap:function(a,b){if(null==b)this.z1(a);else if(b===this._c)this.z1(a);else{if(null==this._b)a._b=null,a._a=null,this._b=this._c=a;else{var c=b._a;b._a=a,a._a=c,c._b=a,a._b=b}this._a++}},an:function(a,b){if(b===this._c)return this.ae(a);if(null==b)return this.ac(a);var c=this.ag(a);return this.ap(c,b),c},ay:function(){return this._a},ar:function(){return 0===this._a},af:function(){this._b=this._c=null,this._a=0},am:function(){return this._b._c},at:function(){var a=this.am();return this.aw(this._b),a},as:function(){return this._c._c},au:function(){return this.aw(this._c)},ak:function(a){for(var b=0,c=this._b;null!=c;){if(a===b)return c._c;c=c._a,b++}return null},aj:function(a){return null==a._a?this._b:a._a},ai:function(a){return null==a._b?this._c:a._b},aw:function(a){return a!==this._b?a._b._a=a._a:this._b=a._a,a!==this._c?a._a._b=a._b:this._c=a._b,this._a--,a._c},av:function(a){return this.aw(a._aa)},ah:function(){return new me(this)},al:function(a){for(var b=this._b;null!=b;){if(null==b._c&&null==a)return b;if(b._c===a)return b;b=b._a}return null},a0:function(){for(var a=Ff.d(this._a),b=0,c=this._b;null!=c;)a[b]=c._c,c=c._a,b++;return a},ax:function(){for(var a=this._b;null!=a;a=a._b){var b=a._a;a._a=a._b,a._b=b}var c=this._b;this._b=this._c,this._c=c},a1:function(a){var b=this.a0();b.sort(a);for(var c=0,d=this._b;null!=d;)d._c=b[c],d=d._a,c++},a2:function(){var a=this.a0();a.sort(Ff.c);for(var b=0,c=this._b;null!=c;)c._c=a[b],c=c._a,b++},az:function(a){null==this._b?(this._b=a._b,this._c=a._c):null!=a._b&&(this._c._a=a._b,a._b._b=this._c,this._c=a._c),this._a+=a._a,a._b=a._c=null,a._a=0},ag:function(a){return new se(a)}});var pe=function(a){pe.superClass.constructor.call(this,a)};Jb.ext(pe,oe,{c1:function(){return new ne(this)},c2:function(){return this.am()},c3:function(){return this.at()}});var qe=function(){this._c=0};Jb.ext(qe,Object,{a:function(a){this._c++,a._b=this._b,a._a=null,null!=this._b?(this._b._a=a,this._b=a):this._b=this._a=a},b:function(a,b){if(null==b)return void this.a(a);var c=b._b;null!=c?c._a=a:this._a=a,a._b=c,a._a=b,b._b=a,this._c++},c:function(a){var b=a._a,c=a._b;this._c--,null!=b?b._b=c:this._b=c,null!=c?c._a=b:this._a=b}});var re=function(a,b){this._p=a,this._j=b,this._o=a._o[b]};Jb.ext(re,Object,{i1:function(){return null!=this._o},i2:function(){this._o=this._o._k[this._j]},i3:function(){this._o=this._o._f[this._j]},i4:function(){this._o=this._p._o[this._j]},i5:function(){this._o=this._p._q[this._j]},i7:function(){return this._p._n[this._j]},i6:function(){return this._o},i8:function(){return this._o}});var se=function(a){this._c=a};Jb.ext(se,Object,{a:function(){return this._a},b:function(){return this._b},c:function(a){this._c=a},d:function(){return this._c}});var te=function(a,b,c,d){this._r=a,this._s=b,this._q=c,this._p=d};Jb.ext(te,Object,{i1:function(a){return this._p[a.a5()]},i3:function(a){return this._r[a.a5()]},i2:function(a){return this._s[a.a5()]},i4:function(a){return this._q[a.a5()]},i8:function(a,b){this._p[a.a5()]=b},i6:function(a,b){this._r[a.a5()]=b},i5:function(a,b){this._s[a.a5()]=b},i7:function(a,b){this._q[a.a5()]=b}});var ue=function(a){this._a=Ff.d(a),this._b=-1};Jb.ext(ue,Object,{d:function(){return this._a[this._b]},b:function(){return this._a[this._b--]},c:function(a){this._a[++this._b]=a},a:function(){return this._b<0}});var ve=function(){};Jb.ext(ve,Object,{a0:function(a){this._c=Ff.d(a)}});var we=function(a,b,c,d,e,f,g){this._g=0,a.xt(this,b,c,d,e,f,g)};Jb.ext(we,ve,{a5:function(){return this._h._u&&this._h.b1(),this._g},a2:function(){return this._d},a3:function(){return this._e},a1:function(a){return this._d!==a?this._d:this._e},a4:function(){for(var a=0;1>=a;a++)this._k[a]=null,this._f[a]=null},a8:function(){return this._k[0]},a7:function(){return this._k[1]},a6:function(a,b,c,d){this.a0(d),this._h=a,this._k=Ff.d(2),this._f=Ff.d(2),this._d=b,this._e=c}});var xe=function(a){this._j=0,this._h=a,this.i4()};Jb.ext(xe,Object,{i2:function(){this._k=this._k._k[this._j],null==this._k&&0===this._j&&(this._k=this._h._o[1],this._j=1)},i3:function(){this._k=this._k._f[this._j],null==this._k&&1===this._j&&(this._k=this._h._q[0],this._j=0)},i4:function(){this._k=this._h._o[0],null==this._k?(this._k=this._h._o[1],this._j=1):this._j=0},i5:function(){this._k=this._h._q[1],null==this._k?(this._k=this._h._q[0],this._j=0):this._j=1},i1:function(){return null!=this._k},i6:function(){return this._k},i8:function(){return this._k},i7:function(){return this._h.ad()}});var ye=function(){this._a=df._A,this._b=df._A,this._c=new md};Jb.ext(ye,Object,{i1:function(){return this._c.size()},i2:function(a){return this._c.get(a)},i3:function(a,b,c){this._c.set(a,new Qd(b,c))},i4:function(a,b){this._c.add(new Qd(a,b))},i5:function(){this._c.clear()},i6:function(){return this._a},i7:function(){return this._b},i8:function(a){this._a=a},i9:function(a){this._b=a}});var ze=function(){this._x=0,this._y=0,this._w=0,this._h=0};Jb.ext(ze,Object,{i5:function(a,b){this._x=a,this._y=b},i6:function(a,b){this._w=a,this._h=b},i4:function(){return this._h},i3:function(){return this._w},i1:function(){return this._x},i2:function(){return this._y}});var Ae=function(a,b,c,d){this._m=a,this._n=b,this._l=c,this._k=d};Jb.ext(Ae,Object,{i1:function(a){return this._k[a.al()]},i3:function(a){return this._m[a.al()]},i2:function(a){return this._n[a.al()]},i4:function(a){return this._l[a.al()]},z1:function(a,b){this._k[a.al()]=b},i6:function(a,b){this._m[a.al()]=b},i7:function(a,b){this._n[a.al()]=b},i5:function(a,b){this._l[a.al()]=b}});var Be=function(a,b){this._b=a,this._r=b,this._a=[];for(var c=this._b-1;c>=0;c--)this._a.push(c);this._c=new md};Jb.ext(Be,Object,{a1:function(a){var b;if(0===this._a.length){this.a2(a,this._b,this._b+this._r);for(var c=this._b+this._r-1;c>this._b;c--)this._a.push(c);b=this._b,this._b+=this._r}else b=this._a.pop();return b},b:function(a){var b=this.a1(a),c=new ke(b,this);return this._c.add(c),this.a4(a,b),c},c:function(a){var b=this.a1(a),c=new le(b,this);return this._c.add(c),this.a4(a,b),c},a2:function(a,b,c){for(var d=a._a;null!=d;d=d._a){var e=Ff.d(c);Ff.f(d._c,e,b),d._c=e}},a3:function(a,b,c){var d=Ff.d(c);Ff.f(a._c,d,b),a._c=d},a4:function(a,b){for(var c=a._a;null!=c;c=c._a)c._c[b]=null},a5:function(a,b){if(a instanceof ke){var c=a;if(c.c())throw"Error";c.d();var d=a._i;this._a.indexOf(d)<0&&(this.a4(b,d),this._a.push(d),this._c.remove(a))}},a6:function(a,b){if(a instanceof le){var c=a;if(c.a())throw"Error";c.b();var d=c._d;this._a.indexOf(d)<0&&(this.a4(b,d),this._a.push(d),this._c.remove(a))}}});var Ce=function(a){this._id=Jb.id(),this._p=0,a.xs(this)};Jb.ext(Ce,ve,{ad:function(){return this._n[0]+this._n[1]},ak:function(){return this._n[1]},ao:function(){return this._n[0]},al:function(){return this._g._y&&this._g.c(),this._p},ag:function(){return this._o[0]},ae:function(){return this._o[1]},af:function(){return new xe(this)},am:function(){return new re(this,1)},ap:function(){return new re(this,0)},an:function(){return new Ee(this)},aq:function(){return new De(this,1)},aw:function(){return new De(this,0)},ah:function(a){for(var b=this._o[0];null!=b;b=b._k[0])if(b.a3()===a)return b;return null},ai:function(a){for(var b=this._o[1];null!=b;b=b._k[1])if(b.a2()===a)return b;return null},aj:function(a){var b=this.ah(a);return null==b&&(b=this.ai(a)),b},au:function(a){this.at(a,1,Ff.d(this.ak()))},av:function(a){this.at(a,0,Ff.d(this.ao()))},as:function(a,b){this.a0(b),this._g=a,this._o=Ff.d(2),this._q=Ff.d(2),this._n=Ff.a(2)},ab:function(a,b,c,d,e){if(null==b)return void this.aa(a,c,d);var f;if(f=b._d===b._e?d:this!==b._d?1:0,0===e){var g=b._k[f];a._f[d]=b,a._k[d]=g,b._k[f]=a,null==g?this._q[c]=a:g._d===g._e?g._f[d]=a:g._f[this!==g._d?1:0]=a}else{var h=b._f[f];a._k[d]=b,a._f[d]=h,b._f[f]=a,null==h?this._o[c]=a:h._d===h._e?h._k[d]=a:h._k[this!==h._d?1:0]=a}this._n[c]++},aa:function(a,b,c){var d=this._q[b];a._k[c]=null,null==d?(this._o[b]=a,a._f[c]=null):(a._f[c]=d,d._d===d._e?d._k[c]=a:d._k[this!==d._d?1:0]=a),this._q[b]=a,this._n[b]++},ar:function(a,b,c){var d,e;d=a._k[c],e=a._f[c],null==d?this._q[b]=e:d._f[d._d!==this?1:0]=e,null==e?this._o[b]=d:e._k[e._d!==this?1:0]=d,this._n[b]--},ac:function(){for(var a=0;1>=a;a++)this._o[a]=null,this._q[a]=null,this._n[a]=0},at:function(a,b,c){if(!(this._n[b]<2)){var d,e=this._n[b],f=0;for(d=this._o[b];null!=d;d=d._k[b])c[f]=d,f++;Ff.s(c,e,a);var g=this._o[b]=c[0];g._f[b]=null;for(var h=1;e>h;)d=c[h],d._f[b]=g,g._k[b]=d,h++,g=d;this._q[b]=d,d._k[b]=null}}});var De=function(a,b){De.superClass.constructor.call(this,a,b),this._h=1!==b?1:0};Jb.ext(De,re,{i6:function(){return this.i9()},i9:function(){return 0!==this._h?this._o._e:this._o._d}});var Ee=function(a){Ee.superClass.constructor.call(this,a)};Jb.ext(Ee,xe,{i6:function(){return this._k.a1(this._h)},i9:function(){return this._k.a1(this._h)}});var Fe=function(a){Fe.superClass.constructor.call(this,a)};Jb.ext(Fe,me,{i9:function(){return this.i6()}});var Ge=function(a){this._o=a,this._c=a._a};Jb.ext(Ge,Object,{i1:function(){return null!=this._c},i2:function(){this._c=this._c._a},i3:function(){this._c=this._c._b},i5:function(){this._c=this._o._b},i4:function(){this._c=this._o._a},i7:function(){return this._o._c},i6:function(){return this._c},i9:function(){return this._c},i8:function(){return this._c}});var He=function(a){if(a&&a.length){He.superClass.constructor.call(this);for(var b=0;b<a.length;b++)this.ae(a[b])}else He.superClass.constructor.call(this,a)};Jb.ext(He,oe,{x1:function(){return new Fe(this)},x2:function(){return this.am()},x3:function(){return this.as()},x4:function(){return this.at()}});var Ie=function(a){this._d=a,Ie.superClass.constructor.call(this)};Jb.ext(Ie,He,{});var Je=function(a){this._a=a,this._b=new pe,this._c=new He};Jb.ext(Je,Object,{a:function(){for(var a=this._a.x9();a.i1();a.i2())this.e(a.i9())},b:function(){this.c(),this.d()},c:function(){for(;!this._c.ar();){var a=this._c.x4();this._a.xq(a)||this.g(a)}},d:function(){for(;!this._b.ar();){var a=this._b.c3();this._a.xp(a)||this.f(a)}},e:function(a){for(var b=a.af();b.i1();b.i2())this._b.ac(b.i8()),this._a.h1(b.i8());this._c.ac(a),this._a.h2(a)},f:function(a){this._a.u1(a)},g:function(a){this._a.h3(a)}}),Je.h=function(a,b){for(b.i4();b.i1();b.i2()){var c=b.i8();a.xq(c.a2())||a.h3(c.a2()),a.xq(c.a3())||a.h3(c.a3()),a.xp(c)||a.u1(c)}},Je.i=function(a,b){for(b.i4();b.i1();b.i2()){var c=b.i8();a.xp(c)&&a.h1(c),0===c.a2().ad()&&a.h2(c.a2()),0===c.a3().ad()&&a.h2(c.a3())}};var Ke=function(){this._g=arguments[0],this._f=this._g.xk(),this._h=this._g.xk(),this._d=new oe,this._e=0,1!==arguments.length&&this.a(arguments[1],arguments[2],arguments[3],arguments[4])};Jb.ext(Ke,Object,{a:function(a,b,c,d){for(var e=Ff.d(c-b+1),f=b;c>=f;f++)e[f]=new Ie(f);for(var g=this._g.x9();g.i1();g.i2()){var h=g.i9();(null==d||d.i4(h))&&(this._f.z1(h,e[a.i2(h)-b].ac(h)),this._e++)}for(var i=0;i<e.length;i++)for(var j=e[i],k=this._d.ae(j),l=j.x1();l.i1();l.i2())this._h.z1(l.i9(),k)},c:function(){this._g.xi(this._h),this._g.xi(this._f)},e:function(){return 0===this._e},g:function(){for(;this._d.am().ar();this._d.at());this._e--;var a=this._d.am().x4();return this._h.z1(a,null),this._f.z1(a,null),a},f:function(){for(;this._d.as().ar();this._d.au());this._e--;var a=this._d.as().x4();return this._h.z1(a,null),this._f.z1(a,null),a},d:function(a){var b=this._f.i1(a),c=this._h.i1(a),d=c.d(),e=null,f=c.a();null!=f?(e=f.d(),this._h.z1(a,f)):(e=new Ie(d._d+1),this._h.z1(a,this._d.ae(e))),d.aw(b),this._f.z1(a,e.ac(a))},b:function(a){var b=this._f.i1(a),c=this._h.i1(a),d=c.d(),e=null,f=c.b();null!=f?(e=f.d(),this._h.z1(a,f)):(e=new Ie(d._d-1),this._h.z1(a,this._d.ac(e))),d.aw(b),this._f.z1(a,e.ac(a))}});var Le={};Le.a1=function(a){return new Ae(a,null,null,null)},Le.a2=function(a){return new Ae(null,a,null,null)},Le.a3=function(a){return new Ae(null,null,a,null)},Le.a4=function(a){return new te(null,a,null,null)},Le.a5=function(a){return new te(null,null,a,null)},Le.a6=function(a){return new te(null,null,null,a)};var Me=function(){if(2===arguments.length){this._a=new oe,this._b=new oe,this._c=0;var a=arguments[0],b=arguments[1],c=new Ne(a._j2.gj(b)/2,0);this._a.ac(c),c=new Ne(a._j2.gj(b)/2,0),this._b.ac(c)}else this._a=arguments[1],this._b=arguments[2],this._c=arguments[3]};Jb.ext(Me,Object,{});var Ne=function(a,b){this._b=a,this._a=b};Jb.ext(Ne,Object,{});var Oe=function(){this._cx=!0,this._cs=new $e,this._ct=new Ye,this._cw=new Ze};Jb.ext(Oe,Object,{i5:function(a){this._cx=a},k:function(){var a=new _e(this);return this._cx&&(this._cs.w1(a),a=this._cs),this._cw.w1(a),a=this._cw,this._ct.w1(a),a=this._ct},i2:function(a){this.k().i2(a)},i1:function(a){return this.k().i1(a)}});var Pe=function(){Pe.superClass.constructor.call(this),this._jv=20,this._jw=40,this._jx=function(a,b){var c=a.a3(),d=b.a3(),e=c._g;return Math.floor(100*(e.g5(c)-e.g5(d)))}};Jb.ext(Pe,Oe,{i4:function(a){return he.a1(a)},i3:function(a){if(!this.i4(a))throw"Error";var b=he.a3(a);if(this._j2=a,this._j3=new Qe(a),mf.c(a),this._jy=a.xk(),!a.xb()){this.bu();var c=this._j3.c1();this.f(c),this.b(this._j3),this.c(this._j3)}for(var d;!b.ar();a.x3(d))d=b.c3(),mf.b(a.g2(d))},bu:function(){if(null!=this._jx)for(var a=this._j2.x9();a.i1();a.i2())a.i9().av(this._jx)},c:function(a){for(var b=this.a2(a),c=Ff.a(b.length),d=0;d<b.length;d++){for(var e=b[d],f=0,g=e.ah();g.i1();g.i2()){var h=g.i6();f=Math.max(f,this._j2.g9(h))}c[d]=f}for(var i=-this._jw,j=0;j<b.length;j++){i+=this._jw+c[j];for(var k=b[j],l=k.ah();l.i1();l.i2()){var m=l.i6();this._j2.s2(m,this._j2.g5(m),i-c[j]/2)}}},a2:function(a){for(var b=Ff.d(a.b()),c=0,d=a.b();d>c;c++)b[c]=new oe;

return a.c1(),this.a1(a.c1(),0,b),b},a1:function(a,b,c){c[b].ae(a);for(var d=a.aw();d.i1();d.i2())this.a1(d.i9(),b+1,c)},b:function(a){var b=a.c1();this._j2.s2(b,0,this._j2.g6(b)),this.g(b)},g:function(a){for(var b=a.aw();b.i1();b.i2()){var c=b.i9(),d=this._jy.i1(c);this._j2.s2(c,this._j2.g5(a)+d._c,this._j2.g6(c)),this.g(c)}},f:function(a){if(this._j3.c2(a))return void this._jy.z1(a,new Me(this,a));var b=a.aw(),c=b.i9();b.i2(),this.f(c);var d=this._jy.i1(c),e=new Me(this,d._a,d._b,0);if(!b.i1())return e._a.ac(new Ne(this._j2.gj(a)/2,0)),e._b.ac(new Ne(this._j2.gj(a)/2,0)),void this._jy.z1(a,e);for(;b.i1();){c=b.i9(),b.i2(),this.f(c),d=this._jy.i1(c);for(var f=e._b.ah(),g=d._a.ah(),h=2147483647,i=0,j=0;f.i1()&&g.i1();){var k=f.i6();f.i2();var l=g.i6();g.i2(),j+=k._a,i+=l._a,h=Math.min(h,i-j-k._b-l._b)}d._c=this._jv-h,i+=d._c;var m=d._b.am();if(m._a=d._c,f.i1()&&!g.i1())for(var n=j-this.a3(d._b);f.i1();n=0){var o=f.i6();f.i2(),d._b.ae(new Ne(o._b,o._a+n))}else if(!f.i1()&&g.i1()){var p=this.a3(e._a);for(p=i-p;g.i1();p=0){var q=g.i6();g.i2(),e._a.ae(new Ne(q._b,q._a+p))}}e._b=d._b}this._jy.z1(a,e);for(var r=-d._c/2,s=a.aw();s.i1();){var t=s.i9();s.i2();var u=this._jy.i1(t);u._c+=r;var v=u._b.am();v._a+=r,v=u._a.am(),v._a+=r}e._a.ac(new Ne(this._j2.gj(a)/2,0)),e._b.ac(new Ne(this._j2.gj(a)/2,0))},a3:function(a){for(var b=0,c=a.ah();c.i1();c.i2()){var d=c.i6();b+=d._a}return b}});var Qe=function(a){this._b=a,this.a()};Jb.ext(Qe,Object,{c1:function(){return null==this._a&&this.a(),this._a},b:function(){return null==this._a?-1:this.d(this._a)},d:function(a){for(var b=0,c=a.aw();c.i1();c.i2())b=Math.max(b,this.d(c.i9()));return b+1},c2:function(a){return 0===a.ao()},a:function(){for(var a=this._b.x9();a.i1();a.i2())if(0===a.i9().ak())return void(this._a=a.i9())}});var Re=function(a){this._d=0,this._e=0,this._f=0,this._a=0,this._b=0,this._g=a,this._c=new oe};Jb.ext(Re,Object,{a:function(){return this._d+this._e+this._f}});var Se=function(){Se.superClass.constructor.call(this),this._kl=340,this._km=360,this._kk=40,this._ko=.5};Jb.ext(Se,Oe,{ic:function(){return this._km},ia:function(){return this._kl},i9:function(){return this._ko},i3:function(a){if(!he.a1(a))throw"Error";this._a=a;var b=this.i8(),c=he.a4(a,b);mf.c(a),this._kn=Ff.d(a.x0());for(var d=a.x9();d.i1();d.i2()){var e=d.i9();e!==b?this.aa(e,new Re(this._kk+this.q(e.aq().i9()))):this.aa(e,new Re(this._kk))}this.s(b),a.s2(b,0,0),this.t(b);for(var f;!c.ar();a.x3(f))f=c.c3()},i4:function(a){return he.a1(a)},i0:function(a){return this._kn[a.al()]},i8:function(){return he.a2(this._a)},i7:function(a){for(var b,c=this.ib(a);;){if(b=this.i6(a),c>=b)break;for(var d=a.aw();d.i1();d.i2()){var e=d.i9();this.i0(e)._g*=1+this._ko}}var f=(c-b)/(2*a.ao());b=0;for(var g=a.aw();g.i1();g.i2()){var h=this.i0(g.i9());h._d+=f,h._e+=f,b+=h._d+h._e}this.id(a)},id:function(a){for(var b=Ff.d(a.ao()),c=0,d=a.ap();d.i1();)b[c]=d.i8(),d.i2(),c++;var e=this;b.sort(function(a,b){var c=a.a3(),d=b.a3(),f=e.i0(c).a()-e.i0(d).a();return f>0?1:f>=0?0:-1});for(var f=0;f<b.length;f++)this._a.h1(b[f]);for(var g=0;g<b.length;g+=2)this._a.u1(b[g]);for(c=b.length-1,c%2===0&&c--;c>0;c-=2)this._a.u1(b[c])},ib:function(a){return 0===a.ak()?this._km:2===a.ao()?Math.min(180,this._kl):this._kl},i6:function(a){for(var b=0,c=a.ap();c.i1();c.i2()){for(var d,e=c.i8(),f=e.a3(),g=this.i0(f),h=-g._g,i=g._b,j=g._c,k=0,l=k+1,m=j._b,n=m.d();l>k;l=(d.y-i)/(d.x-h))d=n,m=j.ai(m),n=m.d(),k=(n.y-d.y)/(n.x-d.x);for(g._d=180*-Math.atan(l)/Math.PI,k=0,l=k-1,m=j._b,n=m.d();m.a().d().x===n.x;n=m.d())m=m.a();for(var o;k>l;l=(o.y-i)/(o.x-h))o=n,m=j.aj(m),n=m.d(),k=(n.y-o.y)/(n.x-o.x);g._e=180*Math.atan(l)/Math.PI,b+=g._d+g._e}return b},aa:function(a,b){this._kn[a.al()]=b},p:function(a){var b=this.i0(a),c=new oe,d=2*this.q(a);c.aa(new Qd(0,0)),c.aa(new Qd(0,d)),c.aa(new Qd(d,d)),c.aa(new Qd(d,0)),b._c=c,b._a=d/2,b._b=d/2},r:function(a){if(0===a.ao())this.p(a);else{var b=this.i0(a),c=this.q(a),d=new oe;d.aa(new Qd(-c,-c)),d.aa(new Qd(-c,c)),d.aa(new Qd(c,-c)),d.aa(new Qd(c,c));for(var e=a.aw();e.i1();e.i2()){var f=this.i0(e.i9());d.az(f._c)}for(var g=df.h(d),h=Number.MAX_VALUE,i=Number.MAX_VALUE,j=Number.MIN_VALUE,k=Number.MIN_VALUE,l=g.ah();l.i1();l.i2()){var m=l.i6();m.x<h&&(h=m.x),m.x>j&&(j=m.x),m.y<i&&(i=m.y),m.y>k&&(k=m.y)}for(var n=new oe,o=g.ah();o.i1();o.i2()){var p=o.i6();n.aa(new Qd(p.x-h,p.y-i))}b._c=n,b._a=-h,b._b=-i}},s:function(a){if(0===a.ao())this.r(a);else{for(var b=a.aw();b.i1();b.i2())this.s(b.i9());this.i7(a);for(var c=0,d=a.aw();d.i1();d.i2()){var e=d.i9(),f=this.i0(e),g=180-(360-this.ib(a))/2-c-(f._e+f._f);c+=f.a(),g=g/180*Math.PI;for(var h=Math.sin(g),i=Math.cos(g),j=f._c._b;null!=j;j=j.a()){var k=j.d(),l=k.x+f._g,m=k.y-f._b,n=new Qd(l*i-h*m,l*h+i*m);j.c(n)}var o=f._a+f._g;f._a=o*i,f._b=o*h}this.r(a)}},t:function(a){var b=this._a.g4(a),c=0;if(a.ak()>0){var d=a.aq().i9(),e=this._a.g4(d);c=Math.PI+Math.atan2(e.y-b.y,e.x-b.x)}for(var f=a.aw();f.i1();f.i2()){var g=f.i9(),h=this.i0(g);if(0!==c){var i=Math.cos(c),j=Math.sin(c),k=h._a*i-j*h._b,l=h._a*j+i*h._b;h._a=k,h._b=l}this._a.s2(g,b.x+h._a,b.y+h._b),this.t(g)}},q:function(a){return 1.41*(Math.max(this._a.gj(a),this._a.g9(a))/2)}});var Te=function(){};Jb.ext(Te,Object,{i2:function(a){return a.ad()},i1:function(a){throw"Error"},i3:function(a){throw"Error"},i4:function(a){throw"Error"}});var Ue=function(a){this._a=a};Jb.ext(Ue,Object,{i2:function(a){for(var b=0,c=a.an();c.i1();c.i2())null!=this._a.i1(c.i9())&&b++;return b},i4:function(a){return null==this._a.i1(a)},i1:function(a){throw"Error"},i3:function(a){throw"Error"}});var Ve=function(){Ve.superClass.constructor.call(this),this._kq=!1,this._kp=90};Jb.ext(Ve,Se,{a:function(a,b){this._kr=b,this._ks=a,this._kq=!0},i7:function(a){if(!this.u(a))return void Ve.superClass.i7.call(this,a);for(var b=this.i9(),c=this.ib(a),d=(360-c)/2+c,e=new pe(a.ap());;){var f=this.i6(a);f=(360-c)/2;for(var g=null,h=null,i=e._b;null!=i;i=i.a()){var j=i.d(),k=j.a3(),l=this.i0(k),m=this._ks.i3(j),n=m-(f+l._e);if(n>=0&&m+l._d>=d&&(n=f+l.a()<=d?d-f-l.a():2*(d-(m+l._d))),l._f=0,n>=0)l._f=n,g=i,h=l;else{for(-n>l._d+l._e?n=(l._d+l._e)/2:n/=-2,f-=n,d>=f&&f+l.a()>d&&(f+=n,n=f+l.a()-d,f-=n);null!=g&&n>h._f;h=this.i0(g.d().a3()))if(n-=h._f,h._f=0,g=g.b(),null==g){h=null;break}null!=g?h._f-=n:f+=n}f+=l.a()}if(d>=f){for(var o=0,p=(360-c)/2,q=a.ap();q.i1();q.i2()){var r=q.i8(),s=r.a3(),t=this._ks.i3(r),u=this.i0(s),v=p+u._f+u._e;o<Math.abs(v-t)&&(o=Math.abs(v-t)),p+=u.a()}if(o<=this._kp)break}for(var w=a.aw();w.i1();w.i2()){var x=w.i9();this.i0(x)._g*=1+b}}},ib:function(a){return this.u(a)?0===a.ak()?this.ic():this.ia():Ve.superClass.ib.call(this,a)},u:function(a){return this._kq&&0!==a.ao()?null!=this._ks.i1(a.ag()):!1}});var We=function(a){this._a=a};Jb.ext(We,Object,{i1:function(a){return this._a.i1(a)},i2:function(a){throw"Error"},i3:function(a){throw"Error"},i4:function(a){throw"Error"}});var Xe=function(){};Jb.ext(Xe,Object,{w1:function(a){this._bb=a},w2:function(){return this._bb},w4:function(a){null!=this._bb&&this._bb.i2(a)},w3:function(a){return null!=this._bb?this._bb.i1(a):!0}});var Ye=function(){this._cg=45,this._ce=400,this._ch=400,this._cf=0};Jb.ext(Ye,Xe,{i1:function(a){if(null!=this.w2()){for(var b=!0,c=a.xk(),d=ae.a3(a,c),e=Ff.d(d),f=Ff.d(d),g=0;d>g;g++)e[g]=new He,f[g]=new pe;for(var h=a.xf();h.i1();h.i2()){var i=h.i8();f[c.i2(i.a2())].aa(i),a.h1(i)}for(var j=a.x9();j.i1();j.i2()){var k=j.i9();e[c.i2(k)].aa(k),a.h2(j.i9())}for(var l=0;d>l;l++){for(var m=e[l].x1();m.i1();m.i2())a.h3(m.i9());for(var n=f[l].c1();n.i1();n.i2())a.u1(n.i8());b=this.w3(a);for(var o=f[l].c1();o.i1();o.i2())a.h1(o.i8());for(var p=e[l].x1();p.i1();p.i2())a.h2(p.i9());if(!b)break}for(var q=0;d>q;q++)for(var r=e[q].x1();r.i1();r.i2())a.h3(r.i9());for(var s=0;d>s;s++)for(var t=f[s].c1();t.i1();t.i2())a.u1(t.i8());return a.xi(c),b}return!0},i2:function(a){if(!a.xb()){for(var b=a.xk(),c=ae.a3(a,b),d=Ff.d(c),e=Ff.d(c),f=Ff.d(c),g=Ff.d(c),h=0;c>h;h++)d[h]=new He,e[h]=new pe;for(var i=a.xf();i.i1();i.i2()){var j=i.i8();e[b.i2(j.a2())].aa(j),a.h1(j)}for(var k=a.x9();k.i1();k.i2()){var l=k.i9();d[b.i2(l)].aa(l),a.h2(k.i9())}for(var m=0;c>m;m++){for(var n=d[m].x1();n.i1();n.i2())a.h3(n.i9());for(var o=e[m].c1();o.i1();o.i2())a.u1(o.i8());this.w4(a);var p=a.g3();f[m]=new Td(p.x,p.y,p.width,p.height);var q={};if(g[m]=q,this._cf>0){var r=this._cg+Math.ceil((p.width+1)/this._cf)*this._cf,s=this._cg+Math.ceil((p.height+1)/this._cf)*this._cf;q.x=p.x,q.y=p.y,q.width=r,q.height=s}else q.x=p.x,q.y=p.y,q.width=p.width+this._cg,q.height=p.height+this._cg;for(var t=e[m].c1();t.i1();t.i2())a.h1(t.i8());for(var u=d[m].x1();u.i1();u.i2())a.h2(u.i9())}for(var v=0;c>v;v++)for(var w=d[v].x1();w.i1();w.i2())a.h3(w.i9());for(var x=0;c>x;x++)for(var y=e[x].c1();y.i1();y.i2())a.u1(y.i8());if(mf.a(g,null,this._ce/this._ch),this._cf<=0)for(var z=0;z<g.length;z++)this.w5(a,d[z],e[z],new Qd(g[z].x,g[z].y),f[z]);else for(var A=0;A<g.length;A++){var B=Math.floor((g[A].x-f[A].x)/this._cf)*this._cf,C=Math.floor((g[A].y-f[A].y)/this._cf)*this._cf,D=f[A].x+B,E=f[A].y+C;this.w5(a,d[A],e[A],new Qd(D,E),f[A])}a.xi(b)}},w5:function(a,b,c,d,e){for(var f=-e.x+d.x,g=-e.y+d.y,h=b.x1();h.i1();h.i2()){var i=a.ga(h.i9());a.s4(h.i9(),new Qd(i.x+f,i.y+g))}for(var j=c.c1();j.i1();j.i2()){for(var k=j.i8(),l=new md,m=a.gp(k).c();m.i1();m.i2()){var n=m.i6();l.add(new Qd(n.x+f,n.y+g))}a.s5(k,new Vd(l))}}});var Ze=function(){};Jb.ext(Ze,Xe,{i1:function(a){return this.w3(a)},i2:function(a){this.w7(a),null!=this.w2()&&this.w4(a),this.w6(a)},w7:function(a){this.e(a),this.k(a),this.i(a)},e:function(a){for(var b=a.x9();b.i1();b.i2()){var c=a.g4(b.i9());a.s1(b.i9(),c)}},w6:function(a){this.l(a),this.j(a),this.f(a)},l:function(a){for(var b=a.x9();b.i1();b.i2()){var c=a.g4(b.i9());a.s1(b.i9(),c)}},j:function(a){for(var b=a.xf();b.i1();b.i2()){var c=a.g7(b.i8()),d=c.i6();c.i8(d),d=c.i7(),c.i9(d);for(var e=0;e<c.i1();e++){var f=c.i2(e);c.i3(e,f.x,f.y)}}},k:function(a){for(var b=a.xf();b.i1();b.i2()){var c=a.g7(b.i8()),d=c.i6();c.i8(d),d=c.i7(),c.i9(d);for(var e=0;e<c.i1();e++){var f=c.i2(e);c.i3(e,f.x,f.y)}}},f:function(a){null!=this._ca&&(a.x1("A",this._ca),this._ca=null,this._b6=null),null!=this._b8&&(a.x1("B",this._b8),this._b8=null,this._b9=null)},i:function(a){this._ca=a.xc("A"),null!=this._ca&&(this._b6=new We(this._ca),a.x1("A",this._b6)),this._b8=a.xc("B"),null!=this._b8&&(this._b9=new We(this._b8),a.x1("B",this._b9))}});var $e=function(){this._a=new pe,this._c=10};Jb.ext($e,Xe,{i2:function(a){this._b=a.xl(),this.w9(a),this.w4(a),this.c(a),this.w8(a,this._b),a.xj(this._b)},i1:function(a){if(null==this.w2())return!0;this._b=a.xl(),this.w9(a);var b=this.w3(a);return this.c(a),a.xj(this._b),b},w8:function(a,b){for(var c=a.xf();c.i1();c.i2()){var d=c.i8();if(null!=b.i1(d)){var e=b.i1(d);mf.g(a,d,e,this._c)}}},w9:function(a){for(var b=a.xk(),c=a.x9();c.i1();c.i2()){for(var d=c.i9(),e=d.af();e.i1();e.i2()){var f=e.i8(),g=f.a1(d),h=b.i1(g);if(h!==f)if(null==h)b.z1(g,f);else{null==this._b.i1(h)&&this._b.i8(h,new pe);var i=this._b.i1(h);i.aa(f),this._a.ac(f),a.h1(f)}}for(var j=d.af();j.i1();j.i2()){var k=j.i8(),l=k.a1(d);b.z1(l,null)}}a.xi(b)},c:function(a){for(;!this._a.ar();a.u1(this._a.c3()));}});var _e=function(a){this._a=a};Jb.ext(_e,Object,{i2:function(a){this._a.i3(a)},i1:function(a){return this._a.i4(a)}});var af=function(){af.superClass.constructor.call(this),this._jo=30,this._jp=new ef,this._jt=5};Jb.ext(af,Oe,{i4:function(a){return!0},i3:function(a){this._ju=a,mf.c(a);for(var b=this._jp.i1(a),c=0,d=a.x9();d.i1();d.i2())c=Math.max(c,this.e(d.i9()));c<this._jt&&(c=this._jt),this.a(b,c)},a:function(a,b){var c=a.i7(),d=2*Math.PI/c,e=0,f=Ff.a(c);a.i4();for(var g=0;c>g;)f[g]=this.e(a.i9())+this._jo,e+=f[g],g++,a.i2();var h=e/c,i=e/(2*Math.PI);b>i&&(i=b),a.i4();for(var j=0,k=0;c>k;){var l=d/h*f[k];j+=l/2;var m=Math.cos(j)*i,n=Math.sin(j)*i;j+=l/2,this._ju.s2(a.i9(),m,n),k++,a.i2()}return i},e:function(a){var b=this._ju.gj(a),c=this._ju.g9(a);return c>=b?c:b}});var bf=function(){bf.superClass.constructor.call(this),this._jm=new af,this._jk=new Ve};Jb.ext(bf,Oe,{i4:function(a){return!0},i3:function(a){if(!(a.x0()<2)){this._jn=a,mf.c(this._jn),mf.e(this._jn);var b=new kf(this._jn);b.a1(),b.h();var c=new Je(this._jn);c.a();for(var d=b.x9();d.i1();d.i2()){var e=d.i9(),f=b.c2(e);if(f.ay()>1){var g=b.d1(e);Je.h(this._jn,g.c1()),this._jm.i3(this._jn);var h=this._jn.g3();b.s7(e,h.width,h.height)}else if(1===f.ay()){var i=f.x2();b.s8(e,this._jn.gm(i)),this._jn.s2(i,0,0)}else b.s7(e,1,1);Je.i(this._jn,this._jn.xf())}c.b();var j=this.a7(b);he.a4(b,j);var k=b.xk(),l=b.xl();this.a2(b,l,k),this.a1(b,l),this.a3(b,j,l),this._jk.a(l,k),this._jk.i3(b),this.a5(b,j,k);for(var m=b.x9();m.i1();m.i2())for(var n=m.i9(),o=b.g4(n),p=b.c2(n).x1();p.i1();p.i2()){var q=p.i9();this._jn.s2(q,o.x+this._jn.g5(q),o.y+this._jn.g6(q))}}},a7:function(a){for(var b=-1,c=null,d=a.x9();d.i1();d.i2()){var e=d.i9();a.c2(e).ay()>b&&(c=e,b=a.c2(e).ay())}return c},a1:function(a,b){for(var c=function(a,c){var d=b.i3(a)-b.i3(c);return d>0?1:d>=0?0:-1},d=a.x9();d.i1();d.i2())d.i9().av(c)},a2:function(a,b,c){for(var d=Ff.a(this._jn.x0()),e=a.x9();e.i1();e.i2())for(var f=e.i9(),g=a.c2(f),h=g.x1();h.i1();h.i2()){var i=h.i9();d[i.al()]=f.al()}var j=he.a2(a);this.a4(a,j,d,b,c)},a3:function(a,b,c){if(a.c2(b).ay()>1){for(var d=0,e=0,f=0,g=b.ap();g.i1();g.i2()){var h=g.i8(),i=c.i3(h);i-d>e&&(e=i-d,f=(d+i)/2),d=i}360-d>e&&(f=(360+d)/2),this.a6(a,b,f);for(var j=b.ap();j.i1();j.i2()){var k=j.i8(),l=c.i3(k);for(l-=f;0>l;l+=360);c.i6(k,l)}b.av(function(a,b){var d=c.i3(a)-c.i3(b);return d>0?1:d>=0?0:-1})}},a4:function(a,b,c,d,e){for(var f=b.al(),g=e.i3(b),h=b.ap();h.i1();h.i2()){for(var i=h.i8(),j=a.b(i),k=0,l=0,m=0,n=0,o=j.c1();o.i1();o.i2()){var p=o.i8(),q=null,r=null;c[p.a2().al()]===f?(q=p.a2(),r=p.a3()):(q=p.a3(),r=p.a2()),m-=this._jn.g5(q),n+=this._jn.g6(q),k-=this._jn.g5(r),l+=this._jn.g6(r)}if(0!==m||0!==n){var s;for(s=180*Math.atan2(n,m)/Math.PI-g;0>s;s+=360);d.i6(i,s)}if(0!==k&&0!==l){var t=180*Math.atan2(l,k)/Math.PI;0>t&&(t+=360),e.i6(i.a3(),t)}this.a4(a,i.a3(),c,d,e)}},a5:function(a,b,c){for(var d=a.g4(b),e=b.ap();e.i1();e.i2()){var f=e.i8(),g=f.a3(),h=a.g4(g),i=h.x-d.x,j=h.y-d.y,k=180*Math.atan2(j,i)/Math.PI;if(null!=c.i1(g)){var l=c.i3(g);k+=l}this.a6(a,g,k),this.a5(a,g,c)}},a6:function(a,b,c){c=c/180*Math.PI;var d=a.c2(b);if(!(d.ay()<=1))for(var e=d.x1();e.i1();e.i2()){var f=e.i9(),g=this._jn.g5(f),h=this._jn.g6(f),i=Math.cos(c),j=Math.sin(c),k=g*i-j*h,l=g*j+i*h;this._jn.s2(f,k,l)}}});var cf=function(){this._a=(new Date).getTime()};Jb.ext(cf,Object,{b:function(){return(new Date).getTime()-this._a}});var df={};df._A=new Qd(0,0),df.b=function(a,b,c){return df.c(a.x,a.y,b.x,b.y,c.x,c.y)},df.c=function(a,b,c,d,e,f){c-=a,d-=b,e-=a,f-=b;var g=e*d-f*c;return Math.abs(g)<1e-5?0:g>=0?0>=g?0:-1:1},df.d=function(a,b,c){return df.b(a,b,c)>0},df.f=function(a,b,c){return df.b(a,b,c)<0},df.g=function(a,b,c){return 0===df.b(a,b,c)},df.h=function(a){return df.i(a)},df.i=function(a){var b=new oe(a.ah()),c=new oe;if(b.a2(),b.ar())return c;var d=b.at();for(c.ae(d);!b.ar()&&d.equals(b.am());b.at());if(b.ar())return c;d=b.at();for(var e=c.ae(d),f=b.ah();f.i1();f.i2()){var g=f.i6();if(!g.equals(d))if(d=g,2===c.ay()&&df.g(c.am(),c.as(),g))e.c(g);else{var h;for(h=e;!df.f(c.ai(h).d(),h.d(),g);h=c.ai(h));var i;for(i=e;!df.d(c.aj(i).d(),i.d(),g);i=c.aj(i));for(;i!==c.aj(h);c.aw(c.aj(h)));e=c.an(g,h)}}return c},df.j=function(){return df.k(Number.MAX_VALUE)},df.k=function(a){return Math.floor(Math.random()*a)},df.l=function(a,b){return Math.random()*(b-a)+a};var ef=function(){};Jb.ext(ef,Object,{i1:function(a){this._b=a;var b=new pe;b=ae.a6(a),b.az(ae.a7(a));for(var c=this.a1();!b.ar();a.x5(b.c3()));return c.x1()},a1:function(){if(this._b.x0()<3)return new He(this._b.x9());for(var a=this._b.xk(),b=this._b.xk(),c=this._b.xl(),d=new Ke(this._b,new Te,0,this.a3(this._b)),e=this._b.x0(),f=new pe,g=new pe,h=new Je(this._b);e>3;e--){for(var i=d.g(),j=i.an();j.i1();j.i2())a.z1(j.i9(),e),b.i5(j.i9(),!1);for(var k=i.an();k.i1();k.i2())for(var l=k.i9(),m=l.ap();m.i1();m.i2()){var n=m.i8();a.i2(n.a3())===e&&(g.aa(n),b.i5(n.a2(),!0),b.i5(n.a3(),!0))}if(g.ay()<i.ad()-1){for(var o=null,p=i.an();p.i1();p.i2()){var q=p.i9();if(a.i2(q)===e&&!b.i4(q))if(null==o)o=q;else{var r=this._b.xo(o,q);c.i7(r,!0),g.aa(r),o=null}}if(null!=o)for(var s=i.an();s.i1();s.i2()){var t=s.i9();if(t!==o&&null==t.aj(o)){var u=this._b.xo(o,t);c.i7(u,!0),g.aa(u);break}}if(g.ay()<i.ad()-1){for(var v=2147483647,w=null,x=i.an();x.i1();x.i2()){var y=x.i9();y.ad()<v&&(w=y,v=y.ad())}for(var z=i.an();z.i1();z.i2()){var A=z.i9();if(null==w.aj(A)&&w!==A){var B=this._b.xo(w,A);if(c.i7(B,!0),g.aa(B),g.ay()>=i.ad()-1)break}}}}for(var C=i.an();C.i1();C.i2())d.b(C.i9());for(var D=g.c1();D.i1();D.i2()){var E=D.i8();c.i4(E)&&(d.d(E.a2()),d.d(E.a3()))}f.az(g),h.e(i)}h.b(),d.c();for(var F=f.c1();F.i1();F.i2()){var G=F.i8();null!=G._h&&(c.i4(G)?this._b.x5(G):this._b.h1(G))}var H=this.a4(this._b),I=new He,J=H.ak(0),K=H.ak(1),L=null;L=J.a2()===K.a2()||J.a2()===K.a3()?J.a3():J.a2(),I.aa(L);for(var M=H.c1();M.i1();M.i2()){var N=M.i8();L=N.a1(L),I.aa(L)}for(var O=f.c1();O.i1();O.i2()){var P=O.i8();c.i4(P)||null!=P._h||this._b.u1(P)}return this._b.xi(b),this._b.xj(c),this._b.xi(a),this.a2(I),I},a2:function(a){if(a.ay()<this._b.x0()){for(var b=this._b.xk(),c=a._b;null!=c;c=c.a()){var d=c.d();b.z1(d,c)}var e;for(e=new Ke(this._b,new Ue(b),0,a.ay(),new Ue(b));!e.e();){for(var f=e.f(),g=f.an();g.i1();g.i2()){var h=g.i9();if(null!=b.i1(h)){var i=b.i1(h),j=a.ai(i).d(),k=null;k=null!=f.aj(j)?a.ao(f,i):a.an(f,i),b.z1(f,k);break}}for(var l=f.an();l.i1();l.i2()){var m=l.i9();null==b.i1(m)&&e.d(m)}}this._b.xi(b),e.c()}},a3:function(a){for(var b=0,c=a.x9();c.i1();c.i2())b=Math.max(b,c.i9().ad());return b},a4:function(a){for(var b=[],c=0,d=a.x0();d>c;c++)b[c]=new fe;var e=new de(b);e.a6(!1),e.a8(a);for(var f=-1,g=null,h=a.x9();h.i1();h.i2()){var i=h.i9(),j=b[i.al()];j._a+j._c>f&&(f=j._a+j._c,g=i)}for(var k=new pe,l=g,m=b[l.al()]._d;null!=m;m=b[l.al()]._d)k.ac(m),l=m.a1(l);l=g;for(var n=b[l.al()]._b;null!=n;n=b[l.al()]._d)k.ae(n),l=n.a1(l);return k}});var ff=function(){this._v=new qe,this._x=new qe,this._z=new Be(3,5),this._w=new Be(3,5),this._y=!1,this._u=!1,this._t={}};Jb.ext(ff,Object,{xm:function(){var a=new Ce(this);return a},xo:function(a,b){return this.xn(a,null,b,null,0,0)},xn:function(a,b,c,d,e,f){return new we(this,a,b,c,d,e,f)},x4:function(a){this.b3(a)},b3:function(a){for(var b;null!=(b=a._o[0]);)this.x5(b);for(;null!=(b=a._o[1]);)this.x5(b);this._v.c(a),a._g=null,this._y=!0},x5:function(a){this.a11(a)},a11:function(a){if(a._h!==this)throw"Error";var b=a.a2(),c=a.a3();this.a12(a,b,c),this._x.c(a),a._h=null,this._u=!0},x7:function(a){a._p=this._v._c,a._g=this,a.ac(),a._c.length<this._z._b&&this._z.a3(a,a._c.length,this._z._b),this._v.a(a),this._y=!0},x8:function(a){if(null!=a._h)throw"Error";a._c.length<this._w._b&&this._w.a3(a,a._c.length,this._w._b),null==a._a||a._a._h!==this?this._x.a(a):this._x.b(a,a._a),a._h=this,a.a4(),this.b2(a,a.a2(),null,a.a3(),null,0,0),this._u=!0},xr:function(a,b,c){var d=a.a2(),e=a.a3();null==a._h?(a._d=b,a._e=c):(d!==b&&(d.ar(a,0,0),a._d=b,b.ab(a,null,0,0,0)),e!==c&&(e.ar(a,1,1),a._e=c,c.ab(a,null,1,1,0)))},x3:function(a){this.xr(a,a.a3(),a.a2())},h1:function(a){this.a11(a)},u1:function(a){this.x8(a)},h2:function(a){this.x4(a)},h3:function(a){this.x7(a)},xa:function(){return this._v._c},x0:function(){return this._v._c},xh:function(){return this._x._c},xg:function(){return this._x._c},xb:function(){return 0===this._v._c},xq:function(a){return a._g===this},xp:function(a){return a._h===this},xd:function(){return this._v._a},x9:function(){return new Ge(this._v)},xf:function(){return new Ge(this._x)},x2:function(a,b){var c=Ff.d(this.xh());if(null!=a&&null!=b)for(var d=this.x9();d.i1();d.i2())d.i9().at(a,1,c),d.i9().at(b,0,c);else if(null==b&&null!=a)for(var e=this.x9();e.i1();e.i2())e.i9().at(a,1,c);else if(null!=b&&null==a)for(var f=this.x9();f.i1();f.i2())f.i9().at(b,0,c)},xk:function(){return this._z.b(this._v)},xl:function(){return this._w.c(this._x)},xi:function(a){this._z.a5(a,this._v)},xj:function(a){this._w.a6(a,this._x)},xc:function(a){return this._t[a]},x1:function(a,b){this._t[a]=b},x6:function(a){delete this._t[a]},b2:function(a,b,c,d,e,f,g){b.ab(a,c,0,0,f),d.ab(a,e,1,1,g)},a12:function(a,b,c){b.ar(a,0,0),c.ar(a,1,1)},c:function(){for(var a=0,b=this.x9();b.i1();b.i2())b.i9()._p=a++;this._y=!1},b1:function(){for(var a=0,b=this.xf();b.i1();b.i2())b.i8()._g=a++;this._u=!1},xs:function(a){a.as(this,this._z._b),a._p=this._v._c,this._v.a(a)},xt:function(a,b,c,d,e,f,g){a.a6(this,b,d,this._w._b),a._g=this._x._c,this._x.a(a),this.b2(a,a.a2(),c,a.a3(),e,f,g)}});var gf=function(){gf.superClass.constructor.call(this)};Jb.ext(gf,ff,{gb:function(a){return this.g1(a)},g7:function(a){return this.g2(a)},g5:function(a){var b=this.g1(a);return b.i1()+b.i3()/2},g6:function(a){var b=this.g1(a);return b.i2()+b.i4()/2},g4:function(a){return new Qd(this.g5(a),this.g6(a))},gi:function(a){return this.g1(a).i1()},gh:function(a){return this.g1(a).i2()},ga:function(a){var b=this.g1(a);return new Qd(b.i1(),b.i2())},gj:function(a){return this.g1(a).i3()},g9:function(a){return this.g1(a).i4()},gm:function(a){return new Rd(this.gj(a),this.g9(a))},s1:function(a,b){this.s2(a,b.x,b.y)},s2:function(a,b,c){var d=this.g1(a);d.i5(b-d.i3()/2,c-d.i4()/2)},s7:function(a,b,c){this.g1(a).i6(b,c)},s8:function(a,b){this.s7(a,b.width,b.height)},s3:function(a,b,c){this.g1(a).i5(b,c)},s4:function(a,b){this.s3(a,b.x,b.y)},gp:function(a){for(var b=this.g2(a),c=new md,d=0;d<b.i1();d++)c.add(b.i2(d));return new Vd(c)},gf:function(a){for(var b=this.g2(a),c=new oe,d=0;d<b.i1();d++)c.aa(b.i2(d));return c},gc:function(a){var b=new md;b.add(this.gs(a));for(var c=this.gp(a).d();c.i1();c.i2())b.add(c.i6());return b.add(this.gl(a)),new Vd(b)},gd:function(a){var b=new oe;b.aa(this.gs(a));for(var c=this.gp(a).d();c.i1();c.i2())b.aa(c.i6());return b.aa(this.gl(a)),b},m1:function(a,b){var c=this.g2(a);c.i5();var d=b.ah(),e=d.i6();this.gx(a,e);var f=b.as();for(d.i2();d.i6()!==f;d.i2()){var g=d.i6();c.i4(g.x,g.y)}this.gy(a,f)},s5:function(a,b){var c=this.g2(a);c.i5();for(var d=b.d();d.i1();d.i2()){var e=d.i6();c.i4(e.x,e.y)}},s6:function(a,b){var c=this.g2(a);c.i5();for(var d=b.ah();d.i1();d.i2()){var e=d.i6();c.i4(e.x,e.y)}},m2:function(a,b,c){this.gx(a,b),this.gy(a,c)},gn:function(a){return this.g2(a).i6()},gk:function(a){return this.g2(a).i7()},gt:function(a,b){this.g2(a).i8(b)},gz:function(a,b){this.g2(a).i9(b)},gs:function(a){var b=this.g2(a).i6();if(null==b)return this.g4(a.a2());var c=new Qd(this.g5(a.a2())+b.x,this.g6(a.a2())+b.y);return c},gl:function(a){var b=this.g2(a).i7();if(null==b)return this.g4(a.a3());var c=new Qd(this.g5(a.a3())+b.x,this.g6(a.a3())+b.y);return c},gx:function(a,b){var c=new Qd(b.x-this.g5(a.a2()),b.y-this.g6(a.a2()));this.g2(a).i8(c)},gy:function(a,b){var c=new Qd(b.x-this.g5(a.a3()),b.y-this.g6(a.a3()));this.g2(a).i9(c)},g8:function(){for(var a=new pe,b=this.xf();b.i1();b.i2())a.aa(b.i8());return a},g3:function(){for(var a,b,c=a=Number.MAX_VALUE,d=b=Number.MIN_VALUE,e=this.x9();e.i1();e.i2()){var f=this.ga(e.i9()),g=this.gm(e.i9());c=Math.min(f.x,c),a=Math.min(f.y,a),d=Math.max(f.x+g.width,d),b=Math.max(f.y+g.height,b)}for(var h=this.xf();h.i1();h.i2())for(var i=this.gp(h.i8()).c();i.i1();i.i2()){var j=i.i6();c=Math.min(j.x,c),a=Math.min(j.y,a),d=Math.max(j.x,d),b=Math.max(j.y,b)}return{x:Math.floor(c),y:Math.floor(a),width:Math.floor(d-c),height:Math.floor(b-a)}}});var hf=function(){hf.superClass.constructor.call(this),this.a(new _d,new Zd)};Jb.ext(hf,gf,{a:function(a,b){this._a3=a,this._a4=b},xo:function(a,b){return this.l2(a,b,this._a4.a6())},l2:function(a,b,c){return this.l1(a,null,b,null,0,0,c)},xn:function(a,b,c,d,e,f){return this.l1(a,b,c,d,e,f,this._a4.a6())},l1:function(a,b,c,d,e,f,g){var h=new we(this,a,b,c,d,e,f);return h._l=g,h},xm:function(){var a=new Ce(this);return a._r=this._a3.m3(),a},g3:function(){for(var a={x:0,y:0,width:-1,height:-1},b=this.x9();b.i1();b.i2())b.i9()._r.m1(a);return a},g1:function(a){return a._r},g2:function(a){return a._l},g5:function(a){return a._r.m4()},g6:function(a){return a._r.m5()},gi:function(a){return a._r.i1()},gh:function(a){return a._r.i2()},gj:function(a){return a._r.i3()},g9:function(a){return a._r.i4()},s2:function(a,b,c){a._r.m6(b,c)},s7:function(a,b,c){a._r.i6(b,c)},s3:function(a,b,c){a._r.i5(b,c)}});var jf=function(){jf.superClass.constructor.call(this),this._ap=this.xk(),this._as=this.xl()};Jb.ext(jf,gf,{g1:function(a){var b=this._ap.i1(a);return null==b&&(b=new ze,this._ap.z1(a,b)),b},g2:function(a){var b=this._as.i1(a);return null==b&&(b=new ye,this._as.i8(a,b)),b}});var kf=function(a){kf.superClass.constructor.call(this),this._ay=a,this._a0=this.xk(),this._au=this.xl()};Jb.ext(kf,jf,{c2:function(a){var b=this._a0.i1(a);return b},a2:function(a,b){this._a0.z1(a,b)},h:function(){null==this._az&&(this._az=this.xk());for(var a=Ff.a(this._ay.x0()+1),b=1,c=this.x9();c.i1();){for(var d=this.c2(c.i9()),e=d.x1();e.i1();e.i2()){var f=e.i9();a[f.al()]=b}for(var g=new pe,h=d.x1();h.i1();h.i2())for(var i=h.i9(),j=a[i.al()],k=i.ap();k.i1();k.i2()){var l=k.i8(),m=l.a3(),n=a[m.al()];n===j&&g.ac(l)}this._az.z1(c.i9(),g),c.i2(),b++}},d1:function(a){return this._az.i1(a)},b:function(a){return this._au.i1(a)},a3:function(a,b){this._au.i8(a,b)},a1:function(){var a=this._ay.xk(),b=Le.a4(Ff.a(this._ay.xh())),c=ae.a1(this._ay,b,a),d=ae.a5(this._ay,b,c);this.d2(a,d),this._ay.xi(a)},c1:function(a){for(var b=null,c=-1,d=0,e=a.length;e>d;d++){var f=a[d];f.ay()>c&&(b=f,c=f.ay())}return b},d2:function(a,b){for(var c=this._ay.xl(),d=this._ay.xk(),e=b.length,f=0;e>f;f++)for(var g=b[f],h=g.c1();h.i1();h.i2())c.i8(h.i8(),g);var i=this.c1(b);this.a4(i,a,c,new md,d);var j={};e=b.length;for(var k=0;e>k;k++){var l=b[k];if(l.ay()>1){var m=this.xm();j[l._id]=m}}for(var n=this._ay.x9();n.i1();n.i2()){var o=n.i9();if(a.i4(o)&&null==d.i1(o)){var p=this.xm();j[o._id]=p;var q=new He;q.aa(o),this.a2(p,q)}}var r=Ff.d(2);e=b.length;for(var s=0;e>s;s++){var t=b[s];if(1===t.ay()){var u=t.c2();r[0]=u.a2(),r[1]=u.a3();for(var v=0;2>v;v++){var w=r[v];if(1===w.ad()){var x=this.xm();j[w._id]=x;var y=new He;y.aa(w),this.a2(x,y)}}}}for(var z=this._ay.x9();z.i1();z.i2()){var A=z.i9();if(null!=d.i1(A))for(var B=d.i1(A),C=j[B._id],D=A.af();D.i1();D.i2()){var E=D.i8();if(c.i1(E)!==B){var F=j[c.i1(E)._id];if(null==F){var G=E.a1(A),H=d.i1(G);F=null!=H?j[H._id]:j[G._id]}var I=C.aj(F),J=null;null==I?(I=this.xo(C,F),J=new pe):J=this.b(I),J.aa(E),this.a3(I,J)}}else if(a.i4(A))for(var K=j[A._id],L=A.af();L.i1();L.i2()){var M=L.i8(),N=M.a1(A),O=j[N._id];if(null!=O){var P=K.aj(O);if(null==P){var Q=this.xo(K,O),R=new pe;R.aa(M),this.a3(Q,R)}}}}if(2===this._ay.x0()&&1===this._ay.xg()){var S=this._ay.xf().i8(),T=j[S.a2()._id],U=j[S.a3()._id];if(null!=U&&null!=T&&null==U.aj(T)){var V=this.xo(T,U),W=new pe;W.aa(S),this.a3(V,W)}}var X=Ff.a(this._ay.x0()),Y=1;e=b.length;for(var Z=0;e>Z;Z++){var $=b[Z],_=j[$._id];if(null!=_){var aa=this.c2(_);null==aa&&(aa=new He,this.a2(_,aa));for(var ba=$.c1();ba.i1();ba.i2()){var ca=ba.i8(),da=ca.a2();X[da.al()]===Y||a.i4(da)&&d.i1(da)!==$||(X[da.al()]=Y,aa.aa(da)),da=ca.a3(),X[da.al()]===Y||a.i4(da)&&d.i1(da)!==$||(X[da.al()]=Y,aa.aa(da))}}}this._ay.xj(c),this._ay.xi(d)},a4:function(a,b,c,d,e){if(!d.contains(a)){d.add(a);for(var f=[],g=a.c1();g.i1();g.i2()){var h=g.i8();f[0]=h.a2(),f[1]=h.a3();for(var i=0;2>i;i++){var j=f[i];if(b.i4(j)&&null==e.i1(j)){a.ay()>1&&e.z1(j,a);for(var k=j.af();k.i1();k.i2()){var l=c.i1(k.i8());this.a4(l,b,c,d,e)}}}}}}});var lf=function(a,b,c,d,e){this._a={},lf.superClass.constructor.call(this);var f,g,h=new md;for(f=0,g=b.size();g>f;f++){var i=b.get(f);if(i instanceof Ib.Link)h.add(i);else{var j=d&&null==e&&i instanceof Ld;j&&i.setExpanded(!0);var k=a.getDimension(i);if(j&&i.setExpanded(!1),null==k)continue;var l=this.xm(),m=a._repulsion;"rightleft"===c||"leftright"===c?this.s7(l,k.height*m,k.width*m):this.s7(l,k.width*m,k.height*m),l.node=i,this._a[i.getId()]=l}}for(f=0,g=h.size();g>f;f++){var n=h.get(f),o=n.getFromAgent(),p=n.getToAgent(),q=this._a[o.getId()],r=this._a[p.getId()];null!=q&&null!=r&&q!==r&&this.xo(q,r)}};Jb.ext(lf,hf,{});var mf={};mf._D=new Vd,mf._E=new Qd(0,0),mf.b=function(a){if(a.i1()>0){for(var b=new md,c=a.i1()-1;c>=0;c--)b.add(a.i2(c));a.i5();for(var d=0,e=b.size();e>d;d++){var f=b.get(d);a.i4(f.x,f.y)}}var g=a.i6();a.i8(a.i7()),a.i9(g)},mf.c=function(a){mf.d(a,!0)},mf.d=function(a,b){if(b)for(var c=a.xf();c.i1();c.i2()){var d=c.i8();a.gt(d,mf._E),a.gz(d,mf._E),a.s5(d,mf._D)}else for(var e=a.xf();e.i1();e.i2())a.s5(e.i8(),mf._D)},mf.e=function(a){for(var b=new Qd(0,0),c=a.xf();c.i1();c.i2()){var d=c.i8();a.gt(d,b),a.gz(d,b)}},mf.f=function(a,b,c,d){for(var e=a.gc(b).b(),f=Ff.d(e),g=0,h=a.gc(b).c();h.i1();h.i2()){var i=h.i6();(0>=g||!i.equals(f[g-1]))&&(f[g]=new Qd(i.x,i.y),g++)}if(e=g,!(2>e)){var j=new md,k=new Sd(f[1].x-f[0].x,f[1].y-f[0].y),l=mf.i(k);l.x*=d,l.y*=d;for(var m=mf.h(f[0],l),n=mf.h(f[1],l),o=new Ud(m,n),p=1;e-1>p;p++){var q=o,r=mf.i(new Sd(f[p+1].x-f[p].x,f[p+1].y-f[p].y));r.x*=d,r.y*=d;var s=mf.h(f[p],r),t=mf.h(f[p+1],r);o=new Ud(s,t);var u=Ud.a6(q,o);null!=u&&j.add(new Qd(u.x,u.y))}var v=new Sd(f[e-1].x-f[e-2].x,f[e-1].y-f[e-2].y);v=mf.i(v),v.x*=d,v.y*=d;var w=mf.h(f[e-1],v),x=new Vd(j);b.a2()===c.a2()?(a.s5(c,x),a.m2(c,m,w)):(a.s5(c,x.a()),a.m2(c,w,m))}},mf.g=function(a,b,c,d){for(var e=d,f=c.c1();f.i1();f.i2()){var g=f.i8();mf.f(a,b,g,e),0>e&&(e-=d),e=-e}},mf.a=function(a,b,c){return mf.j(a,b,c,1)},mf.l=function(a,b,c){if(null==a||a.length<1)return null!=b&&(b.x=0,b.y=0,b.width=0,b.height=0),{width:0,height:0};for(var d=0,e=0,f=0;f<a.length;f++){var g=a[f];d=Math.max(d,g.width),e=Math.max(e,g.height)}var h,i,j=d*e*a.length,k=Math.sqrt(j/c),l=j/k,m=Math.floor(l/d),n=Math.ceil(l/d),o=Math.ceil(a.length/m),p=Math.ceil(a.length/n);n*p>m*o?(h=m,i=o):(h=n,i=p);var q,r=0,s=0,t=0,u=0;if(d>e)for(var v=0;v<a.length;v++)q=a[v],q.x=s*d,q.y=r*e,t=Math.max(t,q.x+q.width),u=Math.max(u,q.y+q.height),++s>=h&&(r++,s=0);else for(var w=0;w<a.length;w++)q=a[w],q.x=s*d,q.y=r*e,t=Math.max(t,q.x+q.width),u=Math.max(u,q.y+q.height),++r>=i&&(s++,r=0);return null!=b&&(b.x=0,b.y=0,b.width=t,b.height=u),{width:i,height:h}},mf.j=function(a,b,c,d){if(null==a||a.length<1)return null!=b&&(b.x=0,b.y=0,b.width=0,b.height=0),0;for(var e,f,g=e=a[0].width,h=f=a[0].height,i=a.length,j=1;i>j;j++){var k=a[j].width;g=Math.min(g,k),e=Math.max(e,k);var l=a[j].height;h=Math.min(h,l),f=Math.max(f,l)}if(h/f>.95&&g/e>.95)return mf.l(a,b,c).width;for(var m=new oe,n=0,o=0;i>o;o++){var p=a[o];m.aa(a[o]),n=Math.floor(n+p.width*p.height)}m.a1(function(a,b){var c=Math.floor(b.height)-Math.floor(a.height);return 0===c?Math.floor(b.width)-Math.floor(a.width):c});var q=0,r=0,s=Math.floor(c*Math.sqrt(n/c)),t=s,u=0,v=new oe;do{var w=new oe;v.aa(w);for(var x,y,z=x=y=0,A=m.ah();A.i1();A.i2()){var B=A.i6();z+B.width>t&&w.ay()>0?(y=Math.max(y,z),w=new oe,w.aa(B),v.aa(w),z=Math.floor(B.width)):(w.aa(B),z=Math.floor(z+B.width)),1===w.ay()&&(x=Math.floor(x+w.am().height))}y=Math.max(y,z),c*x>y&&u!==y&&(v.af(),t=Math.floor(1.1*t),u=y)}while(v.ar());for(var C=0,D=v.ah();D.i1();D.i2()){for(var E=0,F=D.i6(),G=F.ah();G.i1();G.i2()){var H=G.i6();H.x=E,H.y=C,E+=H.width}q=Math.max(q,E),C+=mf.k(F),r=Math.max(r,C)}return null!=b&&(b.x=0,b.y=0,b.width=q,b.height=r),v.ay()},mf.k=function(a){for(var b=0,c=a.ah();c.i1();c.i2())b=Math.max(c.i6().height,b);return b},mf.h=function(a,b){return new Qd(a.x+b.x,a.y+b.y)},mf.i=function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);return new Sd(-a.y/b,a.x/b)};var nf=function(a){this._a=a,this._b=!1};Jb.ext(nf,Object,{a:function(){return this._b},b:function(){return this._a},c:function(){return 1===this._a},d:function(){return 2===this._a},e:function(){return 4===this._a},f:function(){return 8===this._a},g:function(){return 0===this._a}}),nf.h=function(a,b){var c=a.xc("A");return null==c?null:c.i1(b);

},nf.i=function(a,b){var c=a.xc("B");return null==c?null:c.i1(b)},nf.j=function(a){switch(a){case 1:return nf.k;case 2:return nf.l}return null},nf.k=new nf(1),nf.l=new nf(2);var of=function(a,b,c,d,e){this._o=0,this._l=0,this._i=0,this._d=0,this._f=0,this._b=a,this._a=1e-4,this._r=b,this._p=1,this._e=(e.gj(a)+e.g9(a))/4;var f=.45*c*Math.sqrt(d);this._k=df.l(-f,f),this._h=df.l(-f,f),this._g=df.l(-f,f)};Jb.ext(of,Object,{});var pf=function(){this._a=0,this._c=0,this._b=0};Jb.ext(pf,Object,{});var qf=function(){qf.superClass.constructor.call(this),this._dj=0,this._dh=0,this._dq=0,this._dp=0,this._dt=0,this._de=0,this._d3=0,this._dr=0,this._ed=0,this._dw=.65,this._ea=1,this._dl=80,this._dx=3,this._d8=!0,this._eb=3e5,this._ee=2,this._di=2,this._df=1e3};Jb.ext(qf,Oe,{i4:function(a){return!0},i3:function(a){if(null!=a&&(this._d5=a,this.s(a))){var b=new pf,c=0,d=Math.floor(this._dx*this._dz.length*this._dz.length+20*this._dz.length);d=Math.max(d,1e4);var e=this._ea*this._ea*this._dz.length,f=this._df;try{for(;this._dj>e&&d>c;c++){var g=this.b(2147483647&c);0===f--&&(this._dy.b()>this._eb&&(c=d),f=this._df),this.h(g,b),this.d(g,b),this.i(g,b),this._d8?(this.g(g,b),this.j(g,b)):(this.f(g,b),this.c(g,b));var h=Math.sqrt(b._a*b._a+b._c*b._c+b._b*b._b);this.ac(g,b,h),this.aa(g,b,h)}}catch(i){}finally{this.r()}}},s:function(a){if(null==a||a.xa()<1)return!1;this._d5=a,this._dp=1,this._dy=new cf,this._dt=a.x0(),this._d2=Ff.d(this._dt),this._df=1+1e5/this._dt,this._ed=1/(2*this._di),this._de=this._ed*this._ee/(.05*this._dl),this._d3=Math.pow(this._dl,-1)*this._ed,this._dr=Math.pow(this._dl,3)*this._ed,this._dj=0,this._du=new pf,this._dq=Math.max(20*this._dl,10);var b=Math.max(.1,Math.min(this._dw*this._dl,this._dq)),c=this._dt;mf.c(a),this._dz=Ff.d(c);for(var d=a.x9();d.i1();d.i2()){var e=d.i9(),f=new of(e,b,this._dl,this._dt,a);this._dz[--c]=f,this._dj+=f._r,this._dh+=f._r*f._r,this._du._a+=f._k,this._du._c+=f._h,this._du._b+=f._g,this._d2[e.al()]=f}return this._d8=!1,this._dz.length>0},b:function(a){var b=this._dz.length,c=b-a%b-1,d=df.k(c+1),e=this._dz[d];return this._dz[d]=this._dz[c],this._dz[c]=e,e},f:function(a,b){for(var c,d,e=c=d=0,f=a._b.ae();null!=f;f=f.a7()){var g,h=this._d2[f.a2().al()],i=h._k-a._k,j=h._h-a._h,k=h._g-a._g,l=i*i+j*j+k*k,m=Math.sqrt(l),n=m-(h._e+a._e);0>=n||(g=n*n*this._d3/m,e+=i*g,c+=j*g,d+=k*g)}for(var o=a._b.ag();null!=o;o=o.a8()){var p,q=this._d2[o.a3().al()],r=q._k-a._k,s=q._h-a._h,t=q._g-a._g,u=r*r+s*s+t*t,v=Math.sqrt(u),w=v-(q._e+a._e);0>=w||(p=w*w*this._d3/v,e+=r*p,c+=s*p,d+=t*p)}b._a+=e,b._c+=c,b._b+=d},g:function(a,b){var c,d,e=c=d=0;this._dp++,a._f=this._dp;for(var f=a._b.ae();null!=f;f=f.a7()){var g=this._d2[f.a2().al()];g._f=this._dp;var h=g._k-a._k,i=g._h-a._h,j=g._g-a._g,k=h*h+i*i+j*j,l=Math.sqrt(k);if(0!==l){var m=Math.max(1e-6,l-(a._e+g._e)),n=-this._ef[f.a5()]/(m*m);n+=m*m*this._d1[f.a5()],n/=l,e+=h*n,c+=i*n,d+=j*n}}for(var o=a._b.ag();null!=o;o=o.a8()){var p=this._d2[o.a3().al()];p._f=this._dp;var q=p._k-a._k,r=p._h-a._h,s=p._g-a._g,t=q*q+r*r+s*s,u=Math.sqrt(t);if(0!==u){var v=Math.max(1e-6,u-(a._e+p._e)),w=-this._ef[o.a5()]/(v*v);w+=v*v*this._d1[o.a5()],w/=u,e+=q*w,c+=r*w,d+=s*w}}b._a+=e,b._c+=c,b._b+=d},j:function(a,b){for(var c,d,e=c=d=0,f=this._dt-1;f>=0;f--){var g=this._d2[f];if(g._f!==a._f){var h=a._k-g._k,i=a._h-g._h,j=a._g-g._g,k=h*h+i*i+j*j;if(0!==k){var l=Math.sqrt(k),m=Math.max(1e-6,l-(a._e+g._e)),n=this._dr/(m*m*l);e+=h*n,c+=i*n,d+=j*n}}}b._a+=e,b._c+=c,b._b+=d},c:function(a,b){for(var c,d,e=c=d=0,f=this._dt-1;f>=0;f--){var g=this._d2[f],h=a._k-g._k,i=a._h-g._h,j=a._g-g._g,k=h*h+i*i+j*j;if(0!==k){var l,m=Math.sqrt(k),n=m-(a._e+g._e);l=0>=n?this._dr/(1e-8*m):this._dr/(n*n*m),e+=h*l,c+=i*l,d+=j*l}}b._a+=e,b._c+=c,b._b+=d},i:function(a,b){var c=this._du._b/this._dt-a._g;b._b+=c*this._dl*this._dt/this._dh},d:function(a,b){if(0!==this._de){var c=this._du._a/this._dt-a._k,d=this._du._c/this._dt-a._h,e=this._du._b/this._dt-a._g;b._a+=c*this._de,b._c+=d*this._de,b._b+=e*this._de}},h:function(a,b){var c=.05*(a._r+2);c>0&&(b._a=df.l(-c,c),b._c=df.l(-c,c),b._b=df.l(-c,c))},ac:function(a,b,c){if(0!==c&&0!==a._a){var d=b._a*a._o+b._c*a._l+b._b*a._i,e=d/(c*a._a);this._dh-=a._r*a._r,this._dj-=a._r,a._r+=a._p*e>0?.45*e:.15*e,a._r>this._dq?a._r=this._dq:a._r<.1&&(a._r=.1),this._dj+=a._r,this._dh+=a._r*a._r,a._p=e}},aa:function(a,b,c){if(c>0){var d=a._r/c,e=b._a*d,f=b._c*d,g=b._b*d;a._k+=e,a._h+=f,a._g+=g,this._du._a+=e,this._du._c+=f,this._du._b+=g,a._a=c,a._o=b._a,a._l=b._c,a._i=b._b}},r:function(){for(var a=this._d2.length-1;a>=0;a--){var b=this._d2[a];this._d5.s2(b._b,b._k,b._h)}}});var rf=function(a,b,c,d){this._e=a,this._f=b,this._a=c,this._b=d,this._c={}};Jb.ext(rf,Object,{resetGroup:function(){if(this._a&&null==this._b)for(var a in this._c){var b=this._c[a];b.group.setExpanded(this._e.isExpandGroup()?!0:b.b)}},process:function(){for(var a=new md,b=0,c=this._f.size();c>b;b++){var d=this._f.get(b);if(d instanceof Ib.Link)d.isLooped()||a.add(d);else{if(null==this._b&&d.getParent()instanceof Ld)continue;(null==this._b||null!=this._b&&this._b!==d)&&a.add(d),null==this._b&&d instanceof Ld&&this.layoutGroup(d)}}return a},layoutGroup:function(a){if(this._a&&null==this._c[a.getId()]&&null==this._b){this._c[a.getId()]={group:a,b:a.isExpanded()};var b=this._e.getGroupLayoutType(a);if(b){a.setExpanded(!0);for(var c,d=new md,e=a.getChildren(),f=0,g=e.size();g>f;f++)if(c=e.get(f),c instanceof Ld&&(this.layoutGroup(c),c.setExpanded(!1)),c instanceof Ib.Link||d.contains(c)||d.add(c),c instanceof Jd){var h=c.getLinks();if(null!=h)for(var i=0,j=h.size();j>i;i++){var k=h.get(i);d.contains(k)||d.add(k)}}var l=new lf(this._e,d,b,this._a,this._b);try{var m=null;if("round"===b?m=new bf:"symmetry"===b?m=new qf:"hierarchic"===b?m=new Af:("topbottom"===b||"bottomtop"===b||"rightleft"===b||"leftright"===b)&&(m=new Pe),null!=m){m.i2(l);var n=rf.createMatrix(b),o={},p={};for(var q in l._a){var r=l._a[q],s=r.node,t=l.g4(r);if(o[q]=s.getCenterLocation(),null!=n){var u=n.transform(t);s.setCenterLocation(u.x,u.y)}else s.setCenterLocation(t.x,t.y);p[q]=s.getCenterLocation()}}}catch(v){}for(e=a.getChildren(),f=0,g=e.size();g>f;f++)c=e.get(f),c instanceof Ld&&c.setExpanded(!0)}}}}),rf.createMatrix=function(a){return"rightleft"===a?Tb.createMatrix(Math.PI/2,0,0):"leftright"===a?Tb.createMatrix(-Math.PI/2,0,0):"bottomtop"===a?Tb.createMatrix(Math.PI,0,0):null};var sf=function(){};Jb.ext(sf,Object,{i1:function(a,b,c){var d=this.a1(a,b);return this.a2(a,b,c),d},a1:function(a,b){var c=sf.i4(a);c.ax();for(var d=0,e=c.x1();e.i1();e.i2())b.i7(e.i9(),-1);for(var f=c.x1();f.i1();f.i2()){for(var g=f.i9(),h=-1,i=g.aq();i.i1();i.i2())h=Math.max(h,b.i2(i.i9()));b.i7(g,h+1),d=Math.max(d,h+1)}return d+1},a2:function(a,b,c){c.az(sf.i3(a,b))}}),sf.i3=function(a,b){for(var c=new pe,d=a.xf();d.i1();d.i2()){var e=d.i8();b.i2(e.a2())>b.i2(e.a3())&&(a.x3(e),c.ac(e))}return c},sf.i4=function(a){var b=Ff.a(a.xa());return(new ge).a1(a,b),sf.i2(a,b)},sf.i2=function(a,b){for(var c=Ff.d(a.x0()),d=a.x9();d.i1();d.i2()){var e=d.i9(),f=e.al();c[b[f]]=e}return new He(c)};var tf=function(){tf.superClass.constructor.call(this),this.c0()};Jb.ext(tf,pe,{c0:function(){this._bc=1,this._bd=0}});var uf=function(){this._m1=20,this._m2=60,this._m3=5,this._m4=0};Jb.ext(uf,Object,{i4:function(a){this._m3=a},i5:function(a){this._m4=a},i3:function(a){this._m1=a},i6:function(a){this._m2=a},i2:function(a){this._m5=a},t1:function(){return this._m2},a1:function(a,b){for(var c=Ff.d(b.length),d=0;d<b.length;d++)c[d]=b[d].x1();this.a2(a,c)},a2:function(a,b){for(var c=Ff.a(b.length),d=0,e=0;e<b.length;e++){var f=0,g=b[e];for(g.i4();g.i1();g.i2())f=Math.max(f,a.g9(g.i9()));for(c[e]=f,g.i4();g.i1();g.i2()){var h=(c[e]-a.g9(g.i9()))/2;a.s4(g.i9(),new Qd(a.gi(g.i9()),d+h))}var i=this.t1();d+=c[e]+i,g.i4()}},i1:function(a,b,c){this._m6=a,this.t2(b,c)}});var vf=function(a,b){vf.superClass.constructor.call(this)};Jb.ext(vf,uf,{t2:function(a,b){var c=this._m6;this._a=c.xc("D"),this._h=c.xc("C"),this.a1(c,a),this.tg(c,a),this.tf(a,Le.a5(this._e),this._m5,this._l),this.tb(c,this._f[0]),this.ta(a),this.th(c,this._f[0],a),this.b(a),this.tb(c,this._f[1]),this.ta(a),this.th(c,this._f[1],a),this.b(a),this.a11(this._f[1]),this.a12(a),this.tb(c,this._f[2]),this.ta(a),this.th(c,this._f[2],a),this.b(a),this.tb(c,this._f[3]),this.ta(a),this.th(c,this._f[3],a),this.b(a),this.a11(this._f[3]),this.a12(a),this.tc(c),this.tj()},a11:function(a){for(var b=0;b<a.length;b++)a[b]=-a[b]},b:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.ax()}for(var d=0;d<a.length;d++)for(var e=0,f=null,g=a[d].x1();g.i1();g.i2()){var h=g.i9(),i=h.al();this._l[i]=e++,this._b[i]=f,this._k[i]=null,null!=f&&(this._k[f.al()]=h),f=h}var j=this._a;this._a=this._h,this._h=j;for(var k=this._m6.xf();k.i1();k.i2()){var l=k.i8(),m=this._m6.gn(l);this._m6.gt(l,new Qd(-m.x,m.y));var n=this._m6.gk(l);this._m6.gz(l,new Qd(-n.x,n.y))}var o=this._l,p=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:o[a.a2().al()]-o[b.a2().al()]},q=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:o[a.a3().al()]-o[b.a3().al()]};this._m6.x2(p,q)},a12:function(a){for(var b=this._m6.xf();b.i1();b.i2()){var c=b.i8();this._m6.x3(c);var d=this._m6.gn(c),e=this._m6.gk(c);this._m6.gz(c,d),this._m6.gt(c,e)}for(var f=new oe,g=0;g<a.length;g++)f.ae(a[g]);for(var h=0;h<a.length;h++)a[h]=f.au();var i=this._l,j=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:i[a.a2().al()]-i[b.a2().al()]},k=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:i[a.a3().al()]-i[b.a3().al()]};this._m6.x2(j,k)},tg:function(a,b){var c=a.x0(),d=a.xg();this._l=Ff.a(c),this._b=Ff.d(c),this._k=Ff.d(c),this._m=Ff.d(c),this._i=Ff.d(c),this._o=Ff.d(c),this._f=Ff.e(4,c),this._c=Ff.a(c),this._g=Ff.a(c),this._j=Ff.a(c),this._d=Ff.b(c),this._e=Ff.b(d);for(var e=0;e<b.length;e++)for(var f=0,g=null,h=b[e].x1();h.i1();h.i2()){var i=h.i9(),j=i.al();this._l[j]=f++,this._b[j]=g,this._k[j]=null,null!=g&&(this._k[g.al()]=i),g=i}var k=this._l,l=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:k[a.a2().al()]-k[b.a2().al()]},m=function(a,b){return null==a&&null!=b?1:null!=a&&null==b?-1:null==a&&null==b?0:k[a.a3().al()]-k[b.a3().al()]};a.x2(l,m)},tb:function(a,b){for(var c=a.x9();c.i1();c.i2()){var d=c.i9(),e=d.al();this._m[e]=d,this._i[e]=d,b[e]=Number.MAX_VALUE,this._o[e]=d,this._c[e]=Number.MAX_VALUE,this._d[e]=!1,this._j[e]=this._g[e]=0}},ta:function(a){for(var b=1;b<a.length;b++)for(var c=-1,d=a[b]._b;null!=d;d=d.a()){var e=d.d(),f=e.al(),g=e.ak();if(0!==g){var h,i=Math.floor((g+1)/2),j=Math.ceil((g+1)/2),k=1;for(h=e.ae();i>k;h=h.a7())k++;for(var l=!1;j>=k&&!l;k++){var m=this._m6.g2(h),n=h.a2(),o=n.al();this._i[f]===e&&!this._e[h.a5()]&&c<this._l[o]&&(c=this._l[o],this._i[o]=e,this._m[f]=this._m[o],this._i[f]=this._m[f],l=!0,this._j[o]=m.i6().x,this._g[f]=m.i7().x),h=h.a7()}}}},th:function(a,b,c){for(var d=a.x9();d.i1();d.i2()){var e=d.i9(),f=e.al();this._m[f]===e&&this.td(a,e,b)}for(var g=0;g<c.length;g++){var h=c[g].x1();if(h.i1()){var i=c[g].x1().i9(),j=i.al();this._o[this._m[j].al()]===i&&this.tk(a,i,b)}}for(var k=a.x9();k.i1();k.i2()){var l=k.i9(),m=l.al(),n=this._c[this._o[this._m[m].al()].al()];n<Number.MAX_VALUE&&(b[m]+=n)}},td:function(a,b,c){var d=b.al();if(c[d]===Number.MAX_VALUE){c[d]=0;var e=b,f=0;do{var g=e.al();if(g!==d&&(f-=this._g[g]),this._l[g]>0){var h=this._b[g],i=this._m[this._b[g].al()],j=i.al();this.td(a,i,c),this._o[d]===b&&(this._o[d]=this._o[j]),this._o[d]===this._o[j]&&(c[d]=Math.max(c[d],c[h.al()]+this.ti(a,h,e)-f))}f+=this._j[g],e=this._i[g]}while(e!==b);f=0,e=b;do{var k=e.al();k!==d&&(f-=this._g[k]),c[k]=c[d]+f,f+=this._j[k],e=this._i[k]}while(e!==b)}},tk:function(a,b,c){var d=b.al();if(!this._d[d]){this._d[d]=!0;var e=b;do{var f=e.al(),g=this._k[f];if(null!=g){var h=g.al(),i=this._o[this._m[h].al()];if(i!==this._o[d]){var j=c[h]-c[d]-this.ti(a,e,g);this._c[i.al()]!==Number.MAX_VALUE&&(j+=this._c[i.al()]),this._c[this._o[d].al()]=Math.min(this._c[this._o[d].al()],j)}else this.tk(a,this._m[h],c)}e=this._i[f]}while(e!==b)}},tc:function(a){for(var b=Ff.a(4),c=Ff.a(4),d=a.x9();d.i1();d.i2()){var e=d.i9(),f=e.al();c[0]+=this._f[0][f],c[1]+=this._f[1][f],c[2]+=this._f[2][f],c[3]+=this._f[3][f]}c[0]/=a.xa(),c[1]/=a.xa(),c[2]/=a.xa(),c[3]/=a.xa();for(var g=a.x9();g.i1();g.i2()){var h=g.i9(),i=h.al(),j=a.g4(h);b[0]=this._f[0][i]-c[0],b[1]=this._f[1][i]-c[1],b[2]=this._f[2][i]-c[2],b[3]=this._f[3][i]-c[3],b.sort(Ff.n);var k=(b[1]+b[2])/2;a.s1(h,new Qd(k,j.y))}},ti:function(a,b,c){var d,e=a.gj(b),f=a.gj(c);return d=e>1&&f>1?this._m1+(e+f)/2:this._m3+(e+f)/2,this._l[b.al()]<this._l[c.al()]?(null!=this._a&&(d+=this._a.i3(c)),null!=this._h&&(d+=this._h.i3(b))):(null!=this._a&&(d+=this._a.i3(b)),null!=this._h&&(d+=this._h.i3(c))),d},tj:function(){this._l=null,this._b=null,this._k=null,this._e=null,this._m=null,this._i=null,this._f=null,this._c=null,this._o=null,this._d=null,this._j=null,this._g=null},tf:function(a,b,c,d){for(var e=a.length,f=2;e-1>f;f++)for(var g=-1,h=0,i=0,j=a[f].x1(),k=a[f].x1();k.i1();k.i2()){var l=k.i9(),m=null,n=!1;if(1===l.ak()&&(m=l.ae().a2(),null!=c.i1(m)&&null!=c.i1(l)&&(n=!0)),i===a[f].ay()-1||n){for(var o=n?d[m.al()]:a[f-1].ay();i>=h;h++){for(var p=j.i9(),q=p.am();q.i1();q.i2()){var r=q.i8(),s=d[r.a2().al()];(g>s||s>o)&&b.i7(q.i8(),!0)}j.i2()}g=o}i++}}});var wf=function(a,b){this._b=20,this._a=b,this._d=a,this._f={}};Jb.ext(wf,Object,{a3:function(a){this._b=a},a4:function(a,b,c,d,e){if(this.a2(a)){var f=this.b2(a);f._o=b,f._m=e,f._n=d,f._f=c}},b2:function(a){var b=this._f[a._id];return null==b&&(b=new xf,this._f[a._id]=b),b},a2:function(a){return null!=this._f[a._id]},c:function(){for(var a=Le.a1(Ff.a(this._d.xa())),b=Le.a1(Ff.a(this._d.xa())),c=this._d.x9();c.i1();c.i2()){var d=c.i9();if(this.a2(d)){var e=this.b2(d);a.i6(d,this._b*(e.c()-1)),b.i6(d,this._b*(e.b()-1))}}this._d.x1("D",a),this._d.x1("C",b)},g:function(){this._d.x6("D"),this._d.x6("C")},f:function(){for(var a=this._d.x9();a.i1();a.i2()){var b=a.i9();if(this.a2(b)){var c=this._d.gi(b),d=this._d.gh(b),e=this._d.gj(b),f=this._d.g9(b),g=this.b2(b),h=g._q.ay()+g._b.ay()+g._f,i=g._d.ay()+g._g.ay()+g._o,j=g._i.ay()+g._l.ay()+g._n,k=g._h.ay()+g._k.ay()+g._m,l=this._a.a7(e,h),m=this._a.a7(e,i),n=this._a.a7(f,k),o=this._a.a7(f,j);g.a2(this._a.a8(e,h,l),this._a.a8(e,i,m),this._a.a8(f,k,n),this._a.a8(f,j,o));for(var p=g._j.c1();p.i1();p.i2()){var q=p.i8(),r=this.a1(q),s=this.b1(q),t=new oe;r.b()===s.b()?(r.c()?(t.aa(new Qd(c+g._g._bd*m+g._c,d)),t.aa(new Qd(c+g._g._bd*m+g._c,d-this._b)),g._g._bd++,t.aa(new Qd(c+g._g._bd*m+g._c,d-this._b)),t.aa(new Qd(c+g._g._bd*m+g._c,d)),g._g._bd++,g._g._bc=Math.max(g._g._bc,2)):r.d()?(t.aa(new Qd(c+g._b._bd*l+g._p,d+f)),t.aa(new Qd(c+g._b._bd*l+g._p,d+f+this._b)),g._b._bd++,t.aa(new Qd(c+g._b._bd*l+g._p,d+f+this._b)),t.aa(new Qd(c+g._b._bd*l+g._p,d+f)),g._b._bd++,g._b._bc=Math.max(g._b._bc,2)):r.f()?(t.aa(new Qd(c,d+g._i._bd*o+g._a)),t.aa(new Qd(c-this._b,d+g._i._bd*o+g._a)),g._i._bd++,t.aa(new Qd(c-this._b,d+g._i._bd*o+g._a)),t.aa(new Qd(c,d+g._i._bd*o+g._a)),g._i._bd++,g._i._bc=Math.max(g._i._bc,2)):r.e()&&(t.aa(new Qd(c+e,d+g._h._bd*n+g._e)),t.aa(new Qd(c+e+this._b,d+g._h._bd*n+g._e)),g._h._bd++,t.aa(new Qd(c+e+this._b,d+g._h._bd*n+g._e)),t.aa(new Qd(c+e,d+g._h._bd*n+g._e)),g._h._bd++,g._h._bc=Math.max(g._h._bc,2)),this._d.m1(q,t)):r.c()||s.c()?r.e()||s.e()?(t.aa(new Qd(c+e-g._d._bd*m-g._c,d)),t.aa(new Qd(c+e-g._d._bd*m-g._c,d-this._b*g._d._bc)),t.aa(new Qd(c+e+this._b*g._h._bc,d-this._b*g._d._bc)),t.aa(new Qd(c+e+this._b*g._h._bc,d+g._h._bd*n+g._e)),t.aa(new Qd(c+e,d+g._h._bd*n+g._e)),g._d._bd++,g._d._bc++,g._h._bd++,g._h._bc++,s.c()&&t.ax(),this._d.m1(q,t)):r.f()||s.f()?(t.aa(new Qd(c+g._g._bd*m+g._c,d)),t.aa(new Qd(c+g._g._bd*m+g._c,d-this._b*g._g._bc)),t.aa(new Qd(c-this._b*g._i._bc,d-this._b*g._g._bc)),t.aa(new Qd(c-this._b*g._i._bc,d+g._i._bd*o+g._a)),t.aa(new Qd(c,d+g._i._bd*o+g._a)),g._g._bd++,g._g._bc++,g._i._bd++,g._i._bc++,s.c()&&t.ax(),this._d.m1(q,t)):(r.d()||s.d())&&(t.aa(new Qd(c+e-g._d._bd*m-g._c,d)),t.aa(new Qd(c+e-g._d._bd*m-g._c,d-this._b*g._d._bc)),t.aa(new Qd(c+e+this._b*g.b(),d-this._b*g._d._bc)),t.aa(new Qd(c+e+this._b*g.b(),d+f+this._b*g._q._bc)),t.aa(new Qd(c+e-g._q._bd*l-g._p,d+f+this._b*g._q._bc)),t.aa(new Qd(c+e-g._q._bd*l-g._p,d+f)),g._d._bd++,g._d._bc++,g._k._bc++,g._h._bc++,g._q._bc++,g._q._bd++,s.c()&&t.ax(),this._d.m1(q,t)):r.d()||s.d()?r.e()||s.e()?(t.aa(new Qd(c+e-g._q._bd*l-g._p,d+f)),t.aa(new Qd(c+e-g._q._bd*l-g._p,d+f+this._b*g._q._bc)),t.aa(new Qd(c+e+this._b*g._k._bc,d+f+this._b*g._q._bc)),t.aa(new Qd(c+e+this._b*g._k._bc,d+f-g._k._bd*n-g._e)),t.aa(new Qd(c+e,d+f-g._k._bd*n-g._e)),g._q._bd++,g._q._bc++,g._k._bd++,g._k._bc++,s.d()&&t.ax(),this._d.m1(q,t)):(r.f()||s.f())&&(t.aa(new Qd(c+g._b._bd*l+g._p,d+f)),t.aa(new Qd(c+g._b._bd*l+g._p,d+f+this._b*g._b._bc)),t.aa(new Qd(c-this._b*g._l._bc,d+f+this._b*g._b._bc)),t.aa(new Qd(c-this._b*g._l._bc,d+f-g._l._bd*o-g._a)),t.aa(new Qd(c,d+f-g._l._bd*o-g._a)),g._b._bd++,g._b._bc++,g._l._bd++,g._l._bc++,s.d()&&t.ax(),this._d.m1(q,t)):(t.aa(new Qd(c,d+f-g._l._bd*o-g._a)),t.aa(new Qd(c-this._b*g._l._bc,d+f-g._l._bd*o-g._a)),t.aa(new Qd(c-this._b*g._l._bc,d+f+this._b*g.a1())),t.aa(new Qd(c+e+this._b*g._k._bc,d+f+this._b*g.a1())),t.aa(new Qd(c+e+this._b*g._k._bc,d+f-g._k._bd*n-g._e)),t.aa(new Qd(c+e,d+f-g._k._bd*n-g._e)),g._l._bd++,g._l._bc++,g._b._bc++,g._q._bc++,g._k._bc++,g._k._bd++,s.f()&&t.ax(),this._d.m1(q,t))}}}},a5:function(a,b){for(var c=0;c<a.length;c++)for(var d=a[c],e=b[c],f=d.x1();f.i1();f.i2()){var g=f.i9();if(this.a2(g)){var h=this.b2(g);e._g=Math.max(e._g,this._b*(h.d()-1)),e._j=Math.max(e._j,this._b*(h.a1()-1))}}},a1:function(a){var b=this._d.xc("A"),c=null;if(null!=b&&(c=b.i1(a)),null==c||c.g()){var d=this._d.xc("B");if(null==d)return nf.j(1);var e=d.i1(a);if(null==e||e.g())return nf.j(1);if(e.c())return nf.j(8);if(e.f())return nf.j(1);if(e.d())return nf.j(4);if(e.e())return nf.j(2)}return c},b1:function(a){var b=this._d.xc("B"),c=null;if(null!=b&&(c=b.i1(a)),null==c||c.g()){var d=this._d.xc("A");if(null==d)return nf.j(8);var e=d.i1(a);if(null==e||e.g())return nf.j(8);if(e.c())return nf.j(8);if(e.f())return nf.j(1);if(e.d())return nf.j(4);if(e.e())return nf.j(2)}return c}});var xf=function(){this._o=0,this._f=0,this._n=0,this._m=0,this._c=0,this._p=0,this._e=0,this._a=0,this._j=new pe,this._g=new tf,this._d=new tf,this._b=new tf,this._q=new tf,this._h=new tf,this._k=new tf,this._i=new tf,this._l=new tf};Jb.ext(xf,Object,{a1:function(){return Math.max(this._q._bc,this._b._bc)},d:function(){return Math.max(this._d._bc,this._g._bc)},b:function(){return Math.max(this._k._bc,this._h._bc)},c:function(){return Math.max(this._l._bc,this._i._bc)},a2:function(a,b,c,d){this._c=b,this._a=d,this._p=a,this._e=c,this._g.c0(),this._d.c0(),this._b.c0(),this._q.c0(),this._k.c0(),this._h.c0(),this._l.c0(),this._i.c0()}});var yf=function(a,b,c,d){this._k=20,this._r=.5,this._d=a,this._c=b,this._j=c,this._m=d,this._i=null!=a.xc("A")||null!=a.xc("B"),this._t=new Bf(a,b,c,d),this._b=new wf(a,this)};Jb.ext(yf,Object,{a6:function(a){this._k=a,this._t.a1(a),this._b.a3(a)},g1:function(){return this._k},a9:function(a){return this.c1(),a},a5:function(a){return this.a1(),a},b3:function(a){return this.c1(),a=this.c4(a),this._b.c(),a},g2:function(a){return this._b.g(),a},e2:function(a){a=this.f(a),this._b.f()},e1:function(){this._t.d(),null!=this._n&&this._d.xi(this._n),this.a1(),this._d=null},a1:function(){this._i&&(null!=this._q&&(this._d.x1("A",this._q),this._q=null),null!=this._p&&(this._d.x1("B",this._p),this._p=null),null!=this._h&&(this._d.xj(this._h),this._h=null),null!=this._l&&(this._d.xj(this._l),this._l=null))},c1:function(){if(this._i){null==this._h&&(this._h=this._d.xl()),null==this._l&&(this._l=this._d.xl());for(var a=this._d.xf();a.i1();a.i2()){var b=a.i8(),c=null!=this._j.i1(b.a2()),d=null!=this._j.i1(b.a3());if(c&&!d){var e=this._j.i1(b.a2());this._m.i4(e)?this._l.i8(b,nf.h(this._d,e)):this._l.i8(b,nf.i(this._d,e))}else if(!c&&d){var f=this._j.i1(b.a3());this._m.i4(f)?this._h.i8(b,nf.i(this._d,f)):this._h.i8(b,nf.h(this._d,f))}else c||d||(this._m.i4(b)?(this._h.i8(b,nf.i(this._d,b)),this._l.i8(b,nf.h(this._d,b))):(this._h.i8(b,nf.h(this._d,b)),this._l.i8(b,nf.i(this._d,b))))}this._q=this._d.xc("A"),this._p=this._d.xc("B"),this._d.x1("A",this._h),this._d.x1("B",this._l)}},c4:function(a){this._n=this._d.xk(),this._a=this._d.xl(),this._g=this._d.xl();for(var b=new pe,c=new pe,d=new pe,e=new pe,f=new pe,g=new pe,h=new pe,i=new pe,j=new pe,k=this._d.xk(),l=0;l<a.length;l++)for(var m=0,n=a[l].x1();n.i1();)k.i6(n.i9(),m),n.i2(),m++;for(var o=function(a,b){var c=k.i3(a.a3())-k.i3(b.a3());return 0>=c?c>=0?0:-1:1},p=function(a,b){var c=k.i3(a.a2())-k.i3(b.a2());return 0>=c?c>=0?0:-1:1},q=0;q<a.length;q++)for(var r=a[q],s=r._b;null!=s;s=s.a()){var t=s.d();t.av(o),t.au(p);var u=0;b.af(),c.af(),d.af(),e.af(),f.af(),g.af(),h.af(),i.af(),j.af();for(var v=t.ap();v.i1();){var w=v.i8(),x=this.b1(w);null==x||x.d()||x.g()?d.aa(w):x.e()?b.aa(w):x.f()?(c.aa(w),j.aa(w)):x.c()&&(i.aa(w),j.aa(w)),v.i2(),u++}u=0;for(var y=t.am();y.i1();){var z=y.i8(),A=this.a2(z);null==A||A.c()||A.g()?e.aa(z):A.e()?b.aa(z):A.f()?(c.aa(z),j.aa(z)):A.d()&&(g.aa(z),j.aa(z)),y.i2(),u++}var B=k.i3(t);if(!j.ar())for(var C=.1/j.ay(),D=B-.4;!j.ar();D+=C){var E=j.c3();if(E.a2()===t){var F=this._d.xm();this._n.z1(F,E.a2()),this._d.s7(F,1,1),this._c.z1(F,this._c.i1(t)),k.i6(F,D),this._a.i8(E,this._d.gn(E)),this._d.gt(E,df._A),this._d.xr(E,F,E.a3()),r.ao(F,s)}else{var G=this._d.xm();this._n.z1(G,E.a3()),this._d.s7(G,1,1),this._c.z1(G,this._c.i1(t)),k.i6(G,D),this._g.i8(E,this._d.gk(E)),this._d.gz(E,df._A),this._d.xr(E,E.a2(),G),r.ao(G,s)}}if(!b.ar())for(var H=.1/b.ay(),I=B+.1;!b.ar();I+=H){var J=b.c3();if(J.a2()===t){var K=this._d.xm();this._n.z1(K,J.a2()),this._d.s7(K,1,1),this._c.z1(K,this._c.i1(t)),k.i6(K,I),this._a.i8(J,this._d.gn(J)),this._d.gt(J,df._A),this._d.xr(J,K,J.a3()),s=r.an(K,s)}else{var L=this._d.xm();this._n.z1(L,J.a3()),this._d.s7(L,1,1),this._c.z1(L,this._c.i1(t)),k.i6(L,I),this._g.i8(J,this._d.gk(J)),this._d.gz(J,df._A),this._d.xr(J,J.a2(),L),s=r.an(L,s)}}var M=yf._z;this._b.a2(t)&&(M=this._b.b2(t));var N=M._b.ay()+g.ay()+t.ao()+f.ay()+M._q.ay();if(N>0)for(var O=this._d.g9(t)/2,P=this._d.gj(t),Q=this.a7(P,N),R=-.5*P+this.a8(this._d.gj(t),N,Q)+Q*(M._b.ay()+g.ay()),S=t.ap();S.i1();S.i2()){var T=S.i8();this.c2(T)||null!=this._j.i1(T.a2())||(this._d.g2(T).i8(new Qd(R,O)),R+=Q)}var U=this._t.a3(t),V=0,W=0,X=0,Y=0;if(null!=U&&(V=U._e.ay(),W=U._c.ay(),X=U._b.ay(),Y=U._d.ay()),N=M._g.ay()+V+i.ay()+t.ak()+h.ay()+W+M._d.ay(),N>0){for(var Z=this._d.gj(t),$=this.a7(Z,N),_=this.a8(Z,N,$),aa=-.5*Z+_+$*(M._g.ay()+V+i.ay()),ba=-this._d.g9(t)/2,ca=t.am();ca.i1();ca.i2()){var da=ca.i8();this.d1(da)||null!=this._j.i1(da.a3())||(this._d.g2(da).i9(new Qd(aa,ba)),aa+=$)}if(null!=U){for(var ea=-.5*Z+_+$*(M._g.ay()+i.ay()+U._e.ay()-1),fa=U._e.c1();fa.i1();fa.i2()){var ga=fa.i8();this._d.u1(ga),ga.a2()!==t||this.c2(ga)?this.d1(ga)||(this._d.g2(fa.i8()).i9(new Qd(ea,ba)),ea-=$):(this._d.g2(fa.i8()).i8(new Qd(ea,ba)),ea-=$),this._d.h1(ga)}ea=.5*Z-_-$*(M._d.ay()+h.ay());for(var ha=U._c.c1();ha.i1();ha.i2()){var ia=ha.i8();this._d.u1(ia),ia.a2()!==t||this.c2(ia)?this.d1(ia)||(this._d.g2(ha.i8()).i9(new Qd(ea,ba)),ea-=$):(this._d.g2(ha.i8()).i8(new Qd(ea,ba)),ea-=$),this._d.h1(ia)}}}this._b.a2(t)&&this._b.a4(t,V+i.ay()+t.ak()+h.ay()+W,g.ay()+t.ao()+f.ay(),X+c.ay(),Y+b.ay())}return this._d.xi(k),a},a7:function(a,b){return 1>=b?0:a/(b-1+2*this._r)},a8:function(a,b,c){return 1>=b?.5*a:.5*(a-c*(b-1))},f:function(a){var b=this.g1();this._f=this._d.xk();for(var c=0;c<a.length;c++)for(var d=a[c],e=d._b;null!=e;){var f=e.d(),g=this._n.i1(f);if(null!=g||this._t.b2(f))e=e.a();else{var h=new He,i=new He,j=new He,k=new He,l=new He,m=new He,n=new pe,o=new pe,p=new Ef(h,i,j,k,l,m,n,o);this._f.z1(f,p),n.ab(f.am()),o.ab(f.ap());for(var q=e.b();null!=q&&this._n.i1(q.d())===f;q=q.b()){var r=q.d(),s=this.c3(r);s.f()?i.ac(r):s.c()?k.ac(r):s.d()&&m.ac(r)}var t;for(t=e.a();null!=t&&this._n.i1(t.d())===f;t=t.a()){var u=t.d(),v=this.c3(u);v.e()?h.aa(u):v.c()?j.aa(u):v.d()&&l.aa(u)}e=t}}for(var w=this.d2(a),x=0,y=0;y<a.length;y++){var z=w[y];y>0&&(x+=w[y-1]._j+w[y-1]._h+w[y-1]._b),x+=z._g+z._f+z._a+z._d;for(var A=a[y].x1();A.i1();A.i2()){var B=A.i9();this._d.s3(B,this._d.gi(B),this._d.gh(B)+x)}z._c+=x,z._i+=x}for(var C=0;C<a.length;C++)for(var D=a[C],E=D.x1();E.i1();E.i2()){var F=E.i9();null!=this._n.i1(F)&&D.av(E)}for(var G=this,H=function(a,b){return G.a3(a)?G.a3(b)&&G._d.gi(a)>=G._d.gi(b)?-1:1:G.a3(b)?-1:G._d.gi(a)>=G._d.gi(b)?1:-1},I=function(a,b){return G.a3(a)?G.a3(b)?G._d.gi(a)>=G._d.gi(b)?1:-1:1:G.a3(b)?-1:G._d.gi(a)>=G._d.gi(b)?-1:1},J=0;J<a.length;J++)for(var K=w[J],L=a[J].x1();L.i1();L.i2()){var M=L.i9();if(!this._t.b2(M)){var N=this._f.i1(M),O=N._d,P=N._a,Q=N._b,R=N._h,S=N._f,T=N._c,U=N._g,V=N._e,W=0,X=0,Y=0,Z=0,$=M.ao(),_=M.ak(),aa=this._d.gi(M),ba=this._d.gh(M),ca=this._d.gj(M),da=this._d.g9(M),ea=this._t.a3(M),fa=yf._z;if(this._b.a2(M)&&(fa=this._b.b2(M)),null!=ea){if(W=ea._d.ay(),X=ea._b.ay(),Y=ea._e.ay(),Z=ea._c.ay(),W>0)for(var ga=fa._h.ay()+O.ay()+W+fa._k.ay(),ha=this.a7(da,ga),ia=this.a8(da,ga,ha),ja=ba+ia+ha*(fa._h.ay()+this.a4(O)),ka=ea._d.c1();ka.i1();ka.i2()){var la=ka.i8();this._d.u1(la),la.a2()===M?this.c2(la)||this._d.gx(la,new Qd(aa+ca,ja)):(this.d1(la),this._d.gy(la,new Qd(aa+ca,ja))),ja+=ha,this._d.h1(la)}if(X>0)for(var ma=fa._i.ay()+P.ay()+X+fa._l.ay(),na=this.a7(da,ma),oa=this.a8(da,ma,na),pa=ba+oa+na*(fa._i.ay()+this.a4(P)),qa=ea._b.c1();qa.i1();qa.i2()){var ra=qa.i8();this._d.u1(ra),ra.a2()===M?this.c2(ra)||this._d.gx(ra,new Qd(aa,pa)):this.d1(ra)||this._d.gy(ra,new Qd(aa,pa)),pa+=na,this._d.h1(ra)}}if(O.ay()>0){O.a1(H);for(var sa=fa._h.ay()+O.ay()+W+fa._k.ay(),ta=this.a7(da,sa),ua=this.a8(da,sa,ta),va=ba+ua+ta*fa._h.ay(),wa=!0;!O.ar();){var xa=O.x4();if(this.a3(xa)){wa&&(wa=!1,va+=ta*W);var ya=xa.ag(),za=this._d.gd(ya),Aa=za.at();if(za.ac(new Qd(Aa.x,K.b())),this.c2(ya)){var Ba=this._a.i1(ya);za.ac(new Qd(Aa.x,Ba.y+this._d.g6(M))),za.ac(new Qd(Ba.x+this._d.g5(M),Ba.y+this._d.g6(M)))}else za.ac(new Qd(Aa.x,va)),za.ac(new Qd(aa+ca,va));this._d.xr(ya,M,ya.a3()),this._d.m1(ya,za)}else{var Ca=xa.ae(),Da=this._d.gd(Ca),Ea=Da.au();if(Da.ae(new Qd(Ea.x,K.a())),this.d1(Ca)){var Fa=this._g.i1(Ca);Da.ae(new Qd(Ea.x,Fa.y+this._d.g6(M))),Da.ae(new Qd(Fa.x+this._d.g5(M),Fa.y+this._d.g6(M)))}else Da.ae(new Qd(Ea.x,va)),Da.ae(new Qd(aa+ca,va));this._d.xr(Ca,Ca.a2(),M),this._d.m1(Ca,Da)}this._d.x4(xa),va+=ta}}if(P.ay()>0){P.a1(I);for(var Ga=fa._i.ay()+P.ay()+X+fa._l.ay(),Ha=this.a7(da,Ga),Ia=this.a8(da,Ga,Ha),Ja=ba+Ia+Ha*fa._i.ay(),Ka=!0;!P.ar();){var La=P.x4();if(this.a3(La)){Ka&&(Ka=!1,Ja+=Ha*X);var Ma=La.ag(),Na=this._d.gd(Ma),Oa=Na.at();if(Na.ac(new Qd(Oa.x,K.b())),this.c2(Ma)){var Pa=this._a.i1(Ma);Na.ac(new Qd(Oa.x,Pa.y+this._d.g6(M))),Na.ac(new Qd(Pa.x+this._d.g5(M),Pa.y+this._d.g6(M)))}else Na.ac(new Qd(Oa.x,Ja)),Na.ac(new Qd(aa,Ja));this._d.xr(Ma,M,Ma.a3()),this._d.m1(Ma,Na)}else{var Qa=La.ae(),Ra=this._d.gd(Qa),Sa=Ra.au();if(Ra.ae(new Qd(Sa.x,K.a())),this.d1(Qa)){var Ta=this._g.i1(Qa);Ra.ae(new Qd(Sa.x,Ta.y+this._d.g6(M))),Ra.ae(new Qd(Ta.x+this._d.g5(M),Ta.y+this._d.g6(M)))}else Ra.ae(new Qd(Sa.x,Ja)),Ra.ae(new Qd(aa,Ja));this._d.xr(Qa,Qa.a2(),M),this._d.m1(Qa,Ra)}this._d.x4(La),Ja+=Ha}}var Ua=fa._g.ay()+fa._d.ay()+_+R.ay()+Q.ay()+Y+Z;ca=this._d.gj(M);var Va=this.a7(ca,Ua),Wa=this.a8(ca,Ua,Va);Ua=fa._b.ay()+fa._q.ay()+$+T.ay()+S.ay();var Xa=this.a7(ca,Ua),Ya=this.a8(ca,Ua,Xa);if(R.ay()>0)for(var Za,$a=Va,_a=b,ab=this._d.gi(M)+Wa+$a*(fa._g.ay()+R.ay()-1),bb=this._d.gh(M),cb=K._c-K._g-R.ay()*_a;!R.ar();this._d.x4(Za)){Za=R.x4();var db=Za.ag(),eb=this._d.gd(db),fb=eb.at();if(eb.ac(new Qd(fb.x,K.b())),eb.ac(new Qd(fb.x,cb)),this.c2(db)){var gb=this._a.i1(db);eb.ac(new Qd(gb.x+this._d.g5(M),cb)),eb.ac(new Qd(gb.x+this._d.g5(M),gb.y+this._d.g6(M)))}else eb.ac(new Qd(ab,cb)),eb.ac(new Qd(ab,bb)),ab-=$a;cb+=_a,this._d.xr(db,M,db.a3()),this._d.m1(db,eb)}if(Q.ay()>0)for(var hb,ib=Va,jb=b,kb=this._d.gi(M)+this._d.gj(M)-Wa-ib*fa._d.ay(),lb=this._d.gh(M),mb=K._c-K._g-jb;!Q.ar();this._d.x4(hb)){hb=Q.x4();var nb=hb.ag(),ob=this._d.gd(nb),pb=ob.at();if(ob.ac(new Qd(pb.x,K.b())),ob.ac(new Qd(pb.x,mb)),this.c2(nb)){var qb=this._a.i1(nb);ob.ac(new Qd(qb.x+this._d.g5(M),mb)),ob.ac(new Qd(qb.x+this._d.g5(M),qb.y+this._d.g6(M)))}else ob.ac(new Qd(kb,mb)),ob.ac(new Qd(kb,lb)),kb-=ib;mb-=jb,this._d.xr(nb,M,nb.a3()),this._d.m1(nb,ob)}if(T.ay()>0)for(var rb,sb=Xa,tb=b,ub=this._d.gi(M)+Ya+sb*(fa._b.ay()+T.ay()-1),vb=this._d.gh(M)+this._d.g9(M),wb=vb+T.ay()*tb;!T.ar();this._d.x4(rb)){rb=T.x4();var xb=rb.ae(),yb=this._d.gd(xb),zb=yb.au();if(yb.ae(new Qd(zb.x,K.a())),yb.ae(new Qd(zb.x,wb)),this.d1(xb)){var Ab=this._g.i1(xb);yb.ae(new Qd(Ab.x+this._d.g5(M),wb)),yb.ae(new Qd(Ab.x+this._d.g5(M),Ab.y+this._d.g6(M)))}else yb.ae(new Qd(ub,wb)),yb.ae(new Qd(ub,vb)),ub-=sb;wb-=tb,this._d.xr(xb,xb.a2(),M),this._d.m1(xb,yb)}if(S.ay()>0)for(var Bb,Cb=Xa,Db=b,Eb=this._d.gi(M)+this._d.gj(M)-Ya-Xa*fa._q.ay(),Fb=this._d.gh(M)+this._d.g9(M),Gb=Fb+Db;!S.ar();this._d.x4(Bb)){Bb=S.x4();var Hb=Bb.ae(),Ib=this._d.gd(Hb),Jb=Ib.au();if(Ib.ae(new Qd(Jb.x,K.a())),Ib.ae(new Qd(Jb.x,Gb)),this.d1(Hb)){var Kb=this._g.i1(Hb);Ib.ae(new Qd(Kb.x+this._d.g5(M),Gb)),Ib.ae(new Qd(Kb.x+this._d.g5(M),Kb.y+this._d.g6(M)))}else Ib.ae(new Qd(Eb,Gb)),Ib.ae(new Qd(Eb,Fb)),Eb-=Cb;Gb+=Db,this._d.xr(Hb,Hb.a2(),M),this._d.m1(Hb,Ib)}for(;!V.ar();){var Lb=V.c3(),Mb=this._d.gl(Lb);K.a()+12<Mb.y&&this._d.g7(Lb).i4(Mb.x,K.a())}for(;!U.ar();){var Nb=U.c3(),Ob=this._d.gs(Nb);if(K.b()-12>Ob.y){var Pb=this._d.gf(Nb);Pb.ac(new Qd(Ob.x,K.b())),this._d.s6(Nb,Pb)}}}}for(var Qb=0;Qb<a.length;Qb++)for(var Rb=a[Qb],Sb=Rb._b;null!=Sb;Sb=Sb.a()){var Tb=Sb.d(),Ub=this._t.a3(Tb);null!=Ub&&null!=Ub._a&&(this._d.x4(Ub._a),Rb.aw(Sb.b()))}return this._d.xi(this._f),this._d.xj(this._a),this._d.xj(this._g),a},c3:function(a){return this.a3(a)?this.b1(a.ag()):this.a2(a.ae())},b1:function(a){return null==this._h?yf.s:this._h.i1(a)},a2:function(a){return null==this._l?yf.u:this._l.i1(a)},c2:function(a){if(null==a)return!1;var b=this.b1(a);return null!=b&&b.a()},d1:function(a){if(null==a)return!1;var b=this.a2(a);return null!=b&&b.a()},a3:function(a){return 1===a.ao()},b2:function(a){return 1===a.ak()},a4:function(a){for(var b=0,c=a._b;null!=c;c=c.a())this.b2(c.d())&&b++;return b},d2:function(a){for(var b=this._k,c=Ff.d(a.length+1),d=0;d<a.length;d++){var e=a[d],f=new Cf;c[d]=f,f._c=Number.MAX_VALUE,f._i=Number.MIN_VALUE;for(var g=e.x1();g.i1();g.i2()){var h=g.i9(),i=this._d.gb(h);f._c=Math.min(f._c,i.i2()),f._i=Math.max(f._i,i.i2()+i.i4())}}this._b.a5(a,c);for(var j=0;j<a.length;j++)for(var k=c[j],l=a[j].x1();l.i1();l.i2()){var m=l.i9(),n=this._f.i1(m);null!=n&&(k._h=Math.max(k._h,Math.max(n._f.ay()*b,n._c.ay()*b)),k._f=Math.max(k._f,Math.max(n._b.ay()*b,n._h.ay()*b)))}return c}}),yf.s=nf.j(2),yf.u=nf.j(1),yf._z=new xf;var zf=function(){this._af=0,this._b=0};Jb.ext(zf,Object,{ib:function(a){this._af=a},ia:function(a,b,c){this.a6(a,b,c),this.b2(!1);var d=this.g();if(this.o()&&d>0){for(var e=this.r(),f=0;20>f&&d>0&&this.o();f++){this.b2(!0);var g=this.g();d>g&&(this.a7(e),d=g)}this.b3(e),this.b1()}return this.c()},a6:function(a,b,c){this._b=(new Date).getTime(),this._ac=a,this._ah=b;var d=this;this._p=function(a,b){var c=d._n[a.al()]-d._n[b.al()];return c>0?1:c>=0?0:-1},this._ad=Ff.d(c);for(var e=0;e<this._ad.length;e++)this._ad[e]=new He;this._ab=Ff.a(this._ac.x0()),this._f=Ff.d(this._ac.x0()),this._n=Ff.a(this._ac.x0()+1);var f=this._ab;this._o=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,g=c.a2(),h=d.a2(),i=f[g.al()]-f[h.al()];if(0===i){var j=zf.b(nf.h(e,c),e.gn(c)),k=zf.b(nf.h(e,d),e.gn(d)),l=j-k;if(0===l){var m=f[c.a3().al()]-f[d.a3().al()];if(0===m){var n=zf.a(nf.i(e,c),e.gk(c)),o=zf.a(nf.i(e,d),e.gk(d));

return n-o}return m}return l}return i},this._l=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,g=c.a3(),h=d.a3(),i=f[g.al()]-f[h.al()];if(0===i){var j=zf.a(nf.i(e,c),e.gk(c)),k=zf.a(nf.i(e,d),e.gk(d)),l=j-k;if(0===l){var m=f[c.a2().al()]-f[d.a2().al()];if(0===m){var n=zf.b(nf.h(e,c),e.gn(c)),o=zf.b(nf.h(e,d),e.gn(d));return n-o}return m}return l}return i},this._z=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,f=zf.b(nf.h(e,c),e.gn(c)),g=zf.b(nf.h(e,d),e.gn(d));return f-g},this._e=function(a,b){if(null==a&&null!=b)return 1;if(null!=a&&null==b)return-1;if(null==a&&null==b)return 0;var c=a,d=b,e=c._h,f=zf.a(nf.i(e,c),e.gk(c)),g=zf.a(nf.i(e,d),e.gk(d));return f-g},this._ac.x2(this._e,this._z)},c:function(){this._ah=null,this._aa=null,this._f=null,this._n=null,this._p=null,this._o=null,this._l=null,this._ac=null;var a=this._ad;return this._ad=null,a},o:function(){var a=(new Date).getTime()-this._b;return a<=this._af},m:function(){for(var a=this,b=function(b,c){return Math.ceil(a._n[b.a3().al()])-Math.ceil(a._n[c.a3().al()])},c=this._ac.x9();c.i1();c.i2()){for(var d=c.i9().aw();d.i1();d.i2())this._n[d.i9().al()]=df.j();c.i9().av(b)}},b2:function(a){for(var b=0;b<this._ad.length;b++)this._ad[b].af();if(a){this.m();for(var c=0,d=this._ab.length;d>c;c++)this._ab[c]=0;this._ac.x2(null,this._z)}var e=this._ac.xm();this._ah.i7(e,0);for(var f=this._ac.x9();f.i1();f.i2())0===f.i9().ak()&&f.i9()!==e&&this._ac.xo(e,f.i9());var g=new ce(this);g.a6(!0),g.a9(this._ac,e),this._ad[0].at(),this._ac.x4(e),this.d()},a1:function(){this._ac.x2(this._o,this._l);for(var a=0,b=1;b<this._ad.length;b++){var c=this.a2(this._ad[b-1],this._ad[b]);a+=c}var d=0;return a+=d},a2:function(a,b){var c=a.ah(),d=b.ah(),e=new oe,f=new oe;this._aa=Ff.d(this._ac.x0());for(var g=0;c.i1()&&d.i1();d.i2())g+=this.a8(c.i6(),e,f,!0),g+=this.a8(d.i6(),f,e,!1),c.i2();for(;c.i1();c.i2())g+=this.a8(c.i6(),e,f,!0);for(;d.i1();d.i2())g+=this.a8(d.i6(),f,e,!1);return g},a8:function(a,b,c,d){var e=0,f=0,g=0;if(null!=this._aa[a.al()])for(var h=this._aa[a.al()].a(),i=b._b;i!==h;i=i.a()){var j=i._c;j===a?(e++,g+=f,b.aw(i)):f++}var k=e*c.ay()+g;if(d)for(var l=a.ag();null!=l;l=l.a8()){var m=l.a3();this._ab[m.al()]>=this._ab[a.al()]&&(this._aa[m.al()]=c.ae(m))}else for(var n=a.ae();null!=n;n=n.a7()){var o=n.a2();this._ab[o.al()]>this._ab[a.al()]&&(this._aa[o.al()]=c.ae(o))}return k},g:function(){for(var a=this.r(),b=this.a1(),c=!0,d=0;3>d&&this.o()&&b>0;){var e=this.k();b>e?(this.a7(a),b=e):d++,c=!c}if(this.b3(a),this.b1(),b>0){for(var f=1,g=0;1===f&&b>0;g++){this.e(),this.i();var h=this.a1();b>h?(f=1,this.a7(a)):f=-1,b=h}this.b3(a),this.b1()}return b},e:function(){for(var a=this.l(),b=this.r(),c=Ff.d(this._ac.x0()),d=this._ad.length-1;d>=0;d--)for(var e=this._ad[d].ah();e.i1();e.i2()){var f=e.i6();if(1===f.ak()&&1===f.ao()){var g=a.i1(f.ag());if(null!=g&&null==c[g.al()])for(var h=this.a4(f,g),i=g.al(),j=c[i]=Ff.d(h+1),k=j.length-1;k>=0;k--)j[k]=new oe}}for(var l=0;l<this._ad.length;l++)for(var m=this._ad[l].ah();m.i1();m.i2()){var n=m.i6();if(1===n.ak()&&1===n.ao()){var o=a.i1(n.ag());if(null!=o){var p=o.al(),q=this.a4(n,o)-1;c[p][q].ae(n.ae())}}else for(var r=n.ae();null!=r;r=r.a7()){var s=a.i1(r);if(null!=s){var t=s.al(),u=this.a4(n,s)-1;c[t][u].ae(r)}}}for(var v=this._ac.x9();v.i1();v.i2()){var w=v.i9();if(null!=c[w.al()])for(var x=w.ag();null!=x;x=x.a8()){var y=a.i1(x);if(null!=y)for(var z=c[y.al()];z[0].ay()>0;){for(var A,B=0;;){A=z[B].am();var C=A.a3();if(1!==C.ak()||1!==C.ao())break;B++}var D=z[B].at().a3();B--,D=A.a2(),A=z[B].at();for(var E=A.a3();B>=0;)if(b[D.al()]!==b[E.al()]&&(this._ab[D.al()]=b[E.al()]),D=D.ae().a2(),--B>=0){var F=z[B].at();E=F.a3()}}}}this.b1(),this._ac.xj(a)},i:function(){for(var a=this.f(),b=this.r(),c=Ff.d(this._ac.x0()),d=0;d<this._ad.length;d++)for(var e=this._ad[d].ah();e.i1();e.i2()){var f=e.i6();if(1===f.ak()&&1===f.ao()){var g=a.i1(f.ae());if(null!=g&&null==c[g.al()])for(var h=this.a4(g,f),i=g.al(),j=c[i]=Ff.d(h+1),k=j.length-1;k>=0;k--)j[k]=new oe}}for(var l=this._ad.length-1;l>=0;l--)for(var m=this._ad[l].ah();m.i1();m.i2()){var n=m.i6();if(1===n.ak()&&1===n.ao()){var o=a.i1(n.ae());if(null!=o){var p=o.al(),q=this.a4(o,n)-1;c[p][q].ae(n.ag())}}else for(var r=n.ag();null!=r;r=r.a8()){var s=a.i1(r);if(null!=s){var t=s.al(),u=this.a4(s,n)-1;c[t][u].ae(r)}}}for(var v=this._ac.x9();v.i1();v.i2()){var w=v.i9();if(null!=c[w.al()])for(var x=w.ae();null!=x;x=x.a7()){var y=a.i1(x);if(null!=y)for(var z=c[y.al()];z[0].ay()>0;){for(var A,B=0;;){A=z[B].am();var C=A.a2();if(1!==C.ak()||1!==C.ao())break;B++}var D=z[B].at().a2();B--,D=A.a3(),A=z[B].at();for(var E=A.a2();B>=0;)if(b[D.al()]!==b[E.al()]&&(this._ab[D.al()]=b[E.al()]),D=D.ag().a3(),--B>=0){var F=z[B].at();E=F.a2()}}}}this.b1(),this._ac.xj(a)},a4:function(a,b){return this._ah.i2(a)-this._ah.i2(b)},l:function(){for(var a=Le.a6(Ff.d(this._ac.xg())),b=this._ac.x9();b.i1();b.i2()){var c=b.i9();if(c.ao()>1){for(var d=0,e=c.ag();null!=e;e=e.a8()){var f=e.a3();1===f.ak()&&1===f.ao()&&d++}if(d>1)for(var g=c.ag();null!=g;g=g.a8()){var h=g,i=h.a3();if(1===i.ak()&&1===i.ao()){for(;1===i.ak()&&1===i.ao();i=h.a3())a.i8(h,c),h=i.ag();a.i8(h,c)}}}}return a},f:function(){for(var a=Le.a6(Ff.d(this._ac.xg())),b=this._ac.x9();b.i1();b.i2()){var c=b.i9();if(c.ak()>1){for(var d=0,e=c.ae();null!=e;e=e.a7()){var f=e.a2();1===f.ak()&&1===f.ao()&&d++}if(d>1)for(var g=c.ae();null!=g;g=g.a7()){var h=g,i=h.a2();if(1===i.ak()&&1===i.ao()){for(;1===i.ak()&&1===i.ao();i=h.a2())a.i8(h,c),h=i.ae();a.i8(h,c)}}}}return a},k:function(){for(var a=1;a<this._ad.length;a++){for(var b=this._ad[a],c=b.ah();c.i1();c.i2()){var d=c.i6();this._n[d.al()]=this.a5(d,b.ay(),d.am(),this._ad[a-1].ay()),this._n[d.al()]+=this._ab[d.al()]/(3*this._ad[a-1].ay())}this.a3(b,this._p)}return this.a1()},a5:function(a,b,c,d){var e=0;if(0===c.i7())e=d*this._ab[a.al()]/b;else{for(;c.i1();c.i2()){var f=c.i8();e+=f.a2()===a?this._ab[f.a3().al()]:this._ab[f.a2().al()]}e/=c.i7()}return e},a7:function(a){Ff.f(this._ab,a,a.length)},b3:function(a){Ff.f(a,this._ab,a.length)},r:function(){var a=Ff.a(this._ab.length);return this.a7(a),a},d:function(){for(var a=0;a<this._ad.length;a++)for(var b=0,c=this._ad[a].ah();c.i1();)this._ab[c.i6().al()]=b,c.i2(),b++},b1:function(){for(var a=0;a<this._ad.length;a++){for(var b=this._ad[a],c=b._b;null!=c;c=c.a()){var d=c.d();this._f[this._ab[d.al()]]=d}for(var e=0,f=b._b;null!=f;)f.c(this._f[e]),f=f.a(),e++}},a3:function(a,b){for(var c=a.ah(),d=0;d<a.ay();c.i2())this._f[d]=c.i6(),d++;Ff.s(this._f,a.ay(),b);for(var e=0,f=a._b;null!=f;)f.c(this._f[e]),this._ab[this._f[e].al()]=e,f=f.a(),e++}}),zf.b=function(a,b){if(null==a)return 0;var c=a.a()?Math.floor(b.x):0,d=a.a()?Math.floor(b.y):0;return a.e()?1e4-d:a.f()?-1e4+d:a.c()?-2e4-c:c},zf.a=function(a,b){if(null==a)return 0;var c=a.a()?Math.floor(b.x):0,d=a.a()?Math.floor(b.y):0;return a.e()?1e4+d:a.f()?-1e4-d:a.d()?-2e4-c:c};var Af=function(){Af.superClass.constructor.call(this),this._i6=0,this._i3=2147483647,this._i0=60,this._iz=20,this._i2=20,this._i4=20,this.i5(!1),this._i7=new sf,this._i1=new zf,this._i8=new vf};Jb.ext(Af,Oe,{j2:function(){return this._i2},i4:function(a){return!0},i3:function(a){this._i6=(new Date).getTime(),mf.d(a,!1);var b=a.xk(),c=a.xk(),d=a.xl(),e=new pe,f=new yf(a,b,c,d);f.a6(this.j2()),this._i8.i3(this._iz),this._i8.i6(this._i0),this._i8.i4(this._i2),this._i8.i5(this._i4),this._i8.i2(c);for(var g=this._i7.i1(a,b,e),h=e.c1();h.i1();h.i2()){var i=h.i8();d.i7(i,!0);var j=a.gn(i);a.gt(i,a.gk(i)),a.gz(i,j)}this.a2(a,b,c),g=f.a9(g);var k=this.j1(a,b,g);k=f.a5(k),k=f.b3(k),this._i8.i1(a,k,b),k=f.g2(k),f.e2(k),this.b(a,c),this.w(a),this.a1(a,e),f.e1(),a.xj(d),a.xi(c),a.xi(b)},j1:function(a,b,c){if(this._i1 instanceof zf){var d=this._i1,e=(new Date).getTime()-this._i6;d.ib(this._i3-e)}var f=this._i1.ia(a,b,c);return f},a1:function(a,b){for(var c=b.c1();c.i1();c.i2()){var d=c.i8(),e=a.gs(d),f=a.gl(d);a.x3(d);var g=a.gp(d);a.s5(d,g.a()),a.gy(d,e),a.gx(d,f)}},b:function(a,b){for(var c=a.x9();c.i1();c.i2()){var d=c.i9(),e=b.i1(d);if(null!=e&&!a.xp(e)){for(var f=d.am().i8().a2();null!=b.i1(f);f=d.am().i8().a2())d=f;a.u1(e);for(var g=d.ae(),h=new oe;null!=b.i1(g.a3());g=g.a3().ag()){var i=a.gs(g);h.aa(i),h.az(a.gf(g));var j=a.gl(g);j.equals(i)||h.aa(j)}var k=a.gs(g);h.aa(k),h.az(a.gf(g));var l=a.gl(g);l.equals(k)||h.aa(l),a.m1(e,h)}}for(var m=a.x9();m.i1();m.i2())null!=b.i1(m.i9())&&a.x4(m.i9())},w:function(a){for(var b=a.xf();b.i1();b.i2()){var c=b.i8(),d=a.g2(c);if(d.i1()>0){var e=new md,f=a.gc(c),g=f.c(),h=g.i6();g.i2();var i=h.x,j=h.y;if(g.i1()){var k=g.i6(),l=k.x,m=k.y;for(g.i2();g.i1();g.i2()){var n=g.i6(),o=n.x,p=n.y,q=(i-o)*(m-p)/(j-p)+o;Math.abs(q-l)>=1&&(e.add(k),i=l,j=m),k=n,l=o,m=p}}e.size()<d.i1()&&a.s5(c,new Vd(e))}}},a2:function(a,b,c){var d=a.g8().c1();for(d.i5();d.i1();d.i3()){var e=d.i8().a2(),f=d.i8().a3(),g=b.i2(f)-b.i2(e);if(g>1){for(var h=null,i=null,j=e;g>1;g--)h=a.xm(),a.s7(h,1,1),a.s4(h,df._A),i=a.xo(j,h),j===e&&a.gt(i,a.gn(d.i8())),b.i7(h,b.i2(j)+1),c.z1(h,d.i8()),j=h;i=a.xo(h,f),a.gz(i,a.gk(d.i8())),a.h1(d.i8())}}}});var Bf=function(a,b,c,d){this._i=20,this._j=a,this._g=b,this._a=c,this._h=d};Jb.ext(Bf,Object,{a1:function(a){this._i=a},b2:function(a){return null==this._e?!1:this._e.i4(a)},a3:function(a){return null==this._f?null:this._f.i1(a)},d:function(){this._j.xi(this._f),this._j.xi(this._e)}});var Cf=function(){this._c=0,this._i=0,this._g=0,this._j=0,this._f=0,this._h=0,this._d=0,this._e=0,this._a=0,this._b=0};Jb.ext(Cf,Object,{a:function(){return this._c-this._g-this._f-this._a},b:function(){return this._i+this._j+this._h+this._b}});var Df=function(){this._d=new pe,this._b=new pe,this._c=new pe,this._e=new pe};Jb.ext(Df,Object,{});var Ef=function(a,b,c,d,e,f,g,h){this._d=a,this._a=b,this._b=c,this._h=d,this._f=e,this._c=f,this._e=g,this._g=h};Jb.ext(Ef,Object,{});var Ff={};Ff.a=function(a,b){for(var c=[],d=0;a>d;d++)c[d]=b||0;return c},Ff.b=function(a){for(var b=[],c=0;a>c;c++)b[c]=!1;return b},Ff.c=function(a,b){if(a instanceof Qd)return a.x<b.x?-1:a.x>b.x?1:a.y<b.y?-1:a.y<=b.y?0:1;if(a instanceof Rd)return b.width>a.width?-1:b.width<a.width?1:b.height>a.height?-1:b.height>=a.height?0:1;if(a instanceof Td)return a.x<b.x?-1:a.x>b.x?1:a.y<b.y?-1:a.y>b.y?1:b.width>a.width?-1:b.width<a.width?1:b.height>a.height?-1:b.height>=a.height?0:1;throw"Unkown Type: "+a},Ff.d=function(a){for(var b=[],c=0;a>c;c++)b[c]=null;return b},Ff.e=function(a,b){for(var c=[],d=0;a>d;d++)c[d]=Ff.a(b);return c},Ff.f=function(a,b,c){for(var d=0;c>d;d++)b[d]=a[d]},Ff.s=function(a,b,c){var d=[];Ff.f(a,d,b),d.sort(c),Ff.f(d,a,b)},Ff.n=function(a,b){return a-b}}(this);
function inherit(e){function t(){}if(null==e)throw TypeError();if(Object.create)return Object.create(e);var i=typeof e;if("object"!==i&&"function"!==i)throw TypeError();return t.prototype=e,new t}var TTTTT=TTTTT||function(){var e=[];return{REVISION:"14",getAll:function(){return e},removeAll:function(){e=[]},add:function(t){e.push(t)},remove:function(t){t=e.indexOf(t),-1!==t&&e.splice(t,1)},update:function(t){if(0===e.length)return!1;for(var i=0,t=void 0!==t?t:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();i<e.length;)e[i].update(t)?i++:e.splice(i,1);return!0}}}();TTTTT.Tween=function(e){var t,i={},n={},o={},a=1e3,s=0,r=!1,l=!1,d=0,h=null,c=TTTTT.Easing.Linear.None,g=TTTTT.Interpolation.Linear,m=[],u=null,p=!1,f=null,v=null,y=null;for(t in e)i[t]=parseFloat(e[t],10);this.to=function(e,t){return void 0!==t&&(a=t),n=e,this},this.start=function(t){TTTTT.add(this),l=!0,p=!1,h=void 0!==t?t:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),h+=d;for(var a in n){if(n[a]instanceof Array){if(0===n[a].length)continue;n[a]=[e[a]].concat(n[a])}i[a]=e[a],!1==i[a]instanceof Array&&(i[a]*=1),o[a]=i[a]||0}return this},this.stop=function(){return l?(TTTTT.remove(this),l=!1,null!==y&&y.call(e),this.stopChainedTweens(),this):this},this.stopChainedTweens=function(){for(var e=0,t=m.length;t>e;e++)m[e].stop()},this.delay=function(e){return d=e,this},this.repeat=function(e){return s=e,this},this.yoyo=function(e){return r=e,this},this.easing=function(e){return c=e,this},this.interpolation=function(e){return g=e,this},this.chain=function(){return m=arguments,this},this.onStart=function(e){return u=e,this},this.onUpdate=function(e){return f=e,this},this.onComplete=function(e){return v=e,this},this.onStop=function(e){return y=e,this},this.update=function(t){var l;if(h>t)return!0;!1===p&&(null!==u&&u.call(e),p=!0);var y=(t-h)/a,y=y>1?1:y,C=c(y);for(l in n){var S=i[l]||0,I=n[l];I instanceof Array?e[l]=g(I,C):("string"==typeof I&&(I=S+parseFloat(I,10)),"number"==typeof I&&(e[l]=S+(I-S)*C))}if(null!==f&&f.call(e,C),1==y){if(!(s>0)){for(null!==v&&v.call(e),l=0,y=m.length;y>l;l++)m[l].start(t);return!1}isFinite(s)&&s--;for(l in o)"string"==typeof n[l]&&(o[l]+=parseFloat(n[l],10)),r&&(y=o[l],o[l]=n[l],n[l]=y),i[l]=o[l];h=t+d}return!0}},TTTTT.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return 1>(e*=2)?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return 1>(e*=2)?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return 1>(e*=2)?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return 1>(e*=2)?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:1>(e*=2)?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return 1>(e*=2)?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)))},Out:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)},InOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),1>(e*=2)?-.5*i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4):.5*i*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)+1)}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){return 1>(e*=2)?.5*e*e*(3.5949095*e-2.5949095):.5*((e-=2)*e*(3.5949095*e+2.5949095)+2)}},Bounce:{In:function(e){return 1-TTTTT.Easing.Bounce.Out(1-e)},Out:function(e){return 1/2.75>e?7.5625*e*e:2/2.75>e?7.5625*(e-=1.5/2.75)*e+.75:2.5/2.75>e?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return.5>e?.5*TTTTT.Easing.Bounce.In(2*e):.5*TTTTT.Easing.Bounce.Out(2*e-1)+.5}}},TTTTT.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,o=Math.floor(n),a=TTTTT.Interpolation.Utils.Linear;return 0>t?a(e[0],e[1],n):t>1?a(e[i],e[i-1],i-n):a(e[o],e[o+1>i?i:o+1],n-o)},Bezier:function(e,t){var i,n=0,o=e.length-1,a=Math.pow,s=TTTTT.Interpolation.Utils.Bernstein;for(i=0;o>=i;i++)n+=a(1-t,o-i)*a(t,i)*e[i]*s(o,i);return n},CatmullRom:function(e,t){var i=e.length-1,n=i*t,o=Math.floor(n),a=TTTTT.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(0>t&&(o=Math.floor(n=i*(1+t))),a(e[(o-1+i)%i],e[o],e[(o+1)%i],e[(o+2)%i],n-o)):0>t?e[0]-(a(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[i]-(a(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):a(e[o?o-1:0],e[o],e[o+1>i?i:o+1],e[o+2>i?i:o+2],n-o)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=TTTTT.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var e=[1];return function(t){var i,n=1;if(e[t])return e[t];for(i=t;i>1;i--)n*=i;return e[t]=n}}(),CatmullRom:function(e,t,i,n,o){var e=.5*(i-e),n=.5*(n-t),a=o*o;return(2*t-2*i+e+n)*o*a+(-3*t+3*i-2*e-n)*a+e*o+t}}},function(){function e(e){e.setStyle("select.offset",1),e.setStyle("select.width",1)}function n(e,t,i){if(t=t||[],e.length<=3)return t.push(e),t;for(var a=[],r=e.length,l=[],d=[],h=0,c=0;r>c;c++){var g=e[c],m=e[c+1===r?0:c+1],u={x:m.x-g.x,y:m.y-g.y};l.push(u),d.push(g),h+=(m.x-g.x)*(m.y+g.y)}i=void 0===i?0>h:i;for(var p=l.length,f=!1,c=0;p-1>c;c++)if(o(l[c],l[c+1],i)){for(var v=c+1,y=null,C=0;p>C;C++)if(s(e[C],e[v-1],e[v],i)<0&&s(e[C],e[v],e[v+1===r?0:v+1],i)<0){y=C;break}if(null===y&&(y=v-2,0>y&&(y+=e.length)),null!=y){var S=y;S>v&&(S-=e.length);for(var I=S;v>=I;I++){var P=I;0>P&&(P+=e.length),a.push(e[P])}t.push(a);for(var I=v-1;I>S;I--){var P=I;0>P&&(P+=e.length);var A=e[P],E=d.indexOf(A);d.splice(E,1)}n(d,t,i),f=!0}break}return d.length>0&&!f&&t.push(d),t}function o(e,t,i){var n=i?1:-1;return(e.x*t.y-t.x*e.y)*n<0?!0:!1}function s(e,t,i,n){var o=n?1:-1;if(!e||!t||!i)return 1;var a=-e.x*t.y-t.x*i.y-i.x*e.y+i.x*t.y+t.x*e.y+e.x*i.y;return a*o}OUTLINE_SHAPE="dshape",WALL_INNER_PATH="wallInnerPic",WALL_OUTER_PATH="wallOuterPic",WALL_CLOSED="shapenode.closed",WALL_SIZE="size",POLE_IMAGE_PATH="poleTexture",USE_TEXTURE="useTexture",OUTFRAME_IMAGE_PATH="framePic",POLE_SEGMENTS="poleSegments",IS_INNER_WALL="isInnerWall",BELONG_ID="edgeIndex",BLOCK_OFFSET="offset",IMAGE_SRC="picture",SPACE_POS_Y="positionY",SPACE_SIZE="size",BTYPE="bType",GID="gid",OID="oid",SPACE_POSITION="position",SHAPE_TYPE="className",DESIGN_SCALE="oscale",SPACE_SCALE="scale",SPACE_ROTATION="rot",SIZE_LENGTH="length",SIZE_DEPTH="depth",SIZE_HEIGHT="height",TEXTURE="texture",PRIMITIVE_NAME="primitiveName",HOST_NODE_ID="hostNodeId",FLOOR_HEIGHT="floorHeight",BID="businessId",GENERAL="General",CUSTOM_PROPS="customProps",SPE_STR="specularStrength",TRA_PAR="transparent",OPA="opacity",ANGLE="angle",MAIN_VISIBLE="mainVisible",LIB_PRIMITIVES="primitivesLib",LIB_ASSEMBLES="assemblesLib",LIB_GRAPH="graphLib",LIB_COMPONENTS="componentLib",TAG_ANIMATION="animation",FLOOR_NAME="floorName",FLOOR_HEIGHT="floorHeight",FLOOR_VISIBLE="floorVisible",FLOOR_REF="floorRef",FLOOR_LAYER="floorLayer",PATH="path",SEGMENTSH="segmentsH",SEGMENTSR="segmentsR",ARC="arc",START_CLOSED="startClosed",END_CLOSED="endClosed",VERTICES="vertices",FACES="faces",UVS="uvs",LOAD_RESOURCE_TYPE="loadResource",CLOUD_KEY="cloudKey",CLOUD_PASSWORD="cloudPassword",TYPE_LOCAL="local",TYPE_CLOUD="cloud",MONO_URL="https://mono-design.cn/api",MONO_URL_LOGIN="https://mono-design.cn/login",MONO_URL_LOGOUT="https://mono-design.cn/logout",SHOW_FLOOR="showFloor",ALL_VIEW_SELECTABLE="allViewSelectable",AMBIENT_LIGHT_ON="ambientLightOn",AMBIENT_LIGHT_COLOR="ambientLightColor",POINT_LIGHT_ON="pointLightOn",POINT_LIGHT_POSITION="pointLightPosition",POINT_LIGHT_COLOR="pointLightColor",POINT_LIGHT_INTENSITY="pointLightIntensity",POINT_LIGHT_ON1="pointLightOn1",POINT_LIGHT_POSITION1="pointLightPosition1",POINT_LIGHT_COLOR1="pointLightColor1",POINT_LIGHT_INTENSITY1="pointLightIntensity1",POINT_LIGHT_ON2="pointLightOn2",POINT_LIGHT_POSITION2="pointLightPosition2",POINT_LIGHT_COLOR2="pointLightColor2",POINT_LIGHT_INTENSITY2="pointLightIntensity2",POINT_LIGHT_ON3="pointLightOn3",POINT_LIGHT_POSITION3="pointLightPosition3",POINT_LIGHT_COLOR3="pointLightColor3",POINT_LIGHT_INTENSITY3="pointLightIntensity3",POINT_LIGHT_ON4="pointLightOn4",POINT_LIGHT_POSITION4="pointLightPosition4",POINT_LIGHT_COLOR4="pointLightColor4",POINT_LIGHT_INTENSITY4="pointLightIntensity4",POINT_LIGHT_ON5="pointLightOn5",POINT_LIGHT_POSITION5="pointLightPosition5",POINT_LIGHT_COLOR5="pointLightColor5",POINT_LIGHT_INTENSITY5="pointLightIntensity5",SHOW_PROPERTY_SHEET="showPropertySheet",SHOW_AXIS="showAxis",SHOW_AXIS_TEXT="showAxisText",SHOW_DIM="showDim",SHOW_COORD="showCoord",SHOW_TARGET_FLAG="showTargetFlag",SHOW_GRID="showGrid",GRID_GAP="gridGap",SNAPGRID="snapGrid",DECIMAL_NUMBER="decimalNumber",IS_FULL_ROTATION="isFullRotation",IS_FULL_ROTATION_COMPONENT="isFullRotationComponent",ZOOM_SPEED="zoomSpeed",ROTATE_SPEED="rotateSpeed",PAN_SPEED="panSpeed",MAX_DISTANCE="maxDistance",MIN_DISTANCE="minDistance",ZOOM_SPEED_COMPONENT="zoomSpeedComponent",ROTATE_SPEED_COMPONENT="rotateSpeedComponent",PAN_SPEED_COMPONENT="panSpeedComponent",MAX_DISTANCE_COMPONENT="maxDistanceComponent",MIN_DISTANCE_COMPONENT="minDistanceComponent",SHOW_ORIGINAL_FLAG="showOriginalFlag",SCALE_MIN_LIMIT="scaleMinLimit",SCALE_MAX_LIMIT="scaleMaxLimit",ENABLE_SCALE="enableScale",COMPONENT_TEMPLATES="componentTemplates",PUBLIC_TEMPLATES="Public Templates",TEMPLATES="Private Templates",ROOMS="Rooms",SUBTITLE_ROOM="Room",SUBTITLE_COMPONENT="Component",SUBTITLE_MODEL="Container",DEFALUT_POINTS_SHAPE="-200,0,-200,200,0,-200,200,0,200,-200,0,200",PropertyConsts={ROOM_PRIVATE_CATEGORY:"roomPrivateCategory",ROOM_PUBLIC_CATEGORY:"roomPublicCategory",COMPONENT_PRIVATE_CATEGORY:"componentPrivateCategory",COMPONENT_PUBLIC_CATEGORY:"componentPublicCategory",SCOPE_PRIMITIVE:0,SCOPE_PUBLIC:1,Font:{fontFamily:["gentilis","helvetiker","optimer"],fontStyle:["bold","normal"]},WRAPMODE:["six-each","front-other","back-other","left-other","right-other","top-other","bottom-other"],CUSTOM_PROPS:["p1","p2","p3","p4"],FloorStyle:{BUFFER_NODE_FLOOR:"Half Transparent",PLANE_FLOOR:"Wireframe"},FloorSize:{SMALL:"Small",MEDIUM:"Medium",LARGE:"Large"},LocalStorage:{FLOOR_STYLE:"floorStyle",FLOOR_SIZE:"floorSize",SELECT_STYLE:"selectStyle"},COMPONENTFLOOR:"componentFloor",MONO_KEY:"mono2025",MONO_IMG_PRE:"https://mono-design.cn/",MONO_URL_PRE:"https://mono-design.cn/",TYPE_ROOMS:"rooms",TYPE_COMPONENT:"component",TYPE_ROOTCATEGORY:"rootCategory",DEFAULT_IMAGE:"crash.png",NEAR_PLANE:"nearPlane",FAR_PLANE:"farPlane",FOV:"fov",NEAR_PLANE_COMPONENT:"nearPlaneComponent",FAR_PLANE_COMPONENT:"farPlaneComponent",FOV_COMPONENT:"fovComponent",ORDER_BY_ASC:0,ORDER_BY_DESC:1,LINK_STYPE:["","orthogonal.x","orthogonal.x.n","orthogonal.y","orthogonal.y.n","orthogonal.z","orthogonal.z.n","control"],SELECT_STYLE:{WIREFRAME:"wireframe",NORMAL:"normal",BORDER:"border"},Layer:{WALL:"Wall",FLOOR:"Floor",WINDOW:"Window",DOOR:"Door",PIPE:"Pipe",BILLBOARD:"Billboard",TEMPLATE:"Template",DEFAULT:"default"},LAYERID:"layerId",ENABLE_EASING:"enableEasing",TEMPLATE_AUTHOR:"templateAuthor",SHOW_RULER_GUIDES:"showRulerGuides",SHOW_RULER:"showRuler",SCALE_UNIT_TEXT:"scaleUnitText"},Utils={Path:"images/",RelativePath:"",renderGl3dview:function(e,t,i){e.setRenderCallback(i)},createDraggableGl3dview:function(e){if(!e)var e=new twaver.gl3dview.Gl3dview;return e.getView().addEventListener("dragover",function(e){return e.preventDefault?e.preventDefault():e.returnValue=!1,e.dataTransfer.dropEffect="copy",!1},!1),e.setEditableFunction(function(e){return"unresize"!==e.getClient("resize")}),e.getView().addEventListener("drop",function(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault?t.preventDefault():t.returnValue=!1;var i=t.dataTransfer.getData("Text");Utils._handle2dDrop(t,i,e)},!1),e},_handle2dDrop:function(e,t,i){if(!t)return!1;var n=JSON.parse(t),o=i.getElementBox();if(void 0!==n.className&&"twaver.Grid"===n.className){var a,s,r,l;o.forEach(function(e){e instanceof ImageNode&&(a=e.getWidth(),s=e.getHeight(),r=e.getLocation(),l=e)});var d=Utils._createGrid(a,s,r,l);o.add(d)}else if("Material"===n.classType){var h=i.getElementAt(e);console.log(h),h instanceof twaver.Follower&&!(h.getParent()instanceof ImageNode)?(Utils.registerImage(Utils.Path+n.material,i),h.setImage(Utils.Path+n.material),h.setClient("material",n.material),handleText2d(i)):null==h&&o.forEach(function(e){if(e instanceof ImageNode){var t=Utils.Path+n.material;Utils.registerImage(t,i),e.setImage(t),0==faceObject.faceIndex?faceObject.element.setStyle("right.m.texture.image",t):1==faceObject.faceIndex?faceObject.element.setStyle("left.m.texture.image",t):2==faceObject.faceIndex?faceObject.element.setStyle("top.m.texture.image",t):3==faceObject.faceIndex?faceObject.element.setStyle("bottom.m.texture.image",t):4==faceObject.faceIndex?faceObject.element.setStyle("front.m.texture.image",t):5==faceObject.faceIndex&&faceObject.element.setStyle("back.m.texture.image",t)}})}else if("Cube"===n.classType)if(_twaver.isShiftDown(e))Utils.showPortDialog(i,e,n,t);else{var l=i.getElementAt(e),c=Utils.Path+n.material,a=n.args.x,s=n.args.y,g=Utils._createFollower(e,l,c,n.resize,a,s,t,i);o.add(g),o.getSelectionContainer().setSelection(g),handleText2d(i)}else if("Template"===n.classType){var m=Utils.Path+"default_texture.png";if(loadResource===TYPE_CLOUD)modelManager.loadTemplatesAssembleSize(n.id,this,function(n){var a=i.getElementAt(e),s=Utils._createFollower(e,a,m,"unresize",n.x,n.y,t,i);o.add(s),handleText2d(i)});else{var u=modelManager.loadTemplatesAssembleSize(n.id),l=i.getElementAt(e),g=Utils._createFollower(e,l,m,"unresize",u.x,u.y,t,i);o.add(g),handleText2d(i)}}},_createGrid:function(e,t,i,n){var o=new CGrid;return o.setLocation(i),o.setSize(e,t),o.setStyle("grid.border",1),o.setStyle("grid.row.count",3),o.setStyle("grid.column.count",3),o.setStyle("grid.deep",1),o.setStyle("whole.alpha",.6),o.setClient("grid.outer.padding",0),o.setClient("width",e),o.setClient("height",t),o.setClient("location",i),o.setClient("offset",.1),o.setStyle("grid.padding",1),o.setParent(n),o},_createFollower:function(e,t,i,n,o,a,s,r){var l=new twaver.Follower;if(Utils.registerImage(i,r,"component"),l.setImage(i),l.setClient("text",s),l.setClient("resize",n),t instanceof twaver.Grid){var d=r.getLogicalPoint(e),h=t.getCellObject(d);if(null!=h){"unresize"===n&&(l.setStyle("follower.fill.cell",!1),l.setWidth(o*r.zoom),l.setHeight(a*r.zoom)),l.setStyle("follower.row.index",h.rowIndex),l.setStyle("follower.column.index",h.columnIndex),l.setParent(t),l.setHost(t);var c=l.getParent().getParent(),g=l.getCenterLocation().x-c.getCenterLocation().x,m=l.getCenterLocation().y-c.getCenterLocation().y;l.setClient("offsetX",g/r.zoom),l.setClient("offsetY",m/r.zoom);var u=t.getClient("offset");l.setClient("offset",u+.15),l.setClient("selfID",l.getId()),l.setClient("hostCell",t),console.log("translate to 2d")}}return l},createDraggableGl3dview3D:function(e){if(!e)var e=new(new mono.Gl3dview3D);return e.getRootView().addEventListener("dragover",function(e){return e.preventDefault?e.preventDefault():e.returnValue=!1,e.dataTransfer.dropEffect="copy",!1},!1),e.getRootView().addEventListener("drop",function(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault?t.preventDefault():t.returnValue=!1;var i=t.dataTransfer.getData("Text");return i?(Utils._handle3dDrop(t,i,e),!1):!1},!1),e.getRootView().setAttribute("draggable","true"),e},_findFirstObjectByMouse:function(e,t,i){i||(i=function(e){return!(e instanceof mono.Billboard||e.getClient(PropertyConsts.COMPONENTFLOOR))});var n=e.getElementsByMouseEvent(t);if(n.length)for(var o=0;o<n.length;o++){var a=n[o],s=a.element;if(i(s))return a}return null},_init3dObject:function(t){var i=Utils.Path+"default_texture.png";t.setStyle("m.texture.image",i),t.setStyle("m.texture.wrapS",mono.RepeatWrapping),t.setStyle("m.texture.wrapT",mono.RepeatWrapping),t.setStyle("m.texture.repeat",new mono.XiangliangTwo(3,3)),t.setStyle("m.side",mono.DoubleSide),t.setStyle("m.type","phong"),t.setEditable(!0),t.setSelectable(!0),e(t)},_createPath:function(e,t){var i=t||1,n=new mono.Path;if(e instanceof Array)for(var o=e.concat();o&&o.length>0;){var a=o.shift();"m"===a&&n.moveTo(parseInt(o.shift()*i),parseInt(o.shift()*i),parseInt(o.shift()*i)),"l"===a&&n.lineTo(parseInt(o.shift()*i),parseInt(o.shift()*i),parseInt(o.shift()*i)),"c"===a&&n.curveTo(parseInt(o.shift()*i),parseInt(o.shift()*i),parseInt(o.shift()*i),parseInt(o.shift()*i),parseInt(o.shift()*i),parseInt(o.shift()*i))}return n},_createPrimitiveObject:function(e,t){var i,n=("mono."+e.className,Utils.Path+"default_texture.png",e.args);if("Cube"===e.className&&(i=new mono.Cube(n.x,n.y,n.z)),"Sphere"===e.className&&(i=new mono.Sphere(n.radius)),"Cylinder"===e.className){var o=window.prompt("Segment count:",n.radialSegments);if(null===o)return;i=new mono.Cylinder(n.radiusTop,n.radiusBottom,n.height,o),n.smooth?(i.setStyle("m.normalType",mono.NormalTypeSmooth),i.setStyle("top.m.normalType",mono.NormalTypeFlat),i.setStyle("bottom.m.normalType",mono.NormalTypeFlat)):i.setStyle("m.normalType",mono.NormalTypeFlat)}if("Torus"===e.className&&(i=new mono.Torus(n.radius,n.tube,n.radialSegments,n.tubularSegments)),"PathNode"===e.className&&(i=new mono.PathNode(Utils._createPath(n.path),n.pathSegments,n.radius,n.shapeSegments,n.startCap,n.endCap),i.setSegmentsCap(10),n.startCapSize&&i.setStartCapSize(n.startCapSize),n.endCapSize&&i.setEndCapSize(n.endCapSize)),"TextNode"===e.className){var a=[{label:"Text:",id:"text3d",value:n.text,tab:"Properties"},{label:"Font:",id:"font3d",type:"select",options:PropertyConsts.Font.fontFamily,value:n.font,tab:"Properties"},{label:"Style:",id:"style3d",type:"select",options:PropertyConsts.Font.fontStyle,value:n.style,tab:"Properties"}],s="Text Property",r=function(e){var i=new mono.TextNode(e.text3d,null,n.height,e.font3d,e.style3d),o=n.scale||1;i.setScale(o,o,o),Utils._init3dObject(i),t.add(i),t.getSelectionContainer().clearSelection(),i.setSelected(!0)};return void Utils.showInputDialog(a,s,!0,r)}return Utils._init3dObject(i),i},_createLatheObject:function(e){var t=new GridGl3dview;t.setInteractions([new twaver.canvas.interaction.CreateShapeNodeInteraction(t,window.RoundPipeShapeNode),new twaver.canvas.interaction.EditInteraction(t,!1),new twaver.canvas.interaction.DefaultInteraction(t)]),t.setEditPointSize(10),t.addElementByInteraction=function(e){twaver.canvas.Gl3dview.prototype.addElementByInteraction.call(this,e),setTimeout(function(){t.setInteractions([new twaver.canvas.interaction.EditInteraction(t,!1),new twaver.canvas.interaction.SelectInteraction(t),new twaver.canvas.interaction.MoveInteraction(t,!1),new twaver.canvas.interaction.DefaultInteraction(t)])},500)};var i=new twaver.Node("axis");Utils.registerImage(Utils.Path+"axis.png"),i.setImage(Utils.Path+"axis.png"),i.setLocation(400,100),i.setStyle("select.style","none"),t.setEditableFunction(function(e){return e===i?!1:!0}),t.getElementBox().add(i);var n=document.createElement("div"),o=document.createElement("p");o.innerHTML="Note:double click to end path",n.appendChild(o),n.style.width="800px",n.style.height="400px",n.appendChild(t.getView()),setTimeout(function(){t.adjustBounds({width:800,height:400}),t.getView().style.position="relative"},100);var a=[{id:"shapePath",type:"div",value:n,tab:"Path"},{label:"Height Segments:",id:"segmentsH",value:64,tab:"Properties"},{label:"Radius Segments:",id:"segmentsR",value:20,tab:"Properties"},{label:"Rotation Angle:",id:"rotationAngle",value:360,tab:"Properties"},{label:"Start Closed:",id:"startClosed",checked:!1,type:"checkbox",tab:"Properties"},{label:"End Closed:",id:"endClosed",checked:!1,type:"checkbox",tab:"Properties"}],s="Lathe Property",r=function(t,i){var n=new mono.Path;if(t){var o,a=t.getElementBox().getDatas();a.forEach(function(e){e instanceof PipeShapeNode&&(o=e)});var s=t.getElementBox().getDataById("axis"),r=s.getRect(),l={x:r.x+7,y:r.y+r.height};if(o){var d=o.getPoints();if(d&&d.size()>1){var h=d.get(0);n.moveTo(h.x-l.x,l.y-h.y,0);for(var c=1;c<d.size();c++)h=d.get(c),n.lineTo(h.x-l.x,l.y-h.y,0)}var g=parseInt(i.segmentsH),m=parseInt(i.segmentsR),u=parseInt(i.rotationAngle)*Math.PI/180,p=new mono.LatheNode(n,g,m,u,i.startClosed,i.endClosed);p.setStyle("m.side",TGL.DoubleSide).setStyle("m.texture.image","images/default_texture.png"),e.add(p)}}};Utils.showInputDialog(a,s,!0,r,this,[t])},_createPipeObject:function(e){var t=e.getInteractions(),i=!1;t.forEach(function(t){t instanceof ComponentsDragPipeInteraction&&(t=new ComponentsDragPipeInteraction(e),i=!0)}),i||(t.push(new ComponentsDragPipeInteraction(e)),e.setInteractions(t))},_setDropPosition:function(e,t,i){var n=t.getElementsByMouseEvent(e);if(n.length){var o=n[0],a=(o.element,o.point);i.setPosition(a)}},_handle3dDrop:function(t,i,n,o){var a=JSON.parse(i);if("Primitive"===a.classType){var s=Utils._createPrimitiveObject(a,n.getServa());s&&(Utils._setDropPosition(t,n,s),n.getServa().add(s),n.getServa().getSelectionContainer().clearSelection(),s.setEditable(!0),s.setSelectable(!0))}if("Pipe"===a.classType&&Utils._createPipeObject(n),"Combo"===a.classType){for(var r=(a.className,Utils.Path+"default_texture.png"),l=a.primitives,d=a.ops,h=0;h<l.length;h++){var c=l[h],s=Utils._createPrimitiveObject(c);s&&(c.position&&s.setPosition(c.position.x,c.position.y,c.position.z),c.rotation&&s.setRotation(c.rotation.x,c.rotation.y,c.rotation.z),e(s)),l[h]=s}var g=new mono.ComboNode(l,d,!0);e(g),Utils._setDropPosition(t,n,s),n.getServa().add(g),n.getServa().getSelectionContainer().clearSelection(),g.setEditable(!0),g.setSelectable(!0)}if("Lathe"===a.classType&&Utils._createLatheObject(n.getServa()),"Billboard"===a.classType){var m,u=Utils._findFirstObjectByMouse(n,t);u&&(m=u.element);var r=Utils.Path+a.material,s=new mono.Billboard;if(s.setStyle("m.texture.image",r),s.setStyle("m.alignment",mono.BillboardAlignment.bottomCenter),s.setStyle("m.transparent",!1),s.setStyle("m.opacity",1),s.setStyle("m.vertical",!0),m){s.setParent(m),m.boundingBox||m.computeBizBox();var p=m.boundingBox.max.y;s.setPosition(0,p,0)}else Utils._setDropPosition(t,n,s);s.setEditable(!0),s.setSelectable(!0),s.setScale(a.args.x,a.args.y,1),n.getServa().add(s)}if("Cube"===a.classType){var f=Utils.Path+a.material,v=Utils.Path+"brush_metal.png",y=a.args,C=!1;a.transparent&&(C=a.transparent);var s=new mono.Cube(y.x,y.y,y.z);s.setStyle("m.texture.image",v),s.setStyle("m.texture.repeat",new mono.XiangliangTwo(1,1)),s.setClient("shape",a.shape);var S=["front"];a.faces&&(S=a.faces);for(var I=0;I<S.length;I++){var P=S[I];s.setStyle(P+".m.texture.image",f),s.setStyle(P+".m.transparent",C)}s.setEditable(!0),s.setSelectable(!0),e(s),Utils._setDropPosition(t,n,s);var u=Utils._findFirstObjectByMouse(n,t);if(Utils.stickOnSurface(s,n,t,u),a.text){var i=window.prompt("Text:",a.text.content),A=new mono.TextNode(i,null,a.text.height,a.text.font,a.text.style),E=a.text.scale||1;A.setScale(E,E,E),A.setEditable(!0),A.setSelectable(!0),A.setParent(s),A.editTransformToParent=!0,A.setStyle("m.texture.image",Utils.Path+a.text.material),e(A);var u=Utils._findFirstObjectByMouse(n,t);Utils.stickOnSurface(A,n,t,u),a.text.position&&A.setPosition(s.getPosition().x+a.text.position.x,s.getPosition().y+a.text.position.y,s.getPosition().z+a.text.position.z),a.text.rotation&&A.setRotation(s.getRotation().x+a.text.rotation.x,s.getRotation().y+a.text.rotation.y,s.getRotation().z+a.text.rotation.z),n.getServa().add(A)}n.getServa().add(s);var w;if(a.panel){if(w=new mono.Cube(a.panel.x,a.panel.y,a.panel.z),w.setStyle("m.texture.image",v),a.panel.pic){var b=Utils.Path+a.panel.pic;w.setStyle("front.m.texture.image",b)}w.setParent(s),w.editTransformToParent=!0,w.getPosition().z+=s.depth/2,e(w),n.getServa().add(w);var x=s.getId()+":"+w.getId();s.setGroupId(x),w.setGroupId(x)}if(o){s.setClient("cellID",o.getId());var _=faceObject.element.depth;"verticalCard"===a.shape?(s.setHeight(o.getHeight()),w&&w.setHeight(o.getHeight())):"horizontalCard"===a.shape?(s.setWidth(o.getWidth()),w&&w.setWidth(o.getWidth())):"cube"===a.shape&&(s.setWidth(o.getWidth()),s.setHeight(o.getHeight()),s.setDepth(_/10));var T=o.getClient("offsetX"),O=o.getClient("offsetY");setPositionByRelative(faceObject.faceIndex,s,T,O)}}if("Material"===a.classType){var r=a.material?Utils.Path+a.material:null,N=1,L=1,M=!0,C=!1;a.texture&&(N=a.texture.row,L=a.texture.column),void 0!==a.visible&&(M=a.visible),a.transparent&&(C=a.transparent);var u=Utils._findFirstObjectByMouse(n,t);if(u)if(a.texture){var R=[{label:"Row:",id:"row",value:N},{label:"Column:",id:"column",value:L},{label:"Scope:",id:"useForAllFaces",type:"checkbox",inner:"Use this material for all faces"}];Utils.showInputDialog(R,"Set Material",!0,this.setMaterial,this,[r,M,C,u])}else{var U={};U.row=N,U.column=L,this.setMaterial(r,M,C,u,U,a.wrapMode)}}if("Dye-Color"===a.classType){var u=Utils._findFirstObjectByMouse(n,t),D=a.color;if(u&&D){var s=u.element,R=[{label:"Scope:",id:"useForAllFaces",type:"checkbox",inner:"Use this dye color for all faces"}];Utils.showInputDialog(R,"Set Dye Color",!0,this.setDyeColor,this,[D,u])}}if("Template"===a.classType){var k="Load Template",B=[{label:"","class":"lb-save-template",id:"opentemp",name:"templates",type:"radio",checked:!0,inner:"Open template in the scense"},{label:"","class":"lb-save-template",id:"loadtemp",name:"templates",type:"radio",checked:!1,inner:"Insert template in the scense"}];Utils.showInputDialog(B,k,!0,function(e){var i=Utils._findFirstObjectByMouse(n,t),o=modelManager.loadComponentTemplate(n.getServa(),a.id,e.opentemp,this,function(o){e.opentemp||(Utils._setDropPosition(t,n,o),o.setPositionY(o.getHeight()/2),Utils.stickOnSurface(o,n,t,i))});o&&!e.opentemp&&(Utils._setDropPosition(t,n,o),o.setPositionY(o.getHeight()/2),Utils.stickOnSurface(o,n,t,i))})}n.getView().focus()},stickOnSurface:function(e,t,i,n){if(n){var o=n.face,a=n.element,s=n.point;a.getPosition();s=a.worldToLocal(s),e.setParent(a),e.setPosition(s.x,s.y,s.z),e.getPosition().z+=1,e.setClient("faceIndex",o.materialIndex);var r=o.normal.clone();a.setClient("parentFaceIndex",o.materialIndex);for(var l,d,h=e.getParent();h;)l=h,d=l.getClient("parentFaceIndex"),h=h.getParent();0==d?r=new mono.XiangliangThree(1,0,0):1==d?r=new mono.XiangliangThree(-1,0,0):2==d?r=new mono.XiangliangThree(0,1,0):3==d?r=new mono.XiangliangThree(0,-1,0):4==d?r=new mono.XiangliangThree(0,0,1):5==d&&(r=new mono.XiangliangThree(0,0,-1)),r=r.applyMatrix4((new mono.Mat4).extractRotation(a.matrix)),r.normalize();var c=new mono.XiangliangThree(0,0,1),g=Math.acos(r.dot(c)/r.length()/c.length()),m=(new mono.XiangliangThree).crossVectors(r,c).normalize(),u=new mono.Mat4;u.makeRotationAxis(m,-g);var p=(new mono.XiangliangThree).setEulerFromRotationMatrix((new mono.Mat4).extractRotation(u)),p=a.getRotation();e.setRotation(p)}Utils.isCtrlDown(i)&&e.setRotationZ(e.getRotation().z+Math.PI/2)},setDyeColor:function(e,t,i){var n=t.face,o=t.element,a=n.materialIndex;if(i.useForAllFaces){var s="m.color";o.setStyle(s,e),s="m.ambient",o.setStyle(s,e)}else{var s="m.color";o.getIndexSideMapping()&&(s=o.getIndexSideMapping()[a]+"."+s),o.setStyle(s,e),s="m.ambient",o.getIndexSideMapping()&&(s=o.getIndexSideMapping()[a]+"."+s),o.setStyle(s,e)}},setMaterial:function(e,t,i,n,o,a){repeatRow=parseInt(o.row),repeatColumn=parseInt(o.column);var s,r=n.element,l=n.face,d=l.materialIndex,h=o.useForAllFaces,c=r.getIndexSideMapping();if(!a&&c&&(s=r.getIndexSideMapping()[d],s+="."),void 0===s){var g=["m.texture.image","m.texture.repeat","m.visible","m.transparent"];for(nameIndex in g){var m,u=g[nameIndex],p=r.getStyle(u,!0,!0)||[];if("m.texture.image"===u&&e&&(m=e),"m.texture.repeat"===u&&(m=new mono.XiangliangTwo(repeatRow,repeatColumn)),"m.visible"===u&&(m=t),"m.transparent"===u&&(m=i),h)for(var f=0;f<p.length;f++)p[f]=m;else p[d]=m;r.setStyle(u,p)}a&&(r.setStyle("m.texture.image",e),r.setStyle("m.texture.repeat",new mono.XiangliangTwo(1,1)),r.setWrapMode(a))}else if(h){if(c)for(var f=0;f<r.getIndexSideMapping().length;f++){var s=r.getIndexSideMapping()[f];s+=".",r.setStyle(s+"m.texture.image",null),r.setStyle(s+"m.texture.repeat",null),r.setStyle(s+"m.visible",null),r.setStyle(s+"m.transparent",null)}r.setStyle("m.texture.image",e),r.setStyle("m.texture.repeat",new mono.XiangliangTwo(repeatRow,repeatColumn)),r.setStyle("m.visible",t),r.setStyle("m.transparent",i)}else r.setStyle(s+"m.texture.image",e),r.setStyle(s+"m.texture.repeat",new mono.XiangliangTwo(repeatRow,repeatColumn)),r.setStyle(s+"m.visible",t),r.setStyle(s+"m.transparent",i)},registerImage:function(e,t,i,n,o,a){var s=new Image;e.startsWith("data:image")?s.src=e:(s.crossOrigin="",s.src=Utils.RelativePath+e);var r=arguments;a&&(e=a),s.onload=function(){"component"==i?twaver.Util.registerImage(e,s,s.width,s.height,t):twaver.Util.registerImage(e,s,s.width,s.height),n&&n.call(o,s.width,s.height);for(var a=1;a<r.length;a++){var l=r[a];l&&l.invalidateElementUIs&&l.invalidateElementUIs(),l&&l.invalidateDisplay&&l.invalidateDisplay()}}},getImageName:function(e){var t=e.lastIndexOf("/"),i=e;return t>=0&&(i=e.substring(t+1)),t=i.lastIndexOf("."),t>=0&&(i=i.substring(0,t)),i},addMask:function(e){var t;parseInt(document.body.scrollWidth),parseInt(document.body.scrollHeight);return t=document.createElement("div"),e?t.setAttribute("id","mask_"+e):t.setAttribute("id","mask"),t.setAttribute("class","mask"),document.body.appendChild(t),t},randomInt:function(e){return Math.floor(Math.random()*e)},randomColor:function(){var e=Utils.randomInt(255),t=Utils.randomInt(255),i=Utils.randomInt(255);return"#"+Utils._formatNumber(e<<16|t<<8|i)},_formatNumber:function(e){for(var t=e.toString(16);t.length<6;)t="0"+t;return t},changeTwoDecimal:function(e){return Utils.changeDecimalDigit(e,2)},rChangeTwoDecimal:function(e){return e?parseFloat(e.toString().replace(/[^\d\.-]/g,"")):0},changeDecimalDigit:function(e,n){n=n>0&&20>=n?n:2,e=Utils.rChangeTwoDecimal(e),e=parseFloat((e+"").replace(/[^\d\.-]/g,"")).toFixed(n)+"";var o=e.split(".")[0].split("").reverse(),a=e.split(".")[1];for(t="",i=0;i<o.length;i++)t+=o[i];var s=t.split("").reverse().join("")+"."+a;return parseFloat(s)},disposeDialog:function(e){document.getElementById("mask_"+e)?document.body.removeChild(document.getElementById("mask_"+e)):document.body.removeChild(document.getElementById("mask")),document.body.removeChild(document.getElementById(e))},parameterReset:function(e,t){if(this.setButtonStyle(e),"ScaleReset"===e){var i=document.getElementById(t+"X");i.value=parseFloat(1).toFixed(decimalNumber),i=document.getElementById(t+"Y"),i.value=parseFloat(1).toFixed(decimalNumber),i=document.getElementById(t+"Z"),i.value=parseFloat(1).toFixed(decimalNumber)}else if("PositionReset"===e){var i=document.getElementById(t+"X");i.value=parseFloat(0).toFixed(decimalNumber),i=document.getElementById(t+"Y"),i.value=parseFloat(0).toFixed(decimalNumber),i=document.getElementById(t+"Z"),i.value=parseFloat(0).toFixed(decimalNumber)}else if("RotationReset"===e){var i=document.getElementById(t+"X");i.value=0,i=document.getElementById(t+"Y"),i.value=0,i=document.getElementById(t+"Z"),i.value=0}else if("TextureReset"===e){var i=document.getElementById(t+"C");i.value=1,i=document.getElementById(t+"R"),i.value=1}else if("normalReset"===e){var i=document.getElementById(t+"C");i.value=1,i=document.getElementById(t+"R"),i.value=1;
}},setButtonStyleHover:function(e){var t=document.getElementById(e);t.setAttribute("class","parameterReset_hover")},setButtonStyle:function(e){var t=document.getElementById(e);t.setAttribute("class","parameterReset")},showInputDialog:function(e,t,i,n,o,a,s,r,l){if(e){var d,h,c=[],g=[],m=[],u={};if(s){var p=[{label:"p1",id:"p1",tab:"User Properties",readonly:!1,"class":"customlabel"},{label:"p2",id:"p2",tab:"User Properties",readonly:!1,"class":"customlabel"},{label:"p3",id:"p3",tab:"User Properties",readonly:!1,"class":"customlabel"},{label:"p4",id:"p4",tab:"User Properties",readonly:!1,"class":"customlabel"}];e=e.concat(p)}for(var f=0,v=e.length;v>f;f++){var y=e[f];h=y.tab||GENERAL,d=u[h]||document.createElement("form");var C=y.id,S=y.type?y.type:"text";y.label;if("div"!==S){var I=document.createElement("input");"undefined"!=typeof y.label&&I.setAttribute("value",y.label),I.tabIndex="-1",y.readonly!==!1&&I.setAttribute("readonly",!0),y["class"]?I.setAttribute("class",y["class"]):I.setAttribute("class","field"),y.labelId?I.setAttribute("id",y.labelId):y.id&&I.setAttribute("id","label"+y.id);var P="select"===S,A=document.createElement("input");if(P){A=document.createElement("select"),A.style.width="304px";var E=y.value,w=y.options;if(w)for(var b=0;b<w.length;b++){var x=w[b],_=document.createElement("option");_.innerHTML=x,_.setAttribute("value",x),E&&E===x&&_.setAttribute("selected","true"),A.appendChild(_)}}if(!P&&(A.setAttribute("type",S),y.pick?(A.style.borderRight="0px",A.style.width="272px"):A.setAttribute("size",40),y.list)){var T=C+"_datalist";A.setAttribute("list",T);var O=document.createElement("datalist");O.setAttribute("id",T);for(var N=0;N<y.list.length;N++){var L=y.list[N],M=document.createElement("option");M.setAttribute("value",L),O.appendChild(M)}y.datalist=O}if(void 0===S||"input"===S||"text"===S||"password"===S?A.setAttribute("class","input"):"label"===S||A.setAttribute("class","input-r"),y.name&&A.setAttribute("name",y.name),y.pick&&(A.pickImage=!0),void 0!==y.display&&(y.display?(I.style.display="block",A.style.display="block"):(I.style.display="none",A.style.display="none")),void 0===y.min||isNaN(y.min)||A.setAttribute("min",y.min),void 0===y.max||isNaN(y.max)||A.setAttribute("max",y.max),y.listener&&(A[y.eve]=y.listener),0==y.editable&&(A.setAttribute("readonly","readonly"),A.style.border="0px",A.style.borderBottom="1px solid #ABADB3"),"checkbox"===S||"radio"===S){var R=y.checked;void 0===R&&(R=!1),R&&A.setAttribute("checked",R)}if(y.id&&(A.setAttribute("id",y.id),"User Properties"==y.tab?g.push(y.id):c.push(y.id)),Utils.isNotNull(y.value)&&A.setAttribute("value",y.value),"multipleF"!=S&&"multipleS"!==S&&"multipleT"!==S&&"button"!==S&&d.appendChild(I),("multipleF"===S||"multipleS"===S||"multipleT"===S)&&("undefined"!=typeof y.labelMinor&&I.setAttribute("value",y.labelMinor),y["class"]?I.setAttribute("class",y["class"]):I.setAttribute("class","fieldlabel"),"textureRepeatC"===y.id||"normalScaleC"===y.id?I.style.width="48px":"textureRepeatR"===y.id||"normalScaleR"===y.id?I.style.width="30px":"shapeW"===y.id?I.style.width="17px":"shapeH"===y.id||"shapeD"===y.id?I.style.width="11px":"ambientLightColor"===y.id?I.style.width="50px":"pointLightColor"===y.idTyle?I.style.width="50px":"pointLightPosition"===y.idTyle?I.style.width="65px":"pointLightIntensity"===y.idTyle&&(I.style.width="70px"),d.appendChild(I)),"range"===S){var U=document.createElement("div"),D=document.createElement("output");D.value=A.value,D.style.paddingLeft="10px",D.setAttribute("id","rangeValue"),function(e,t){e.addEventListener("change",function(){t.value=e.value})}(A,D),U.appendChild(A),U.appendChild(D),d.appendChild(U)}else if("textArea"===S){var k=document.createElement("div"),D=document.createElement("textarea");D.setAttribute("id",C),D.value=y.value,D.style.width="500px",D.style.height="300px",k.appendChild(D),d.appendChild(k)}else if("multipleF"===S||"multipleS"===S||"multipleT"===S)A.style.width="84px",A.style.marginLeft="1px","textureRepeatC"===y.id||"textureRepeatR"===y.id||"normalScaleC"===y.id||"normalScaleR"===y.id?A.style.width="106px":"shapeW"===y.id||"shapeH"===y.id||"shapeD"===y.id?A.style.width="81px":"ambientLightColor"===y.id?A.style.width="60px":"pointLightColor"===y.idTyle?A.style.width="60px":"pointLightPosition"===y.idTyle?A.style.width="115px":"pointLightIntensity"===y.idTyle&&(A.style.width="60px"),d.appendChild(A);else if("label"==S);else if("button"==S){var B=document.createElement("input");B.id=y.label,B.setAttribute("type","button"),B.setAttribute("class","parameterReset"),B.setAttribute("title","reset"),"PositionReset"===y.label?(B.setAttribute("onclick","Utils.parameterReset('PositionReset','position')"),B.setAttribute("onmouseover","Utils.setButtonStyleHover('PositionReset')"),B.setAttribute("onmouseout","Utils.setButtonStyle('PositionReset')")):"RotationReset"===y.label?(B.setAttribute("onclick","Utils.parameterReset('RotationReset','rotation')"),B.setAttribute("onmouseover","Utils.setButtonStyleHover('RotationReset')"),B.setAttribute("onmouseout","Utils.setButtonStyle('RotationReset')")):"ScaleReset"===y.label?(B.setAttribute("onclick","Utils.parameterReset('ScaleReset','scale')"),B.setAttribute("onmouseover","Utils.setButtonStyleHover('ScaleReset')"),B.setAttribute("onmouseout","Utils.setButtonStyle('ScaleReset')")):"TextureReset"===y.label?(B.setAttribute("onclick","Utils.parameterReset('TextureReset','textureRepeat')"),B.setAttribute("onmouseover","Utils.setButtonStyleHover('TextureReset')"),B.setAttribute("onmouseout","Utils.setButtonStyle('TextureReset')")):"normalReset"===y.label&&(B.setAttribute("onclick","Utils.parameterReset('normalReset','normalScale')"),B.setAttribute("onmouseover","Utils.setButtonStyleHover('normalReset')"),B.setAttribute("onmouseout","Utils.setButtonStyle('normalReset')")),B.setAttribute("onmousedown","Utils.stopPropagation(event)"),d.appendChild(B)}else d.appendChild(A);if(y.inner&&y.display!==!1){var F=document.createElement("label");F.setAttribute("class","innerLabel"),F.innerHTML=y.inner,d.appendChild(F)}if(y.pick){var z=document.createElement("input");z.setAttribute("class","image-pick-button"),z.setAttribute("name","pick"),z.setAttribute("type","button"),z.onclick=y.pickFunction,d.appendChild(z)}if(void 0===y["return"]){var G=document.createElement("div");G.setAttribute("class","clear"),d.appendChild(G)}y.datalist&&d.appendChild(y.datalist),u[h]=d}else d?d.appendChild(y.value):(d=document.createElement("div"),d.style.width="800px",d.style.height="400px",d.appendChild(y.value)),u[h]=d,y.id&&c.push(y.id)}var V=new TabPanel;for(var H in u)V.addTab(H,u[H]);V.setTabChangedFunction(function(e){Utils.setDialogRect("dialog_id"),r&&r(e)});var Y=l?l:"input_dialog_id";Utils.showDialog(Y,V.getView(),t,i,!1,null,n,o,a,c,g,m)}},showDialog:function(e,t,i,n,o,a,s,r,l,d,h,c){Utils.addMask(e);var g=document.createElement("div");g.setAttribute("id",e),g.setAttribute("title",i),a?g.setAttribute("class",a):g.setAttribute("class","dialog");var m=document.createElement("div");m.setAttribute("id","dialog_title"+e),m.setAttribute("class","dialog-title-div");var u=document.createElement("img");if(u.setAttribute("class","new_icon"),u.setAttribute("src","images/tw.png"),m.appendChild(u),i){var p=document.createElement("span");p.innerHTML=i,p.setAttribute("class","nd"),g.appendChild(p),m.appendChild(p)}if(o){var f=document.createElement("img");f.setAttribute("src","images/index01_03.png"),f.setAttribute("class","delete"),f.onclick=function(){Utils.disposeDialog(e)},m.appendChild(f)}g.appendChild(m);var v=document.createElement("div");if(v.setAttribute("class","clear"),m.appendChild(v),t&&"string"==typeof t){var y=document.createElement("div");y.innerHTML=t,a||y.setAttribute("class","inner"),g.appendChild(y)}if(t&&"object"==typeof t){var y=document.createElement("div");if(y.appendChild(t),a||y.setAttribute("class","inner"),g.appendChild(y),t.resetRect){var C=document.getElementById("mask");document.getElementById("mask_"+e)&&(C=document.getElementById("mask_"+e));var S=C.offsetWidth,I=C.offsetHeight;t.style.width=parseInt(.8*S)+"px",t.style.height=parseInt(.7*I)+"px"}}var P={};if(n){if(s){var A=document.createElement("button");A.setAttribute("class","cbt"),A.onclick=function(){Utils.disposeDialog(e)};var E=document.createElement("a");E.appendChild(A),g.appendChild(E)}var w=document.createElement("button");w.setAttribute("class","obt");var b=document.createElement("a");b.appendChild(w),s?w.onclick=function(){if(h&&h.length>0){for(var t={},i=0;i<h.length;i++){var n=h[i],o=document.getElementById("label"+n).value,a=document.getElementById(n).value;t[o]=a}P.customProps=t}if(d)for(var i=0;i<d.length;i++){var c=d[i],g="";document.getElementById(c)&&(P[c]=document.getElementById(c).value,g=document.getElementById(c).type),"checkbox"===g||"radio"===g?P[c]=document.getElementById(c).checked:"select"===g?P[c]=document.getElementById(c).selected:"file"===g&&(P[c]=document.getElementById(c).files)}var m=[];l&&(m=l),m.push(P);var u=s.apply(r,m);("undefined"==typeof u||u)&&Utils.disposeDialog(e)}:w.onclick=function(){Utils.disposeDialog(e)},g.appendChild(b)}return document.body.appendChild(g),Utils.setDialogRect(e),g.setAttribute("tabindex",-1),g.focus(),g.onkeydown=function(e){window.event?keynum=e.keyCode:e.which&&(keynum=e.which),!Utils.isShiftDown(e)&&13==keynum&&w&&w.click()},Utils.move("dialog_title"+e,e),P},getMouseP:function(e){e=e||window.event;var t=e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:{x:e.clientX+document.body.scrollLeft-document.body.clientLeft,y:e.clientY+document.body.scrollTop-document.body.clientTop};return t},move:function(e,t){e=document.getElementById(e),t=document.getElementById(t),t.moving=!1,e.onmousedown=function(e){var i=Utils.getMouseP(e),n={x:i.x-t.offsetLeft,y:i.y-t.offsetTop};document.onmousemove=function(e){var i=Utils.getMouseP(e);t.style.left=i.x-n.x+"px",t.style.top=i.y-n.y+"px",t.moving=!0},document.onmouseup=function(){t.moving&&(window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),this.onmousemove=null,t.moving=!1)}}},setDialogRect:function(e){var t=document.getElementById("mask");if(document.getElementById("mask_"+e)&&(t=document.getElementById("mask_"+e)),t){var i=t.offsetWidth,n=t.offsetHeight,o=document.getElementById(e),a=o.offsetWidth,s=o.offsetHeight;o.style.left=i/2-a/2+"px",o.style.top=n/2-s/2+"px"}},createRoom:function(e){"room"===e?(document.body.removeChild(document.getElementById("mask_newEditor")),document.body.removeChild(document.getElementById("newEditor")),Utils.checkLoadLocalImage()):"component"===e&&(document.location.href="index.html?showEditor=false")},createComponent:function(e){"room"===e?document.location="components.html":"component"===e&&(document.body.removeChild(document.getElementById("mask_newEditor")),document.body.removeChild(document.getElementById("newEditor")),Utils.checkLoadLocalImage())},createLayerRow:function(e,t,i,n,o){var a=new TreeComboBox(e,null,!0,o.getRoots(),null,null,i),s={id:t,value:a.getView(),type:"div",tab:n};return s},createImageRow:function(e,t,i,n){var o=localStorage.getItem(LOAD_RESOURCE_TYPE)===TYPE_CLOUD?{label:e,id:t,value:i,pick:!0,tab:n,pickFunction:function(){Utils.pickImage(t)}}:{label:e,id:t,value:i,tab:n};return o},pickImage:function(e){var t=new TextureImagePanel;t.init(),Utils.showDialog("imagepane",t.getView(),"Select Image",!0,!1,null,Utils.setImageCategory,Utils,[e,t])},setImageCategory:function(e,t){var i=t.getLastGl3dviewData();i&&document.getElementById(e)&&(document.getElementById(e).value=i.getClient("path"))},pickAnimation:function(e,t,i){var t=document.getElementById(e).value,n=new twaver.LayerBox,o=n.getDataById("default");if(Utils.isNotNull(t)&&""!=t){var a=t.split(";");for(var s in a){var r=new twaver.Layer;0==s&&(r=o);var l=a[s],d=l?l.split(":"):["","",""],h=d[0],c=d[1],g=parseFloat(d[2]),m=d.length>3?parseInt(d[3]):1500,u=d.length>4?parseInt(d[4]):0,p=d.length>5?d[5]:"Linear.None";r.setClient("action",h),r.setClient("anchor",c),r.setClient("value",g),r.setClient("time",m),r.setClient("delay",u),r.setClient("easing",p),n.getDataById(r.getId())||n.add(r)}}else o.setClient("time",1500),o.setClient("delay",0),o.setClient("easing","Linear.None");var f=new AnimationTable(n);f.showDialog(e)},queryString:function(e,t){var i=new RegExp(""+t+"=([^&?]*)","ig");return e.match(i)?e.match(i)[0].substr(t.length+1):null},getImageSrc:function(e){var t="";return t=e.indexOf("http")>=0?e:e.indexOf("base64")>=0?e:e.indexOf(Utils.Path)>=0?e:Utils.Path+e},showPortDialog:function(e,t,i,n){var o=[{label:"Rows:",id:"rows",type:"input",value:2},{label:"Columns:",id:"columns",type:"input",value:2}];Utils.showInputDialog(o,"Port Params",!0,this.createPortByMat,this,[e,t,i,n])},createPortByMat:function(e,t,i,n,o){var a=parseInt(o.rows),s=parseInt(o.columns),r=e.getElementBox(),l=e.getElementAt(t);if(l instanceof twaver.Grid){var d=(i.resize,e.getLogicalPoint(t)),h=l.getCellObject(d);Utils.registerImage(Utils.Path+i.material,e,"component");for(var c=0;a>c;c++)for(var g=0;s>g;g++){var m=new twaver.Follower;if(m.setImage(Utils.Path+i.material),m.setClient("text",n),m.setClient("resize",i.resize),r.getSelectionContainer().setSelection(m),null!=h){"unresize"===i.resize&&(m.setStyle("follower.fill.cell",!1),m.setWidth(i.args.x*e.zoom),m.setHeight(i.args.y*e.zoom)),m.setParent(l),m.setHost(l),m.setStyle("follower.row.index",h.rowIndex+c),m.setStyle("follower.column.index",h.columnIndex+g);var u=m.getParent().getParent(),p=m.getCenterLocation().x-u.getCenterLocation().x,f=m.getCenterLocation().y-u.getCenterLocation().y;m.setClient("offsetX",p/e.zoom),m.setClient("offsetY",f/e.zoom);var v=l.getClient("offset");m.setClient("offset",v+.15),m.setClient("selfID",m.getId()),m.setClient("hostCell",l),r.add(m)}}handleText2d(e)}},showTemplateDialog:function(e,t,i,n,o){var a=[{label:"Rows :",id:"rows",type:"input",value:2},{label:"Columns :",id:"columns",type:"input",value:2},{label:"X Gap :",id:"xGap",type:"input",value:20},{label:"Y Gap :",id:"yGap",type:"input",value:20}];Utils.showInputDialog(a,"Template Params",!0,this.createTemplateByMat,this,[e,t,i,n,o])},createTemplateByMat:function(e,t,i,n,o,a){var s=parseInt(a.rows),r=parseInt(a.columns),l=parseInt(a.xGap),d=parseInt(a.yGap),h=[];if(n.loadFromCloud)for(var o=function(e,n,o){processHost(e,i),e._host?e._host.setCenterLocation({x:t.getLogicalPoint(i).x+(e.getWidth()+l)*o,y:t.getLogicalPoint(i).y+(e.getHeight()+d)*n}):e.setCenterLocation({x:t.getLogicalPoint(i).x+(e.getWidth()+l)*o,y:t.getLogicalPoint(i).y+(e.getHeight()+d)*n}),h.push(e),t.getSelectionContainer().clearSelection(),h.forEach(function(e){t.getSelectionContainer().appendSelection(e)})},c=0;s>c;c++)for(var g=0;r>g;g++)e._createElement(t,t.getLogicalPoint(i),n,o,c,g);else for(var c=0;s>c;c++)for(var g=0;r>g;g++){var m=e._createElement(t,t.getLogicalPoint(i),n,o);m._host?m._host.setCenterLocation({x:t.getLogicalPoint(i).x+(m.getWidth()+l)*g,y:t.getLogicalPoint(i).y+(m.getHeight()+d)*c}):m.setCenterLocation({x:t.getLogicalPoint(i).x+(m.getWidth()+l)*g,y:t.getLogicalPoint(i).y+(m.getHeight()+d)*c})}},checkPointFlag:function(e,t,i,n){if("undefined"!=typeof i)if(t)t.setShowPoint(i);else if(i){t=new TargetFlagNode(n);var o=borderPane.getView();if(n==f.ORIGINAL_POINT)var a=0,s=0;else var a=o.offsetWidth-ACCORDION_WIDTH,s=o.offsetHeight;t.setCenterLocation(a/2,s/2),e.getElementBox().add(t)}},isCtrlDown:function(e){return e.ctrlKey||e.metaKey},isAltDown:function(e){return e.altKey},isShiftDown:function(e){return e.shiftKey},getVersion:function(){return"2.1.5"},createPointLight:function(e,t){var i=new mono.PointLight(16777215,1),n=1e4;return"undefined"!=typeof e&&(n=e),i.setPosition(n,n,n),0==t&&i.setVisible(!1),i},clearLocalStorage:function(){localStorage&&(localStorage.clear(),alert("success"))},setGl3dviewBackground:function(e,t){var i=localStorage.getItem(t);i||(i="#FFFFFF"),e.setClearColor(i)},copyDatasToBoxAnchor:function(e,t){var i=modelManager.serializeDatasInfo(e,gl3dview._scaleUnitValue);console.log(i),t.copyAnchor=i},pasteBoxAnchorToBox:function(e,t){var i=[];if(e.copyAnchor){var n=modelManager.parseSketch(JSON.parse(e.copyAnchor));if(n instanceof Array)for(var o in n)t&&n[o].setClient("floorName",t),e.add(n[o]),i.push(n[o])}return i},string2Boolean:function(e){return e?"false"===e?!1:!0:!1},string2Float:function(e,t){return e?parseFloat(e):defautValue},loadPropertiesFromLocalStorage:function(e,t,i,n,o){var a=localStorage.getItem(LOAD_RESOURCE_TYPE);a?loadResource=a:document.URL.startsWith(PropertyConsts.MONO_URL_PRE)&&(loadResource=TYPE_CLOUD);var a=localStorage.getItem(DECIMAL_NUMBER);a&&(decimalNumber=parseInt(a)),a=localStorage.getItem(CLOUD_KEY),a&&(cloudKey=a),a=localStorage.getItem(CLOUD_PASSWORD),a&&(cloudPassword=a),a=localStorage.getItem(AMBIENT_LIGHT_ON),a&&t.setVisible(Utils.string2Boolean(a)),a=localStorage.getItem(AMBIENT_LIGHT_COLOR),a&&t.setColor(a),a=localStorage.getItem(PropertyConsts.LocalStorage.SELECT_STYLE),a&&(selectStyle=a);for(var s=1;s<=i.length;s++){if(a=localStorage.getItem(POINT_LIGHT_ON+s+""),a&&i[s-1].setVisible(Utils.string2Boolean(a)),a=localStorage.getItem(POINT_LIGHT_POSITION+s+"")){var r=a.split(",");3==r.length?i[s-1].setPosition(r[0],r[1],r[2]):i[s-1].setPosition(r[0],r[0],r[0])}a=localStorage.getItem(POINT_LIGHT_COLOR+s+""),a&&i[s-1].setColor(a),a=localStorage.getItem(POINT_LIGHT_INTENSITY+s+""),a&&i[s-1].setIntensity(parseFloat(a))}if(e)a=localStorage.getItem(PropertyConsts.LocalStorage.FLOOR_STYLE),a&&(floorStyle=a),a=localStorage.getItem(PropertyConsts.LocalStorage.FLOOR_SIZE),a&&(floorSize=a),a=localStorage.getItem(SHOW_FLOOR),a&&(showFloor=Utils.string2Boolean(a),showFloor||n.remove(viewFloor)),a=localStorage.getItem(ALL_VIEW_SELECTABLE),a&&(allViewSelectable=Utils.string2Boolean(a));else{if(a=localStorage.getItem(SHOW_PROPERTY_SHEET),Utils.isNotNull(a)?(showPropertySheet=Utils.string2Boolean(a),showPropertySheet?borderPane.setRight(sheetPane):borderPane.setRight(null)):borderPane.setRight(null),a=localStorage.getItem(SHOW_TARGET_FLAG))var l=Utils.string2Boolean(a);if(a=localStorage.getItem(SHOW_ORIGINAL_FLAG))var d=Utils.string2Boolean(a);a=localStorage.getItem(SHOW_GRID),Utils.isNotNull(a)?showGrid=Utils.string2Boolean(a):showGrid=!0,a=localStorage.getItem(PropertyConsts.SHOW_RULER_GUIDES),Utils.isNotNull(a)?showRulerGuides=Utils.string2Boolean(a):showRulerGuides=!1,a=localStorage.getItem(PropertyConsts.SHOW_RULER),Utils.isNotNull(a)?showRuler=Utils.string2Boolean(a):showRuler=!0,o[0]instanceof GridGl3dview&&setTimeout(function(){0==showGrid?o[0].setShowGrid(!1):o[0].setShowGrid(!0)},100)}a=localStorage.getItem(ENABLE_SCALE),a&&(enableScale=Utils.string2Boolean(a)),a=localStorage.getItem(SHOW_AXIS),a&&(showAxis=Utils.string2Boolean(a)),a=localStorage.getItem(SHOW_AXIS_TEXT),a&&(showAxisText=Utils.string2Boolean(a)),a=localStorage.getItem(PropertyConsts.ENABLE_EASING),a&&(enableEasing=Utils.string2Boolean(a)),a=localStorage.getItem(SHOW_DIM),a&&(showDim=Utils.string2Boolean(a)),a=localStorage.getItem(SHOW_COORD),a&&(showCoord=Utils.string2Boolean(a)),e&&(a=localStorage.getItem(IS_FULL_ROTATION_COMPONENT),a&&(isFullRotation=Utils.string2Boolean(a),"undefined"!=typeof o[1]&&(isFullRotation?o[1].getInteractions()[1].yRistrict=!1:(o[1].getInteractions()[1].yRistrict=!0,reset4CGleye(6,3)))),a=localStorage.getItem(SCALE_MIN_LIMIT),a&&(scaleMinLimit=Utils.string2Float(a,.1)),a=localStorage.getItem(SCALE_MAX_LIMIT),a&&(scaleMaxLimit=Utils.string2Float(a,100)),a=localStorage.getItem(ZOOM_SPEED_COMPONENT),a&&(comZoomSpeed=parseFloat(a)),a=localStorage.getItem(ROTATE_SPEED_COMPONENT),a&&(comRotateSpeed=parseFloat(a)),a=localStorage.getItem(PAN_SPEED_COMPONENT),a&&(comPanSpeed=Utils.string2Float(a)),a=localStorage.getItem(MAX_DISTANCE_COMPONENT),a&&(comMaxDistance=parseFloat(a)),a=localStorage.getItem(MIN_DISTANCE_COMPONENT),a&&(comMinDistance=parseFloat(a)),a=localStorage.getItem(PropertyConsts.NEAR_PLANE_COMPONENT),a&&(comNearPlane=parseFloat(a)),a=localStorage.getItem(PropertyConsts.FAR_PLANE_COMPONENT),a&&(comFarPlane=parseFloat(a)),a=localStorage.getItem(PropertyConsts.FOV_COMPONENT),a&&(comFov=parseFloat(a))),e||(a=localStorage.getItem(IS_FULL_ROTATION),a&&(isFullRotation=Utils.string2Boolean(a),"undefined"!=typeof defaultInteraction&&(isFullRotation?defaultInteraction.yRistrict=!1:(defaultInteraction.yRistrict=!0,defaultInteraction.yLowerLimitAngle=-Math.PI/8,defaultInteraction.yUpLimitAngle=Math.PI/2))),a=localStorage.getItem(ZOOM_SPEED),a&&(zoomSpeed=parseInt(a)),a=localStorage.getItem(ROTATE_SPEED),a&&(rotateSpeed=parseInt(a)),a=localStorage.getItem(PAN_SPEED),a&&(panSpeed=Utils.string2Float(a)),a=localStorage.getItem(MAX_DISTANCE),a&&(maxDistance=parseInt(a)),a=localStorage.getItem(MIN_DISTANCE),a&&(minDistance=parseInt(a)),a=localStorage.getItem(PropertyConsts.NEAR_PLANE),a&&(nearPlane=parseFloat(a)),a=localStorage.getItem(PropertyConsts.FAR_PLANE),a&&(farPlane=parseFloat(a)),a=localStorage.getItem(PropertyConsts.FOV),a&&(fov=parseFloat(a)));var h=localStorage.getItem(e?"componentBackground":"roomBackground");if(o instanceof Array&&o.length)for(var s=0;s<o.length;s++){var c=o[s];if(c instanceof GridGl3dview)Utils.checkPointFlag(c,targetFlagElement,l),Utils.checkPointFlag(c,originalFlagElement,d,f.ORIGINAL_POINT),c.invalidateElementVisibility();else if(c instanceof mono.Gl3dview3D&&(c.setShowAxis(showAxis),c.setShowAxisText(showAxisText),h&&c.setClearColor(h),Utils.isNotNull(enableEasing))){var g,m=c.getInteractions();m&&m.forEach(function(e){e instanceof mono.DefaultInteraction&&(g=e)}),g&&g.setEasing(enableEasing)}}},validateCloudKeyCallback:function(e,t,i,n){var o=JSON.parse(e);if(o.error)alert(o.error);else{var a=o.value;if(!a)return void alert("Cloud key is invalid");if(a.end_date){var s=new Date;if(Date.parse(a.end_date)-s<0)return void alert("Cloud key is past due")}localStorage.setItem(CLOUD_KEY,t),localStorage.setItem(CLOUD_PASSWORD,i),n?(accordion4C.clearAllCategories(),fillComponentCategoryView(),refreshComponentAccordion(accordion4C.getAccodion().getCurrentTitle())):(accordionPane.clearAllCategories(),fillCategoryView(),refreshAccordion(accordionPane.getAccodion().getCurrentTitle()))}},validateCloudKey:function(e,t,i,n){return e?void Utils.doLogin(e,t,this,n):void alert("Cloud key is required")},doLogin:function(e,t,i,n){var o={arguments:{username:e,password:t}};require(MONO_URL_LOGIN,o,n,i)},login:function(e,t,i,n){var o=new XMLHttpRequest;o.timeout=15e3,o.ontimeout=function(){n&&n.call(i,{error:"request timeout"})};var a=new FormData;a.append("username",e),a.append("password",t),o.open("post",MONO_URL_LOGIN,!0),o.withCredentials=!0,o.onreadystatechange=function(){4==o.readyState&&200==o.status&&n&&n.call(i,http.responseText)},o.send(a)},doLogout:function(){if(confirm("Logout?")){var e={arguments:{}};document.location.href="login.html",localStorage.setItem("mono-user",""),require(MONO_URL_LOGOUT,e)}},isNotNull:function(e){return void 0!==e&&"undefined"!==e&&null!==e&&"null"!==e&&""!==e},registerRandomImage:function(e,t){var i=new Image;i.src=Utils.RelativePath+t,i.crossOrigin="";arguments;i.onload=function(){twaver.Util.registerImage(e,i,i.width,i.height),i.onload=null}},handlerTexture:function(e,t,i){var n;if(Utils.isNotNull(e)){if(e instanceof Array){n=[];for(var o=0;o<e.length;o++){var a=Utils.handlerTexture(e[o],t,i);n.push(a)}}else"string"!=typeof e||e.startsWith("data:image")||e.startsWith("http")?n=e.startsWith("http")&&i&&e.indexOf("%")>=0?decodeURI(e):e:(n=Utils.RelativePath+e,t&&(n=PropertyConsts.MONO_IMG_PRE+n));return n}return n},scaleCanvas:function(e,t,i){var n=e.width,o=e.height;void 0==t&&(t=n),void 0==i&&(i=o);var a=o>n?n:o,s=n>a?(n-a)/2:0,r=o>a?(o-a)/2:0,l=document.createElement("canvas"),d=l.getContext("2d");return l.width=t,l.height=i,d.drawImage(e,s,r,a,a,0,0,t,i),l},checkLoadLocalImage:function(){try{var e=document.createElement("canvas"),t=new Image;t.src=Utils.getImageSrc("floor.png");var i=e.getContext("2d");i.fillStyle="#EEEEFF",i.fillRect(0,0,400,300),t.onload=function(){i.drawImage(t,0,0,100,100);try{i.getImageData(0,0,100,100)}catch(e){if(console.log(e),console.log(e.name),console.log(e.message),"SecurityError"===e.name&&(e.message.indexOf("the canvas has been tainted by cross-origin data")>=0||e.message.indexOf("SecurityError: DOM Exception 18")>=0)){var n="<div class='error_dialog'><span class='r_title'>Get cross-origin data</span><p>Your browser can not access local file and will get security error.<br>click <a href='http://twaver.servasoft.com/?p=7366' target='_blank'>twaver.servasoft.com</a> to get solution</p></div>";Utils.showDialog("errorDialog",n,"Warning",!1,!0,"loadimagedialog")}}}}catch(n){console.log(n)}},paintArrow:function(e,t,i,n,o,a){if(e&&t&&i){e.moveTo(t.x,t.y),e.lineTo(i.x,i.y);var s=i.x,r=i.y;o=o||10,a=a||5,n=n||"up",e.moveTo(s,r),"up"==n?(e.lineTo(s-o/2,r+a),e.lineTo(s+o/2,r+a)):"right"==n?(e.lineTo(s-a,r-o/2),e.lineTo(s-a,r+o/2)):"left"==n?(e.lineTo(s+a,r+o/2),e.lineTo(s+a,r-o/2)):"down"==n&&(e.lineTo(s+o/2,r-a),e.lineTo(s-o/2,r-a)),e.lineTo(s,r),e.fill()}},isTargetFlag:function(e){return e&&e instanceof TargetFlagNode&&e.getType()==f.TARGET_POINT},isOriginalFlag:function(e){return e&&e instanceof TargetFlagNode&&e.getType()==f.ORIGINAL_POINT},createSelectInput:function(e,t,i){if(e&&!(e.length<=0)){var n=document.createElement("select");t&&(i=i||"onchange",n[i]=t);for(var o=0;o<e.length;o++){var a=e[o],s=document.createElement("option");s.setAttribute("value",a),s.innerHTML=a,n.appendChild(s)}}},categoryCache:{},publicCategoryCache:{},initCategory:function(e,t,i,n){Object.getOwnPropertyNames(e).length<=0?Utils.getTemplateCategory(e,t,i,n):n&&n()},getTemplateCategory:function(e,t,i,n){function o(e,t,i){if(i.type&&i.type==PropertyConsts.TYPE_COMPONENT){var n=e[i.type];n||(e[i.type]=n={})}if(n){var o=n[t];o||(n[t]=o={})}else{var o=e[t];o||(e[t]=o={})}if(o.children?o.children.push(i):o.children=[i],i.type&&i.type==PropertyConsts.TYPE_COMPONENT&&t==PropertyConsts.TYPE_ROOTCATEGORY){var a=e[t];a||(e[t]=a={}),a.children?a.children.push(i):a.children=[i]}return o}var a={};Utils.isNotNull(i)&&(a.scope=i);var s={module:t,method:"search",arguments:a},r=function(){if(1===arguments.length){var t=JSON.parse(arguments[0]);if(t.error)return void alert(t.error);for(var i=t.value,a=0;a<i.length;a++){var s=i[a];s.type&&s.type==PropertyConsts.TYPE_COMPONENT&&(e[s.type]||(e[s.type]={}),e[s.type][s.id]=s),e[s.id]=s}for(var a=0;a<i.length;a++){var s=i[a];s.parent_id?o(e,s.parent_id,s):o(e,PropertyConsts.TYPE_ROOTCATEGORY,s)}n&&n()}};require(MONO_URL,s,r,this)},requestMono:function(e,t,i){require(MONO_URL,e,t,i)},stopPropagation:function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault?e.preventDefault():e.returnValue=!1},convert2Radian:function(e){return e*Math.PI/180},convert2Angle:function(e){return 180*e/Math.PI},showLoginDialog:function(){var e=[{label:"Cloud Key:",id:"key"},{label:"Cloud Password:",type:"password",id:"password"}];Utils.showInputDialog(e,"Login",!0,function(){var e=document.getElementById("key").value,t=document.getElementById("password").value;Utils.validateCloudKey(e,t,!1,function(i){var n=JSON.parse(i);if(n.error)alert(n.error);else{var o=n.value;o?Date.parse(o.end_date)-new Date<0?alert("Cloud key is past due"):(localStorage.setItem(LOAD_RESOURCE_TYPE,TYPE_CLOUD),localStorage.setItem(CLOUD_KEY,e),localStorage.setItem(CLOUD_PASSWORD,t)):alert("Cloud key is invalid")}location.reload()})},this)},generateAssembleId:function(e){return e=e||mono.Math.generateUUID()},setButtonsStyle:function(e,t){if(e)for(var i=0;i<e.length;i++)if(e[i]!==t){var n=document.getElementById(e[i]);n.setAttribute("class",e[i])}else{var o=document.getElementById(t);o.setAttribute("class",t+"_hover")}},createLinkHandle:function(e){var t=e.getSelectionContainer().getSelection();if(!(2!=t.size()||t.get(0)instanceof mono.Link||t.get(1)instanceof mono.Link)){var i=[{label:"Link Style:",id:"linkStyle",type:"select",options:PropertyConsts.LINK_STYPE,value:"orthogonal.y"},{label:"Link Color:",id:"linkColor",value:"blue"},{label:"Link Size:",id:"linkSize",value:5},{label:"Link Extend:",id:"linkExtend",value:0},{label:"Link point data:",id:"linkPoints",tab:"Link Points",type:"textArea",readonly:!1,value:""}];this.showInputDialog(i,"Link Properties",!0,this.createLinkDialogHandle,this,[e],!0)}},createLinkDialogHandle:function(e,t){var i=e.getSelectionContainer().getSelection(),n=new TGL.Link(i.get(0),i.get(1));if(n.setExtend(parseFloat(t.linkExtend)),n.setLinkType(t.linkStyle),n.s({"m.color":t.linkColor,"m.linewidth":parseFloat(t.linkSize)}),"control"==t.linkStyle&&t.linkPoints){for(var o=t.linkPoints.toString().replace(/\s/g,",").replace(/\r\n/g,","),a=o.split(","),s=[],r=0;r<a.length;r+=3)isNaN(parseFloat(a[r]))||s.push(new TGL.XiangliangThree(parseFloat(a[r]),parseFloat(a[r+1]),parseFloat(a[r+2])));n.setControls(s)}e.add(n)},scale3DElement:function(e,t){var i=e.getPosition().clone();e.setPosition(i.x*t,i.y*t,i.z*t);var n=e.getClassName();switch(n=n.replace("TGL.","mono.")){case"mono.Cube":e.setWidth(e.getWidth()*t),e.setHeight(e.getHeight()*t),e.setDepth(e.getDepth()*t);break;case"mono.Sphere":e.setRadius(e.getRadius()*t);break;case"mono.Cylinder":e.setRadiusTop(e.getRadiusTop()*t),e.setRadiusBottom(e.getRadiusBottom()*t),e.setHeight(e.getHeight()*t);break;case"mono.Torus":e.setRadius(e.getRadius()*t),e.setTube(e.getTube()*t);break;case"mono.Billboard":var o=e.getScale();e.setScale(o.x*t,o.y*t,1);break;case"mono.PathNode":e.setRadius(e.getRadius()*t);var a=e.getPath(),s=a.toArray(),r=Utils._createPath(s,t);e.setPath(r);break;case"mono.TextNode":var l=e.getScale();e.setHeight(e.getHeight()*t),e.setScale(l.x*t,l.y*t,l.z*t);break;case"mono.ComboNode":var d=e.getCombos(),h=e.getStyle("m.texture.image",!0),c=e.getStyle("m.texture.repeat",!0),g=[];for(var m in d)Utils.scale3DElement(d[m],t),g.push(d[m]);e.setCombos(g),e.setStyle("m.texture.image",h),e.setStyle("m.texture.repeat",c);break;case"mono.LatheNode":var a=e.getPath(),s=a.toArray(),r=Utils._createPath(s,t);e.setPath(r);break;case"mono.Entity":}}};var r=function(e){for(var t=box.getNodes().toArray(),i=t.length,n=0;i>n;n++){var o=t[n];o.isSelected()&&o.setRotationZ(o.getRotation().z+e)}};$rSelected=r;var l=function(){var e=box.getSelectionContainer().getSelection(),t=e.size();if(0===t)alert("Select one or more objects.");else{var i="";1===t&&(i=e.get(0).getGroupId());for(var n=window.prompt("Group ID:",i),o=0;t>o;o++){var a=e.get(o);a.setGroupId(n)}}};$group=l;var d=function(e){var t=[];t.push();var i=[{label:"Select align pattern:",id:"group_on_ground",name:"align",type:"radio",checked:!0,inner:'<img src="'+Utils.Path+'../images/align_group_on_ground.png" />   Group align on ground'},{label:"",id:"group_under_ground",name:"align",type:"radio",checked:!1,inner:'<img src="'+Utils.Path+'../images/align_group_under_ground.png" />   Group align under ground'},{label:"",id:"on_ground",name:"align",type:"radio",checked:!1,inner:'<img src="'+Utils.Path+'../images/align_on_ground.png" />   Align on ground'},{label:"",id:"under_ground",name:"align",type:"radio",checked:!1,inner:'<img src="'+Utils.Path+'../images/align_under_ground.png" />   Align under ground'},{label:"",id:"center",name:"align",type:"radio",checked:!1,inner:'<img src="'+Utils.Path+'../images/align_center_3d.png" />   Align center'},{label:"",id:"top",name:"align",type:"radio",checked:!1,inner:'<img src="'+Utils.Path+'../images/align_top_3d.png" />   Align top'},{label:"",id:"bottom",name:"align",type:"radio",checked:!1,inner:'<img src="'+Utils.Path+'../images/align_bottom_3d.png" />   Align bottom'}];Utils.showInputDialog(i,"Align Pattern",!0,h,this,[e])},h=function(e,t){for(var i=(t.group_on_ground||t.group_under_ground,new Array),n=e.getSelectionContainer().getSelection(),o=n.size(),a=0;o>a;a++){var s=n.get(a);i.push(s)}var r,l;if(i.length>0)for(var a=0;a<i.length;a++){var s=i[a];if(s&&!s.getParent()){var d=s.getWorldBizBox();d&&(t.under_ground&&s.setPositionY(s.getPosition().y-d.max.y),t.on_ground&&s.setPositionY(s.getPosition().y-d.min.y),
(!r||r<d.max.y)&&(r=d.max.y),(!l||l>d.min.y)&&(l=d.min.y))}}if(!t.under_ground&&!t.on_ground&&(r||l)&&i.length>0)for(var a=0;a<i.length;a++){var s=i[a];if(s&&!s.getParent()){if(t.top){var h=r-s.getWorldBizBox().max.y;s.setPositionY(s.getPosition().y+h)}if(t.group_under_ground&&s.setPositionY(s.getPosition().y-r),t.bottom){var h=s.getWorldBizBox().min.y-l;s.setPositionY(s.getPosition().y-h)}t.group_on_ground&&s.setPositionY(s.getPosition().y-l),t.center&&s.setPositionY((r+l)/2)}}};$align3d=d;var c=function(){var e=[];e.push();var t=[{label:"Select layout pattern:",id:"star",name:"layout",type:"radio",checked:!0,inner:'<img src="'+Utils.Path+'../images/align_group_on_ground.png" />   Star layout'}];Utils.showInputDialog(t,"Layout Pattern",!0,g,this,[box])},g=function(e,t){for(var i=(t.group_on_ground||t.group_under_ground,new Array),n=e.getSelectionContainer().getSelection(),o=n.size(),a=0;o>a;a++){var s=n.get(a);s.getParent()||i.push(s)}var r,l,d,h=new mono.XiangliangThree(0,1,0);if(i.length>0)for(var a=0;a<i.length;a++){var s=i[a];if(s&&!s.getParent()){s.setRotation(0,0,0),0==a&&(r=s.getPosition().x,l=s.getPosition().y,d=s.getPosition().z),s.setPosition(r,l,d);var c=s.getWorldBizBox();if(c){var g=c.max.x-c.min.x;if(s.setPositionX(s.getPosition().x+g/2),a>0){var m=2*Math.PI/i.length*a;s.rotateFromAxis(h,new mono.XiangliangThree(r-s.getPosition().x,l-s.getPosition().y,d-s.getPosition().z),m)}}}}};$layout3d=c;var m=function(e){for(var t=new Array,i=box.getSelectionContainer().getSelection(),n=i.size(),o=0;n>o;o++){var a=i.get(o);t.push(a)}u(t,e)};$combo=m;var u=function(e,t){if(e.length>1){for(var i=[],n=1;n<e.length;n++)i.push(t);for(var o=new mono.ComboNode(e,i),n=0;n<e.length;n++){var a=e[n];box.remove(a)}Utils.setComboCentralized(o),box.add(o)}};Utils.setComboCentralized=function(e){if(e){e.setCentralized(!0);var t=e.getOffsetPosition(),i=e.getPosition();t&&e.setPosition(i.x+t.x,i.y+t.y,i.z+t.z)}};var p=function(){var e=(new Date).getFullYear(),t="<div id = 'about' class='mar' style='margin-top:0px;'><p>MONO DESIGN is a TWaver online 2D/3D modelling tool.</p><br><p>Visit our website to get more information:</p><p><a href='http://twaver.servasoft.com'>twaver.servasoft.com</a></p><p><a href='http://doc.servasoft.com/'>doc.servasoft.com</a></p><br><p>Contact us:<a href='mailto:info@servasoftware.com'>info@servasoftware.com</a></p><br><p>&copy; Copyright "+e+" <b>Serva Software LLC.</b> All rights reserved.</p><br></div>";Utils.showDialog("dialog-about",t,"About MONO DESIGN "+Utils.getVersion(),!0,!1)};$showabout=p;Utils.getUnPredefinedFloorLayers=function(e){var t=new twaver.List;return e.getLayerBox().getRoots().forEach(function(e){e.getClient("floorLayer")&&!e.getClient("predefined")&&t.add(e)}),t},Utils.addInteractionComboBox=function(e,t){var i=twaver.Util.isTouchable?["Touch","None"]:["Default-Lazy","Edit-Live"],n=function(){"Default-Lazy"===this.value?(allGl3dviews[2].setDefaultInteractions(!0),allGl3dviews[2]._lazyMoveAnimate=null):"Edit-Live"===this.value&&allGl3dviews[2].setEditInteractions()};Utils.addComboBox(e,i,n,t)},Utils.addComboBox=function(e,t,i,n){var o=document.createElement("select");return o.style.verticalAlign="top",o.setAttribute("class","combobox-comp"),t.forEach(function(e){var t=document.createElement("option");t.appendChild(document.createTextNode(e)),t.setAttribute("value",e),o.appendChild(t)}),i&&o.addEventListener("change",i,!1),n&&(o.value=n),e.appendChild(o),o},Utils.getLayerByFloorName=function(e,t){var i=null;return e.forEach(function(e){return e.getClient("floorName")==t?void(i=e):void 0}),i},Utils.createProgressBar=function(e,t){var i=document.createElement("div");i.style.width=e+"px",i.style.height=t+"px",i.style.position="absolute";for(var n=1;8>=n;n++){var o=document.createElement("div");o.className="blockG",o.id="rotateG_0"+n,i.appendChild(o)}return i},Utils.createToolTipDiv=function(e,t){if(NaN!=parseInt(e)&&NaN!=parseInt(t)){e=parseInt(e),t=parseInt(t);var i=document.createElement("div");i.style.width=e+"px",i.style.height=t+"px",i.style.zIndex="1001",i.style.display="none",i.id="toolTipId",i.setAttribute("class","bubble arrow"),i.style.backgroundColor="#FCFBF7",i.style.backgroundImage="url(images/loading.png)",i.style.backgroundRepeat="no-repeat",document.body.appendChild(i);var n=document.createElement("span");n.id="toolTipTextId",n.innerHTML="",n.style.color="rgb(240,120,25)",n.style.fontSize="11px",n.style.position="absolute",n.style.top="3px",n.style.left="5px",n.style.width="205px",i.appendChild(n)}},Utils.addNumberCommas=function(e){e+="",x=e.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var t=/(\d+)(\d{3})/;t.test(x1);)x1=x1.replace(t,"$1,$2");return x1+x2},Utils.loginMONO=function(e,t){if(!e||!t)return void alert("username and password is required");var i=new XMLHttpRequest,n=new FormData;n.append("username",e),n.append("password",t),i.open("post","https://mono-design.cn/login",!0),i.withCredentials=!0,i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){var t=JSON.parse(i.responseText);t.error?alert(t.error):(localStorage.setItem("mono-user",e),localStorage.setItem("loadResource","cloud"))}},i.send(n)},Utils.setupLogout=function(){var e=document.getElementById("main_toolbar");if(e){var t=localStorage.getItem("mono-user");null==t?e.innerHTML+='<img src="images/user.png"><a href="login.html"> Login</a>':e.innerHTML+='<img src="images/user.png"><a id="user" href="#" onclick="Utils.showUserProfile();" title="Click show your profile">'+t+'</a> | <a id="logout" href="#" onclick="Utils.doLogout();">Logout</a>'}},Utils.ready=function(e){return"complete"==document.readyState?e():void(window.addEventListener?window.addEventListener("load",e,!1):window.attachEvent?window.attachEvent("onload",e):window.onload=e)},Utils.ready(function(){Utils.setupLogout()}),Utils.showUserProfile=function(){var e=(localStorage.getItem("mono-user"),{arguments:{},method:"getSelf",module:"users"});require(MONO_URL,e,Utils.showUserProfileDialog)},Utils.publishTemplate=function(e,t,i){var n=(localStorage.getItem("mono-user"),{arguments:{template_id:e,category_id:i},method:"publish",module:"templates"});require(MONO_URL,n,function(e){var i='Template "'+t+'" has been published successfully.';alert(i)})},Utils.unpublishTemplate=function(e,t,i){var n=(localStorage.getItem("mono-user"),{arguments:{template_id:e,category_id:i},method:"unpublish",module:"templates"});require(MONO_URL,n,function(e){var i='Template "'+t+'" has been unpublished successfully.';alert(i)})},Utils.showUserProfileDialog=function(e){var t=JSON.parse(e),i=t.value,n=[{label:"User:",id:"user",readonly:!0,value:i.user,editable:!1},{label:"Valid From:",id:"start_date",readonly:!0,value:Utils.formatDate(i.start_date),editable:!1},{label:"Valid Thru:",id:"end_date",readonly:!0,value:Utils.formatDate(i.end_date),editable:!1},{label:"Old Password:",id:"old_password",readonly:!1,type:"password",value:"",editable:!0},{label:"New Password:",id:"password",readonly:!1,type:"password",value:"",editable:!0},{label:"Confirm Password:",id:"password2",readonly:!1,type:"password",value:"",editable:!0}],o=function(e){if(e.password!=e.password2)return void alert("New password and confirm password do not match");if(!e.password||e.length<8)return void alert("New password should at least 8 characters");var t={module:"users",method:"changepw",arguments:{old_password:e.old_password,new_password:e.password}};require(MONO_URL,t,function(){alert("New password has been set up")})};Utils.showInputDialog(n,"User Profile",!0,o,this,[],null,null)},Utils.formatDate=function(e){if(e){var t=Date.parse(e),i=new Date(t),n=new Date(i).format("yyyy-MM-dd");return n}return""},Utils.setPolygonOffset=function(e,t,i){var n="m.polygonOffset";if(i&&(n=i+"."+n),e){var o=n+"Factor",a=n+"Units";e.setStyle(n,!0),e.setStyle(o,1),e.setStyle(a,t)}},Utils.updateBoxInfo=function(e){if(!e.batch){var t=document.getElementById("boxInfo");if(t){for(var i=e.getDatas().toArray(),n=0,o=0,a=0;a<i.length;a++){var s=i[a];if(s.faces){if(s.getClient(PropertyConsts.COMPONENTFLOOR))continue;o+=s.faces.length,n++}}n=Utils.addNumberCommas(n),o=Utils.addNumberCommas(o),t.innerHTML="Objects: "+n+"<br>Faces: "+o}}},Utils.updateFpsInfo=function(e,t){var i=document.getElementById("fpsInfo");i&&(i.innerHTML="FPS: "+e+"<br>TPF: "+t+" ms")},Utils.setupEightLights=function(e,t){t=t||5e3;for(var i=.5,n=[[1,1,1],[-1,1,1],[1,1,-1],[-1,1,-1],[1,-1,1],[-1,-1,1],[1,-1,-1],[-1,-1,-1]],o=0;o<n.length;o++){var a=n[o][0]*t,s=n[o][1]*t,r=n[o][2]*t,l=new mono.PointLight(16777215,i);l.setPosition(a,s,r),e.add(l)}},Utils.createGl3dviewInfoTag=function(e,t,i){var n=document.createElement("span");n.innerHTML="",n.style.position="absolute",n.style.left="2px",n.style.background="transparent",n.style.width="200px",n.style.top=i,n.style.color="#AAAAAA",n.setAttribute("id",t),e.appendChild(n)},Utils.setupGl3dviewInfoTags=function(e){var t=document.createElement("div");Utils.createGl3dviewInfoTag(t,"boxInfo","0px"),Utils.createGl3dviewInfoTag(t,"fpsInfo","25px"),t.setAttribute("class","gl3dview3d-boxinfo"),e.getRootView().appendChild(t)},Utils.createToggleImage=function(e,t,i){i=i||document.body;var n=document.createElement("div");n.setAttribute("class",e),i.appendChild(n);var o=document.createElement("div");return o.setAttribute("class",t),o.style.display="block",n.appendChild(o),o},Utils.createLeftToggleImage=function(e,t,i){var n=Utils.createToggleImage("hidden-left-div","left-expand-img",i);n.onclick=function(){var i=document.getElementsByClassName("hidden-left-div")[0];"left-expand-img"==this.getAttribute("class")?(this.setAttribute("class","left-expand-img left-collapse-img"),i.setAttribute("class","hidden-left-div hidden-left-collapse-div"),e()):(i.setAttribute("class","hidden-left-div"),this.setAttribute("class","left-expand-img"),t())}},Utils.createTopToggleImage=function(e,t,i){var n=Utils.createToggleImage("hidden-top-div","top-expand-img",i);n.onclick=function(){var i=document.getElementsByClassName("hidden-top-div")[0],n=document.getElementById("menubar");"top-expand-img"==this.getAttribute("class")?(this.setAttribute("class","top-expand-img top-collapse-img"),i.setAttribute("class","hidden-top-div hidden-top-collapse-div"),n.style.display="none",e()):(i.setAttribute("class","hidden-top-div"),this.setAttribute("class","top-expand-img"),n.style.display="block",t())}},Utils.isMainNode=function(e){var t=!1;return e&&e.getClient&&Utils.isNotNull(e.getClient("mainVisible"))&&0==e.getClient("mainVisible")&&(t=!0),t},Utils.setBox3DSelectStyle=function(e,t){e.forEach(function(e){e instanceof mono.Entity&&Utils.setElementSelectStyle(e,t)})},Utils.setElementSelectStyle=function(e,t){t==PropertyConsts.SELECT_STYLE.WIREFRAME?e.setStyle("select.style","outline.wireframe"):t==PropertyConsts.SELECT_STYLE.NORMAL?e.setStyle("select.style","outline.normal"):t==PropertyConsts.SELECT_STYLE.BORDER&&e.setStyle("select.style","border")},Utils.setElementCustomProps=function(e,t,i){var n=t.getClient(CUSTOM_PROPS);if(n)for(var o in n){var a=n[o];void 0==i[a]&&t.setClient(a,null)}if(i){var s;for(var o in i)s=i[o],t.setClient(s,e.getClient(s));t.setClient(CUSTOM_PROPS,i)}},Utils.isFloorVisibleByFloorName=function(e,t){var i=!0;return t.forEach(function(t){return t.getClient("floorName")==e?i=t.getClient("floorVisible"):void 0}),i},Utils.transforAndScaleCanvasContext=function(e,t){var i=e.getContext("2d");if(!t&&e.isTransfor&&e.width&&e.height)return i;if(devicePixelRatio=window.devicePixelRatio||1,backingStoreRatio=i.webkitBackingStorePixelRatio||i.mozBackingStorePixelRatio||i.msBackingStorePixelRatio||i.oBackingStorePixelRatio||i.backingStorePixelRatio||1,ratio=devicePixelRatio/backingStoreRatio,devicePixelRatio!==backingStoreRatio){var n=e.width,o=e.height;e.width=n*ratio,e.height=o*ratio,e.style.width=n+"px",e.style.height=o+"px",i.scale(ratio,ratio)}return e.width&&e.height&&(e.isTransfor=!0),i},Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},Number.prototype.format=function(e,t,i,n){var o="\\d(?=(\\d{"+(t||3)+"})+"+(e>0?"\\D":"$")+")",a=this.toFixed(Math.max(0,~~e));return(n?a.replace(".",n):a).replace(new RegExp(o,"g"),"$&"+(i||","))},ImageShapeNode=function(){ImageShapeNode.superClass.constructor.apply(this,arguments),this.setClient(IMAGE_SRC,Utils.Path+"room.png"),this.setStyle("vector.outline.color","#333333"),this.setStyle("vector.outline.width",10),this.setClient("shapenode.closed",!0),this.setClient("focusColor","green"),this.setClient("resizeBorderWidth",10),this.setClient("resizeBorderLength",18),this.setClient("resizeBorderGap",10),this.setClient("resizeBorderColor","yellow"),this.setClient("wallInnerPic",Utils.Path+"wall00-inner.png"),this.setClient("wallOuterPic",Utils.Path+"wall00.png"),this.setClient("lightMapPic",Utils.Path+"lightmap.png"),this.setClient("size",{x:0,y:300,z:10}),this.setClient("useTexture",!1),this.setClient("framePic",Utils.Path+"wall00-frame.png"),this.setClient("fill",!0),this.setClient("showDim",showDim),this.setClient("dimLeadLength",35),this.setClient("dimLineOffset",.7),this.setClient("dimLineWidth",1),this.setClient("dimColor","#F07819"),this.setClient("dimTextGap",5),this.setClient("dimTextFont","12px Arial"),this.setClient("dimArrowWidth",8),this.setClient("dimArrowHeight",3),this.setClient("showCoord",showCoord),this.setClient("coordTextColor","white"),this.setClient("coordTextFont","12px Arial"),this.setClient("coordTextOffsetX",0),this.setClient("coordTextOffsetY",20),this.setClient("coordTextAlign","center"),this.setClient("coordTextBaseline","middle"),this.setClient("coordTextBackground","rgba(240,120,25,0.7)"),this.setClient("decimalNumber",0),this.setClient("room.gap.right",100),this.setClient("room.gap.bottom",100),this.offsetY=0,this.offsetX=0,this.negatedYInterval=!1},twaver.Util.ext("ImageShapeNode",twaver.ShapeNode,{getCanvasUIClass:function(){return ImageShapeNodeUI},getElementUIClass:function(){return ImageShapeNodeUI},getVectorUIClass:function(){return ImageShapeNodeUI},onChildRemoved:function(e,t){this.refreshChilden()},onChildAdded:function(e,t){this.refreshChilden()},onPropertyChanged:function(e){ImageShapeNode.superClass.onPropertyChanged.call(this,e),"points"===e.property&&this.refreshChilden()},checkBlockOnEdge:function(e){var t=!1;return this.getChildren().forEach(function(i){i.getClient("edgeIndex")===e&&(t=!0)}),t},refreshChilden:function(){this.getChildren().forEach(function(e){e.refresh()})},translate3d:function(e,t,i){var n=new Array,o=this.getPoints(),a=this.getCenterLocation(),s=new twaver.List;o.forEach(function(e){s.add({x:e.x-a.x,y:e.y-a.y})});var r=o.size();if(!(0>=r)){2==r&&this.setClient("shapenode.closed",!1);var l=this.getClient("shapenode.closed");this._wallInnerPic=""===this.getClient("wallInnerPic")?null:Utils.handlerTexture(this.getClient("wallInnerPic")),this._wallOuterPic=""===this.getClient("wallOuterPic")?null:Utils.handlerTexture(this.getClient("wallOuterPic")),this._wallFramePic=""===this.getClient("framePic")?null:Utils.handlerTexture(this.getClient("framePic")),this._lightMapPic=""===this.getClient("lightMapPic")?null:Utils.handlerTexture(this.getClient("lightMapPic")),this instanceof InnerWallShapeNode&&(this._wallOuterPic=this._wallInnerPic),this.floorName=this.getClient("floorName"),this.floorHeight=this.getClient("floorHeight");var d=this.getClient("size"),h=this.getClient("useTexture"),c=this.getClient("transparent"),g=this.getClient("opacity"),m=this.getClient(CUSTOM_PROPS),u=this.getClient(PropertyConsts.LAYERID);this.deep=10;var p=300;this.repeat=50,d&&(this.deep=d.z,p=d.y),0==h&&(this.repeat=p);for(var f=new mono.Path,v=0;r>v;v++){if(i)var y=s.get(v);else var y=o.get(v);0==v?f.moveTo(y.x,-y.y,0):f.lineTo(y.x,-y.y,0)}l&&f.closePath();var C=this.getId(),S=e.getDataById(C),I=new mono.PathCube({path:f,width:this.deep,height:p,repeat:this.repeat});e.startBatch(),I.setStyle("m.texture.image",this._wallOuterPic),I.setStyle("inside.m.texture.image",this._wallInnerPic),I.setStyle("top.m.texture.image",this._wallFramePic),I.setStyle("bottom.m.texture.image",this._wallFramePic),I.setStyle("aside.m.texture.image",this._wallFramePic),I.setStyle("zside.m.texture.image",this._wallFramePic),I.setStyle("m.transparent",c),I.setStyle("inside.m.lightmap.image",this._lightMapPic),I.setStyle("outside.m.lightmap.image",this._lightMapPic),I.setStyle("m.opacity",g);var P=this.getClient("shapeNodeIndex");Utils.setPolygonOffset(I,2*-P),e.endBatch();var A=[],E=[];A.push(I);for(var w=0;w<t.length;w++){var b=t[w],x=this.createBlocks(e,b,n,a);A.push(x),E.push("-")}return!S&&C&&(S=C?new mono.ComboNode(A,E,!1,C):new mono.ComboNode),A.length>0&&S.setCombos(A),E&&S.setOperators(E),S.setStyle("m.type","phong"),S.setClient("floorName",this.floorName),S.setPositionY(this.floorHeight||0),S.setPositionX(a.x),S.setPositionZ(a.y),S.setEditable(!0),S.setSelectable(!0),Utils.setElementCustomProps(this,S,m),u&&S.setClient(PropertyConsts.LAYERID,u),e.getDataById(C)||e.add(S),n.push(S),n}},createBlocks:function(e,t,i,n){var o=new mono.Path,a=t.getCenterLocation(),s=t.getClient("leftPoint"),r=t.getClient("rightPoint");s={x:s.x-n.x,y:s.y-n.y},r={x:r.x-n.x,y:r.y-n.y},o.moveTo(s.x,-s.y,0),o.lineTo(r.x,-r.y,0);var l=t.getClient("height"),d=t.getClient("positionY"),h=new mono.PathCube(o,this.deep,l,null,this.repeat);if(h.setStyle("m.texture.image",this._wallFramePic),h.setPositionY(d||0),!t.isCutoff()){var c=t.getBlockPicture(),g=t.getStyle("vector.outline.width"),m=t.getBlockWidth()+g,u=t.getBlockHeight(),p=t.getBlockDepth(),f=r.x-s.x,v=r.y-s.y,y=t.getAngle(f,-v),C=new MaterialDesc,S=t.getClient("transparent"),I=t.getClient("opacity"),P=t.getClient(PropertyConsts.LAYERID);C.transparent=!0,null==c?(C.color="white",C.alpha=0):C.texture=c,e.getDataById(t.getId())&&e.removeById(t.getId());var A=t.getClient(CUSTOM_PROPS),E=GeometryTranslater.get3DGeometry(C,"mono.Cube",{x:m,y:u,z:p},{x:a.x,y:d+(this.floorHeight||0)+u/2,z:a.y},null,null,null,{id:t.getId()});E.setRotationY(y),E.setClient("floorName",this.floorName),E.setClient("animation",t.getClient("animation")),E.setStyle("m.specularStrength",t.getClient("specularStrength")),E.setStyle("m.opacity",1),E.setStyle("m.transparent",!1),E.setStyle("front.m.transparent",S),E.setStyle("front.m.opacity",I),E.setStyle("back.m.transparent",S),E.setStyle("back.m.opacity",I),E.setStyle("m.polygonOffset",!0),E.setStyle("m.polygonOffsetFactor",.1),E.setStyle("m.polygonOffsetUnits",1),E.setEditable(!1),E.setSelectable(!1),E.setWidth(m),t.getClient("horizontalFlip")&&E.setStyle("back.m.texture.flipX",t.getClient("horizontalFlip")),P&&E.setClient(PropertyConsts.LAYERID,P),Utils.setElementCustomProps(t,E,A),e.getDataById(t.getId())||e.add(E),this.setBlockMapPropety(t,E),i.push(E)}return h},setBlockMapPropety:function(e,t){var i=e.getClient("envmap"),n=e.getClient("reflectRatio")||1,o=e.getClient("normalmap"),a=e.getClient("normalScale")||{x:1,y:1},s=e.getClient("normalType"),r=e.getClient("specularmap"),l=e.getClient("specular"),d=e.getClient("lightmap");t.s({"front.m.envmap.image":i?[i,i,i,i,i,i]:null,"m.reflectRatio":n,"front.m.normalmap.image":o,"back.m.normalmap.image":o,"m.normalScale":new mono.XiangliangTwo(a.x,a.y),"m.normalType":s,"front.m.specularmap.image":r,"m.specular":l,"m.lightmap.image":d})},isPointOnPoints:function(e){for(var t=this.getPoints(),i=0;i<t.size();i++)if(_twaver.math.getDistance(e,t.get(i))<=10)return!0;return!1},getPointIndex:function(e){var t=this.getPoints();if(t.size()<2)return-1;for(var i=0;i<t.size();i++)if(_twaver.math.getDistance(e,t.get(i))<=10)return-1;for(var n,o=t.get(0),i=1;i<t.size();i++){if(n=t.get(i),this.isPointOnLine(e,o,n,10))return i-1;o=n}return o=t.get(0),this.isPointOnLine(e,o,n,10)?t.size()-1:-1},isPointOnLine:function(e,t,i,n){0>n&&(n=0);var o=this.getDistanceFromPointToLine(e,t,i);return n>=o&&e.x>=Math.min(t.x,i.x)-n&&e.x<=Math.max(t.x,i.x)+n&&e.y>=Math.min(t.y,i.y)-n&&e.y<=Math.max(t.y,i.y)+n},getDistanceFromPointToLine:function(e,t,i){if(t.x===i.x)return Math.abs(e.x-t.x);var n=(i.y-t.y)/(i.x-t.x),o=(i.x*t.y-t.x*i.y)/(i.x-t.x);return Math.abs(n*e.x-e.y+o)/Math.sqrt(n*n+1)},setOffsetYofPoints:function(e){this.offsetY=e},setOffsetXofPoints:function(e){this.offsetX=e},getOffsetYofPoints:function(){return this.offsetY},getOffsetXofPoints:function(){return this.offsetX},setNegatedYInterval:function(e){this.negatedYInterval=e},getNegatedYInterval:function(){return this.negatedYInterval}}),ImageShapeNodeUI=function(e,t){ImageShapeNodeUI.superClass.constructor.apply(this,arguments)},twaver.Util.ext("ImageShapeNodeUI",twaver.vector.ShapeNodeUI,{drawDefaultBody:function(e){var t=this._element;if(t._points&&!(t._points.size()<1)){var i=this._getZoomPoints(),n=t._segments,o=t.getStyle("vector.outline.width"),a=t.getStyle("vector.outline.pattern"),s=t.getStyle("vector.outline.width"),r=t.getStyle("vector.outline.color"),l=t.getClient("shapenode.closed"),d=twaver.Util.getRect(i),h=e;o>0&&twaver.Util.grow(d,o,o);var c,g=this._gl3dview.isSelected(this._element),m=this._element.getClient("resizeBorderWidth"),u=this._element.getClient("resizeBorderLength"),p=this._element.getClient("resizeBorderGap"),f=this._element.getClient("resizeBorderColor"),v=t.getClient("showDim"),y=t.getClient("showCoord");g&&(c=_twaver.clone(d)),h=this.setShadow(this,h),h.beginPath();var C=twaver.Util.getImageAsset(t.getClient(IMAGE_SRC));C&&(h.fillStyle=h.createPattern(C.getImage(),"repeat")),h.lineWidth=s,h.strokeStyle=r,_twaver.g.drawLinePoints(h,i,a,n,l),t.getClient("fill")&&h.fill(),h.stroke();var S=t.getClient("focusIndex");if(S>=0){var I=i.get(S),P=i.get(S===i.size()-1?0:S+1);h.beginPath(),h.strokeStyle=t.getClient("focusColor"),h.moveTo(I.x,I.y),h.lineTo(P.x,P.y),h.stroke()}if(g){h.lineWidth=m+2,h.strokeStyle="black",h.beginPath(),this._borderLines=[];var A,E,w;A={x:c.x-p,y:c.y-p},E={x:A.x,y:A.y+u},w={x:A.x+u,y:A.y},this._addBorderLine(h,A,E,w),A={x:c.x+c.width+p,y:c.y-p},E={x:A.x-u,y:A.y},w={x:A.x,y:A.y+u},this._addBorderLine(h,A,E,w),A={x:c.x+c.width+p,y:c.y+c.height+p},E={x:A.x,y:A.y-u},w={x:A.x-u,y:A.y},this._addBorderLine(h,A,E,w),A={x:c.x-p,y:c.y+c.height+p},E={x:A.x+u,y:A.y},w={x:A.x,y:A.y-u},this._addBorderLine(h,A,E,w),h.stroke(),h.beginPath(),h.lineWidth=m,h.strokeStyle=f,u-=1,A={x:c.x-p,y:c.y-p},E={x:A.x,y:A.y+u},w={x:A.x+u,y:A.y},h.moveTo(E.x,E.y),h.lineTo(A.x,A.y),h.lineTo(w.x,w.y),A={x:c.x+c.width+p,y:c.y-p},E={x:A.x-u,y:A.y},w={x:A.x,y:A.y+u},h.moveTo(E.x,E.y),h.lineTo(A.x,A.y),h.lineTo(w.x,w.y),A={x:c.x+c.width+p,y:c.y+c.height+p},E={x:A.x,y:A.y-u},w={x:A.x-u,y:A.y},h.moveTo(E.x,E.y),h.lineTo(A.x,A.y),h.lineTo(w.x,w.y),A={x:c.x-p,y:c.y+c.height+p},E={x:A.x+u,y:A.y},w={x:A.x,y:A.y-u},h.moveTo(E.x,E.y),h.lineTo(A.x,A.y),h.lineTo(w.x,w.y),h.stroke()}g&&(y&&this.drawCoord(h),v&&this.drawDim(h))}},validateBodyBounds:function(){ImageShapeNodeUI.superClass.validateBodyBounds.call(this);var e=this._element;if(e._points&&!(e._points.size()<1)){var t=this._getZoomPoints();if(!(t.size()<2)){var i=e.getStyle("vector.outline.width"),n=this.getPathRect("vector",!0);i>0&&twaver.Util.grow(n,i,i);var o=this._gl3dview.isSelected(this._element),a=this._element.getClient("resizeBorderWidth"),s=this._element.getClient("resizeBorderGap");o&&twaver.Util.grow(n,(a+s)/this._gl3dview.getZoom()*2+2,(a+s)/this._gl3dview.getZoom()*2+2),this.addBodyBounds(n)}}},_addBorderLine:function(e,t,i,n){this._borderLines.push({point1:i,point2:t}),this._borderLines.push({point1:t,point2:n}),e.moveTo(i.x,i.y),e.lineTo(t.x,t.y),e.lineTo(n.x,n.y)},isPointOnBorderLine:function(e){if(!this._borderLines)return null;for(var t=this._element.getClient("resizeBorderWidth"),i=0;i<this._borderLines.length;i++){var n=this._borderLines[i];if(this._element.isPointOnLine(e,n.point1,n.point2,t))return Math.floor(i/2)}return null},drawDim:function(e){function t(e,t,o){var a=_twaver.math.getCenterPoint(e,t),s=angle1=_twaver.math.getAngle(e,t);t.x<e.x&&(s=Math.PI+s);var r=o.toFixed(2),h=n.measureText(r).width,c=_twaver.math.createMatrix(s,e.x,e.y),m=c.transform({x:e.x,y:e.y-l}),f=c.transform({x:e.x,y:e.y-l*d});c=_twaver.math.createMatrix(s,t.x,t.y);var v=c.transform({x:t.x,y:t.y-l}),y=c.transform({x:t.x,y:t.y-l*d}),C=i.getPointBetween(f,y,.5-(h/2+g)/o),S=i.getPointBetween(f,y,.5+(h/2+g)/o),I=i.getPointBetween(f,y,u/o);c=_twaver.math.createMatrix(s,I.x,I.y);var P=c.transform({x:I.x,y:I.y-p}),A=c.transform({x:I.x,y:I.y+p}),E=i.getPointBetween(f,y,1-u/o);c=_twaver.math.createMatrix(s,E.x,E.y);var w=c.transform({x:E.x,y:E.y-p}),b=c.transform({x:E.x,y:E.y+p});n.beginPath(),n.moveTo(e.x,e.y),n.lineTo(m.x,m.y),n.moveTo(t.x,t.y),n.lineTo(v.x,v.y),n.moveTo(f.x,f.y),n.lineTo(C.x,C.y),n.moveTo(S.x,S.y),n.lineTo(y.x,y.y),n.moveTo(f.x,f.y),n.lineTo(P.x,P.y),n.moveTo(f.x,f.y),n.lineTo(A.x,A.y),n.moveTo(y.x,y.y),n.lineTo(w.x,w.y),n.moveTo(y.x,y.y),n.lineTo(b.x,b.y),n.stroke(),n.save(),a={x:(f.x+y.x)/2,y:(f.y+y.y)/2},n.translate(a.x,a.y),n.rotate(angle1),n.translate(-a.x,-a.y),n.fillText(r,a.x,a.y),n.restore()}var i=this,n=e,o=this._element,a=this._getZoomPoints(),s=o.getPoints();if(a&&!(a.size()<2)&&this._gl3dview.isSelected(o)){var r=this.getBodyRect(),l=o.getClient("dimLeadLength"),d=o.getClient("dimLineOffset"),h=o.getClient("dimLineWidth"),c=o.getClient("dimColor"),g=o.getClient("dimTextGap"),m=o.getClient("dimTextFont"),u=o.getClient("dimArrowWidth"),p=o.getClient("dimArrowHeight"),f={x:r.x-l,y:r.y-l,width:r.width+2*l,height:r.height+2*l};this.isClockwise()&&(l=-l),this.addBodyBounds(f),n=this.setShadow(this,n),n.strokeStyle=c,n.lineWidth=h,n.fillStyle=c,n.font=m,n.textAlign="center",n.textBaseline="middle";for(var v=a.get(0),y=s.get(0),C=1,S=a.size();S>C;C++){var I=a.get(C),P=s.get(C),A=_twaver.math.getDistance(y,P);y=P,t(v,I,A),v=I}if(S>2){var A=_twaver.math.getDistance(y,s.get(0));t(v,a.get(0),A)}}},getPointBetween:function(e,t,i){return{x:e.x+(t.x-e.x)*i,y:e.y+(t.y-e.y)*i}},isClockwise:function(e){var t=this._element,e=t.getPoints();if(!e||e.size()<2)return!0;for(var i=0,n=e.size(),o=0;n>o;o++){var a=e.get(o),s=e.get(o+1===n?0:o+1);i+=(s.x-a.x)*(s.y+a.y)}return i>0},drawCoord:function(e){var t=e,i=this._element,n=this._getZoomPoints(),o=i.getPoints();if(n&&o){var a=this.getBodyRect(),s=i.getClient("coordTextColor"),r=i.getClient("coordTextFont"),l=i.getClient("coordTextOffsetX"),d=i.getClient("coordTextOffsetY"),h=i.getClient("coordTextAlign"),c=i.getClient("coordTextBaseline"),g=i.getClient("coordTextBackground"),m=i.getClient("decimalNumber"),u={x:a.x-100,y:a.y-50,width:a.width+200,height:a.height+100};this.addBodyBounds(u),t=this.setShadow(this,t),t.save(),t.font=r;for(var p=0,f=n.size();f>p;p++){var v=n.get(p),y=o.get(p),C="("+(v.x+i.getOffsetXofPoints()).toFixed(m)+", "+(v.y*(i.getNegatedYInterval()?-1:1)+i.getOffsetYofPoints()).toFixed(m)+")";y&&(C="("+(y.x+i.getOffsetXofPoints()).toFixed(m)+", "+(y.y*(i.getNegatedYInterval()?-1:1)+i.getOffsetYofPoints()).toFixed(m)+")");var S=_twaver.g.getTextSize(t.font,C);t.fillStyle=g,t.fillRect(v.x-S.width/2+l,v.y-S.height/2+d,S.width,S.height),t.fillStyle=s,t.textAlign=h,t.textBaseline=c,t.fillText(C,v.x,v.y+d)}t.restore()}}}),InnerWallShapeNode=function(){InnerWallShapeNode.superClass.constructor.apply(this,arguments),this.setClient(IMAGE_SRC,Utils.Path+"room.png"),this.setStyle("vector.outline.color","#333333"),this.setStyle("vector.outline.width",5),this.setClient("shapenode.closed",!1),this.setClient("focusColor","green"),this.setClient("resizeBorderWidth",10),this.setClient("resizeBorderLength",25),this.setClient("resizeBorderGap",10),this.setClient("resizeBorderColor","yellow"),this.setClient("size",{x:0,y:230,z:4}),this.setClient("repeat",{row:1,column:1})},twaver.Util.ext("InnerWallShapeNode",ImageShapeNode,{translate3d:function(e,t,i){var n=this.getPoints(),o=n.size();if(!(0>=o)){for(var a=0;o>a;a++)this.setStyle("inner_wall_"+a,!0);return ImageShapeNode.prototype.translate3d.call(this,e,t,i)}}}),FloorShapeNode=function(){FloorShapeNode.superClass.constructor.apply(this,arguments),this.setClient(IMAGE_SRC,Utils.Path+"floor02_3d.png"),this.setStyle("vector.outline.color","#FFFFFF"),this.setStyle("vector.outline.width",0),this.setClient("shapenode.closed",!0),this.setClient("focusColor","blue"),this.setClient("repeat",100),this.setClient("size",{x:0,y:0,z:.1}),this.setClient("transparent",!1),this.setClient("opacity",1)},twaver.Util.ext("FloorShapeNode",ImageShapeNode,{translate3d:function(e,t,i){var n=this.getPoints(),o=n.size(),a=this.getCenterLocation(),s=new twaver.List;if(n.forEach(function(e){s.add({x:e.x-a.x,y:e.y-a.y})}),!(0>=o||2>=o)){for(var r=this.getClient("floorHeight"),l=this.getClient("floorName"),d=this.getClient("transparent"),h=this.getClient("opacity"),c=Utils.handlerTexture(""===this.getClient(IMAGE_SRC)?null:this.getClient(IMAGE_SRC)),g=this.getClient("repeat"),m=this.getClient(CUSTOM_PROPS),u=this.getClient(PropertyConsts.LAYERID),p=new mono.Path,f=0;o>f;f++){var v=s.get(f);0==f?p.moveTo(v.x,-v.y,0):p.lineTo(v.x,-v.y,0)}var y=.1,o=this.getClient("size");o&&(y=o.z),y=parseFloat(y||1);var C=e.getDataById(this.getId());if(!C)var C=new mono.ShapeNode({id:this.getId(),path:p});return r=(r||0)-1,C.setPath(p),C.setPositionX(a.x),C.setPositionZ(a.y),C.setAmount(y),C.setVertical(!0),C.setRepeat(g),C.setStyle("m.texture.image",c),C.setStyle("m.type","phong"),C.setStyle("m.transparent",d),C.setStyle("m.opacity",h),C.setClient("floorName",l),C.setPositionY(r),C.setSelectable(!1),Utils.setElementCustomProps(this,C,m),u&&C.setClient(PropertyConsts.LAYERID,u),e.getDataById(this.getId())||e.add(C),C}}}),mono.Floor=function(e){this.material=new mono.EntityMaterial,this.materialSize=1,mono.BufferNode.call(this),this.points=e._as?e._as:e,this.points=n(this.points),this.compuateBufferData(),this.renderDepth=1e3},mono.extend(mono.Floor,mono.BufferNode,{constructor:mono.Floor,fixCenter:function(){var e=new Array;if(this.points){for(var t=0,i=0,n=0;n<this.points.length;n++){var o=this.points[n];t+=o.x,i+=o.y}t/=this.points.length,i/=this.points.length;for(var n=0;n<this.points.length;n++){var o=this.points[n];e.push({x:o.x-t,y:o.y-i})}this.points=e,this.setPosition(new mono.XiangliangThree(o.x,0,o.y))}},compuateBufferData:function(){for(var e={},t=0,i=0,n=0,o=0,a=0,i=0;i<this.points.length;i++){var s=this.points[i];n+=3*s.length,o+=3*(s.length-2),a+=2*s.length}var r=new Float32Array(n);for(e.array=r,e.itemSize=3,e.numItems=n,this.attributes.position=e,i=0;i<this.points.length;i++)for(var s=this.points[i],l=0;l<s.length;l++){var d=s[l],h=d.length?d[0]:d.x,c=d.length?d[1]:d.y;r[t]=h,r[t+1]=0,r[t+2]=c,t+=3}this.offsets=[{index:0,count:o}];var g={};g.array=new Uint16Array(o),this.attributes.index=g,t=0;var m=0;for(i=0;i<this.points.length;i++){for(var s=this.points[i],l=0;l<s.length-2;l++)g.array[t]=m,g.array[t+1]=m+l+1,g.array[t+2]=m+l+2,t+=3;m+=s.length}var u={};u.itemSize=2,u.numItems=a,u.array=new Float32Array(a),this.attributes.uv=u;var p=this.getRect();for(t=0,i=0;i<this.points.length;i++)for(var s=this.points[i],l=0;l<s.length;l++){var d=s[l],h=d.length?d[0]:d.x,f=d.length?d[1]:d.y,v=(h-p.x)/p.width,y=(f-p.y)/p.height;u.array[t]=v,u.array[t+1]=y,t+=2}this.verticesNeedUpdate=!0,this.elementsNeedUpdate=!0,this.uvsNeedUpdate=!0},getRect:function(){for(var e=null,t=0;t<this.points.length;t++){var i=this.points[t];if(null===e)e=this.getPointsRect(i);else{var n=this.getPointsRect(i);e=this.unionRect(e,n)}}return e},unionRect:function(e,t){if(e&&t){var i={};return i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.width=Math.max(e.x+e.width,t.x+t.width)-i.x,i.height=Math.max(e.y+e.height,t.y+t.height)-i.y,i}return null},getPointsRect:function(e){if(!e)return null;e._as&&(e=e._as);var t=e.length;if(0>=t)return null;for(var i=e[0],n=i.length?i[0]:i.x,o=i.length?i[1]:i.y,a={
x:n,y:o,width:0,height:0},s=1;t>s;s++){i=e[s];var n=i.length?i[0]:i.x,o=i.length?i[1]:i.y,r=Math.min(a.x,n),l=Math.max(a.x+a.width,n),d=Math.min(a.y,o),h=Math.max(a.y+a.height,o);a.x=r,a.y=d,a.width=l-r,a.height=h-d}return a}}),PrimitiveNode=function(){PrimitiveNode.superClass.constructor.apply(this,arguments),this.setClient("oscale",100),this.setClient("scaleFont","18px Verdana"),this.setClient("scaleColor","black"),this.setClient("maskColor","white"),this.setClient("maskAlpha",.5),this.setClient("tipsFont","12px Calibri"),this.setClient("tips","Scroll to Scale"),this.setClient("selectedColor","yellow"),this.setStyle("label.position","center"),this.setStyle("select.style","null"),this.setClient("vertical",!0),this.setImage("primitiveNode_Image")},twaver.Util.ext("PrimitiveNode",twaver.Follower,{translate3d:function(e,t){var i=this.getClient("scale"),n=this.getClient("oscale"),o=this.getClient("size"),a=this.getClient("assembleSize"),s=this.getClient("rot"),r=this.getClient("texture"),l=this.getClient("className"),d=this.getClient("transparent"),h=this.getClient("opacity"),c=null,g=this.getClient(CUSTOM_PROPS),m=this.getClient("vertical"),u=this.getClient(PropertyConsts.LAYERID);c=r?r instanceof Array?r:r instanceof twaver.List?r.toArray():r.indexOf(Utils.Path)>=0?r:Utils.Path+r:Utils.Path+PropertyConsts.DEFAULT_IMAGE,this.setClient(IMAGE_SRC,c);var p=this.getClient("repeat"),f=this.getClient("types"),v=this.getClient("colors"),y=this.getClient("visible"),C=this.getClient("other"),S=this.getClient("positionY"),I=this.getClient("floorHeight"),P=this.getClient("flipX"),A=this.getClient("flipY"),E=this.getClient("envmap"),w=this.getClient("reflectRatio"),b=this.getClient("normalmap"),x=this.getClient("normalScale"),_=this.getClient("normalType"),T=this.getClient("specularmap"),O=this.getClient("specular"),N=this.getClient("lightmap"),L={repeat:p,types:f,color:v,transparent:d,opacity:h,visible:y,flipX:P,flipY:A,envmap:E,reflectRatio:w,normalmap:b,normalScale:x,normalType:_,specularmap:T,specular:O,lightmap:N},M=new MaterialDesc;c instanceof Array&&(M.tType=c.length),M.texture=c;for(var R in L){var U=L[R];this.setArrayStyleValue(R,U,M)}C&&Utils.isNotNull(C.openTop)&&(M.openTop=C.openTop),C&&Utils.isNotNull(C.openBottom)&&(M.openBottom=C.openBottom),M.color=this.getClient("colors"),M.ambient=this.getClient("ambient"),C=C||{},o=o||a,C.id=this.getId();var D=this.get3DShape(M,l,o,C,e);if(D.setName(this.getClient("primitiveName")),D){Utils.setElementCustomProps(this,D,g),u&&D.setClient(PropertyConsts.LAYERID,u);var k=this.getClient(OID);k&&D.setClient(OID,k);var B=this.getClient(BID);B&&D.setClient(BID,B),s&&D.setRotation(s.x,s.y,s.z),Utils.isNotNull(this.getAngle())&&0!=this.getAngle()&&(isSettingRotation=!0,D.setRotation(0,0,0),isSettingRotation=!1,D.rotateFromWorldYAxis(Utils.convert2Radian(-this.getAngle())));var F=this.getCenterLocation();if(null==this.getHost()||this.getHost()instanceof FloorShapeNode){if(F){D.setPositionX(F.x),a?D.setPositionY(a.y/2):D.setPositionY(0),D.setPositionZ(F.y);var z=this.getClient("off");z&&(D.setPositionX(F.x-z.x),D.setPositionZ(F.y-z.z))}}else if(F){var G=this.getClient("position");G&&D.setPosition(G.x,G.y,G.z)}var i=this.getClient("scale");i||(i=new mono.XiangliangThree(1,1,1)),i&&(n&&(n/=100,i=new mono.XiangliangThree(i.x*n,i.y*n,i.z*n),D.setPositionY(D.getPosition().y*n)),D.setScale(i)),void 0!==m&&D.setStyle("m.vertical",m),S=S?S:0,D.setPositionY(D.getPosition().y+S),I&&D.setPositionY(D.getPosition().y+I),D.setEditable(!0),D.setSelectable(!0);var V=this.getClient(TAG_ANIMATION);V&&D.setClient(TAG_ANIMATION,V);var H=this.getClient("animationGroup");H&&D.setClient("animationGroup",H);var Y=this.getClient("mainVisible");Utils.isNotNull(Y)&&(D.setClient("mainVisible",Y),D.setStyle("m.transparent",!0),D.setStyle("m.opacity",.001)),D.setClient("floorName",this.getClient("floorName")),D.setGroupId(this.getClient("groupid")),D.setClient("nodeId",this.getId()),this.getClient("isEntity")&&D.setClient("isEntity",!0);var W=parseFloat(this.getClient("scaleValue"));if(W)if(D instanceof mono.Billboard){D.setPositionX(parseFloat(D.getPositionX()*W)),D.setPositionY(parseFloat(D.getPositionY()*W)),D.setPositionZ(parseFloat(D.getPositionZ()*W));var i=D.getScale();D.setScale(parseFloat(i.x*W),parseFloat(i.y*W),parseFloat(i.z*W))}else if(D instanceof mono.Cube){var X=D.getWidth(),j=D.getHeight(),Z=D.getDepth();D.setWidth(X*W),D.setHeight(j*W),D.setDepth(Z*W),this.getParent()&&(D.setPositionX(parseFloat(D.getPositionX()*W)),D.setPositionY(parseFloat(D.getPositionY()*W)),D.setPositionZ(parseFloat(D.getPositionZ()*W)))}else{D.setPositionX(parseFloat(D.getPositionX()*W)),D.setPositionY(parseFloat(D.getPositionY()*W)),D.setPositionZ(parseFloat(D.getPositionZ()*W));var i=D.getScale();D.setScale(parseFloat(i.x*W),parseFloat(i.y*W),parseFloat(i.z*W))}if(D instanceof mono.PointLight){if(this.getClient("lightPosition")){var J=this.getClient("lightPosition").split(",");3===J.length&&D.setPosition(new mono.XiangliangThree(parseFloat(J[0]),parseFloat(J[1]),parseFloat(J[2])))}this.getClient("lightColor")&&D.setColor(this.getClient("lightColor")),this.getClient("lightIntensity")&&D.setIntensity(parseFloat(this.getClient("lightIntensity")))}if(D instanceof mono.SpotLight){if(this.getClient("lightPosition")){var J=this.getClient("lightPosition").split(",");3===J.length&&D.setPosition(new mono.XiangliangThree(parseFloat(J[0]),parseFloat(J[1]),parseFloat(J[2])))}else D.setPositionY(100);this.getClient("lightColor")&&D.setColor(this.getClient("lightColor")),this.getClient("lightIntensity")&&D.setIntensity(parseFloat(this.getClient("lightIntensity"))),this.getClient("angle")&&D.setAngle(parseFloat(this.getClient("angle")))}return this.afterTranslate3d(D),D}},setArrayStyleValue:function(e,t,i){t&&(t instanceof twaver.List&&(t=t.toArray()),(t instanceof Array&&t.length>0||!t instanceof Array)&&(i[e]=t))},afterTranslate3d:function(e){mono.AniUtil.resetAnimatedFlag(e)},get3DShape:function(e,t,i,n,o){var a=$gt3d(e,t,i,null,null,null,null,n,this,o);return a.setSelectable(!0),a},getVectorUIClass:function(){return PrimitiveNodeUI}}),PrimitiveNodeUI=function(e,t){PrimitiveNodeUI.superClass.constructor.apply(this,arguments)},twaver.Util.ext("PrimitiveNodeUI",twaver.vector.NodeUI,{validateBodyBounds:function(){PrimitiveNodeUI.superClass.validateBodyBounds.call(this);var e=this.getBodyRect();0!=this._element.getAngle()&&(e=this._element.getOriginalRect()),this.addBodyBounds(e)}}),twaver.Util.registerShape("triangle",function(e,t,i,n){var o=i.getOriginalRect(),a=o.width,s=o.height;a>12/n.getZoom()&&(a-=12/n.getZoom()),s>12/n.getZoom()&&(s-=12/n.getZoom()),e.moveTo(-a/2,s/2),e.lineTo(a/2,s/2),e.lineTo(0,0),e.lineTo(-a/2,s/2),e.closePath()}),twaver.Util.registerShape("small_triangle",function(e,t,i,n){if(i.getHost()){var o=i.getOriginalRect(),a=8/n.getZoom();a>o.width&&(a=o.width),a>o.height&&(a=o.height),o.height/2<a&&(a=0),e.moveTo(0,0),e.lineTo(0,a)}}),twaver.Util.registerImage("primitiveNode_Image",{v:[{shape:"rect",fill:function(e){var t=gl3dview.isSelected(e),i=e.getClient("maskColor");return t&&(i=e.getClient("selectedColor")),i},alpha:'<%=getClient("maskAlpha")%>',rect:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>12/gl3dview.getZoom()&&(i-=12/gl3dview.getZoom()),n>12/gl3dview.getZoom()&&(n-=12/gl3dview.getZoom()),[-i/2,-n/2,i,n]}},{shape:"rect",alpha:1,lineColor:"#927652",lineWidth:6,rect:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>6/gl3dview.getZoom()&&(i-=6/gl3dview.getZoom()),n>6/gl3dview.getZoom()&&(n-=6/gl3dview.getZoom()),[-i/2,-n/2,i,n]}},{shape:"line",fill:"gray",lineWidth:1,p1:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>12/gl3dview.getZoom()?i-=12/gl3dview.getZoom():i=0,n>12/gl3dview.getZoom()?n-=12/gl3dview.getZoom():n=0,{x:-i/2,y:-n/2}},p2:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>12/gl3dview.getZoom()?i-=12/gl3dview.getZoom():i=0,n>12/gl3dview.getZoom()?n-=12/gl3dview.getZoom():n=0,{x:i/2,y:n/2}}},{shape:"line",fill:"gray",lineWidth:1,p1:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>12/gl3dview.getZoom()?i-=12/gl3dview.getZoom():i=0,n>12/gl3dview.getZoom()?n-=12/gl3dview.getZoom():n=0,{x:-i/2,y:n/2}},p2:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>12/gl3dview.getZoom()?i-=12/gl3dview.getZoom():i=0,n>12/gl3dview.getZoom()?n-=12/gl3dview.getZoom():n=0,{x:i/2,y:-n/2}}},{shape:"triangle",fill:"#927652",data:{w:90,h:90},alpha:.4},{shape:"small_triangle",position:0,lineWidth:8,lineColor:"#927652",translate:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>17/gl3dview.getZoom()?i-=17/gl3dview.getZoom():i=0,n-=11/gl3dview.getZoom(),{x:-i/2,y:-n/2}}},{shape:"small_triangle",position:1,lineWidth:8,lineColor:"#927652",translate:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>17/gl3dview.getZoom()?i-=17/gl3dview.getZoom():i=0,n-=11/gl3dview.getZoom(),{x:i/2,y:-n/2}}},{shape:"small_triangle",position:0,lineWidth:8,lineColor:"#927652",translate:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>17/gl3dview.getZoom()?i-=17/gl3dview.getZoom():i=0,n-=25/gl3dview.getZoom(),{x:-i/2,y:n/2}}},{shape:"small_triangle",position:1,lineWidth:8,lineColor:"#927652",translate:function(e){var t=e.getOriginalRect(),i=t.width,n=t.height;return i>17/gl3dview.getZoom()?i-=17/gl3dview.getZoom():i=0,n-=25/gl3dview.getZoom(),{x:i/2,y:n/2}}}]}),Block=function(){Block.superClass.constructor.apply(this,arguments),this.setClient("length",90),this.setClient("edgeIndex",-1),this.setClient("offset",.5),this.setClient("gap",0),this.setClient("angle",0),this.setClient("focus",!1),this.setStyle("vector.outline.width",2),this.setStyle("vector.outline.color","gray"),this.setStyle("vector.fill.color","white"),this.setSize(0,0),this.setClient("fullWidth",!1),this.setClient("horizontalFlip",!1),this.setImage("image_block"),this.isDoor()&&(this.blockPicture=this.blockPicture||Utils.Path+"door00_3d.png",this.blockWidth=this.blockWidth||80,this.blockHeight=this.blockHeight||200,this.blockDepth=this.blockDepth||10,this.positionY=this.positionY||0,this.setClient("depth",this.blockDepth)),this.isWindow()&&(this.blockPicture=this.blockPicture||Utils.Path+"window00_3d.png",this.blockWidth=this.blockWidth||100,this.blockHeight=this.blockHeight||120,this.blockDepth=this.blockDepth||10,this.positionY=this.positionY||(this.height-this.blockHeight)/2,this.setClient("depth",this.blockDepth));var e=this.getClient("transparent"),t=this.getClient("opacity");this.setStyle("m.transparent",e),this.setStyle("m.opacity",t),this.isCutoff()&&(this.blockWidth=this.blockWidth||100,this.blockHeight=this.blockHeight||100,this.positionY=this.positionY||(this.height-this.blockHeight)/2,this.blockPicture||(this.blockPicture=new mono.BasicMaterial({color:"green",transparent:!0,opacity:.5}))),this.setClient("height",this.blockHeight),this.setClient("positionY",this.positionY)},twaver.Util.ext("Block",twaver.Node,{onPropertyChanged:function(e){Block.superClass.onPropertyChanged.call(this,e),!this.getParent()||"C:length"!==e.property&&"C:edgeIndex"!==e.property&&"C:offset"!==e.property&&"C:gap"!==e.property||this.refresh()},refresh:function(){var e=this.getParent(),t=this.getClient("edgeIndex"),i=this.getClient("offset"),n=e.getPoints();if(n&&t>=0&&t<n.size()){var o=n.get(t),a=n.get(t===n.size()-1?0:t+1),s=a.x-o.x,r=a.y-o.y,l={x:o.x+s*i,y:o.y+r*i},d=this.getAngle(s,r),h=this.getStyle("vector.outline.width"),c=this.getClient("gap"),g=this.getClient("length")/2+h/2,m=e.getStyle("vector.outline.width")/2+h/2+c,u=twaver.Util.getRect([twaver.Util.transformPoint(l,d,-g,-m).point,twaver.Util.transformPoint(l,d,g,-m).point,twaver.Util.transformPoint(l,d,g,m).point,twaver.Util.transformPoint(l,d,-g,m).point]);this.setSize(u.width,u.height),this.setCenterLocation(l),this.setClient("angle",d),this.setClient("leftPoint",twaver.Util.transformPoint(l,d,-g,0).point),this.setClient("rightPoint",twaver.Util.transformPoint(l,d,g,0).point)}},getAngle:function(e,t){return 0===e?0===t?0:t>0?Math.PI/2:-Math.PI/2:Math.atan(t/e)},getEdgeIndex:function(){return this.getClient("edgeIndex")},isDoor:function(){return this instanceof Door},isWindow:function(){return this instanceof Window},isCutoff:function(){return this instanceof Cutoff},getBlockWidth:function(){return Math.abs(this.getClient("length"))},getBlockHeight:function(){return Math.abs(this.getClient("height"))},getBlockDepth:function(){return Math.abs(this.getClient("depth"))},getBlockPicture:function(){return this.getClient("picture")},getBlockPositionY:function(){return Math.abs(this.getClient("positionY"))}}),Door=function(){Door.superClass.constructor.apply(this,arguments),this.setClient("positionY",0)},twaver.Util.ext("Door",Block,{}),Window=function(){Window.superClass.constructor.apply(this,arguments),this.setClient("positionY",100)},twaver.Util.ext("Window",Block,{}),Cutoff=function(){Cutoff.superClass.constructor.apply(this,arguments),this.setClient("positionY",100)},twaver.Util.ext("Cutoff",Block,{}),twaver.Util.registerImage("image_block",{rotate:'<%=getClient("angle")*180/Math.PI%>',diameter:function(e){var t=10,i=e.getParent();return i&&(t=i.getStyle("vector.outline.width")+2*e.getClient("gap")),t/gl3dview.getZoom()},v:[{shape:"rect",rect:function(e){var t=e.getClient("length");t&&(t=Math.abs(t));var i=e.getParent(),n=10;i&&(n=i.getStyle("vector.outline.width")+2*e.getClient("gap"));var o=this.diameter(e);return t>o&&(t-=o),n/=gl3dview.getZoom(),[-t/2,-n/2,t,n]},lineWidth:'<%=getStyle("vector.outline.width")%>',lineColor:'<%if(getClient("focus")){return "green"}else{return getStyle("vector.outline.color")}%>',fill:'<%=getStyle("vector.fill.color")%>'},{shape:"line",x1:function(e){if(e instanceof Window||e instanceof Door){var t=e.getClient("length");t&&(t=Math.abs(t));var i=this.diameter(e);return t>i&&(t-=i),-t/2}return 0},y1:0,x2:function(e){if(e instanceof Window||e instanceof Door){var t=e.getClient("length");t&&(t=Math.abs(t));var i=this.diameter(e);return t>i&&(t-=i),t/2}return 0},y2:0,lineWidth:1,lineColor:'<%if(getClient("focus")){return "green"}else{return getStyle("vector.outline.color")}%>',lineDash:function(e){return e instanceof Window?[10,2]:void 0}},{shape:"circle",cx:function(e){var t=e.getClient("length");t&&(t=Math.abs(t));var i=this.diameter(e);return t>i&&(t-=i),-t/2},cy:0,r:function(e){if(null==gl3dview||!gl3dview.getSelectionContainer().contains(e))return 0;var t=e.getParent(),i=10;return t&&(i=t.getStyle("vector.outline.width")+2*e.getClient("gap")),i/=gl3dview.getZoom(),i/2},lineWidth:1,fill:"yellow",stroke:"black"},{shape:"circle",cx:function(e){var t=e.getClient("length");t&&(t=Math.abs(t));var i=this.diameter(e);return t>i&&(t-=i),t/2},cy:0,r:function(e){if(null==gl3dview||!gl3dview.getSelectionContainer().contains(e))return 0;var t=e.getParent(),i=10;return t&&(i=t.getStyle("vector.outline.width")+2*e.getClient("gap")),i/=gl3dview.getZoom(),i/2},lineWidth:1,fill:"yellow",stroke:"black"}]}),PipeShapeNode=function(){PipeShapeNode.superClass.constructor.apply(this,arguments),this.setClient(IMAGE_SRC,Utils.Path+"default_texture.png"),this.setStyle("vector.outline.color","red"),this.setStyle("vector.outline.width",5),this.setClient("shapenode.closed",!0),this.setClient("focusColor","blue"),this.setClient("shapenode.closed",!1),this.setClient("fill",!1),this.setClient("radius",10),this.setClient("segments",20),this.setClient("positionY",100),this.setClient("startCap","none"),this.setClient("endCap","none"),this.setClient("startCapSize","1"),this.setClient("endCapSize","1"),this.setClient("repeat",{row:100,column:3}),this.setClient("pointPositions",{}),this.setClient("adjust",!1),this.setClient("adjust.degree",10),this.setClient("transparent",!1),this.setClient("opacity",1)},twaver.Util.ext("PipeShapeNode",ImageShapeNode,{getPointPositionY:function(e){var t=this.getClient("floorHeight")||0,i=""+e,n=this.getClient("pointPositions")[i];return n?parseInt(n+t):parseInt(this.getClient("positionY")+t)},translate3d:function(e,t,i){var n=this.getClient("floorName"),o=this.getPoints(),a=this.getClient("startCap"),s=this.getClient("endCap"),r=this.getClient("startCapSize"),l=this.getClient("endCapSize"),d=this.getClient("transparent"),h=this.getClient("opacity"),c=this.getClient(CUSTOM_PROPS),g=this.getClient(PropertyConsts.LAYERID),m=new mono.Path;if(o&&o.size()>1){m.moveTo(o.get(0).x,this.getPointPositionY(0),o.get(0).y);for(var u=1;u<o.size();u++)m.lineTo(o.get(u).x,this.getPointPositionY(u),o.get(u).y)}var p=parseInt(this.getClient("radius"));m=this.adjustPath(m);var f=parseInt(this.getClient("segments")),v=e.getDataById(this.getId());v||(v=new mono.PathNode({id:this.getId()})),v.setPath(m),v.setSegments(f),v.setRadius(p),v.setSegmentsR(50),v.setStartCap(a),v.setEndCap(s),v.setStartCapSize(r),v.setEndCapSize(l);var y=""===this.getClient(IMAGE_SRC)?null:this.getClient(IMAGE_SRC),C=this.getClient("repeat");return C||(C={row:100,column:3}),v.setStyle("m.texture.image",y),v.setStyle("m.texture.wrapS",mono.RepeatWrapping),v.setStyle("m.texture.wrapT",mono.RepeatWrapping),v.setStyle("m.texture.repeat",new mono.XiangliangTwo(C.row,C.column)),v.setStyle("m.side",mono.DoubleSide),v.setStyle("m.type","phong"),v.setStyle("m.transparent",d),v.setStyle("m.opacity",h),v.setEditable(!1),v.setSelectable(!1),v.setClient("floorName",n),Utils.setElementCustomProps(this,v,c),g&&v.setClient(PropertyConsts.LAYERID,g),e.getDataById(this.getId())||e.add(v),v},adjustPath:function(e){if(this.getClient("adjust")){var t=this.getClient("adjust.degree")||10,i=parseInt(this.getClient("radius"));return mono.PathNode.prototype.adjustPath(e,i,t)}return e}}),RoundPipeShapeNode=function(){RoundPipeShapeNode.superClass.constructor.apply(this,arguments),this.setClient("adjust",!0),this.setStyle("vector.outline.color","green")},twaver.Util.ext("RoundPipeShapeNode",PipeShapeNode,{}),function(){abc={},modelnode={},modelimp={},interaction={},gadgets={},modellib={},editnodes={},DEFAULT_THUMBNAIL="crash.png",MaterialDesc=function(){this.type="phong",this.sides=mono.DoubleSide,this.repeat=null,this.tType=6,this.wraps=mono.RepeatWrapping,this.wrapt=mono.RepeatWrapping,this.transparent=!1,this.opacity=null,this.texture=[]},twaver.Util.ext("MaterialDesc",Object,{wrap3DStyle:function(e){var t={};if(this.texture=Utils.handlerTexture(this.texture),this.texture&&(t[M_MAP_SRC]=this.texture),this.type||(this.type="phong"),this.repeat)if(2!=this.repeat.length||this.repeat[0]instanceof Array){if(this.repeat instanceof Array){var i=[];for(var n in this.repeat)i.push(new mono.XiangliangTwo(this.repeat[n][0],this.repeat[n][1]));this.repeat=i}}else this.repeat=new mono.XiangliangTwo(this.repeat[0],this.repeat[1]);else this.repeat=new mono.XiangliangTwo(1,1);t[M_MAP_REPEAT]=this.repeat,this.type&&(t[M_TYPE]=this.type),this.transparent instanceof Array?t[M_TRANSPARENT]=this.transparent:void 0!=this.transparent&&(t[M_TRANSPARENT]=this.transparent),this.opacity instanceof Array?t[M_OPACITY]=this.opacity:void 0!=this.opacity?t[M_OPACITY]=this.opacity:t[M_OPACITY]=1,this.visible instanceof Array?t[M_VISIBLE]=this.visible:!1===this.visible?t[M_VISIBLE]=!1:t[M_VISIBLE]=!0,this.flipX instanceof Array?t[M_TEXTURE_FLIPX]=this.flipX:!0===this.flipX?t[M_TEXTURE_FLIPX]=!0:t[M_TEXTURE_FLIPX]=!1,this.flipY instanceof Array?t[M_TEXTURE_FLIPY]=this.flipY:!0===this.flipY?t[M_TEXTURE_FLIPY]=!0:t[M_TEXTURE_FLIPY]=!1,this.specularStrength instanceof Array?t[M_SPECULARSTRENGTH]=this.specularStrength:void 0!=this.specularStrength&&(t[M_SPECULARSTRENGTH]=this.specularStrength),this.polygonOffset instanceof Array?t[M_POLYGONOFFSET]=this.polygonOffset:!0===this.polygonOffset?t[M_POLYGONOFFSET]=!0:t[M_POLYGONOFFSET]=!1,this.polygonOffsetFactor instanceof Array?t[M_POLYGONOFFSETFACTOR]=this.polygonOffsetFactor:void 0!=this.polygonOffsetFactor&&(t[M_POLYGONOFFSETFACTOR]=this.polygonOffsetFactor),this.polygonOffsetUnits instanceof Array?t[M_POLYGONOFFSETUNITS]=this.polygonOffsetUnits:void 0!=this.polygonOffsetUnits&&(t[M_POLYGONOFFSETUNITS]=this.polygonOffsetUnits),this.envmap instanceof Array?t["m.envmap.image"]=this.envmap:void 0!=this.envmap&&(t["m.envmap.image"]=this.envmap),this.reflectRatio instanceof Array?t["m.reflectRatio"]=this.reflectRatio:void 0!=this.reflectRatio&&(t["m.reflectRatio"]=this.reflectRatio),this.normalmap instanceof Array?t["m.normalmap.image"]=this.normalmap:void 0!=this.normalmap&&(t["m.normalmap.image"]=this.normalmap),this.normalScale instanceof Array?t["m.normalScale"]=this.normalScale:void 0!=this.normalScale&&(t["m.normalScale"]=this.normalScale),this.normalType instanceof Array?t["m.normalType"]=this.normalType:void 0!=this.normalType&&(t["m.normalType"]=this.normalType),this.specularmap instanceof Array?t["m.specularmap.image"]=this.specularmap:void 0!=this.specularmap&&(t["m.specularmap.image"]=this.specularmap),this.specular instanceof Array?t["m.specular"]=this.specular:void 0!=this.specular&&(t["m.specular"]=this.specular),this.lightmap instanceof Array?t["m.lightmap.image"]=this.lightmap:void 0!=this.lightmap&&(t["m.lightmap.image"]=this.lightmap),this.type&&(t[M_TYPE]=this.type),this.ambient&&(t[M_AMBIENT]=this.ambient),t[M_SIDE]=mono.DoubleSide,this.color&&(t[M_COLOR]=this.color),e instanceof mono.Billboard||(e.setStyle(M_WRAPS,mono.RepeatWrapping),e.setStyle(M_WRAPT,mono.RepeatWrapping)),e instanceof mono.Cylinder&&(this.openTop&&e.setOpenTop(!0),this.openBottom&&e.setOpenBottom(this.openBottom)),e.s(t)}}),Cylinder_faces=["side","top","bottom"],MaterialDesc.faces=["right","left","top","bottom","front","back"],M_MAP_SRC="m.texture.image",M_MAP_REPEAT="m.texture.repeat",M_VISIBLE="m.visible",M_TRANSPARENT="m.transparent",M_COLOR="m.color",M_WRAPS="m.texture.wrapS",M_WRAPT="m.texture.wrapT",M_OPACITY="m.opacity",M_CUBE_REPEAT=[1,1],M_TYPE="m.type",M_SIDE="m.side",M_ALIGNMENT="m.alignment",M_AMBIENT="m.ambient",M_TEXTURE_FLIPX="m.texture.flipX",M_TEXTURE_FLIPY="m.texture.flipY",M_SPECULARSTRENGTH="m.specularStrength",M_POLYGONOFFSET="m.polygonOffset",M_POLYGONOFFSETFACTOR="m.polygonOffsetFactor",M_POLYGONOFFSETUNITS="m.polygonOffsetUnits",GeometryTranslater={},GeometryTranslater.get3DGeometryFromContainerImp=function(e){var t=modelManager.getContainerLib(),i=t.getValue(e,"size"),n=t.getValue(e,"pos"),o=t.getValue(e,"className");o||(o=t.getValue(e,"type"));var a=t.getValue(e,"scale"),s=t.getValue(e,"dt"),r=t.getValue(e,"repeat"),l=t.getValue(e,"types"),d=t.getValue(e,"color"),h=t.getValue(e,"transparent"),c=t.getValue(e,"opacity"),g=t.getValue(e,"visible"),m=t.getValue(e,"ambient"),u=t.getValue(e,TAG_ANIMATION),p=t.getValue(e,"animationGroup"),f=t.getValue(e,CUSTOM_PROPS),v=t.getValue(e,"flipX"),y=t.getValue(e,"flipY"),C=t.getValue(e,"specularStrength"),S=t.getValue(e,"polygonOffset"),I=t.getValue(e,"polygonOffsetFactor"),P=t.getValue(e,"polygonOffsetUnits"),A=t.getValue(e,"openTop"),E=t.getValue(e,"openBottom"),w=t.getValue(e,"object3dId"),b=t.getValue(e,"scaleValue"),x=t.getValue(e,"mainVisible"),_=t.getValue(e,OID),T=new MaterialDesc;T.type=l,T.repeat=r,T.texture=s,T.color=d,T.opacity=c,T.transparent=h,T.visible=g,T.ambient=m,T.flipX=v,T.flipY=y,T.openTop=A,T.openBottom=E,T.specularStrength=C,T.polygonOffset=S,T.polygonOffsetFactor=I,T.polygonOffsetUnits=P,T.envmap=t.getValue(e,"envmap"),T.reflectRatio=t.getValue(e,"reflectRatio"),T.normalmap=t.getValue(e,"normalmap"),T.normalScale=t.getValue(e,"normalScale"),T.normalType=t.getValue(e,"normalType"),T.specularmap=t.getValue(e,"specularmap"),T.specular=t.getValue(e,"specular"),T.lightmap=t.getValue(e,"lightmap"),s instanceof Array?T.tType=6:T.tType=1;var O=t.getValue(e,"rot"),N=GeometryTranslater.get3DOtherGeometry(e,o),L=GeometryTranslater.get3DGeometry(T,o,i,n,a,O,void 0,N);if(u&&L.setClient(TAG_ANIMATION,u),p&&L.setClient("animationGroup",p),f){var M;for(var R in f)M=f[R],L.setClient(M,t.getValue(e,M));L.setClient(CUSTOM_PROPS,f)}for(var R=0;6>R;R++){var U=t.getValue(e,"face"+R);U&&L.setClient("face"+R,U)}return w&&L.setClient("object3dId",w),b&&L.setClient("scaleValue",b),Utils.isNotNull(x)&&L.setClient("mainVisible",x),_&&L.setClient(OID,_),L},GeometryTranslater.get3DGeometry=function(e,t,i,n,o,a,s,r,l,d){t||(t="mono.Cube"),0!=t.indexOf("mono.")&&(t="mono."+t);var h=null,c=null;switch(r&&(c=r.id),c&&d&&(h=d.getDataById(c)),t){case"mono.Cube":h||(h=c?new mono.Cube({id:c}):new mono.Cube),i&&(h.setWidth(i.x),h.setHeight(i.y),h.setDepth(i.z)),r.wrapMode&&h.setWrapMode(r.wrapMode);break;case"mono.Sphere":h||(h=c?new mono.Sphere({id:c}):new mono.Sphere),i&&i.x&&h.setRadius(i.x/2);break;case"mono.Cylinder":h||(h=c?new mono.Cylinder({id:c}):new mono.Cylinder);var g=null;r&&(g=r.radialSegments),g||(g=4),i.x&&h.setRadiusTop(i.x),i.z&&h.setRadiusBottom(i.z),i.y&&h.setHeight(i.y),g&&h.setSegmentsR(g);break;case"mono.Torus":h||(h=c?new mono.Torus({id:c}):new mono.Torus),r.radius&&h.setRadius(r.radius),r.tube&&h.setTube(r.tube),r.radialSegments&&h.setSegmentsR(r.radialSegments),r.tubularSegments&&h.setSegmentsT(r.tubularSegments),r.arc&&h.setArc(r.arc);break;case"mono.Billboard":h||(h=c?new mono.Billboard(c):new mono.Billboard);var m=mono.BillboardAlignment.bottomCenter;r&&r.alignment&&(m=r.alignment),o||i&&(o={x:i.x,y:i.y,z:1}),h.setStyle(M_ALIGNMENT,m);break;case"mono.Floor":s&&(h=new mono.Floor(s));break;case"mono.PathNode":h||(h=c?new mono.PathNode({id:c}):new mono.PathNode),r&&(r.radius&&h.setRadius(parseFloat(r.radius)),r.path&&h.setPath(Utils._createPath(r.path)),r.segments&&h.setSegments(parseInt(r.segments)),r.segmentsR&&h.setSegmentsR(parseInt(r.segmentsR)),r.startCap&&h.setStartCap(r.startCap),r.endCap&&h.setEndCap(r.endCap),r.startCapSize&&h.setStartCapSize(parseFloat(r.startCapSize)),r.endCapSize&&h.setEndCapSize(parseFloat(r.endCapSize)),r.segmentsCap&&h.setSegmentsCap(parseInt(r.segmentsCap)));break;case"mono.TextNode":h||(h=c?new mono.TextNode({id:c}):new mono.TextNode),r&&(r.text&&h.setText(r.text),r.height&&h.setHeight(r.height),r.weight&&h.setWeight(r.weight),r.style&&h.setStyle(r.style),r.curveSegments&&h.setCurveSegments(r.curveSegments),r.bevelEnabled&&h.setBevelEnabled(r.bevelEnabled),r.textSize&&h.setSize(r.textSize));break;case"mono.ComboNode":var u=[];if(r.combos&&r.combos.length>1)for(var p=0;p<r.combos.length;p++){var f=r.combos[p].id,v=modelManager.getContainerNode(f);if(v){var y=ContainerFactory.getContainerFromContainerNode(modelManager.getContainerLib(),v);if(y instanceof modelimp.ContainerImp)for(var C=y.get2DObjects(),S=0;S<C.length;S++){l?C[S].setHost(l):C[S].setHost(new twaver.Node);var I=C[S].translate3d();d&&d.remove(I),u.push(I)}}}h||(h=c?new mono.ComboNode({id:c}):new mono.ComboNode),u.length>0&&(h.setCombos(u),r.operators&&h.setOperators(r.operators)),r.centralized&&Utils.setComboCentralized(h),e.texture==Utils.Path+PropertyConsts.DEFAULT_IMAGE&&(e.texture=null);break;case"mono.LatheNode":h||(h=c?new mono.LatheNode({id:c}):new mono.LatheNode),r&&(r.path&&h.setPath(Utils._createPath(r.path)),r.segmentsH&&h.setSegmentsH(r.segmentsH),r.segmentsR&&h.setSegmentsR(r.segmentsR),r.arc&&h.setArc(r.arc),void 0!==r.startClosed&&h.setStartClosed(r.startClosed),void 0!==r.endClosed&&h.setEndClosed(r.endClosed));break;case"mono.Entity":if(h||(h=c?new mono.Entity({id:c}):new mono.Entity),r){if(r.vertices&&h.setVertices(r.vertices),r.faces){var P=[];h.setFaces(P)}r.uvs&&h.setUvs(r.uvs)}break;case"mono.PointLight":h||(h=c?new mono.PointLight({id:c}):new mono.PointLight);break;case"mono.SpotLight":h||(c?(h=new mono.SpotLight({id:c}),h._id=c):h=new mono.SpotLight)}return n&&h.setPosition(n.x,n.y,n.z),a&&h.setRotation(a.x,a.y,a.z),o&&h.setScale(o.x,o.y,o.z),r&&Utils.isNotNull(r.mainVisible)&&h.setClient("mainVisible",r.mainVisible),e&&e.wrap3DStyle(h),h},GeometryTranslater.get2DGeometry=function(e,t,i){var i=getValue(this,"size"),n=getValue(this,"pos"),o=new PrimitiveNode,a=getValue(this,"ov",PropertyConsts.DEFAULT_IMAGE);i&&o.setClient("size",i);var s=getValue(this,"scale");s&&o.setClient("scale",s);var r=getValue(this,"dt");r&&o.setClient("texture",r);var l=getValue(this,"rot");l&&o.setClient("rot",l);var d=getValue(this,"scaleValue");d&&o.setClient("scaleValue",d),a&&(o.setImage(a),Utils.registerImage(Utils.Path+a)),o.setName(this.pid),n&&o.setClient("position",n),this.ishost&&(o.ishost=!0);var t=getValue(this,"className","mono.Cube");return o.setClient("className",t),o},GeometryTranslater.get3DCombination=function(e){var t,i,n,o,a=e.operations,s=e.primitives,r=1;if(s.length>=2&&a.length==s.length-1){t=s[0],n=new mono.CSG(t);for(var l=0;l<a.length;l++){i=s[r],o=new mono.CSG(i);var d=a[l];"+"==d?n=n.union(o):"-"==d&&(n=n.substract(o))}}},GeometryTranslater.copyPropertyForRoom2D=function(e,t,i){var n=t,o=e;if($cpc(o,n),o[WALL_INNER_PATH]&&n.setClient(WALL_INNER_PATH,o[WALL_INNER_PATH]),o[WALL_OUTER_PATH]&&n.setClient(WALL_OUTER_PATH,o[WALL_OUTER_PATH]),!1===i.getValue(o,WALL_CLOSED)&&n.setClient("shapenode.closed",!1),o[WALL_SIZE]){var a=o[WALL_SIZE];n.setClient(WALL_SIZE,{x:0,y:a[1],z:a[2]})}o[POLE_IMAGE_PATH]&&n.setClient(POLE_IMAGE_PATH,o[POLE_IMAGE_PATH]),!0===i.getValue(o,USE_TEXTURE)&&n.setClient(USE_TEXTURE,!0),o[OUTFRAME_IMAGE_PATH]&&n.setClient(OUTFRAME_IMAGE_PATH,o[OUTFRAME_IMAGE_PATH]),o.lightmap&&n.setClient("lightMapPic",o.lightmap)},GeometryTranslater.copyCommonPropertyFor2D=function(e,t){var i=t;if(i.setClient(GID,e[GID]),e[OID]&&i.setClient(OID,e[OID]),e[BID]&&i.setClient(BID,e[BID]),e[PRIMITIVE_NAME]&&i.setClient(PRIMITIVE_NAME,e[PRIMITIVE_NAME]),e[FLOOR_NAME]&&i.setClient(FLOOR_NAME,e[FLOOR_NAME]),e[FLOOR_HEIGHT]&&i.setClient(FLOOR_HEIGHT,e[FLOOR_HEIGHT]),e[CUSTOM_PROPS]){var n=e[CUSTOM_PROPS];for(var o in n){var a=n[o];i.setClient(a,e[a])}i.setClient(CUSTOM_PROPS,n)}e[PropertyConsts.LAYERID]&&i.setClient(PropertyConsts.LAYERID,e[PropertyConsts.LAYERID]),e[TRA_PAR]&&i.setClient(TRA_PAR,e[TRA_PAR]),e[OPA]&&i.setClient(OPA,e[OPA])},GeometryTranslater.copyPropertyForStandObject2D=function(e,t,i){var n=t,o=e;if($cpc(e,t),o[SPACE_SCALE]){var a=o[SPACE_SCALE];n.setClient(DESIGN_SCALE,100*a[0])}var s=i.getValue(o,SPACE_POSITION);s&&n.setCenterLocation(s[0],s[2]);var r=i.getValue(o,SPACE_ROTATION);r&&n.setClient(SPACE_ROTATION,r);var l=i.getValue(o,SPACE_POS_Y);l&&n.setClient(SPACE_POS_Y,l);var d=i.getValue(o,"selectable");void 0!=d&&n.setClient("selectable",d);var h=i.getValue(o,ANGLE);h&&n.setAngle(h)},GeometryTranslater.get3DOtherGeometry=function(e,t){function i(t){e.wrapMode&&(t.wrapMode=e.wrapMode)}function n(t){e.path&&(t.path=e.path),e.segments&&(t.segments=e.segments);var i=e.getValue(e,"segmentsR");i&&(t.segmentsR=i),e.startCap&&(t.startCap=e.startCap),e.endCap&&(t.endCap=e.endCap),e.startCapSize&&(t.startCapSize=e.startCapSize),e.endCapSize&&(t.endCapSize=e.endCapSize),e.segmentsCap&&(t.segmentsCap=e.segmentsCap)}function o(t){e.text&&(t.text=e.text),e.textSize&&(t.textSize=e.textSize),e.height&&(t.height=e.height),e.weight&&(t.weight=e.weight),e.style&&(t.style=e.style),e.curveSegments&&(t.curveSegments=e.curveSegments),e.bevelEnabled&&(t.bevelEnabled=e.bevelEnabled)}function a(t){e.operators&&(t.operators=e.operators),e.combos&&(t.combos=e.combos),e.centralized&&(t.centralized=e.centralized)}function s(t){e[PATH]&&(t.path=e[PATH]),e[SEGMENTSH]&&(t.segmentsH=e[SEGMENTSH]),e[SEGMENTSR]&&(t.segmentsR=e[SEGMENTSR]),e[ARC]&&(t.arc=e[ARC]),void 0!==e[START_CLOSED]&&(t.startClosed=e[START_CLOSED]),void 0!==e[END_CLOSED]&&(t.endClosed=e[END_CLOSED])}function r(t){e[VERTICES]&&(t.vertices=e[VERTICES]),e[FACES]&&(t.faces=e[FACES]),e[UVS]&&(t.uvs=e[UVS])}var l={},d=e.getValue(e,"radialSegments");d&&(l.radialSegments=d),e.radius&&(l.radius=e.radius),e.tube&&(l.tube=e.tube),e.tubularSegments&&(l.tubularSegments=e.tubularSegments),e.arc&&(l.arc=e.arc);var h=e.getValue(e,"alignment");return h&&(l.alignment=h),"mono.Cube"===t?i(l):"mono.PathNode"===t?n(l):"mono.TextNode"===t?o(l):"mono.ComboNode"===t?a(l):"mono.LatheNode"===t?s(l):"mono.Entity"===t&&r(l),l},$gt3d=GeometryTranslater.get3DGeometry,$cpfr=GeometryTranslater.copyPropertyForRoom2D,$cpc=GeometryTranslater.copyCommonPropertyFor2D,$cpfs2=GeometryTranslater.copyPropertyForStandObject2D,$gt3dog=GeometryTranslater.get3DOtherGeometry,
modellib.ContainerNode=function(){},twaver.Util.ext("modellib.ContainerNode",Object,{getID:function(){var e=this.pid;return e||(e=this.assembleid),e||(e=this.id),e},getType:function(){return this.type},getThumbnail:function(){return this.thumbnail?this.thumbnail:DEFAULT_THUMBNAIL},getOverview:function(){return this.ov?this.ov:this.getThumbnail()},getContents:function(){return this.children},getTips:function(){return this.tips?this.tips:this.id},getLabel:function(){return this.label=this.label?this.label:this.name,this.label=this.label?this.label:this.id,this.label},getTexture:function(){return this.dt?this.dt:DEFAULT_THUMBNAIL},getClassType:function(){return this.classType},getClassName:function(){return this.className}}),modellib.ContainerNode.TYPE_ASSEMBLE="assemble",modellib.ContainerNode.TYPE_PRIMITIVE="primitive",modellib.Assemble=function(e){this.id=e,this.children=[]},twaver.Util.ext("modellib.Assemble",Object,{addChild:function(e){if(e instanceof modellib.Assemble){var t={id:e.id};e.pos&&(t.pos=e.pos),e.rot&&(t.rot=e.rot),this._children.push(t)}this.children.push(e)},setHost:function(e){var t=this.findByID(e);t&&(t.ishost=!0)},findByID:function(e){return a(this.children,e)}}),modellib.ContainerLibEvent=function(){},modellib.ContainerLibEvent.LIBCONTENT_ADDED="lib.contents.added",modellib.ContainerLibEvent.LIBCONTENT_REMOVED="lib.contents.removed",modellib.ContainerLibrary=function(){this._library={},this._primitives={},this._assembles={},this._categories={},this._subTitles={},this.targetCount=3,this._contentsChangedispatcher=new twaver.EventDispatcher},twaver.Util.ext("modellib.ContainerLibrary",Object,{parsePrimitives:function(e,t,i,n){for(var o=e.length,a=0;o>a;a++){var s=new modellib.ContainerNode(modellib.ContainerNode.TYPE_PRIMITIVE),r=e[a];for(var l in r)s[l]=r[l];this.addPrimitive(s)}this.targetCount--,i&&i.call(n,t,"executed")},parseAssembles:function(e,t,i,n){for(var o=e.length,a=0;o>a;a++){var s=new modellib.ContainerNode(modellib.ContainerNode.TYPE_ASSEMBLE),r=e[a];for(var l in r)s[l]=r[l];this.addAssemble(s)}this.targetCount--,i&&i.call(n,t,"executed")},parseLib:function(e,t,i,n){this._categories=e.categories;for(var o=0;o<this._categories.length;o++){var a=this._categories[o];this._library[a.id]=a;for(var s=a.contents,r=0;r<s.length;r++){var l=s[r];this._subTitles[l.subtitle]=l}}this.targetCount--,i&&i.call(n,t,"executed")},isLoaded:function(){return 0==this.targetCount},getCategories:function(){var e=[];for(var t in this._library)e.push(this._library[t]);return e},getChildren:function(e){return this._library[e]},getContainerNode:function(e){var t=this._assembles[e];return t||(t=this._primitives[e]),t},getContainerNodeByTemplateName:function(e){var t=null;if(this._assembles)for(var i in this._assembles)this._assembles[i].templateName==e&&(t=this._assembles[i]);return t},addContainerNode:function(e){modellib.ContainerNode.TYPE_ASSEMBLE==e.getType()?this.addAssemble(e):this.addPrimitive(e)},addPrimitive:function(e){if(e&&e.id){var t=e.id;this._primitives[t]||(this._primitives[t]=e)}},addAssemble:function(e){if(e&&e.id){var t=e.id;this._assembles[t]||(this._assembles[t]=e)}},removeAccemble:function(e){if(this._accemble[e]){this._accemble[e];delete this._accemble[e]}},fireContentsChangedEvent:function(e){this._contentsChangedispatcher.fire(e)},addContentsChangedListener:function(e,t){this._contentsChangedispatcher.add(e,t)},getDefaultContainerValue:function(e,t){var i=this.getContainerNode(e);return i?i[t]:null},getValue:function(e,t,i){if(!e)return null;var n=e[t];return(void 0===n||null===n)&&(n=this.getDefaultContainerValue(e.id,t)),(void 0===n||null===n)&&3==arguments.length&&(n=arguments[2]),n},getContainerNodeContents:function(e){var t=null;if(e.getContents&&(t=e.getContents()),!t){var i=this.getContainerNode(e.id);i||(i=this.getContainerNode(e.pid)),i&&(t=i.getContents())}return t}}),modellib.ContainerManager=function(){modellib.ContainerManager.superClass.constructor.apply(this,arguments),this._modellib=new modellib.ContainerLibrary,this.init(),this.initSerializationSettings(),localStorage.getItem(LIB_PRIMITIVES)||localStorage.setItem(LIB_PRIMITIVES,"{}"),localStorage.getItem(LIB_ASSEMBLES)||localStorage.setItem(LIB_ASSEMBLES,"{}"),localStorage.getItem(LIB_GRAPH)||localStorage.setItem(LIB_GRAPH,"{}"),localStorage.getItem(LIB_COMPONENTS)||localStorage.setItem(LIB_COMPONENTS,"{}"),this.roots=[],this.assembleCache=[],this.primitivesCache=[],this.nodesMap={},this.lastAssemble=null,this.buildings=[],this.equipments=[],this.targets=[],this.pipes=[],this.floors=[],this.roomAssembles=[],this.roomPrimitives=[],this.jsonVersion=1.1},twaver.Util.ext("modellib.ContainerManager",Object,{lastAssemble:null,init:function(){this.loadResource=localStorage.getItem(LOAD_RESOURCE_TYPE)||TYPE_LOCAL,this._modellib.addContentsChangedListener(this.onLibContentsChanged,this)},initSerializationSettings:function(){mono.SerializationSettings.setClientType(MAIN_VISIBLE,"boolean"),mono.SerializationSettings.setClientType(OID,"string"),mono.SerializationSettings.setClientType(TAG_ANIMATION,"string")},getContainerLib:function(){return this._modellib},parsePrimitives:function(e){this._modellib.parsePrimitives(e),this.loadSharedPrimitive()},parseAssembles:function(e){this._modellib.parseAssembles(e),this.loadSharedAssemble(e)},parseLib:function(e){this._modellib.parseLib(e)},wrapContainerNodeIntoItem:function(e,t,i,n){var o=this.getContainerNode(t);if(o||e!=TEMPLATES||(o=this._modellib.getContainerNodeByTemplateName(i)),o){o.label=o.label||i,o.tips=o.tips||i,o.templateName=i;var a={className:this._modellib.getValue(o,"shape")||o.getClassName(),image:n?n:o.getThumbnail(),classType:o.getClassType(),actionType:this._modellib.getValue(o,"actionType"),tooltip:o.getTips(),label:o.getLabel(),dragImage:o.getOverview(),image3d:o.getTexture(),id:o.id,embeded:o.embeded,json:o.json,args:o.args,texture:o.texture,material:o.material,color:o.color,material_index:o.material_index,resize:o.resize,panel:o.panel,shape:o.shape,faces:o.faces,transparent:o.transparent,layer:o.layer,wrapMode:o.wrapMode,visible:o.visible},s=this._modellib.getValue(o,"type");s&&(a.type=s);var r=this._modellib.getValue(o,"radialSegments");return r&&(a.radialSegments=r),a}if(o=this.getSharedGraph(t)){var l=i,d=n?n:o.thumbnail;d=n?n:"crash.png";var a={className:"Graph",image:d,classType:"Graph",actionType:"loadTemplate",tooltip:l,label:l,dragImage:d,id:t};return a}return null},getContainerNode:function(e){return this._modellib.getContainerNode(e)},getCategory:function(e){return JSON.parse(localStorage.getItem(e))},getSharedComponent:function(e){var t=JSON.parse(localStorage.getItem(LIB_COMPONENTS));return t?t[e]:null},getSharedGraph:function(e){var t=JSON.parse(localStorage.getItem(LIB_GRAPH));return t?t[e]:null},getSharedAssemble:function(e){var t=this.getSharedAssembles();return t?t[e]:null},getSharedPrimitive:function(e){var t=this.getSharedPrimitives();return t?t[e]:null},getSharedComponent:function(e){var t=this.getSharedComponents();return t?t[e]:null},removeShareComponent:function(e){var t=this.getSharedComponents();if(t&&t[e]){delete t[e];var i=JSON.stringify(t);localStorage.setItem(LIB_COMPONENTS,i)}},removeShareCategory:function(e,t){var i=localStorage.getItem(LOAD_RESOURCE_TYPE);if(i===TYPE_CLOUD)this.deleteItemFromDB(t,null,this);else{if(e){var n=null,o=null;if(n=JSON.parse(localStorage.getItem(e)))for(var a=0;a<n.contents.length;a++)o=n.contents[a],o&&ContainerUtils.containsID(o.children,t)&&ContainerUtils.removeChild(o.children,t)}"Templates"===e&&this.removeShareItem(t),localStorage.setItem(e,JSON.stringify(n))}},deleteItemFromDB:function(e,t,i){var n={method:"remove",module:"templates",arguments:{id:e}};require(MONO_URL,n,t,i)},removeShareAssemble:function(e){var t=this.getSharedAssembles();if(t&&t[e]){delete t[e];var i=JSON.stringify(t);localStorage.setItem(LIB_ASSEMBLES,i)}},removeShareGraph:function(e){var t=this.getSharedGraphLibrary();if(t&&t[e]){delete t[e];var i=JSON.stringify(t);localStorage.setItem(LIB_GRAPH,i)}},removeShareItem:function(e){var t=this.getSharedAssembles();if(t&&t[e]){for(var i=t[e],n=i.children,o=this.getSharedPrimitives(),a=0;a<n.length;a++){var s=n[a].id;o[s]&&delete o[s]}var r=JSON.stringify(o);localStorage.setItem(LIB_PRIMITIVES,r),delete t[e];var l=JSON.stringify(t);localStorage.setItem(LIB_ASSEMBLES,l)}else{var d=this.getSharedGraphLibrary();if(d&&d[e]){delete d[e];var h=JSON.stringify(d);localStorage.setItem(LIB_GRAPH,h)}}},shareGraph:function(e,t,i,n,o){if(i){var a=null,s=null;if(e&&(a=this.getCategory(e),a||(a={id:e,contents:[]}),a)){for(var r=0;r<a.contents.length;r++)t==a.contents[r].subtitle&&(s=a.contents[r]);s||(s={subtitle:t,children:[]},a.contents.push(s))}var l=this.getSharedGraphLibrary();if(l){l[i.id]=i,s&&(ContainerUtils.containsID(s.children,i.id)||s.children.push({id:i.id,name:o,thumbnail:n}));var d=JSON.stringify(l);localStorage.setItem(LIB_GRAPH,d),localStorage.setItem(e,JSON.stringify(a))}}},sharePrimitive:function(e,t,i,n){if(i){var o=null,a=null;if(e&&(o=JSON.parse(localStorage.getItem(e)),o||(o={id:e,contents:[]}),o)){for(var s=0;s<o.contents.length;s++)t==o.contents[s].subtitle&&(a=o.contents[s]);a||(a={subtitle:t,children:[]},o.contents.push(a))}var r=this.getSharedPrimitives();if(r){if(i instanceof Array)for(var s=0;s<i.length;s++)r[i[s].id]=i[s],a&&(ContainerUtils.containsID(a.children,i[s].id)||a.children.push(i[s]));else r[i.id]=i,a&&(ContainerUtils.containsID(a.children,i.id)||a.children.push(i));var l=JSON.stringify(r);localStorage.setItem(LIB_PRIMITIVES,l),n&&localStorage.setItem(e,JSON.stringify(o))}}},shareAssemble:function(e,t,i,n,o){if(i){var a=null,s=null;if(e&&(a=JSON.parse(localStorage.getItem(e)),a||(a={id:e,contents:[]}),a)){for(var r=0;r<a.contents.length;r++)t==a.contents[r].subtitle&&(s=a.contents[r]);s||(s={subtitle:t,children:[]},a.contents.push(s))}var l=this.getSharedAssembles();if(l){if(i instanceof Array)for(var r=0;r<i.length;r++)l[i[r].id]=i[r],s&&i[r].templateName===n&&(ContainerUtils.containsID(s.children,i[r].id)||s.children.push({id:i[r].id,name:n,thumbnail:o}));else l[i.id]=i,s&&i.templateName===n&&(ContainerUtils.containsID(s.children,i.id)||s.children.push({id:i.id,name:n,thumbnail:o}));var d=JSON.stringify(l);localStorage.setItem(LIB_ASSEMBLES,d),localStorage.setItem(e,JSON.stringify(a))}}},getSharedPrimitives:function(){return JSON.parse(localStorage.getItem(LIB_PRIMITIVES))},getSharedAssembles:function(){return JSON.parse(localStorage.getItem(LIB_ASSEMBLES))},getSharedGraphLibrary:function(){return JSON.parse(localStorage.getItem(LIB_GRAPH))},getSharedComponents:function(){return JSON.parse(localStorage.getItem(LIB_COMPONENTS))},loadResourceFile:function(e,t){var i=document.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src","resources/"+e),t&&(i.onload=t.call(i,e,"loaded")),document.getElementsByTagName("head")[0].appendChild(i)},loadGraph:function(e,t,i,n,o){var a=new twaver.ElementBox,s=this.loadGraphto2d(a,t,o),r=this.show3D(a,e,s,i,n);return{box2d:a,box3d:r}},loadGraphto2d:function(e,t,i){var n=null,o=null;if(t){var a=t.scaleValue,s=this.parseSketch(t,!1,i);if(s instanceof Array){var r,l;e.forEach(function(e){Utils.isTargetFlag(e)?r=e:Utils.isOriginalFlag(e)&&(l=e)});for(var d=0;d<s.length;d++)if(s[d]instanceof twaver.Layer){var h=!1,c=Utils.getUnPredefinedFloorLayers(e);c.forEach(function(e){return e.getClient("floorRef")?void(h=!0):void 0}),e.getLayerBox().getDataById(s[d].getId())||Utils.getLayerByFloorName(e.getLayerBox(),s[d].getClient(FLOOR_NAME))||(h&&s[d].getClient("floorRef")&&s[d].setClient("floorRef",!1),e.getLayerBox().add(s[d]))}else s[d]instanceof TargetFlagNode?(Utils.isTargetFlag(s[d])?(r&&e.remove(r),r=s[d],n=s[d]):Utils.isOriginalFlag(s[d])&&(l&&e.remove(l),l=s[d],o=s[d]),e.add(s[d])):s[d]&&e.add(s[d])}this.scale=1/parseFloat(a),this.scale=this.scale||1;var g=this,m={};e.forEach(function(e){e instanceof PrimitiveNode&&(m[e.getId()]=e.getCenterLocation())}),e.forEach(function(e){if(e instanceof twaver.ShapeNode){if(e instanceof PipeShapeNode){var t=e.getStyle("vector.outline.width"),i=Math.abs(Math.log(g.scale));t=g.scale>1?t/Math.pow(1.5,i):t*Math.pow(1.5,i),e.setStyle("vector.outline.width",t)}var n=new twaver.List,o=e.getPoints();o.forEach(function(e){n.add({x:e.x/g.scale,y:e.y/g.scale})}),e.setPoints(n)}else if(e instanceof Window||e instanceof Door||e instanceof Cutoff){var a=e.getClient("length"),s=e.getStyle("vector.outline.width"),i=Math.abs(Math.log(g.scale));s=g.scale>1?s/Math.pow(1.5,i):s*Math.pow(1.5,i),e.setStyle("vector.outline.width",s),e.setClient("length",a/g.scale)}}),e.forEach(function(e){if(e instanceof PrimitiveNode){var t=parseFloat(1)/parseFloat(e.scaleValue||1),i=e.getHeight(),n=e.getWidth();e.setHeight(i/t),e.setWidth(n/t);var o=m[e.getId()]||e.getCenterLocation(),a={x:o.x/g.scale,y:o.y/g.scale};e.setCenterLocation(a)}})}return{targetPoint:n,originalPoint:o}},addPrimitiveInfoIntoContainerLib:function(e,t){var i=new modellib.ContainerNode(e);ContainerUtils.copyProperties(i,t),i.type="primitive",i.shape="PrimitiveContainer",this._modellib.addPrimitive(i)},addAssembleInfoIntoContainerLib:function(e,t){var i=new modellib.ContainerNode(e);ContainerUtils.copyProperties(i,t),i.type="assemble",i.shape="AssembleContainer",this._modellib.addAssemble(i)},loadSharedPrimitive:function(){var e;if(e=arguments.length>0?arguments[0]:this.getSharedPrimitives(),e instanceof Array)for(var t=0;t<e.length;t++)this.addPrimitiveInfoIntoContainerLib(modellib.ContainerNode.TYPE_PRIMITIVE,e[t]);else for(var i in e)this.addPrimitiveInfoIntoContainerLib(modellib.ContainerNode.TYPE_PRIMITIVE,e[i])},loadSharedAssemble:function(){if(arguments.length>0?assembles=arguments[0]:assembles=this.getSharedAssembles(),assembles instanceof Array)for(var e=0;e<assembles.length;e++)this.addAssembleInfoIntoContainerLib(modellib.ContainerNode.TYPE_ASSEMBLE,assembles[e]);else for(var t in assembles)this.addAssembleInfoIntoContainerLib(modellib.ContainerNode.TYPE_ASSEMBLE,assembles[t])},parseSketch:function(e,t,i){var n=e.assembles,o=e.primitives,a=e.sketch;o&&this.loadSharedPrimitive(o),n&&this.loadSharedAssemble(n);var s=this.parseCustomSketch(a,t,i);return this.wrapImageShapeNodeHost(s),s},wrapImageShapeNodeHost:function(e){var t={};if(e instanceof Array){for(var i=0;i<e.length;i++)e[i]&&e[i].getClient("primitiveName")&&e[i].setName(e[i].getClient("primitiveName")),e[i]&&e[i].getClient(OID)&&(t[e[i].getClient(OID)]=e[i].getId());for(var i=0;i<e.length;i++)if(e[i]&&e[i]instanceof ImageShapeNode){e[i].getClient(OID)&&e[i].setClient(OID,e[i].getId());var n=e[i].getClient("hostNodeId");n&&e[i].setClient("hostNodeId",t[n])}}},parseCustomSketch:function(e,t,i){var n=e.buildings,o=e.equipments,a=e.floors,s=e.pipes,r=e.layers,l=e.targets,d=[];if(r instanceof Array)for(var h=0;h<r.length;h++)d=d.concat(this.parseLayer(r[h],t));if(n instanceof Array)for(var h=0;h<n.length;h++){var c=n[h];d=d.concat(this.parseCustomBuilding(c,t))}if(o instanceof Array)for(var h=0;h<o.length;h++)d=d.concat(this.parseStandObject3D(o[h],t,i));if(a instanceof Array)for(var h=0;h<a.length;h++)d=d.concat(this.parseFloor(a[h],t));if(s instanceof Array)for(var h=0;h<s.length;h++)d=d.concat(this.parsePipes(s[h],t));if(l&&l instanceof Array)for(var h=0;h<l.length;h++)d=d.concat(this.parseTarget(l[h],t));return d},parseLayer:function(e,t){if(!t){var i=new twaver.Layer;return i.setClient(FLOOR_NAME,e[FLOOR_NAME]),i.setClient(FLOOR_HEIGHT,e[FLOOR_HEIGHT]),i.setClient(FLOOR_VISIBLE,e[FLOOR_VISIBLE]),i.setClient(FLOOR_REF,e[FLOOR_REF]),i.setClient(FLOOR_LAYER,e[FLOOR_LAYER]),[i]}},parseCustomBuilding:function(e,t){var i=[],n=this._modellib.getValue(e,IS_INNER_WALL)?new InnerWallShapeNode:new ImageShapeNode,o=e.children,a=this._modellib.getValue(e,OUTLINE_SHAPE);if(a.length%3==0){for(var s=[],r=0;r<a.length;r+=3)s.push({x:a[r],y:a[r+2]});n.setPoints(new twaver.List(s))}if($cpfr(e,n,this._modellib),o instanceof Array)for(var r=0;r<o.length;r++){var l=o[r];if(l.children)i=i.concat(this.parseCustomBuilding(l));else{var d=null,h=l.bType;d="window"===h?new Window:"door"===h?new Door:"cutoff"===h?new Cutoff:new Block;var c=l[IMAGE_SRC],g=l[SPACE_SIZE];l[SIZE_LENGTH]&&d.setClient(SIZE_LENGTH,l[SIZE_LENGTH]),l[TAG_ANIMATION]&&d.setClient(TAG_ANIMATION,l[TAG_ANIMATION]),l[SIZE_HEIGHT]&&d.setClient(SIZE_HEIGHT,l[SIZE_HEIGHT]),l[FLOOR_NAME]&&d.setClient(FLOOR_NAME,l[FLOOR_NAME]),l[FLOOR_HEIGHT]&&d.setClient(FLOOR_HEIGHT,l[FLOOR_HEIGHT]),l[SIZE_LENGTH]||l[SIZE_HEIGHT]||(g||(g=this._modellib.getValue(this.getContainerNode(l.gid),SPACE_SIZE)),g&&(d.setClient(SIZE_LENGTH,g[0]),d.setClient(SIZE_HEIGHT,g[1])));var m=l[SPACE_POS_Y];if(m)"door"!=h&&d.setClient(SPACE_POS_Y,m);else{var u=l[SPACE_POSITION];u&&"door"!=h&&d.setClient(SPACE_POS_Y,u[1])}c&&d.setClient(IMAGE_SRC,c),d.setClient(BELONG_ID,l[BELONG_ID]),d.setClient(SHAPE_TYPE,"BlockContainer"),d.setClient(GID,l.gid),d.setClient(BLOCK_OFFSET,l[BLOCK_OFFSET]),d.setClient(SPE_STR,l[SPE_STR]),d.setClient("transparent",l[TRA_PAR]),d.setClient("opacity",l[OPA]),l.envmap&&d.setClient("envmap",l.envmap),l.reflectRatio&&d.setClient("reflectRatio",l.reflectRatio),l.normalmap&&d.setClient("normalmap",l.normalmap),l.normalScale&&d.setClient("normalScale",l.normalScale),l.normalType&&d.setClient("normalType",l.normalType),l.specularmap&&d.setClient("specularmap",l.specularmap),l.specular&&d.setClient("specular",l.specular),l.lightmap&&d.setClient("lightmap",l.lightmap),this.parseCustomProps(d,l),n.addChild(d)}}if(t){var p=new mono.Serva;return n.translate3d(p,n.getChildren().toArray()),i=i.concat(p.getNodes().toArray())}var f=[n];return f=f.concat(n.getChildren().toArray())},parseStandObject3D:function(e,t,i){var n=[],o=this._modellib.getContainerNode(e.gid);if(o){var a=ContainerFactory.getContainerFromContainerNode(this._modellib,o);if(t){n=n.concat(a.get3DObjects());var s=a.hostContainer3DNode;if(s){var r=this._modellib.getValue(e,SPACE_POSITION),l=this._modellib.getValue(e,SPACE_POS_Y);r&&(l&&(r.y+=l),s.setPosition(r[0],r[1],r[2]));var d=this._modellib.getValue(e,"scale"),h=this._modellib.getValue(e,DESIGN_SCALE);d||(d=[1,1,1]),h instanceof Array&&(d=[d[0]*h[0],d[1]*h[1],d[2]*h[2]]),s.setScale(d[0],d[1],d[2]);var c=this._modellib.getValue(e,"rot");c&&s.setRotation(c[0],c[1],c[2]),s[GID]=e[GID],s[OID]=e[OID]}}else{n=n.concat(a.get2DObjects(!i));var s=a.mainNode;s||(s=n[0]),s&&($cpfs2(e,s,this._modellib),s.scaleValue=a.scaleValue)}}return n},parseFloor:function(e,t){var i=[],n=new FloorShapeNode;n[GID]=e[GID],n[OID]=e[OID];var o=this.getContainerNode(e[GID]),a=this._modellib.getValue(e,OUTLINE_SHAPE);if(a||o&&(a=this._modellib.getValue(o,OUTLINE_SHAPE)),a&&a.length%3==0){for(var s=[],r=0;r<a.length;r+=3)s.push({x:a[r],y:a[r+2]});n.setPoints(new twaver.List(s))}var l=this._modellib.getValue(e,IMAGE_SRC);l||o&&(l=this._modellib.getValue(o,"dt")),l&&(refreshGl3dview?Utils.registerImage(l,null,null,refreshGl3dview):Utils.registerImage(l),n.setClient(IMAGE_SRC,l));var d=this._modellib.getValue(e,HOST_NODE_ID);d&&n.setClient(HOST_NODE_ID,d);var h=this._modellib.getValue(e,FLOOR_NAME);h&&n.setClient(FLOOR_NAME,h);var c=this._modellib.getValue(e,FLOOR_HEIGHT);c&&n.setClient(FLOOR_HEIGHT,c);var g=this._modellib.getValue(e,"repeat");g&&n.setClient("repeat",g);var m=this._modellib.getValue(e,"size");m&&n.setClient("size",m);var u=this._modellib.getValue(e,TRA_PAR);u&&n.setClient(TRA_PAR,u);var p=this._modellib.getValue(e,OPA);if(p&&n.setClient(OPA,p),this.parseCustomProps(n,e),t){var f=new mono.Serva;return n.translate3d(f,n.getChildren().toArray()),i=i.concat(f.getNodes().toArray())}return[n]},parsePipes:function(e,t){var i=[],n=new PipeShapeNode;if(e.className&&"RoundPipeShapeNode"==e.className&&(n=new RoundPipeShapeNode),e[GID]&&(n.setClient(GID,e[GID]),n[GID]=e[GID]),e[OID]&&n.setClient(OID,e[OID]),e.repeat&&n.setClient("repeat",e.repeat),Utils.isNotNull(e.positionY)&&n.setClient("positionY",e.positionY),e[OUTLINE_SHAPE])var o=e[OUTLINE_SHAPE];var o=e[OUTLINE_SHAPE];if(o&&o.length%3==0){for(var a=[],s=0;s<o.length;s+=3)a.push({x:o[s],y:o[s+2]});n.setPoints(new twaver.List(a))}if(e[FLOOR_NAME]&&n.setClient(FLOOR_NAME,e[FLOOR_NAME]),e.startCap&&n.setClient("startCap",e.startCap),e.endCap&&n.setClient("endCap",e.endCap),e.startCapSize&&n.setClient("startCapSize",e.startCapSize),e.endCapSize&&n.setClient("endCapSize",e.endCapSize),e.radius&&n.setClient("radius",e.radius),e.segments&&n.setClient("segments",e.segments),e[IMAGE_SRC]&&n.setClient(IMAGE_SRC,e[IMAGE_SRC]),e.pointPositions&&n.setClient("pointPositions",e.pointPositions),this.parseCustomProps(n,e),t){var r=new mono.Serva;return n.translate3d(r,n.getChildren().toArray()),i=i.concat(r.getNodes().toArray())}return[n]},parseTarget:function(e){var t=new TargetFlagNode(e.type);return t.setCenterLocation(e.x,e.z),t.setClient(SPACE_POS_Y,e.y),t.setShowPoint(e.visible),[t]},parseCustomProps:function(e,t){var i=this._modellib.getValue(t,CUSTOM_PROPS);if(i){for(var n in i)e.setClient(i[n],this._modellib.getValue(t,i[n]));e.setClient(CUSTOM_PROPS,i)}var o=this._modellib.getValue(t,PropertyConsts.LAYERID);o&&e.setClient(PropertyConsts.LAYERID,o)},loadTemplate:function(e,t){var i=this;if("object"==typeof t){var n=t,o={module:"templates",method:"getData",arguments:{id:n.id}},a=function(){var t=JSON.parse(arguments[0]);if(t.error)return void alert(t.error);var n=JSON.parse(t.value);i.loadDataCheck(cloudKey,this.loadGraphto2d,[e,n]),refreshGl3dview()};require(MONO_URL,o,a,this)}else{var s=this.getSharedGraph(t);this.loadGraphto2d(e,s),refreshGl3dview()}},loadDataCheck:function(e,t,i){var n=i[1],o=this;if(n){for(var a=[],s=n.sketch.equipments,r=0;r<s.length;r++){var l=this._modellib.getContainerNode(s[r].gid);l||a.indexOf(s[r].gid)<0&&a.push(s[r].gid)}if(a.length>0){var d={module:"templates",method:"getDatas",arguments:{gids:a.join(",")}},h=function(){var e=JSON.parse(arguments[0]);if(e.error)return void alert(e.error);var n=e.value;if(n&&n.length>0)for(r in n){var a=JSON.parse(n[r].data);a.primitives||a.assembles?(o.loadSharedPrimitive(a.primitives),o.loadSharedAssemble(a.assembles)):(o.loadSharedPrimitive(a.primitivesCache),o.loadSharedAssemble(a.assembleCache))}t.apply(o,i)};require(MONO_URL,d,h,this)}else t.apply(o,i)}},loadDataFromRoom:function(e,t){var i,n,o=new twaver.ElementBox,a=this.parseSketch(e);if(a instanceof Array)for(var s=0;s<a.length;s++)a[s]instanceof twaver.Layer?o.getLayerBox().add(a[s]):a[s]instanceof TargetFlagNode?(Utils.isTargetFlag(a[s])?i=a[s]:Utils.isOriginalFlag(a[s])&&(n=a[s]),o.add(a[s])):o.add(a[s]);this.show3D(o,t,{targetPoint:i,originalPoint:n})},loadDatafromComponent:function(e,t,i){this.loadSharedPrimitive(t.primitives),this.loadSharedAssemble(t.assembles);var n={x:120,y:100},o=this._modellib.getContainerNode(i);if(o){var a=ContainerFactory.getContainerFromContainerNode(this._modellib,o);if(a instanceof modelimp.ContainerImp){var s,r=(e.getServa(),new twaver.ElementBox),l=a.get2DObjects();l[0]&&(a.mainNode?(a.mainNode.setCenterLocation(n),a.mainNode instanceof PrimitiveNode&&a.mainNode.setName(a.id),s=a.mainNode):(l[0].setCenterLocation(n),l[0]instanceof PrimitiveNode&&l[0].setName(a.id),s=l[0]),s&&(s.getX()<0&&s.setX(0),s.getY()<0&&s.setY(0)));for(var d=0;d<l.length;d++)r.add(l[d]);this.show3D(r,e)}}},show3D:function(e,t,i,n,o){t||(t=new mono.Gl3dview3D);var a=t.getServa(),s=[];if(o||(a.clear(),a.getAlarmBox().clear()),i)var r=i.targetPoint,l=i.originalPoint;var d={},h=0;a.startBatch(),e.forEach(function(e){var i=e;if(i instanceof twaver.ShapeNode){var n=i.getPoints(),o=n.size();if(o>0&&i instanceof ImageShapeNode){i.setClient("shapeNodeIndex",h++);var r=i.getChildren(),l=[];r&&r.forEach(function(e){e instanceof Block&&l.push(e)});var c=i.translate3d(a,l,t);c instanceof Array?s=s.concat(c):s.push(c)}}else i instanceof PrimitiveNode&&(d[i.getId()]=i.translate3d(a,t))}),e.forEach(function(e){var t=e;if(t.getHost){var i=t.getHost();i&&d[t.getId()].setParent(d[i.getId()])}});var c=[];for(var g in d)d[g].getParent()||c.push(d[g]);a.getRoots().forEachReverse(function(e){e instanceof mono.ComboNode&&e.getClient("entity")&&a.remove(e)});for(var m=0;m<c.length;m++){var u=c[m];if(!a.getDataById(u.getId())){var p=u.getDescendants();if(u.getClient("isEntity")){p.push(u);var f=new mono.ComboNode(p,null,!0,"entity"+u.getId());f.setPosition(u.getPosition()),f.setClient("floorName",u.getClient("floorName")),f.setClient(BID,u.getClient(BID)),f.setClient("entity",!0),a.add(f)}else a.addByDescendant(u)}}if(a.endBatch(),d=null,l&&l.isShowPoint()){s=s.concat(c);for(var g=0;g<s.length;g++){var v=s[g];if(!v.getParent()&&v instanceof mono.Entity){var y=v.getPosition();if(y){var C=l.getCenterLocation();y.x=y.x-C.x,y.y=y.y-l.getClient(SPACE_POS_Y),y.z=y.z-C.y,v.setPosition(y)}}}}if(r&&r.isShowPoint()){var S=r.getCenterLocation(),I=new mono.XiangliangThree(S.x,100,S.y);t.getGleye().look(I);for(var P=t.getInteractions(),g=0;g<P.length;g++)P[g]instanceof mono.DefaultInteraction&&(P[g].target=I)}return a},loadGraphUrl:function(e,t,i,n,o,a){var s=this;this.loadFile(t,function(t){var r=JSON.parse(t);if(r){var l=s.loadGraph(e,r,i,n);a&&a.call(o,l.box2d,l.box3d)}})},loadGraphDatas:function(e){var t=this,i=new mono.Gl3dview3D;return this.loadFile(e,function(e){var n=JSON.parse(e);n&&t.loadGraph(i,n)}),i.getServa().getDatas()},loadFile:function(e,t){if(e){var i=new XMLHttpRequest;void 0!==t&&i.addEventListener("load",function(e){t(e.target.responseText)},!1),i.open("GET",e,!0),i.send(null)}},loadComponentDatas:function(e,t){var i={};if(this.loadResource===TYPE_CLOUD){var n={module:"templates",method:"getData",arguments:{id:e}};require(MONO_URL,n,t,this)}else{var o=modelManager.getSharedComponent(e);o&&(i=o.data)}return i},loadCloudTemplateById:function(e,t,i,n,o){var a=this,s={module:"templates",method:"getData",arguments:{id:t}};loadCloud=function(){var t=JSON.parse(arguments[0]);if(t.error)return void alert(t.error);if(!t.value)return void alert("No Template with Id "+id);var s,r=JSON.parse(t.value);if(r.primitives&&r.primitives.length>0&&r.assembles&&r.assembles.length>0||r.primitivesCache&&r.assembleCache){var l=e?e.getServa():null;s=a.loadComponentTemplateFromContents(l,t.value,i,!1),o&&o.call(n,s)}else a.loadDataCheck(null,function(){var t=a.loadGraph(e,r,!0);o&&o.call(n,t)},[e,r,!0])},require(MONO_URL,s,loadCloud,this)},loadTemplateFromCloud:function(e,t,i,n){var o={module:"templates",method:"search",arguments:{name:t}},a=this,s=function(){if(1===arguments.length){var r=JSON.parse(arguments[0]);if(r.error)return void alert(r.error);if(!r.value||r.value.length<=0)return void alert(t+" dese not exist");var l=r.value[0];o={module:"templates",method:"getData",arguments:{id:l.id}},s=function(){var o=JSON.parse(arguments[0]);if(o.error)return void alert(o.error);if(!o.value)return void alert("No Template with name "+t);var s=JSON.parse(o.value);"Component"===l.type?a.loadDatafromComponent(e,s,t):a.loadDataCheck(i,a.loadGraph,[e,s,n])},require(MONO_URL,o,s,this)}};require(MONO_URL,o,s,this)},exportRoomToTemplate:function(e,t,i,n,o,a,s,r,l){var d=n;if(!d)return alert("Template name is required"),!1;if(this.loadResource===TYPE_CLOUD&&!o)return alert("Template category is required"),!1;d||(d="Your Graph");var h=this.serializeGraphInfo(e);if(h.id=Utils.generateAssembleId(),this.loadResource===TYPE_CLOUD){var c=JSON.stringify(h);if(l)g={module:"templates",method:"update",arguments:{id:a,name:n,data:c,category:o,gid:h.id,icon:t,author:s,tags:r,preview:i}};else var g={module:"templates",method:"add",arguments:{name:n,data:c,category:o,scope:0,gid:h.id,icon:t,preview:i,author:s,tag:r}};var m=function(){if(1===arguments.length){var e=JSON.parse(arguments[0]);if(e.error)return void alert(e.error);alert("Containers have been export to the cloud library.")}};require(MONO_URL,g,m,this)}else this.shareGraph(TEMPLATES,SUBTITLE_ROOM,h,t,d),alert("Containers have been export to the local library.");return h},serializeDatasInfo:function(e,t){for(var i=e.size(),n=0;i>n;n++)this.dfs2DNodes(e.get(n));for(var o={buildings:this.buildings,equipments:this.equipments,pipes:this.pipes,floors:this.floors},a={primitives:[],assembles:[],sketch:o},n=0;i>n;n++)delete e.get(n).visited;return t&&(a.scaleValue=t),this.buildings=[],this.equipments=[],this.floors=[],this.pipes=[],JSON.stringify(a)},serializeGraphInfo:function(e,t){for(var i=e.getDatas(),n=i.size(),o=0;n>o;o++)this.dfs2DNodes(i.get(o));var a=[],s=Utils.getUnPredefinedFloorLayers(e);if(s&&s.size()>0){var r=this;s.forEach(function(e){a.push(r.dfs2DLayers(e))})}var l={buildings:this.buildings,equipments:this.equipments,targets:this.targets,pipes:this.pipes,floors:this.floors,layers:a},d={primitives:[],assembles:[],sketch:l};t&&(this.handlePrimitivesInfo(),this.handleAssemblesInfo(),d={primitives:this.roomPrimitives,assembles:this.roomAssembles,sketch:l});var h=e.getClient("scaleValue");h&&(d.scaleValue=h);for(var o=0;n>o;o++)delete i.get(o).visited;return this.buildings=[],this.equipments=[],this.targets=[],this.floors=[],this.pipes=[],this.layerInfo=[],this.roomPrimitives=[],this.roomAssembles=[],d},handleAssemblesInfo:function(){for(var e,t,i=this.roomAssembles,n=0;n<i.length;n++){e=i[n],t=e.getContents();for(var o=0;o<t.length;o++){var a=t[o],s=this.getContainerNode(a.id);for(var r in a)"id"!=r&&a[r]==s[r]&&(a[r]=void 0);a.type=void 0,a.shape=void 0}e.type=void 0,e.shape=void 0}},handlePrimitivesInfo:function(){for(var e,t=this.roomPrimitives,i=0;i<t.length;i++)e=t[i],e.type=void 0,e.shape=void 0},searchTemplatesFromDB:function(e,t,i,n,o){var a={module:"templates",method:"search",arguments:{scope:t,category:o}};require(MONO_URL,a,i,n)},getPreviewById:function(e,t,i){var n=(localStorage.getItem(CLOUD_KEY),{module:"templates",method:"getPreview",arguments:{id:e}});require(MONO_URL,n,t,i,!0)},dfs2DNodes:function(e){if(!e.visited){e.visited=!0;var t,i=e.getParent();if(i)i instanceof ImageShapeNode&&(t=this.getBlockInfo(e));else if(t=this.getBasicInfo(e),e instanceof PipeShapeNode)this.wrapPipeInfo(t,e),this.pipes.push(t);else if(e instanceof FloorShapeNode)this.wrapFloorInfo(t,e),this.floors.push(t);else if(e instanceof ImageShapeNode){var n=e.getChildren().size();if(this.wrapRoomInfo(t,e),this.buildings.push(t),n>0)for(var o=e.getChildren(),a=0;n>a;a++){var s=o.get(a);t.children.push(this.dfs2DNodes(s))}}else e instanceof TargetFlagNode?(t=this.pointsFlagInfo(t,e),this.targets.push(t)):this.equipments.push(t);return e.visited=!1,t}},dfs2DLayers:function(e){var t={};return t[FLOOR_NAME]=e.getClient(FLOOR_NAME),t[FLOOR_HEIGHT]=e.getClient(FLOOR_HEIGHT),t[FLOOR_VISIBLE]=e.getClient(FLOOR_VISIBLE),t[FLOOR_REF]=e.getClient(FLOOR_REF),t[FLOOR_LAYER]=e.getClient(FLOOR_LAYER),t},getBasicInfo:function(e){var t=e.getClient(GID);t&&!s(this.roomAssembles,t)&&this.buildingAssembles(t);var i=e.getClient(OID),n=ContainerUtils.covertTo3DPosition(e),o={id:e.getId(),oid:i};o[GID]=t,o[SPACE_POSITION]=[n.x,n.y,n.z],o[SPACE_POS_Y]=e.getClient(SPACE_POS_Y),o[SPACE_ROTATION]=e.getClient(SPACE_ROTATION),o[PRIMITIVE_NAME]=e.getClient(PRIMITIVE_NAME),o[FLOOR_NAME]=e.getClient(FLOOR_NAME),o[FLOOR_HEIGHT]=e.getClient(FLOOR_HEIGHT),o[BID]=e.getClient(BID),o[ANGLE]=e.getAngle();var a=e.getClient(DESIGN_SCALE);a&&(a/=100,o[SPACE_SCALE]=[a,a,a]);var r=e.getClient("animation");r&&""!=r&&(o.animation=r);var l=e.getClient(CUSTOM_PROPS);if(l){for(var d in l){var h=l[d];o[h]=e.getClient(h)}o.customProps=l}var c=e.getClient(PropertyConsts.LAYERID);return c&&(o.layerId=c),o},pointsFlagInfo:function(e,t){e={};var i=t.getLocation();return e.x=i.x,e.y=t.getClient(SPACE_POS_Y),e.z=i.y,e.visible=t.isShowPoint(),e.type=t.getType(),e},wrapPipeInfo:function(e,t){e.dshape=this.getDShapeOfImageShapedNode(t),t instanceof RoundPipeShapeNode&&(e.className="RoundPipeShapeNode"),e.repeat=t.getClient("repeat"),e[IMAGE_SRC]=t.getClient(IMAGE_SRC),e.pointPositions=t.getClient("pointPositions"),e.startCap=t.getClient("startCap"),e.endCap=t.getClient("endCap"),e.startCapSize=t.getClient("startCapSize"),e.endCapSize=t.getClient("endCapSize"),e.radius=t.getClient("radius"),e.segments=t.getClient("segments"),e.positionY=t.getClient("positionY")},wrapFloorInfo:function(e,t){e.dshape=this.getDShapeOfImageShapedNode(t),e[IMAGE_SRC]=t.getClient(IMAGE_SRC),e.repeat=t.getClient("repeat"),e.size=t.getClient("size");
var i=t.getClient("hostNodeId");i&&""!=i&&(e.hostNodeId=i),e[TRA_PAR]=t.getClient(TRA_PAR),e[OPA]=t.getClient(OPA)},wrapRoomInfo:function(e,t){var i=modelManager.getContainerNode(e[GID]);e.dshape=this.getDShapeOfImageShapedNode(t),e.children=[];var n=t.getClient(USE_TEXTURE);!0===n?e[USE_TEXTURE]=!0:e[USE_TEXTURE]=!1;var o=t.getClient(WALL_SIZE),a=!0;if(o){var s=this._modellib.getValue(i,WALL_SIZE);s&&o.x==s.x&&o.y==s.y&&o.z==s.z&&(a=!1)}a&&(e[WALL_SIZE]=[o.x,o.y,o.z],a=!1);var r=t.getClient(WALL_CLOSED);!1===r&&(e[WALL_CLOSED]=!1),e[POLE_IMAGE_PATH]=t.getClient(POLE_IMAGE_PATH),e[OUTFRAME_IMAGE_PATH]=t.getClient(OUTFRAME_IMAGE_PATH),e[WALL_INNER_PATH]=t.getClient(WALL_INNER_PATH),e[WALL_OUTER_PATH]=t.getClient(WALL_OUTER_PATH),e[IS_INNER_WALL]=t instanceof InnerWallShapeNode;var l=t.getClient(OID);l&&""!=l&&(e[OID]=l);t.getClient(TRA_PAR),t.getClient(OPA);e[TRA_PAR]=t.getClient(TRA_PAR),e[OPA]=t.getClient(OPA),e.lightmap=t.getClient("lightMapPic")},getDShapeOfImageShapedNode:function(e){for(var t=e.getPoints(),i=[],n=t.size(),o=0;n>o;o++){var a=t.get(o);i=i.concat([a.x,0,a.y])}return i},buildingAssembles:function(e){var t=this.getContainerNode(e);if(t)if(t.children&&t.children.length>0){this.roomAssembles.push(t);for(var i=0;i<t.children.length;i++){var n=t.children[i].id;this.buildingAssembles(n)}}else if(!s(this.roomPrimitives,t.id)&&(this.roomPrimitives.push(t),"mono.ComboNode"===t.className&&t.combos))for(var o=t.combos,i=0;i<o.length;i++)this.buildingAssembles(o[i].id)},getBlockInfo:function(e){info=this.getBasicInfo(e),e instanceof Window?info[BTYPE]="window":e instanceof Door?info[BTYPE]="door":e instanceof Cutoff&&(info[BTYPE]="cutoff");this.getContainerNode(info[GID]);info[BELONG_ID]=e.getClient(BELONG_ID),info[IMAGE_SRC]=e.getClient(IMAGE_SRC);var t=e.getClient(SPACE_SIZE);return info[SPACE_POSITION][1]=e.getClient(SPACE_POS_Y),t?info[SPACE_SIZE]=[t.x,t.y,t.z]:info[SPACE_SIZE]=[e.getClient(SIZE_LENGTH),e.getClient(SIZE_HEIGHT),e.getClient(SIZE_DEPTH)],info[BLOCK_OFFSET]=e.getClient(BLOCK_OFFSET),info[SPE_STR]=e.getClient(SPE_STR),info[TRA_PAR]=e.getClient(TRA_PAR),info[OPA]=e.getClient(OPA),e.getClient("envmap")&&(info.envmap=e.getClient("envmap")),e.getClient("reflectRatio")&&(info.reflectRatio=e.getClient("reflectRatio")),e.getClient("normalmap")&&(info.normalmap=e.getClient("normalmap")),e.getClient("normalScale")&&(info.normalScale=e.getClient("normalScale")),e.getClient("normalType")&&(info.normalType=e.getClient("normalType")),e.getClient("specularmap")&&(info.specularmap=e.getClient("specularmap")),e.getClient("specular")&&(info.specular=e.getClient("specular")),e.getClient("lightmap")&&(info.lightmap=e.getClient("lightmap")),console.log(info),info},organizeComponentsDrawing:function(e){var t=(this.serializeComponentsInfo(e),{primitives:this.primitivesCache,assembles:this.assembleCache});return this.disposeComponents(e.getNodes().toArray(),e.getBillboards().toArray()),t},exportComponentToTemplate:function(e,t,i,n,o,a,s,r,l,d,h){var c=n;return c?this.loadResource!==TYPE_CLOUD||o?void this.organizeAssembles(e,c,null,t,i,o,a,s,r,l,d,h):(alert("Template category is required"),!1):(alert("Template name is required"),!1)},serializeComponentsInfo:function(e,t,i,n){for(var o=e.getNodes().toArray(),a=e.getBillboards().toArray(),s=0;s<o.length;s++){var r=o[s];r.getClient(PropertyConsts.COMPONENTFLOOR||r instanceof mono.Floor)||this.serialize3DDate(r,o,a,e)}for(var l=this.assembleCache,d=0;d<l.length;d++){var h=l[d].boundingBox;if(h){l[d].assembleSize=h.size();var c=ContainerUtils.getCenterOfBizBox(h);c={x:c.x,y:c.y,z:c.z},l[d].off=c}0!=d&&delete l[d].boundingBox}for(var s=0;s<a.length;s++)if(!a[s].visited){var g={};this.getInfoOfBillboard(g,a[s]),this.primitivesCache.push(g),this.roots.push(a[s]),this.nodesMap[a[s].getId()]=a[s]}var m=null;if(this.roots.length>1||1==this.roots.length&&0==this.assembleCache.length){var u=Utils.generateAssembleId(i);m=new modellib.Assemble(u);for(var s=0;s<this.roots.length;s++){var r=this.roots[s],p=null;p=r.assembleID?{id:r.assembleID}:{id:this.roots[s].getId()},r.oid&&(p.oid=r.oid),this.wrapAnimation(p,r),this.wrapCustomProps(p,r),m&&m.addChild(p)}var f=mono.Utils.getBizBox(this.roots,!0);m.assembleSize=f.size();var c=ContainerUtils.getCenterOfBizBox(f);c={x:c.x,y:c.y,z:c.z},m.off=c,m.ishost=!0,t&&(m.templateName=t),this.assembleCache.push(m)}else{var v=ContainerUtils.indexInArray(this.assembleCache,this.roots[0].assembleID);m=this.assembleCache[v];var u=Utils.generateAssembleId(i);this.roots[0].assembleID=u,t&&(m.templateName=t),m.id=u,m.ishost=!0}if(m&&m.children.length>0){m.scaleValue=comScaleValue,m.isEntity=n;for(var y=m.off,C=!1,s=0;s<m.children.length;s++){var p=m.children[s];p.ishost&&(C=!0)}for(var s=0;s<m.children.length;s++){var p=m.children[s];C?p.ishost&&this.setChildPosition(p,y):this.setChildPosition(p,y)}}return this.assembleCache.length>0&&delete this.assembleCache[0].boundingBox,m},setChildPosition:function(e,t){var i=e.id;i.startsWith("assemble")&&(i=i.substring("assemble".length,i.length));var n=this.nodesMap[i].getPosition();e.pos={x:n.x-t.x,y:n.y-t.y,z:n.z-t.z}},organizeAssembles:function(e,t,i,n,o,a,s,r,l,d,h,c){console.log(o);var g=this.serializeComponentsInfo(e,t,null,d);if(this.loadResource===TYPE_CLOUD){for(var m,u=0;u<this.assembleCache.length;u++)this.assembleCache[u].ishost&&(h&&c&&(this.assembleCache[u].id=c),m=this.assembleCache[u].id,d&&(this.assembleCache[u].isEntity=!0));var p={primitives:this.primitivesCache,assembles:this.assembleCache},f=JSON.stringify(p);console.log(f);var v;v=h?{module:"templates",method:"update",arguments:{id:s,name:t,data:f,category:a,method:"Component",gid:m,icon:n,author:r,tags:l,preview:o}}:{module:"templates",method:"add",arguments:{name:t,data:f,category:a,method:"Component",scope:0,gid:m,icon:n,author:r,tags:l,preview:o}};var y=function(){if(1===arguments.length){var e=JSON.parse(arguments[0]);if(e.error)return void alert(e.error);alert("Containers have been export to the cloud library.")}};require(MONO_URL,v,y,this)}else{for(var u=0;u<this.primitivesCache.length;u++)this.sharePrimitive("Private Templates","Component",this.primitivesCache[u],!1);g&&(this.shareAssemble("Private Templates","Component",g,t,n),delete g.off);for(var C=this.assembleCache,S=0;u<C.length;S++)C[S].ishost&&d&&(C[S].isEntity=!0),modelManager.shareAssemble("Private Templates","Component",C[S],t,n);alert("Containers have been export to the local library.")}console.log("primitives ext lib:\n"+localStorage.getItem(LIB_PRIMITIVES)),console.log(localStorage.getItem(LIB_PRIMITIVES).length),console.log("assemble ext lib:\n"+localStorage.getItem(LIB_ASSEMBLES)),this.disposeComponents(e.getNodes().toArray(),e.getBillboards().toArray())},loadComponentTemplateFromContents:function(e,t,i,n){var o,a=JSON.parse(t);if(a.primitives&&a.assembles||a.primitivesCache&&a.assembleCache){this.loadSharedPrimitive(a.primitives||a.primitivesCache),this.loadSharedAssemble(a.assembles||a.assembleCache);var s=this.getTemplateGID(a.assembles||a.assembleCache);s&&(o=this.create3DElementsFromContainerNode(e,s,n)),i&&o&&o.setParent(i)}return o},getTemplateGID:function(e){var t;if(e)for(var i=0;i<e.length;i++)if(e[i].ishost||e[i].templateName){t=e[i].id;break}return t},loadComponentTemplateFromURL:function(e,t,i,n,o){var a=this;this.loadFile(t,function(t){if(t){var s=a.loadComponentTemplateFromContents(e,t,i,!1);o&&o.call(n,s)}})},loadComponentTemplate:function(e,t,i,n,o){if(this.loadResource!==TYPE_CLOUD)return this.create3DElementsFromContainerNode(e,t,i);var a={module:"templates",method:"get",arguments:{id:t}},s=function(){var t=JSON.parse(arguments[0]);if(t.error)return void alert(t.error);var a=t.value;if(a){var s=JSON.parse(a.data);console.log(a.data),s.primitives||s.assembles?(this.loadSharedPrimitive(s.primitives),this.loadSharedAssemble(s.assembles)):(this.loadSharedPrimitive(s.primitivesCache),this.loadSharedAssemble(s.assembleCache));var r=this.create3DElementsFromContainerNode(e,a.gid,i,a.version);o&&o.call(n,r)}};require(MONO_URL,a,s,this)},create3DElementsFromContainerNode:function(e,t,i,n){var o,a=!i,s=this.getContainerNode(t);if(s||(s=this._modellib.getContainerNodeByTemplateName(t)),s){var r=ContainerFactory.getContainerFromContainerNode(this._modellib,s);if(r instanceof modelimp.ContainerImp){var l=r.get3DObjects(a);if(e)for(var d=parseFloat(r.scaleValue)/parseFloat(e.scaleValue||1),h=0;h<l.length;h++)Utils.scale3DElement(l[h],d),e.add(l[h]);2!=l.length||i||l[0]instanceof mono.Cube&&(l[0].setSelectable(r.mainNode.isSelectable()),l[0].setEditable(r.mainNode.isEditable()),l[0].setClient("mainVisible",!1),e.remove(r.mainNode,!0),r.mainNode=l[0]),r.mainNode?o=r.mainNode:r.rootNodes&&1==r.rootNodes.length&&(o=r.rootNodes[0])}}return o},getHostNodeAssembleSize:function(e){var t,i=this.getContainerNode(e);if(i||(i=this._modellib.getContainerNodeByTemplateName(e)),i){var n=ContainerFactory.getContainerFromContainerNode(this._modellib,i);n&&(t=n.assembleSize),n instanceof modelimp.ContainerImp&&n.mainNode&&n.mainNode.getClient("assembleSize")&&(t=n.mainNode.getClient("assembleSize"))}return t},loadTemplatesAssembleSize:function(e,t,i){if(this.loadResource!==TYPE_CLOUD)return this.getHostNodeAssembleSize(e);var n={module:"templates",method:"get",arguments:{id:e}},o=function(){var e=JSON.parse(arguments[0]);if(e.error)return void alert(e.error);var n=e.value;if(n){var o=JSON.parse(n.data);this.loadSharedPrimitive(o.primitives),this.loadSharedAssemble(o.assembles);var a=this.getHostNodeAssembleSize(n.gid);i&&i.call(t,a)}};require(MONO_URL,n,o,this)},disposeComponents:function(e,t){this.nodesMap={},this.assembleCache=[],this.primitives=[],this.primitivesCache=[],this.roots=[];for(var i=0;i<e.length;i++)delete e[i].visited,delete e[i].assembleID;for(var i=0;i<t.length;i++)delete t[i].visited},serialize3DDate:function(e,t,i,n){if(!e.visited){if(e.visited=!0,!ContainerUtils.containsInArray(t,e.getId(),"_id")&&!ContainerUtils.containsInArray(i,e.getId(),"_id"))return;e.getParent()||this.roots.push(e);var o=this.pushPrimitive(e,n);if(this.nodesMap[e.getId()]=e,e.getChildren().size()>0){var a,s=e.getChildren(),r=this.createAssembleID(e.getId()),l=ContainerUtils.indexInArray(this.assembleCache,r);a=l>=0?this.assembleCache[l]:new modellib.Assemble(r);var d={id:o.id,oid:e.getClient(OID)};this.wrapAnimation(d,e),this.wrapCustomProps(d,e),a.addChild(d),e.assembleID=a.id;var h=mono.Utils.getBizBox([e],!0);a.boundingBox=h,a.setHost(e.getId()),ContainerUtils.containsInArray(this.assembleCache,a.id)||this.assembleCache.push(a);for(var c=0;c<s._as.length;c++){var g=s._as[c];if(this.serialize3DDate(g,t,i,n),g.getChildren()._as.length<=0){var d={id:g.getId(),pos:g.getPosition(),oid:g.getClient(OID)};this.wrapAnimation(d,g),this.wrapCustomProps(d,g),a.addChild(d)}else{var m=this.createAssembleID(g.getId()),d={id:m,pos:g.getPosition(),oid:g.getClient(OID)};this.wrapAnimation(d,g),this.wrapCustomProps(d,g),a.addChild(d)}}}}},pushPrimitive:function(e,t){var i=this.getContainerInfo(e);return this.primitivesCache.push(i),i},getCommonInfo:function(e){var t={};return t.id=e.getId(),e.getScale()&&(t.scale=e.getScale()),e.getPosition()&&(t.pos=e.getPosition()),e.getRotation()&&(t.rot=e.getRotation()),e.getGroupId()&&(t.groupid=e.getGroupId()),t},getStyleInfo:function(e,t){t.styleMap[M_AMBIENT]&&(e.ambient=t.getStyle(M_AMBIENT)),t.styleMap[M_COLOR]&&(e.color=t.getStyle(M_COLOR)),t.styleMap[M_MAP_SRC]&&(e.dt=t.getStyle(M_MAP_SRC)),t.styleMap[M_TRANSPARENT]&&(e.transparent=t.getStyle(M_TRANSPARENT)),t.styleMap[M_TYPE]&&(e.types=t.getStyle(M_TYPE)),t.styleMap[M_VISIBLE]&&(e.visible=t.getStyle(M_VISIBLE)),t.styleMap[M_OPACITY]&&(e.opacity=t.getStyle(M_OPACITY)),t.styleMap[M_TEXTURE_FLIPX]&&(e.flipX=t.getStyle(M_TEXTURE_FLIPX)),t.styleMap[M_TEXTURE_FLIPY]&&(e.flipY=t.getStyle(M_TEXTURE_FLIPY)),t.styleMap[M_SPECULARSTRENGTH]&&(e.specularStrength=t.getStyle(M_SPECULARSTRENGTH)),t.styleMap[M_POLYGONOFFSET]&&(e.polygonOffset=t.getStyle(M_POLYGONOFFSET)),t.styleMap[M_POLYGONOFFSETFACTOR]&&(e.polygonOffsetFactor=t.getStyle(M_POLYGONOFFSETFACTOR)),t.styleMap[M_POLYGONOFFSETUNITS]&&(e.polygonOffsetUnits=t.getStyle(M_POLYGONOFFSETUNITS)),t.styleMap["m.envmap.image"]&&(e.envmap=t.getStyle("m.envmap.image")),t.styleMap["m.reflectRatio"]&&(e.reflectRatio=t.getStyle("m.reflectRatio")),t.styleMap["m.normalmap.image"]&&(e.normalmap=t.getStyle("m.normalmap.image")),t.styleMap["m.normalScale"]&&(e.normalScale=t.getStyle("m.normalScale")),t.styleMap["m.normalType"]&&(e.normalType=t.getStyle("m.normalType")),t.styleMap["m.specularmap.image"]&&(e.specularmap=t.getStyle("m.specularmap.image")),t.styleMap["m.specular"]&&(e.specular=t.getStyle("m.specular")),t.styleMap["m.lightmap.image"]&&(e.lightmap=t.getStyle("m.lightmap.image"));var i=t.getStyle(M_MAP_REPEAT);if(e.repeat=[],i instanceof Array)for(var n=0;n<i.length;n++)i[n]?e.repeat.push([i[n].x,i[n].y]):e.repeat.push([1,1]);else e.repeat=[i.x,i.y]},getClientInfo:function(e,t){t.getClient("object3dId")&&(e.object3dId=t.getClient("object3dId")),t.getClient("scaleValue")&&(e.scaleValue=t.getClient("scaleValue")),Utils.isNotNull(t.getClient("mainVisible"))&&(e.mainVisible=t.getClient("mainVisible")),t.getClient(OID)&&(e.oid=t.getClient(OID)),t.getClient("animationGroup")&&(e.animationGroup=t.getClient("animationGroup"))},getContainerInfo:function(e){var t=this.getCommonInfo(e);return this.getObject3DInfo(t,e),this.getStyleInfo(t,e),this.getClientInfo(t,e),t},getObject3DInfo:function(e,t){return t instanceof mono.Cube?this.getInfoOfCube(e,t):t instanceof mono.Sphere?this.getInfoOfSphere(e,t):t instanceof mono.Cylinder?this.getInfoOfCylinder(e,t):t instanceof mono.Torus?this.getInfoOfTorus(e,t):t instanceof mono.PathNode?this.getInfoOfPathNode(e,t):t instanceof mono.TextNode?this.getInfoOfTextNode(e,t):t instanceof mono.ComboNode?this.getInfoOfComboNode(e,t):t instanceof mono.LatheNode?this.getInfoOfLatheNode(e,t):t instanceof mono.Billboard?this.getInfoOfBillboard(e,t):t instanceof mono.Entity?this.getInfoOfEntity(e,t):e},getInfoOfCube:function(e,t){e.size={x:t.width,y:t.height,z:t.depth},e.className="mono.Cube";for(var i=0;6>i;i++)t.getClient("face"+i)&&(e["face"+i]=t.getClient("face"+i));var n=(t.material,t.getWrapMode());return n&&(e.wrapMode=n),e},getInfoOfSphere:function(e,t){var i=2*t.radius;e.size={x:i,y:i,z:i};t.material;return e.className="mono.Sphere",e},getInfoOfBillboard:function(e,t){return e.id=t.getId(),e.scale={x:t.getScale().x,y:t.getScale().y,z:t.getScale().z},e.className="mono.Billboard",e.dt=t.getStyle(M_MAP_SRC),e.alignment=t.getStyle(M_ALIGNMENT),e.transparent=t.getStyle(M_TRANSPARENT),e.opacity=t.getStyle(M_OPACITY),e.pos={x:t.getPosition().x,y:t.getPosition().y,z:t.getPosition().z},e[OID]=t.getClient(OID),e},getInfoOfCylinder:function(e,t){var i=t.radiusTop,n=t.radiusBottom,o=t.height;e.size={x:i,y:o,z:n};t.material;return e.className="mono.Cylinder",e.radialSegments=t.segmentsR,e.openTop=t.openTop,e.openBottom=t.openBottom,e},getInfoOfTorus:function(e,t){e[SHAPE_TYPE]="mono.Torus",e.radialSegments=t.segmentsR,e.radius=t.radius,e.tube=t.tube,e.tubularSegments=t.segmentsT,e.arc=t.arc;var i=t.radius+t.tube;return e[SPACE_SIZE]={x:i,y:i,z:i},e},getInfoOfPathNode:function(e,t){return e[SHAPE_TYPE]="mono.PathNode",e.radius=t.radius,e.path=t.getPath().toArray(),e.segments=t.segments,e.segmentsR=t.segmentsR,e.startCap=t.startCap,e.endCap=t.endCap,e.startCapSize=t.startCapSize,e.endCapSize=t.endCapSize,e.segmentsCap=t.segmentsCap,e},getInfoOfTextNode:function(e,t){return e[SHAPE_TYPE]="mono.TextNode",e.text=t.text,e.textSize=t.size,e.height=t.height,e.weight=t.weight,e.style=t.style,e.curveSegments=t.curveSegments,e.bevelEnabled=t.bevelEnabled,e},getInfoOfComboNode:function(e,t){var i=[];if(e[SHAPE_TYPE]="mono.ComboNode",e.operators=t.getOperators(),t.getCombos())for(var n=t.getCombos(),o=0;o<n.length;o++){var a=this.pushPrimitive(n[o]);i.push({id:a.id})}return e.combos=i,e.centralized=t.isCentralized(),e},getInfoOfLatheNode:function(e,t){return e[SHAPE_TYPE]="mono.LatheNode",e[PATH]=t.getPath().toArray(),e[SEGMENTSH]=t.getSegmentsH(),e[SEGMENTSR]=t.getSegmentsR(),e[ARC]=t.getArc(),e[START_CLOSED]=t.isStartClosed(),e[END_CLOSED]=t.isEndClosed(),e},getInfoOfEntity:function(e,t){return e[SHAPE_TYPE]="mono.Entity",e[VERTICES]=t.getVertices(),e[FACES]=t.getFaces(),e[UVS]=t.getUvs(),e},createAssembleID:function(e){return"assemble"+e},wrapAnimation:function(e,t){var i=t.getClient("animation");i&&""!=i&&(e.animation=i)},wrapCustomProps:function(e,t){var i=t.getClient(CUSTOM_PROPS),n=PropertyConsts.CUSTOM_PROPS,o=!1,a=!0;if(i)for(var s in i){if(!n[s]){a=!1;break}if(i[s]!=n[s]){a=!1;break}}if(a){var r;for(var l in i)t.getClient(i[l])&&(o=!0)}else o=!0;if(o&&i){var r;for(var l in i)r=i[l],e[r]=t.getClient(r);e.customProps=i}}}),ContainerUtils={};var e;ContainerUtils.setDefaultContainerManager=function(t){e=t};var t=(180/Math.PI,Math.PI/180),i=function(e){return e*t},n=function(e){return e?!0:!1};require=function(e,t,i,n,a){o(e,t,i,n,a)};var o=function(e,t,i,o,a){if(n(e)||i("error: url error, "+e),!navigator.onLine)return void alert("NETWORK CONNECT ERROR");var s=Utils.createProgressBar(40,50),r=new FormData,l=t.module;l&&(e+="/"+l);var d=t.method;d&&(e+="/"+d);var h=t.arguments;if(h)for(var c in h)r.append(c,h[c]);var g=new XMLHttpRequest;g.open("POST",e,!0),g.withCredentials=!0,g.timeout=15e4;var m;g.ontimeout=function(){s&&s.parentNode&&s.parentNode.removeChild(s),m&&m.parentNode&&m.parentNode.removeChild(m),alert("request timeout")},setTimeout(function(){if((4!=g.readyState||200!=g.status)&&!a){m=Utils.addMask("progressBars"),m.style.zIndex=1001,s.style.zIndex=1002;var e=m.offsetWidth,t=m.offsetHeight;s.style.left=e/2-20+"px",s.style.top=t/2-25+"px",document.body.appendChild(s)}},1e3);var u=function(e){i&&i.call(this.scope,e)};u.scope=o,g.onreadystatechange=function(){if(navigator.onLine||(s&&s.parentNode&&s.parentNode.removeChild(s),m&&m.parentNode&&m.parentNode.removeChild(m),alert("NETWORK CONNECT ERROR")),404==g.status&&(s&&s.parentNode&&s.parentNode.removeChild(s),m&&m.parentNode&&m.parentNode.removeChild(m)),4==g.readyState&&200==g.status){if(i){var e=JSON.parse(g.responseText);e.error?"Login First"==e.error?document.location.href="login.html":alert(e.error):i.call(o,g.responseText)}s&&s.parentNode&&s.parentNode.removeChild(s),m&&m.parentNode&&m.parentNode.removeChild(m)}},g.send(r)},a=function(e,t){for(var i=0;i<e.length;i++)if(t==e[i].id)return e[i];return null};ContainerUtils.containsInArray=function(e,t,i){return ContainerUtils.indexInArray(e,t,i)>=0?!0:!1},ContainerUtils.indexInArray=function(e,t,i){i||(i="id");for(var n=0;n<e.length;n++)if(t==e[n][i])return n;return-1};var s=function(e,t){if(e&&e instanceof Array)for(var i=0;i<e.length;i++){var n=e[i];if(n&&n.id==t)return!0}return!1};ContainerUtils.covertTo3DPosition=function(e){var t=e.getCenterLocation(),i={};i.x=t.x;var n=e.getClient("size");return n&&(i.y=n.y/2),i.z=t.y,i},ContainerUtils.isEquals=function(e,t){return e?e.x==t.x&&e.y==t.y&&e.z==t.z:t?!1:!0},ContainerUtils.containsID=function(e,t){for(var i=0;i<e.length;i++)if(t==e[i].id)return!0;return!1},ContainerUtils.removeChild=function(e,t){for(var i,n=0;n<e.length;n++)t==e[n].id&&(i=e[n]);if(i){var o=e.indexOf(i);o>-1&&e.splice(o,1)}},ContainerUtils.copyProperties=function(e,t,i){for(var n in t)n!=i&&(e[n]=t[n])},ContainerUtils.copyNeedProperties=function(e,t){for(var i in t)e[i]?e[i]!=t[i]&&(e[i]=t[i]):e[i]=t[i]},ContainerUtils.mergeBizBox=function(e,t,i){e||(e=new mono.BizBox),t||(t=new mono.BizBox);var n=(t.max.x-t.min.x)/2,o=(t.max.y-t.min.y)/2,a=(t.max.z-t.min.z)/2,s=i.x+n,r=i.y+o,l=i.z+a,d=i.x-n,h=i.y-o,c=i.z-a,g={x:e.max.x>s?e.max.x:s,y:e.max.y>r?e.max.y:r,z:e.max.z>l?e.max.z:l},m={x:e.min.x<d?e.min.x:d,y:e.min.y<h?e.min.y:h,z:e.min.z<c?e.min.z:c};return new mono.BizBox(m,g)},ContainerUtils.getCenterOfBizBox=function(e){return{x:(e.max.x+e.min.x)/2,y:(e.max.y+e.min.y)/2,z:(e.max.z+e.min.z)/2}},modelimp.ContainerImp=function(){modelimp.ContainerImp.superClass.constructor.apply(this)},twaver.Util.ext("modelimp.ContainerImp",Object,{parse:function(e){this._modelnode=e},getContents:function(){return this._contents},get3DObjects:function(){return default3DShape},get2DObjects:function(){return defautl2DShape},getValue:function(e,t,i){if(!e)return null;var n=e[t];return(void 0===n||null===n)&&3==arguments.length&&(n=arguments[2]),n}}),modelimp.AssembleContainer=function(){modelimp.AssembleContainer.superClass.constructor.apply(this),this._contents=[],this.hostContainerNode=null,this.mainNode=null,this.version},twaver.Util.ext("modelimp.AssembleContainer",modelimp.ContainerImp,{appendChild:function(e){this._contents.push(e)},get3DObjects:function(e){for(var t=[],i=0;i<this._contents.length;i++){var n=this._contents[i];this._contents[i].get3DObjects||console.log("aaaaaa");var o=this._contents[i].get3DObjects(this.version);if(e&&(this.ishost||this.templateName)){var a=this.getValue(this,"assembleSize");this.mainNode=new mono.Cube(a.x,a.y,a.z),this.mainNode.setClient("mainVisible",!1),this.mainNode.setStyle("m.transparent",!0),this.mainNode.setStyle("m.opacity",.001)}n.ishost&&(this.hostContainerNode=o[0],this.pos&&this.hostContainerNode.setPosition(this.pos.x,this.pos.y,this.pos.z)),t=t.concat(o)}if(!e&&this.mainNode&&(this.mainNode=void 0),this.hostContainerNode)for(var i=0;i<t.length;i++)this.hostContainerNode!=t[i]&&(t[i].getParent()||t[i].setParent(this.hostContainerNode));if(this.mainNode){t=t.concat(this.mainNode);for(var i=0;i<t.length;i++)this.mainNode!=t[i]&&(t[i].getParent()||t[i].setParent(this.mainNode))}this.rootNodes=[];for(var i=0;i<t.length;i++)t[i].getParent()||this.rootNodes.push(t[i]);return t},get2DObjects:function(e){for(var t=[],i=0;i<this._contents.length;i++){var n=this._contents[i],o=this._contents[i].get2DObjects();if(e&&(this.ishost||this.templateName)){var a=this.getValue(this,"assembleSize");this.mainNode=new PrimitiveNode,this.mainNode.setClient("mainVisible",!1),this.mainNode.setClient("assembleSize",a),this.mainNode.setClient("gid",this.id),this.mainNode.setSize(a.x,a.z),this.isEntity&&this.mainNode.setClient("isEntity",!0)}n.ishost&&(this.hostContainerNode=o[0]),t=t.concat(o)}if(!e&&this.mainNode&&(this.mainNode=void 0),this.hostContainerNode){var s=(this.getValue(this,"rot"),this.getValue(this,"pos"));s&&(this.hostContainerNode.setCenterLocation({x:s.x,y:s.y}),this.hostContainerNode.setClient("position",s));var r=this.getValue(this,"scaleValue");r&&this.hostContainerNode.setClient("scaleValue",r);for(var l=this.hostContainerNode.getCenterLocation(),i=0;i<t.length;i++)if(this.hostContainerNode!=t[i]){var d=t[i].getCenterLocation();t[i].getHost()||(t[i].setCenterLocation({x:l.x+d.x,y:l.y+d.y}),t[i].setHost(this.hostContainerNode),t[i].setParent(this.hostContainerNode))}}if(this.mainNode){t=t.concat(this.mainNode);for(var i=0;i<t.length;i++)this.mainNode!=t[i]&&(t[i].getParent()||(t[i].setParent(this.mainNode),t[i].setHost(this.mainNode)))}return t}}),modelimp.PrimitiveContainer=function(){modelimp.PrimitiveContainer.superClass.constructor.apply(this),this.databox=new mono.Serva},twaver.Util.ext("modelimp.PrimitiveContainer",modelimp.ContainerImp,{getContents:function(){return this._contents},get3DObjects:function(e){var t=[];if(e){var i={};for(var n in this){var o=this[n];"function"==typeof o&&o.constructor==Function||o instanceof mono.Serva||(console.log(n,":",this[n]+">>>>>>>"),i[n]=this[n])}this.databox.clear();var a=new mono.SerializationSettings;a.isServaSerializable=!1;var s=new mono.JsonSerializer(this.databox,a),r=s.serialize(),l=JSON.parse(r);l.datas.push(i),s.deserialize(JSON.stringify(l)),t.push(this.dataBox.getDataAt(0))}else t.push(GeometryTranslater.get3DGeometryFromContainerImp(this));return t},get2DObjects:function(){var e=[],t=new PrimitiveNode,i=this.getValue(this,"className","mono.Cube");t.setClient("className",i),this.setBasicInfo(t);var n={},o=this.getValue(this,"radialSegments");o&&(n.radialSegments=o),this.radius&&(n.radius=this.radius),this.tube&&(n.tube=this.tube),this.tubularSegments&&(n.tubularSegments=this.tubularSegments),this.arc&&(n.arc=this.arc);var a=this.getValue(this,"alignment");a&&(n.alignment=a);var s=this.getValue(this,"mainVisible");return Utils.isNotNull(s)&&(n.mainVisible=s),"mono.Cube"===i?this.setCubeInfo(n):"mono.PathNode"===i?this.setPathNodeInfo(n):"mono.TextNode"===i?this.setTextNodeInfo(n):"mono.ComboNode"===i?this.setComboNodeInfo(n):"mono.LatheNode"===i?this.setLatheNodeInfo(n):"mono.Cylinder"===i&&this.setCylinderInfo(n),t.setClient("other",n),e.push(t),e},setBasicInfo:function(e){var t=this.getValue(this,"selectable");e.setClient("selectable",t);var i=this.getValue(this,"editable");e.setClient("editable",i);var n=this.getValue(this,"size")||this.getValue(this,"assembleSize");n&&e.setClient("size",n);var o=this.getValue(this,"scale");o&&e.setClient("scale",o);var a=this.getValue(this,"dt");a&&e.setClient("texture",a);var s=this.getValue(this,"rot");s&&e.setClient("rot",s);var r=this.getValue(this,"scaleValue");r&&e.setClient("scaleValue",r);var l=this.getValue(this,"transparent");l&&e.setClient("transparent",l);var d=this.getValue(this,"repeat");d&&e.setClient("repeat",d);var h=this.getValue(this,"types");h&&e.setClient("types",h);var c=this.getValue(this,"ov");c&&(e.setImage(Utils.Path+c),Utils.registerImage(Utils.Path+c,null,null,function(t,i){e.setSize(t,i)}));var g=this.getValue(this,"oid");g&&e.setClient(OID,g);var m=this.getValue(this,"id");m||(m=this.pid),e.setClient(GID,m);var u=this.getValue(this,"visible");e.setClient("visible",u),e.setClient("opacity",this.getValue(this,"opacity"));var p=this.getValue(this,"pos");p&&e.setClient("position",p),this.ishost&&(e.ishost=!0);var f=this.getValue(this,"color");f&&e.setClient("colors",f),e.setClient("ambient",this.getValue(this,"ambient"));var v=this.getValue(this,TAG_ANIMATION);v&&e.setClient(TAG_ANIMATION,v);var y=this.getValue(this,"animationGroup");y&&e.setClient("animationGroup",y),e.setClient("groupid",this.getValue(this,"groupid"));var C=this.getValue(this,CUSTOM_PROPS);if(C){for(var S in C)e.setClient(C[S],this.getValue(this,C[S]));e.setClient(CUSTOM_PROPS,C)}var I=this.getValue(this,"flipX");I&&e.setClient("flipX",I);var P=this.getValue(this,"flipY");P&&e.setClient("flipY",P);var A=this.getValue(this,PropertyConsts.LAYERID);A&&e.setClient(PropertyConsts.LAYERID,A);var E=this.getValue(this,"specularStrength");E&&e.setClient("specularStrength",E);var w=this.getValue(this,"polygonOffset");Utils.isNotNull(w)&&e.setClient("polygonOffset",w);var b=this.getValue(this,"polygonOffsetFactor");b&&e.setClient("polygonOffsetFactor",b);var x=this.getValue(this,"polygonOffsetUnits");x&&e.setClient("polygonOffsetUnits",x);var _=this.getValue(this,"envmap");_&&e.setClient("envmap",_);var T=this.getValue(this,"reflectRatio");T&&e.setClient("reflectRatio",T);var O=this.getValue(this,"normalmap");O&&e.setClient("normalmap",O);var N=this.getValue(this,"normalScale");N&&e.setClient("normalScale",N);var L=this.getValue(this,"normalType");L&&e.setClient("normalType",L);var M=this.getValue(this,"specularmap");M&&e.setClient("specularmap",M);var R=this.getValue(this,"specular");R&&e.setClient("specular",R);var U=this.getValue(this,"lightmap");U&&e.setClient("lightmap",U)},setCubeInfo:function(e){this.wrapMode&&(e.wrapMode=this.wrapMode)},setPathNodeInfo:function(e){this.path&&(e.path=this.path),this.segments&&(e.segments=this.segments);var t=this.getValue(this,"segmentsR");t&&(e.segmentsR=t),this.startCap&&(e.startCap=this.startCap),this.endCap&&(e.endCap=this.endCap),this.startCapSize&&(e.startCapSize=this.startCapSize),this.endCapSize&&(e.endCapSize=this.endCapSize),this.segmentsCap&&(e.segmentsCap=this.segmentsCap)},setTextNodeInfo:function(e){this.text&&(e.text=this.text),this.textSize&&(e.textSize=this.textSize),this.height&&(e.height=this.height),this.weight&&(e.weight=this.weight),this.style&&(e.style=this.style),this.curveSegments&&(e.curveSegments=this.curveSegments),this.bevelEnabled&&(e.bevelEnabled=this.bevelEnabled)},setComboNodeInfo:function(e){this.operators&&(e.operators=this.operators),this.combos&&(e.combos=this.combos),this.centralized&&(e.centralized=this.centralized)},setLatheNodeInfo:function(e){this[PATH]&&(e.path=this[PATH]),this[SEGMENTSH]&&(e.segmentsH=this[SEGMENTSH]),this[SEGMENTSR]&&(e.segmentsR=this[SEGMENTSR]),this[ARC]&&(e.arc=this[ARC]),void 0!==this[START_CLOSED]&&(e.startClosed=this[START_CLOSED]),void 0!==this[END_CLOSED]&&(e.endClosed=this[END_CLOSED])},setCylinderInfo:function(e){Utils.isNotNull(this.openTop)&&(e.openTop=this.openTop),Utils.isNotNull(this.openBottom)&&(e.openBottom=this.openBottom)}}),modelimp.Normal=function(){modelimp.Normal.superClass.constructor.apply(this)},twaver.Util.ext("modelimp.Normal",modelimp.PrimitiveContainer,{get2DObjects:function(){var e=[],t=getValue(this,"size"),n={x:-t.x/2,y:0},o={x:t.x/2,y:0},a=getValue(this,"rot");if(a){var s=i(a.y),r=_twaver.math.createMatrix(s,0,0);n=r.transform(n),o=r.transform(o)}var l=new ImageShapeNode,d=[n,o];return l.setStyle("vector.outline.color","#333333"),t&&(l.setStyle("vector.outline.width",t.z),l.setClient("size",t)),l.setStyle("shapenode.closed",!1),l.setPoints(new twaver.List(d)),e.push(l),e}}),modelimp.FloorShapedContainer=function(){modelimp.FloorShapedContainer.superClass.constructor.apply(this)},twaver.Util.ext("modelimp.FloorShapedContainer",modelimp.PrimitiveContainer,{get3DObjects:function(){return default3DShape},get2DObjects:function(){var e=this.getValue(this,"dt"),t=this.getValue(this,OUTLINE_SHAPE),i=this.getValue(this,TRA_PAR),n=this.getValue(this,OPA),o=this.getValue(this,PropertyConsts.LAYERID);if(t.length%3==0){for(var a=[],s=0;s<t.length;s+=3)a.push({x:t[s],y:t[s+2]});var r=new FloorShapeNode;return r.setLayerId(bottomLayer.getId()),r.setPoints(new twaver.List(a)),r.setClient(SHAPE_TYPE,"FloorShapedContainer"),r.setClient(GID,this.getID()),r.setClient(TRA_PAR,i),r.setClient(OPA,n),o&&r.setClient(PropertyConsts.LAYERID,o),e&&(Utils.registerImage(Utils.Path+e),r.setClient(IMAGE_SRC,Utils.Path+e)),[r]}return null}}),modelimp.RoomContainer=function(){modelimp.RoomContainer.superClass.constructor.apply(this)},twaver.Util.ext("modelimp.RoomContainer",modelimp.FloorShapedContainer,{get3DObjects:function(){return[]},get2DObjects:function(){var e=this.getValue(this,OUTLINE_SHAPE),t=this.getValue(this,TRA_PAR),i=this.getValue(this,OPA),n=this.getValue(this,PropertyConsts.LAYERID);if(e.length%3==0){for(var o=[],a=0;a<e.length;a+=3)o.push({x:e[a],y:e[a+2]});var s=this.getValue(this,"size"),r=new ImageShapeNode;return s&&r.setClient("size",{x:s.x,y:s.y,z:s.z}),r.setPoints(new twaver.List(o)),r.setClient("className","RoomContainer"),r.setClient("gid",this.getID()),r.setClient(TRA_PAR,t),r.setClient(OPA,i),n&&r.setClient(PropertyConsts.LAYERID,n),[r]}return null}}),modelimp.BlockContainer=function(){modelimp.BlockContainer.superClass.constructor.apply(this)},twaver.Util.ext("modelimp.BlockContainer",modelimp.PrimitiveContainer,{get3DObjects:function(){return default3DShape},get2DObjects:function(){var e=this.getValue(this,"dt"),t=this.getValue(this,"dsize"),i=this.getValue(this,"pos"),n=this.getValue(this,"btype"),o=this.getValue(this,"specularStrength"),a=this.getValue(this,TRA_PAR),s=this.getValue(this,OPA),r=this.getValue(this,PropertyConsts.LAYERID),l=null;"window"==n?(l=new Window,l.setClient("depth",t.z)):"door"==n?(l=new Door,l.setClient("depth",t.z)):l="cutoff"==n?new Cutoff:new Block,l.setClient("length",t.x),l.setClient("height",t.y),o&&l.setClient("specularStrength",o),i&&l.setClient("positionY",i.y),e&&l.setClient("picture",Utils.Path+e);var d=this.getValue(this,"rot");return d&&l.setClient("angle",d.y),a&&l.setClient(TRA_PAR,a),s&&l.setClient(OPA,s),r&&l.setClient(PropertyConsts.LAYERID,r),l.setClient("className","BlockContainer"),l.setClient("gid",this.getID()),[l]}}),ContainerFactory={},ContainerFactory.models={},ContainerFactory.createContainer=function(e){var t=e;t&&t.indexOf(".")<0&&(t="modelimp."+t);var i=_twaver.newInstance(t);return i},ContainerFactory.getContainerFromContainerNode=function(e,t){if(!t)return null;var i=t.pid;i||(i=t.id);var n=ContainerFactory.models[i];return n||(n=ContainerFactory.createContainerFromContainerNode(e,t),n&&(ContainerFactory.models[i]=n)),n},ContainerFactory.createContainerFromContainerNode=function(e,t){
if(!t)return null;var i=e.getValue(t,"type"),n=e.getValue(t,"shape");if(modellib.ContainerNode.TYPE_ASSEMBLE==i){var o=null;if(n||(n="AssembleContainer"),o=ContainerFactory.createContainer(n)){o.id=t.id,o.pid=t.pid;for(var a=e.getContainerNodeContents(t),s=0;s<a.length;s++){var r=a[s],l=e.getContainerNode(r.id),d={},h=ContainerFactory.getContainerFromContainerNode(e,l);ContainerUtils.copyNeedProperties(d,h),ContainerUtils.copyNeedProperties(d,r),o.appendChild(d)}ContainerUtils.copyProperties(o,t)}return o}n||(n="PrimitiveContainer");var c=ContainerFactory.createContainer(n);return c.id=t.id,ContainerUtils.copyProperties(c,t),c}}(),TargetFlagNode=function(e){TargetFlagNode.superClass.constructor.apply(this,arguments),this.type=e||f.TARGET_POINT,this.type==f.ORIGINAL_POINT?(this.setImage("images/originalpoint.png"),this.setClient(SPACE_POS_Y,0)):(this.setImage("images/targetpoint.png"),this.setClient(SPACE_POS_Y,100)),this.showPoint=!0},twaver.Util.ext("TargetFlagNode",twaver.Follower,{isShowPoint:function(){return this.showPoint},setShowPoint:function(e){this.showPoint=e},getType:function(){return this.type}});var f={TARGET_POINT:"targetPoint",ORIGINAL_POINT:"originalPoint"};RoomInteraction=function(e){RoomInteraction.superClass.constructor.call(this,e)},twaver.Util.ext("RoomInteraction",twaver.vector.interaction.BaseInteraction,{lastIndex:-1,lastElement:null,lastLogicalPoint:null,mouseDown:null,mouseMoved:null,horizontal:null,vertical:null,block:null,addPointCursor:"url('data:image/png;base64,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'),auto",setUp:function(){this.addListener("mousedown","mousemove","mouseup","keydown","dragover","drop","dblclick")},tearDown:function(){this.removeListener("mousedown","mousemove","mouseup","keydown","dragover","drop","dblclick")},handle_dblclick:function(e){var t=-1,i=this.gl3dview.getElementAt(e);i instanceof ImageShapeNode&&(t=twaver.Util.getPointIndex(i.getPoints(),this.gl3dview.getLogicalPoint(e),this.gl3dview.getEditPointSize()));var n=new RoomDialog(i,t);n.show()},handle_mousedown:function(e){if(this.mouseDown=!0,this.lastLogicalPoint=this.gl3dview.getLogicalPoint(e),this.lastLogicalPoint){var t=this.gl3dview.getElementAt(e);if(t instanceof ImageShapeNode&&!lock2d)if(resize=this.gl3dview.getElementUI(t).isPointOnBorderLine(this.lastLogicalPoint),null!==resize)this.lastElement=t,this.gl3dview.isMovable=function(e){return!1};else{var i=t.getPointIndex(this.gl3dview.getLogicalPoint(e));i>=0&&(this.lastIndex=i,this.lastElement=t,this.gl3dview.isMovable=function(e){return!1})}t instanceof Block&&(this.block=t)}},handleClicked:function(e,t,i){i?e.fireInteractionEvent({kind:"clickElement",event:t,element:i}):e.fireInteractionEvent({kind:"clickBackground",event:t})},handle_mousemove:function(e){if(!lock2d)if(this._setGl3dviewCreateShapeNodeCursor(),this.mouseDown){var t=this.gl3dview.getLogicalPoint(e);if(!t)return this.gl3dview.getView().scrollTop+=10,void(this.gl3dview.getView().scrollLeft+=10);if(offsetX=this.lastLogicalPoint?t.x-this.lastLogicalPoint.x:0,offsetY=this.lastLogicalPoint?t.y-this.lastLogicalPoint.y:0,this.lastIndex>=0){Utils.stopPropagation(e);var i=this.lastElement.getPoints(),n=i.get(this.lastIndex),o=i.get(this.lastIndex===i.size()-1?0:this.lastIndex+1);this.gl3dview.enableSingleOrientationMove?this.mouseMoved||(this.horizontal=n.x==o.x,this.vertical=!this.horizontal,this.mouseMoved=!0):!this.mouseMoved&&_twaver.isCtrlDown(e)&&(this.horizontal=Math.abs(offsetX)>=Math.abs(offsetY),this.vertical=!this.horizontal,this.mouseMoved=!0),this.vertical||(n.x+=offsetX,o.x+=offsetX),this.horizontal||(n.y+=offsetY,o.y+=offsetY),this.lastElement.firePointsChange(),this.lastLogicalPoint=t}if(this.block){var a=this.block.getClient("edgeIndex"),s=this.block.getClient("length"),r=this.block.getClient("offset"),i=this.block.getParent().getPoints(),n=i.get(a),o=i.get(a===i.size()-1?0:a+1),l=o.x-n.x,d=o.y-n.y,h=Math.abs(l)>Math.abs(d),c=h?offsetX:offsetY,g=c;if(this.block.getClient("focusLeft"))h?l>0&&(g=-g):(l>=0&&0>d&&(c=-c),l>=0&&d>0&&(g=-g),0>l&&d>0&&(c=-c,g=-g)),this.block.setClient("length",s-c),this.block.setClient("offset",r-g/Math.abs(h?l:d)/2);else if(this.block.getClient("focusRight"))h?0>l&&(g=-g):(l>=0&&0>d&&(c=-c,g=-g),0>l&&d>0&&(c=-c),0>l&&0>d&&(g=-g)),this.block.setClient("length",s+c),this.block.setClient("offset",r+g/Math.abs(h?l:d)/2);else{var r=Math.abs(l)>Math.abs(d)?(t.x-this.lastLogicalPoint.x)/l:(t.y-this.lastLogicalPoint.y)/d;this.block.setClient("offset",this.block.getClient("offset")+r)}this.lastLogicalPoint=t}null!==resize&&this.lastElement&&(0===resize?(this.lastElement.setLocation(this.lastElement.getX()+offsetX,this.lastElement.getY()+offsetY),this.lastElement.setSize(this.lastElement.getWidth()-offsetX,this.lastElement.getHeight()-offsetY)):1===resize?(this.lastElement.setLocation(this.lastElement.getX(),this.lastElement.getY()+offsetY),this.lastElement.setSize(this.lastElement.getWidth()+offsetX,this.lastElement.getHeight()-offsetY)):2===resize?this.lastElement.setSize(this.lastElement.getWidth()+offsetX,this.lastElement.getHeight()+offsetY):3===resize&&(this.lastElement.setLocation(this.lastElement.getX()+offsetX,this.lastElement.getY()),this.lastElement.setSize(this.lastElement.getWidth()-offsetX,this.lastElement.getHeight()+offsetY)),this.lastLogicalPoint=t)}else{var m=this.gl3dview.getElementAt(e),t=this.gl3dview.getLogicalPoint(e);if(this.lastElement&&this.lastElement!==m&&(this.lastElement instanceof ImageShapeNode&&(this.lastElement.setClient("focusIndex",-1),this.gl3dview.getView().style.cursor="default"),this.lastElement instanceof Block&&(this.lastElement.setClient("focus",!1),this.lastElement.setClient("focusLeft",!1),this.lastElement.setClient("focusRight",!1),this.gl3dview.getView().style.cursor="default"),this.lastElement=null),m instanceof ImageShapeNode)if(resize=this.gl3dview.getElementUI(m).isPointOnBorderLine(t),null!==resize)this.lastElement=m,this.gl3dview.getView().style.cursor="move";else{var a=m.getPointIndex(t);m.setClient("focusIndex",a),a>=0?(this.lastElement=m,_twaver.isAltDown(e)?this.gl3dview.getView().style.cursor=this.addPointCursor:this.gl3dview.getView().style.cursor="move"):m.isPointOnPoints(t)||(this.gl3dview.getView().style.cursor="default")}else m instanceof Block?(m.setClient("focus",!0),this.gl3dview.getSelectionContainer().contains(m)&&_twaver.math.getDistance(t,m.getClient("leftPoint"))<=10?(m.setClient("focusLeft",!0),m.setClient("focusRight",!1),this.gl3dview.getView().style.cursor="move"):this.gl3dview.getSelectionContainer().contains(m)&&_twaver.math.getDistance(t,m.getClient("rightPoint"))<=10?(m.setClient("focusLeft",!1),m.setClient("focusRight",!0),this.gl3dview.getView().style.cursor="move"):(m.setClient("focusLeft",!1),m.setClient("focusRight",!1),this.gl3dview.getView().style.cursor="default"),this.lastElement=m):this.lastElement=null}},handle_mouseup:function(e){this.mouseDown=!1,this.mouseMoved=!1,this.horizontal=!1,this.vertical=!1,this.lastIndex=-1,this.lastElement=null,this.lastLogicalPoint=null,this.block=null,this.resize=!1,this.gl3dview.getView().style.cursor="default",lock2d||delete this.gl3dview.isMovable},handle_mousewheel:function(e){if(!lock2d){this.gl3dview.getSelectionContainer().size()>0&&(e.preventDefault(),e.stopPropagation());var t=!1,i=this;e.wheelDelta!==e.wheelDeltaX&&(e.wheelDelta?e.wheelDelta>0&&(t=!0):e.detail<0&&(t=!0)),this.gl3dview.getSelectionContainer().toSelection(function(e){e instanceof PrimitiveNode&&i._scaleElement(t,e)})}},handle_keydown:function(e){if(!lock2d){var t=!1;if(46==e.keyCode){if(this.gl3dview.getSelectionContainer().getSelection().size()>0){var i=this.gl3dview.getSelectionContainer().getSelection();if(1==i.size()&&this.gl3dview.getSelectionContainer().getLastData()instanceof TargetFlagNode)return;if(confirm("Sure to Delete")){var n=this.gl3dview.getElementBox(),o=new twaver.List;o.addAll(i),o.forEach(function(e){e instanceof TargetFlagNode||n.remove(e)})}}t=!0}37==e.keyCode&&(this._moveSelectionElements("left"),t=!0),38==e.keyCode&&(this._moveSelectionElements("top"),t=!0),39==e.keyCode&&(this._moveSelectionElements("right"),t=!0),40==e.keyCode&&(this._moveSelectionElements("bottom"),t=!0),Utils.isCtrlDown(e)&&(67===e.keyCode&&(this._copySelection(),t=!0),86===e.keyCode&&(this._pasteSelection(),t=!0)),83===e.keyCode&&this._adsorptionSelectionElements(),t&&(e.preventDefault(),e.stopPropagation())}},handle_dragover:function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,e.dataTransfer.dropEffect="copy";var t=this.gl3dview.getElementAt(e),i=this.gl3dview.getLogicalPoint(e);if(this.gl3dview.lastElement&&this.gl3dview.lastElement!==t&&(this.gl3dview.lastElement instanceof ImageShapeNode&&this.gl3dview.lastElement.setClient("focusIndex",-1),this.gl3dview.lastElement=null),t instanceof ImageShapeNode){var n=t.getPointIndex(i);t.setClient("focusIndex",n),n>=0&&(this.gl3dview.lastElement=t)}else this.gl3dview.lastElement=null;return!1},getAllElementsAt:function(e){var t={x:e.x-1,y:e.y-1,width:2,height:2},i=this.gl3dview.getElementsAtRect(t,!0,null,!1);return i},findFirstFloorAt:function(e){var t=this.getAllElementsAt(e);if(t)for(var i=0;i<t.size();i++)if(t.get(i)instanceof FloorShapeNode)return t.get(i)},handle_drop:function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault?e.preventDefault():e.returnValue=!1;var t=e.dataTransfer.getData("Text");if(!t)return!1;var i=JSON.parse(t);loadResource===TYPE_CLOUD&&i.isTemplate&&(i.loadFromCloud=!0,"Component"!=i.method&&(i.actionType="loadTemplate"));var n=this.gl3dview.getElementAt(e);if(i.actionType)"loadTemplate"===i.actionType?i.loadFromCloud?(modelManager.loadTemplate(this.gl3dview.getElementBox(),i),roomTemplateId=i.id):modelManager.loadTemplate(this.gl3dview.getElementBox(),i.id):(type="ImageShapeNode","CreateFloorShapeNode"===i.actionType?type="FloorShapeNode":"CreateInnerWallShapeNode"===i.actionType?type="InnerWallShapeNode":"CreatePipeShapeNode"===i.actionType?type="PipeShapeNode":"CreateRoundPipeShapeNode"===i.actionType?type="RoundPipeShapeNode":"CreateRoomWithFloorShapeNode"===i.actionType&&(type=function(t){var i=new ImageShapeNode;return i instanceof twaver.ShapeNode&&t&&(i.setPoints(t),i.setClient("isHostNode",!0),i.setClient("decimalNumber",decimalNumber),i.setClient("transparent",!1),i.setClient("opacity",1),i.setClient(PropertyConsts.LAYERID,PropertyConsts.Layer.WALL),2==t._as.length&&(alert("Please draw more than two points!"),i.removeAt(0),i.removeAt(1),gl3dview.fireInteractionEvent({kind:"removePoint",event:e,element:this.shapeNode}))),i}),classType=window[type]?window[type]:type,this._createShapeNodeInteractions(classType));else if(n&&n instanceof ImageShapeNode)if(!i.embeded||n instanceof FloorShapeNode)if("FloorShapedContainer"!=i.className||n.getClient(OID)){var o=i.mtarget;if(o){if("Floor"===o){var a=this.gl3dview.getLogicalPoint2(e),s=this.findFirstFloorAt(a);if(s&&i.material){var r=Utils.Path+i.material;Utils.registerImage(r,this.gl3dview),s.setClient(IMAGE_SRC,r)}}"Room"===o&&n instanceof ImageShapeNode&&this.handleRoomMaterial(n,i)}else i.embeded||this._createRoom(this.gl3dview,e,i)}else{var l=this._createElement(this.gl3dview,n.getCenterLocation(),i.id);l.setClient("hostNodeId",n.getId()),n.setClient(OID,n.getId())}else{var a=this.gl3dview.getLogicalPoint(e);n.setClient("focusIndex",-1);var d=n.getPointIndex(a);if(d>=0){var h=n.getPoints(),c=h.get(d),g=h.get(d===h.size()-1?0:d+1),m=g.x-c.x,u=g.y-c.y,p=Math.abs(m)>Math.abs(u)?(a.x-c.x)/m:(a.y-c.y)/u;this._createPureElement(this.gl3dview,i,function(e){e.setClient("edgeIndex",d),e.setParent(n),e.setClient("offset",p);var t=parseFloat("1m")/parseFloat(gl3dview._scaleUnitValue),i=e.getClient("length"),o=e.getStyle("vector.outline.width"),a=Math.abs(Math.log(t));o=t>1?o/Math.pow(1.5,a):o*Math.pow(1.5,a),e.setClient("length",i*t)})}}else{if("BlockContainer"==i.className&&i.embeded)return!1;var o=i.mtarget;n||"Room"!==o?this._createRoom(this.gl3dview,e,i):this.handleRoomMaterial(null,i)}return this._setGl3dviewCreateShapeNodeCursor(),!1},handleRoomMaterial:function(e,t){var i=!1;if(box2d.forEach(function(e){var t=e;return t instanceof ImageShapeNode&&!(t instanceof FloorShapeNode)?(i=!0,!1):void 0}),i){var n="Change Room Material",o=[];if(e||(n="Change All Room Material",o=[{label:"Scope:",id:"cfloor",name:"scope",type:"radio",checked:!0,inner:"For current floor's images"},{label:"",id:"afloor",name:"scope",type:"radio",checked:!1,inner:"For all floors' images"}]),t.texture)var a=[{label:"Image:",id:"pic",value:Utils.Path+t.material},{label:"Usage:",id:"outside",name:"side",type:"radio",checked:!0,inner:"For all external faces (incudes all frame and pole faces)"},{label:"",id:"inside",name:"side",type:"radio",checked:!1,inner:"For all internal faces"}];else var a=[{label:"External Image:",id:"external",value:Utils.Path+t.outside},{label:"Internal Image:",id:"internal",value:Utils.Path+t.inside},{label:"Frame Image:",id:"frame",value:Utils.Path+t.frame}];a=o.concat(a),Utils.showInputDialog(a,n,!0,this.setRoomMaterial,this,[e,t.texture])}},setRoomMaterial:function(e,t,i){var n=[];if(e?n.push(e):box2d.forEach(function(e){var t=e;t instanceof ImageShapeNode&&!(t instanceof FloorShapeNode)&&(i.cfloor?t.getClient("floorName")===floorPane.getCurrentFloorName()&&n.push(t):n.push(t))}),n.length>0)for(var o=0;o<n.length;o++){var a=n[o];t?(i.outside?(a.setClient("wallOuterPic",i.pic),a.setClient("framePic",i.pic),a.setClient("poleTexture",i.pic)):a.setClient("wallInnerPic",i.pic),a.setClient("useTexture",!0)):(a.setClient("wallOuterPic",i.external),a.setClient("wallInnerPic",i.internal),a.setClient("framePic",i.frame),a.setClient("poleTexture",i.external),a.setClient("useTexture",!1));var s=a instanceof InnerWallShapeNode;s&&(a.setClient("poleTexture",a.getClient("wallInnerPic")),a.setClient("wallOuterPic",a.getClient("wallInnerPic")))}},_createShapeNodeInteractions:function(e){this.gl3dview.setInteractions([new MyCreateShapeNodeInteraction(this.gl3dview,e),new twaver.vector.interaction.DefaultInteraction(this.gl3dview)])},_createPureElement:function(e,t,i){var n=t.id;a=modelManager.getContainerNode(n);var o=modelManager.getContainerLib();if(a){var s=ContainerFactory.getContainerFromContainerNode(o,a);if(s instanceof modelimp.ContainerImp)for(var r=s.get2DObjects(),l=e.getElementBox(),d=0;d<r.length;d++)l.add(r[d]),e.getSelectionContainer().clearSelection(),e.getSelectionContainer().setSelection(r[d]),i&&i(r[d])}},_createRoom:function(e,t,i){if("squareRoomWithFloor"===i.id){var n=this._createElement(e,e.getLogicalPoint(t),"floor02"),o=this._createElement(e,e.getLogicalPoint(t),"squareRoom");n.setClient("hostNodeId",o.getId()),o.setClient(OID,o.getId()),o.setClient("decimalNumber",decimalNumber)}else if("LShapedRoomWithFloor"===i.id){var n=this._createElement(e,e.getLogicalPoint(t),"floor03"),o=this._createElement(e,e.getLogicalPoint(t),"LShapedRoom");n.setClient("hostNodeId",o.getId()),o.setClient(OID,o.getId()),o.setClient("decimalNumber",decimalNumber)}else if("SquareAddOnRoomWithFloor"===i.id){var n=this._createElement(e,e.getLogicalPoint(t),"floor04"),o=this._createElement(e,e.getLogicalPoint(t),"SquareAddOnRoom");n.setClient("hostNodeId",o.getId()),o.setClient(OID,o.getId()),o.setClient("decimalNumber",decimalNumber)}else if("AngledAddOnRoomWithFloor"===i.id){var n=this._createElement(e,e.getLogicalPoint(t),"floor05"),o=this._createElement(e,e.getLogicalPoint(t),"AngledAddOnRoom");n.setClient("hostNodeId",o.getId()),o.setClient(OID,o.getId()),o.setClient("decimalNumber",decimalNumber)}else if("RoomByPoints"===i.id){var a=new RoomByPointsDialog(i,e,t);a.show()}else if(i.loadFromCloud)if(_twaver.isShiftDown(t))Utils.showTemplateDialog(this,e,t,i);else var s=function(e){processHost(e,t)},r=this._createElement(e,e.getLogicalPoint(t),i,s);else if(_twaver.isShiftDown(t))Utils.showTemplateDialog(this,e,t,i.id);else{var r=this._createElement(e,e.getLogicalPoint(t),i.id);if(processHost(r,t),!i.id)return;i.id.indexOf("billboard")>=0?r.setStyle("m.vertical",!0):i.id.indexOf("pointlight")>=0?"pointlight01"==i.id?(r.setClient("lightColor",new mono.Color(16777215)),r.setClient("lightIntensity",1)):"pointlight02"==i.id&&(r.setClient("lightColor",new mono.Color(16773335)),r.setClient("lightIntensity",1)):i.id.indexOf("spotlight")>=0&&"spotlight01"==i.id&&(r.setClient("lightColor",new mono.Color(14146559)),r.setClient("lightIntensity",1),r.setClient("angle",Math.PI))}},_createElement:function(e,t,i,n,o,a){if("object"!=typeof i)return this._createElementDeal(e,t,i,n);var s=i,r={module:"templates",method:"get",arguments:{id:s.id}},l=function(){var i=JSON.parse(arguments[0]);if(i.error)return void alert(i.error);var s=i.value;if(s){var r=JSON.parse(s.data);if(r)return r.primitives||r.assembles?(modelManager.loadSharedPrimitive(r.primitives),modelManager.loadSharedAssemble(r.assembles)):(modelManager.loadSharedPrimitive(r.primitivesCache),modelManager.loadSharedAssemble(r.assembleCache)),this._createElementDeal(e,t,s.gid,n,o,a)}};require(MONO_URL,r,l,this)},_createElementDeal:function(e,t,i,n,o,a){var s=modelManager.getContainerLib(),r=modelManager.getContainerNode(i);if(r||(r=s.getContainerNodeByTemplateName(i)),r){var l=ContainerFactory.getContainerFromContainerNode(s,r);if(l instanceof modelimp.ContainerImp){var d,h=l.get2DObjects(!0),c=e.getElementBox();h[0]&&(l.mainNode?(l.mainNode instanceof PrimitiveNode&&l.mainNode.setName(l.templateName||l.id),d=l.mainNode,d.setClient(PropertyConsts.LAYERID,PropertyConsts.Layer.TEMPLATE)):(h[0]instanceof PrimitiveNode&&(h[0].setName(l.templateName),h[0].getClient(PropertyConsts.LAYERID)||h[0].setClient(PropertyConsts.LAYERID,PropertyConsts.Layer.TEMPLATE)),d=h[0]));for(var g=parseFloat(l.scaleValue||1),m=0;m<h.length;m++)c.add(h[m]),e.getSelectionContainer().clearSelection(),e.getSelectionContainer().setSelection(h[m]);l.mainNode&&(e.getSelectionContainer().clearSelection(),e.getSelectionContainer().setSelection(l.mainNode)),"mono.Billboard"==r.className&&h[0].setStyle("m.vertical",!0);var u=l.mainNode;u||(u=h[0]),u.scaleValue=r.scaleValue;var g=parseFloat(u.scaleValue||1),p=u.getHeight(),f=u.getWidth();return u.setHeight(p*g),u.setWidth(f*g),u.setCenterLocation(t),n&&n(u,o,a),u}}},_setGl3dviewCreateShapeNodeCursor:function(){var e=this;this.gl3dview.getInteractions().forEach(function(t){t instanceof twaver.vector.interaction.CreateShapeNodeInteraction&&(e.gl3dview.getView().style.cursor="crosshair")})},_scaleElement:function(e,t){if(t&&t instanceof PrimitiveNode&&this.gl3dview.isSelected(t)){var i=t.getSize(),n=t.getClient("oscale"),o=t.getCenterLocation();if(e&&1e3>n){var a=Math.round(1.1*n),s=1.1*i.width,r=1.1*i.height;a>1e3&&(a=1e3,s=i.width*(1e3/n),r=i.height*(1e3/n)),t.setSize(s,r),t.setClient("oscale",a)}else if(!e&&n>5){var a=Math.round(n/1.1),s=i.width/1.1,r=i.height/1.1;5>a&&(a=5,s=i.width*(5/n),r=i.height*(5/n)),t.setSize(s,r),t.setClient("oscale",a)}t.setName(Utils.changeTwoDecimal(t.getClient("oscale"))+"%\nScroll to Scale"),t.setCenterLocation(o)}},_adsorptionSelectionElements:function(){var e=box2d.getSelectionContainer().getSelection(),t=parseInt(localStorage.getItem(SNAPGRID))||10;e.size()>0&&e.forEach(function(e){var i=e.getPoints();i.forEach(function(e){e.x=parseInt(e.x/t)*t+(e.x%t<t/2?0:t),e.y=parseInt(e.y/t)*t+(e.y%t<t/2?0:t)}),e.setPoints(i)})},_moveSelectionElements:function(e){var t=box2d.getSelectionContainer().getSelection();if(t.size()>0){var i=0,n=0;"left"===e&&(i=-1),"right"===e&&(i=1),"top"===e&&(n=-1),"bottom"===e&&(n=1),twaver.Util.moveElements(t,i,n,!1)}},_copySelection:function(){var e=box2d.getSelectionContainer().getSelection(),t=e.toList();e.forEach(function(i){box2d.forEach(function(n){!e.contains(n)&&n.isDescendantOf(i)&&t.add(n),n.getClient("hostNodeId")&&i.getClient("oid")&&n.getClient("hostNodeId")===i.getClient("oid")&&t.add(n)})}),Utils.copyDatasToBoxAnchor(t,box2d)},_pasteSelection:function(){var e=floorPane.getCurrentFloorName(),t=Utils.pasteBoxAnchorToBox(box2d,e);if(t&&t.length>0){box2d.getSelectionContainer().clearSelection();for(var i in t)t[i]instanceof Block||t[i]instanceof FloorShapeNode&&t[i].getClient("hostNodeId")||(box2d.getSelectionContainer().appendSelection(t[i]),t[i].setX(t[i].getX()+20),t[i].setY(t[i].getY()+20))}}}),MonoEditInteraction=function(e,t){MonoEditInteraction.superClass.constructor.call(this,e)},twaver.Util.ext("MonoEditInteraction",twaver.vector.interaction.EditInteraction,{deletePointCursor:"url('data:image/png;base64,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'),auto",setUp:function(){MonoEditInteraction.superClass.setUp.apply(this,arguments),this.addListener("keydown","keyup")},tearDown:function(){MonoEditInteraction.superClass.setUp.apply(this,arguments),this.removeListener("keydown","keyup")},handle_keydown:function(e){this.currentKeyEvent=e,this.showSnap=!0},handle_keyup:function(e){this.currentKeyEvent=null,this.showSnap=!1},handle_mouseup:function(e){if(this.isStart){var t=_twaver.clone(this._endLogical);if(this.resizingRect)if(this.lazyMode)if(this.gl3dview.isResizeAnimate()){var i=this,n=new twaver.animate.AnimateBounds(this.node,this.resizingRect,function(){i.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:e,element:i.node,resizeDirection:i.resizeDirection})});twaver.animate.AnimateManager.start(n)}else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"lazyResizeEnd",event:e,element:this.node,resizeDirection:this.resizeDirection});else this.node.setLocation(this.resizingRect.x,this.resizingRect.y),this.node.setSize(this.resizingRect.width,this.resizingRect.height),this.gl3dview.fireInteractionEvent({kind:"liveResizeEnd",event:e,element:this.node,resizeDirection:this.resizeDirection});else if(this.shapeNode&&this.pointIndex>=0&&t){var o=this.shapeNode.getPoints().get(this.pointIndex);if(this.horizontal&&(t.y=o.y),this.vertical&&(t.x=o.x),this.currentKeyEvent&&83===this.currentKeyEvent.keyCode){var a=parseInt(localStorage.getItem(SNAPGRID))||10;t.x=parseInt(t.x/a)*a+(t.x%a<a/2?0:a),t.y=parseInt(t.y/a)*a+(t.y%a<a/2?0:a)}this.shapeNode.setPoint(this.pointIndex,t),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:e,element:this.shapeNode,pointIndex:this.pointIndex})}else if(this.shapeLink&&this.pointIndex>=0&&t){var o=this.shapeLink.getPoints().get(this.pointIndex);this.horizontal&&(t.y=o.y),this.vertical&&(t.x=o.x),this.shapeLink.setPoint(this.pointIndex,t),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:e,element:this.shapeLink,pointIndex:this.pointIndex})}else this.linkUI&&t&&(this.linkUI.setControlPoint(t),this.gl3dview.fireInteractionEvent({kind:"liveMovePointEnd",event:e,element:this.linkUI._element}))}this._handle_mouseup(e),this.clear()},_isEditingShapeNode:function(e,t){if(this.node instanceof twaver.ShapeNode){this.shapeNode=this.node;for(var i=this.shapeNode.getPoints(),n=0,o=i.size();o>n;n++){var a=i.get(n);if(this._contains(e,a,this.editPointSize))return _twaver.isAltDown(t)?this._setCursor(this.deletePointCursor):this._setCrossCursor(),this.pointIndex=n,!0}if(null!=this.shapeNode.getPointIndex(e)&&this.shapeNode.getPointIndex(e)>=0)return!0}return this.pointIndex=-1,!1},handle_mousemove:function(e){if(this.gl3dview.isValidEvent(e)){if(this.isStartRotate&&this.node)return this._handleRotateElement(e,this.node),void(this.gl3dview.isShowRotateScale()&&this.repaint());if(this.isStart){if(this.shapeNode&&this.pointIndex>=0){this._handleMovingShapeNodePoint(e);var t={},i=parseInt(localStorage.getItem(SNAPGRID))||10;if(this.currentKeyEvent&&83===this.currentKeyEvent.keyCode){var n=this.shapeNode.getPoints().get(this.pointIndex);t.x=parseInt(n.x/i)*i+(n.x%i<i/2?0:i),t.y=parseInt(n.y/i)*i+(n.y%i<i/2?0:i),(t.x!=n.x||t.y!=n.y)&&this.repaint()}return}if(this.shapeLink&&this.pointIndex>=0)return void this._handleMovingShapeLinkPoint(e);
if(this.node&&this.resizeDirection)return void this._handleResizing(e);if(this.linkUI)return void this._handleMovingLinkControlPoint(e);var n=this.gl3dview.getLogicalPoint2(e);if(this.node&&this.node instanceof twaver.ShapeNode&&this.node.getPointIndex(n)&&this.node.getPointIndex(n)>=0)return void(this.gl3dview._dragToPan=!1)}else{var o=this.gl3dview.getElementAt(e);if(this.gl3dview.isSelectingElement()||this.gl3dview.isMovingElement()||0===this.gl3dview.getSelectionContainer().size())return void this.clear();var a=this.gl3dview.getElementUI(o);if(!a||!a.getEditAttachment())return void this.clear();var n=this.gl3dview.getLogicalPoint2(e);if(o instanceof twaver.ShapeNode&&(n=this.gl3dview.getLogicalPoint(e)),o instanceof twaver.Node){if(this.node=o,this.node instanceof Block)return this.gl3dview._dragToPan=!1,void(this.isStart=!0);if(this._isEditingShapeNode(n,e)||this._isResizingNode(n))return void this.gl3dview.setEditingElement(!0);if(this._isRotatingElement(n))return this.gl3dview.setRotatingElement(!0),void this.gl3dview.setEditingElement(!0)}else if(o instanceof twaver.ShapeLink){if(this.shapeLink=o,this._isEditingShapeLink(n))return void this.gl3dview.setEditingElement(!0)}else if(a instanceof twaver.gl3dview.LinkUI&&twaver.Link.isOrthogonalLink(a._element)){this.linkUI=a;var s=this.linkUI.getControlPoint();return void(s&&this._contains(n,s)&&(this._setCrossCursor(),this.gl3dview.setEditingElement(!0)))}this.clear()}}},handle_mousedown:function(e){if(0===e.button)if(!_twaver.isAltDown(e)||this.gl3dview.isEditingElement()){if(this.gl3dview.isEditingElement()&&!this.isStart&&!this.isStartRotate)if(this.node&&this.resizeDirection)this.isStart=!0,this._handle_mousedown(e),this.gl3dview.fireInteractionEvent({kind:this.lazyMode?"lazyResizeStart":"liveResizeStart",event:e,element:this.node,resizeDirection:this.resizeDirection});else if(this.shapeNode&&this.pointIndex>=0){var t=this.shapeNode.getPoints()._as.length;_twaver.isAltDown(e)?2==t?confirm("You will delete the entire wall, Sure to Delete")&&(this.shapeNode.removeAt(0),this.shapeNode.removeAt(1),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:e,element:this.shapeNode})):confirm("Sure to Delete")&&(3==t&&this.shapeNode.setClient("shapenode.closed",!1),this.shapeNode.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:e,element:this.shapeNode})):(this.isStart=!0,this._handle_mousedown(e),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:e,element:this.shapeNode,pointIndex:this.pointIndex}))}else this.shapeLink&&this.pointIndex>=0?_twaver.isAltDown(e)?(this.shapeLink.removeAt(this.pointIndex),this.gl3dview.fireInteractionEvent({kind:"removePoint",event:e,element:this.shapeLink})):(this.isStart=!0,this._handle_mousedown(e),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:e,element:this.shapeLink,pointIndex:this.pointIndex})):this.linkUI?(this.isStart=!0,this._handle_mousedown(e),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:e,element:this.linkUI._element})):this.shapeNode?this.isStart=!0:this.node&&(this.node.getClient("className")&&"mono.Billboard"==this.node.getClient("className")||(this.isStartRotate=!0,this._handle_mousedown(e)))}else{var i=this.gl3dview.getElementAt(e),n=this.gl3dview.getLogicalPoint(e);if(i instanceof twaver.ShapeNode){var o=this.getPointIndex(i.getPoints(),n,!0);o>0&&(this._handle_mousedown(e),this.pointIndex=o,this.shapeNode=i,i.addPoint(n,o),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:e,element:i,pointIndex:o}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:e,element:i,pointIndex:o}))}if(i instanceof twaver.ShapeLink){var a=new twaver.List(i.getPoints()),s=this.gl3dview.getElementUI(i);a.add(s.getFromPoint(),0),a.add(s.getToPoint());var o=this.getPointIndex(a,n)-1;o>0&&(this._handle_mousedown(e),this.pointIndex=o,this.shapeLink=i,i.addPoint(n,o),this._setCrossCursor(),this.gl3dview.setEditingElement(!0),this.isStart=!0,this.gl3dview.fireInteractionEvent({kind:"addPoint",event:e,element:i,pointIndex:o}),this.gl3dview.fireInteractionEvent({kind:"liveMovePointStart",event:e,element:i,pointIndex:o}))}}},paint:function(e){if(MonoEditInteraction.superClass.paint.apply(this,arguments),this.shapeNode){var t=10,i=new twaver.List,n={},o=this.shapeNode.getPoints().size(),a=this;if(snapGrid=parseInt(localStorage.getItem(SNAPGRID))||10,this.shapeNode&&this.pointIndex>=0&&this.showSnap){var s=this.shapeNode.getPoints(),r=s.get(this.pointIndex);if(!r)return;n.x=parseInt(r.x/snapGrid)*snapGrid+(r.x%snapGrid<snapGrid/2?0:snapGrid),n.y=parseInt(r.y/snapGrid)*snapGrid+(r.y%snapGrid<snapGrid/2?0:snapGrid);var l=this.pointIndex+1>=o?this.pointIndex+1-o:this.pointIndex+1,d=this.pointIndex-1<0?this.pointIndex-1+o:this.pointIndex-1;if(n.x&&n.y){this.img=new Image,i.add(s.get(l)),i.add(n),i.add(s.get(d));var h="("+n.x+","+n.y+")",c=_twaver.math.getRect(i),g=this.shapeNode.getClient("coordTextFont"),l=(i.get(0),n),d=i.get(1),m=_twaver.g.getTextSize(g,h);_twaver.math.grow(c,3*t+Math.max(m.width,m.height),3*t+Math.max(m.width,m.height));var u=e;u.fillStyle="rgb(0,100,0)",u.strokeStyle="#000000",u.beginPath(),u.arc(n.x,n.y,t,0,2*Math.PI),u.fill(),u.stroke(),u.closePath(),u.strokeStyle="rgb(0,100,0)";var p=new twaver.List(["moveto","lineto","lineto"]);u.beginPath(),_twaver.g.drawLinePoints(u,i,[5,5],p),u.stroke(),u.closePath(),u.fillStyle="rgba(0,100,0,0.5)",u.fillRect(n.x+t,n.y-m.height/2,m.width,m.height),u.font=g,u.fillStyle="#FFFFFF",u.textBaseline="middle",u.fillText(h,n.x+t,n.y),u.strokeStyle="rgb(0,100,0)",this.img.src="data:image/png;base64,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",this.img.onload=function(){u.drawImage(a.img,n.x-3*t,n.y-3*t,2*t,2*t)}}}}},clear:function(){MonoEditInteraction.superClass.clear.apply(this,arguments),this.gl3dview._dragToPan=!0,this.gl3dview.setRotatePointSize(twaver.Defaults.NETWORK_ROTATE_POINT_SIZE)}}),mono.AniUtil={},mono.AniUtil.Easing=TTTTT.Easing,mono.AniUtil.DefaultEasing=mono.AniUtil.Easing.Linear.None,mono.AniUtil.AllEasings={"Linear.None":mono.AniUtil.Easing.Linear.None,"Quadratic.In":mono.AniUtil.Easing.Quadratic.In,"Quadratic.Out":mono.AniUtil.Easing.Quadratic.Out,"Quadratic.InOut":mono.AniUtil.Easing.Quadratic.InOut,"Cubic.In":mono.AniUtil.Easing.Cubic.In,"Cubic.Out":mono.AniUtil.Easing.Cubic.Out,"Cubic.InOut":mono.AniUtil.Easing.Cubic.InOut,"Quartic.In":mono.AniUtil.Easing.Quartic.In,"Quartic.Out":mono.AniUtil.Easing.Quartic.Out,"Quartic.InOut":mono.AniUtil.Easing.Quartic.InOut,"Quintic.In":mono.AniUtil.Easing.Quintic.In,"Quintic.Out":mono.AniUtil.Easing.Quintic.Out,"Quintic.InOut":mono.AniUtil.Easing.Quintic.InOut,"Sinusoidal.In":mono.AniUtil.Easing.Sinusoidal.In,"Sinusoidal.Out":mono.AniUtil.Easing.Sinusoidal.Out,"Sinusoidal.InOut":mono.AniUtil.Easing.Sinusoidal.InOut,"Exponential.In":mono.AniUtil.Easing.Exponential.In,"Exponential.Out":mono.AniUtil.Easing.Exponential.Out,"Exponential.InOut":mono.AniUtil.Easing.Exponential.InOut,"Circular.In":mono.AniUtil.Easing.Circular.In,"Circular.Out":mono.AniUtil.Easing.Circular.Out,"Circular.InOut":mono.AniUtil.Easing.Circular.InOut,"Elastic.In":mono.AniUtil.Easing.Elastic.In,"Elastic.Out":mono.AniUtil.Easing.Elastic.Out,"Elastic.InOut":mono.AniUtil.Easing.Elastic.InOut,"Back.In":mono.AniUtil.Easing.Back.In,"Back.Out":mono.AniUtil.Easing.Back.Out,"Back.InOut":mono.AniUtil.Easing.Back.InOut,"Bounce.In":mono.AniUtil.Easing.Bounce.In,"Bounce.Out":mono.AniUtil.Easing.Bounce.Out,"Bounce.InOut":mono.AniUtil.Easing.Bounce.InOut},mono.AniUtil.AllEasingNames=[];for(name in mono.AniUtil.AllEasings)mono.AniUtil.AllEasingNames.push(name);mono.AniUtil.getAllActions=function(){return["","rotation","move","scale"]},mono.AniUtil.getAllAnchors=function(){return["","left","right","top","bottom","front","back","center-x","center-y","center-z"]},mono.AniUtil.getAllValues=function(e){return[.1,.2,.3,.4,.5,.6,.7,.8,.9,1,1.25,1.5,1.75,2,30,60,90,120,150,180,210,240,270,300,330,360,-30,-60,-90,-120,-150,-180,-210,-240,-270,-300,-330,-360]},mono.AniUtil.oldAnimationTypes=["LeftMove","RightMove","FrontMove","BackMove","LeftRotationClockwise90","LeftRotationAnticlockwise90","LeftRotationClockwise120","LeftRotationAnticlockwise120","CenterRotationClockwise270","CenterRotationAnticlockwise270"],mono.AniUtil.animate=function(e){requestAnimationFrame(mono.AniUtil.animate),TTTTT.update(e)},mono.AniUtil.animate(),mono.AniUtil.createAxisByName=function(e){var t=new mono.XiangliangThree(0,1,0);return"y"===e&&(t=new mono.XiangliangThree(0,1,0)),"x"===e&&(t=new mono.XiangliangThree(1,0,0)),"z"===e&&(t=new mono.XiangliangThree(0,0,1)),t},mono.AniUtil.createAnchorPosition=function(e,t){var i=e.getBizBox(),n=i.size(),o=0,a=0,s=0;return"center"===t.substring(0,6)||("left"===t?o=-n.x/2:"right"===t?o=n.x/2:"front"===t?s=n.z/2:"back"===t?s=-n.z/2:"top"===t?a=n.y/2:"bottom"===t&&(a=-n.y/2)),new mono.XiangliangThree(o,a,s)},mono.AniUtil.playRotate=function(e,t,i,n,o,a,s,r){var l=mono.AniUtil.createAxisByName(t),d=mono.AniUtil.createAnchorPosition(e,i);if(!e.__tween){var h=0,c=e.__animated?n:-n;return e.__tweenLastRotation=h,e.__tweenDestRotation=c,e.__animated=!e.__animated,o=o||1e3,a=a||0,s=s||mono.AniUtil.DefaultEasing,e.__tween=new TTTTT.Tween({v:h}).to({v:c},o).easing(s).delay(a).onUpdate(function(){e.rotateFromAxis(l,d,this.v-e.__tweenLastRotation),e.__tweenLastRotation=this.v}).onComplete(function(){delete e.__tween,delete e.__tweenLastRotation,delete e.__tweenDestRotation,r&&r.apply(e)}).start(),e.__tween}},mono.AniUtil.playScale=function(e,t,i,n,o,a,s){if(!e.__tween){var r=0,l=i||1;1>i&&(r=1,l=i||0),n=n||1e3,o=o||0,a=a||mono.AniUtil.DefaultEasing,e.__fromPosition=e.getPosition().clone(),e.__fromScale=e.getScale().clone();var d,h;"top"===t||"bottom"===t?(d=e.getHeight()/2,h="y","bottom"===t&&(d=-1*d)):"front"===t||"back"===t?(d=e.getDepth()/2,h="z","back"===t&&(d=-1*d)):"left"===t||"right"===t?(d=e.getWidth()/2,h="x","left"===t&&(d=-1*d)):"center-x"===t?h="x":"center-y"===t?h="y":"center-z"===t?h="z":(d=e.getHeight()/2,h="y");var c=e.getPosition()[h]-d*e.getScale()[h],g=e.getPosition()[h]/e.getScale()[h]*i;return 1>i&&(c=e.getPosition()[h],g=e.getPosition()[h]/e.getScale()[h]*i-d*e.getScale()[h]),console.log(c,g),e.__tween=new TTTTT.Tween({scale:r,v:c}).to({scale:l,v:g},n).easing(a).delay(o).onUpdate(function(){if(d){var t=e.__fromPosition.clone();t[h]=this.v,e.setPosition(t)}var i=e.__fromScale.clone();i[h]=this.scale,e.setScale(i)}).onComplete(function(){delete e.__tween,delete e.__fromPosition,delete e.__fromScale,s&&s.apply(e)}).start(),e.__tween}},mono.AniUtil.playMove=function(e,t,i,n,o,a,s){var r;("left"===t||"right"===t)&&(r="x","left"===t&&(i=-1*i)),("top"===t||"bottom"===t)&&(r="y","bottom"===t&&(i=-1*i)),("front"===t||"back"===t)&&(r="z","back"===t&&(i=-1*i));var l=e.getBizBox(),d=l.max.x-l.min.x,h=l.max.y-l.min.y,c=l.max.z-l.min.z;if("x"===r&&(i*=d),"y"===r&&(i*=h),"z"===r&&(i*=c),!e.__tween){var g=e.getPosition()[r],m=e.__animated?e.getPosition()[r]-i:e.getPosition()[r]+i;return e.__animated=!e.__animated,e.__fromPosition=e.getPosition().clone(),n=n||1e3,o=o||0,a=a||mono.AniUtil.DefaultEasing,e.__tween=new TTTTT.Tween({v:g}).to({v:m},n).easing(a).delay(o).onUpdate(function(){var t=e.__fromPosition.clone();t[r]=this.v,e.setPosition(t)}).onComplete(function(){delete e.__tween,s&&s.apply(e),console.log("complete",g,m,e)}).start(),e.__tween}},mono.AniUtil.getAxisByAnchor=function(e){if("top"===e||"bottom"===e)return"x";if("left"===e||"right"===e)return"y";if("front"===e||"back"===e)return"y";if("center"===e.substring(0,6)){var t=e.split("-");return t[1]}},mono.AniUtil.playAnimation=function(e,t,i,n,o,a){if(e&&t){if(-1!=mono.AniUtil.oldAnimationTypes.indexOf(t))switch(t){case"LeftMove":t="move:left:0.9";break;case"RightMove":t="move:right:0.9";break;case"FrontMove":t="move:front:0.9";break;case"BackMove":t="move:back:0.9";break;case"LeftRotationClockwise90":t="rotation:left:90";break;case"LeftRotationAnticlockwise90":t="rotation:left:-90";break;case"LeftRotationClockwise120":t="rotation:left:120";break;case"LeftRotationAnticlockwise120":t="rotation:left:-120";break;case"CenterRotationClockwise270":t="rotation:center-y:270";break;case"CenterRotationAnticlockwise270":t="rotation:center-y:-270"}i=i||1e3,n=n||0,o=o||mono.AniUtil.DefaultEasing;var s=t.split(":"),r=s[0],l=s[1],d=parseFloat(s[2]);if(s.length>3&&(i=parseInt(s[3])),s.length>4&&(n=parseInt(s[4])),s.length>5&&(o=mono.AniUtil.AllEasings[s[5]]),"rotation"===r){var h=mono.AniUtil.getAxisByAnchor(l);return d=d/180*Math.PI,mono.AniUtil.playRotate(e,h,l,d,i,n,o,a)}return"move"===r?mono.AniUtil.playMove(e,l,d,i,n,o,a):"scale"===r?mono.AniUtil.playScale(e,l,d,i,n,o,a):void 0}},mono.AniUtil.getAnimationString=function(e,t,i,n,o,a){if(!e||!t||!i)return"";var s=e+":"+t+":"+i;return n&&(s+=":"+n),s+=o?":"+o:":0",a&&(s+=":"+a),s},mono.AniUtil.findAnimationAgent=function(e){for(var t=e.getClient("animation");!t&&e.getParent();)t=e.getParent().getClient("animation"),e=e.getParent();return t?e:null},mono.AniUtil.playAlarmAnimation=function(e,t,i,n,o,a){if(!e.__tween){var s=0,r=60;return i=i||1500,n=n||0,o=o||TTTTT.Easing.Elastic.Out,e.__tween=new TTTTT.Tween({scale:s}).to({scale:r},i).easing(o).delay(n).onUpdate(function(){t.setScale(this.scale,this.scale,1)}).onComplete(function(){delete e.__tween,a&&a.apply()}).start()}},mono.AniUtil.playInspection=function(e,t,i){return t.unshift({px:e.getGleye().getPosition().x,py:e.getGleye().getPosition().y,pz:e.getGleye().getPosition().z,tx:e.getGleye().getTarget().x,ty:e.getGleye().getTarget().y,tz:e.getGleye().getTarget().z}),t.__cursor||(t.__cursor=1),mono.AniUtil._doPlayInspection(e,t,i)},mono.AniUtil._doPlayInspection=function(e,t,i){if(t.__cursor<t.length){var n=t[t.__cursor-1],o=t[t.__cursor],a=mono.AniUtil._createInspectionTween(e,n,o);return a.onComplete(function(){t.__cursor++,mono.AniUtil._doPlayInspection(e,t,i)}),a.start(),a}i&&i.apply()},mono.AniUtil._fixStopMissingValues=function(e,t){null==t.px&&(t.px=e.getGleye().getPosition().x),null==t.py&&(t.py=e.getGleye().getPosition().y),null==t.pz&&(t.pz=e.getGleye().getPosition().z),null==t.tx&&(t.tx=e.getGleye().getTarget().x),null==t.ty&&(t.ty=e.getGleye().getTarget().y),null==t.tz&&(t.tz=e.getGleye().getTarget().z)},mono.AniUtil._createInspectionTween=function(e,t,i){var n=i.time?i.time:2e3,o=i.delay?i.delay:0,a=i.easing?i.easing:mono.AniUtil.DefaultEasing;return mono.AniUtil._fixStopMissingValues(e,t),mono.AniUtil._fixStopMissingValues(e,i),new TTTTT.Tween(t).to(i,n).easing(a).delay(o).onUpdate(function(){e.getGleye().look(new mono.XiangliangThree(this.tx,this.ty,this.tz)),e.getGleye().setPosition(this.px,this.py,this.pz)})},mono.AniUtil.playTransform=function(e,t,i,n,o,a){i=i||2e3,n=n||0,o=o||TTTTT.Easing.Linear.None,mono.AniUtil._fixTransformMissingValues(e,t);var s=mono.AniUtil.createElementTransform(e);return new TTTTT.Tween(s).to(t,i).easing(o).delay(n).onUpdate(function(){e.setPosition(this.px,this.py,this.pz),e.setRotation(this.rx,this.ry,this.rz),e.setScale(this.sx,this.sy,this.sz)}).onComplete(function(){a&&a.apply()}).start()},mono.AniUtil._fixTransformMissingValues=function(e,t){null==t.px&&(t.px=t.getPosition().x),null==t.py&&(t.py=t.getPosition().y),null==t.pz&&(t.pz=t.getPosition().z),null==t.rx&&(t.rx=t.getRotation().x),null==t.ry&&(t.ry=t.getRotation().y),null==t.rz&&(t.rz=t.getRotation().z),null==t.sx&&(t.sx=t.getScale().x),null==t.sy&&(t.sy=t.getScale().y),null==t.sz&&(t.sz=t.getScale().z)},mono.AniUtil.createElementTransform=function(e){return{px:e.getPosition().x,py:e.getPosition().y,pz:e.getPosition().z,rx:e.getRotation().x,ry:e.getRotation().y,rz:e.getRotation().z,sx:e.getScale().x,sy:e.getScale().y,sz:e.getScale().z}},mono.AniUtil.createTransform=function(e,t,i,n,o,a,s,r,l){return{px:e,py:t,pz:i,rx:n,ry:o,rz:a,sx:s,sy:r,sz:l}},mono.AniUtil.isAnimated=function(e){return e&&null!=e.__animated&&e.__animated===!0},mono.AniUtil.resetAnimation=function(e){if(e){var t=e.getNodes().toArray();if(t)for(var i=0;i<t.length;i++){var n=t[i];mono.AniUtil.isAnimated(n)&&mono.AniUtil.playAnimation(n,n.getClient("animation"))}}},mono.AniUtil.resetAnimatedFlag=function(e){e&&(delete e.__animated,delete e.__played)},mono.AniUtil.playGleyeAnimation=function(e,t,i,n,o,a){if(e&&t){i=i||1e3,n=n||0,o=o||mono.AniUtil.DefaultEasing;var s=t.split(":"),r=(s[0],parseFloat(s[1]));r=r/180*Math.PI;var l=mono.AniUtil.createAxisByName("y"),d=e.getTarget();if(!e.__tween){var h=0,c=r;return e.__tweenLastRotation=h,e.__tweenDestRotation=c,e.__tween=new TTTTT.Tween({v:h}).to({v:c},i).easing(o).delay(n).onUpdate(function(){var t=v(l,e.getPosition(),d,this.v-e.__tweenLastRotation);e.setPosition(t),e.__tweenLastRotation=this.v}).onComplete(function(){delete e.__tween,delete e.__tweenLastRotation,delete e.__tweenDestRotation,a&&a.apply(e)}).start(),e.__tween}}};var v=function(e,t,i,n){var o=t.clone();return o.rotateFromAxisAndCenter(e,n,i)};mono.AnimationData=function(e,t,i,n){this.object=t,this.animation=i,this.groupName=n,this._id=e},twaver.Util.ext("mono.AnimationData",Object,{play:function(){if(this.object instanceof mono.Entity){this.object.__animated=this.object.__played;var e=this.animation.split(";");e.length>=1&&(this.object.__played?this.playAnimationString(e,e.length-1,e.length,this.object.__played):this.playAnimationString(e,0,e.length,this.object.__played)),this.object.__played=!this.object.__played}},playAnimationString:function(e,t,i,n){var o=this;this.object.__animated=n,n?e[i-1]&&t>=0&&mono.AniUtil.playAnimation(this.object,e[t],null,null,null,function(){o.playAnimationString(e,--t,i,n)}):e[t]&&i>t&&mono.AniUtil.playAnimation(this.object,e[t],null,null,null,function(){o.playAnimationString(e,++t,i,n)})},setAnimationGroup:function(e){this.groupName=e},setAnimation:function(e){this.animation=e},isPlayed:function(){return this.object&&null!=this.object.__played&&this.object.__played===!0},reset:function(){this.isPlayed()&&this.play()}}),mono.AnimationManager=function(e){this.name=e,this.animations=[],this.animationMap={},this.totalAnimations=[],this.isPlayed=!1},twaver.Util.ext("mono.AnimationManager",Object,{add:function(e){this.animations.push(e),this.totalAnimations.push(e),this.animationMap[e._id]=e},remove:function(e){var t=this.animations.indexOf(e);-1!==t&&this.animations.splice(t,1),this.animationMap[e._id]=null,t=this.totalAnimations.indexOf(e),-1!==t&&this.totalAnimations.splice(t,1)},getAnimationById:function(e){return this.animationMap[e]},stop:function(){var e=this.getCurrentAnimation();e.stop()},setTotalAnimations:function(e){if(e&&e.length>0)for(var t in e){var i=this.totalAnimations.indexOf(e[t]);-1!==i&&this.totalAnimations.push(e[t])}},playAll:function(){if(this.animations&&this.animations.length>0)if(isPlayed)for(var e=this.animations.length-1;e>=0;e--)this.play(this.animations[e]);else for(var e=0;e<animations.length;e++)this.play(this.animations[e]);isPlayed=!isPlayed},getCurrentAnimation:function(){if(this.animations&&this.animations.length>0)for(var e in this.animations)if(this.animations[e].isPlaying)return this.animations[e]},reset:function(){for(var e in this.animations)this.animations[e].reset()},play:function(e){if(e.groupName){var t=this.getAllAnimationsByGroupName(e.groupName);for(var i in t)t[i].play()}else e.play()},getAllAnimations:function(){return this.animations},getAllAnimationsByGroupName:function(e){var t=[];if(this.totalAnimations&&this.totalAnimations.length>0)for(var i in this.totalAnimations)this.totalAnimations[i].groupName==e&&t.push(this.totalAnimations[i]);return t},resetAllAnimations:function(){if(this.animations&&this.animations.length>0)for(var e in this.animations)this.animations[e].reset()}})}();var extend=function(e,t,i){e.superClass=t,e.prototype=inherit(t.prototype),e.prototype.constructor=e;for(prop in i)e.prototype[prop]=i[prop]},Healper_addEventListener=function(e,t,i,n,o){null==o&&(o=!1);var a=function(e){i.call(a.scope,e)};a.scope=n,e.addEventListener?e.addEventListener(t,a,o):e.attachEvent("on"+t,a)};SampleData=function(){this.x=0,this.y=0,this.value=null},RecordSet=function(e,t){this.max=e,this.data=t},CommonObject=function(){CommonObject.superClass.apply(this),this._c={}},extend(CommonObject,Object,{get:function(e){return this._c[e]},set:function(e,t){this._c[e]=t},print:function(e){console.log(e)},initDefaults:function(e){for(pro in e)this._c[pro]=e[pro]}}),TH3=function(e){TH3.superClass.apply(this,arguments),this._store=new Store(this),this.initDefaults({radius:40,element:null,canvas:{},acanvas:{},ctx:{},actx:{},legend:null,visible:!0,width:0,height:0,max:0,gradient:!1,opacity:180,premultiplyAlpha:!1,bounds:{l:1e3,r:0,t:1e3,b:0},gradient:{.25:"rgb(0,0,255)",.5:"rgb(0,255,255)",.75:"rgb(0,255,0)",1:"rgb(255,0,0)"},blur:15}),this.init(),e?this.configure(e):this.initColorPalette()},extend(TH3,CommonObject,{setRadius:function(e){var t=this.get("radius");t!=e&&(this.set("radius",e),this.updateSettings())},setBlur:function(e){var t=this.get("blur");t!=e&&(this.set("blur",e),this.updateSettings())},setGradient:function(e){this.set("gradient",e||{.25:"rgb(0,0,255)",.5:"rgb(0,255,255)",.75:"rgb(0,255,0)",1:"rgb(255,0,0)"}),this.initColorPalette()},setBounds:function(){if(2==arguments.length)this.set("width",arguments[0]),this.set("height",arguments[1]);else if(1==arguments.length){var e=arguments[0],t=this.get("bounds");e.hasOwnProperty("left")&&(t.l=e.left),e.hasOwnProperty("right")&&(t.r=e.right),e.hasOwnProperty("top")&&(t.t=e.top),e.hasOwnProperty("bottom")&&(t.b=e.bottom)}this.updateSettings()},addPoint:function(e){this._store.addPoint(e)},pushDataSet:function(e,t){this._store.pushRecordSet(e,t)},showData:function(){console.log(this._store.toJSON())},configure:function(e){if(this.set("radius",e.radius||40),this.set("element",e.element instanceof Object?e.element:document.getElementById(e.element)),this.set("visible",null!=e.visible?e.visible:!0),this.set("max",e.max||!1),this.setGradient(e.gradient),this.set("opacity",parseInt(255/(100/e.opacity),10)||180),this.set("width",e.width||0),this.set("height",e.height||0),e.legend){var t=e.legend;t.gradient=this.get("gradient"),this.set("legend",new Legend(t))}this.updateSettings()},resize:function(){var e=this.get("element"),t=this.get("canvas"),i=this.get("acanvas");e?(t.width=i.width=this.get("width")||e.style.width.replace(/px/,"")||this.getWidth(e),this.set("width",t.width),t.height=i.height=this.get("height")||e.style.height.replace(/px/,"")||this.getHeight(e),this.set("height",t.height)):(t.width=i.width=this.get("width"),t.height=i.height=this.get("height"))},init:function(){var e=document.createElement("canvas"),t=document.createElement("canvas"),i=e.getContext("2d"),n=t.getContext("2d");e.className="h29#3",this.set("canvas",e),this.set("ctx",i),this.set("acanvas",t),this.set("actx",n),e.style.cssText=t.style.cssText="position:absolute;top:0;left:0;",e.isMovable=!0,this.get("visible")||(e.style.display="none"),n.shadowOffsetX=15e3,n.shadowOffsetY=15e3,n.shadowBlur=this.get("blur")},bindElement:function(e){this.set("element",e),this.appendTo(e)},updateSettings:function(){this.resize();var e=this.get("element");this.appendTo(e)},appendTo:function(e){var t=this.get("canvas"),i=t.parentElement;i!==e&&e&&(e.appendChild(t),this.get("legend")&&e.appendChild(this.get("legend").getElement()))},initColorPalette:function(){var e,t,i,n=document.createElement("canvas"),o=this.get("gradient");n.width="1",n.height="256",e=n.getContext("2d"),t=e.createLinearGradient(0,0,1,256),i=e.getImageData(0,0,1,1),i.data[0]=i.data[3]=64,i.data[1]=i.data[2]=0,e.putImageData(i,0,0),i=e.getImageData(0,0,1,1),this.set("premultiplyAlpha",i.data[0]<60||i.data[0]>70);for(var a in o)t.addColorStop(a,o[a]);e.fillStyle=t,e.fillRect(0,0,1,256),this.set("gradientdata",e.getImageData(0,0,1,256).data)},getWidth:function(e){var t=e.offsetWidth;return e.style.paddingLeft&&(t+=e.style.paddingLeft),e.style.paddingRight&&(t+=e.style.paddingRight),t},getHeight:function(e){var t=e.offsetHeight;return e.style.paddingTop&&(t+=e.style.paddingTop),e.style.paddingBottom&&(t+=e.style.paddingBottom),t},colorize:function(e,t){var i,n,o,a,s,r,l,d,h,c,g=this.get("width"),m=this.get("radius"),u=this.get("height"),p=this.get("actx"),f=this.get("ctx"),v=3*m,y=this.get("premultiplyAlpha"),C=this.get("gradientdata"),S=this.get("opacity"),I=this.get("bounds");null!=e&&null!=t?(e+v>g&&(e=g-v),0>e&&(e=0),0>t&&(t=0),t+v>u&&(t=u-v),i=e,n=t,a=e+v,o=t+v):(i=I.l<0?0:I.l,a=I.r>g?g:I.r,n=I.t<0?0:I.t,o=I.b>u?u:I.b),s=p.getImageData(i,n,a-i,o-n),r=s.data,l=r.length;for(var P=3;l>P;P+=4)d=r[P],h=4*d,h&&(c=S>d?d:S,r[P-3]=C[h],r[P-2]=C[h+1],r[P-1]=C[h+2],y&&(r[P-3]/=255/c,r[P-2]/=255/c,r[P-1]/=255/c),r[P]=c);s.data=r,f.putImageData(s,i,n)},drawBackground:function(e){},drawAlpha:function(e,t,i,n){var o=this.get("radius"),a=this.get("actx"),s=this.getMax(),r=this.get("bounds"),l=this.get("blur"),d=e-1.5*o>>0,h=t-1.5*o>>0,c=e+1.5*o>>0,g=t+1.5*o>>0;a.save(),this.drawBackground(a),a.restore(),a.shadowColor="rgba(0,0,0,"+(i?i/s:"0.1")+")",console.log(i),a.shadowOffsetX=15e3,a.shadowOffsetY=15e3,a.shadowBlur=l,a.beginPath(),a.arc(e-15e3,t-15e3,o,0,2*Math.PI,!0),a.closePath(),a.fill(),n?this.colorize(d,h):(d<r.l&&(r.l=d),h<r.t&&(r.t=h),c>r.r&&(r.r=c),g>r.b&&(r.b=g))},toggleDisplay:function(){var e=this.get("visible"),t=this.get("canvas");e?t.style.display="none":t.style.display="block",this.set("visible",!e)},getImage:function(){var e=this.get("canvas");return e.toDataURL()},clear:function(){var e=this.get("width"),t=this.get("height");this._store.set("data",[]),this.get("ctx").clearRect(0,0,e,t),this.get("actx").clearRect(0,0,e,t)},cleanup:function(){this.get("element").removeChild(this.get("canvas"))},getMax:function(){return this.get("max")?this.get("max"):this._store._max},setMax:function(e){this.set("max",e)},getDataSet:function(){return this._store.get("data")},updateAlpha:function(e){for(var e=this.getDataSet(),t=0;t<e.length;t++){var i=e[t];if(i)for(var n=0;n<i.length;n++){var o=i[n];o&&this.drawAlpha(t,n,o,!0)}}},print:function(e){TH3.superClass.prototype.print.apply(this,arguments)}}),Store=function(e){Store.superClass.apply(this,arguments),this._max=1,this._m=e,this.set("data",[])},extend(Store,CommonObject,{addPoint:function(e){e.value?this.addDataPoint(e.x,e.y,e.value):e.count?this.addDataPoint(e.x,e.y,e.count):this.addDataPoint(e.x,e.y)},addDataPoint:function(e,t){if(!(0>e||0>t)){var i=this.get("data");return i[e]||(i[e]=[]),i[e][t]||(i[e][t]=0),i[e][t]+=arguments.length<3?1:arguments[2],2==i[e][t]&&console.log("add data point "+e+","+t+"   "+i[e][t]),this.set("data",i),this._max<i[e][t]?(this._m.get("actx").clearRect(0,0,this._m.get("width"),this._m.get("height")),void this.setDataSet({max:i[e][t],data:i},!0)):void this._m.drawAlpha(e,t,i[e][t],!0)}},pushRecordSet:function(e,t){this.setDataSet(e,t)},setDataSet:function(e,t){var i=[],n=e.data,o=n.length;if(this._m.clear(),this._max=e.max,this._m.get("legend")&&this._m.get("legend").update(e.max),null!=t&&t){for(var a in n)if(void 0!==a)for(var s in n[a])void 0!==s&&this._m.drawAlpha(a,s,n[a][s],!1)}else for(;o--;){var r=n[o];i[r.x]||(i[r.x]=[]),i[r.x][r.y]||(i[r.x][r.y]=0),r.value?i[r.x][r.y]=r.value:r.count?i[r.x][r.y]=r.count:i[r.x][r.y]?i[r.x][r.y]++:i[r.x][r.y]=1,
this._m.drawAlpha(r.x,r.y,i[r.x][r.y],!1)}this._m.colorize(),this.set("data",n)},exportDataSet:function(){var e=this.get("data"),t=[];for(var i in e)if(void 0!==i)for(var n in e[i])void 0!==n&&t.push({x:parseInt(i,10),y:parseInt(n,10),count:1e3});return{max:this._max,data:t}},generateRandomDataSet:function(e){var t=this._m.get("width"),i=this._m.get("height"),n={},o=Math.floor(1e3*Math.random()+1);n.max=o;for(var a=[];e--;)a.push({x:Math.floor(Math.random()*t+1),y:Math.floor(Math.random()*i+1),count:Math.floor(Math.random()*o+1)});n.data=a,this.setDataSet(n)},toJSON:function(){for(var e=[],t=this.get("data"),i=0;i<t.length;i++)if(t[i])for(var n=0;n<t[i].length;n++)t[i][n]&&e.push({x:i,y:n,v:t[i][n]});return JSON.stringify(e)}}),Legend=function(e){Legend.superClass.apply(this,arguments),this.set("decimal",0),this.init(e)},extend(Legend,CommonObject,{init:function(e){this.config=e,e&&e.decimal&&this.set("decimal",e.decimal);var t,i,n=e.title||"Legend",o=e.position,a=e.offset||10,s=(e.gradient,document.createElement("ul")),r="";this.processGradientObject(),r+=o.indexOf("t")>-1?"top:"+a+"px;":"bottom:"+a+"px;",r+=o.indexOf("l")>-1?"left:"+a+"px;":"right:"+a+"px;",t=document.createElement("div"),t.style.cssText="border-radius:5px;position:absolute;"+r+"font-family:Helvetica; width:256px;z-index:10000000000; background:rgba(255,255,255,1);padding:10px;border:1px solid black;margin:0;",t.innerHTML="<h3 style='padding:0;margin:0;text-align:center;font-size:16px;'>"+n+"</h3>",s.style.cssText="position:relative;font-size:12px;display:block;list-style:none;list-style-type:none;margin:0;height:15px;",i=document.createElement("div"),i.style.cssText=["position:relative;display:block;width:256px;height:15px;border-bottom:1px solid black; background-image:url(",this.createGradientImage(),");"].join(""),t.appendChild(s),t.appendChild(i),t.className="l_m",this.set("element",t),this.set("labelsEl",s),this.update(1)},processGradientObject:function(){var e=this.config.gradient,t=[];for(var i in e)e.hasOwnProperty(i)&&t.push({stop:i,value:e[i]});t.sort(function(e,t){return e.stop-t.stop}),t.unshift({stop:0,value:"rgba(0,0,0,0)"}),this.set("gradientArr",t)},createGradientImage:function(){var e,t=this.get("gradientArr"),i=t.length,n=document.createElement("canvas"),o=n.getContext("2d");n.width="256",n.height="15",e=o.createLinearGradient(0,5,256,10);for(var a=0;i>a;a++)e.addColorStop(1/(i-1)*a,t[a].value);o.fillStyle=e,o.fillRect(0,5,256,10),o.strokeStyle="black",o.beginPath();for(var a=0;i>a;a++)o.moveTo((1/(i-1)*a*256>>0)+.5,0),o.lineTo((1/(i-1)*a*256>>0)+.5,0==a?15:5);return o.moveTo(255.5,0),o.lineTo(255.5,15),o.moveTo(255.5,4.5),o.lineTo(0,4.5),o.stroke(),this.set("ctx",o),n.toDataURL()},getElement:function(){return this.get("element")},update:function(e){for(var t,i,n=this.get("gradientArr"),o=this.get("ctx"),a=this.get("labelsEl"),s="",r=this.get("decimal"),l=0;l<n.length;l++)t=(e*n[l].stop).toFixed(r),i=o.measureText(t).width/2>>0,0==l&&(i=0),l==n.length-1&&(i*=2),s+='<li style="position:absolute;left:'+(((1/(n.length-1)*l*256||0)>>0)-i+.5)+'px">'+t+"</li>";a.innerHTML=s}}),TemperatureBoard=function(e,t,i,n,o,a,s){this.direction=i||"v",this.width=e,this.height=t,this.map=new TH3(s),this.map.setRadius(n||25),this.map.setBounds(e,t),this.map.setGradient(o),this.map.setBlur(a||15)},extend(TemperatureBoard,Object,{setDirection:function(e){this.direction=e},setSize:function(e,t){this.width=e,this.height=t,map.setBounds(e,t)},drawBackground:function(e){this.map.drawBackground(e),this.map.updateAlpha()},addPoint:function(){if(1==arguments.length&&"object"==typeof arguments[0])this.map.addPoint(arguments[0]);else if(3==arguments.length){var e=new SampleData;e.x=arguments[0],e.y=arguments[1],e.value=arguments[2],this.map.addPoint(e)}},getImage:function(){return this.map.getImage()},getTemperatureBoard:function(){var e=new TGL.Plane(this.width,this.height);return e.setStyle("m.texture.repeat",new TGL.XiangliangTwo(1,1)).setStyle("m.type","basic").setStyle("m.texture.image",this.getImage()).setStyle("m.transparent",!0).setStyle("m.side","both"),"h"==this.direction&&e.setRotation(90*Math.PI/180,0,0),e},setGradient:function(e){this.map.setGradient(e),this.map.updateAlpha()},setRadius:function(e){this.map.setRadius(e),this.map.updateAlpha()},setBlur:function(e){this.map.setBlur(e),this.map.updateAlpha()},setMax:function(e){this.map.setMax(e),this.map.updateAlpha()}}),LEDDisplay=function(e){this._dom=document.createElement("canvas"),this._dom.setAttribute("width",160),this._dom.setAttribute("height",32);var t=new Image,i=this;t.onload=function(){i.repaint()},t.src=e,this.board=t},extend(LEDDisplay,Object,{repaint:function(){this.paint(this.cont)},getx:function(e){return NaN===e?10:e>=0&&9>=e?e:10},getView:function(){return this._dom},display:function(e){var t=e;e.length||(t+="");for(var i=t.length,n=[],o=0;i>o;o++)n.push(t.substr(o,1));this.paint(n)},paint:function(e){this.cont=e;var t=this._dom,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);for(var n=0;n<e.length;n++){var o=this.getx(Number(e[n]));i.drawImage(this.board,32*o,0,32,32,32*n,0,32,32)}}}),mono.Toolkits={},mono.Toolkits.loadGraph=function(e,t,i,n){return modelManager.loadGraph(e,t,i,n)},mono.Toolkits.loadTemplateByName=function(e,t,i,n,o){modelManager.loadTemplateFromCloud(e,t,i,o)},mono.Toolkits.loadTemplateById=function(e,t,i,n,o){modelManager.loadCloudTemplateById(e,t,i,n,o)},mono.Toolkits.loadGraphUrl=function(e,t,i,n,o,a){modelManager.loadGraphUrl(e,t,i,n,o,a)},mono.Toolkits.loadGraphDatas=function(e){return modelManager.loadGraphDatas(e)},mono.Toolkits.exportGraph=function(e){return modelManager.serializeGraphInfo(e,!0)},mono.Toolkits.loadTemplate=function(e,t,i){return modelManager.loadComponentTemplateFromContents(e,t,i,!1)},mono.Toolkits.loadTemplateUrl=function(e,t,i,n,o){modelManager.loadComponentTemplateFromURL(e,t,i,n,o)},mono.Toolkits.login=function(e,t,i,n){Utils.login(e,t,i,n)},mono.Toolkits.batchExportTemplates=function(e){return(new TemplateTablePane).batchDownloadTemplates(e)};var modelManager,timerID,taskCount=0,showDim=!1,showCoord=!1,decimalNumber=2,refreshGl3dview,loadmodels=function(e){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",Utils.RelativePath+"resources/"+e),document.getElementsByTagName("head")[0].appendChild(t)},initContainerLib=function(e){modelManager=new modellib.ContainerManager,e&&(loadmodels("RoomPrimitives.json"),loadmodels("RoomAssembles.json"))},parsePrimitives=function(e){modelManager.parsePrimitives(e),modelManager.loadSharedPrimitive(),taskCount++},parseAssembles=function(e){modelManager.parseAssembles(e),modelManager.loadSharedAssemble(),taskCount++},parseLib=function(e){modelManager.parseLib(e),taskCount++}+function(e,t){mono.LoadingManager=function(e,i,n){var o=this,a=0,s=0;this.onLoad=e,this.onProgress=i,this.onError=n,this.itemStart=function(e){s++},this.itemEnd=function(e){a++,o.onProgress!==t&&o.onProgress(e,a,s),a===s&&o.onLoad!==t&&o.onLoad()}},mono.DefaultLoadingManager=new mono.LoadingManager,mono.ImageLoader=function(e){this.manager=e!==t?e:mono.DefaultLoadingManager},mono.ImageLoader.prototype={constructor:mono.ImageLoader,load:function(e,i,n,o){var a=this,s=document.createElement("img");return i!==t&&s.addEventListener("load",function(t){a.manager.itemEnd(e),i(this)},!1),n!==t&&s.addEventListener("progress",function(e){n(e)},!1),o!==t&&s.addEventListener("error",function(e){o(e)},!1),this.crossOrigin!==t&&(s.crossOrigin=this.crossOrigin),s.src=e,a.manager.itemStart(e),s},loadFile:function(e,i,n,o){var a=this,s=new FileReader;i!==t&&(s.onload=function(){i(s.result),a.manager.itemEnd(e.name)}),n!==t&&s.addEventListener("progress",function(e){n(e)},!1),o!==t&&s.addEventListener("error",function(e){o(e)},!1),s.readAsDataURL(e),a.manager.itemStart(e.name)},setCrossOrigin:function(e){this.crossOrigin=e}},mono.XHRLoader=function(e){this.manager=e!==t?e:mono.DefaultLoadingManager},mono.XHRLoader.prototype={constructor:mono.XHRLoader,load:function(e,i,n,o){var a=this,s=new XMLHttpRequest;i!==t&&s.addEventListener("load",function(t){i(t.target.responseText),a.manager.itemEnd(e)},!1),n!==t&&s.addEventListener("progress",function(e){n(e)},!1),o!==t&&s.addEventListener("error",function(e){o(e)},!1),this.crossOrigin!==t&&(s.crossOrigin=this.crossOrigin),s.open("GET",e,!0),s.send(null),a.manager.itemStart(e)},loadFile:function(e,i,n,o){if(e){var a=this,s=new FileReader;i!==t&&(s.onload=function(){i(s.result),a.manager.itemEnd(e.name)}),n!==t&&s.addEventListener("progress",function(e){n(e)},!1),o!==t&&s.addEventListener("error",function(e){o(e)},!1),s.readAsText(e),a.manager.itemStart(e.name)}},setCrossOrigin:function(e){this.crossOrigin=e}},mono.MTLLoader=function(e,t,i){this.baseUrl=e,this.options=t,this.crossOrigin=i},mono.extend(mono.MTLLoader,null,{constructor:mono.MTLLoader,load:function(e,t,i,n){var o=this,a=new mono.XHRLoader;a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){t(o.parse(e))})},loadFile:function(e,t,i,n){var o=this,a=new mono.XHRLoader;a.loadFile(e,function(e){t(o.parse(e))})},loadText:function(e,t){t(this.parse(e))},parse:function(e){for(var t=e.split("\n"),i={},n=/\s+/,o={},a=0;a<t.length;a++){var s=t[a];if(s=s.trim(),0!==s.length&&"#"!==s.charAt(0)){var r=s.indexOf(" "),l=r>=0?s.substring(0,r):s;l=l.toLowerCase();var d=r>=0?s.substring(r+1):"";if(d=d.trim(),"newmtl"===l)i={name:d},o[d]=i;else if(i)if("ka"===l||"kd"===l||"ks"===l){var h=d.split(n,3);i[l]=[parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2])]}else i[l]=d}}var c=new mono.MTLLoader.MaterialCreator(this.baseUrl,this.options);return c.setMaterials(o),c}}),mono.MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e,this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:mono.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:mono.RepeatWrapping},mono.extend(mono.MTLLoader.MaterialCreator,mono.EventDispatcher,{constructor:mono.MTLLoader.MaterialCreator,setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var i in e){var n=e[i],o={};t[i]=o;for(var a in n){var s=!0,r=n[a],l=a.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(r=[r[0]/255,r[1]/255,r[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===r[0]&&0===r[1]&&0===r[1]&&(s=!1);break;case"d":this.options&&this.options.invertTransparency&&(r=1-r)}s&&(o[l]=r)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return this.materials[e]===t&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var t=this,i=this.materialsInfo[e],n={name:e,side:this.side};for(var o in i){var a=i[o];switch(o.toLowerCase()){case"kd":n.diffuse=(new mono.Color).setRGB(a[0],a[1],a[2]);break;case"ka":n.ambient=(new mono.Color).setRGB(a[0],a[1],a[2]);break;case"ks":n.specular=(new mono.Color).setRGB(a[0],a[1],a[2]);break;case"map_kd":if("string"==typeof this.baseUrl)n.map={},n.map.img=this.baseUrl+a,n.map.wrapS=this.wrap,n.map.wrapT=this.wrap;else if("object"==typeof this.baseUrl){if(a.indexOf(".")>0){a=a.substring(0,a.lastIndexOf(".")).toLowerCase();var s={};if(/\-s/.test(a)){var r=/\-s( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;s=r.exec(a);var l=a.split(s[0]);a=l[l.length-1].trim(),s.repeatR=parseInt(s[1]),s.repeatC=parseInt(s[2])}if(/\-t/.test(a)){var r=/\-t( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/;s=r.exec(a);var l=a.split(s[0]);a=l[l.length-1].trim(),s.repeatR=parseInt(s[1]),s.repeatC=parseInt(s[2])}}this.baseUrl[a]&&(n.map={},n.map.img=this.baseUrl[a],n.map.wrapS=t.wrap,n.map.wrapT=t.wrap,n.map.repeatR=s.repeatR,n.map.repeatC=s.repeatC)}break;case"ns":n.shininess=a;break;case"d":1>a&&(n.transparent=!0,n.opacity=a)}}return n.diffuse&&(n.ambient||(n.ambient=n.diffuse),n.color=n.diffuse),this.materials[e]=n,this.materials[e]},loadTexture:function(e,t,i,n){var o=/\.dds$/i.test(e);if(o)var a=mono.ImageUtils.loadCompressedTexture(e,t,i,n);else{var s=new Image,a=new mono.Texture(s,t),r=new mono.ImageLoader;r.crossOrigin=this.crossOrigin,r.load(e,function(e){a.image=mono.MTLLoader.ensurePowerOfTwo_(e),a.needsUpdate=!0,i&&i(a)})}return a}}),mono.MTLLoader.ensurePowerOfTwo_=function(e){if(!mono.MTLLoader.isPowerOfTwo_(e.width)||!mono.MTLLoader.isPowerOfTwo_(e.height)){var t=document.createElement("canvas");t.width=mono.MTLLoader.nextHighestPowerOfTwo_(e.width),t.height=mono.MTLLoader.nextHighestPowerOfTwo_(e.height);var i=t.getContext("2d");return i.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t}return e},mono.MTLLoader.isPowerOfTwo_=function(e){return 0===(e&e-1)},mono.MTLLoader.nextHighestPowerOfTwo_=function(e){--e;for(var t=1;32>t;t<<=1)e|=e>>t;return e+1},mono.OBJLoader=function(e){this.manager=e!==t?e:mono.DefaultLoadingManager},mono.extend(mono.OBJLoader,Object,{constructor:mono.ObJLoader,load:function(e,t,i,n){var o=this,a=new mono.XHRLoader(o.manager);a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){t(o.parse(e))})},parse:function(e){function i(e,t,i){return new mono.XiangliangThree(e,t,i)}function n(e,t){return new mono.XiangliangTwo(e,t)}function o(e,t,i,n){return new mono.Face3(e,t,i,n)}function a(e,i,n,a){a===t?l.faces.push(o(parseInt(e)-(c+1),parseInt(i)-(c+1),parseInt(n)-(c+1))):l.faces.push(o(parseInt(e)-(c+1),parseInt(i)-(c+1),parseInt(n)-(c+1),[m[parseInt(a[0])-1].clone(),m[parseInt(a[1])-1].clone(),m[parseInt(a[2])-1].clone()]))}function s(e,t,i){l.uvs.push([u[parseInt(e)-1].clone(),u[parseInt(t)-1].clone(),u[parseInt(i)-1].clone()])}function r(e,i,n){e[3]===t?(a(e[0],e[1],e[2],n),i!==t&&i.length>0&&s(i[0],i[1],i[2])):(n!==t&&n.length>0?(a(e[0],e[1],e[3],[n[0],n[1],n[3]]),a(e[1],e[2],e[3],[n[1],n[2],n[3]])):(a(e[0],e[1],e[3]),a(e[1],e[2],e[3])),i!==t&&i.length>0&&(s(i[0],i[1],i[3]),s(i[1],i[2],i[3])))}var l,d,h=new mono.Element,c=0;/^o /gm.test(e)===!1&&(l=new mono.Entity,d=new mono.BasicMaterial,l.setStyle("m.type","phong"),h.addChild(l));for(var g=0,m=[],u=[],p=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,f=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,v=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,y=/f( +\d+)( +\d+)( +\d+)( +\d+)?/,C=/f( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))?/,S=/f( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))?/,I=/f( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))?/,P=e.split("\n"),A=0;A<P.length;A++){var E=P[A];E=E.trim();var w;if(0!==E.length&&"#"!==E.charAt(0))if(null!==(w=p.exec(E)))l.vertices.push(i(parseFloat(w[1]),parseFloat(w[2]),parseFloat(w[3])));else if(null!==(w=f.exec(E)))m.push(i(parseFloat(w[1]),parseFloat(w[2]),parseFloat(w[3])));else if(null!==(w=v.exec(E)))u.push(n(parseFloat(w[1]),parseFloat(w[2])));else if(null!==(w=y.exec(E)))r([w[1],w[2],w[3],w[4]]);else if(null!==(w=C.exec(E)))r([w[2],w[5],w[8],w[11]],[w[3],w[6],w[9],w[12]]);else if(null!==(w=S.exec(E)))r([w[2],w[6],w[10],w[14]],[w[3],w[7],w[11],w[15]],[w[4],w[8],w[12],w[16]]);else if(null!==(w=I.exec(E)))r([w[2],w[5],w[8],w[11]],[],[w[3],w[6],w[9],w[12]]);else if(/^o /.test(E))l!==t&&(c+=l.vertices.length),l=new mono.Entity,d=new mono.BasicMaterial,l.setStyle("m.type","phong"),l._name=E.substring(2).trim(),h.addChild(l),g=0;else if(/^g /.test(E));else if(/^usemtl /.test(E)){E.substring(7).trim()}else/^mtllib /.test(E)||/^s /.test(E)}for(var A=0,b=h._childList._as.length;b>A;A++){var l=h._childList._as[A];l.computed=!1,l.computeNodeData(),l.computeCentroids(),l.computeFaceNormals(),l.computeBoundingSphere()}return h}}),mono.OBJMTLLoader=function(){},mono.extend(mono.OBJMTLLoader,mono.MTLLoader,{constructor:mono.OBJMTLLoader,load:function(e,t,i,n,o,a){var s=this,r=new mono.MTLLoader(i);r.load(t,function(t){var i=t;i.preload();var o=new mono.XHRLoader(s.manager);o.setCrossOrigin(this.crossOrigin),o.load(e,function(e){for(var t=s.parse(e),o=0;o<t._childList._as.length;o++){var a=t._childList._as[o];if(a.mname){var r=i.create(a.mname);s.setGeometryStyle(a,r)}for(var l=0;l<a._childList._as.length;l++){var d=a._childList._as[l];if(d.mname){var h=i.create(d.mname);s.setGeometryStyle(d,h)}}}n(t)})})},setGeometryStyle:function(e,t){if(t.map){this.loadTexture(e,t.map.img);var i=t.map.repeatR,n=t.map.repeatC;i&&n&&e.setStyle("m.texture.repeat",new mono.XiangliangTwo(i,n))}e.setStyle("m.ambient",t.ambient),e.setStyle("m.specular",t.specular),e.setStyle("m.color",t.color),t.transparent&&(e.setStyle("m.transparent",!0),e.setStyle("m.opacity",t.opacity))},loadBase64:function(e,t,i,n,o,a){var s=this,r=mono.base64decode(t),l=mono.base64decode(e),d=new mono.MTLLoader(i);d.loadText(r,function(e){var t=e;t.preload();for(var i=s.parse(l),o=0;o<i._childList._as.length;o++){var a=i._childList._as[o];if(a.mname){var r=t.create(a.mname);s.setGeometryStyle(a,r)}for(var d=0;d<a._childList._as.length;d++){var h=a._childList._as[d];if(h.mname){var c=t.create(h.mname);s.setGeometryStyle(h,c)}}}n(i)})},loadFiles:function(e,t,i,n,o,a){var s=this,r=new mono.MTLLoader(i);r.loadFile(t,function(t){var i=t;i.preload();var o=new mono.XHRLoader(s.manager);o.loadFile(e,function(e){for(var t=s.parse(e),o=0;o<t._childList._as.length;o++){var a=t._childList._as[o];if(a.mname){var r=i.create(a.mname);s.setGeometryStyle(a,r)}for(var l=0;l<a._childList._as.length;l++){var d=a._childList._as[l];if(d.mname){var h=i.create(d.mname);s.setGeometryStyle(d,h)}}}n(t)})})},loadTexture:function(e,t){if("string"==typeof t)e.setStyle("m.texture.image",t);else if(e&&t){var i=new mono.ImageLoader;i.loadFile(t,function(t){e.setStyle("m.texture.image",t)})}},parse:function(e,i){function n(e,t,i){return new mono.XiangliangThree(e,t,i)}function o(e,t){return new mono.XiangliangTwo(e,t)}function a(e,t,i,n){return new mono.Face3(e,t,i,n)}function s(e,i){if(u.length>0&&(m.vertices=u,m.computed=!1,m.computeCentroids(),m.computeFaceNormals(),m.computeBoundingSphere(),m.faces.length>0)){var n=m._name;g.addChild(m),m=new mono.Entity,m._name=n,m.setStyle("m.type","phong"),p=0}e!==t&&(m._name=e),i!==t&&(m.mname=i)}function r(e,i,n,o){o===t?m.faces.push(a(parseInt(e)-(h+1),parseInt(i)-(h+1),parseInt(n)-(h+1))):m.faces.push(a(parseInt(e)-(h+1),parseInt(i)-(h+1),parseInt(n)-(h+1),[f[parseInt(o[0])-1].clone(),f[parseInt(o[1])-1].clone(),f[parseInt(o[2])-1].clone()]))}function l(e,t,i){m.uvs.push([v[parseInt(e)-1].clone(),v[parseInt(t)-1].clone(),v[parseInt(i)-1].clone()])}function d(e,i,n){e[3]===t?(r(e[0],e[1],e[2],n),i!==t&&i.length>0&&l(i[0],i[1],i[2])):(n!==t&&n.length>0?(r(e[0],e[1],e[3],[n[0],n[1],n[3]]),r(e[1],e[2],e[3],[n[1],n[2],n[3]])):(r(e[0],e[1],e[3]),r(e[1],e[2],e[3])),i!==t&&i.length>0&&(l(i[0],i[1],i[3]),l(i[1],i[2],i[3])))}var h=0,c=new mono.Entity,g=c,m=new mono.Entity;m.setStyle("m.type","phong");for(var u=[],p=0,f=[],v=[],y=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,C=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,S=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,I=/f( +\d+)( +\d+)( +\d+)( +\d+)?/,P=/f( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))?/,A=/f( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))?/,E=/f( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))?/,w=e.split("\n"),b=0;b<w.length;b++){var x=w[b];x=x.trim();var _;if(0!==x.length&&("#"!==x.charAt(0)||"o"==x.charAt(2)))if(null!==(_=y.exec(x)))u.push(n(parseFloat(_[1]),parseFloat(_[2]),parseFloat(_[3])));else if(null!==(_=C.exec(x)))f.push(n(parseFloat(_[1]),parseFloat(_[2]),parseFloat(_[3])));else if(null!==(_=S.exec(x)))v.push(o(parseFloat(_[1]),parseFloat(_[2])));else if(null!==(_=I.exec(x)))d([_[1],_[2],_[3],_[4]]);else if(null!==(_=P.exec(x)))d([_[2],_[5],_[8],_[11]],[_[3],_[6],_[9],_[12]]);else if(null!==(_=A.exec(x)))d([_[2],_[6],_[10],_[14]],[_[3],_[7],_[11],_[15]],[_[4],_[8],_[12],_[16]]);else if(null!==(_=E.exec(x)))d([_[2],_[5],_[8],_[11]],[],[_[3],_[6],_[9],_[12]]);else if("#"===x.charAt(0)&&"o"===x.charAt(2))s(),h+=u.length,u=[],g=new mono.Entity,g._name=x.substring(2).trim(),c.addChild(g);else if(/^g /.test(x))s(x.substring(2).trim(),t);else if(/^usemtl /.test(x))s(t,x.substring(7).trim());else if(/^mtllib /.test(x)){if(i){var T=x.substring(7);T=T.trim(),i(T)}}else/^s /.test(x)}return s(t,t),c}})}(window);
var demo={
	LAZY_MIN: 1000,
	LAZY_MAX: 6000,
	CLEAR_COLOR: '#39609B',	
	RES_PATH: 'res',
	
	lastElement: null,
	timer: null,
	
	getRes: function(file){
		return demo.RES_PATH+'/'+file;
	},

	getEnvMap: function(){
		if(!demo.defaultEnvmap){			
			demo.defaultEnvmap=[];
			var image=demo.getRes('room.jpg');
			for(var i=0;i<6;i++){
				demo.defaultEnvmap.push(image);
			}
		}
		return demo.defaultEnvmap;
	},
	
	//all registered object creaters.
	_creators: {},

	//all registered object filters.
	_filters: {},

	//all registered shadow painters.
	_shadowPainters: {},

	registerCreator: function(type, creator){
		this._creators[type] = creator;
	},
	
	getCreator: function(type){
		return this._creators[type];
	},
	
	registerFilter: function(type, filter){
		this._filters[type] = filter;
	},
	
	getFilter: function(type){
		return this._filters[type];
	},

	registerShadowPainter: function(type, painter){
		this._shadowPainters[type] = painter;
	},
	
	getShadowPainter: function(type){
		return this._shadowPainters[type];
	},
	
	init: function(htmlElementId){				
		var gl3dview= new mono.Gl3dview3D();
		demo.typeFinder = new mono.QuickFinder(gl3dview.getServa(), 'type', 'client');

		var gleye = new mono.PerspectiveGleye(30, 1.5, 30, 30000);		
		gl3dview.setGleye(gleye);
		
		var interaction = new mono.DefaultInteraction(gl3dview);
		interaction.yLowerLimitAngle=Math.PI/180*2;
		interaction.yUpLimitAngle=Math.PI/2;
		interaction.maxDistance=10000;
		interaction.minDistance=50;
		interaction.zoomSpeed=3;
		interaction.panSpeed=0.2;

		var editInteraction = new mono.EditInteraction(gl3dview);
		editInteraction.setShowHelpers(true);
        editInteraction.setScaleable(false);
        editInteraction.setRotateable(false);
        editInteraction.setTranslateable(true);

		gl3dview.setInteractions([interaction, new mono.SelectionInteraction(gl3dview), editInteraction]);

		gl3dview.isSelectable = function(element){
			return gl3dview.moveView && element.getClient('type') === 'rack';
		};	
		gl3dview.editableFunction = function(element){
			return gl3dview.moveView && element.getClient('type') === 'rack';
		}	
		document.getElementById(htmlElementId).appendChild(gl3dview.getRootView());
		var tooltip = new Tooltip(['BusinessId'],['000000']);
		document.body.appendChild(tooltip.getView());

		var personLoaded = false;
		
		var buttons=[{
			label: '场景复位',
			icon: 'reset.png',
			clickFunction: function(){							
				demo.resetView(gl3dview);
			},
		},{
			label: '走线管理',
			icon: 'connection.png',
			clickFunction: function(){
				var showing=gl3dview.connectionView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleConnectionView(gl3dview);
				}
			}
		},{
			label: '人工路径',
			icon: 'person.png',
			clickFunction: function(){
				demo.togglePersonVisible(personLoaded, gl3dview);
				personLoaded = !personLoaded;
			}
		},{
			label: '调试信息',
			icon: 'fps.png',
			clickFunction: function(){
				demo.toggleFpsView(gl3dview);
			}
		},{
			label: '拖拽机柜',
			icon: 'edit.png',
			clickFunction: function(){
				var showing=gl3dview.moveView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleMoveView(gl3dview);
				}
			}
		},{
			label: '温度图',
			icon: 'temperature.png',
			clickFunction: function(){				
				var showing=gl3dview.temperatureView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleTemperatureView(gl3dview);
				}
			}
		},{
			label: '可用空间',
			icon: 'space.png',
			clickFunction: function(){			
				var showing=gl3dview.spaceView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleSpaceView(gl3dview);
				}
			}
		},{
			label: '机柜利用率',
			icon: 'usage.png',
			clickFunction: function(){
				var showing=gl3dview.usageView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleUsageView(gl3dview);
				}
			}
		},{
			label: '空调风向',
			icon: 'air.png',
			clickFunction: function(){		
				var showing=gl3dview.airView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleAirView(gl3dview);
				}
			}
		},{
			label: '烟雾监控',
			icon: 'smoke.png',
			clickFunction: function(){		
				var showing=gl3dview.smokeView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleSmokeView(gl3dview);
				}
			}
		},{
			label: '漏水监测',
			icon: 'water.png',
			clickFunction: function(){		
				var showing=gl3dview.waterView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleWaterView(gl3dview);
				}
			}
		},{
			label: '防盗监测',
			icon: 'security.png',
			clickFunction: function(){			
				var showing=gl3dview.laserView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.toggleLaserView(gl3dview);
				}
			}
		},{
			label: '供电电缆',
			icon: 'power.png',
			clickFunction: function(){			
				var showing=gl3dview.powerView;
				demo.resetView(gl3dview);
				if(!showing){
					demo.togglePowerView(gl3dview);
				}
			}
		},{
			label: '告警巡航',
			icon: 'alarm.png',
			clickFunction: function(){			
				if(gl3dview.inspecting){
					return;
				}
				demo.resetView(gl3dview);
				demo.resetRackPosition(gl3dview);
				gl3dview.inspecting=true;
				demo.inspection(gl3dview);
			}		
		}];
		demo.setupToolbar(buttons);

		mono.Utils.autoAdjustGl3dviewBounds(gl3dview,document.documentElement,'clientWidth','clientHeight');
		gl3dview.getRootView().addEventListener('dblclick', function(e){
			demo.handleDoubleClick(e, gl3dview);
		});	
		gl3dview.getRootView().addEventListener('mousemove',function(e){
			demo.handleMouseMove(e, gl3dview, tooltip);
		});

		demo.setupLights(gl3dview.getServa());
		gl3dview.getServa().getAlarmBox().addServaChangeListener(function(e){
			var alarm = e.data;
			if(e.kind === 'add'){
				var node = gl3dview.getServa().getDataById(alarm.getElementId());
				node.setStyle('m.alarmColor', null);
			}
		});

		gl3dview.getServa().addDataPropertyChangeListener(function(e){
			var element = e.source, property = e.property, oldValue = e.oldValue, newValue = e.newValue;
			if(property == 'position' && gl3dview.moveView){
				if(oldValue.y != newValue.y){
					element.setPositionY(oldValue.y);
				}
			}

		});
		
		gl3dview.addInteractionListener(function(e){
			if(e.kind == 'liveMoveEnd'){				
				demo.dirtyShadowMap(gl3dview);
			}
		});

		var time1=new Date().getTime();
		demo.loadData(gl3dview);
		var time2=new Date().getTime();		
		console.log('time:  ' + (time2-time1));

		demo.startSmokeAnimation(gl3dview);
		demo.startFpsAnimation(gl3dview);
		demo.resetGleye(gl3dview);
	},
	
	resetGleye: function(gl3dview){
		gl3dview.getGleye().setPosition(2000,1200,3000);
		gl3dview.getGleye().lookAt(new mono.XiangliangThree(0,0,0));
	},

	dirtyShadowMap: function(gl3dview){
		var floor = gl3dview.getServa().shadowHost;
		var floorCombo = demo.typeFinder.findFirst('floorCombo');
		demo.updateShadowMap(floorCombo, floor, floor.getId(),gl3dview.getServa());
	},

	togglePersonVisible: function(visible, gl3dview){
		var gleye = gl3dview.getGleye();
		var databox = gl3dview.getServa();
		if(!visible){
			this.loadObj(gleye, databox);
		}else{
			this.removeObj(databox);
		}
	},

	removeObj: function(box){
		var person = demo.typeFinder.find('person').get(0);
		person.animate.stop();
		box.removeByDescendant(person);

		var trail = demo.typeFinder.find('trail').get(0);
		box.removeByDescendant(trail);
	},
	
	loadObj: function(gleye, box){
		var obj=demo.getRes('worker.obj');
		var mtl=demo.getRes('worker.mtl');               
			
		var loader = new mono.OBJMTLLoader();
		loader.load(obj, mtl, {'worker': demo.getRes('worker.png'),}, function (object) {                    			
			object.setScale(3,3,3);		
			object.setClient('type', 'person');	
			box.addByDescendant(object);
			
			var updater=function(element){
				if(element && element.getChildren()){
					element.getChildren().forEach(function(child){
						child.setStyle('m.normalType', mono.NormalTypeSmooth);
						updater(child);
					});
				}
			}
			updater(object);

			var x=-650, z=600, angle=0;
			object.setPosition(x, 0, z);
			object.setRotationY(angle);
			var points=[[650, 600], [650, -300], [130, -300], [130, -600], [-650, -600], [-650, 580], [-450, 580], [-400, 550]];
			object.animate=demo.createPathAnimates(gleye, object, points);//, true);//, true, 0);
			object.animate.play();

			var path=new mono.Path();
			path.moveTo(object.getPositionX(), object.getPositionZ());
			for(var i=0;i<points.length; i++){
				path.lineTo(points[i][0], points[i][1]);
			}
			path = mono.PathNode.prototype.adjustPath(path, 20);

			var trail=new mono.PathCube(path, 10, 3);
			trail.s({
				'm.type': 'phong',
				'm.specularStrength': 30,
				'm.color': '#298A08',
				'm.ambient': '#298A08', 		
				'm.texture.image': demo.getRes('flow.jpg'),
				'm.texture.repeat': new mono.XiangliangTwo(150, 1),
			});
			trail.setRotationX(Math.PI);
			trail.setPositionY(5);
			trail.setClient('type', 'trail');
			box.add(trail);
		});
	},

	createPathAnimates: function(gleye, element, points, loop, finalAngle){
		var animates=[];		

		if(points && points.length>0){
			var x=element.getPositionX();
			var z=element.getPositionZ();
			var angle=element.getRotationY();

			var createRotateAnimate=function(gleye, element, toAngle, angle){
				if(toAngle!=angle && toAngle!=NaN){
					if(toAngle-angle > Math.PI){
						toAngle-=Math.PI*2;
					}
					if(toAngle-angle < -Math.PI){
						toAngle+=Math.PI*2;
					}
					//console.log(angle, toAngle);
					var rotateAnimate = new twaver.Animate({
						from: angle,
						to: toAngle,
						type: 'number',
						dur: Math.abs(toAngle-angle)*300,
						easing: 'easeNone',
						onUpdate: function(value){
							element.setRotationY(value);
						},
					});
					rotateAnimate.toAngle=toAngle;
					return rotateAnimate;
				}
			}

			for(var i=0;i<points.length;i++){
				var point=points[i];				
				var x1=point[0];
				var z1=point[1];
				var rotate=Math.atan2(-(z1-z), x1-x);
				
				var rotateAnimate=createRotateAnimate(gleye, element, rotate, angle);
				if(rotateAnimate){
					animates.push(rotateAnimate);
					angle=rotateAnimate.toAngle;
				}
				
				var moveAnimate = new twaver.Animate({
					from: {x: x, y: z},
					to: {x: x1, y: z1},
					type: 'point',
					dur: Math.sqrt((x1-x)*(x1-x)+(z1-z)*(z1-z))*5,
					easing: 'easeNone',
					onUpdate: function(value){
						element.setPositionX(value.x);
						element.setPositionZ(value.y);
					},
				});
				animates.push(moveAnimate);				

				x=x1;
				z=z1;
			}			

			if(finalAngle!=undefined && angle!=finalAngle){
				var rotateAnimate=createRotateAnimate(gleye, element, finalAngle, angle);
				if(rotateAnimate){
					animates.push(rotateAnimate);
				}
			}
		}
		var animate;
		for(var i=0;i<animates.length;i++){
			if(i>0){
				animates[i-1].chain(animates[i]);
				if(loop &&i==animates.length-1){
					animates[i].chain(animate);
				}
			}else{
				animate=animates[i];
			}
		}
		return animate;
	},

	toggleConnectionView: function(gl3dview){
		gl3dview.connectionView=!gl3dview.connectionView;

		var connectionView=gl3dview.connectionView;
		var box=gl3dview.getServa();
		var connections = demo.typeFinder.find('connection');
		var rails = demo.typeFinder.find('rail');
		connections.forEach(function(connection){
			connection.setVisible(connectionView);
			if(!connection.billboard){
				connection.billboard=new mono.Billboard();
				connection.billboard.s({
					'm.texture.image': demo.createConnectionBillboardImage('0'),
					'm.vertical': true,
				});
				connection.billboard.setScale(60,30,1);
				connection.billboard.setPosition(400,230,330);
				box.add(connection.billboard);
			}
			connection.billboard.setVisible(connectionView);
			if(connection.isVisible()){
				var offsetAnimate = new twaver.Animate({
					from: 0 ,
					to: 1,
					type: 'number',
					dur: 1000,
					repeat:Number.POSITIVE_INFINITY,
					reverse: false,
					onUpdate: function(value){
						connection.s({
							'm.texture.offset': new mono.XiangliangTwo(value, 0),
						});
						if(value===1){
							var text='54'+parseInt(Math.random()*10)+'.'+parseInt(Math.random()*100);
							connection.billboard.s({
								'm.texture.image': demo.createConnectionBillboardImage(text),
							});
						}
					},
				});
				offsetAnimate.play();
				connection.offsetAnimate = offsetAnimate;
			}else{
				if(connection.offsetAnimate){
					connection.offsetAnimate.stop();
				}
			}
		});
		rails.forEach(function(rail){
			rail.setVisible(connectionView);
		});
	},

	setupLights: function(box){
		var pointLight = new mono.PointLight(0xFFFFFF,0.3);
		pointLight.setPosition(0,1000,-1000);
		box.add(pointLight);     
		
		var pointLight = new mono.PointLight(0xFFFFFF,0.3);
		pointLight.setPosition(0,1000,1000);
		box.add(pointLight);        

		var pointLight = new mono.PointLight(0xFFFFFF,0.3);
		pointLight.setPosition(1000,-1000,1000);
		box.add(pointLight);        

		box.add(new mono.AmbientLight('white'));	
	},

	handleDoubleClick: function(e, gl3dview){
		var gleye=gl3dview.getGleye();
		var interaction=gl3dview.getDefaultInteraction();
		var firstClickObject=demo.findFirstObjectByMouse(gl3dview,e);
		if(firstClickObject){
			var element=firstClickObject.element;		
			var newTarget=firstClickObject.point;
			var oldTarget=gleye.getTarget();
			demo.animateGleye(gleye, interaction, oldTarget, newTarget, function(){
				if(element.getClient('animation')){
					demo.playAnimation(element, element.getClient('animation'));
				}				
			});
			if(element.getClient('dbl.func')){				
				var func=element.getClient('dbl.func');
				func();
			}
		}else{
			var oldTarget=gleye.getTarget();
			var newTarget=new mono.XiangliangThree(0,0,0);
			demo.animateGleye(gleye, interaction, oldTarget, newTarget);
		}
	},

	//鼠标移动到网元上1S后显示tooltip
    handleMouseMove: function(e, gl3dview, tooltipObj){ 
        var objects = gl3dview.getElementsByMouseEvent(e);
        //获取当前网元，如果当前鼠标下有对象并且类型为group，那么就设置currentElement为鼠标下的网元
        var currentElement = null;
        var tooltip = tooltipObj.getView();
        // var tooltip = document.getElementById('tooltip');
        if (objects.length) {           
            var first = objects[0];
            var object3d = first.element;
            if(object3d.getClient('type') === 'card' && object3d.getClient('isAlarm')){ 
                currentElement = object3d;
                tooltipObj.setValues([object3d.getClient('BID')]);
            }
        }
        //如果当前和上一次的网元不一致，先清除timer。
        //如果当前网元有值，起一个timer，2S后显示tooltip。
        //tooltip显示的位置为最近一次鼠标移动时的位置
        if (demo.lastElement != currentElement ) {
            clearTimeout(demo.timer);
            if(currentElement){
               demo.timer = setTimeout(function(){
                    tooltip.style.display = 'block';
                    tooltip.style.position = 'absolute';
                    tooltip.style.left = (window.lastEvent.pageX - tooltip.clientWidth/2) + 'px';
                    tooltip.style.top = (window.lastEvent.pageY - tooltip.clientHeight - 15) + 'px';
                },1000); 
            }     
        }
        //设置上一次的网元为当前网元
        demo.lastElement = currentElement; 
        //如果当前鼠标下没有网元，隐藏tooltip
        if(currentElement == null){
            tooltip.style.display = 'none';
        }
        //设置每次移动时鼠标的事件对象
        window.lastEvent = e;
    },

	copyProperties: function(from, to, ignores){
		if(from && to){
			for(var name in from){
				if(ignores && ignores.indexOf(name)>=0){
					//ignore.
				}else{
					to[name]=from[name];
				}
			}
		}
	},

	createCubeObject: function(json){
		var translate=json.translate || [0,0,0];
		var width=json.width;
		var height=json.height;
		var depth=json.depth;
		var sideColor=json.sideColor;
		var topColor=json.topColor;

		var object3d=new mono.Cube(width, height, depth);				
		object3d.setPosition(translate[0], translate[1]+height/2, translate[2]);					
		object3d.s({
			'm.color': sideColor,
			'm.ambient': sideColor,
			'left.m.lightmap.image': demo.getRes('inside_lightmap.jpg'),
			'right.m.lightmap.image': demo.getRes('outside_lightmap.jpg'),
			'front.m.lightmap.image': demo.getRes('outside_lightmap.jpg'),
			'back.m.lightmap.image': demo.getRes('inside_lightmap.jpg'),
			'top.m.color': topColor,
			'top.m.ambient': topColor,						
			'bottom.m.color': topColor,
			'bottom.m.ambient': topColor,						
		});

		return object3d;
	},
	
	create2DPath: function(pathData) {
		var path;
		for(var j=0;j<pathData.length;j++){
			var point=pathData[j];
			if(path){
				path.lineTo(point[0],point[1], 0);
			}else{
				path=new mono.Path();
				path.moveTo(point[0],point[1], 0);
			}
		}

		return path;
	},
	
	create3DPath: function(pathData) {
		var path;
		for(var j=0;j<pathData.length;j++){
			var point=pathData[j];
			if(path){
				path.lineTo(point[0],point[1], point[2]);
			}else{
				path=new mono.Path();
				path.moveTo(point[0],point[1], point[2]);
			}
		}

		return path;
	},

	createPathObject: function(json){
		var translate=json.translate || [0,0,0];
		var pathWidth=json.width;
		var pathHeight=json.height;		
		var pathData=json.data;					
		var path=this.create2DPath(pathData);
		var pathInsideColor=json.insideColor;
		var pathOutsideColor=json.outsideColor;
		var pathTopColor=json.topColor;
		
		var object3d=this.createWall(path, pathWidth, pathHeight, pathInsideColor, pathOutsideColor, pathTopColor);
		object3d.setPosition(translate[0], translate[1], -translate[2]);	
		object3d.shadow=json.shadow;

		return object3d;
	},

	filterJson: function(box, objects){
		var newObjects=[];

		for(var i=0; i<objects.length; i++){
			var object=objects[i];
			var type=object.type;
			var filter=this.getFilter(type);
			if(filter){
				var filteredObject=filter(box, object);
				if(filteredObject){
					if(filteredObject instanceof Array){
						newObjects=newObjects.concat(filteredObject);						
					}else{
						this.copyProperties(object, filteredObject, ['type']);
						newObjects.push(filteredObject);
					}
				}
			}else{
				newObjects.push(object);				
			}
		}
		
		return newObjects;
	},

	createCombo: function(parts){
		var children=[];		
		var ops=[];
		var ids=[];
		for(var i=0;i<parts.length;i++){
			var object=parts[i];
			var op=object.op || '+';
			var style=object.style;
			var translate=object.translate || [0,0,0];
			var rotate=object.rotate || [0,0,0];
			var object3d=null;
			if(object.type==='path'){				
				object3d=this.createPathObject(object);
			}
			if(object.type==='cube'){
				object3d=this.createCubeObject(object);
			}			
			if(object3d){
				object3d.setRotation(rotate[0], rotate[1], rotate[2]);
				if(style){
					object3d.s(style);
				}						
				children.push(object3d);
				if(children.length>1){
					ops.push(op);
				}
				ids.push(object3d.getId());
			}
		}

		if(children.length>0){
			var combo=new mono.ComboNode(children, ops);
			combo.setNames(ids);
			return combo;
		}
		return null;
	},

	loadData: function(gl3dview){
		var json= demo.filterJson(gl3dview.getServa(), dataJson.objects);
		var box=gl3dview.getServa();

		gl3dview.setClearColor(demo.CLEAR_COLOR);

		var children=[];
		var ops=[];
		var ids=[];
		var shadowHost;
		var shadowHostId;
		for(var i=0;i<json.length;i++){
			var object=json[i];
			var op=object.op;
			var style=object.style;
			var client=object.client;
			var translate=object.translate || [0,0,0];
			var rotate=object.rotate || [0,0,0];
			var object3d=null;

			if(object.type==='path'){				
				object3d=this.createPathObject(object);
			}
			if(object.type==='cube'){
				object3d=this.createCubeObject(object);				
			}

			if(object.shadowHost){
				shadowHost=object3d;
				shadowHostId=object3d.getId();
				box.shadowHost = shadowHost;
			}

			var creator=demo.getCreator(object.type);
			if(creator){
				creator(box, object);
				continue;
			}

			if(object3d){
				object3d.shadow = object.shadow;
				object3d.setRotation(rotate[0], rotate[1], rotate[2]);
				if(style){
					object3d.s(style);
				}		
				if(client){
					for(var key in client){
						object3d.setClient(key,client[key]);		
					}
				}	
				if(op){
					children.push(object3d);
					if(children.length>1){
						ops.push(op);
					}
					ids.push(object3d.getId());
				}else{						
					box.add(object3d);
				}
			}
		}
		
		if(children.length>0){
			var combo=new mono.ComboNode(children, ops);			
			combo.setNames(ids);
			combo.setClient('type', 'floorCombo');
			box.add(combo);

			//lazy load floor shadow map.
			if(shadowHost && shadowHostId){
				setTimeout(function(){demo.updateShadowMap(combo, shadowHost, shadowHostId,box)}, demo.LAZY_MAX);
			}
		}
	},

	updateShadowMap: function(combo, shadowHost, shadowHostId,box){					
		var shadowMapImage=demo.createShadowImage(box, shadowHost.getWidth(), shadowHost.getDepth());
		var floorTopFaceId=shadowHostId+'-top.m.lightmap.image';						
		combo.setStyle(floorTopFaceId, shadowMapImage);
	},

	loadRackContent: function(box, x, y, z, width, height, depth, severity, cube, cut, json, parent, oldRack){
		var positionY=10;
		var serverTall=9;
		var serverGap=2;
		var findFaultServer=false;
		while(positionY<height-20){
			var number = parseInt(Math.random()*3)+1;
			var pic='server'+number+'.jpg';
			if(number === 3 ){
				pic='server3.png';
			}
			
			var color= (number === 3 || positionY>100) && !findFaultServer && severity ? severity.color : null;
			var server=this.createServer(box, cube, cut, pic, color, oldRack);

			var size = server.getBizBox().size();
			if(color){
				findFaultServer=true;
			}
			server.setPositionY(positionY + size.y/2 - height/2);
			server.setPositionZ(server.getPositionZ()+5);	
			server.setParent(parent);
			positionY = positionY + size.y + serverGap;
			if(positionY>200){
				box.removeByDescendant(server,true);
				break;
			}

		}
	},

	createServer: function(box, cube, cut, pic, color, oldRack){
		var picMap = {
			'server1.jpg': 4.445*2,
			'server2.jpg': 4.445*3,
			'server3.png': 4.445*6,
		}
		var x=cube.getPositionX();
		var z=cube.getPositionZ();
		var width=cut.getWidth();
		var height = picMap[pic];
		var depth=cut.getDepth();

		var serverBody=new mono.Cube(width-2, height-2, depth-4);
		var bodyColor=color?color:'#5B6976';
		serverBody.s({
			'm.color': bodyColor,
			'm.ambient': bodyColor,
			'm.type':'phong',
			'm.texture.image': demo.getRes('rack_inside.jpg'),
		});
		serverBody.setPosition(0, 0.5, (cube.getDepth()-serverBody.getDepth())/2);

		var serverPanel=new mono.Cube(width+2, height+1, 0.5);
		color=color?color:'#FFFFFF';
		serverPanel.s({			
			'm.texture.image': demo.getRes('rack_inside.jpg'),
			'front.m.texture.image': demo.RES_PATH + '/' +pic,
			'front.m.texture.repeat': new mono.XiangliangTwo(1,1),
			'm.specularStrength': 100,
			'm.transparent': true,
			'm.color': color,
			'm.ambient': color,
		});
		serverPanel.setPosition(0, 0, serverBody.getDepth()/2+(cube.getDepth()-serverBody.getDepth())/2);
		if(pic == 'server3.png'){
			var serverColor = '#FFFFFF';
			serverPanel.s({
				'm.color': serverColor,
				'm.ambient': serverColor,
			});
		}

		var server=new mono.ComboNode([serverBody, serverPanel], ['+']);
		server.setClient('animation', 'pullOut.z');
		server.setPosition(0.5, 0, -5);
		box.add(server);

		if(pic == 'server3.png'){
			var isRendered = false;
			var xoffset = 2.1008, yoffset = 0.9897;
			var width = width + 2;
			var height = height +1;
			var cardWidth = (width - xoffset*2)/14;
			var count = 14;

			for(var i = 0; i< count; i++){
				var cardColor = '#FFFFFF';
				if(i > 5 && !isRendered) {
					cardColor = color;
					isRendered = true;
				}
				var params={
					'height': height-yoffset*2, 
					'width': cardWidth, 
					'depth':depth*0.4, 
					'pic': demo.RES_PATH + '/'+ 'card'+(i%4+1) +'.png',
					'color': cardColor
				};
				var card=demo.createCard(params);
				box.add(card);

				card.setParent(server);	
				card.setClient('type','card');	
				card.setClient('BID','card-'+i);	
				card.setClient('isAlarm', cardColor != '#FFFFFF');				
		  		card.p(-width/2 + xoffset + (i+0.5) * cardWidth,-height/2+yoffset,serverPanel.getPositionZ()-1);
		  		card.setClient('animation', 'pullOut.z');

				if(card.getClient('isAlarm')){
					oldRack.alarmCard=card;					
				}
		  	}
		}
		return server;
	},

	createCard: function(json){
		var translate=json.translate || [0,0,0];
		var x=translate[0],
			y=translate[1],
			z=translate[2];
		var width=json.width || 10,
			height=json.height || 50,
			depth=json.depth || 50;	
		var rotate=json.rotate || [0,0,0];
		var color = json.color || 'white';
		var pic = json.pic || demo.getRes('card1.png');

		var parts=[{
			//card panel
			type: 'cube',
			width: width,
			height: height,
			depth: 1,
			translate: [x, y, z+1],
			rotate: rotate,
			op: '+',			
			style:{
				'm.color': color,
				'm.ambient': color,
				'm.texture.image': demo.getRes('gray.png'),
				'front.m.texture.image': pic,
				'back.m.texture.image': pic,
			}
		},{
			//card body
			type: 'cube',
			width: 1,
			height: height*0.95,
			depth: depth,
			translate: [x, y, z-depth/2+1],
			rotate: rotate,
			op: '+',
			style:{
				'm.color': color,
				'm.ambient': color,
				'm.texture.image': demo.getRes('gray.png'),
				'left.m.texture.image': demo.getRes('card_body.png'),
				'right.m.texture.image': demo.getRes('card_body.png'),
				'left.m.texture.flipX': true,
				'm.transparent': true,	
				'm.lightmap.image':demo.getRes('outside_lightmap.jpg'),
			} 
		}];
		
		return demo.createCombo(parts);
	},	

	createShadowImage: function(box, floorWidth, floorHeight){			
		var canvas = document.createElement('canvas');
		canvas['width']=floorWidth;
		canvas['height']=floorHeight;
		var context = canvas.getContext('2d');
		context.beginPath();
		context.rect(0, 0, floorWidth, floorHeight);
		context.fillStyle = 'white';
		context.fill();

		var marker=function(context, text, text2, x, y){
			var color='#0B2F3A';//'#0B2F3A';//'#FE642E';
			context.font = 60+'px "Microsoft Yahei" bold';
			context.fillStyle = color;
			context.textAlign = 'center';
			context.textBaseline = 'middle';		
			//context.shadowBlur = 30;
			context.fillText(text, x, y);
			context.strokeStyle=color;
			context.lineWidth=3;			
			context.strokeText(text, x, y);

			if(!text2) return;
			y+=52;
			color='#FE642E';
			context.font = 26+'px "Microsoft Yahei" ';
			context.fillStyle = color;
			context.textAlign = 'center';
			context.textBaseline = 'middle';		
			context.fillText(text2, x, y);
		}
		marker(context, '阿里巴巴', '192.168.1.100', 530, 500);
		marker(context, '乐视', '192.168.1.150', 590, 1000);
		marker(context, '亚马逊', 'ip待分配', 1020, 1000);

		box.forEach(function(object){
			if(object instanceof mono.Entity && object.shadow){
				var translate=object.getPosition() || {x:0, y:0, z:0};	
				var rotate=object.getRotation() || {x:0, y:0, z:0};
				var rotate=-rotate[1];

				demo.paintShadow(object, context, floorWidth, floorHeight, translate, rotate);
			}
		});
		
		return canvas;
	},

	paintShadow: function(object, context, floorWidth, floorHeight, translate, rotate){
		var type=object.getClient('type');
		var shadowPainter=demo.getShadowPainter(type);

		if(shadowPainter){
			shadowPainter(object, context, floorWidth, floorHeight, translate, rotate);
		}
	},	
	
	findFirstObjectByMouse: function(gl3dview, e){
		var objects = gl3dview.getElementsByMouseEvent(e);
		if (objects.length) {
			for(var i=0;i<objects.length;i++){			
				var first = objects[i];
				var object3d = first.element;
				if(! (object3d instanceof mono.Billboard)){
					return first;
				}
			}
		}
		return null;
	},

	animateGleye: function(gleye, interaction, oldPoint, newPoint, onDone){
		//twaver.Util.stopAllAnimates(true);
		
		var offset=gleye.getPosition().sub(gleye.getTarget());
		var animation=new twaver.Animate({
			from: 0,
			to: 1,
			dur: 500,
			easing: 'easeBoth',
			onUpdate: function (value) {
				var x=oldPoint.x+(newPoint.x-oldPoint.x)*value;
				var y=oldPoint.y+(newPoint.y-oldPoint.y)*value;
				var z=oldPoint.z+(newPoint.z-oldPoint.z)*value;
				var target=new mono.XiangliangThree(x,y,z);				
				gleye.lookAt(target);
				interaction.target=target;
				var position=new mono.XiangliangThree().addVectors(offset, target);
				gleye.setPosition(position);
			},
		});
		animation.onDone=onDone;
		animation.play();
	},
	
	playAnimation: function(element, animation, done){
		var params=animation.split('.');
		if(params[0]==='pullOut'){
			var direction=params[1];
			demo.animatePullOut(element, direction, done);
		}
		if(params[0]==='rotate'){
			var anchor=params[1];
			var angle=params[2];
			var easing=params[3];
			demo.animateRotate(element, anchor, angle, easing, done);
		}		
	},

	animatePullOut: function(object, direction, done){
		//twaver.Util.stopAllAnimates(true);

		var size=object.getBizBox().size().multiply(object.getScale());

		var movement=0.8;
		
		var directionVec=new mono.XiangliangThree(0, 0, 1);
		var distance=0;
		if(direction==='x'){
			directionVec=new mono.XiangliangThree(1, 0, 0);
			distance=size.x;
		}
		if(direction==='-x'){
			directionVec=new mono.XiangliangThree(-1, 0, 0);
			distance=size.x;
		}
		if(direction==='y'){
			directionVec=new mono.XiangliangThree(0, 1, 0);
			distance=size.y;
		}
		if(direction==='-y'){
			directionVec=new mono.XiangliangThree(0, -1, 0);
			distance=size.y;
		}
		if(direction==='z'){
			directionVec=new mono.XiangliangThree(0, 0, 1);
			distance=size.z;
		}
		if(direction==='-z'){
			directionVec=new mono.XiangliangThree(0, 0, -1);
			distance=size.z;
		}

		distance=distance*movement;
		if(object.getClient('animated')){
			directionVec=directionVec.negate();
		}

		var fromPosition=object.getPosition().clone();		
		object.setClient('animated', !object.getClient('animated'));

		new twaver.Animate({
			from: 0,
			to: 1,
			dur: 2000,
			easing: 'bounceOut',			
			onUpdate: function (value) {
				//don't forget to clone new instance before use them!
				object.setPosition(fromPosition.clone().add(directionVec.clone().multiplyScalar(distance * value)));
			},
			onDone: function(){
				demo.animationFinished(object);			

				if(done) {
					done();
				}
			},
		}).play();
	},

	animateRotate: function(object, anchor, angle, easing, done){
		//twaver.Util.stopAllAnimates(true);
		easing = easing || 'easeInStrong';

		var size=object.getBizBox().size().multiply(object.getScale());
		
		var from=0;
		var to=1;
		if(object.getClient('animated')){
			to=-1;
		}
		object.setClient('animated', !object.getClient('animated'));
		
		var position;
		var axis;
		if(anchor==='left'){
			position=new mono.XiangliangThree(-size.x/2, 0, 0);
			var axis=new mono.XiangliangThree(0,1,0);
		}
		if(anchor==='right'){
			position=new mono.XiangliangThree(size.x/2, 0, 0);
			var axis=new mono.XiangliangThree(0,1,0);
		}

		var animation=new twaver.Animate({
			from: from,
			to: to,
			dur: 1500,
			easing: easing,
			onUpdate: function (value) {					
				if(this.lastValue===undefined){
					this.lastValue=0;
				}
				object.rotateFromAxis(axis.clone(), position.clone(), Math.PI/180*angle*(value-this.lastValue));
				this.lastValue=value;
			},
			onDone: function(){
				delete this.lastValue;
				demo.animationFinished(object);

				if(done) {
					done();
				}
			},
		});
		animation.play();
	},
	
	animationFinished: function(element){
		var animationDoneFuc=element.getClient('animation.done.func');
		if(animationDoneFuc){
			animationDoneFuc();
		}
	},

	getRandomInt: function(max){
		return parseInt(Math.random()*max);
	},
	
	getRandomLazyTime: function(){
		var time=demo.LAZY_MAX-demo.LAZY_MIN;
		return demo.getRandomInt(time)+demo.LAZY_MIN;
	},

	generateAssetImage: function(text){         
		var width=512, height=256;

		var canvas = document.createElement('canvas');
		canvas.width  = width;
		canvas.height = height;

		var ctx = canvas.getContext('2d');		
		ctx.fillStyle='white';
		ctx.fillRect(0,0,width,height);
		
		ctx.font = 150+'px "Microsoft Yahei" bold';
		ctx.fillStyle = 'black';
		ctx.textAlign = 'center';
		ctx.textBaseline = 'middle';
		ctx.fillText(text, width/2,height/2);
		ctx.strokeStyle='black';
		ctx.lineWidth=15;
		ctx.strokeText(text, width/2,height/2);

		return canvas;   
	},

	toggleTemperatureView: function(gl3dview){
		gl3dview.temperatureView=!gl3dview.temperatureView;

		gl3dview.getServa().forEach(function(element){						
			var type=element.getClient('type');

			if(type==='rack' || type==='rack.door'){	
				element.setVisible(!gl3dview.temperatureView);
				if(type==='rack'){
					if(!element.temperatureFake){
						var fake=new mono.Cube(element.getWidth(), element.getHeight(), element.getDepth());
						element.temperatureFake = fake;
						var sideImage=demo.createSideTemperatureImage(element, 3+Math.random()*10);
						fake.s({
							'm.texture.image': sideImage,
							'top.m.texture.image': element.getStyle('top.m.texture.image'),
							'top.m.normalmap.image':demo.getRes('metal_normalmap.jpg'),
							'top.m.specularmap.image': element.getStyle('top.m.texture.image'),
							'top.m.envmap.image': demo.getEnvMap(),
							'top.m.type':'phong',
						});								
						gl3dview.getServa().add(fake);
					}
					element.temperatureFake.setPosition(element.getPosition());
					element.temperatureFake.setVisible(gl3dview.temperatureView);
				}
			}
		});
		if(gl3dview.temperatureView){
			demo.createTemperatureBoard(gl3dview.getServa());
			demo.createTemperatureWall(gl3dview.getServa());
		}else{
			gl3dview.getServa().remove(gl3dview.getServa().temperaturePlane);
			delete gl3dview.getServa().temperaturePlane;
			gl3dview.getServa().remove(gl3dview.getServa().temperatureWall);
			delete gl3dview.getServa().temperatureWall;
		}
	},

	createTemperatureBoard: function(box){
		var floor=box.shadowHost;
		var board = new TemperatureBoard(512,512,'h', 20);

		box.forEach(function(element){						
			var type=element.getClient('type');
			if(type==='rack'){
				var x=element.getPositionX()/floor.getWidth()*512+256;
				var y=element.getPositionZ()/floor.getDepth()*512+256;
				var value=0.1+Math.random()*0.3;
				var width=element.getWidth()/floor.getWidth()*512;
				var depth=element.getDepth()/floor.getWidth()*512;

				board.addPoint(x-width/2,y+depth/2,value);
				board.addPoint(x+width/2,y+depth/2,value);
				board.addPoint(x-width/2,y-depth/2,value);
				board.addPoint(x+width/2,y-depth/2,value);
				board.addPoint(x,y,value);				
			}
		});

		var image = board.getImage();
		
		var plane=new mono.Plane(floor.getWidth(), floor.getDepth());
		plane.s({
			'm.texture.image': image,
			'm.transparent': true,
			'm.side': mono.DoubleSide,
			'm.type': 'phong',
		});
		plane.setPositionY(10);
		plane.setRotationX(-Math.PI/2);
		box.add(plane);
		
		box.temperaturePlane=plane;
	},

	createTemperatureWall: function(box){		
		var cube=new mono.Cube(990, 200, 10);
		cube.s({
			'm.visible': false,
		});
		cube.s({
			'front.m.visible': true,
			'm.texture.image': demo.getRes('temp1.jpg'),
			'm.side': mono.DoubleSide,
			'm.type': 'phong',
		});
		cube.setPosition(0, cube.getHeight()/2, 400);
		cube.setRotationX(Math.PI);
		box.add(cube);
		
		box.temperatureWall=cube;
	},	
	
	createSideTemperatureImage: function(rack, count){
		var width=2;
		var height=rack.getHeight();
		var step=height/count;
		var board = new TemperatureBoard(width,height,'v', height/count);		

		for(var i=0;i<count;i++){		
			var value=0.3+Math.random()*0.2;
			if(value<4){
				value=Math.random()*0.9;
			}
			board.addPoint(width/2,step*i,value);
		};

		return board.getImage();
	},

	toggleSpaceView: function(gl3dview){
		gl3dview.spaceView=!gl3dview.spaceView;

		gl3dview.getServa().forEach(function(element){						
			var type=element.getClient('type');

			if(type==='rack' || type==='rack.door'){	
				element.setVisible(!gl3dview.spaceView);
				if(type==='rack'){
					if(!element.spaceCubes){
						element.spaceCubes=demo.createRackSpaceCubes(gl3dview.getServa(), element);
					}
					for(var i=0;i<element.spaceCubes.length;i++){
						element.spaceCubes[i].setPosition(element.getPositionX(), 
							element.spaceCubes[i].getPositionY(),
							element.getPositionZ());
						element.spaceCubes[i].setVisible(gl3dview.spaceView);
					}
				}
			}
		});
	},

	createRackSpaceCubes: function(box, rack){	
		var cubes=[];
		var width=rack.getWidth();
		var height=rack.getHeight();
		var depth=rack.getDepth();

		var total=42;
		var step=height/total;
		var index=0;

		var colors=['#8A0808', '#088A08', '#088A85', '#6A0888','#B18904'];

		var solid=false;
		while(index<42){
			var size=parseInt(1+Math.random()*5);
			solid=!solid;
			var color=solid? colors[size-1] : '#A4A4A4';
			if(solid){
				size*=2;
			}else{
				size*=4;
			}
			if(index+size>total){
				size=total-index;
			}
			
			var cube=new mono.Cube(width, step*size-2, depth);
			var y=(index+size/2)*step;
			cube.setPosition(rack.getPositionX(), y, rack.getPositionZ());
			cube.s({
				'm.type': 'phong',
				'm.color': color,
				'm.ambient': color,
				'm.specularStrength': 50,
			});
			if(solid){
				cube.s({
					'm.transparent': true,
					'm.opacity': 0.6,
				});				
			}			
			box.add(cube);
			cubes.push(cube);

			index+=size;
		}
		return cubes;
	},

	toggleUsageView: function(gl3dview){
		gl3dview.usageView=!gl3dview.usageView;

		gl3dview.getServa().forEach(function(element){						
			var type=element.getClient('type');

			if(type==='rack' || type==='rack.door'){	
				element.setVisible(!gl3dview.usageView);
				if(type==='rack'){
					if(!element.usageFakeTotal){
						var usage=Math.random();
						var color=demo.getHSVColor((1-usage)*0.7, 0.7, 0.7);

						var usageFakeTotal=new mono.Cube(element.getWidth(), element.getHeight(), element.getDepth());
						element.usageFakeTotal = usageFakeTotal;
						usageFakeTotal.s({
							'm.wireframe': true,
							'm.transparent': true,
							'm.opacity': 0.2,
						});		
						usageFakeTotal.setPosition(element.getPosition());
						gl3dview.getServa().add(usageFakeTotal);
						
						var height=element.getHeight()*usage;

						var usageFakeUsed=new mono.Cube(element.getWidth(), 0, element.getDepth());
						element.usageFakeUsed = usageFakeUsed;						
						usageFakeUsed.s({
							'm.type': 'phong',
							'm.color': color,
							'm.ambient': color,
							'm.specularStrength': 20,
							'left.m.lightmap.image': demo.getRes('inside_lightmap.jpg'),
							'right.m.lightmap.image': demo.getRes('inside_lightmap.jpg'),
							'back.m.lightmap.image': demo.getRes('inside_lightmap.jpg'),
							'front.m.lightmap.image': demo.getRes('inside_lightmap.jpg'),
						});		
						usageFakeUsed.setPosition(element.getPosition());
						usageFakeUsed.setPositionY(0);
						gl3dview.getServa().add(usageFakeUsed);

						var usageAnimation=new twaver.Animate({
							from: 0,
							to: height,
							type: 'number',
							dur: 2000,
							delay: Math.random()*200,
							easing: 'bounceOut',
							onUpdate: function(value){
								usageFakeUsed.setHeight(value);
								usageFakeUsed.setPositionY(usageFakeUsed.getHeight()/2);
							},
						});
						element.usageAnimation=usageAnimation;
					}

					element.usageFakeTotal.setVisible(gl3dview.usageView);
					element.usageFakeUsed.setVisible(gl3dview.usageView);
					element.usageFakeTotal.setPosition(element.getPosition().clone());
					element.usageFakeUsed.setHeight(0);
					element.usageFakeUsed.setPosition(element.getPosition().clone());
					element.usageFakeUsed.setPositionY(0);

					if(gl3dview.usageView){
						element.usageAnimation.play();
					}else{
						element.usageAnimation.stop();
					}
				}
			}
		});
	},

	toggleAirView: function(gl3dview){
		gl3dview.airView=!gl3dview.airView;

		if(!gl3dview.getServa().airPlanes){
			gl3dview.getServa().airPlanes=demo.createAirPlanes();
		}

		for(var i=0;i<gl3dview.getServa().airPlanes.length;i++){
			var plane=gl3dview.getServa().airPlanes[i];
			if(gl3dview.airView){
				gl3dview.getServa().add(plane);
				plane.airAnimation.play();
			}else{
				gl3dview.getServa().remove(plane);
				plane.airAnimation.stop();
			}
		}		
	},

	toggleMoveView: function(gl3dview){
		gl3dview.getServa().getSelectionContainer().clearSelection();
		gl3dview.moveView=!gl3dview.moveView;
		gl3dview.dirtyGl3dview();
	},

	/* h, s, v (0 ~ 1) */
	getHSVColor: function (h, s, v) {
		var r, g, b, i, f, p, q, t;
		if (h && s === undefined && v === undefined) {
			s = h.s, v = h.v, h = h.h;
		}
		i = Math.floor(h * 6);
		f = h * 6 - i;
		p = v * (1 - s);
		q = v * (1 - f * s);
		t = v * (1 - (1 - f) * s);
		switch (i % 6) {
			case 0: r = v, g = t, b = p; break;
			case 1: r = q, g = v, b = p; break;
			case 2: r = p, g = v, b = t; break;
			case 3: r = p, g = q, b = v; break;
			case 4: r = t, g = p, b = v; break;
			case 5: r = v, g = p, b = q; break;
		}
		var rgb='#'+this.toHex(r * 255)+this.toHex(g * 255)+this.toHex(b * 255);
		return rgb;
	},

	toHex: function (value){
		var result=parseInt(value).toString(16);
		if(result.length==1){
			result='0'+result;
		}
		return result;
	},
	
	showDialog: function(content, title, width, height) {
		title= title || '';
		width=width || 600;
		height=height || 400;
		var div=document.getElementById('dialog');
		if(div){
			document.body.removeChild(div);
		}
		div=document.createElement('div');
		div.setAttribute('id', 'dialog');

		div.style.display = 'block';
		div.style.position = 'absolute';
		div.style.left = '100px';
		div.style.top = '100px';
		div.style.width=width+'px';
		div.style.height=height+'px';
		div.style.background='rgba(164,186,223,0.75)';						
		div.style['border-radius']='5px';
		document.body.appendChild(div);

		var span=document.createElement('span');
		span.style.display = 'block';
		span.style['color']='white';
		span.style['font-size']='13px';
		span.style.position = 'absolute';
		span.style.left = '10px';
		span.style.top = '2px';
		span.innerHTML=title;
		div.appendChild(span);

		var img=document.createElement('img');
		img.style.position = 'absolute';
		img.style.right= '4px';
		img.style.top = '4px';
		img.setAttribute('src', demo.getRes('close.png'));
		img.onclick = function () {
			document.body.removeChild(div);
		};
		div.appendChild(img);

		if(content){
			content.style.display = 'block';
			content.style.position = 'absolute';
			content.style.left = '3px';
			content.style.top = '24px';
			content.style.width=(width-6)+'px';
			content.style.height=(height-26)+'px';
			div.appendChild(content);
		}
	},

	showVideoDialog: function(title){
		var video=document.createElement('video');		
		video.setAttribute('src', demo.getRes('test.mp4'));
		video.setAttribute('controls', 'true');
		video.setAttribute('autoplay', 'true');			
		
		demo.showDialog(video, title, 610, 280);
	},

	createConnectionBillboardImage: function(value){
		var width=512, height=256;
		var text='当前网络流量';
		var canvas = document.createElement('canvas');
		canvas['width']=width;
		canvas['height']=height;
		var context = canvas.getContext('2d');
		context.fillStyle = '#FE642E';
		context.fillRect(0, 0, width, height-height/6);

		context.beginPath();
		context.moveTo(width*0.2, 0);
		context.lineTo(width/2, height);
		context.lineTo(width*0.8, 0);
		context.fill();
		
		var color='white';
		context.font = 40+'px "Microsoft Yahei" bold';
		context.fillStyle = color;
		context.textAlign = 'left';
		context.textBaseline = 'middle';		
		context.fillText(text, height/10, height/5);

		var color='white';
		text=value;
		context.font = 100+'px "Microsoft Yahei" bold';
		context.fillStyle = color;
		context.textAlign = 'left';
		context.textBaseline = 'middle';		
		context.fillText(text, height/10, height/2);
		context.strokeStyle=color;
		context.lineWidth=4;			
		context.strokeText(text, height/10, height/2);

		text='Mb/s';
		context.font = 50+'px "Microsoft Yahei" bold';
		context.fillStyle = color;
		context.textAlign = 'right';
		context.textBaseline = 'middle';		
		context.fillText(text, width-height/10, height/2+20);

		return canvas;
	},

	inspection: function(gl3dview){
		var leftDoor, rightDoor;
		var rack;
		gl3dview.getServa().forEach(function(element){
			if(element.getClient('type')==='left-door') {
				leftDoor=element;
			}
			if(element.getClient('type')==='right-door') {
				rightDoor=element;
			}
			if(element.getClient('label')==='1A04'){
				rack=element;
			}
		});

		var actions1=[
			{'px':2000, 'py':500, 'pz':2000, 'tx':0, 'ty':0, 'tz':0, }, 			
			{'px':2000,'pz':-2000},
			{'px':0,'pz':-2500},
			{'px':-2000},
			{'px':-2500,'pz':0},
			{'pz':2000},
			{'px':-1200, 'tx':-350, 'ty':170, 'tz':500}, 
			{'px': -550, 'py': 190, 'pz':1100}, 
		];

		var actions2=[
			{'px': -350, 'py': 120, 'pz':600, 'tx':-340, 'ty':150, 'tz':-300}, 
			{'py': 100, 'pz':200, }, 
			{'px': -300, 'py': 300, 'pz':150, 'ty':70}, 
		];

		var showAlarmAction=function(element){
			var card=element.alarmCard;
			var position=card.getWorldPosition();
			var actions3=[
				{'px': position.x, 'py': position.y, 'pz': position.z+120, 'tx':position.x, 'ty':position.y+10, 'tz':position.z}, 
				{'px': position.x-30, 'py': position.y+30, 'pz': position.z+90, 'ty':position.y+15}, 
			];
			mono.AniUtil.playInspection(gl3dview, actions3, function(){
				demo.playAnimation(card, card.getClient('animation'), function(){
					gl3dview.inspecting=false;
					demo.showAlarmDialog();
				});				
			});			
		}

		rack.setClient('loaded.func', showAlarmAction);

		var doorOpen=function(){			
			demo.playAnimation(leftDoor, leftDoor.getClient('animation'), function(){
				mono.AniUtil.playInspection(gl3dview, actions2, function(){
					var door=rack.door;
					demo.playAnimation(door, door.getClient('animation'));					
				});		
			});
			demo.playAnimation(rightDoor, rightDoor.getClient('animation'));
		}
		mono.AniUtil.playInspection(gl3dview, actions1, doorOpen);
	},

	showAlarmDialog: function(){
		var span=document.createElement('span');		
		span.style['background-color']='rgba(255,255,255,0.85)';
		span.style['padding']='10px';
		span.style['color']='darkslategrey';
		span.innerHTML='<b>告警描述</b>'+
			'<p>中兴S330板卡有EPE1，LP1，OL16，CSB,SC，EPE1（2M电口）与LP1（155M光）与用户路由器连接。'+
			'EPE1上发生TU-AIS ,TU-LOP，UNEQ，误码秒告警，所配业务均出现，用户路由器上出现频繁up，down告警。'+
			'用户路由器上与1块LP1（有vc12级别的交叉）连接的cpos板卡上也有频繁up，down告警，与另一块LP1（vc4穿通）'+
			'连接的cpos卡上无告警</p>'+
			'<b>故障分析</b>'+
			'<p>情况很多。如果只是单站出现，首先判断所属环上保护，主用光路有没有告警；如果有，解决主用线路问题；'+
			'如果没有，做交叉板主备切换--当然是在晚上进行；很少出现主备交叉板都坏的情况。'+
			'还没解决的话，依次检查单板和接口板。</p>';

		demo.showDialog(span, 'SDH 2M支路板告警', 510, 250);
		span.style['width']='484px';
		span.style['height']='203px';
	},

	resetView: function(gl3dview){		
		demo.resetGleye(gl3dview);

		//reset all racks. unload contents, close door.
		var loadedRacks=[];
		gl3dview.getServa().forEach(function(element){
			if(element.getClient('type')==='rack' && element.oldRack){
				loadedRacks.push(element);
			}
		});
		for(var i=0;i<loadedRacks.length;i++){
			//restore the old rack.
			var newRack=loadedRacks[i];
			var oldRack=newRack.oldRack;

			if(newRack.alarm){
				gl3dview.getServa().getAlarmBox().remove(newRack.alarm);
			}
			gl3dview.getServa().removeByDescendant(newRack,true);

			gl3dview.getServa().add(oldRack);
			if(oldRack.alarm){
				gl3dview.getServa().getAlarmBox().add(oldRack.alarm);
			}
			oldRack.door.setParent(oldRack);
			oldRack.setClient('loaded', false);
			
			//reset door.
			var door=oldRack.door;
			gl3dview.getServa().add(door);
			if(door.getClient('animated')){
				demo.playAnimation(door, door.getClient('animation'));
			}
		}

		//reset room door.
		var doors=[];
		gl3dview.getServa().forEach(function(element){
			if(element.getClient('type')==='left-door' || element.getClient('type')==='right-door'){
				doors.push(element);
			}
		});
		for(var i=0;i<doors.length;i++){
			var door=doors[i];
			if(door.getClient('animated')){
				demo.playAnimation(door, door.getClient('animation'));
			}
		}

		//reset all views.
		if(gl3dview.temperatureView){
			demo.toggleTemperatureView(gl3dview);
		}
		if(gl3dview.spaceView){
			demo.toggleSpaceView(gl3dview);
		}
		if(gl3dview.usageView){
			demo.toggleUsageView(gl3dview);
		}
		if(gl3dview.airView){
			demo.toggleAirView(gl3dview);
		}
		if(gl3dview.moveView){
			demo.toggleMoveView(gl3dview);
		}
		if(gl3dview.connectionView){
			demo.toggleConnectionView(gl3dview);
		}
		if(gl3dview.smokeView){
			demo.toggleSmokeView(gl3dview);
		}
		if(gl3dview.waterView){
			demo.toggleWaterView(gl3dview);
		}
		if(gl3dview.laserView){
			demo.toggleLaserView(gl3dview);
		}
		if(gl3dview.powerView){
			demo.togglePowerView(gl3dview);
		}
	},

	resetRackPosition: function(gl3dview){		
		//reset all rack position
		gl3dview.getServa().forEach(function(element){
			if(element.getClient('type')==='rack'){
				element.setPosition(element.getClient('origin'));
			}
		});
		demo.dirtyShadowMap(gl3dview);
	},

	showDoorTable: function(){
		var table=document.createElement('table');
		table.setAttribute('class', 'gridtable');
		for(var k=0;k<8;k++){
			var tr=document.createElement('tr');
			table.appendChild(tr);
			for(var i=0;i<3;i++){
				var tagName= k==0 ? 'th' : 'td';
				var td=document.createElement(tagName);
				tr.appendChild(td);
				if(k==0){
					if(i==0){
						td.innerHTML='#';
					}
					if(i==1){
						td.innerHTML='Time';
					}
					if(i==2){
						td.innerHTML='Activity';
					}
				}else{
					if(i==0){
						td.innerHTML=parseInt(Math.random()*1000);
					}
					if(i==1){
						td.innerHTML=new Date().format('yyyy h:mm');
					}
					if(i==2){
						if(Math.random()>0.5){
							td.innerHTML='Door access allowed';
						}else{
							td.innerHTML='Instant Alart - Door access denied';
						}
					}
				}
			}
		}

		demo.showDialog(table, 'Door Security Records', 330, 240);
	},

	toggleSmokeView: function(gl3dview){
		gl3dview.smokeView=!gl3dview.smokeView;
		gl3dview.getServa().forEach(function(element){
			var type=element.getClient('type');
			if(type==='smoke' || type==='extinguisher_arrow'){
				element.setVisible(gl3dview.smokeView);				
			}
		});
	},

	startSmokeAnimation: function(gl3dview){
		setInterval(demo.updateSmoke(gl3dview), 200);
	},

	startFpsAnimation: function(gl3dview){
		var span=document.createElement('span');
		span.style.display = 'block';
		span.style['color']='white';
		span.style['font-size']='10px';
		span.style.position = 'absolute';
		span.style.left = '10px';
		span.style.top = '10px';
		span.style.visibility='hidden';
		document.body.appendChild(span);
		gl3dview.fpsDiv=span;		

		demo.fps=0;		
		gl3dview.setRenderCallback(function(){
			demo.fps++;
		});
		setInterval(demo.updateFps(gl3dview), 1000);		
	},
	
	toggleFpsView: function(gl3dview){							
		gl3dview.fpsView=!gl3dview.fpsView;

		if(gl3dview.fpsView){
			gl3dview.fpsDiv.style.visibility='inherit';
		}else{
			gl3dview.fpsDiv.style.visibility='hidden';
		}
	},


	updateSmoke: function(gl3dview){
		return function(){
			if(gl3dview.smokeView){
				gl3dview.getServa().forEach(function(element){
					if(element.getClient('type')==='smoke' && element.isVisible()){
						var smoke=element;
						var count = smoke.vertices.length;
						for (var i = 0; i < count; i++) {
							var point= smoke.vertices[i];
							point.y = Math.random() * 200;
							point.x = Math.random() * point.y/2-point.y/4;				
							point.z = Math.random() * point.y/2-point.y/4;
						}
						smoke.verticesNeedUpdate = true;
						gl3dview.dirtyGl3dview();
					}
				});
			}
		}
	},

	updateFps: function(gl3dview){
		return function(){
			gl3dview.fpsDiv.innerHTML='FPS:  ' + demo.fps;
			demo.fps=0;
		}
	},

	toggleWaterView: function(gl3dview){
		gl3dview.waterView=!gl3dview.waterView;
		if(gl3dview.waterView){
			demo.createWaterLeaking(gl3dview.getServa());
			gl3dview.getServa().oldAlarms=gl3dview.getServa().getAlarmBox().toDatas();
			gl3dview.getServa().getAlarmBox().clear();
		}else{
			if(gl3dview.getServa().waterLeakingObjects){
				for(var i=0;i<gl3dview.getServa().waterLeakingObjects.length;i++){
					gl3dview.getServa().remove(gl3dview.getServa().waterLeakingObjects[i]);
				}
			}
			gl3dview.getServa().oldAlarms.forEach(function(alarm){
				gl3dview.getServa().getAlarmBox().add(alarm);
			});
		}

		gl3dview.getServa().forEach(function(element){
			var type=element.getClient('type');
			if(type==='water_cable'){
				element.setVisible(gl3dview.waterView);
			}else if(type && type!=='floorCombo' && type!=='extinguisher' && type!=='glassWall'){
				if(gl3dview.waterView){		
					if(type==='rack' || type==='rack_door'){
						element.oldTransparent=element.getStyle('m.transparent');
						element.oldOpacity=element.getStyle('m.opacity');
						element.setStyle('m.transparent', true);
						element.setStyle('m.opacity', 0.1);
					}else{
						element.oldVisible=element.isVisible();
						element.setVisible(false);
					}
				}else{
					if(type==='rack' || type==='rack_door'){
						element.setStyle('m.transparent', element.oldTransparent);
						element.setStyle('m.opacity', element.oldOpacity);
					}else{
						element.setVisible(element.oldVisible);
					}
				}
			}
		});
	},

	createWaterLeaking: function(box){
		var sign=new mono.Billboard();
		sign.s({
			'm.texture.image': demo.getRes('alert.png'),
			'm.vertical': true,				
		});
		sign.setScale(80,160,1);
		sign.setPosition(50, 90, 50);
		box.add(sign);

		var ball=new mono.Sphere(30);
		ball.s({
			'm.transparent': true,
			'm.opacity': 0.8,
			'm.type': 'phong',
			'm.color': '#58FAD0',
			'm.ambient': '#81BEF7',
			'm.specularStrength': 50,
			'm.normalmap.image': demo.getRes('rack_inside_normal.jpg'),
		});	
		ball.setPosition(50, 0, 50);
		ball.setScale(1, 0.1, 0.7);
		box.add(ball);

		box.waterLeakingObjects=[sign, ball];
	},

	toggleLaserView: function(gl3dview){
		gl3dview.laserView=!gl3dview.laserView;		

		gl3dview.getServa().forEach(function(element){
			if(element.getClient('type')==='laser'){
				element.setVisible(gl3dview.laserView);
			}
		});
	},

	setupToolbar: function(buttons){		
		var count=buttons.length;
		var step=32;

		var div=document.createElement('div');
		div.setAttribute('id', 'toolbar');
		div.style.display = 'block';
		div.style.position = 'absolute';
		div.style.left = '10px';
		div.style.top = '75px';
		div.style.width='32px';
		div.style.height=(count*step+step)+'px';
		div.style.background='rgba(255,255,255,0.75)';						
		div.style['border-radius']='5px';
		document.body.appendChild(div);

		for(var i=0;i<count;i++){
			var button=buttons[i];
			var icon=button.icon;
			var img=document.createElement('img');
			img.style.position = 'absolute';
			img.style.left=  '4px';
			img.style.top = (step/2+(i * step))+'px';			
			img.style['pointer-events']='auto';
			img.style['cursor']='pointer';
			img.setAttribute('src', demo.getRes(icon));		
			img.style.width='24px';
			img.style.height='24px';
			img.setAttribute('title', button.label);
			img.onclick = button.clickFunction;
			div.appendChild(img);
		}
	},

	togglePowerView: function(gl3dview){
		if(!gl3dview.powerLineCreated){
			demo.createPowerLines(gl3dview);
		}
		gl3dview.powerView=!gl3dview.powerView;		

		gl3dview.getServa().forEach(function(element){
			var type=element.getClient('type');
			if(type==='power_line'){
				element.setVisible(gl3dview.powerView);
			}
		});
	},

	createPowerLines: function(gl3dview){
		var box=gl3dview.getServa();		

		var createRackLines=function(labels, offsetZ){
			box.forEach(function(element){
				if(element.getClient('type')==='rack'){				
					var label=element.getClient('label');
					if(labels.indexOf(label)>-1){
						var position=element.getPosition();
						var points=[];
						points.push([position.x, position.y, position.z]);
						points.push([position.x, position.y, position.z-60]);
						points.push([position.x, 240, position.z-60]);
						points.push([position.x, 240, offsetZ]);
						points.push([-550, 240, offsetZ]);
						demo.createPathLink(box, points, '#FE9A2E', 'power_line');

						var points=[];
						points.push([position.x-5, position.y, position.z]);
						points.push([position.x-5, position.y, position.z-60]);
						points.push([position.x-5, 250, position.z-60]);
						points.push([position.x-5, 250, offsetZ]);
						points.push([-550, 250, offsetZ]);
						demo.createPathLink(box, points, 'cyan', 'power_line');

						offsetZ-=5;
					}
				}
			});
		}

		createRackLines(['1A07', '1A08', '1A09', '1A10', '1A11', '1A12', '1A13'], 150);
		createRackLines(['1A00', '1A01', '1A02',], 160);
		createRackLines(['1A03', '1A04', '1A05','1A06'], -300);

		demo.createPathLink(box, [[-1000, 420, 600], [-800, 250, 500], [-550, 250, 500], [-550, 250, -315]], 'cyan', 'power_line');
		demo.createPathLink(box, [[-1000, 410, 600], [-800, 240, 500], [-550, 240, 500], [-550, 240, -315]], '#FE9A2E', 'power_line');
	},

	createPathLink: function(box, points, color, clientType){
		if(points && points.length>1){			
			color = color || 'white';
			for(var i=1;i<points.length;i++){
				var from=points[i-1];
				var to=points[i];
				
				var fromNode=new mono.Cube(0.001, 0.001, 0.001);
				fromNode.s({
					'm.color': color,
				})
				fromNode.setPosition(from[0], from[1], from[2]);
				fromNode.setClient('type', clientType);
				box.add(fromNode);

				var toNode=fromNode.clone();
				toNode.setPosition(to[0], to[1], to[2]);
				toNode.setClient('type', clientType);
				box.add(toNode);

				var link=new mono.Link(fromNode, toNode);
				link.s({
					'm.color': color,
				});
				link.setClient('type', clientType);
				box.add(link);
			}
		}
	},
}
demo.registerFilter('floor', function(box, json){
	return {
		type: 'cube',
		width: 1000,
		height: 10,
		depth: 1000,
		translate: [0, -10, 0],
		shadowHost: true,
		op: '+',
		style: {
			'm.type': 'phong',
			'm.color': '#BEC9BE',
			'm.ambient': '#BEC9BE',
			'top.m.type':'basic',
			'top.m.texture.image': demo.getRes('floor.jpg'),
			'top.m.texture.repeat': new mono.XiangliangTwo(10,10),
			'top.m.color': '#DAF0F5',
			'top.m.polygonOffset':true,
			'top.m.polygonOffsetFactor':3,
			'top.m.polygonOffsetUnits':3,
		}
	};
});

demo.registerFilter('floor_cut', function(box, json){
	return {
		type: 'cube',
		width: 100,
		height: 100,
		depth: 100,
		op: '-',
		style: {
			'm.texture.image': demo.getRes('floor.jpg'),
			'm.texture.repeat': new mono.XiangliangTwo(4,4),
			'm.color': '#DAF0F5',
			'm.lightmap.image': demo.getRes('outside_lightmap.jpg'),
			'm.polygonOffset':true,
			'm.polygonOffsetFactor':3,
			'm.polygonOffsetUnits':3,
		}
	};
});

demo.registerFilter('floor_box', function(box, json){
	return {
		type: 'cube',
		width: 100,
		height: 100,
		depth: 100,
		shadow: true,
		sideColor: '#C3D5EE',
		topColor: '#D6E4EC',
		client: {
			type: 'floor_box'
		}
	};
});

demo.registerFilter('plants', function(box, json){
	var objects=[];
	var translates=json.translates;
	if(translates){
		for(var i=0;i<translates.length;i++){
			var translate=translates[i];
			var plant={
				type: 'plant',
				shadow: true,
				translate: translate,
			};
			demo.copyProperties(json, plant, ['type', 'translates', 'translate']);
			objects.push(plant);
		}
	}
	return objects;
});

demo.registerFilter('racks', function(box, json){
	var objects=[];
	var translates=json.translates;
	var severities=json.severities || [];
	var labels=json.labels || [];
	if(translates){
		for(var i=0;i<translates.length;i++){
			var translate=translates[i];
			var severity=severities[i];
			var label=labels[i] || '';
			var rack={
				type: 'rack',
				shadow: true,
				translate: translate,
				severity: severity,
				label: label,
			};
			demo.copyProperties(json, rack, ['type', 'translates', 'translate', 'severities']);
			objects.push(rack);
		}
	}
	return objects;
});

demo.registerFilter('wall', function(box, json){	
	var objects=[];

	var wall = {
		type: 'path',
		op: '+',
		width: 20,
		height: 200,
		shadow: true,
		insideColor: '#B8CAD5',
		outsideColor: '#A5BDDD',		
		topColor: '#D6E4EC',
		translate: json.translate,
		data:json.data,

		client: {
			'data': json.data,
			'type': 'wall',
			'translate': json.translate,
		},
	};
			
	objects.push(wall);		

	if(json.children){	
		var children=demo.filterJson(box, json.children);				
		objects=objects.concat(children);	
	}

	var comboChildren=[];
	var returnObjects=[];
	for(var i=0;i<objects.length;i++){
		var child=objects[i];
		if(child.op){
			comboChildren.push(child);
		}else{
			returnObjects.push(child);
		}
	}
	
	var comboWall = demo.createCombo(comboChildren);
	comboWall.shadow = true;
	comboWall.setClient('data', json.data);
	comboWall.setClient('type','wall');
	comboWall.setClient('translate',json.translate);
	box.add(comboWall);

	return returnObjects;
});

demo.registerFilter('window', function(box, json){
	var translate=json.translate || [0,0,0];
	var x=translate[0],
		y=translate[1],
		z=translate[2];
	var width=json.width || 100,
		height=json.height || 100,
		depth=json.depth || 50;
	var glassDepth=2;
	var platformHeight=5,
		platformDepth=45,
		platformOffsetZ=10;

	return [{
		// window cut off
		type: 'cube',
		width: width,
		height: height,
		depth: depth, 
		translate: [x, y, z],
		op: '-',
		sideColor: '#B8CAD5',
		topColor: '#D6E4EC',		
		
	},{
		//window glass
		type: 'cube',
		width: width-0.5,
		height: height-0.5,
		depth: glassDepth,
		translate: [x, y, z],
		op: '+',
		style: {			
			'm.color':'#58ACFA',
			'm.ambient':'#58ACFA',
			'm.type':'phong',
			'm.specularStrength': 0.1,
			'm.envmap.image': demo.getEnvMap(),
			'm.specularmap.image': demo.getRes('rack_inside_normal.jpg'),	
			'm.texture.repeat': new mono.XiangliangTwo(10,5),
			'front.m.transparent': true,
			'front.m.opacity':0.4,
			'back.m.transparent': true,
			'back.m.opacity':0.4,
		},			
	},{
		//window bottom platform.
		type: 'cube',
		width: width,
		height: platformHeight,
		depth: platformDepth, 
		translate: [x, y, z+platformOffsetZ],
		op: '+',
		sideColor: '#A5BDDD',
		topColor: '#D6E4EC',
	}];
});

demo.registerFilter('door', function(box, json){
	var translate=json.translate || [0,0,0];
	var x=translate[0],
		y=translate[1],
		z=translate[2];
	var width=json.width || 205,
		height=json.height || 180,
		depth=json.depth || 26;	
	var frameEdge=10,
		frameBottomEdge=2;

	return [{
		//door frame.
		type: 'cube',
		width: width,
		height: height,
		depth: depth,
		translate: [x, y, z],
		op: '+',
		sideColor: '#C3D5EE',
		topColor: '#D6E4EC',
	},{
		//door cut off.
		type: 'cube',
		width: width-frameEdge,
		height: height-frameEdge/2-frameBottomEdge,
		depth: depth+2,
		op: '-',
		translate:[x,y+frameBottomEdge,z],
		sideColor: '#B8CAD5',
		topColor: '#D6E4EC',			
	},{
		//left door.
		type: 'cube',
		width: (width-frameEdge)/2-2,
		height: height-frameEdge/2-frameBottomEdge-2,
		depth: 2,
		translate:[x-(width-frameEdge)/4,frameBottomEdge+1,z],
		sideColor: 'orange',
		topColor: 'orange',
		style:{
			'm.type': 'phong',
			'm.transparent': true,
			'front.m.texture.image': demo.getRes('door_left.png'),					
			'back.m.texture.image': demo.getRes('door_right.png'),					
			'm.specularStrength': 100,
			'm.envmap.image': demo.getEnvMap(),
			'm.specularmap.image': demo.getRes('white.png'),	
		},
		client:{
			'animation': 'rotate.left.-90.bounceOut',
			'type': 'left-door',
		},
	},{
		//right door.
		type: 'cube',
		width: (width-frameEdge)/2-2,
		height: height-frameEdge/2-frameBottomEdge-2,
		depth: 2,
		translate:[x+(width-frameEdge)/4,frameBottomEdge+1,z],
		sideColor: 'orange',
		topColor: 'orange',
		style:{
			'm.type': 'phong',
			'm.transparent': true,
			'front.m.texture.image': demo.getRes('door_right.png'),					
			'back.m.texture.image': demo.getRes('door_left.png'),					
			'm.specularStrength': 100,
			'm.envmap.image': demo.getEnvMap(),
			'm.specularmap.image': demo.getRes('white.png'),	
		},		
		client:{
			'animation': 'rotate.right.90.bounceOut',
			'type': 'right-door',
		},
	},{
		//door control.
		type: 'cube',
		width: 15,
		height: 32,
		depth: depth-3,
		translate: [x-width/2-13, height*0.6, z],
		style:{
			'left.m.visible': false,
			'right.m.visible': false,
			'top.m.visible': false,
			'bottom.m.visible': false,
			'm.transparent': true,
			'm.specularStrength': 50,
			'front.m.texture.image': demo.getRes('lock.png'),
			'back.m.texture.image': demo.getRes('lock.png'),
		},
		client:{
			'dbl.func': demo.showDoorTable,
			'type': 'door_lock',
		},
	}];
});

demo.registerFilter('glass_wall', function(box, json){
	var translate=json.translate || [0,0,0];
	var x=translate[0],
		y=translate[1],
		z=translate[2];
	var width=json.width || 100,
		height=json.height || 200,
		depth=json.depth || 20;	
	var glassHeight=height*0.6;
	var rotate=json.rotate || [0,0,0];

	var parts=[{
		//wall body.
		type: 'cube',
		width: width,
		height: height,
		depth: depth,
		shadow: true,
		translate: [x, y, z],
		rotate: rotate,
		op: '+',
		sideColor: '#A5BDDD',
		topColor: '#D6E4EC',
	},{
		//wall middle cut off
		type: 'cube',
		width: width+2,
		height: glassHeight,
		depth: depth+2,
		translate: [x, (height-glassHeight)/3*2, z],
		rotate: rotate,
		op: '-',
		sideColor: '#A5BDDD',
		topColor: '#D6E4EC',
	},{
		//wall middle glass.
		type: 'cube',
		width: width,
		height: glassHeight,
		depth: 4,
		translate: [x, (height-glassHeight)/3*2, z],
		rotate: rotate,
		op: '+',
		sideColor: '#58ACFA',
		topColor: '#D6E4EC',
		style: {
			'm.transparent': true,
			'm.opacity':0.6,
			'm.color':'#01A9DB',
			'm.ambient':'#01A9DB',
			'm.type':'phong',
			'm.specularStrength': 100,
			'm.envmap.image': demo.getEnvMap(),
			'm.specularmap.image': demo.getRes('rack_inside_normal.jpg'),	
			'm.texture.repeat': new mono.XiangliangTwo(30, 5),
		},
	}];
	
	var wall=demo.createCombo(parts);
	wall.setClient('type','glassWall');
	wall.setClient('size', wall.getBizBox().size());
	wall.setClient('translate',translate);
	wall.shadow = true;
	box.add(wall);
});

demo.registerFilter('rail', function(box, json){		
	var params = {
		type: 'path',
		width: 50,
		height: 8,		
		data:json.data,
	};	

	var loader=function(box, params){
		box.add(demo.createRail(params));
	};

	var loaderFunc=function(box, params){
		return function(){
			loader(box, params);
		};
	};
	setTimeout(loaderFunc(box, params), demo.getRandomLazyTime());	
});

demo.createRail = function(params){
	var rail=demo.createPathObject(params);
	rail.s({
		'm.texture.image': demo.getRes('rail.png'),
		'm.type': 'phong',
		'm.transparent': true,
		'm.color': '#CEECF5',
		'm.ambient': '#CEECF5',
		'aside.m.visible': false,
		'zside.m.visible': false,
		'm.specularStrength': 50,
	});
	rail.setPositionY(263);
	rail.setClient('type', 'rail');
	rail.setVisible(false);
	
	return rail;
}

demo.registerFilter('connection', function(box, json){			
	var path = demo.create3DPath(json.data);
	path = mono.PathNode.prototype.adjustPath(path, 5);
	var color=json.color;
	var flow=json.flow;
	var y=json.y;
	
	var loader=function(box, path, color, flow, y){
		box.add(demo.createConnection(path, color, flow, y));
	};

	var loaderFunc=function(box, path, color, flow, y){
		return function(){
			loader(box, path, color, flow, y);
		};
	};
	setTimeout(loaderFunc(box, path, color, flow, y), demo.getRandomLazyTime());	
});

demo.createConnection = function(path, color, flow, y){
	var connection=new mono.PathNode(path, 100, 1);
	connection.s({
		'm.type': 'phong',
		'm.specularStrength': 30,
		'm.color': color,
		'm.ambient': color, 		
		'm.texture.image': demo.getRes('flow.jpg'),
		'm.texture.repeat': new mono.XiangliangTwo(200, 1),
		'm.texture.flipX': flow>0,
	});
	connection.setClient('flow', flow);
	connection.setStartCap('plain');
	connection.setEndCap('plain');
	connection.setPositionY(y);
	connection.setClient('type', 'connection');	
	connection.setVisible(false);
	return connection;
};

demo.registerShadowPainter('wall', function(object, context, floorWidth, floorHeight, translate, rotate){
	var translate = object.getClient('translate') || [0, 0, 0];		
	var translateX=floorWidth/2+translate[0];
	var translateY=floorHeight-(floorHeight/2+translate[2]);
	var pathData=object.getClient('data');			
	
	context.save();
	context.translate(translateX, translateY);
	context.rotate(rotate);
	context.beginPath();
	var first=true;
	for(var j=0;j<pathData.length;j++){
		var point=pathData[j];
		if(first){
			context.moveTo(point[0], -point[1]);
			first=false;
		}else{
			context.lineTo(point[0], -point[1]);
		}
	}

	context.lineWidth = object.getClient('width') || 20;		

	context.strokeStyle = 'white';
	context.shadowColor = '#222222';
	context.shadowBlur = 60;
	context.shadowOffsetX = 0;
	context.shadowOffsetY = 0;
	context.stroke();
	
	context.restore();
});

demo.registerShadowPainter('floor_box', function(object, context, floorWidth, floorHeight, translate, rotate){
	var translateX=floorWidth/2+translate.x;
	var translateY=floorHeight/2+translate.z;
	var width=object.getWidth();
	var lineWidth=object.getDepth();

	context.save();

	context.translate(translateX, translateY);
	context.rotate(rotate);

	context.beginPath();
	context.moveTo(-width/2, 0);
	context.lineTo(width/2, 0);
	
	context.lineWidth = lineWidth;
	context.strokeStyle = 'white';
	context.shadowColor = '#222222';
	context.shadowBlur = 60;
	context.shadowOffsetX = 0;
	context.shadowOffsetY = 0;						
	context.stroke();	

	context.restore();
});

demo.registerShadowPainter('rack', function(object, context, floorWidth, floorHeight, translate, rotate){
	var translateX=floorWidth/2+translate.x;
	var translateY=floorHeight/2+translate.z;
	var width=object.width || 60;
	var height=object.height || 200;
	var depth=object.depth || 80;
	var width=width*0.99;
	var lineWidth=depth*0.99;

	context.save();

	context.beginPath();
	context.moveTo(translateX-width/2, translateY);
	context.lineTo(translateX+width/2, translateY);
	
	context.lineWidth = lineWidth;
	context.strokeStyle = 'gray';
	context.shadowColor = 'black';
	context.shadowBlur = 100;
	context.shadowOffsetX = 0;
	context.shadowOffsetY = 0;						
	context.stroke();			
	
	context.restore();
});

demo.createRoundShadowPainter=function(radius){
	return function(object, context, floorWidth, floorHeight, translate, rotate){
		var translateX=floorWidth/2+translate.x;
		var translateY=floorHeight/2+translate.z;

		context.save();

		context.beginPath();
		context.arc(translateX, translateY, radius, 0, 2 * Math.PI, false);
		
		context.fillStyle='black';
		context.shadowColor = 'black';
		context.shadowBlur = 25;
		context.shadowOffsetX = 0;
		context.shadowOffsetY = 0;						
		context.fill();			

		context.restore();
	}
};

demo.registerShadowPainter('plant', demo.createRoundShadowPainter(11));
demo.registerShadowPainter('extinguisher', demo.createRoundShadowPainter(7));

demo.registerShadowPainter('glassWall', function(object, context, floorWidth, floorHeight, translate, rotate){
	var translate = object.getClient('translate');
	var size = object.getClient('size');
	var translateX=floorWidth/2+translate[0];
	var translateY=floorHeight/2+translate[2];
	var width=size.x;
	var lineWidth=size.z;
	context.save();

	context.translate(translateX, translateY);

	context.beginPath();
	context.moveTo(-width/2, 0);
	context.lineTo(width/2, 0);
	
	context.lineWidth = lineWidth;
	context.strokeStyle = 'white';
	context.shadowColor = '#222222';
	context.shadowBlur = 60;
	context.shadowOffsetX = 0;
	context.shadowOffsetY = 0;						
	context.stroke();	

	context.restore();						
});

demo.registerCreator('rack', function(box, json){
	var translate=json.translate || [0,0,0];
	var x=translate[0],
		y=translate[1],
		z=translate[2];
	var width=json.width || 60;
	var height=json.height || 200;
	var depth=json.depth || 80;
	var severity=json.severity;
	var label=json.label;
	var shadow = json.shadow;

	var rack= new mono.Cube(width, height, depth);
	rack.s({				
		'm.color': '#557E7A',
		'left.m.lightmap.image':demo.getRes('outside_lightmap.jpg'),
		'right.m.lightmap.image':demo.getRes('outside_lightmap.jpg'),
		'front.m.lightmap.image':demo.getRes('outside_lightmap.jpg'),
		'back.m.lightmap.image':demo.getRes('outside_lightmap.jpg'),
		'top.m.normalmap.image':demo.getRes('metal_normalmap.jpg'),
		'left.m.normalmap.image':demo.getRes('metal_normalmap.jpg'),
		'right.m.normalmap.image':demo.getRes('metal_normalmap.jpg'),
		'back.m.normalmap.image':demo.getRes('metal_normalmap.jpg'),
		'top.m.specularmap.image': demo.getRes('outside_lightmap.jpg'),	
		'left.m.specularmap.image': demo.getRes('outside_lightmap.jpg'),	
		'right.m.specularmap.image': demo.getRes('outside_lightmap.jpg'),	
		'back.m.specularmap.image': demo.getRes('outside_lightmap.jpg'),	
		'top.m.envmap.image': demo.getEnvMap(),
		'left.m.envmap.image': demo.getEnvMap(),
		'right.m.envmap.image': demo.getEnvMap(),
		'back.m.envmap.image': demo.getEnvMap(),
		'm.ambient': '#557E7A',
		'm.type':'phong',
		'm.specularStrength': 50,
		'front.m.texture.image':demo.getRes('rack.jpg'),
		'front.m.texture.repeat': new mono.XiangliangTwo(1,1),
		'front.m.specularmap.image':demo.getRes('white.png'),
		'front.m.color':'#666',
		'front.m.ambient':'#666',
		'front.m.specularStrength': 200,
	});
	rack.setPosition(x, height/2+1+y, z);

	var labelCanvas=demo.generateAssetImage(label);
	rack.setStyle('top.m.texture.image', labelCanvas);
	rack.setStyle('top.m.specularmap.image', labelCanvas);
	rack.setClient('label', label);
	rack.setClient('type', 'rack');
	rack.setClient('origin', rack.getPosition().clone());
	rack.setClient('loaded', false);
	rack.shadow = shadow;

	var rackDoor = new mono.Cube(width, height, 2);
	rackDoor.s({
		'm.type':'phong',
		'm.color': '#A5F1B5',
		'm.ambient': '#A4F4EC',
		'front.m.texture.image': demo.getRes('rack_front_door.jpg'),
		'back.m.texture.image': demo.getRes('rack_door_back.jpg'),
		'm.envmap.image': demo.getEnvMap(),
	});
	rackDoor.setParent(rack);
	rack.door=rackDoor;
	rackDoor.setPosition(0, 0, depth/2+1); 
	rackDoor.setClient('animation','rotate.right.100');
	rackDoor.setClient('type', 'rack.door');
	rackDoor.setClient('animation.done.func', function(){	
		if(rack.getClient('loaded') || !rackDoor.getClient('animated')){
			return;
		}
		var fake=rack.clone();
		fake.s({
			'm.color': 'red',
			'm.ambient': 'red',
			'm.texture.image': null,
			'top.m.normalmap.image': demo.getRes('outside_lightmap.jpg'),
			'top.m.specularmap.image': demo.getRes('white.png'),
		});
		fake.setDepth(fake.getDepth()-2);
		fake.setWidth(fake.getWidth()-2);
		box.add(fake);

		rack.s({
			'm.transparent': true,
			'm.opacity': 0.5,
		});

		new twaver.Animate({
			from: 0,
			to: fake.getHeight(),
			dur: 2000,
			easing: 'easeOut',
			onUpdate: function (value) {
				fake.setHeight(value);
				fake.setPositionY(value/2);
			},
			onDone: function(){
				box.remove(fake);
				rack.s({
					'm.transparent': false,
					'm.opacity': 1,
				});
				var loader = rack.getClient('rack.loader');
				if(loader && rackDoor.getClient('animated') && !rack.getClient('loaded')){
					loader();
					rack.setClient('loaded', true);

					if(rack.getClient('loaded.func')){
						rack.getClient('loaded.func')(rack);
					}
				}
			}
		}).play();
	});

	var loader=function(box, width, height, depth, severity, rack, json){
		var cut=new mono.Cube(width*0.75, height-10, depth*0.7);
		cut.s({
			'm.color': '#333333',
			'm.ambient': '#333333',
			'm.lightmap.image': demo.getRes('inside_lightmap.jpg'),
			'bottom.m.texture.repeat': new mono.XiangliangTwo(2,2),			
			'left.m.texture.image': demo.getRes('rack_panel.jpg'),
			'right.m.texture.image': demo.getRes('rack_panel.jpg'),
			'back.m.texture.image': demo.getRes('rack_panel.jpg'),
			'back.m.texture.repeat': new mono.XiangliangTwo(1,1),
			'top.m.lightmap.image': demo.getRes('floor.jpg'),
		});
		cut.setPosition(0, 0, depth/2-cut.getDepth()/2+1);
		box.remove(rack);
		if(rack.alarm){
			box.getAlarmBox().remove(rack.alarm);
		}

		var cube = rack.clone();
		cube.p(0, 0, 0);
		
		var newRack=new mono.ComboNode([cube, cut], ['-']);
		
		var x=rack.getPosition().x;
		var y=rack.getPosition().y;
		var z=rack.getPosition().z;

		newRack.p(x, y, z);
		newRack.setClient('type', 'rack');
		newRack.oldRack=rack;
		rack.newRack=newRack;
		newRack.shadow = shadow;
		box.add(newRack);

		if(severity){
			var alarm = new mono.Alarm(newRack.getId(), newRack.getId(), severity);
			newRack.setStyle('alarm.billboard.vertical', true);
			newRack.alarm=alarm;
			box.getAlarmBox().add(alarm);
		}

		//set child for newrack
		var children = rack.getChildren();
		children.forEach(function(child){
			if(child && !(child instanceof mono.Billboard)){
				child.setParent(newRack);
			}
		});

		demo.loadRackContent(box, x, y, z, width, height, depth, severity, cube, cut, json, newRack, rack);		
	};

	box.add(rack);
	box.add(rackDoor);
	if(severity){
		var alarm = new mono.Alarm(rack.getId(), rack.getId(), severity);
		rack.setStyle('alarm.billboard.vertical', true);
		rack.alarm=alarm;
		box.getAlarmBox().add(alarm);
	}			
	var loadFunction = function(){
		loader(box, width, height, depth, severity, rack, json);
	};
	rack.setClient('rack.loader', loadFunction);
});

demo.registerCreator('plant', function(box, json){
	var scale=json.scale || [1,1,1];
	var scaleX=scale[0], scaleY=scale[1], scaleZ=scale[2];
	var shadow = json.shadow;
	var translate=json.translate || [0,0,0];
	var x=translate[0], y=translate[1], z=translate[2];

	var loader=function(x, y, z, scaleX, scaleY, scaleZ){
		var plant=demo.createPlant(x, y, z, scaleX, scaleY, scaleZ);
		plant.shadow = shadow;
		box.add(plant);
	};

	var loaderFunc=function(x, y, z, scaleX, scaleY, scaleZ){
		return function(){
			loader(x, y, z, scaleX, scaleY, scaleZ);
		};
	};
	setTimeout(loaderFunc(translate[0],translate[1],translate[2],scale[0],scale[1],scale[2]), demo.getRandomLazyTime());					
});

demo.registerCreator('tv', function(box, json){
	var translate=json.translate || [0,0,0];
	var x=translate[0],
		y=translate[1],
		z=translate[2];
	var edgeX=4,
		edgeY=2;
	var picture=json.picture || demo.getRes('tv.jpg');
	var rotate=json.rotate || [0,0,0];

	var parts = [{
		//tv body
		type: 'cube',
		width: 150,
		height: 80,
		depth: 5,
		translate: [x, y, z],
		rotate: rotate,
		op: '+',
		style: {
			'm.type': 'phong',
			'm.color': '#2D2F31',
			'm.ambient': '#2D2F31',
			'm.normalmap.image':demo.getRes('metal_normalmap.jpg'),
			'm.texture.repeat': new mono.XiangliangTwo(10,6),
			'm.specularStrength': 20,
		},
	},{
		//'tv cut off',
		type: 'cube',
		width: 130,
		height: 75,
		depth: 5,
		translate: [x, y+edgeY, z+edgeX],
		rotate: rotate,
		op: '-',
		style: {
			'm.type': 'phong',
			'm.color': '#2D2F31',
			'm.ambient': '#2D2F31',
			'm.normalmap.image':demo.getRes('metal_normalmap.jpg'),
			'm.texture.repeat': new mono.XiangliangTwo(10,6),
			'm.specularStrength': 100,
		},
	},{
		//'tv screen',
		type: 'cube',
		width: 130,
		height: 75,
		depth: 1,
		translate: [x, y+edgeY, z+1.6],
		rotate: rotate,
		op: '+',
		style: {
			'm.type': 'phong',
			'm.specularStrength': 200,
			'front.m.texture.image': picture,
		},
	}];

	var tv=demo.createCombo(parts);
	tv.setClient('type', 'tv');
	box.add(tv);
});

demo.registerCreator('post', function(box, json){
	var translate=json.translate || [0,0,0];
	var x=translate[0],
		y=translate[1],
		z=translate[2];
	var width=json.width, height=json.height;
	var pic=json.pic;

	var post=new mono.Cube(width, height, 0);
	post.s({
		'm.visible': false,
	});
	post.s({
		'm.texture.image': pic,
		'front.m.visible': true,
	});
	post.setPosition(x, y, z);
	post.setClient('type', 'post');

	box.add(post);
});

demo.registerCreator('extinguisher', function(box, json){
	var translate=json.translate || [0,0,0];
	var x=translate[0], z=translate[1];
	var arrow=json.arrow;

	var loader=function(box, translate, x, z){
		var extinguisher=demo.createExtinguisher(box, translate, x, z, arrow);
		box.add(extinguisher);
	}

	var loaderFunc=function(box, translate, x, z, arrow){
		return function(){
			loader(box, translate, x, z, arrow);
		}
	}
	setTimeout(loaderFunc(box, translate, x, z, arrow), demo.getRandomLazyTime());					
});

demo.registerCreator('smoke', function(box, json){
	var translate=json.translate || [0,0,0];	
	var color=json.color;

	var loader=function(box, translate, color){
		var smoke=demo.createSmoke(translate, color);
		box.add(smoke);
	}

	var loaderFunc=function(box, translate, color){
		return function(){
			loader(box, translate, color);
		}
	}
	setTimeout(loaderFunc(box, translate, color), demo.getRandomLazyTime());					
});

demo.createSmoke=function(translate, color){
	var x=translate[0], y=translate[1], z=translate[2];
	var smoke = new mono.Particle();
	var count=300;
	for (var i = 0; i < count; i++) {
		smoke.vertices.push(new mono.XiangliangThree());
	}

	smoke.verticesNeedUpdate = true;
	smoke.sortParticles = false;
	smoke.setStyle('m.size', 20);
	smoke.setStyle('m.transparent', true);
	smoke.setStyle('m.opacity', 0.5);
	smoke.setStyle('m.texture.image', demo.getRes('smoking.png'));
	smoke.setStyle('m.color', color);
	smoke.setStyle('m.depthTest',false);

	smoke.setClient('type', 'smoke');

	smoke.setVisible(false);
	smoke.setPosition(x,y,z);
	return smoke;
}


demo.createExtinguisher=function(box, translate, x, z, arrow){
	var body=new mono.Cylinder(8,8,50,20);
	body.setPositionY(body.getHeight()/2);
	body.s({
		'side.m.texture.image': demo.getRes('fire_extinguisher_side.jpg'),
		'm.type': 'phong',
		'm.specularStrength': 50,
	});
	body.shadow=true;
	body.setClient('type', 'extinguisher');
	body.setPosition(x,body.getHeight()/2,z);
	box.add(body);

	var top=new mono.Sphere(8,20);
	top.setParent(body);
	top.setPositionY(body.getHeight()/2);
	top.setScaleY(0.5);
	top.s({
		'm.color': '#DF0101',
		'm.ambient': '#DF0101',
		'm.type': 'phong',
		'm.specularStrength': 50,
	});
	box.add(top);

	var nozzle=new mono.Cylinder(2,3,10);
	nozzle.setParent(top);
	nozzle.setPositionY(top.getRadius());			
	nozzle.s({
		'm.color': 'orange',
		'm.ambient': 'orange',
		'm.type': 'phong',
	}); 
	box.add(nozzle);

	var handleA=new mono.Cube(14,1,3);
	handleA.setParent(nozzle);
	handleA.setPositionY(nozzle.getHeight()-3);	
	handleA.setPositionX(handleA.getWidth()/2-2);
	handleA.setRotationZ(Math.PI/180*45);
	handleA.s({
		'm.texture.image': demo.getRes('metal.png'),
		'm.type': 'phong',
	}); 
	box.add(handleA);

	var handleB=new mono.Cube(14,1,3);
	handleB.setParent(nozzle);
	handleB.setPositionY(nozzle.getHeight()-8);	
	handleB.setPositionX(handleB.getWidth()/2);
	handleB.setRotationZ(Math.PI/180*-10);
	handleB.s({
		'm.texture.image': demo.getRes('metal.png'),
		'm.type': 'phong',
	}); 
	box.add(handleB);

	var path=new mono.Path();
	path.moveTo(0,0,0);
	path.curveTo(-10,0,0,-15,-10,0);
	path.curveTo(-20,-20,0,-15,-55,0);
	var pipe=new mono.PathNode(path,50,2,10,'round','round');
	pipe.setParent(nozzle);
	pipe.s({
		'm.texture.image': demo.getRes('metal.png'),
		'm.type': 'phong',
	}); 
	box.add(pipe);			

	if(arrow){
		var count=6;
		var height=60;
		var planes=[];
		for(var i=0; i<count; i++){
			var plane=new mono.Plane(height/2, height);
			plane.s({
				'm.texture.image': demo.getRes('down.png'),
				'm.transparent': true,
				'm.side': mono.DoubleSide,
				'm.type': 'phong',				
			});			
			plane.setParent(nozzle);
			plane.setPositionY(height+i*height);
			plane.setVisible(false);
			plane.setClient('type', 'extinguisher_arrow');
			box.add(plane);
			planes.push(plane);

			planes.index=10000;
		}

		var func=function(){
			if(planes[0].isVisible()){		
				planes.index--;
				if(planes.index==0){
					planes.index=10000;
				}
				var offset=planes.index % count;
				for(var i=count-1;i>=0;i--){
					var plane=planes[i];
					if(i===offset){
						plane.s({
							'm.color': '#FF8000',
							'm.ambient': '#FF8000',				
						});
					}else{
						plane.s({
							'm.color': 'white',
							'm.ambient': 'white',
						});
					}
				}
			}
			setTimeout(func, 200);
		}
		setTimeout(func, 200);
	}
}

demo.registerFilter('gleye', function(box, json){
	var x=json.translate[0], y=json.translate[1], z=json.translate[2];
	var angle=json.angle || 0;
	var direction=130;

	var loader=function(box, x, y, z, angle, direction){		
		var gleye=demo.createGleye(box, x, y, z, angle, direction);
		box.add(gleye);
	}

	var loaderFunc=function(box, x, y, z, angle, direction){		
		return function(){
			loader(box, x, y, z, angle, direction);
		}
	}
	setTimeout(loaderFunc(box, x, y, z, angle, direction), demo.getRandomLazyTime());					
});

demo.createGleye=function(box, x, y, z, angle, direction){		
	var body=new mono.Cylinder(4,4,15);
	body.s({
		'm.texture.image': demo.getRes('bbb.png'),
		'top.m.texture.image': demo.getRes('camera.png'),
		'bottom.m.texture.image': demo.getRes('eee.png'),
		'm.type': 'phong',
	});
	
	var style={
		'side.m.normalType': mono.NormalTypeSmooth,
	};
	var cover1=new mono.Cylinder(6,6,20);	
	cover1.s(style);
	var cover2=new mono.Cylinder(5,5,20);
	cover2.s(style);
	var cover3=new mono.Cube(10,20,10);				
	var path=new mono.Path();
	path.moveTo(0,0,0);
	path.lineTo(0,-10,0);
	path.lineTo(0,-11,-1);
	path.lineTo(0,-12,-13);
	path.lineTo(0,-12,-30);
	
	var gleye=new mono.ComboNode([cover1,cover3,cover2, body],['+','-','+']);
	gleye.s({
		'm.type': 'phong',
		'm.color': '#2E2E2E',
		'm.ambient': '#2E2E2E',
		'm.specularStrength': 50,
	});
	gleye.setRotation(Math.PI/180*100, 0, Math.PI/180*angle);
	gleye.setPosition(x,y,z);		
	gleye.setClient('type', 'gleye');
	gleye.setClient('dbl.func', function(){
		demo.showVideoDialog('Gleye #: C300-493A  |  Status: OK');
	});
	box.add(gleye);

	var pipe=new mono.PathNode(path,10,2,10,'plain','plain');
	pipe.s({
		'm.color': '#2E2E2E',
		'm.ambient': '#2E2E2E',
		'm.type': 'phong',
		'm.specularStrength': 50,
		'm.normalType': mono.NormalTypeSmooth,
	});
	pipe.setRotationX(-Math.PI/2);		
	pipe.setParent(gleye);
	
	box.add(pipe);
};

demo.createWall = function(path, thick, height, insideColor, outsideColor, topColor){
	var wall= new mono.PathCube(path, thick, height);
	wall.s({
		'outside.m.color': outsideColor,
		'inside.m.type': 'basic',
		'inside.m.color': insideColor,
		'aside.m.color': outsideColor,
		'zside.m.color': outsideColor,
		'top.m.color': topColor,
		'bottom.m.color': topColor,
		'inside.m.lightmap.image': demo.getRes('inside_lightmap.jpg'),
		'outside.m.lightmap.image': demo.getRes('outside_lightmap.jpg'),
		'aside.m.lightmap.image': demo.getRes('outside_lightmap.jpg'),
		'zside.m.lightmap.image': demo.getRes('outside_lightmap.jpg'),
	});
	return wall;
}

demo.createPlant = function(x, y, z, scaleX, scaleY, scaleZ){
	var plant;
	if(!demo._plantInstance){
		var w=30;
		var h=120;
		var pic=demo.getRes('plant.png');
		var objects=[];

		var cylinderVase=new mono.Cylinder(w*0.6,w*0.4,h/5,20,1,false,false);
		cylinderVase.s({
			'm.type': 'phong',
			'm.color': '#845527',
			'm.ambient': '#845527',
			'm.texture.repeat': new mono.XiangliangTwo(10,4),
			'm.specularmap.image': demo.getRes('metal_normalmap.jpg'),
			'm.normalmap.image':demo.getRes('metal_normalmap.jpg'),
		});			
		var cylinderHollow=cylinderVase.clone();
		cylinderHollow.setScale(0.9,1,0.9);
		var cylinderMud=cylinderHollow.clone();
		cylinderMud.setScale(0.9,0.7,0.9);
		cylinderMud.s({
			'm.type': 'phong',
			'm.color': '#163511',
			'm.ambient': '#163511',
			'm.texture.repeat': new mono.XiangliangTwo(10,4),
			'm.specularmap.image': demo.getRes('metal_normalmap.jpg'),
			'm.normalmap.image':demo.getRes('metal_normalmap.jpg'),
		});
		var vase=new mono.ComboNode([cylinderVase,cylinderHollow,cylinderMud],['-','+']);
		objects.push(vase);

		var count=5;
		for(var i=0;i<count;i++){
			var plant=new mono.Cube(w*2,h,0.01);	

			plant.s({
				'm.visible': false,
				'm.alphaTest': 0.5,
				'front.m.visible': true,
				'front.m.texture.image': pic,
				'back.m.visible': true,
				'back.m.texture.image': pic,
			});
			plant.setParent(vase);
			plant.setPositionY(cylinderVase.getHeight()/2+plant.getHeight()/2-3);
			plant.setRotationY(Math.PI * i/count);
			objects.push(plant);
		}

		demo._plantInstance=new mono.ComboNode(objects);				
		demo._plantInstance.setClient('plant.original.y', cylinderVase.getHeight()/2);			
		plant = demo._plantInstance;
		//console.log('create plant from brand new');
	}else{
		plant = demo._plantInstance.clone();
		//console.log('create plant from instance');
	}

	plant.setPosition(x,plant.getClient('plant.original.y')+y,z);
	plant.setScale(scaleX, scaleY, scaleZ);
	plant.setClient('type', 'plant');
	return plant;
}

demo.createAirPlanes = function(){
	var planes=[];
	var wavePath= new mono.Path();
	wavePath.moveTo(0,0,0);
	wavePath.curveTo(0,80,30,0,100,150);
	wavePath.curveTo(0,120,200,0,200,230);

	var creator=function(length, x, z){
		var path = new mono.Path();
		path.moveTo(0,0,0);
		path.lineTo(length,0,0);			
		var curvePlane = new mono.CurvePlane(path, wavePath);
		curvePlane.setPosition(x, 0, z);
		curvePlane.s({
			'm.texture.image': demo.getRes('arrow.png'),
			'm.side': 'both',
			'm.texture.repeat': new mono.XiangliangTwo(parseInt(length/50), 8),				
			'm.transparent': true,
			'm.gradient': {0: '#84DF29', 0.6: '#DF6029', 1: '#DF2929'},
			'm.gradientType': 2,				
		});

		var airAnimation=new twaver.Animate({
			from: 0,
			to: 1,
			dur: 1000,
			reverse: false,
			repeat:Number.POSITIVE_INFINITY,
			onUpdate: function(value){
				curvePlane.s({
					'm.texture.offset': new mono.XiangliangTwo(0, -value),
				});
			},
		});
		curvePlane.airAnimation=airAnimation;						

		return curvePlane;
	}

	planes.push(creator(450, -10, 150));
	planes.push(creator(195, -310, 150));
	planes.push(creator(250, -400, -350));
	return planes;
}

demo.registerFilter('water_cable', function(box, json){			
	var path = demo.create3DPath(json.data);
	path = mono.PathNode.prototype.adjustPath(path, 5);
	var color=json.color;
	var size=json.size;
	var y=json.y;
	
	var loader=function(box, path, color, size, y){
		box.add(demo.createWaterCable(path, color, size, y));
	};

	var loaderFunc=function(box, path, color, size, y){
		return function(){
			loader(box, path, color, size, y);
		};
	};
	setTimeout(loaderFunc(box, path, color, size, y), demo.getRandomLazyTime());	
});

demo.createWaterCable = function(path, color, size, y){
	var cable=new mono.PathNode(path, 100, size);
	cable.s({
		'm.type': 'phong',
		'm.specularStrength': 50,
		'm.color': color,
		'm.ambient': color, 		
		'm.texture.image': demo.getRes('flow.jpg'),
		'm.texture.repeat': new mono.XiangliangTwo(100, 1),
	});
	cable.setStartCap('plain');
	cable.setEndCap('plain');
	cable.setPositionY(y);
	cable.setClient('type', 'water_cable');	
	cable.setVisible(false);
	return cable;
};

demo.registerFilter('laser', function(box, json){			
	var loader=function(box, json){
		box.add(demo.createLaser(box, json));
	};

	var loaderFunc=function(box, json){
		return function(){
			loader(box, json);
		};
	};
	setTimeout(loaderFunc(box, json), demo.getRandomLazyTime());	
});

demo.createLaser = function(box, json){
	var angle=Math.atan2(json.to[1]-json.from[1], json.to[0]-json.from[0]);
	
	var offset=1.5;
	var fromOffsetZ=offset*Math.sin(angle);
	var fromOffsetX=offset*Math.cos(angle);
	var toOffsetZ=offset*Math.sin(angle+Math.PI);
	var toOffsetX=offset*Math.cos(angle+Math.PI);

	//from side.
	var pole=new mono.Cylinder(5, 5, 170);
	pole.s({
		'm.texture.image': demo.getRes('rack_inside.jpg'),
		'm.texture.repeat': new mono.XiangliangTwo(1, 3),
		'm.color': '#A4A4A4',
		'm.ambient': '#A4A4A4',
		'm.type': 'phong',
		'm.specularStrength': 10,
	});
	pole.setPosition(json.from[0], pole.getHeight()/2, json.from[1]);
	pole.setClient('type', 'laser');
	pole.setVisible(false);
	box.add(pole);

	var glass=new mono.Cylinder(4, 4, 130);
	glass.s({			
		'm.type': 'phong',
		'm.color': '#A9F5D0',
		'm.ambient': '#A9F5D0',
		'm.envmap.image': demo.getEnvMap(),

	});
	glass.setParent(pole);
	glass.setPosition(fromOffsetX, 0, fromOffsetZ);
	glass.setClient('type', 'laser');
	glass.setVisible(false);
	box.add(glass);

	//another side.
	var pole2=pole.clone();
	pole2.setPosition(json.to[0], pole2.getHeight()/2, json.to[1]);
	pole2.setClient('type', 'laser');
	pole2.setVisible(false);
	box.add(pole2);

	var glass2=glass.clone();
	glass2.setParent(pole2);
	glass2.setPosition(toOffsetX, 0, toOffsetZ);
	glass2.setClient('type', 'laser');
	glass2.setVisible(false);
	box.add(glass2);

	//create laser lines.
	var color='red';
	for(var i=0;i<5;i++){
		var from=new mono.Cube(1,1,1);
		from.s({
			'm.color': color,
			'm.ambient': color,
		});
		from.setPosition(json.from[0], 30+i*27, json.from[1]);
		from.setClient('type', 'laser');
		from.setVisible(false);
		box.add(from);

		var to=from.clone();
		to.setPosition(json.to[0], 30+i*27, json.to[1]);
		to.setClient('type', 'laser');
		to.setVisible(false);
		box.add(to);

		var link=new mono.Link(from, to);
		link.s({
			'm.color': color,
			'm.ambient': color,
			'm.type': 'phong',
			'm.transparent': true,
			'm.opacity': 0.7,
		});
		link.setClient('type', 'laser');
		link.setVisible(false);
		box.add(link);
	}
};

Tooltip = function(keys, values) {
    this.mainContent = document.createElement('div');
    this.keys = keys;
    this.values = values;
    this.init();
}

twaver.Util.ext('Tooltip', Object, {
	init: function(){
		this.mainContent.setAttribute('class', 'tooltip');
		this.mainContent.setAttribute('id', 'tooltip');
		this.table = document.createElement('table');
		for(var i = 0; i < this.keys.length; i++){
			var tr = document.createElement('tr');
			var tdKey = document.createElement('td');
			tdKey.setAttribute('class', 'tooltip-key');
			tdKey.innerHTML = this.keys[i];
			tr.appendChild(tdKey);

			var tdValue = document.createElement('td');
			tdValue.setAttribute('class', 'tooltip-value');
			tdValue.innerHTML = this.values[i];
			tr.appendChild(tdValue);
			this.table.appendChild(tr);
		}
		this.mainContent.appendChild(this.table);
	},
	getView: function(){
		return this.mainContent;
	},
	setValues: function(values){
		this.values = values;
		var children = this.table.childNodes;
		for(var i = 0; i < this.values.length; i++){
			var value = this.values[i];
			var childGroup = children[i];
			childGroup.lastChild.innerHTML = value;
		}
	}
});

var dataJson={	
	objects: [{
		type: 'floor',
		width: 1600,
		depth: 1300,
	},{
		type: 'floor_cut',
		width: 200,
		height: 20,
		depth: 260,
		translate: [-348,0,530],
		rotate: [Math.PI/180*3, 0, 0],
	},{
		type: 'floor_box',
		width: 300,
		height: 50,
		depth: 100,
		translate: [350, 0, -500],	
	},{
		type: 'wall',
		height: 200,		
		translate: [-500, 0, -500],
		data:[[0, 0], [1000, 0], [1000, 500], [500, 500], [500, 1000], [0, 1000], [0,0]],
		children: [{
			type: 'window',
			translate: [200, 30, 500],
			width: 420,
			height: 150,
			depth: 50, 
		},{
			type: 'door',
			width: 205,
			height: 180,
			depth: 26,
			translate: [-350, 0, 500],
		}],
	},{
		type: 'plants',
		shadow: true,
		translates: [[560, 0, 400],[560, 0, 0],[60, 0, -100],[60, 0, -400],[-560, 0, 400],[-560, 0, 0],[-560, 0, -400]],
	},{
		type: 'plants',		
		scale: [0.5, 0.3, 0.5],
		shadow: false,
		translates: [[100, 27, 520],[300, 27, 520]],
	},{
		type: 'glass_wall',
		width: 1300,
		rotate: [0, Math.PI/180*90, 0],
		translate: [-790, 0, 0],
	},{
		type: 'glass_wall',
		width: 1300,
		rotate: [0, Math.PI/180*90, 0],
		translate: [790, 0, 0],	
	},{
		type: 'racks',		
		translates: [
			[-150, 0, 250],
			[-150-62, 0, 250],
			[-150-62-62, 0, 250],
			[-370, 0, -250],
			[-370+62, 0, -250],
			[-370+62+62, 0, -250],
			[-370+62+62+62, 0, -250],
			[150, 0, 250],
			[150+62, 0, 250],
			[150+62+62, 0, 250],
			[150+62+62+62, 0, 250],
			[150+62+62+62+62, 0, 250],
			[150-62, 0, 250],
			[150-62-62, 0, 250],			
		],
		labels: (function(){
			var labels=[];
			for(var k=0; k<14; k++){
				var label = '1A';
				if(k < 10){
 					label += '0';
				}
				labels.push(label + k);
			}
			return labels;
		})(),
		severities: [mono.AlarmSeverity.CRITICAL, null,null,mono.AlarmSeverity.WARNING,mono.AlarmSeverity.CRITICAL,null, mono.AlarmSeverity.MINOR, mono.AlarmSeverity.WARNING,mono.AlarmSeverity.WARNING,null,mono.AlarmSeverity.MINOR],
	},{
		type: 'tv',
		translate: [-130, 100, 513],	
	},{
		type: 'post',
		translate: [80, 110, 10],	
		width: 70,
		height: 120,
		pic: demo.getRes('post.jpg'),
	},{
		type: 'rail',
		data:[ [-180, 250], [-400, 250], [-400, -250], [400, -250]],
	},{
		type: 'connection',
		color: '#ED5A00',
		y: 265,
		flow: 0.05,
		data:[
			[-180, -100, -250],
			[-180, -100, -150],
			[-180, -50, -150],
			[-180, -50, -250],
			[-180, 0, -250],
			[-400, 0, -250],
			[-400, 0, 250],
			[400, 0, 250],
			[400, -50, 250],
			[400, -50, 350],
			[400, -100, 350],
			[400, -100, 250],
		],
	},{
		type: 'connection',
		color: '#21CD43',
		y: 265,
		flow: -0.05,
		data:[
			[-180+3, -100, -250],
			[-180+3, -100, -150],
			[-180+3, -50, -150],
			[-180+3, -50, -250+3],
			[-180+3, 0, -250+3],
			[-400+3, 0, -250+3],
			[-400+3, 0, 250-3],
			[400+3, 0, 250-3],
			[400+3, -50, 250-3],
			[400+3, -50, 350],
			[400+3, -100, 350],
			[400+3, -100, 250],
		],
	},{
		type: 'gleye',
		translate: [80, 200, 30],
	},{
		type: 'gleye',
		translate: [470, 200, 400],
		angle: 90,
	},{
		type: 'gleye',
		translate: [-450, 200, -470],
		alarm: mono.AlarmSeverity.WARNING,
	},{
		type: 'extinguisher',
		translate: [-45, -470],
	},{
		type: 'extinguisher',
		translate: [-45, -450],		
		arrow: true,
	},{
		type: 'extinguisher',
		translate: [-45, -430],
	},{
		type: 'smoke',
		translate: [300, 180, 240],
		color: '#FAAC58',
	},{
		type: 'smoke',
		translate: [-300, 180, -240],
		color: '#B40431',
	},{
		type: 'water_cable',
		color: '#B45F04',
		y: 10,
		size: 3,
		data:[
			[50, 0, 50],
			[460, 0, 50],
			[460, 0, 450],
			[-460, 0, 450],
			[-460, 0, -450],
			[-100, 0, -450],
			[-50, 0, -400],
			[-50, 0, 0],
			[0, 0, 50],
			[50, 0, 50],
		],
		},{
		type: 'water_cable',
		color: '#04B431',
		y: 10,
		size: 3,
		data:[
			[-300, 0, 180],
			[440, 0, 180],
			[440, 0, 330],
			[-340, 0, 330],
			[-340, 0, -180],
			[-420, 0, -180],
			[-420, 0, -310],
			[-120, 0, -310],
			[-120, 0, -180],
			[-320, 0, -180],
		],
	},{
		type: 'laser',
		from: [-485, 330],
		to: [485, 330],
	},{
		type: 'laser',
		from: [-485, 0],
		to: [-20, 0],
	},{
		type: 'laser',
		from: [-80, 480],
		to: [-80, -480],
	}],
};